<!DOCTYPE html><html lang="en"><head><title>Help for package breathtestcore</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {breathtestcore}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#AIC.breathtestnlmefit'><p>S3 AIC method for breathtestnlmefit</p></a></li>
<li><a href='#augment.breathtestfit'><p>Augmented prediction for breathtest fit</p></a></li>
<li><a href='#breathtest_data'><p>Data structure with PDR data and descriptors for breath test records</p></a></li>
<li><a href='#breathtest_read_function'><p>Snoop method to read breath test file</p></a></li>
<li><a href='#btcore_file'><p>Path to example breath test data file</p></a></li>
<li><a href='#cleanup_data'><p>Transforms 13C breath data into a clean format for fitting</p></a></li>
<li><a href='#coef_by_group'><p>Tabulates per-group breath test parameters</p></a></li>
<li><a href='#coef_diff_by_group'><p>Tabulates breath test parameter differences of groups</p></a></li>
<li><a href='#coef.breathtestfit'><p>S3 coef and summary for breathtestfit</p></a></li>
<li><a href='#cum_exp_beta'><p>Cumulative exponential beta function</p></a></li>
<li><a href='#dob_to_pdr'><p>Convert breath test DOB data to PDR data</p></a></li>
<li><a href='#exp_beta'><p>Exponential beta function for 13C breath data</p></a></li>
<li><a href='#extract_id'><p>Extracts an ID from string IRIS CSV file</p></a></li>
<li><a href='#nlme_fit'><p>Mixed-model nlme fit to 13C Breath Data</p></a></li>
<li><a href='#nls_fit'><p>Individual curve fit with nls to 13C breath test data</p></a></li>
<li><a href='#null_fit'><p>Convert data to class breathtestfit</p></a></li>
<li><a href='#plot.breathtestfit'><p>S3 plot method for breathtestfit</p></a></li>
<li><a href='#read_any_breathtest'><p>Read breathtest files of any format</p></a></li>
<li><a href='#read_breathid'><p>Read BreathID file</p></a></li>
<li><a href='#read_breathid_xml'><p>Read new BreathID/Examens XML file</p></a></li>
<li><a href='#read_breathtest_excel'><p>Reads breathtest data in Excel format</p></a></li>
<li><a href='#read_iris'><p>Read 13C data from IRIS/Wagner Analysen</p></a></li>
<li><a href='#read_iris_csv'><p>Read 13C data from IRIS/Wagner Analysen in CSV Format</p></a></li>
<li><a href='#sigma.breathtestnlmefit'><p>S3 method to extract the fit's residual standard deviation</p></a></li>
<li><a href='#simulate_breathtest_data'><p>Simulate 13C breath time series data</p></a></li>
<li><a href='#subsample_data'><p>Decimate densely sampled 13C time series</p></a></li>
<li><a href='#t50_bluck_coward'><p>Bluck-Coward self-corrected half-emptying time</p></a></li>
<li><a href='#t50_maes_ghoos'><p>Half-emptying time by Maes/Ghoos method</p></a></li>
<li><a href='#t50_maes_ghoos_scintigraphy'><p>Half-emptying time t50 from Maes/Ghoos fit with scintigraphic correction</p></a></li>
<li><a href='#tidy.breathtestfit'><p>Broom-style tidying methods for breathtestfit</p></a></li>
<li><a href='#tlag_bluck_coward'><p>Lag phase for Bluck-Coward self-correcting fit</p></a></li>
<li><a href='#tlag_maes_ghoos'><p>So-called lag time from Maes/Ghoos fit</p></a></li>
<li><a href='#usz_13c'><p>Zurich sample set of 13C breath test data</p></a></li>
<li><a href='#usz_13c_a'><p>Exotic 13C breath test data</p></a></li>
<li><a href='#usz_13c_d'><p>13C breath test data with MRI emptying for comparison</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Title:</td>
<td>Core Functions to Read and Fit 13c Time Series from Breath Tests</td>
</tr>
<tr>
<td>Version:</td>
<td>0.8.9</td>
</tr>
<tr>
<td>Description:</td>
<td>Reads several formats of 13C data (IRIS/Wagner,
    BreathID) and CSV.  Creates artificial sample data for testing.  Fits
    Maes/Ghoos, Bluck-Coward self-correcting formula using 'nls', 'nlme'.
    Methods to fit breath test curves with Bayesian Stan methods are
    refactored to package 'breathteststan'. For a Shiny GUI, see package
    'dmenne/breathtestshiny' on github.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a></td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 4.0.0)</td>
</tr>
<tr>
<td>Imports:</td>
<td>assertthat, dplyr, ggfittext, ggplot2, broom (&ge; 0.7.0),
graphics, grid, MASS, methods, multcomp, nlme, purrr, readr,
readxl, signal, stats, stringr, tibble (&ge; 3.0.0), tidyr,
tools, utils, xml2</td>
</tr>
<tr>
<td>Suggests:</td>
<td>base, gridExtra, qpdf, knitr, rmarkdown, testthat(&ge; 2.99),
breathteststan, covr</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://github.com/dmenne/breathtestcore">https://github.com/dmenne/breathtestcore</a>,</td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/dmenne/breathtestcore/issues">https://github.com/dmenne/breathtestcore/issues</a></td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>SystemRequirements:</td>
<td>pandoc</td>
</tr>
<tr>
<td>Config/testthat/edition:</td>
<td>3</td>
</tr>
<tr>
<td>Config/testthat/parallel:</td>
<td>true</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.3.2</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2025-01-07 08:37:09 UTC; Dieter</td>
</tr>
<tr>
<td>Author:</td>
<td>Dieter Menne [aut, cre],
  Menne Biomed Consulting Tuebingen [cph],
  Benjamin Misselwitz [fnd],
  Mark Fox [fnd],
  Andreas Steingoetter [dtc],
  University Hospital of Zurich, Dep. Gastroenterology [fnd, dtc]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Dieter Menne &lt;dieter.menne@menne-biomed.de&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2025-01-08 09:20:12 UTC</td>
</tr>
</table>
<hr>
<h2 id='AIC.breathtestnlmefit'>S3 AIC method for breathtestnlmefit</h2><span id='topic+AIC.breathtestnlmefit'></span>

<h3>Description</h3>

<p>Extract AIC from a model fitted with <code><a href="#topic+nlme_fit">nlme_fit</a></code>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'breathtestnlmefit'
AIC(object, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="AIC.breathtestnlmefit_+3A_object">object</code></td>
<td>
<p>of class breathtestnlmefit</p>
</td></tr>
<tr><td><code id="AIC.breathtestnlmefit_+3A_...">...</code></td>
<td>
<p>not used</p>
</td></tr>
</table>

<hr>
<h2 id='augment.breathtestfit'>Augmented prediction for breathtest fit</h2><span id='topic+augment.breathtestfit'></span>

<h3>Description</h3>

<p>Broom method <code><a href="generics.html#topic+augment">augment</a></code> to compute predicted values 
from  the results of class <code>breathttestfit</code>  as generated by  
<code><a href="#topic+nls_fit">nls_fit</a></code> or <code><a href="#topic+nlme_fit">nlme_fit</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'breathtestfit'
augment(x, by = NULL, minute = NULL, dose = 100, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="augment.breathtestfit_+3A_x">x</code></td>
<td>
<p>Object of class <code>breathttestfit</code></p>
</td></tr>
<tr><td><code id="augment.breathtestfit_+3A_by">by</code></td>
<td>
<p>When <code>by</code> is NULL, predictions for the original data values
are returned.  When <code>by</code> is a positive number, it is used as a step 
size for a sequence of minutes from 0 to the maximum value of minute in data set.</p>
</td></tr>
<tr><td><code id="augment.breathtestfit_+3A_minute">minute</code></td>
<td>
<p>When a vector is passed, this overrides settings in <code>by</code>,
and predictions are calculated at the requested minute values.</p>
</td></tr>
<tr><td><code id="augment.breathtestfit_+3A_dose">dose</code></td>
<td>
<p>13C acetate or octanoate dose</p>
</td></tr>
<tr><td><code id="augment.breathtestfit_+3A_...">...</code></td>
<td>
<p>other parameters passed to methods</p>
</td></tr>
</table>


<h3>Value</h3>

<p>When <code>by</code> is NULL,  returns one row for each 
original observation pdr, and column <code>fitted</code>. If new data are given, 
i.e. when one of parameter <code>by</code> or <code>minute</code> is not null, 
only column <code>fitted</code> is added.
</p>


<h3>See Also</h3>

<p><code><a href="generics.html#topic+augment">augment</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>library(broom)
# Generate simulated data
data = cleanup_data(simulate_breathtest_data(n_records = 3)$data)
# Fit using the curves individually
fit = nls_fit(data)
# Predict values at t=60 and t=120
augment(fit, minute = c(60, 120))

</code></pre>

<hr>
<h2 id='breathtest_data'>Data structure with PDR data and descriptors for breath test records</h2><span id='topic+breathtest_data'></span>

<h3>Description</h3>

<p>Generates structure of class <code>breathtest_data</code> with 
required fields and optional fields. Optional fields by default are NA. 
This structure is used internally as an intermediate when reading in 
external file formats. All <code>read_xxx</code> functions return this structure, 
or a list of this structure (e.g. <code><a href="#topic+read_breathid_xml">read_breathid_xml</a></code>), and any
converter to  a new format should do  the same to be used with 
<code><a href="#topic+cleanup_data">cleanup_data</a></code>. 
To support a new format with, also update 
<code><a href="#topic+breathtest_read_function">breathtest_read_function</a></code> which returns the most likely function 
to read the file by reading a few lines in it.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>breathtest_data(
  patient_id,
  name = NA,
  first_name = NA,
  initials = NA,
  dob = NA,
  birth_year = NA,
  gender = NA,
  study = NA,
  pat_study_id = NA,
  file_name,
  device = "generic",
  substrate,
  record_date,
  start_time = record_date,
  end_time = record_date,
  test_no,
  dose = 100,
  height = 180,
  weight = 75,
  t50 = NA,
  gec = NA,
  tlag = NA,
  data = data
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="breathtest_data_+3A_patient_id">patient_id</code></td>
<td>
<p>required, string or number for unique identification</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_name">name</code></td>
<td>
<p>optional</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_first_name">first_name</code></td>
<td>
<p>optional</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_initials">initials</code></td>
<td>
<p>optional, 2 characters, 1 number</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_dob">dob</code></td>
<td>
<p>optional date of birth (not to be confused with &quot;delta over baseline&quot;)</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_birth_year">birth_year</code></td>
<td>
<p>optional</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_gender">gender</code></td>
<td>
<p>optional <code>m</code> or <code>f</code></p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_study">study</code></td>
<td>
<p>optional name of study; can be used in population fit</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_pat_study_id">pat_study_id</code></td>
<td>
<p>optional; patient number within study_ does not need to be globally unique</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_file_name">file_name</code></td>
<td>
<p>required; file where data were read from, or other unique string_
when data are read again, this string is tested and record is skipped when
same filename is already in database, therefore uniqueness is important_ when some
record does not turn up in database after repeated reading, check if a record with
the same file name is already there, and rename the file to avoid collisions_</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_device">device</code></td>
<td>
<p>breath_id or iris; default &quot;generic&quot;</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_substrate">substrate</code></td>
<td>
<p>should contain string &quot;ace&quot; or &quot;oct&quot; or &quot;okt&quot;, case insensitive_ will
be replaced by &quot;acetate&quot; or &quot;octanoate&quot;. If empty, &quot;ocatanoate&quot; is assumed.</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_record_date">record_date</code></td>
<td>
<p>required record date_</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_start_time">start_time</code></td>
<td>
<p>optional</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_end_time">end_time</code></td>
<td>
<p>optional</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_test_no">test_no</code></td>
<td>
<p>required integer; unique test number converted to integer if factor</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_dose">dose</code></td>
<td>
<p>optional, default 100 mg</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_height">height</code></td>
<td>
<p>optional, in cm; when pdr must be calculated, default values are
used; see <code><a href="#topic+dob_to_pdr">dob_to_pdr</a></code></p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_weight">weight</code></td>
<td>
<p>optional, in kg</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_t50">t50</code></td>
<td>
<p>optional, only present if device computes this value</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_gec">gec</code></td>
<td>
<p>optional, only present if device computes this value</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_tlag">tlag</code></td>
<td>
<p>optional, only present if device computes this value</p>
</td></tr>
<tr><td><code id="breathtest_data_+3A_data">data</code></td>
<td>
<p>data frame with at least 5 rows and columns <code>minute</code> or 
<code>time</code> and one or both of <code>dob</code> or <code>pdr</code>. 
If pdr is missing, and height, weight 
and substrate are given, computes pdr via function <code><a href="#topic+dob_to_pdr">dob_to_pdr</a></code>. 
When height and weight are missing,  defaults 180 cm and 75 kg are used instead.</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'># Read a file with known format
iris_csv_file = btcore_file("IrisCSV.TXT")
iris_csv_data = read_iris_csv(iris_csv_file)
# Note that many filds are NA
str(iris_csv_data)
# Convert to a format that can be fed to one of the fit functions
iris_df = cleanup_data(iris_csv_data)
# Individual curve fit
coef(nls_fit(iris_df)) 
</code></pre>

<hr>
<h2 id='breathtest_read_function'>Snoop method to read breath test file</h2><span id='topic+breathtest_read_function'></span>

<h3>Description</h3>

<p>Reads the first line of a file, and returns
the best matching function to read the breath test data in it.
To automatically read the file with the inferred file type,
use <code><a href="#topic+read_any_breathtest">read_any_breathtest</a></code>. For Excel files, only the
first sheet is read.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>breathtest_read_function(filename = NULL, text = NULL)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="breathtest_read_function_+3A_filename">filename</code></td>
<td>
<p>breath test data file from Iris/Wagner (extended or CSV), 
BreathID</p>
</td></tr>
<tr><td><code id="breathtest_read_function_+3A_text">text</code></td>
<td>
<p>as alternative to filename, pass the text of the file directly.
This parameter is not used for Excel files.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Function to read the file or the text; NULL if no matching function 
was found
</p>


<h3>Examples</h3>

<pre><code class='language-R'> file = btcore_file("IrisCSV.TXT")
 # Get function to read this file. Returns \code{\link{read_iris_csv}}.
 read_fun = breathtest_read_function(file)
 str(read_fun(file))
 # or, simple (returns a list!)
 str(read_any_breathtest(file), 1 )
 
</code></pre>

<hr>
<h2 id='btcore_file'>Path to example breath test data file</h2><span id='topic+btcore_file'></span>

<h3>Description</h3>

<p>Path to example breath test data file
</p>


<h3>Usage</h3>

<pre><code class='language-R'>btcore_file(filename = NULL, full.names = FALSE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="btcore_file_+3A_filename">filename</code></td>
<td>
<p>example file in <code>extdata</code> directory without path. 
Case sensitive on Unix. When filename is missing, returns the names of the 
available sample files.</p>
</td></tr>
<tr><td><code id="btcore_file_+3A_full.names">full.names</code></td>
<td>
<p>When <code>filename</code> is NULL, return full path names</p>
</td></tr>
</table>


<h3>Value</h3>

<p>full filename to example file to use in read_xxx
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  head(btcore_file())
  filename = btcore_file("IrisMulti.TXT")
  data = read_iris(filename)
</code></pre>

<hr>
<h2 id='cleanup_data'>Transforms 13C breath data into a clean format for fitting</h2><span id='topic+cleanup_data'></span>

<h3>Description</h3>

<p>Accepts various data formats of ungrouped or grouped 13C breath 
test time series, and transforms these into a data frame that can be used by
all fitting functions, e.g. <code><a href="#topic+nls_fit">nls_fit</a></code>.
If in doubt, pass data frame through <code>cleanup_data</code> before forwarding it 
to a fitting function. If the function cannot repair the format, it gives better
error messages than the <code>xxx_fit</code> functions.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>cleanup_data(data, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="cleanup_data_+3A_data">data</code></td>
<td>

<ul>
<li><p>A data frame, array or tibble with at least two numeric columns
with  optional names <code>minute</code> and <code>pdr</code> to fit 
a single 13C record.  
</p>
</li>
<li><p>A data frame or tibble with three columns named <code>patient_id</code>,
<code>minute</code> and <code>pdr</code>. 
</p>
</li>
<li><p>A matrix that can be converted to one of the above.
</p>
</li>
<li><p>A list of data frames/tibbles that are concatenated. When the list has 
named elements, the names are converted to group labels. When the list elements
are not named, group name <code>A</code> is used for all items.
</p>
</li>
<li><p>A structure of class <code><a href="#topic+breathtest_data">breathtest_data</a></code>, as imported from
a file with <code><a href="#topic+read_any_breathtest">read_any_breathtest</a></code>
</p>
</li>
<li><p>A list of class <code>breathtest_data_list</code> as generated
from read function such as <code><a href="#topic+read_breathid_xml">read_breathid_xml</a></code>
</p>
</li></ul>
</td></tr>
<tr><td><code id="cleanup_data_+3A_...">...</code></td>
<td>
<p>optional. 
</p>

<dl>
<dt>use_filename_as_patient_id</dt><dd><p>Always use filename instead of 
patient name. Use this when patient id are not unique.</p>
</dd>
</dl>
</td></tr>
</table>


<h3>Value</h3>

<p>A tibble with 4 columns. Column <code>patient_id</code> is created with a dummy
entry of <code>pat_a</code> if no patient_id was present in the input data set. 
A column <code>group</code> is required in the input data if the patients are from different 
treatment groups or within-subject repeats, e.g. in crossover design. 
A dummy group name &quot;A&quot; is added if no group column was available in the input data set.
If <code>group</code> is present, this is a hint to the analysis functions to do 
post-hoc breakdown or use it as a grouping variable in population-based methods.
A patient can have records in multiple groups, for example in a cross-over 
designs. 
</p>
<p>Columns <code>minute</code> and <code>pdr</code> are the same as given on input, but negative
minute values are removed, and an entry at 0 minutes is shifted to 0.01 minutes 
because most fit methods cannot handle the singularity at t=0.
</p>
<p>An error is raised if dummy columns <code>patient_id</code> and <code>group</code> cannot be 
added in a unique way, i.e. when multiple values for a given minute cannot be 
disambiguated.
</p>
<p>Comments are persistent; multiple comments are concatenated with newline separators.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>options(digits = 4)
# Full manual
minute = seq(0,30, by = 10)
data1 = data.frame(minute, 
   pdr = exp_beta(minute, dose = 100, m = 30,  k = 0.01, beta = 2))
# Two columns with data at t = 0
data1
# Four columns with data at t = 0.01
cleanup_data(data1)

# Results from simulate_breathtest_data can be passed directly to cleanup_data
cleanup_data(simulate_breathtest_data(3))
# .. which implicitly does
cleanup_data(simulate_breathtest_data(3)$data)

# Use simulated data
data2 = list(
  Z = simulate_breathtest_data(seed = 10)$data,
  Y = simulate_breathtest_data(seed = 11)$data)
d = cleanup_data(data2)
str(d)
unique(d$patient_id)
unique(d$group)
# "Z" "Y"

# Mix multiple input formats
f1 = btcore_file("350_20043_0_GER.txt")
f2 = btcore_file("IrisMulti.TXT")
f3 = btcore_file("IrisCSV.TXT")
# With a named list, the name is used as a group parameter
data = list(A = read_breathid(f1), B = read_iris(f2), C = read_iris_csv(f3)) 
d = cleanup_data(data)
str(d)
unique(d$patient_id)
# "350_20043_0_GER" "1871960"         "123456"
# File name is used as patient name if none is available
unique(d$group)
# "A" "B" "C"
</code></pre>

<hr>
<h2 id='coef_by_group'>Tabulates per-group breath test parameters</h2><span id='topic+coef_by_group'></span>

<h3>Description</h3>

<p>Given a fit to 13C breath test curves, computes absolute values and
their confidence intervals of parameters, e.g. of the half emptying time <code>t50</code>.
Generic S3 method for class breathtestfit.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>coef_by_group(fit, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="coef_by_group_+3A_fit">fit</code></td>
<td>
<p>Object of class <code>breathtestfit</code>, for example from 
<code><a href="#topic+nlme_fit">nlme_fit</a></code>, <code><a href="#topic+nls_fit">nls_fit</a></code> or <code><a href="breathteststan.html#topic+stan_fit">stan_fit</a></code></p>
</td></tr>
<tr><td><code id="coef_by_group_+3A_...">...</code></td>
<td>
<p>Not used</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>tibble</code> of class <code>coef_by_group</code> with columns
</p>

<dl>
<dt>parameter</dt><dd><p>Parameter of fit, e.g. <code>beta, k, m, t50</code></p>
</dd>
<dt>method</dt><dd><p>Method used to compute parameter. <code>exp_beta</code> refers to primary
fit parameters <code>beta, k, m</code>. <code>maes_ghoos</code> uses the method from 
Maes B D, Ghoos Y F,
Rutgeerts P J, Hiele M I, Geypens B and Vantrappen G 1994 Dig. Dis. Sci. 39 S104-6.
<code>bluck_coward</code> is the self-correcting method from  Bluck L J C and 
Coward W A 2006</p>
</dd>
<dt>group</dt><dd><p>Grouping parameter of the fit, e.g. <code>patient, normal, liquid, solid</code></p>
</dd>
<dt>estimate</dt><dd><p>Parameter estimate</p>
</dd>
<dt>conf.low, conf.high</dt><dd><p>Lower and upper 95
estimate.</p>
</dd>
<dt>diff_group</dt><dd><p>Letters a, b, c indicate that parameter would be in mutually 
significantly different groups. Letter combinations like <code>ab</code> or <code>abc</code> 
indicated that this parameter is not significantly different from the given 
other groups in a Tukey-corrected pairwise test. </p>
</dd>
</dl>



<h3>Examples</h3>

<pre><code class='language-R'>library(dplyr)
data("usz_13c")
data = usz_13c %&gt;%
  dplyr::filter( patient_id %in%
    c("norm_001", "norm_002", "norm_003", "norm_004", "pat_001", "pat_002","pat_003")) %&gt;%
  cleanup_data()
fit = nls_fit(data)
coef_by_group(fit)

fit = nlme_fit(data)
coef_by_group(fit)

</code></pre>

<hr>
<h2 id='coef_diff_by_group'>Tabulates breath test parameter differences of groups</h2><span id='topic+coef_diff_by_group'></span>

<h3>Description</h3>

<p>Given a fit to 13C breath test curves, computes between-group confidence
intervals and p-values, for examples of the half emptying time <code>t50</code>,
with correction for multiple testing.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>coef_diff_by_group(fit, mcp_group = "Tukey", reference_group = NULL, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="coef_diff_by_group_+3A_fit">fit</code></td>
<td>
<p>Object of class <code>breathtestfit</code>, for example from
<code><a href="#topic+nlme_fit">nlme_fit</a></code>, <code><a href="#topic+nls_fit">nls_fit</a></code></p>
</td></tr>
<tr><td><code id="coef_diff_by_group_+3A_mcp_group">mcp_group</code></td>
<td>
<p>&quot;Tukey&quot; (default) for all pairwise comparisons, &quot;Dunnett&quot; for
comparisons relative to the reference group.</p>
</td></tr>
<tr><td><code id="coef_diff_by_group_+3A_reference_group">reference_group</code></td>
<td>
<p>Used as the first group and as reference group for
<code>mcp_group == "Dunnett"</code></p>
</td></tr>
<tr><td><code id="coef_diff_by_group_+3A_...">...</code></td>
<td>
<p>Not used</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>tibble</code> of class <code>coef_diff_by_group</code> with columns
</p>

<dl>
<dt>parameter</dt><dd><p>Parameter of fit, e.g. <code>beta, k, m, t50</code></p>
</dd>
<dt>method</dt><dd><p>Method used to compute parameter. <code>exp_beta</code> refers to primary
fit parameters <code>beta, k, m</code>. <code>maes_ghoos</code> uses the method from
Maes B D, Ghoos Y F,
Rutgeerts P J, Hiele M I, Geypens B and Vantrappen G 1994 Dig. Dis. Sci. 39 S104-6.
<code>bluck_coward</code> is the self-correcting method from  Bluck L J C and
Coward W A 2006</p>
</dd>
<dt>groups</dt><dd><p>Which pairwise difference, e.g <code>solid - liquid</code></p>
</dd>
<dt>estimate</dt><dd><p>Estimate of the difference</p>
</dd>
<dt>conf.low, conf.high</dt><dd><p>Lower and upper 95
A comparison is significantly different from zero when both estimates have the same
sign.</p>
</dd>
<dt>p.value</dt><dd><p>p-value of the difference against 0, corrected for multiple testing</p>
</dd>
</dl>



<h3>Examples</h3>

<pre><code class='language-R'>library(dplyr)
data("usz_13c")
data = usz_13c %&gt;%
  dplyr::filter( patient_id %in%
    c("norm_001", "norm_002", "norm_003", "norm_004", "pat_001", "pat_002","pat_003")) %&gt;%
  cleanup_data()
fit = nls_fit(data)
coef_diff_by_group(fit)

fit = nlme_fit(data)
coef_diff_by_group(fit)

# TODO: Add example for Stan fit typecast to class \code{breathtestfit} to compute
# confidence intervals instead of credible intervals
</code></pre>

<hr>
<h2 id='coef.breathtestfit'>S3 coef and summary for breathtestfit</h2><span id='topic+coef.breathtestfit'></span>

<h3>Description</h3>

<p>Function <code>coef</code> extracts the estimates such as t50, 
tlag, from fitted 13C beta  exponential models. The result is the same 
as <code>fit$coef</code>, but without
column <code>stat</code>, which always is <code>"estimate"</code> for <code><a href="#topic+nls_fit">nls_fit</a></code>
and <code><a href="#topic+nlme_fit">nlme_fit</a></code>. 
</p>
<p>The <code>summary</code> method only extracts <code>t50</code> by the Maes/Ghoos method
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'breathtestfit'
coef(object, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="coef.breathtestfit_+3A_object">object</code></td>
<td>
<p>of class <code>breathtestfit</code>, as returned by <code><a href="#topic+nls_fit">nls_fit</a></code> or 
<code><a href="#topic+nlme_fit">nlme_fit</a></code></p>
</td></tr>
<tr><td><code id="coef.breathtestfit_+3A_...">...</code></td>
<td>
<p>other parameters passed to methods</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'># Generate simulated data
data = cleanup_data(simulate_breathtest_data())
# Fit with the population method
fit = nlme_fit(data)
# All coefficients in the long form
coef(fit)
# Access coefficients directly
fit$coef
# Only t50 by Maes/Ghoos
# Can also be used with stan fit (slow!)
## Not run: 
if (require("breathteststan")) {
  fit = stan_fit(data, iter = 300, chain = 1)
  coef(fit)
  # We get quantiles here in key/value format
  unique(fit$coef$stat)
}

## End(Not run)
</code></pre>

<hr>
<h2 id='cum_exp_beta'>Cumulative exponential beta function</h2><span id='topic+cum_exp_beta'></span>

<h3>Description</h3>

<p>Equation (2), page 4 from Bluck, &quot;Recent advances in the interpretation of
the 13C octanoate breath test for gastric emptying&quot;
</p>


<h3>Usage</h3>

<pre><code class='language-R'>cum_exp_beta(minute, dose, cf)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="cum_exp_beta_+3A_minute">minute</code></td>
<td>
<p>time in minutes</p>
</td></tr>
<tr><td><code id="cum_exp_beta_+3A_dose">dose</code></td>
<td>
<p>in mg</p>
</td></tr>
<tr><td><code id="cum_exp_beta_+3A_cf">cf</code></td>
<td>
<p>named vector of coefficients; only <code>k</code> and <code>beta</code> are required.
Note that <code>k</code> is measured in 1/min (e_g_ 0_01/min),
while often it is quoted as 1/h (e_g_ 0_6/h).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Vector of predicted cumulative pdr
</p>


<h3>See Also</h3>

<p><code><a href="#topic+exp_beta">exp_beta</a></code>
</p>

<hr>
<h2 id='dob_to_pdr'>Convert breath test DOB data to PDR data</h2><span id='topic+dob_to_pdr'></span>

<h3>Description</h3>

<p>Convert DOB (delta-over-baseline) to PDR for 13C breath test. 
This is equation (4) in
Sanaka, Yamamoto, Tsutsumi, Abe, Kuyama (2005) Wagner-Nelson method for analysing
the atypical double-peaked excretion curve in the [13c]-octanoate gastric
emptying breath test in humans. Clinical and experimental pharmacology and
physiology 32, 590-594.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>dob_to_pdr(
  dob,
  weight = 75,
  height = 180,
  mw = 167,
  purity_percent = 99.1,
  mg_substrate = 100
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="dob_to_pdr_+3A_dob">dob</code></td>
<td>
<p>Delta-over-baseline vector in 0/00</p>
</td></tr>
<tr><td><code id="dob_to_pdr_+3A_weight">weight</code></td>
<td>
<p>Body weight in kg; assumed 75 kg if missing</p>
</td></tr>
<tr><td><code id="dob_to_pdr_+3A_height">height</code></td>
<td>
<p>Body height in cm; assume 180 cm if missing</p>
</td></tr>
<tr><td><code id="dob_to_pdr_+3A_mw">mw</code></td>
<td>
<p>Molecular weight,  83.023388 g/mol for acetate, 167 g/mol for octanoate.
Can also be given as string &quot;acetate&quot; or &quot;octanoate&quot;.</p>
</td></tr>
<tr><td><code id="dob_to_pdr_+3A_purity_percent">purity_percent</code></td>
<td>
<p>Purity in percent</p>
</td></tr>
<tr><td><code id="dob_to_pdr_+3A_mg_substrate">mg_substrate</code></td>
<td>
<p>Substrate in mg</p>
</td></tr>
</table>


<h3>Value</h3>

<p>PDR percent dose/h
</p>


<h3>Note</h3>

<p>I have no idea where the factor 10 in equation (4) comes from, possibly
from percent(PDR)/and DOB(0/00). In Kim and Camillieri, Stable isotope breath 
test and gastric emptying, page 207, a factor of 0.1123 instead of 0.01123 
is used, without the factor 10. Which one is correct?
</p>


<h3>Examples</h3>

<pre><code class='language-R'>filename = btcore_file("350_20049_0_GERWithWeight.txt")
bid = read_breathid(filename)
bid$data$pdr1 = dob_to_pdr(bid$data$dob, weight=bid$weight, height=bid$height)

plot(bid$data$minute, bid$data$pdr1, main="points: from breath_id; line: computed",
type="l")
points(bid$data$minute, bid$data$pdr,col="red",type="p",pch=16)
#
# Check how far our computed pdr is from the stored pdr
var(bid$data$pdr1-bid$data$pdr)
</code></pre>

<hr>
<h2 id='exp_beta'>Exponential beta function for 13C breath data</h2><span id='topic+exp_beta'></span>

<h3>Description</h3>

<p>Function to fit PDR time series data to exponential-beta function
as given in: 
</p>
<p>Maes, B. D., B. J. Geypens, Y. F. Ghoos, M. I. Hiele, and P. J. Rutgeerts. 1998. 
13C-Octanoic Acid Breath Test for Gastric Emptying Rate of Solids. 
Gastroenterology 114(4): 856-50
</p>
<p>Sanaka M, Nakada K (2010) Stable isotope breath test for assessing gastric emptying:
A comprehensive review.  J. Smooth Muscle Research 46(6): 267-280
</p>
<p>Bluck L J C and Coward W A 2006 Measurement of gastric
emptying by the C-13-octanoate breath test &mdash; rationalization
with scintigraphy Physiol. Meas. 27 279?89
</p>
<p>For a review, see
</p>
<p>Bluck LJC (2009) Recent advances in the interpretation of the 13C octanoate
breath test for gastric emptying. Journal of Breath Research, 3 1-8
</p>


<h3>Usage</h3>

<pre><code class='language-R'>exp_beta(minute, dose, m, k, beta)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="exp_beta_+3A_minute">minute</code></td>
<td>
<p>vector of time values in minutes</p>
</td></tr>
<tr><td><code id="exp_beta_+3A_dose">dose</code></td>
<td>
<p>in mg</p>
</td></tr>
<tr><td><code id="exp_beta_+3A_m">m</code></td>
<td>
<p>efficiency</p>
</td></tr>
<tr><td><code id="exp_beta_+3A_k">k</code></td>
<td>
<p>time constant</p>
</td></tr>
<tr><td><code id="exp_beta_+3A_beta">beta</code></td>
<td>
<p>form factor</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function is defined as
</p>
<pre>exp_beta = function(minute,dose,m,k,beta) {
     m*dose*k*beta*(1-exp(-k*minute))^(beta-1)*exp(-k*minute)
}</pre>
<p>At minute == 0, the function behaves like a polynomial with degree (beta-1).
</p>


<h3>Value</h3>

<p>Values and gradients of estimated PDR for use with <code>nls</code> and <code>nlme</code>
</p>


<h3>See Also</h3>

<p>In the example below, data and fit are plotted with standard R graphics.
The S3 method <code><a href="#topic+plot.breathtestfit">plot.breathtestfit</a></code> provides <code>ggplot2</code> graphics.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>start = list(m=20,k=1/100,beta=2)

# fit to real data set and show different t50 results
sample_file = btcore_file("350_20043_0_GER.txt")
# minute 0 must be removed to avoid singularity
breath_id = read_breathid(sample_file)
data = subset(breath_id$data, minute &gt;0)
sample_nls = nls(pdr~exp_beta(minute, 100, m, k, beta), data = data, start = start)
data$pdr_fit_bluck=predict(sample_nls)
plot(data$minute, data$pdr, pch=16, cex=0.7, xlab="time (min)", ylab="PDR",
  main="t50 with different methods")
lines(data$minute,data$pdr_fit_bluck, col="blue")
t50 = t50_bluck_coward(coef(sample_nls))
t50_maes_ghoos = t50_maes_ghoos(coef(sample_nls))
t50scint = t50_maes_ghoos_scintigraphy(coef(sample_nls))
abline(v = t50, col = "red")
abline(v = t50_maes_ghoos, col = "darkgreen", lty = 2)
abline(v = breath_id$t50, col = "black", lty = 4)
abline(v = t50scint, col = "gray", lty = 3)
text(t50, 0, "Self-corrected Bluck/Coward", col = "red", adj = -0.01)
text(breath_id$t50, 0.5,"From BreathID device",col = "black", adj=-0.01)
text(t50scint, 1," Maes/Ghoos scintigraphic", col = "gray", adj = -0.01)
text(t50_maes_ghoos,1.5, "Classic Maes/Ghoos", col = "darkgreen", adj = -0.01)

# simulated data set
dose = 100
set.seed(4711)
# do not use minute 0, this gives singular gradients
# if required, shift minute = 0 by a small positive amount, e.g. 0.1
# create simulated data
pdr  = data.frame(minute=seq(2, 200, by = 10))
pdr$pdr =
  exp_beta(pdr$minute, 100, start$m, start$k, start$beta) + rnorm(nrow(pdr), 0, 1)
par(mfrow = c(1, 2))
# plot raw data
plot(pdr$minute, pdr$pdr, pch=16, cex=0.5, xlab = "time (min)",ylab = "PDR")
# compute fit
pdr_nls = nls(pdr~exp_beta(minute, 100, m, k, beta), data = pdr, start = start)
# compute prediction
pdr$pd_rfit = predict(pdr_nls)
lines(pdr$minute, pdr$pd_rfit, col="red", lwd=2)

# plot cumulative
plot(pdr$minute, cum_exp_beta(pdr$minute,100,coef(pdr_nls)), type="l",
     xlab = "time (min)", ylab = "cumulative PDR")
# show t50
t50 = t50_bluck_coward(coef(pdr_nls))
tlag = tlag_bluck_coward(coef(pdr_nls))
abline(v = t50, col = "gray")
abline(v = tlag,col = "green")
abline(h = 50, col = "gray")


# create simulated data from several patients
pdr1 = data.frame(patient = as.factor(letters[1:10]))
pdr1$m = start$m*(1 + rnorm(nrow(pdr1), 0, 0.1))
pdr1$k = start$k*(1 + rnorm(nrow(pdr1), 0, 0.3))
pdr1$beta = start$beta*(1 + rnorm(nrow(pdr1), 0, 0.1))
pdr1  = merge(pdr1, expand.grid(minute = seq(2, 200, by = 10), 
   patient = letters[1:10]))
pdr1 = pdr1[order(pdr1$patient, pdr1$minute), ]

# simulated case: for patient a, only data up to 50 minutes are available
pdr1 = pdr1[!(pdr1$patient == "a" &amp; pdr1$minute &gt; 50),]
set.seed(4711)
pdr1$pdr =
  with(pdr1, exp_beta(minute, 100, m, k, beta) + rnorm(nrow(pdr1), 0, 1))

# compute nls fit for patient a only: fails
# the following line will produce an error message

pdr_nls = try(nls(pdr~exp_beta(minute, 100, m, k, beta), data=pdr1, start=start,
                  subset = patient=="a"))
stopifnot(class(pdr_nls) == "try-error")

# use nlme to fit the whole set with one truncated record
suppressPackageStartupMessages(library(nlme))
pdr_nlme = nlme(pdr~exp_beta(minute,100,m,k,beta), data = pdr1,
                fixed = m+k+beta~1,
                random = m+k+beta~1,
                groups = ~patient,
                start = c(m = 20, k = 1/100, beta = 2))
coef(pdr_nlme)
pred_data = expand.grid(minute = seq(0, 400, 10), patient = letters[1:10])
pred_data$pdr = predict(pdr_nlme, newdata = pred_data)
suppressPackageStartupMessages(library(ggplot2))
ggplot() +
  geom_point(data = pdr1, aes(x = minute, y = pdr, color = "red")) + 
  geom_line(data = pred_data, aes(x = minute, y = pdr), color = "black", linewidth = 1 ) +
  ggtitle("Short patient record 'a' gives a good fit with many missing data using nlme.\n
          Borrowing strength from nlme in action!")+
  facet_wrap(~patient) +
  theme(legend.position="none")
</code></pre>

<hr>
<h2 id='extract_id'>Extracts an ID from string IRIS CSV file</h2><span id='topic+extract_id'></span>

<h3>Description</h3>

<p>First tries to extract only digits, separating these by underscore 
when there are multiple blocks. If this give a non-valid  id, returns the 
whole string without spaces and periods, hoping it makes sense.
For internal use, but should be overridden for exotic IDs
</p>


<h3>Usage</h3>

<pre><code class='language-R'>extract_id(id)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="extract_id_+3A_id">id</code></td>
<td>
<p>One item from column Identifikation, e.g. &quot;KEK-ZH-Nr.2013-1234&quot;</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>extract_id
</code></pre>

<hr>
<h2 id='nlme_fit'>Mixed-model nlme fit to 13C Breath Data</h2><span id='topic+nlme_fit'></span>

<h3>Description</h3>

<p>Fits exponential beta curves to 13C breath test series data using
a mixed-model population approach. See
<a href="https://menne-biomed.de/blog/breath-test-stan/">https://menne-biomed.de/blog/breath-test-stan/</a> for a comparison between
single curve, mixed-model population and Bayesian methods.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>nlme_fit(
  data,
  dose = 100,
  start = list(m = 30, k = 1/100, beta = 2),
  sample_minutes = 15
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="nlme_fit_+3A_data">data</code></td>
<td>
<p>Data frame or tibble as created by <code><a href="#topic+cleanup_data">cleanup_data</a></code>,
with mandatory columns <code>patient_id, group, minute</code> and <code>pdr</code>.
It is recommended to run all data through <code><a href="#topic+cleanup_data">cleanup_data</a></code> to
insert dummy columns for <code>patient_id</code> and <code>group</code> if the
data are distinct, and report an error if not. At least 2 records are required
for a population fit, but 10 or more are recommended to obtain a stable result.</p>
</td></tr>
<tr><td><code id="nlme_fit_+3A_dose">dose</code></td>
<td>
<p>Dose of acetate or octanoate. Currently, only one common dose
for all records is supported. The dose only affects parameter <code>m</code> of the 
fit; all important t50-parameters are unaffected by the dose.</p>
</td></tr>
<tr><td><code id="nlme_fit_+3A_start">start</code></td>
<td>
<p>Optional start values. In most case, the default values are good
enough to achieve convergence, but slightly different values for <code>beta</code>
(between 1 and 2.5) can save a non-convergent run.</p>
</td></tr>
<tr><td><code id="nlme_fit_+3A_sample_minutes">sample_minutes</code></td>
<td>
<p>When the mean sampling interval is &lt; <code>sampleMinutes</code>, 
data are subsampled using a spline algorithm by function <code><a href="#topic+subsample_data">subsample_data</a></code>.
See the graphical output of <code><a href="#topic+plot.breathtestfit">plot.breathtestfit</a></code> for an example where
too densely sampled data of one patients were subsampled for the fit.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list of class (&quot;breathtestnlmefit&quot; &quot;breathtestfit&quot;) with elements
</p>

<dl>
<dt>coef</dt><dd><p>Estimated parameters in a key-value format with 
columns <code>patient_id, group, parameter, stat, method</code> and <code>value</code>.
Parameter <code>stat</code> currently always has value <code>"estimate"</code>. 
Confidence intervals will be added later, so do not take for granted that 
all parameters are estimates.  Has an attribute AIC which can be retrieved by
the S3-function <code>AIC</code>.</p>
</dd>
<dt>data</dt><dd><p>The data effectively fitted. If points are to closely sampled
in the input, e.g. with BreathId devices, data are subsampled before fitting.</p>
</dd>
</dl>



<h3>See Also</h3>

<p>Base methods <code>coef, plot, print</code>; methods from package
<code>broom: tidy, augment</code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>d = simulate_breathtest_data(n_records = 3, noise = 0.7, seed = 4712)
data = cleanup_data(d$data)
fit = nlme_fit(data)
plot(fit) # calls plot.breathtestfit
options(digits = 3)
library(dplyr)
cf = coef(fit)
# The coefficients are in long key-value format
cf
# AIC can be extracted
AIC(fit)
# Reformat the coefficients to wide format and compare 
# with the expected coefficients from the simulation 
# in d$record.
cf %&gt;%
  filter(grepl("m|k|beta", parameter )) %&gt;%
  select(-method, -group) %&gt;%
  tidyr::spread(parameter, value) %&gt;%
  inner_join(d$record, by = "patient_id") %&gt;%
  select(patient_id, m_in = m.y, m_out = m.x,
         beta_in = beta.y, beta_out = beta.x,
         k_in = k.y, k_out = k.x)
</code></pre>

<hr>
<h2 id='nls_fit'>Individual curve fit with nls to 13C breath test data</h2><span id='topic+nls_fit'></span>

<h3>Description</h3>

<p>Fits individual exponential beta curves to 13C breath test time series
</p>


<h3>Usage</h3>

<pre><code class='language-R'>nls_fit(data, dose = 100, start = list(m = 50, k = 1/100, beta = 2))
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="nls_fit_+3A_data">data</code></td>
<td>
<p>Data frame or tibble as created by <code><a href="#topic+cleanup_data">cleanup_data</a></code>, 
with mandatory columns <code>patient_id, group, minute</code> and <code>pdr</code>. 
It is recommended to run all data through <code><a href="#topic+cleanup_data">cleanup_data</a></code> which
will insert dummy columns for <code>patient_id</code> and <code>minute</code> if the
data are distinct, and report an error if not.</p>
</td></tr>
<tr><td><code id="nls_fit_+3A_dose">dose</code></td>
<td>
<p>Dose of acetate or octanoate. Currently, only one common dose
for all records is supported.</p>
</td></tr>
<tr><td><code id="nls_fit_+3A_start">start</code></td>
<td>
<p>Optional start values
<code>patient_id</code> and <code>group</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list of class (&quot;breathtestnlsfit&quot; &quot;breathtestfit&quot;) with elements
</p>

<dl>
<dt>coef</dt><dd><p>Estimated parameters in a key-value format with 
columns <code>patient_id, group, parameter, stat, method</code> and <code>value</code>.
Parameter <code>stat</code> always has value <code>"estimate"</code>.
Confidence intervals might be added later, so do not take for granted 
all parameters are estimates.</p>
</dd>
<dt>data</dt><dd><p>Input data; <code>nls_fit</code> does not decimate the data. If you have 
large data sets where subsampling might be required to achieve faster convergence,
using <code>nls_fit</code> anyway is only relevant to show how NOT to do it. 
Use <code>nlme_fit</code> or <code>stan_fit</code> instead.</p>
</dd>
</dl>



<h3>See Also</h3>

<p>Base methods <code>coef, plot, print</code>; methods from package
<code>broom: tidy, augment</code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>d = simulate_breathtest_data(n_records = 3, noise = 0.2, seed = 4711)
data = cleanup_data(d$data)
fit = nls_fit(data)
plot(fit) # calls plot.breathtestfit
options(digits = 2)
cf = coef(fit)
library(dplyr)
cf %&gt;% 
  filter(grepl("m|k|beta", parameter )) %&gt;% 
  select(-method, -group) %&gt;% 
  tidyr::spread(parameter, value) %&gt;% 
  inner_join(d$record, by = "patient_id") %&gt;% 
  select(patient_id, m_in = m.y, m_out = m.x, 
         beta_in = beta.y, beta_out = beta.x,
         k_in = k.y, k_out = k.x)
</code></pre>

<hr>
<h2 id='null_fit'>Convert data to class breathtestfit</h2><span id='topic+null_fit'></span>

<h3>Description</h3>

<p>Does not change the data set, but returns a class suitable
for plotting raw data with <code><a href="#topic+plot.breathtestfit">plot.breathtestfit</a></code>. 
See <code><a href="#topic+read_any_breathtest">read_any_breathtest</a></code> for an example.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>null_fit(data, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="null_fit_+3A_data">data</code></td>
<td>
<p>Data frame or tibble as created by <code><a href="#topic+cleanup_data">cleanup_data</a></code>, 
with mandatory columns <code>patient_id, group, minute</code> and <code>pdr</code>.</p>
</td></tr>
<tr><td><code id="null_fit_+3A_...">...</code></td>
<td>
<p>Not used</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list of classes <code>breathtestnullfit, breathtestfit</code> 
with element <code>data</code> which contains the unmodified data.
</p>

<hr>
<h2 id='plot.breathtestfit'>S3 plot method for breathtestfit</h2><span id='topic+plot.breathtestfit'></span>

<h3>Description</h3>

<p>Plots 13C data and fits.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'breathtestfit'
plot(
  x,
  inc = 5,
  method_t50 = "maes_ghoos",
  linewidth = 1,
  point_size = NULL,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="plot.breathtestfit_+3A_x">x</code></td>
<td>
<p>object of class <code>breathtestfit</code>, as returned by <code><a href="#topic+nls_fit">nls_fit</a></code>, 
<code><a href="#topic+nlme_fit">nlme_fit</a></code>, <code><a href="#topic+null_fit">null_fit</a></code> or <code>stan_fit</code>; stan_fit is
in package <code>breathteststan</code>,</p>
</td></tr>
<tr><td><code id="plot.breathtestfit_+3A_inc">inc</code></td>
<td>
<p>Increment for fitted curve plot in minutes</p>
</td></tr>
<tr><td><code id="plot.breathtestfit_+3A_method_t50">method_t50</code></td>
<td>
<p>Method for t50: &quot;<code>maes_ghoos</code>&quot;, &quot;<code>bluck_coward</code>&quot; or 
&quot;<code>maes_ghoos_scintigraphy</code>&quot;</p>
</td></tr>
<tr><td><code id="plot.breathtestfit_+3A_linewidth">linewidth</code></td>
<td>
<p>optional line width; can improve look for printouts</p>
</td></tr>
<tr><td><code id="plot.breathtestfit_+3A_point_size">point_size</code></td>
<td>
<p>optional point size; determined dynamically when NULL</p>
</td></tr>
<tr><td><code id="plot.breathtestfit_+3A_...">...</code></td>
<td>
<p>other parameters passed to methods. Not used</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>data = list(
  A = simulate_breathtest_data(n_records = 6, seed = 100),
  B = simulate_breathtest_data(n_records = 4, seed = 187) 
)
# cleanup_data combines the list into a data frame
x = nls_fit(cleanup_data(data))
plot(x)
</code></pre>

<hr>
<h2 id='read_any_breathtest'>Read breathtest files of any format</h2><span id='topic+read_any_breathtest'></span>

<h3>Description</h3>

<p>Uses <code><a href="#topic+breathtest_read_function">breathtest_read_function</a></code> to determine the file type
and reads it if it has a valid format.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>read_any_breathtest(files)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="read_any_breathtest_+3A_files">files</code></td>
<td>
<p>A single filename, a list or a character vector of filenames.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list of <code><a href="#topic+breathtest_data">breathtest_data</a></code>, even if
only one file was passed. The list can be passed to <code><a href="#topic+cleanup_data">cleanup_data</a></code>
to extract one concatenated data frame for processing with <code><a href="#topic+nls_fit">nls_fit</a></code>,  
<code><a href="#topic+nlme_fit">nlme_fit</a></code>, <code><a href="#topic+null_fit">null_fit</a></code> (no processing) or
<code>stan_fit</code> in separate package <code>breathteststan</code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>files = c(
  group_a = btcore_file("IrisCSV.TXT"),
  group_a = btcore_file("350_20043_0_GER.txt"),
  group_b = btcore_file("IrisMulti.TXT"),
  group_b = btcore_file("NewBreathID_01.xml")  
 )
 bt = read_any_breathtest(files)
 str(bt, 1)
 # Passing through cleanup_data gives a data frame/tibble
 bt_df = cleanup_data(bt)
 str(bt_df)
 # If you want data only, use null_fit()
 plot(null_fit(bt_df))
 # Plot population fit with decimated data
 plot(nlme_fit(bt_df))
</code></pre>

<hr>
<h2 id='read_breathid'>Read BreathID file</h2><span id='topic+read_breathid'></span>

<h3>Description</h3>

<p>Reads 13c data from a BreathID file, and returns a structure 
of class <code>breathtest_data</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>read_breathid(filename = NULL, text = NULL)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="read_breathid_+3A_filename">filename</code></td>
<td>
<p>name of txt-file to be read</p>
</td></tr>
<tr><td><code id="read_breathid_+3A_text">text</code></td>
<td>
<p>alternatively, text can be given as string</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Structure of class <code><a href="#topic+breathtest_data">breathtest_data</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>filename = btcore_file("350_20043_0_GER.txt")
# Show first lines
cat(readLines(filename, n = 10), sep="\n")
#
bid = read_breathid(filename)
str(bid)
</code></pre>

<hr>
<h2 id='read_breathid_xml'>Read new BreathID/Examens XML file</h2><span id='topic+read_breathid_xml'></span>

<h3>Description</h3>

<p>Reads 13c data from an XML BreathID file, and returns a structure
of class <code>breathtest_data_list</code>, which is a list with elements of
class <code>breathtest_data</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>read_breathid_xml(filename = NULL, text = NULL)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="read_breathid_xml_+3A_filename">filename</code></td>
<td>
<p>name of xml-file to be read</p>
</td></tr>
<tr><td><code id="read_breathid_xml_+3A_text">text</code></td>
<td>
<p>alternatively, text can be given as string</p>
</td></tr>
</table>


<h3>Value</h3>

<p>List of class <code>breathtest_data_list</code> of structures of
class <code><a href="#topic+breathtest_data">breathtest_data</a></code>; an XML file can contain multiple data sets.
Errors string for individual records are returned as attribute &quot;errors&quot;.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>filename = btcore_file("NewBreathID_01.xml")
# Show first lines
cat(readLines(filename, n = 10), sep="\n")
bid = read_breathid_xml(filename)
# List with length 1
str(bid, 1)
filename = btcore_file("NewBreathID_multiple.xml")
bids = read_breathid_xml(filename)
str(bids, 1) # 3 elements - the others in the file have no data
# Create hook function to deselect first record
choose_record = function(records) {
  r  = rep(TRUE, length(records))
  r[1] = FALSE
  r
}
options(breathtestcore.choose_record = choose_record)
bids = read_breathid_xml(filename)
str(bids, 1) # 2 elements, first deselected


</code></pre>

<hr>
<h2 id='read_breathtest_excel'>Reads breathtest data in Excel format</h2><span id='topic+read_breathtest_excel'></span>

<h3>Description</h3>

<p>Can read several formats of data sets in Excel, from
2 (<code>minute, pdr or dob</code> for 1 record) to 4 columns (<code>patient_id, 
group, minute, pdr or dob</code>). Conversion from dob to pdf is done for 
assuming 180 cm height and 75 kg weight.
See the example below with several sheets for supported formats
</p>


<h3>Usage</h3>

<pre><code class='language-R'>read_breathtest_excel(filename, sheet = 1)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="read_breathtest_excel_+3A_filename">filename</code></td>
<td>
<p>Name of Excel-file to be read</p>
</td></tr>
<tr><td><code id="read_breathtest_excel_+3A_sheet">sheet</code></td>
<td>
<p>Name or number of Excel file to be read. When used with 
<code><a href="#topic+read_any_breathtest">read_any_breathtest</a></code>, the first sheet is always read. You must 
call  <code>read_breathtest_excel</code> explicitly to read other worksheets, as shown
in the example below.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Different from the other readXXX function, this returns a list
with a data frame, not a structure of <code><a href="#topic+breathtest_data">breathtest_data</a></code>. 
Pass result through <code><a href="#topic+cleanup_data">cleanup_data</a></code> to make it compatible with 
other formats.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>filename = btcore_file("ExcelSamples.xlsx")
sheets = readxl::excel_sheets(filename)
# First 4 lines of each sheet
for (sheet in sheets) {
  cat("\nSheet ", sheet,"\n")
  ex = readxl::read_excel(filename, sheet = sheet, n_max = 4)
  print(ex)
}  
# To get consistently formatted data from a sheet
bt_data = read_breathtest_excel(filename, sheets[6])
# 3 columns
str(bt_data)
bt_cleaned = cleanup_data(bt_data)
# 4 columns standard format
str(bt_cleaned)
</code></pre>

<hr>
<h2 id='read_iris'>Read 13C data from IRIS/Wagner Analysen</h2><span id='topic+read_iris'></span>

<h3>Description</h3>

<p>Reads composite files with 13C data from IRIS/Wagner Analysen.
The composite files start as follows:
</p>
<pre>
"Testergebnis"
"Nummer","1330"
"Datum","10.10.2013"
"Testart"</pre>


<h3>Usage</h3>

<pre><code class='language-R'>read_iris(filename = NULL, text = NULL)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="read_iris_+3A_filename">filename</code></td>
<td>
<p>name of IRIS/Wagner file in composite format</p>
</td></tr>
<tr><td><code id="read_iris_+3A_text">text</code></td>
<td>
<p>alternatively, text can be given as string</p>
</td></tr>
</table>


<h3>Value</h3>

<p>List of class <code><a href="#topic+breathtest_data">breathtest_data</a></code> with 
<code>file_name, patient_name, patient_first_name,
test, identifikation</code>, and data frame <code>data</code> with <code>time</code>
and <code>dob</code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>filename = btcore_file("IrisMulti.TXT")
cat(readLines(filename, n = 10, encoding = "latin1"), sep="\n")
#
iris_data = read_iris(filename)
str(iris_data)
</code></pre>

<hr>
<h2 id='read_iris_csv'>Read 13C data from IRIS/Wagner Analysen in CSV Format</h2><span id='topic+read_iris_csv'></span>

<h3>Description</h3>

<p>Reads 13C data from IRIS/Wagner Analysen in CSV Format
The CSV files start as follows:
</p>
<pre>
"Name","Vorname","Test","Identifikation"
</pre> 
<p>This format does not have information about the substrate (acetate, octanoate),
the dose and body weight and height. The following defaults are used: <code>substrate = acetate, 
dose = 100,  weight = 75, height = 180</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>read_iris_csv(filename = NULL, text = NULL)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="read_iris_csv_+3A_filename">filename</code></td>
<td>
<p>Name of IRIS/Wagner file in CSV format</p>
</td></tr>
<tr><td><code id="read_iris_csv_+3A_text">text</code></td>
<td>
<p>alternatively, text can be given as string</p>
</td></tr>
</table>


<h3>Value</h3>

<p>List of class <code>breath_test_data</code> with <code>file name, 
patient name, patient first name, test, identifikation</code>,
and data frame <code>data</code> with <code>time</code> and <code>dob</code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>filename = btcore_file("IrisCSV.TXT")
cat(readLines(filename, n = 3, encoding = "latin1"), sep="\n")
#
iris_data = read_iris_csv(filename)
str(iris_data)
</code></pre>

<hr>
<h2 id='sigma.breathtestnlmefit'>S3 method to extract the fit's residual standard deviation</h2><span id='topic+sigma.breathtestnlmefit'></span>

<h3>Description</h3>

<p>Functions for <code>nls</code> and <code>nlme</code> are available; 
additional functions for Stan-based fits are defined in package <code>breathteststan</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'breathtestnlmefit'
sigma(object, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="sigma.breathtestnlmefit_+3A_object">object</code></td>
<td>
<p>Result of class <code>breathtestfit</code></p>
</td></tr>
<tr><td><code id="sigma.breathtestnlmefit_+3A_...">...</code></td>
<td>
<p>Not used</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A numeric value giving the standard deviation of the residuals.
</p>

<hr>
<h2 id='simulate_breathtest_data'>Simulate 13C breath time series data</h2><span id='topic+simulate_breathtest_data'></span>

<h3>Description</h3>

<p>Generates simulated breath test data, optionally with errors. If none of the three
standard deviations <code>m_std, k_std, beta_std</code> is given, an empirical covariance
matrix from USZ breath test data is used. If any of the standard deviations is given,
default values for the others will be used.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>simulate_breathtest_data(
  n_records = 10,
  m_mean = 40,
  m_std = NULL,
  k_mean = 0.01,
  k_std = NULL,
  beta_mean = 2,
  beta_std = NULL,
  noise = 1,
  cov = NULL,
  student_t_df = NULL,
  missing = 0,
  seed = NULL,
  dose = 100,
  first_minute = 5,
  step_minute = 15,
  max_minute = 155
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="simulate_breathtest_data_+3A_n_records">n_records</code></td>
<td>
<p>Number of records</p>
</td></tr>
<tr><td><code id="simulate_breathtest_data_+3A_m_mean">m_mean</code>, <code id="simulate_breathtest_data_+3A_m_std">m_std</code></td>
<td>
<p>Mean and between-record standard deviation of parameter m giving metabolized fraction.</p>
</td></tr>
<tr><td><code id="simulate_breathtest_data_+3A_k_mean">k_mean</code>, <code id="simulate_breathtest_data_+3A_k_std">k_std</code></td>
<td>
<p>Mean and between-record standard deviation of parameter k, in units of 1/minutes.</p>
</td></tr>
<tr><td><code id="simulate_breathtest_data_+3A_beta_mean">beta_mean</code>, <code id="simulate_breathtest_data_+3A_beta_std">beta_std</code></td>
<td>
<p>Mean and between-record standard deviations of lag parameter beta</p>
</td></tr>
<tr><td><code id="simulate_breathtest_data_+3A_noise">noise</code></td>
<td>
<p>Standard deviation of normal noise when <code>student_t_df = NULL</code>; scaling of noise when student_t_df &gt;= 2.</p>
</td></tr>
<tr><td><code id="simulate_breathtest_data_+3A_cov">cov</code></td>
<td>
<p>Covariance matrix, default NULL, i.e. not used. If given, overrides 
standard deviation settings.</p>
</td></tr>
<tr><td><code id="simulate_breathtest_data_+3A_student_t_df">student_t_df</code></td>
<td>
<p>When NULL (default), Gaussian noise is added; when &gt;= 2, Student_t distributed noise is added, which generates more realistic outliers. Values from 2 to 5 are useful, when higher values are used the result comes close to that of Gaussian noise. Values below 2 are truncated to 2.</p>
</td></tr>
<tr><td><code id="simulate_breathtest_data_+3A_missing">missing</code></td>
<td>
<p>When 0 (default), all curves have the same number of data points. When &gt; 0, this is the fraction of points that were removed randomly to simulate missing</p>
</td></tr>
<tr><td><code id="simulate_breathtest_data_+3A_seed">seed</code></td>
<td>
<p>Optional seed; not set if seed = NULL (default)</p>
</td></tr>
<tr><td><code id="simulate_breathtest_data_+3A_dose">dose</code></td>
<td>
<p>Octanoate/acetate dose, almost always 100 mg, which is also the default</p>
</td></tr>
<tr><td><code id="simulate_breathtest_data_+3A_first_minute">first_minute</code></td>
<td>
<p>First sampling time. Do not use 0 here, some algorithms do not 
converge when data near 0 are passed.</p>
</td></tr>
<tr><td><code id="simulate_breathtest_data_+3A_step_minute">step_minute</code></td>
<td>
<p>Inter-sample interval for breath test</p>
</td></tr>
<tr><td><code id="simulate_breathtest_data_+3A_max_minute">max_minute</code></td>
<td>
<p>Maximal time in minutes.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list of class simulated_breathtest_data with 2  elements:
</p>

<dl>
<dt>record</dt><dd><p>Data frame with columns
<code>patient_id(chr), m, k, beta, t50</code> giving the effective parameters 
for the individual patient record.</p>
</dd>
<dt>data</dt><dd><p>Data frame with columns
<code>patient_id(chr), minute(dbl), pdr(dbl)</code> giving the
time series and grouping parameters.</p>
</dd>
</dl>

<p>A comment is attached to the return value that can be used as a title for plotting.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>library(ggplot2)
pdr = simulate_breathtest_data(n_records = 4, seed = 4711, missing = 0.3,
       student_t_df = 2, noise = 1.5) # Strong outliers
#
str(pdr, 1)  
#
pdr$record # The "correct" parameters
#
# Explicit plotting
ggplot(pdr$data, aes(x = minute, y = pdr)) + geom_point() +
  facet_wrap(~patient_id) + ggtitle(comment(pdr$data))
#
# Or use cleanup_data and null_fit for S3 plotting
plot(null_fit(cleanup_data(pdr$data)))
</code></pre>

<hr>
<h2 id='subsample_data'>Decimate densely sampled 13C time series</h2><span id='topic+subsample_data'></span>

<h3>Description</h3>

<p>When data of a record are more closely spaced than <code>sample_minutes</code>, 
these are spline-subsampled to <code>sample_minutes</code>. In the region of the initial slope,
i.e. the initial fifth of the time, the record is sampled more densely.
Too dense sampling leads to non-convergent <code>nlme</code> fits and to long runs
with Stan-based fits. 
The function is used internally by function <code>link{nlme_fit}</code> in 
package <code>breathtestcore</code> and is exported 
for use  by package <code>breathteststan</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>subsample_data(data, sample_minutes)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="subsample_data_+3A_data">data</code></td>
<td>
<p>Data frame with columns <code>patient_id, group, minute, pdr</code>.</p>
</td></tr>
<tr><td><code id="subsample_data_+3A_sample_minutes">sample_minutes</code></td>
<td>
<p>Required average density. When points are more closely
spaced, data are subsampled. No upsampling occurs when data are more sparse.</p>
</td></tr>
</table>

<hr>
<h2 id='t50_bluck_coward'>Bluck-Coward self-corrected half-emptying time</h2><span id='topic+t50_bluck_coward'></span>

<h3>Description</h3>

<p>Uses Newton's method to solve the self-corrected Bluck-Coward equation
for 1/2 to compute the half-emptying time t_50. 
</p>
<p>See also equation G(n,t) in 
</p>
<p>Bluck LJC, Jackson S, Vlasakakis G, Mander A (2011)
Bayesian hierarchical methods to interpret  the 13C-octanoic acid breath
test for gastric emptying. Digestion 83_96-107, page 98.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>t50_bluck_coward(cf)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="t50_bluck_coward_+3A_cf">cf</code></td>
<td>
<p>Named vector of coefficients; only <code>k</code> and <code>beta</code> are required.
In this package, <code>k</code> is measured in units of 1/min (e.g. 0.01/min),
in publications it is often quoted as 1/h (e.g. 0.6/h).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Time where value is 1/2 of the maximum, i.e. t_50 or t_1/2 in minutes; 
in the publication by Bluck et al, the parameter is called t_1/2(in).
</p>


<h3>See Also</h3>

<p><code><a href="#topic+exp_beta">exp_beta</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># From table 3 and 4 in Bluck et al.; values for \code{k} and \code{beta} 
# (nls, bayesian) are entered and checked against the tabulated values of 
# t_{1/2(in)}.
# Most errors are small, but there are some outliers; errors in paper table?
# Parameters and Bluck et al. results:
# table 3 of Bluck et al.
cf3 = data.frame(
          method = rep(c("nls", "bayesian")),
          group = rep(c("lean", "obese"),each=2),
          k =    c(0.576,0.606,0.529,0.608),
          beta = c(5.24, 5.79, 5.95, 7.54),
          t12 =  c(3.67, 3.63, 4.23, 3.99),
          t12in = c(2.076, 2.110, 2.422, 2.466),
          tlag = c(2.88, 2.88, 3.34, 3.26),
          tlagin = c(1.632, 1.724, 1.92, 2.101)
)
cf3 = dplyr::mutate(cf3,
          t50_maes_ghoos = t50_maes_ghoos(cf3),
          t50_bluck_coward = t50_bluck_coward(cf3),
          tlag_maes_ghoos = tlag_maes_ghoos(cf3),
          tlag_bluck_coward = tlag_bluck_coward(cf3),
          err_t50_maes_ghoos = round(100*(t50_maes_ghoos-t12)/t12, 2),
          err_t50_bluck_coward =
            round(100*(t50_bluck_coward-t12in)/t12in, 2),
          err_lag_maes = round(100*(tlag_maes_ghoos-tlag)/tlag,2),
          err_lag_bluck_coward =
            round(100*(tlag_bluck_coward-tlagin)/tlagin,2)
)
cf3
# table 4
# there are large differences for mj3, both using the bayesian (26%)
# and the nls method (16%).  The other data are within the expected limits
cf4 = data.frame(
          method = rep(c("nls", "bayesian"),each=3),
          group = rep(c("mj1",   "mj2",   "mj3")),  
          k = c(0.585,  0.437,  0.380,  0.588,  0.418,  0.361),  
          beta=c(4.35,  4.08,  4.44,  4.49, 4.30, 4.29), 
          t12 = c(3.39, 4.25, 4.82, 3.40, 4.61, 5.09), 
          t12in = c(1.77, 2.16, 2.19, 1.81, 2.34, 2.43), 
          tlag = c(2.56, 3.17, 3.39, 2.58, 3.40, 3.62), 
          tlagin = c(1.30, 1.53, 1.33, 1.35, 1.65, 1.57)
)
cf4 = dplyr::mutate(cf4,
          t50_maes_ghoos = t50_maes_ghoos(cf4),
          t50_bluck_coward = t50_bluck_coward(cf4),
          tlag_maes_ghoos = tlag_maes_ghoos(cf4),
          tlag_bluck_coward = tlag_bluck_coward(cf4),
          err_t50_maes_ghoos = unlist(round(100*(t50_maes_ghoos-t12)/t12)),
          err_t50_bluck_coward =
            round(100*(t50_bluck_coward-t12in)/t12in,2),
          err_lag_maes = round(100*(tlag_maes_ghoos-tlag)/tlag,2),
          err_lag_bluck_coward =
            round(100*(tlag_bluck_coward-tlagin)/tlagin,2)
)
cf4

</code></pre>

<hr>
<h2 id='t50_maes_ghoos'>Half-emptying time by Maes/Ghoos method</h2><span id='topic+t50_maes_ghoos'></span>

<h3>Description</h3>

<p>Half-emptying time t50 as determined from the fit of a
beta exponential function. In the Maes/Ghoos model, it is defined as the time
when the area under curve (AUC) is 50% of the AUC from 0 to infinity.
</p>
<p>Maes B D, Ghoos Y F, Rutgeerts P J, Hiele M I, Geypens B and Vantrappen G 1994 
Dig. Dis. Sci. 39 S104-6.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>t50_maes_ghoos(cf)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="t50_maes_ghoos_+3A_cf">cf</code></td>
<td>
<p>named vector of coefficients; only <code>k</code> and <code>beta</code> are required
note that <code>k</code> is measured in 1/min (e.g. 0.01/min),
usually it is quoted as 1/h (e.g. 0.6/h).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Time in minutes when area under curve is 50% of the AUC to infinity.
In the Maes/Ghoos model, this is used as a surrogate for gastric emptying 
half time <code>t50</code>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+exp_beta">exp_beta</a></code>, and <code><a href="#topic+t50_bluck_coward">t50_bluck_coward</a></code> for an example.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Integral from 0 to infinity is 100 at dose 100 mg
integrate(exp_beta, 0, Inf, beta = 1.5, k = 0.01, m = 1, dose = 100)
t50_mg = t50_maes_ghoos(c(beta = 1.5, k = 0.01, dose = 100))
t50_mg
# Integral to half-emptying time \code{t50_maes_ghoos} is 50 
integrate(exp_beta, 0, t50_mg, beta = 1.5, k = 0.01, m = 1, dose = 100)
</code></pre>

<hr>
<h2 id='t50_maes_ghoos_scintigraphy'>Half-emptying time t50 from Maes/Ghoos fit with scintigraphic correction</h2><span id='topic+t50_maes_ghoos_scintigraphy'></span>

<h3>Description</h3>

<p>Half-emptying time t50 in minutes from beta exponential function fit,
with linear and rather arbitrary correction for 
scintigraphic values. This is given for comparison with published data only;
there is little justification to use it, even if it is closer to real gastric
emptying times as determined by MRI or scintigraphy.
Ghoos YF, Maes BD, Geypens BJ, Mys G, Hiele MI, Rutgeerts PJ, Vantrappen G. 
Measurement of gastric emptying rate of solids by means of a carbon-labeled 
octanoic acid breath test. Gastroenterology. 1993;104:1640-1647.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>t50_maes_ghoos_scintigraphy(cf)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="t50_maes_ghoos_scintigraphy_+3A_cf">cf</code></td>
<td>
<p>named vector of coefficients; only <code>k</code> and <code>beta</code> are required</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Time where value is 1/2 of maximum, i.e. t50 in minutes.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+exp_beta">exp_beta</a></code>, and <code><a href="#topic+t50_bluck_coward">t50_bluck_coward</a></code> for an example.
</p>

<hr>
<h2 id='tidy.breathtestfit'>Broom-style tidying methods for breathtestfit</h2><span id='topic+tidy.breathtestfit'></span>

<h3>Description</h3>

<p>Broom-method <code><a href="generics.html#topic+tidy">tidy</a></code> to streamline the results of class 
<code>breathttestfit</code>  as generated by  <code>nls_fit</code> or <code>nlme_fit</code>. Returns 
the fit  coefficients and half-emptying time t50 with the Maes/Ghoos method; 
additional parameters should be extracted with <code><a href="#topic+coef.breathtestfit">coef</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'breathtestfit'
tidy(x, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="tidy.breathtestfit_+3A_x">x</code></td>
<td>
<p>Object of class <code>breathttestfit</code></p>
</td></tr>
<tr><td><code id="tidy.breathtestfit_+3A_...">...</code></td>
<td>
<p>other parameters passed to methods</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A tibble/data frame with columns
</p>

<dl>
<dt>patient_id</dt><dd><p>Patient Id (character)</p>
</dd>
<dt>group</dt><dd><p>Treatment or patient group (character)</p>
</dd>
<dt>m</dt><dd><p>Fraction metabolized</p>
</dd>
<dt>k</dt><dd><p>Time constant (1/minutes)</p>
</dd>
<dt>beta</dt><dd><p>The so-called lag parameters, no dimension</p>
</dd>
<dt>t50</dt><dd><p>Emptying half time in minutes as calculated following Maes/Ghoos</p>
</dd>
</dl>



<h3>See Also</h3>

<p><code><a href="generics.html#topic+tidy">tidy</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>library(broom)
# Generate simulated data
data = cleanup_data(simulate_breathtest_data()$data)
# Fit with the population method
fit = nlme_fit(data)
# Output coefficients
tidy(fit)
# All coefficients in the long form
coef(fit)
</code></pre>

<hr>
<h2 id='tlag_bluck_coward'>Lag phase for Bluck-Coward self-correcting fit</h2><span id='topic+tlag_bluck_coward'></span>

<h3>Description</h3>

<p>This parameter is probably not very useful, as it can be negative
</p>


<h3>Usage</h3>

<pre><code class='language-R'>tlag_bluck_coward(cf)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="tlag_bluck_coward_+3A_cf">cf</code></td>
<td>
<p>named vector of coefficients; only <code>k</code> and <code>beta</code> are required.
Note that in this package,  <code>k</code> is measured in 1/min (e.g. 0.01/min),
while in the literature is is often quoted as 1/h (e.g. 0.6/h).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Lag phase in minutes (time t at which the maximum in the rate of change
of g(t) occurs)
</p>


<h3>See Also</h3>

<p><code><a href="#topic+exp_beta">exp_beta</a></code>, and <code><a href="#topic+t50_bluck_coward">t50_bluck_coward</a></code> for an example.
</p>

<hr>
<h2 id='tlag_maes_ghoos'>So-called lag time from Maes/Ghoos fit</h2><span id='topic+tlag_maes_ghoos'></span>

<h3>Description</h3>

<p>Computes <code>tlag</code> from uncorrected fit to the beta 
exponential function. The name <code>tlag</code> is a misnomer; it simply 
is the maximum of the PDR curve, so in papers by Bluck et al. it is renamed to t_max.
</p>
<p>Maes B D, Ghoos Y F, Rutgeerts P J, Hiele M I, Geypens B and Vantrappen G 1994 
Dig. Dis. Sci. 39 S104-6.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>tlag_maes_ghoos(cf)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="tlag_maes_ghoos_+3A_cf">cf</code></td>
<td>
<p>named vector of coefficients; only <code>k</code> and <code>beta</code> are required
<code>k</code> is measured in 1/min (e.g. 0.01/min).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Lag time as defined from Maes/Ghoos fit
</p>


<h3>See Also</h3>

<p><code><a href="#topic+exp_beta">exp_beta</a></code>, and <code><a href="#topic+t50_bluck_coward">t50_bluck_coward</a></code> for an example.
</p>

<hr>
<h2 id='usz_13c'>Zurich sample set of 13C breath test data</h2><span id='topic+usz_13c'></span>

<h3>Description</h3>

<p>13C time series PDR data from normals and random patients
from the division of <a href="https://www.usz.ch/fachbereich/gastroenterologie-und-hepatologie/">Gastroenterology and Hepatology,
University Hospital Zurich</a>.
Most breath samples from normals were collected with bags and analyzed by
<a href="http://kibion.com">IRIS/Wagner</a>
infrared spectroscopy. Patient samples were recorded with the continuous
monitoring system <a href="https://www.meridianbioscience.com/">BreathID</a>.
</p>

<dl>
<dt>patient_id</dt><dd><p>Patient identifier, starting with <code>norm</code> for normals
(healthy volunteers) and  <code>pat</code> for patients. Note that for normals
there are two records for each subject, so only the combination of patient_id 
and group is a unique identifier of the time series record.</p>
</dd>
<dt>group</dt><dd><p><code>liquid_normal</code> for normals and liquid meal,
<code>solid_normal</code> normals and solid meal, and <code>patient</code> for patients
from the University Hospital of Zurich.</p>
</dd>
<dt>minute</dt><dd><p>Time in minutes</p>
</dd>
<dt>pdr</dt><dd><p>PDR as computed by breathtest device or from dob via function dob_to_pdr</p>
</dd>
</dl>



<h3>Usage</h3>

<pre><code class='language-R'>data(usz_13c)
</code></pre>


<h3>Format</h3>

<p>A data frame with 15574 rows and 4 variables
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(usz_13c)
## Not run: 
str(usz_13c)
# Plot all records; this needs some time
pdf(file.path(tempdir(), "usz_13c.pdf"), height= 30)
# null_fit makes data plotable without fitting a model
plot(null_fit(usz_13c))
dev.off()

## End(Not run)
# Plot a subset
suppressPackageStartupMessages(library(dplyr))
usz_part =  usz_13c  %&gt;% 
  filter(patient_id %in% c("norm_001","norm_002", "pat_001", "pat_002"))
plot(null_fit(usz_part))
</code></pre>

<hr>
<h2 id='usz_13c_a'>Exotic 13C breath test data</h2><span id='topic+usz_13c_a'></span>

<h3>Description</h3>

<p>13C time series PDR data from three different groups in a randomized
(= not-crossover) design. This are unpublished data from
<a href="https://www.usz.ch/fachbereich/gastroenterologie-und-hepatologie/">Gastroenterology and Hepatology,
University Hospital Zurich</a>. 
</p>
<p>Data are formatted as described in <code><a href="#topic+usz_13c">usz_13c</a></code>. These time series present
a challenge for algorithms.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(usz_13c_a)
</code></pre>


<h3>Examples</h3>

<pre><code class='language-R'>
library(dplyr)
library(ggplot2)
data(usz_13c_a)
d = usz_13c_a %&gt;% 
  cleanup_data() %&gt;% # recommended to test for validity
  nlme_fit()
plot(d)

</code></pre>

<hr>
<h2 id='usz_13c_d'>13C breath test data with MRI emptying for comparison</h2><span id='topic+usz_13c_d'></span>

<h3>Description</h3>

<p>13C time series PDR data from normals and three different meals 
in a cross-over design from the division of 
<a href="https://www.usz.ch/fachbereich/gastroenterologie-und-hepatologie/">Gastroenterology and Hepatology,
University Hospital Zurich</a>. See
<a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/nmo.12025">Kuyumcu et al.,
Gastric secretion does not affect...</a>.
</p>
<p>Data are formatted as described in <code><a href="#topic+usz_13c">usz_13c</a></code>. In addition, half
emptying times from MRI measurements are attached to the data as attribute
<code>mri_t50</code>. The example below shows how to analyze the data and present half
emptying times from MRI and 13C in diagrams.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(usz_13c_d)
</code></pre>


<h3>Examples</h3>

<pre><code class='language-R'>
library(dplyr)
library(ggplot2)
data(usz_13c_d)
mri_t50 = attr(usz_13c_d, "mri_t50")
d = usz_13c_d %&gt;% 
  cleanup_data() %&gt;% # recommended to test for validity
  nlme_fit()
plot(d) +
  geom_vline(data = mri_t50, aes(xintercept = t50), linetype = 2)

# Maes-Ghoos t50
dd = mri_t50 %&gt;% 
  inner_join(
    coef(d) %&gt;% filter(parameter=="t50", method == "maes_ghoos"),
    by = c("patient_id", "group")) %&gt;% 
  mutate(
    t50_maes_ghoos = value
 )

ggplot(dd, aes(x=t50, y = t50_maes_ghoos, color = group)) +  
  geom_point() +
  facet_wrap(~group) +
  geom_abline(slope = 1, intercept = 0) +
  xlim(45,205) +
  ylim(45,205) 

# Bluck-Coward t50
dd = mri_t50 %&gt;% 
  inner_join(
    coef(d) %&gt;% filter(parameter=="t50", method == "bluck_coward"),
    by = c("patient_id", "group")) %&gt;% 
  mutate(
    t50_bluck_coward = value
 )

ggplot(dd, aes(x=t50, y = t50_bluck_coward, color = group)) +  
  geom_point() +
  facet_wrap(~group) +
  geom_abline(slope = 1, intercept = 0) +
  xlim(0,205) +
  ylim(0,205) 

</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
