<!DOCTYPE html><html><head><title>Help for package safedata</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {safedata}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#add_locations'><p>Adds location data to a SAFE data worksheet.</p></a></li>
<li><a href='#add_taxa'><p>Add a taxonomic hierarchy to a SAFE data worksheet.</p></a></li>
<li><a href='#download_gazetteer'><p>Downloads the current SAFE gazetteer</p></a></li>
<li><a href='#download_index'><p>Downloads the current dataset index</p></a></li>
<li><a href='#download_location_aliases'><p>Downloads the current SAFE location aliases</p></a></li>
<li><a href='#download_safe_files'><p>Download SAFE dataset files</p></a></li>
<li><a href='#fetch_record_metadata'><p>Get and load SAFE dataset metadata</p></a></li>
<li><a href='#file_status'><p>Get file status for a dataset</p></a></li>
<li><a href='#get_data_dir'><p>Checks the data directory is set and returns it</p></a></li>
<li><a href='#get_file_details'><p>Get file details for a record</p></a></li>
<li><a href='#get_index'><p>Get the cached dataset index</p></a></li>
<li><a href='#get_locations'><p>Obtaining locations for a SAFE dataset.</p></a></li>
<li><a href='#get_taxa'><p>Obtaining taxonomy for a SAFE dataset.</p></a></li>
<li><a href='#get_taxon_coverage'><p>Retrieve the current taxon index</p></a></li>
<li><a href='#get_taxon_graph'><p>Get a graph of the taxa in a dataset</p></a></li>
<li><a href='#igraph_to_phylo'><p>Getting a phylogeny for a dataset</p></a></li>
<li><a href='#insert_dataset'><p>Inserts local copies of files from a dataset into a SAFE data directory</p></a></li>
<li><a href='#load_gazetteer'><p>Load and cache the SAFE gazetteer</p></a></li>
<li><a href='#load_index'><p>Load and cache the dataset index</p></a></li>
<li><a href='#load_location_aliases'><p>Load and cache the SAFE location aliases</p></a></li>
<li><a href='#load_safe_data'><p>Loads data from a SAFE dataset.</p></a></li>
<li><a href='#safe_api_search'><p>Internal SAFE dataset API search functions</p></a></li>
<li><a href='#safedata'><p>Finding and using data from the SAFE Project.</p></a></li>
<li><a href='#safedata_env'><p>Index file memory cache</p></a></li>
<li><a href='#safedata_network'><p>Network resources and the safedata package.</p></a></li>
<li><a href='#search_safe'><p>SAFE dataset search functions.</p></a></li>
<li><a href='#set_example_safe_dir'><p>Functions to use an example data directory for package examples</p></a></li>
<li><a href='#set_safe_dir'><p>Set the local SAFE data directory</p></a></li>
<li><a href='#show_concepts'><p>Show SAFE dataset metadata</p></a></li>
<li><a href='#taxon_index_to_taxon_table'><p>Add taxon hierarchy to taxon metadata</p></a></li>
<li><a href='#try_to_download'><p>Attempt to download a URL resource, failing gracefully.</p></a></li>
<li><a href='#validate_record_ids'><p>Validates dataset record ids from user input</p></a></li>
<li><a href='#verbose_message'><p>Message function that can be globally muted</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Interface to Data from the SAFE Project</td>
</tr>
<tr>
<td>Version:</td>
<td>1.1.3</td>
</tr>
<tr>
<td>Date:</td>
<td>2023-05-05</td>
</tr>
<tr>
<td>Description:</td>
<td>The SAFE Project (<a href="https://www.safeproject.net/">https://www.safeproject.net/</a>) is a large 
	scale ecological experiment in Malaysian Borneo that explores the impact 
	of habitat fragmentation and conversion on ecosystem function and services. 
	Data collected at the SAFE Project is made available under a common format 
	through the Zenodo data repository and this package makes it easy to 
	discover and load that data into R.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a></td>
</tr>
<tr>
<td>Imports:</td>
<td>readxl, jsonlite, chron, curl, sf, httr, igraph</td>
</tr>
<tr>
<td>Suggests:</td>
<td>knitr, rmarkdown, ape, testthat (&ge; 2.1.0)</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://imperialcollegelondon.github.io/safedata/index.html">https://imperialcollegelondon.github.io/safedata/index.html</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/ImperialCollegeLondon/safedata/issues">https://github.com/ImperialCollegeLondon/safedata/issues</a></td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.2.0</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2023-05-05 11:30:41 UTC; dorme</td>
</tr>
<tr>
<td>Author:</td>
<td>Andy Aldersley [aut],
  David Orme <a href="https://orcid.org/0000-0002-7005-1394"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [aut,
    cre]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>David Orme &lt;d.orme@imperial.ac.uk&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2023-05-05 15:00:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='add_locations'>Adds location data to a SAFE data worksheet.</h2><span id='topic+add_locations'></span>

<h3>Description</h3>

<p>This function adds location data to the rows of a SAFE data worksheet,
converting it into a <code><a href="sf.html#topic+sf">sf</a></code> spatial features object. Rows
are matched to values in a location_field: if there is only one location
field, it will be used automatically; otherwise, the specific field must
be provided.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>add_locations(
  obj,
  location_field = NULL,
  location_table = NULL,
  gazetteer_info = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="add_locations_+3A_obj">obj</code></td>
<td>
<p>An existing object of class <code>safedata</code></p>
</td></tr>
<tr><td><code id="add_locations_+3A_location_field">location_field</code></td>
<td>
<p>The name of a location field in a
<code>safedata</code> object.</p>
</td></tr>
<tr><td><code id="add_locations_+3A_location_table">location_table</code></td>
<td>
<p>An existing location table for a dataset,
as generated by <code><a href="#topic+get_locations">get_locations</a></code>.</p>
</td></tr>
<tr><td><code id="add_locations_+3A_gazetteer_info">gazetteer_info</code></td>
<td>
<p>Should all the gazetteer fields be included in
the returned <code><a href="sf.html#topic+sf">sf</a></code>  object. See
<code><a href="#topic+load_gazetteer">load_gazetteer</a></code> for details.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A modified <code>safedata</code> object including geometry data.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+get_locations">get_locations</a></code>, <code><a href="#topic+load_gazetteer">load_gazetteer</a></code>,
<code><a href="#topic+load_location_aliases">load_location_aliases</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>   set_example_safe_dir()
   beetle_abund &lt;- load_safe_data(1400562, "Ant-Psel")
   beetle_abund &lt;- add_locations(beetle_abund)
   unset_example_safe_dir()
</code></pre>

<hr>
<h2 id='add_taxa'>Add a taxonomic hierarchy to a SAFE data worksheet.</h2><span id='topic+add_taxa'></span>

<h3>Description</h3>

<p>All datasets containing taxon observations provide taxonomic data (see
<code><a href="#topic+get_taxa">get_taxa</a></code>) that can be linked to rows in data worksheets
that contain &quot;taxa&quot; fields. This function matches the taxonomic hierarchy
for a dataset for a given taxon field in a data worksheet and inserts
fields to show that hierarchy.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>add_taxa(
  obj,
  taxon_field = NULL,
  taxon_table = NULL,
  prefix = NULL,
  which = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="add_taxa_+3A_obj">obj</code></td>
<td>
<p>An existing object of class <code>safedata</code></p>
</td></tr>
<tr><td><code id="add_taxa_+3A_taxon_field">taxon_field</code></td>
<td>
<p>The name of a taxon field in a <code>safedata</code> for
which to add taxonomic data.</p>
</td></tr>
<tr><td><code id="add_taxa_+3A_taxon_table">taxon_table</code></td>
<td>
<p>An existing taxon table for a dataset, as generated by
<code><a href="#topic+get_taxa">get_taxa</a></code>.</p>
</td></tr>
<tr><td><code id="add_taxa_+3A_prefix">prefix</code></td>
<td>
<p>A string to be appended to taxon field names, primarily to
discriminate between fields of multiple taxonomies are to be added.</p>
</td></tr>
<tr><td><code id="add_taxa_+3A_which">which</code></td>
<td>
<p>A vector specifying a subset of taxonomy table field
names to add.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>An existing taxon table can be provided to the function, but the table
will be automatically loaded if no table is provided. If a data worksheet
only contains a single taxon field, then that field will be used
automatically, otherwise users have to specify which taxon field to use.
A prefix can be added to taxon fields in order to discrimate between
fields from multuple taxon fields. By default, the function adds all of
the fields included in the output of <code><a href="#topic+get_taxa">get_taxa</a></code>, but
<code>which</code> allows a subset of field names to be used.
</p>


<h3>Value</h3>

<p>A modified <code>safedata</code> object with added taxonomic columns.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+get_taxa">get_taxa</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>   set_example_safe_dir()
   beetle_morph &lt;- load_safe_data(1400562, "MorphFunctTraits")
   beetle_morph &lt;- add_taxa(beetle_morph)
   unset_example_safe_dir()
</code></pre>

<hr>
<h2 id='download_gazetteer'>Downloads the current SAFE gazetteer</h2><span id='topic+download_gazetteer'></span>

<h3>Description</h3>

<p>This function downloads the gazetteer from the SAFE data
gazetteer API (e.g. <a href="https://www.safeproject.net/api/gazetteer">https://www.safeproject.net/api/gazetteer</a>)
and saves it in the root of the safe data directory.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>download_gazetteer()
</code></pre>

<hr>
<h2 id='download_index'>Downloads the current dataset index</h2><span id='topic+download_index'></span>

<h3>Description</h3>

<p>This function downloads the dataset index from the SAFE data
API (e.g. <a href="https://www.safeproject.net/api/index">https://www.safeproject.net/api/index</a>) and saves
it in the root SAFE data directory
</p>


<h3>Usage</h3>

<pre><code class='language-R'>download_index()
</code></pre>

<hr>
<h2 id='download_location_aliases'>Downloads the current SAFE location aliases</h2><span id='topic+download_location_aliases'></span>

<h3>Description</h3>

<p>This function downloads the location aliases from the SAFE data
location aliases API (for example,
<a href="https://www.safeproject.net/api/location_aliases">https://www.safeproject.net/api/location_aliases</a>)
and saves it in the root of the safe data directory.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>download_location_aliases()
</code></pre>

<hr>
<h2 id='download_safe_files'>Download SAFE dataset files</h2><span id='topic+download_safe_files'></span>

<h3>Description</h3>

<p>This downloads files associated with SAFE datasets, either all of the
files included in a set of records (<code>xlsx_only = FALSE</code>) or just
the core .xlsx files (<code>xlsx_only = FALSE</code>), and stores them in the
SAFE data directory. See <code><a href="#topic+insert_dataset">insert_dataset</a></code> for details on
using embargoed or restricted datasets.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>download_safe_files(
  record_ids,
  confirm = TRUE,
  xlsx_only = TRUE,
  download_metadata = TRUE,
  refresh = FALSE,
  token = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="download_safe_files_+3A_record_ids">record_ids</code></td>
<td>
<p>A vector of SAFE dataset record ids or a
<code><a href="#topic+safe_record_set">safe_record_set</a></code> object.</p>
</td></tr>
<tr><td><code id="download_safe_files_+3A_confirm">confirm</code></td>
<td>
<p>Requires the user to confirm before download (logical)</p>
</td></tr>
<tr><td><code id="download_safe_files_+3A_xlsx_only">xlsx_only</code></td>
<td>
<p>Should all files be downloaded or just the core .xslx
file (logical)</p>
</td></tr>
<tr><td><code id="download_safe_files_+3A_download_metadata">download_metadata</code></td>
<td>
<p>Should the metadata record for the file be
downloaded (logical)</p>
</td></tr>
<tr><td><code id="download_safe_files_+3A_refresh">refresh</code></td>
<td>
<p>Should the function check if local copies have been
modified and download fresh copies. This is useful if the local
copies have unintentionally been modified but note the warning above.</p>
</td></tr>
<tr><td><code id="download_safe_files_+3A_token">token</code></td>
<td>
<p>An access token for restricted datasets. These tokens are
requested through the Zenodo page for a restricted dataset and are
long alphanumeric strings. If you are providing a token, you should
only provide the record id for that dataset.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>By default, the function will also download the dataset metadata. This
information is required by many of the functions in the package but users
can turn off automatic metadata download.
</p>


<h3>Value</h3>

<p>Invisibly, a vector of paths within the 'safe_dir' for
successfully downloaded files. If the download is not successful then
the function returns FALSE.
</p>


<h3>Warning</h3>

<p>Using <code>refresh = TRUE</code> will <strong>overwrite locally modified
files</strong> and replace them with the versions of record from Zenodo.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>   
       set_example_safe_dir()
       recs &lt;- validate_record_ids(c(3247631, 3266827, 3266821))
       download_safe_files(recs, confirm = FALSE)
       unset_example_safe_dir()
   
   ## Not run: 
       # This example requires a private token
       download_safe_files(1237730, confirm = FALSE,
                           token="longStringFromZenodo")
   
## End(Not run)
</code></pre>

<hr>
<h2 id='fetch_record_metadata'>Get and load SAFE dataset metadata</h2><span id='topic+fetch_record_metadata'></span><span id='topic+load_record_metadata'></span>

<h3>Description</h3>

<p>Internal handlers to i) ensure there are local copies of record metadata,
fetching it from the SAFE project website if needed and ii) load that
data from file.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>fetch_record_metadata(record_set)

load_record_metadata(record_set)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="fetch_record_metadata_+3A_record_set">record_set</code></td>
<td>
<p>An object of class <code><a href="#topic+safe_record_set">safe_record_set</a></code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This is the same metadata used to populate the Zenodo description but is
downloaded as JSON format and stored within the record directory in the
SAFE data directory for reuse.
</p>


<h3>Value</h3>

<p>The <code>fetch_record_metadata</code> function invisibly returns a
logical value indicating if all records were fetched successfully and
<code>load_record_metadata</code> returns a list object containing record
metadata
</p>


<h3>Functions</h3>


<ul>
<li> <p><code>fetch_record_metadata</code>: Download and store JSON metadata for
a record
</p>
</li>
<li> <p><code>load_record_metadata</code>: Load JSON metadata for a record
</p>
</li></ul>


<h3>Examples</h3>

<pre><code class='language-R'>   
   set_example_safe_dir()
   rec &lt;- validate_record_ids(1400562)
   safedata:::fetch_record_metadata(rec)
   metadata &lt;- safedata:::load_record_metadata(rec)
   unset_example_safe_dir()
   
</code></pre>

<hr>
<h2 id='file_status'>Get file status for a dataset</h2><span id='topic+file_status'></span>

<h3>Description</h3>

<p>This returns a formatted status string for <code><a href="#topic+show_record">show_record</a></code> and
<code><a href="#topic+show_worksheet">show_worksheet</a></code> showing if a dataset is available globally
or locally as a private copy.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>file_status(metadata)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="file_status_+3A_a">A</code></td>
<td>
<p>loaded metadata dictionary for a record</p>
</td></tr>
</table>

<hr>
<h2 id='get_data_dir'>Checks the data directory is set and returns it</h2><span id='topic+get_data_dir'></span>

<h3>Description</h3>

<p>Checks the data directory is set and returns it
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_data_dir()
</code></pre>

<hr>
<h2 id='get_file_details'>Get file details for a record</h2><span id='topic+get_file_details'></span>

<h3>Description</h3>

<p>This function returns a list of the files associated with a record.
The access status of the record is reported, along with the local
absolute file path and whether a local copy is present. If there
is no local copy and the dataset is open access, you can use
<code><a href="#topic+download_safe_files">download_safe_files</a></code> to get local copies. If the dataset
is embargoed or restricted, see <code><a href="#topic+insert_dataset">insert_dataset</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_file_details(record_id)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="get_file_details_+3A_record_id">record_id</code></td>
<td>
<p>A record id</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame with fields: filename, dataset_access, path
and local.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>   
   set_example_safe_dir()
   files &lt;- get_file_details(1400562)
   unset_example_safe_dir()
   
</code></pre>

<hr>
<h2 id='get_index'>Get the cached dataset index</h2><span id='topic+get_index'></span>

<h3>Description</h3>

<p>This function just safely retrieves the safedata index from the
package cache.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_index()
</code></pre>


<h3>Value</h3>

<p>A data frame containing the dataset index details.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+load_index">load_index</a></code>
</p>

<hr>
<h2 id='get_locations'>Obtaining locations for a SAFE dataset.</h2><span id='topic+get_locations'></span>

<h3>Description</h3>

<p>This function returns a spatial 'simple features' (<code><a href="sf.html#topic+sf">sf</a></code>)
object for a dataset record, including basic information about locations
for the SAFE gazetteer if requested.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_locations(obj, gazetteer_info = FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="get_locations_+3A_obj">obj</code></td>
<td>
<p>A single record id, or an existing safedata dataframe.</p>
</td></tr>
<tr><td><code id="get_locations_+3A_gazetteer_info">gazetteer_info</code></td>
<td>
<p>Should all the gazetteer fields be included in the
returned <code><a href="sf.html#topic+sf">sf</a></code> object.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>All SAFE datasets recording observations from the field must include a
Locations worksheet, which must contain all of the location names used
in Locations type fields in data worksheets. These entries are matched
against existing location names in the SAFE gazetteer. Users can
also include &quot;new&quot; location names in their dataset, which do not
necessarily have coordinates. Processing locations works as
follows:
</p>

<ol>
<li><p> Known locations (<code>new_location = FALSE</code>) are matched
against both the official location names in the gazetteer
and the accepted aliases.
</p>
</li>
<li><p> New locations are first checked against the location aliases
list to see if any new locations in this dataset have been
matched to a gazetteer location. The gazetteer location is
then used in preference to any new location data within the
dataset.
</p>
</li>
<li><p> Finally, remaining new locations are assigned any feature
geometry within the dataset. New locations do not necessarily
have geometry data, so may have null or empty geometries.
</p>
</li></ol>



<h3>Value</h3>

<p>An object of classes &quot;safe_locations&quot;, &quot;sf&quot; and &quot;data.frame&quot;.
</p>


<h3>Note</h3>

<p>Not all SAFE project datasets contain locations. In this case
<code><a href="#topic+get_locations">get_locations</a></code> will return NULL.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+add_locations">add_locations</a></code>, <code><a href="#topic+load_gazetteer">load_gazetteer</a></code>,
<code><a href="#topic+load_location_aliases">load_location_aliases</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>   set_example_safe_dir()
   locations &lt;- get_locations(1400562)
   unset_example_safe_dir()
</code></pre>

<hr>
<h2 id='get_taxa'>Obtaining taxonomy for a SAFE dataset.</h2><span id='topic+get_taxa'></span>

<h3>Description</h3>

<p>This function generates a taxonomy table for a specified SAFE dataset
record. Each row represent a taxon used in the data worksheets in the
dataset and the table fields show the taxonomic hierarchy, taken from
GBIF, for those taxa.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_taxa(obj)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="get_taxa_+3A_obj">obj</code></td>
<td>
<p>A single record id, or an existing safedata dataframe.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>All SAFE datasets containing taxa must include a Taxa worksheet, which
must contain all of the taxa referred to in taxon fields in data
worksheets. All entries in this worksheet are  validated against the
GBIF database before publication and are used to populate the taxonomic
index for the SAFE datasets. The validated taxonomic hierarchy for the
data is also available in the metadata for a record and this function
converts the metadata into a taxonomy table. If the Taxa worksheet for
a SAFE project dataset is empty, because the data does not contain
observations on taxa, <code>get_taxa</code> will return NULL.
</p>
<p>The taxonomy table includes the eight &quot;backbone&quot; taxonomic ranks used
in the GBIF database: Kingdom, Phylum, Class, Order, Family, Genus,
Species and Subspecies. It also includes three further fields:
<code>taxon_name</code>, <code>taxon_rank</code> and <code>gbif_status</code>. These
record the original taxa provided in the Taxa worksheet and show
where the taxonomic name used in a dataset differs from the canonical
name used in GBIF. The row names of the taxon table are the labels
used in data worksheets and are used to match a taxonomy table to a
loaded data worksheet (see <code><a href="#topic+add_taxa">add_taxa</a></code>).
</p>
<p>For more details on the structure of the Taxa worksheet see:
<a href="https://safedata-validator.readthedocs.io/en/latest/data_format/taxa.html">https://safedata-validator.readthedocs.io/en/latest/data_format/taxa.html</a>
</p>


<h3>Value</h3>

<p>A taxonomy table of classes &quot;safe_taxa&quot; and &quot;data.frame&quot;.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+add_taxa">add_taxa</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>   set_example_safe_dir()
   taxa &lt;- get_taxa(1400562)
   unset_example_safe_dir()
</code></pre>

<hr>
<h2 id='get_taxon_coverage'>Retrieve the current taxon index</h2><span id='topic+get_taxon_coverage'></span>

<h3>Description</h3>

<p>This function downloads the current taxon index across published
datasets and returns a formatted taxon table showing the taxonomic
hierarchy of each taxon. It requires an internet connection.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_taxon_coverage()
</code></pre>


<h3>Details</h3>

<p>Note that the use of &quot;user&quot; defined taxa can lead to some unusual
entries. There is nothing to stop a user defining &quot;Gallus gallus&quot; as a
&quot;user&quot; taxon with Animalia as a parent taxon.
</p>


<h3>Value</h3>

<p>A data frame containing higher taxon level information for
each taxon in the database taxon index. If the API is unavailable,
the function returns NULL.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+get_taxa">get_taxa</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>    
    all_taxa &lt;- get_taxon_coverage()
    
</code></pre>

<hr>
<h2 id='get_taxon_graph'>Get a graph of the taxa in a dataset</h2><span id='topic+get_taxon_graph'></span>

<h3>Description</h3>

<p>This function loads the taxon index for a dataset (see
<code><a href="#topic+get_taxa">get_taxa</a></code>) and creates a taxonomic graph for the dataset.
The graph vertex attributes contain further details of each taxon,
including GBIF id and taxonomic status.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_taxon_graph(record)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="get_taxon_graph_+3A_record">record</code></td>
<td>
<p>A single dataset record id</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function may modify the taxon index data to represent it as a
graph, primarily to avoid duplicating taxon names, which are used as
the primary vertex id. Possible issues are:
</p>

<ol>
<li><p> A user maps two worksheet names onto the _same_ taxon name: for
example, &quot;moth&quot; and &quot;butterfly&quot; both using Lepidoptera as a taxon
name. This is resolved by recreating the two worksheet names as
children ofthe shared taxon name.
</p>
</li>
<li><p> The taxon index may contain two GBIF taxonomic concepts with the
same name (e.g. an accepted and doubtful usage). In this case, the
function appends the GBIF ID to make taxon names unique.
</p>
</li>
<li><p> Simple duplication of identical taxa - this should not happen
but has been observed and the function removes all but one entry.
</p>
</li>
<li><p> Missing parent taxa - again this should not happen but sometimes
the GBIF backbone chain stops above the Kingdom level. The function
adds a unique name for unknown parents.
</p>
</li></ol>



<h3>Value</h3>

<p>An <code><a href="igraph.html#topic+make_graph">graph</a></code> object.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>   set_example_safe_dir()
   beetle_graph &lt;- get_taxon_graph(1400562)
   plot(beetle_graph, vertex.label.cex = 0.6, vertex.size = 15,
        vertex.size2 = 3, vertex.shape = "rectangle")
   # show worksheet names for tips
   wsn &lt;- igraph::vertex_attr(beetle_graph, "worksheet_name")
   txn &lt;- igraph::vertex_attr(beetle_graph, "name")
   labels &lt;- ifelse(is.na(wsn), txn, wsn)
   is_leaf &lt;- igraph::vertex_attr(beetle_graph, "leaf")
   vert_col &lt;- ifelse(is_leaf, "cornflowerblue", "grey")
   plot(beetle_graph, vertex.label.cex = 0.6, vertex.size = 15,
        vertex.size2 = 3, vertex.shape = "rectangle",
        vertex.label = labels, vertex.color= vert_col)
   unset_example_safe_dir()
</code></pre>

<hr>
<h2 id='igraph_to_phylo'>Getting a phylogeny for a dataset</h2><span id='topic+igraph_to_phylo'></span><span id='topic+get_phylogeny'></span>

<h3>Description</h3>

<p>The function <code>igraph_to_phylo</code> takes a taxon graph (see
<code><a href="#topic+get_taxon_graph">get_taxon_graph</a></code>) and attempts to convert that to a
a <code><a href="ape.html#topic+read.tree">phylo</a></code> object from <span class="pkg">ape</span>.
This will fail if the graph is not simple (no loops or multiple edges)
or is not connected (has isolated taxa). Neither of these conditions
should happen in datasets but they do.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>igraph_to_phylo(g)

get_phylogeny(record)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="igraph_to_phylo_+3A_g">g</code></td>
<td>
<p>A taxon graph returned by <code><a href="#topic+get_taxon_graph">get_taxon_graph</a></code></p>
</td></tr>
<tr><td><code id="igraph_to_phylo_+3A_record">record</code></td>
<td>
<p>A single dataset record id</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The phylogeny is assigned with equal branch lengths and so displays
showing the taxonomic hierarchy of taxa. Note that the phylogeny will
contain singleton nodes if an internal taxon has a single descendant -
see the example below showing internal node labels. The
<code><a href="ape.html#topic+ape-package">ape</a></code> functions
<code><a href="ape.html#topic+collapse.singles">has.singles</a></code> and
<code><a href="ape.html#topic+collapse.singles">collapse.singles</a></code> can be used to detect and remove
these if required.
</p>
<p>The function <code>get_phylogeny</code> is simply a wrapper that calls
<code><a href="#topic+get_taxon_graph">get_taxon_graph</a></code> and then <code>igraph_to_phylo</code>.
</p>


<h3>Value</h3>

<p>An <code><a href="ape.html#topic+read.tree">phylo</a></code> object.
</p>


<h3>Functions</h3>


<ul>
<li> <p><code>get_phylogeny</code>: Get a phylogeny for a dataset
</p>
</li></ul>


<h3>See Also</h3>

<p><code><a href="#topic+get_taxon_graph">get_taxon_graph</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>   set_example_safe_dir()
   beetle_graph &lt;- get_taxon_graph(1400562)
   beetle_phylo &lt;- igraph_to_phylo(beetle_graph)
   ape::plot.phylo(beetle_phylo, show.node.label = TRUE)
   # Or wrapped into a single function
   beetle_phylo &lt;- get_phylogeny(1400562)
   ape::plot.phylo(beetle_phylo, show.node.label = TRUE)
   unset_example_safe_dir()
</code></pre>

<hr>
<h2 id='insert_dataset'>Inserts local copies of files from a dataset into a SAFE data directory</h2><span id='topic+insert_dataset'></span>

<h3>Description</h3>

<p>If files are embargoed or restricted, then users may request the
datafiles from the authors. This function allows provided files
to be incorporated into a SAFE data directory, so that they will
then work seamlessly alongside openly available data.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>insert_dataset(record_id, files)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="insert_dataset_+3A_record_id">record_id</code></td>
<td>
<p>A SAFE dataset record id</p>
</td></tr>
<tr><td><code id="insert_dataset_+3A_files">files</code></td>
<td>
<p>A vector of files to insert into the data directory</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>   set_example_safe_dir()
   files &lt;- system.file("safedata_example_dir",
                        "template_ClareWfunctiondata.xlsx",
                        package = "safedata")
   insert_dataset(1237719, files)
   dat &lt;- load_safe_data(1237719, "Data")
   str(dat)
   unset_example_safe_dir()
</code></pre>

<hr>
<h2 id='load_gazetteer'>Load and cache the SAFE gazetteer</h2><span id='topic+load_gazetteer'></span>

<h3>Description</h3>

<p>This function loads the SAFE gazetteer, stored as a geojson file in the
root of the SAFE data directory, as an <code><a href="sf.html#topic+sf">sf</a></code> GIS object.
The GIS data uses the WGS84 (EPSG:4326) geographic coordinate system.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>load_gazetteer()
</code></pre>


<h3>Details</h3>

<p>The gazetteer contains the following fields:
</p>

<dl>
<dt>location</dt><dd><p>The official gazetteer name for a sampling site.</p>
</dd>
<dt>type</dt><dd><p>A short description of location type - typically the project
that created the location</p>
</dd>
<dt>plot_size</dt><dd><p>Where applicable, the size of the plot at a location.
Note that point locations may define a sampling area with a plot
size.</p>
</dd>
<dt>display_order</dt><dd><p>DELETE</p>
</dd>
<dt>parent</dt><dd><p>DELETE</p>
</dd>
<dt>region</dt><dd><p>One of the four major large scale sampling areas: SAFE,
Maliau, Danum and VJR</p>
</dd>
<dt>fractal_order</dt><dd><p>Only defined for the SAFE core sampling points,
which follow a fractal layout.</p>
</dd>
<dt>transect_order</dt><dd><p>Again, for SAFE core sampling points, the
location of a point along the sampling design transect.</p>
</dd>
<dt>centroid_x, centroid_y</dt><dd><p>The centroid of the feature</p>
</dd>
<dt>source</dt><dd><p>The original source GIS file that the feature was
described in.</p>
</dd>
<dt>bbox_xmin, bbox_ymin, bbox_xmax, bbox_ymax</dt><dd><p>The bounding box of
the feature.</p>
</dd>
<dt>geometry</dt><dd><p>The GIS geometry for the data - a column of class
<code><a href="sf.html#topic+sfc">sfc</a></code>.</p>
</dd>
</dl>

<p>When this function is first called in a session, the loaded
<code><a href="sf.html#topic+sf">sf</a></code> object is cached for re-use (see
<code><a href="#topic+load_index">load_index</a></code>).
</p>


<h3>Value</h3>

<p>An <code><a href="sf.html#topic+sf">sf</a></code> object containing the SAFE gazetteer
locations.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+load_location_aliases">load_location_aliases</a></code>, <code><a href="#topic+load_index">load_index</a></code>
</p>

<hr>
<h2 id='load_index'>Load and cache the dataset index</h2><span id='topic+load_index'></span>

<h3>Description</h3>

<p>This function loads the dataset record index from the JSON file in
the SAFE data directory and sets which datasets are currently available
and which records are the most recent available under a given concept.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>load_index()
</code></pre>


<h3>Details</h3>

<p>When any of the three index files (<code>index.json</code>,
<code>gazetteer.geojson</code> and <code>location_aliases.csv</code>) are loaded,
the file contents are cached in memory to reduce load times. The cache
is within an environment that is not exported in the package namespace
and is not intended to be user accessible.
</p>


<h3>Value</h3>

<p>Returns NULL invisibly - use get_index() to obtain the
index data.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+load_location_aliases">load_location_aliases</a></code>,
<code><a href="#topic+load_gazetteer">load_gazetteer</a></code>
</p>

<hr>
<h2 id='load_location_aliases'>Load and cache the SAFE location aliases</h2><span id='topic+load_location_aliases'></span>

<h3>Description</h3>

<p>This function loads the SAFE locations alias, stored as a csv file in
the root of the SAFE data directory, as data frame.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>load_location_aliases()
</code></pre>


<h3>Details</h3>

<p>When this function is first called in a session, the loaded data frame
object is cached for re-use (see <code><a href="#topic+load_index">load_index</a></code>).
</p>


<h3>Value</h3>

<p>A data frame containing the SAFE location aliases.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+load_gazetteer">load_gazetteer</a></code>, <code><a href="#topic+load_index">load_index</a></code>
</p>

<hr>
<h2 id='load_safe_data'>Loads data from a SAFE dataset.</h2><span id='topic+load_safe_data'></span><span id='topic+str.safedata'></span><span id='topic+print.safedata'></span>

<h3>Description</h3>

<p>This function returns a data frame containing the data from a data
worksheet in a SAFE dataset. Note that SAFE dataset .xlsx files include
the other (non-data) worksheets Summary, Taxa, Locations that contain
metadata: see  <code><a href="#topic+get_taxa">get_taxa</a></code>, <code><a href="#topic+get_locations">get_locations</a></code>,
<code><a href="#topic+add_taxa">add_taxa</a></code> and <code><a href="#topic+add_locations">add_locations</a></code> for accessing
and using this metadata.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>load_safe_data(record_id, worksheet)

## S3 method for class 'safedata'
str(object, ...)

## S3 method for class 'safedata'
print(x, n = 10, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="load_safe_data_+3A_record_id">record_id</code></td>
<td>
<p>A SAFE dataset record id</p>
</td></tr>
<tr><td><code id="load_safe_data_+3A_worksheet">worksheet</code></td>
<td>
<p>The name of the worksheet to load</p>
</td></tr>
<tr><td><code id="load_safe_data_+3A_...">...</code></td>
<td>
<p>Further arguments to <code>str</code> and <code>print</code> methods.</p>
</td></tr>
<tr><td><code id="load_safe_data_+3A_x">x</code>, <code id="load_safe_data_+3A_object">object</code></td>
<td>
<p>A <code>safedata</code> object.</p>
</td></tr>
<tr><td><code id="load_safe_data_+3A_n">n</code></td>
<td>
<p>The number of rows to show in the <code>print</code> method.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>In particular, the large amount of data worksheet summary metadata is
not attached as attributes to the data frame returned by this function.
This is largely to avoid excessive output to the console during normal
use of the data frame: an extended description of a worksheet can be
displayed using <code><a href="#topic+show_worksheet">show_worksheet</a></code>.
</p>
<p>Currently, this function only loads data from SAFE formatted
<code>.xlsx</code> files - data stored in external files is not yet
handled.
</p>


<h3>Value</h3>

<p>A data frame with the additional <code>safedata</code> class and
additional attribute data containing metadata for the data.
</p>


<h3>Methods (by generic)</h3>


<ul>
<li> <p><code>str</code>: Display structure of a safedata data frame
</p>
</li>
<li> <p><code>print</code>: Print safedata data frame
</p>
</li></ul>


<h3>Examples</h3>

<pre><code class='language-R'>   set_example_safe_dir()
   beetle_abund &lt;- load_safe_data(1400562, "Ant-Psel")
   str(beetle_abund)
   # See also the show_worksheet function for further worksheet metadata
   show_worksheet(beetle_abund)
   unset_example_safe_dir()
</code></pre>

<hr>
<h2 id='safe_api_search'>Internal SAFE dataset API search functions</h2><span id='topic+safe_api_search'></span><span id='topic+validate_query_param'></span>

<h3>Description</h3>

<p>The two internal functions described here handle validating the
parameters passed to the exported search functions and then constructing
API calls from the parameters and the common <code>ids</code> and
<code>most_recent</code> arguments.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>safe_api_search(endpoint, params, ids = NULL, most_recent = FALSE)

validate_query_param(name, val, class = "character", length = 1)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="safe_api_search_+3A_endpoint">endpoint</code></td>
<td>
<p>The name of the search API endpoint to be used.</p>
</td></tr>
<tr><td><code id="safe_api_search_+3A_params">params</code></td>
<td>
<p>A character vector of the query parameters to be passed  to
the API endpoint.</p>
</td></tr>
<tr><td><code id="safe_api_search_+3A_ids">ids</code></td>
<td>
<p>A set of SAFE dataset record IDs to restrict a search. This will
typically be a <code><a href="#topic+safe_record_set">safe_record_set</a></code> object returned by another
search but can also be a vector of record ids in any of the formats
accepted by <code><a href="#topic+validate_record_ids">validate_record_ids</a></code>.</p>
</td></tr>
<tr><td><code id="safe_api_search_+3A_most_recent">most_recent</code></td>
<td>
<p>Logical indicating whether to restrict the API to
returning only the most recent versions of the datasets found. By default
all versions of matching dataset concepts are returned.</p>
</td></tr>
<tr><td><code id="safe_api_search_+3A_name">name</code></td>
<td>
<p>The parameter name</p>
</td></tr>
<tr><td><code id="safe_api_search_+3A_val">val</code></td>
<td>
<p>The user provided input</p>
</td></tr>
<tr><td><code id="safe_api_search_+3A_class">class</code></td>
<td>
<p>Accepted input classes</p>
</td></tr>
<tr><td><code id="safe_api_search_+3A_length">length</code></td>
<td>
<p>Accepted input lengths</p>
</td></tr>
</table>


<h3>Value</h3>

<p>The <code>safe_api_search</code> function returns an object of class
<code><a href="#topic+safe_record_set">safe_record_set</a></code> of datasets that match the submitted
query. The <code>validate_query_param</code> function either returns NULL
on success or raises an error.
</p>


<h3>Functions</h3>


<ul>
<li> <p><code>safe_api_search</code>: Constructs, submits and formats calls to
the SAFE API.
</p>
</li>
<li> <p><code>validate_query_param</code>: A basic query parameter validation handler
</p>
</li></ul>

<hr>
<h2 id='safedata'>Finding and using data from the SAFE Project.</h2><span id='topic+safedata'></span>

<h3>Description</h3>

<p>The SAFE Project is one of the largest ecological experiments in the world.
We are studying how biodiversity and ecosystem function change as forests are
modified by human activities. As well as studying the change, we also
explore whether preserving sections of forest within modified landscapes
and around waterways can protect biodiversity and ecosystem function,
and how much protection is needed to be effective.
</p>
<p>The project is a multinational collaboration that has generated a wide range
of research data. We archive and document this data using the Zenodo file
repository and maintain spatial, taxonomic and other indices to support data
discovery and reuse. This package provides a range of tools to make it easier
to find and analyse our research data outputs.
</p>


<h3>Links</h3>

<p><a href="https://www.safeproject.net/datasets/view_datasets">https://www.safeproject.net/datasets/view_datasets</a>
<a href="https://www.zenodo.org/communities/safe">https://www.zenodo.org/communities/safe</a>
</p>

<hr>
<h2 id='safedata_env'>Index file memory cache</h2><span id='topic+safedata_env'></span><span id='topic+index'></span>

<h3>Description</h3>

<p>The <code>safedata_env</code> environment within the package namespace is
used to cache a copy of the dataset index, gazetteer and location aliases
rather than needing to repeatedly read these from file. This environment
is accessed by internal functions and is not intended for the end user.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>safedata_env
</code></pre>


<h3>Format</h3>

<p>An object of class <code>environment</code> of length 0.</p>

<hr>
<h2 id='safedata_network'>Network resources and the safedata package.</h2><span id='topic+safedata_network'></span>

<h3>Description</h3>

<p>The safedata package requires access to the internet in order to:
</p>
<p>1. maintain an up-to-date index of datasets and the locations gazeteer,
2. download datasets and their metadata,
3. download metadata about the taxonomic coverage of datasets, and
4. search dataset metadata for relevant datasets.
</p>
<p>These actions use two resources. The first is the safedata web server API
which provides everything except the actual datasets. The second is the
Zenodo API, which provides the datasets.
</p>
<p>If you do not have an internet connection - or if either of the two APIs is
unavailable - the safedata package can be used as normal to load and use
datasets that have already been downloaded to the local safedata directory.
However, it will not be possible to update the dataset index, download new
datasets or search for datasets until the APIs are available. The package
should handle internet failures gracefully and provide meaningful messages.
</p>


<h3>Note on SSL certificates</h3>

<p>Downloading data uses the curl package and the underlying libcurl library.
Some older versions of Mac OS X (10.14 and earlier) provide a built-in
libcurl with an outdated set of certificates that prevents curl from
connecting to resources using LetsEncrypt for HTTPS, which includes
https://safeproject.net. To use safedata on these systems, you have to
install a newer version of curl (e.g. using brew) and then compile curl
from source, linking it to that newer libcurl. The simplest way to do this
is to use <code>export PKG_CONFIG_PATH="/usr/local/opt/curl/lib/pkgconfig"</code>
before installing the package: this points the installation to the package
configuration for the brew installed version of curl.
</p>

<hr>
<h2 id='search_safe'>SAFE dataset search functions.</h2><span id='topic+search_safe'></span><span id='topic+search_dates'></span><span id='topic+search_fields'></span><span id='topic+search_authors'></span><span id='topic+search_taxa'></span><span id='topic+search_text'></span><span id='topic+search_spatial'></span>

<h3>Description</h3>

<p>In addition to the datasets stored on Zenodo, the SAFE Project website
provides an API to search dataset metadata in more depth. The search
functions access this API and return <code><a href="#topic+safe_record_set">safe_record_set</a></code> objects
identifying datasets that match a particular query.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>search_dates(dates, match_type = "intersect", most_recent = FALSE, ids = NULL)

search_fields(
  field_text = NULL,
  field_type = NULL,
  ids = NULL,
  most_recent = FALSE
)

search_authors(author, ids = NULL, most_recent = FALSE)

search_taxa(
  taxon_name = NULL,
  taxon_rank = NULL,
  gbif_id = NULL,
  ids = NULL,
  most_recent = FALSE
)

search_text(text, ids = NULL, most_recent = FALSE)

search_spatial(
  wkt = NULL,
  location = NULL,
  distance = NULL,
  ids = NULL,
  most_recent = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="search_safe_+3A_dates">dates</code></td>
<td>
<p>A vector of length 1 or 2, containing either ISO format date
character strings (&quot;yyyy-mm-dd&quot;) or <code>POSIXt</code> dates.</p>
</td></tr>
<tr><td><code id="search_safe_+3A_match_type">match_type</code></td>
<td>
<p>A character string (see Details).</p>
</td></tr>
<tr><td><code id="search_safe_+3A_most_recent">most_recent</code></td>
<td>
<p>Logical indicating whether to restrict the API to
returning only the most recent versions of the datasets found. By default
all versions of matching dataset concepts are returned.</p>
</td></tr>
<tr><td><code id="search_safe_+3A_ids">ids</code></td>
<td>
<p>A set of SAFE dataset record IDs to restrict a search. This will
typically be a <code><a href="#topic+safe_record_set">safe_record_set</a></code> object returned by another
search but can also be a vector of record ids in any of the formats
accepted by <code><a href="#topic+validate_record_ids">validate_record_ids</a></code>.</p>
</td></tr>
<tr><td><code id="search_safe_+3A_field_text">field_text</code></td>
<td>
<p>Text to search for within the data worksheet field name
and description.</p>
</td></tr>
<tr><td><code id="search_safe_+3A_field_type">field_type</code></td>
<td>
<p>A data worksheet field type (see Links).</p>
</td></tr>
<tr><td><code id="search_safe_+3A_author">author</code></td>
<td>
<p>A character string used to search for datasets by author
full (or partial) names.</p>
</td></tr>
<tr><td><code id="search_safe_+3A_taxon_name">taxon_name</code></td>
<td>
<p>The scientific name of a taxon to search for.</p>
</td></tr>
<tr><td><code id="search_safe_+3A_taxon_rank">taxon_rank</code></td>
<td>
<p>A taxonomic rank to search for.</p>
</td></tr>
<tr><td><code id="search_safe_+3A_gbif_id">gbif_id</code></td>
<td>
<p>A GBIF taxonomic ID number.</p>
</td></tr>
<tr><td><code id="search_safe_+3A_text">text</code></td>
<td>
<p>Character string to look for within a SAFE dataset, worksheet,
title, field description, and dataset keywords.</p>
</td></tr>
<tr><td><code id="search_safe_+3A_wkt">wkt</code></td>
<td>
<p>A well-known text geometry string, assumed to use latitude and
longitude in WGS84 (EPSG:4326).</p>
</td></tr>
<tr><td><code id="search_safe_+3A_location">location</code></td>
<td>
<p>The name of a location in the SAFE gazetteer.</p>
</td></tr>
<tr><td><code id="search_safe_+3A_distance">distance</code></td>
<td>
<p>A buffer distance for spatial searches, giving the distance
in metres within which to match either location or wkt searches.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The API provides endpoints to search datasets by date extents, data
worksheet fields, authors, taxa, free text and by spatial query. All
of the functions accept the argument <code>most_recent</code>, which restricts
the returned datasets to the most recent versions of each matching dataset
concept. The functions can also be passed an existing
<code><a href="#topic+safe_record_set">safe_record_set</a></code> object to search within the results
of a previous search.
</p>
<p>The <code>match_type</code> parameter specifies how to match date ranges and must
be one of &quot;intersect&quot; (default), &quot;contain&quot;, or &quot;within&quot;. The &quot;contain&quot; option
returns datasets that span a date range,  &quot;within&quot; returns datasets that
fall within the given range and &quot;intersect&quot; selects datasets that overlap any
part of the date range. Note that match_type is ignored when only a single
date is provided.
</p>


<h3>Value</h3>

<p>An object of class <code><a href="#topic+safe_record_set">safe_record_set</a></code> of datasets that
match the query.
</p>


<h3>Functions</h3>


<ul>
<li> <p><code>search_dates</code>: Search datasets by date extent
</p>
</li>
<li> <p><code>search_fields</code>: Search data worksheet field metadata.
</p>
</li>
<li> <p><code>search_authors</code>: Search by dataset author
</p>
</li>
<li> <p><code>search_taxa</code>: Search by taxon name, rank or GBIF ID.
</p>
</li>
<li> <p><code>search_text</code>: Search dataset, worksheet and field titles
and descriptions
</p>
</li>
<li> <p><code>search_spatial</code>: Search by spatial sampling area/named location.
</p>
</li></ul>


<h3>Spatial searches</h3>

<p>For spatial searches, users can select a location name from a SAFE
data gazetteer (see e.g. <a href="https://www.safeproject.net/info/gazetteer">https://www.safeproject.net/info/gazetteer</a>
or <code><a href="#topic+load_gazetteer">load_gazetteer</a></code>) or provide a WKT geometry. The sampling
locations provided in each SAFE dataset are tested to see if they intersect
the search geometry.
</p>
<p>A buffer <code>distance</code> can aso be provided to extend the search around the
query geometry. Note that although WKT geometries should be provided
using WGS84 lat/long coordinates, since this is typical field GPS data,
distances must be provided as metres and all proximity calculations take
place in the UTM50N projected coordinate system.
</p>
<p>The <code>search_spatial</code> function will not retrieve datasets that have not
provided sampling locations or use newly defined locations that are missing
coordinate information.
</p>


<h3>Links</h3>


<dl>
<dt>SAFE data API</dt><dd><p>e.g. <a href="https://www.safeproject.net/api">https://www.safeproject.net/api</a></p>
</dd>
<dt>Worksheet field types</dt><dd><p><a href="https://safedata-validator.readthedocs.io/en/latest/data_format/data.html#field-types">https://safedata-validator.readthedocs.io/en/latest/data_format/data.html#field-types</a></p>
</dd>
<dt>SAFE gazetteer</dt><dd><p>See <code><a href="#topic+load_gazetteer">load_gazetteer</a></code> and e.g.
<a href="https://www.safeproject.net/info/gazetteer">https://www.safeproject.net/info/gazetteer</a></p>
</dd>
<dt>WKT</dt><dd><p><a href="https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry">https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry</a></p>
</dd>
</dl>



<h3>Examples</h3>

<pre><code class='language-R'>   
   search_dates("2014-06-12")
   search_dates(as.POSIXct(c("2014-06-12", "2015-06-11")))
   search_dates(c("2014-06-12", "2015-06-11"), match_type = "contain")
   search_fields(field_text = "temperature")
   search_fields(field_type = "numeric")
   search_fields(field_text = "temperature", field_type = "numeric")
   search_authors("Ewers")
   search_taxa(taxon_name = "Formicidae")
   search_taxa(gbif_id = 4342)
   search_taxa(taxon_rank = "family")
   search_text("forest")
   search_text("ant")
   search_spatial(wkt = "Point(116.5 4.75)")
   search_spatial(wkt = "Point(116.5 4.75)", distance = 100000)
   search_spatial(wkt = "Polygon((110 0, 110 10,120 10,120 0,110 0))")
   search_spatial(location = "A_1")
   search_spatial(location = "A_1", distance = 2500)

   # combining searches using logical operators
   fish &lt;- search_taxa('Actinopterygii')
   odonates &lt;- search_taxa("Odonata")
   ewers &lt;- search_authors("Ewers")
   aquatic &lt;- fish | odonates
   aquatic_ewers &lt;- aquatic &amp; ewers
   all_in_one &lt;- (fish | odonates) &amp; ewers
   
</code></pre>

<hr>
<h2 id='set_example_safe_dir'>Functions to use an example data directory for package examples</h2><span id='topic+set_example_safe_dir'></span><span id='topic+unset_example_safe_dir'></span>

<h3>Description</h3>

<p>The documentation of <code>safedata</code> includes code examples using a data
directory. A zipped example directory is included in the package files
(data/safedata_example_dir.zip) but package code must not write within
the package structure. The <code>set_example_safe_dir</code> function is used
in code examples to unpack this example directory into a temporary
folder and set it for use in  the example code. The function
<code>unset_example_safe_dir</code> is then used to restore any existing data
directory set by the user. The example directory should only be created
once per session.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>set_example_safe_dir()

unset_example_safe_dir()
</code></pre>


<h3>Value</h3>

<p>The set_example_safe_dir function returns the path of the example
directory invisibly.
</p>


<h3>Functions</h3>


<ul>
<li> <p><code>unset_example_safe_dir</code>: Restores a user data directory after
running an code example.
</p>
</li></ul>


<h3>See Also</h3>

<p><code><a href="#topic+set_safe_dir">set_safe_dir</a></code>
</p>

<hr>
<h2 id='set_safe_dir'>Set the local SAFE data directory</h2><span id='topic+set_safe_dir'></span>

<h3>Description</h3>

<p>This function sets the local directory used to store SAFE dataset
files along with record and index metadata. The function can also
initialise a new data directory, downloading the required index
files. By default, it will update indices if needed and will
validate the directory contents. Once set, the location of the
directory is stored in options(&quot;safedata.dir&quot;). The <code>url</code>
argument specifies a URL to a website that exposes the SAFE data
API.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>set_safe_dir(
  safedir,
  update = TRUE,
  create = FALSE,
  url = "https://www.safeproject.net"
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="set_safe_dir_+3A_safedir">safedir</code></td>
<td>
<p>A path to the directory to set as the SAFE data
directory (str).</p>
</td></tr>
<tr><td><code id="set_safe_dir_+3A_update">update</code></td>
<td>
<p>Should the local dataset index be updated (logical)?</p>
</td></tr>
<tr><td><code id="set_safe_dir_+3A_create">create</code></td>
<td>
<p>Should a new data directory be created at the provided
path (logical)?</p>
</td></tr>
<tr><td><code id="set_safe_dir_+3A_url">url</code></td>
<td>
<p>A URL providing the SAFE Data API, defaulting to the SAFE
Project's own URL.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The safedata package uses a data directory to store local copies of
dataset files along with index files. Files for a dataset record are
stored in subdirectories using the zenodo concept id for the record
and then record id: <code>3342494/3342495</code>, for example. In addition
to data files from these records, these folders can also contain a
JSON file containing record metadata (e.g. <code>3342495.json</code>): this
is a structured version of the summary information shown on the
Zenodo page.
</p>
<p>The root of the data directory also holds three index files:
</p>

<dl>
<dt><code>index.json</code></dt><dd><p>, containing a full list of the
files and dataset records available in the SAFE data
repository;</p>
</dd>
<dt><code>gazetteer.geojson</code></dt><dd><p>, containing the official list of
known sampling locations and GIS data; and</p>
</dd>
<dt><code>location_aliases.csv</code></dt><dd><p>, a list of alternative names
permitted for some locations.</p>
</dd>
</dl>

<p>If <code>create = TRUE</code>, the function will try to create the named
directory and populate it with the three index files. This requires
an internet connection.
</p>
<p>By default, the function also needs an internet connection to check
for updates to the three index files. Updating can be turned off for
offline use.
</p>
<p>The default behaviour is also to validate the directory structure. The
function will warn when files other than those found in datasets are
present within the data structure and when any dataset files that are
present have been modified. Although this can be turned off, it is
not recommended to modify or add files within a SAFE data directory.
</p>


<h3>Value</h3>

<p>Invisibly, a boolean showing whether a SAFE data directory was
set successfully.
</p>

<hr>
<h2 id='show_concepts'>Show SAFE dataset metadata</h2><span id='topic+show_concepts'></span><span id='topic+show_record'></span><span id='topic+show_worksheet'></span>

<h3>Description</h3>

<p>These functions provide access to the metadata associated with SAFE
datasets. The functions provide three levels of information:
</p>

<dl>
<dt><code>show_concepts</code></dt><dd><p>displays the record versions grouped
under dataset concepts,</p>
</dd>
<dt><code>show_record</code></dt><dd><p>displays summary information about a
specific record, and </p>
</dd>
<dt><code>show_worksheet</code></dt><dd><p>displays metadata about data worksheet
fields within a record.</p>
</dd>
</dl>

<p>All three functions accept a first argument <code>obj</code>, which can be one
of three things:
</p>

<ol>
<li><p> A character or numeric vector of SAFE dataset records or
concepts, which will be validated using
<code><a href="#topic+validate_record_ids">validate_record_ids</a></code>, or
</p>
</li>
<li><p> An already validated <code><a href="#topic+safe_record_set">safe_record_set</a></code> object, or
</p>
</li>
<li><p> A <code>safedata</code> data frame loaded using
<code><a href="#topic+load_safe_data">load_safe_data</a></code>.
</p>
</li></ol>

<p>If <code>show_concepts</code> is passed a record id, then the function looks
up the relevant concept. The version table indicates which versions
are available (&quot;*&quot; for the most recent available version and &quot;o&quot;
for older available versions), and which are unavailable due to
embargo or retriction (&quot;x&quot;). A &quot;!&quot; is used to show that a private
local copy of an embargoed or restricted dataset has been inserted
using <code><a href="#topic+insert_dataset">insert_dataset</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>show_concepts(obj)

show_record(obj)

show_worksheet(obj, worksheet = NULL, extended_fields = FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="show_concepts_+3A_obj">obj</code></td>
<td>
<p>A reference to SAFE records or a loaded worksheet (see above)</p>
</td></tr>
<tr><td><code id="show_concepts_+3A_worksheet">worksheet</code></td>
<td>
<p>The name of a worksheet to show. Obviously, if
<code>obj</code> is a loaded worksheet, that will be the worksheet
described and this can be left as NULL.</p>
</td></tr>
<tr><td><code id="show_concepts_+3A_extended_fields">extended_fields</code></td>
<td>
<p>Logical - show a compact description of worksheet
fields or a longer output including full metadata descriptors.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Invisibly, a SAFE metadata object or a list of such objects.
These are not really intended for end user consumption.
</p>


<h3>Functions</h3>


<ul>
<li> <p><code>show_concepts</code>: Show the records associated with a
dataset concept.
</p>
</li>
<li> <p><code>show_record</code>: Show details of a specific dataset
</p>
</li>
<li> <p><code>show_worksheet</code>: Show details of a data worksheet
</p>
</li></ul>


<h3>Examples</h3>

<pre><code class='language-R'>   set_example_safe_dir()
   recs &lt;- validate_record_ids(c(1400562, 3266827, 3266821))
   show_concepts(recs)
   show_record(recs[1,])
   # Show worksheet metadata from a record or from a loaded worksheet
   show_worksheet(1400562, "EnvironVariables")
   beetle_abund &lt;- load_safe_data(1400562, "Ant-Psel")
   show_worksheet(beetle_abund, extended_fields = TRUE)
   unset_example_safe_dir()
</code></pre>

<hr>
<h2 id='taxon_index_to_taxon_table'>Add taxon hierarchy to taxon metadata</h2><span id='topic+taxon_index_to_taxon_table'></span>

<h3>Description</h3>

<p>Taxon data is stored as a set of taxa with taxon ids and parent taxon
ids. For any given dataset, the set should include all parent taxa
required. This internal function takes such list of taxon data and
adds columns showing the taxonomic hierarchy for each row. It is used by
<code><a href="#topic+get_taxa">get_taxa</a></code> and <code><a href="#topic+get_taxon_coverage">get_taxon_coverage</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>taxon_index_to_taxon_table(taxa)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="taxon_index_to_taxon_table_+3A_taxa">taxa</code></td>
<td>
<p>An existing object of class <code>safedata</code></p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame adding higher taxon level information for each taxon
</p>


<h3>See Also</h3>

<p><code><a href="#topic+get_taxa">get_taxa</a></code>
</p>

<hr>
<h2 id='try_to_download'>Attempt to download a URL resource, failing gracefully.</h2><span id='topic+try_to_download'></span>

<h3>Description</h3>

<p>This function tries to fetch a resource from a URL and handles failure to
resolve the resource (bad URLs), timeouts and then actual HTTP error
codes.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>try_to_download(url, local_path = NULL, timeout = 10)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="try_to_download_+3A_url">url</code></td>
<td>
<p>The URL to download.</p>
</td></tr>
<tr><td><code id="try_to_download_+3A_local_path">local_path</code></td>
<td>
<p>A path to a file in which to save the URL content.</p>
</td></tr>
<tr><td><code id="try_to_download_+3A_timeout">timeout</code></td>
<td>
<p>The waiting time in seconds before a request should
timeout.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>If the download fails, the function returns FALSE and the return value
attribute 'fail_msg' is used to provide details. Otherwise, an
<code><a href="httr.html#topic+response">response</a></code> object is returned containing the resource. If a
local path is provided, the resource is downloaded to that path and the
function returns TRUE to indicate success.
</p>


<h3>Value</h3>

<p>An <code>response</code> object or a boolean showing if the
download attempt was successful.
</p>


<h3>Note</h3>

<p>This function contains code to simulate network failures of varying kinds (no
network, no API, specific resource unavailable) for use in unit testing.
</p>

<hr>
<h2 id='validate_record_ids'>Validates dataset record ids from user input</h2><span id='topic+validate_record_ids'></span><span id='topic+safe_record_set'></span><span id='topic+print.safe_record_set'></span><span id='topic++26.safe_record_set'></span><span id='topic++7C.safe_record_set'></span>

<h3>Description</h3>

<p>This takes a vector of user supplied record identifiers and validates
them against the index. Typically the identifiers are provided as
integers, but the function will also handle Zenodo URLs and DOIs.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>validate_record_ids(record_set)

## S3 method for class 'safe_record_set'
print(x, ...)

## S3 method for class 'safe_record_set'
x &amp; y

## S3 method for class 'safe_record_set'
x | y
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="validate_record_ids_+3A_record_set">record_set</code></td>
<td>
<p>A vector of values containing Zenodo concept or
record ids.</p>
</td></tr>
<tr><td><code id="validate_record_ids_+3A_x">x</code>, <code id="validate_record_ids_+3A_y">y</code></td>
<td>
<p>Objects of class <code>safe_record_set</code></p>
</td></tr>
<tr><td><code id="validate_record_ids_+3A_...">...</code></td>
<td>
<p>Further arguments to print methods, unused.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function returns a data frame with class <code>safe_record_set</code>,
containing the columns <code>concept</code>, <code>record</code>, <code>available</code>
and, finally, <code>mra</code> containing the most recent available record
(if any). The function can be run on an existing <code>safe_record_set</code>
to update this information.
</p>
<p>Note that <code>record</code> will be NA when a value represents a concept id.
Inputs that do not match a record or concept ids are returned in the
attribute <code>mismatches</code> of the record set.
</p>
<p>This function is largely used internally to validate user inputs and
to provide a common output for the search functions but is exported
to allow users to check record ids and display summary information
using the print method.
</p>


<h3>Value</h3>

<p>An object of class <code>safe_record_set</code> (see Details)
</p>


<h3>Methods (by generic)</h3>


<ul>
<li> <p><code>print</code>: Print a brief summary of
&quot;safe_record_set&quot; objects.
</p>
</li>
<li> <p><code>&amp;</code>: Combine two record sets, retaining only
records that are present in both.
</p>
</li>
<li> <p><code>|</code>: Combine two record sets, including the
records that are present in either.
</p>
</li></ul>


<h3>Examples</h3>

<pre><code class='language-R'>   set_example_safe_dir()
   validate_record_ids(c(3247631, 3266827, 3266821, -1000))
   validate_record_ids(c("https://doi.org/10.5281/zenodo.3247631",
                         "10.5281/zenodo.3266827",
                         "https://zenodo.org/record/3266821",
                         "not_this_one/3266821"))
   unset_example_safe_dir()
</code></pre>

<hr>
<h2 id='verbose_message'>Message function that can be globally muted</h2><span id='topic+verbose_message'></span>

<h3>Description</h3>

<p>Prints a message if  <code>option("safedata.verbose")</code>  is set
to TRUE. Note that individual expressions can be muted using
<code>suppressMessages()</code> but this mutes them globally.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>verbose_message(str, ...)
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
