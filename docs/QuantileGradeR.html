<!DOCTYPE html><html><head><title>Help for package QuantileGradeR</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {QuantileGradeR}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#createCutoffsDF'><p>Create Cutoffs Dataframe</p></a></li>
<li><a href='#findCutoffs'><p>Find Cutoff Values.</p></a></li>
<li><a href='#gradeAllBus'><p>Grade Businesses.</p></a></li>
<li><a href='#gradeBus'><p>Grade a Business.</p></a></li>
<li><a href='#percentileSeek'><p>Find percentile values (to match a set of global proportions).</p></a></li>
<li><a href='#updateGamma'><p>Update Gamma (percentile value).</p></a></li>
<li><a href='#X.kc'><p>Example Inspection Scores Matrix.</p></a></li>
<li><a href='#zips.kc'><p>Example ZIP Code Vector.</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Title:</td>
<td>Quantile-Adjusted Restaurant Grading</td>
</tr>
<tr>
<td>Version:</td>
<td>0.1.1</td>
</tr>
<tr>
<td>Date:</td>
<td>2017-02-06</td>
</tr>
<tr>
<td>Author:</td>
<td>Zoe Ashwood &lt;zashwood@law.stanford.edu&gt;,
    Becky Elias &lt;Becky.Elias@kingcounty.gov&gt;,
    Daniel E. Ho &lt;dho@law.stanford.edu&gt;</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Zoe Ashwood &lt;zashwood@law.stanford.edu&gt;</td>
</tr>
<tr>
<td>Description:</td>
<td>Implementation of the food safety restaurant grading system adopted by Public Health - Seattle &amp; King County (see Ashwood, Z.C., Elias, B., and Ho. D.E. "Improving the Reliability of Food Safety Disclosure: A Quantile Adjusted Restaurant Grading System for Seattle-King County" (working paper)). As reported in the accompanying paper, this package allows jurisdictions to easily implement refinements that address common challenges with unadjusted grading systems. First, in contrast to unadjusted grading, where the most recent single routine inspection is the primary determinant of a grade, grading inputs are allowed to be flexible. For instance, it is straightforward to base the grade on average inspection scores across multiple inspection cycles. Second, the package can identify quantile cutoffs by inputting substantively meaningful regulatory thresholds (e.g., the proportion of establishments receiving sufficient violation points to warrant a return visit). Third, the quantile adjustment equalizes the proportion of establishments in a flexible number of grading categories (e.g., A/B/C) across areas (e.g., ZIP codes, inspector areas) to account for inspector differences. Fourth, the package implements a refined quantile adjustment that addresses two limitations with the stats::quantile() function when applied to inspection score datasets with large numbers of score ties. The quantile adjustment algorithm iterates over quantiles until, over all restaurants in all areas, grading proportions are within a tolerance of desired global proportions. In addition the package allows a modified definition of "quantile" from "Nearest Rank". Instead of requiring that at least p[1]% of restaurants receive the top grade and at least (p[1]+p[2])% of restaurants receive the top or second best grade for quantiles p, the algorithm searches for cutoffs so that as close as possible p[1]% of restaurants receive the top grade, and as close as possible to p[2]% of restaurants receive the second top grade.</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="http://www.kingcounty.gov/depts/health/environmental-health/food-safety/inspection-system/food-safety-rating.aspx">http://www.kingcounty.gov/depts/health/environmental-health/food-safety/inspection-system/food-safety-rating.aspx</a></td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 3.2.3)</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a> | <a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a> [expanded from: GPL (&ge; 2)]</td>
</tr>
<tr>
<td>LazyData:</td>
<td>TRUE</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>5.0.1</td>
</tr>
<tr>
<td>Imports:</td>
<td>stats</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2017-02-06 18:47:12 UTC; zoeashwood</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2017-02-06 21:22:48</td>
</tr>
</table>
<hr>
<h2 id='createCutoffsDF'>Create Cutoffs Dataframe</h2><span id='topic+createCutoffsDF'></span>

<h3>Description</h3>

<p><code>createCutoffsDF</code> is an internal function, which creates a dataframe with
identical cutoff values for all ZIP codes (if <code>type = "unadj"</code>), or
quantile cutoffs in a ZIP code (if <code>type = "perc"</code> or <code>type =
"perc.resolve.ties"</code>). This function is called extensively by the
<code>findCutoffs</code> function.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>createCutoffsDF(X, z, gamma, type)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="createCutoffsDF_+3A_x">X</code></td>
<td>
<p>Numeric matrix of size <code>n</code> x <code>p</code>, where <code>n</code> is the
number is restaurants to be graded and <code>p</code> is the number of inspections
to be used in grade assignment.  Entry  <code>X[i,j]</code> represents the
inspection score for the <code>i</code>th restaurant in the <code>j</code>th most recent
inspection.</p>
</td></tr>
<tr><td><code id="createCutoffsDF_+3A_z">z</code></td>
<td>
<p>Character vector of length <code>n</code> representing ZIP codes (or other
subunits within a jurisdiction).  <code>z[i]</code> is the ZIP code corresponding
to the restaurant with inspection scores in row <code>i</code> of <code>X</code>.</p>
</td></tr>
<tr><td><code id="createCutoffsDF_+3A_gamma">gamma</code></td>
<td>
<p>Numeric vector representing absolute grade cutoffs or quantiles,
depending on <code>type</code> variable value. Entries in gamma should be
increasing, with <code>gamma[1] &lt;= gamma[2]</code> etc (this is related to the
&quot;Warning&quot; section and larger scores being associated with higher risk). If
<code>type = "perc"</code> or <code>type = "perc.resolve.ties"</code>, gamma values
represent quantiles and should take on values between 0 and 1.</p>
</td></tr>
<tr><td><code id="createCutoffsDF_+3A_type">type</code></td>
<td>
<p>Character string that is one of <code>"unadj"</code>,
<code>"perc"</code>, or <code>"perc.resolve.ties"</code>, and that indicates the grading
algorithm to be implemented.</p>
</td></tr>
</table>


<h3>Details</h3>

<p><code>createCutoffsDF</code> takes in a matrix of restaurants' scores and a vector
corresponding to restaurants' ZIP codes, and outputs a data frame of cutoff
scores to be used in grade classification. The returned ZIP code cutoff data
frame has one row for each unique ZIP code and has <code>(length(gamma)+1)</code>
columns, corresponding to one column for the ZIP code name, and
<code>(length(gamma))</code> cutoff scores separating the <code>(length(gamma)+1)</code>
grading categories.  Across each ZIP code's row, cutoff scores increase and we
assume, as in the King County (WA) case, that greater risk is associated with
larger inspection scores. (If scores are decreasing in risk, users should
transform inspection scores before utilizing functions in the
<code>QuantileGradeR</code> package with a simple function such as <code>f(score) =
- score</code>.)
</p>
<p>The way in which cutoff scores are calculated for each ZIP code depends on the
value of the <code>type</code> variable.  The <code>type</code> variable can take one of
three values (see later).
</p>


<h3>Modes</h3>

<p><code>type = "unadj"</code> creates a ZIP code cutoff data frame
with the same cutoff scores (meaningful values in a jurisdiction's
inspection system that are contained in the vector <code>gamma</code>) for all ZIP
codes. This ZIP code data frame can then be used to carry out &quot;unadjusted&quot;
grading, in which a restaurant's most recent routine inspection score is
compared to these cutoffs.
</p>
<p><code>type = "perc"</code> takes in a vector of quantiles,
<code>gamma</code>, and returns a data frame of the scores in each ZIP code
corresponding to these quantiles (using the &quot;Nearest Rank&quot; definition of
quantile).
</p>
<p><code>type = "perc.resolve.ties"</code> takes in a vector of
quantiles, <code>gamma</code>, and instead of returning (for B/C cutoffs, for
example) the scores in each ZIP code that result in <em>at least</em>
(<code>gamma[2]</code> x 100)% of restaurants in the ZIP code scoring less than
or equal to these cutoffs, <code>type = "perc.resolve.ties"</code> takes into
account the fact that ties exist in ZIP codes. Returned scores for A/B
cutoffs are those that result in the <em>closest</em> percentage of
restaurants in the ZIP code scoring less than or equal to the A/B cutoff to
the desired percentage, (<code>gamma[1]</code> x 100)%. Similarly, B/C cutoffs
are the scores in the ZIP code that result in the <em>closest</em> percentage
of restaurants in the ZIP code scoring less than or equal to the B/C cutoff
and more than the A/B cutoff to the desired percentage, (<code>(gamma[2] -
 gamma[1])</code> x 100)%.
</p>

<hr>
<h2 id='findCutoffs'>Find Cutoff Values.</h2><span id='topic+findCutoffs'></span>

<h3>Description</h3>

<p><code>findCutoffs</code> applies a quantile adjustment to inspection scores within a
jurisdiction's subunits (e.g. ZIP codes) and creates a data frame of cutoff
values to be used for grading restaurants or other inspected entities.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>findCutoffs(X, z, gamma, resolve.ties = TRUE, restaurant.tol = 10,
  max.iterations = 20)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="findCutoffs_+3A_x">X</code></td>
<td>
<p>Numeric matrix of size <code>n</code> x <code>p</code>, where <code>n</code> is the
number is restaurants to be graded and <code>p</code> is the number of inspections
to be used in grade assignment.  Entry  <code>X[i,j]</code> represents the
inspection score for the <code>i</code>th restaurant in the <code>j</code>th most recent
inspection.</p>
</td></tr>
<tr><td><code id="findCutoffs_+3A_z">z</code></td>
<td>
<p>Character vector of length <code>n</code> representing ZIP codes (or other
subunits within a jurisdiction).  <code>z[i]</code> is the ZIP code corresponding
to the restaurant with inspection scores in row <code>i</code> of <code>X</code>.</p>
</td></tr>
<tr><td><code id="findCutoffs_+3A_gamma">gamma</code></td>
<td>
<p>Numeric vector representing absolute grade cutoffs. Entries in
gamma should be increasing, with <code>gamma[1] &lt;= gamma[2]</code> etc (this is
related to the &quot;Warning&quot; section and larger scores being associated with
higher risk).</p>
</td></tr>
<tr><td><code id="findCutoffs_+3A_resolve.ties">resolve.ties</code></td>
<td>
<p>Boolean value that determines the definition of quantile
to be used after optimal quantiles have been found with the
<code>percentileSeek</code> function. See Modes below, as well as Appendix J of
Ho, D.E., Ashwood, Z.C., and Elias, B. &quot;Improving the Reliability of Food
Safety Disclosure: A Quantile Adjusted Restaurant Grading System for
Seattle-King County&quot;.</p>
</td></tr>
<tr><td><code id="findCutoffs_+3A_restaurant.tol">restaurant.tol</code></td>
<td>
<p>An integer indicating the maximum difference in the number of
restaurants in a grading category between the unadjusted and adjusted
grading algorithms (for the top <code>length(gamma)</code> grading categories).</p>
</td></tr>
<tr><td><code id="findCutoffs_+3A_max.iterations">max.iterations</code></td>
<td>
<p>The maximum number of iterations that the iterative
algorithm (carried out by the internal <code>percentileSeek</code> function)
should run in order to find optimal quantiles for ZIP cutoffs. The iterative
algorithm is described in more detail below.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>In our documentation, we use the language &quot;ZIP code&quot; and &quot;restaurant&quot;,
however, our grading algorithm and our code can be applied to grade other
inspected entities; and quantile cutoffs can be sought in subunits of a
jurisdiction that are not ZIP codes. For example, it may make sense to search
for quantile cutoffs in an inspector's allocated inspection area or within a
census tract. We chose to work with ZIP codes in our work because area
assignments for inspectors in King County (WA) tend to be single or multiple
ZIP codes, and we desired to assign grades based on how a restaurant's scores
compare to other restaurants assessed by the same inspector.  We could have
calculated quantile cutoffs in an inspector's allocated area, but inspector
areas are not always contiguous. Because food choices are generally local, ZIP
codes offer a transparent and meaningful basis for consumers to distinguish
establishments. Where &quot;ZIP code&quot; is referenced, please read &quot;ZIP code or other
subunit of a jurisdiction&quot; and &quot;restaurant&quot; should read &quot;restaurant or other
entity to be graded&quot;.
</p>
<p><code>findCutoffs</code> takes in a vector of cutoff scores, <code>gamma</code>, a matrix
of restaurants' scores, <code>X</code>, and a vector corresponding to restaurants'
ZIP codes, <code>z</code>, and outputs a data frame of cutoff scores to be used in
the <code><a href="#topic+gradeAllBus">gradeAllBus</a></code> function to assign grades to restaurants.
<code>findCutoffs</code> first carries out &quot;unadjusted grading&quot; and compares
restaurants' most recent routine inspection scores to the raw cutoff scores
contained in <code>gamma</code> and assigns initial grades to restaurants. Grade
proportions in this scheme are then used as initial quantiles to find quantile
cutoffs in each ZIP code (or quantile cutoffs accommodating for the presence
of score ties in the ZIP code, depending on the value of <code>resolve.ties</code>;
see the Modes section). Restaurants are then graded with the ZIP code quantile
cutoffs, and grading proportions are compared with grading proportions from
the unadjusted system. Quantiles are iterated over one at a time (by the
internal <code>percentileSeek</code> function, which uses a binary search root
finding method) until grading proportions with ZIP code quantile cutoffs are
within a certain tolerance (as determined by <code>restaurant.tol</code>) of the
unadjusted grading proportions. This iterative step is important because of the
discrete nature of the inspection score distribution, and the existence of
large numbers of restaurants with the same inspection scores.
</p>
<p>The returned ZIP code cutoff data frame has one row for each unique ZIP code
and has <code>(length(gamma)+1)</code> columns, corresponding to one column for the
ZIP code name, and <code>(length(gamma))</code> cutoff scores separating the
<code>(length(gamma)+1)</code> grading categories.  Across each ZIP code's row,
cutoff scores increase and we assume, as in the King County (WA) case, that
greater risk is associated with larger inspection scores. (If scores are
decreasing in risk, users should transform inspection scores  with a simple
function such as <code>f(score) = - score</code> before using any of the functions
in <code>QuantileGradeR</code>.)
</p>


<h3>Modes</h3>

<p>When <code>resolve.ties = TRUE</code>, in order to calculate
quantile cutoffs in a ZIP code, we alter the definition of quantile from
the usual &quot;Nearest Rank&quot; definition and use the &quot;Quantile Adjustment (with
Ties Resolution)&quot; definition that is discussed in Appendix J of
Ho, D.E., Ashwood, Z.C., and Elias, B. &quot;Improving the Reliability of Food
Safety Disclosure: A Quantile Adjusted Restaurant Grading System for
Seattle-King County&quot; (working paper). In particular, once we have found the
optimal set of quantiles to be applied across ZIP codes, <code>p</code>,
with the <code>percentileSeek</code> function, instead of returning (for B/C
cutoffs, for example) the scores in each ZIP code that result in <em>at
least</em> (<code>p[2]</code> x 100)% of restaurants in the ZIP code scoring
less than or equal to these cutoffs, the mode <code>resolve.ties = TRUE</code>
takes into account the ties that exist in ZIP codes. Returned scores for
A/B cutoffs are those that result in the <em>closest</em> percentage of
restaurants in the ZIP code scoring less than or equal to the A/B cutoff to
the desired percentage, (<code>p[1]</code> x 100)%. Similarly, B/C cutoffs
are the scores in the ZIP code that result in the <em>closest</em> percentage
of restaurants in the ZIP code scoring less than or equal to the B/C cutoff
and more than the A/B cutoff to the desired percentage, (<code>(p[2] -
  p[1])</code> x 100)%.
</p>
<p>When <code>resolve.ties = FALSE</code>, we use the usual &quot;Nearest
Rank&quot; definition of quantile when applying the optimal quantiles,
<code>p</code>, across ZIP codes.
</p>


<h3>Warning</h3>

<p><code>findCutoffs</code> will produce cutoff scores even for ZIP
codes with only one restaurant: situations in which a quantile adjustment
shouldn't be used. It is the job of the user to ensure that, if using the
<code>findCutoffs</code> function, it makes sense to do so.  This may involve only
performing the quantile adjustment on larger ZIP codes and providing
absolute cutoff points for smaller ZIP codes, or may involve aggregating
smaller ZIP codes into a larger geographical unit and then performing the
quantile adjustment on the larger area (the latter approach is the one we
adopted).
</p>
<p>As mentioned previously, <code>findCutoffs</code> was created for
an inspection system that associates greater risk with larger inspection
scores. If the inspection system of interest associates greater risk with
reduced scores, it will be neccessary to perform a transformation of the
scores matrix before utilizing the <code>findCutoffs</code> function. However a
simple function such as <code>f(score) = - score</code> would perform the
necessary transformation.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
## ==== Quantile-Adjusted Grading =====
## ZIP Code Cutoffs
# In King County, meaningful scores in the inspection system are 0 and 30:
# more than 50% of restaurants score 0 points in a single inspection round,
# and 30 is the highest score that a restaurant can be assigned before it is
# subject to a return inspection, hence these values form our gamma vector.
# The output dataframe, zipcode.cutoffs.df, has ten rows and three columns: one
# row for every unique ZIP code in zips.kc, one column for the ZIP name, the
# second column for the A/B cutoff (Gamma.A) and the third column for the B/C
# cutoff (Gamma.B).

 zipcode.cutoffs.df &lt;- findCutoffs(X.kc, zips.kc, gamma = c(0, 30))

## ==== Traditional Grading Systems ====
## ZIP Code Cutoffs
# Traditional (unadjusted) restaurant grading systems use the same cutoff scores
# for all ZIP codes. To allow comparison, an unadjusted ZIP code cutoff frame
# for King County is generated by the internal createCutoffsDF function:

 unadj.cutoffs.df &lt;- createCutoffsDF(X.kc, zips.kc, gamma = c(0, 30), type = "unadj")
</code></pre>

<hr>
<h2 id='gradeAllBus'>Grade Businesses.</h2><span id='topic+gradeAllBus'></span>

<h3>Description</h3>

<p><code>gradeAllBus</code> takes in a vector of business inspection scores, business
ZIP codes and a data frame of ZIP code cutoff scores (generated by the
<code>findCutoffs</code> function) and returns a vector of business grades.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>gradeAllBus(scores, z, zip.cutoffs)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="gradeAllBus_+3A_scores">scores</code></td>
<td>
<p>Numeric vector of length <code>n</code>, where <code>n</code> is the number is
restaurants to be graded.  Each entry is the inspection score for one
business.</p>
</td></tr>
<tr><td><code id="gradeAllBus_+3A_z">z</code></td>
<td>
<p>Character vector of length <code>n</code>, where each entry is the ZIP
code (or other geographic area) of a business.  The order of businesses in
<code>z</code> is the same as the order of businesses in <code>scores</code>.</p>
</td></tr>
<tr><td><code id="gradeAllBus_+3A_zip.cutoffs">zip.cutoffs</code></td>
<td>
<p>A dataframe with the first column containing all of the
ZIP codes in z and later columns containing cutoff scores for each ZIP code
for grade classification.  Cutoff scores for each ZIP code should be
ordered from lowest score in column 2 (representing the cutoff for the best
grade) to the largest cutoff score in the final column (representing the
cutoff inspection score for the second worst grade). This dataframe will
most likely have been generated by the <code>findCutoffs</code> function.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>As explained in the <code>findCutoffs</code> documentation, we use the language &quot;ZIP
code&quot; and &quot;restaurant&quot;, however, our grading algorithm can be applied to grade
other inspected entities. As with <code>findCutoffs</code>, where &quot;ZIP code&quot; is
referenced, please read &quot;ZIP code or other subunit of a jurisdiction&quot; and
&quot;restaurant&quot; should read &quot;restaurant or other entity to be graded&quot;.
</p>
<p><code>gradeAllBus</code> takes a vector of inspection scores (one score for each
restaurant: the score can be a mean across multiple inspections or the result
of a single inspection), a vector of ZIP codes and a dataframe of ZIP code
cutoffs (most likely generated by the <code>findCutoffs</code> function).  It
compares each restaurant's inspection score to cutoff scores in the
restaurant's ZIP code. It finds the smallest cutoff score in the restaurant's
ZIP code that the restaurant's inspection score is less than or equal to -
let's say this is the (<code>letter.index</code>)th cutoff score - and returns the
(<code>letter.index</code>)th letter of the alphabet as the grade for the
restaurant. The returned vector of grades maintains the order of businesses
in vector inputs <code>scores</code> and in <code>z</code>).
</p>


<h3>Value</h3>

<p>A character vector of length n, with each entry corresponding to the
grade that the restaurant received.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

## ===== Quantile-Adjusted Grading =====
## ZIP Code Cutoffs (see findCutoffs documentation for an explanation of how
## these are calculated)

 zipcode.cutoffs.df &lt;- findCutoffs(X.kc, zips.kc, gamma = c(0, 30))

## In King County, we use a restaurant's mean inspection score over the last
## four inspections for grading (see Ho, D.E.,
## Ashwood, Z.C., and Elias, B. "Improving the Reliability of Food Safety
## Disclosure: A Quantile Adjusted Restaurant Grading System for Seattle-King
## County" (working paper)). Calculate these mean scores:

 mean.scores &lt;- rowMeans(X.kc, na.rm = TRUE)

## We then use the mean scores and the zipcode.cutoffs.df dataframe to perform
## grading:

 adj.grades &lt;- gradeAllBus(mean.scores, zips.kc, zipcode.cutoffs.df)


## ===== Traditional Grading Systems =====
## For comparison, calculate grades as if we had used a traditional grading
## system in King County, with 0 and 30 as the A/B and B/C cutoffs for all ZIP
## codes.

## Cutoffs:

 unadj.cutoffs.df &lt;- createCutoffsDF(X.kc, zips.kc, gamma = c(0, 30), type = "unadj")

## Grades (traditional grading systems only use the most recent inspection score
## for grading):

 unadj.grades &lt;- gradeAllBus(scores = X.kc[,c(1)], zips.kc, zip.cutoffs = unadj.cutoffs.df)


## ===== Comparison: Quantile-Adjusted Grading and Traditional Grading ===
## Proportion of restaurants in each grading category varies dramatically
## between ZIPs in traditional compared to quantile-adjusted grading; these
## differences do not reflect sanitation differences, but rather differences in
## stringency across inpectors (see: Ho, D.E., Ashwood, Z.C., and Elias, B.
## "Improving the Reliability of Food Safety Disclosure: A Quantile Adjusted
## Restaurant Grading System for Seattle-King County" (working paper)).
## Tabulate restaurants in each ZIP code in each grading category and then
## divide by total number of restaurants in each ZIP to obtain proportions.
## Proportions are rounded to 2 decimal places.

## Traditional Grading

 foo1 &lt;- round(table(zips.kc, unadj.grades)/apply(table(unadj.grades, zips.kc), 2, sum), 2)

## Quantile-Adjusted Grading

 foo2 &lt;- round(table(zips.kc, adj.grades)/apply(table(adj.grades, zips.kc), 2, sum), 2)

</code></pre>

<hr>
<h2 id='gradeBus'>Grade a Business.</h2><span id='topic+gradeBus'></span>

<h3>Description</h3>

<p><code>gradeBus</code> takes in the inspection score for one restaurant, the ZIP
code for the restaurant, a data frame of ZIP
code cutoff information and returns the grade for the business in question.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>gradeBus(x.bar.i, z.i, zip.cutoffs)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="gradeBus_+3A_x.bar.i">x.bar.i</code></td>
<td>
<p>Numeric inspection score (or mean score) for restaurant in
question.</p>
</td></tr>
<tr><td><code id="gradeBus_+3A_z.i">z.i</code></td>
<td>
<p>Character representing ZIP code (or other geographic area) of
business in question.</p>
</td></tr>
<tr><td><code id="gradeBus_+3A_zip.cutoffs">zip.cutoffs</code></td>
<td>
<p>A dataframe with the first column containing ZIP codes and
later columns containing grade cutoff scores for each ZIP code. Cutoff
scores for each ZIP code should be ordered from lowest score in column 2
(representing the cutoff for the best grade) to largest cutoff score in the
final column (representing the cutoff inspection score for the second worst
grade).</p>
</td></tr>
</table>


<h3>Details</h3>

<p><code>gradeBus</code> takes one inspection score for a restaurant (this may be a
mean or the result of a single inspection), the restaurant's ZIP code and a
dataframe of ZIP code cutoffs. It compares each restaurant's inspection score
to cutoff scores in the restaurant's ZIP code.  It finds the smallest cutoff
score in the restaurant's ZIP code that the restaurant's inspection score is
less than or equal to - let's say this is the (<code>letter.index</code>)th cutoff
score - and returns the (<code>letter.index</code>)th letter of the alphabet as the
grade for the restaurant.  <code>gradeBus</code> is the function called by
<code><a href="#topic+gradeAllBus">gradeAllBus</a></code> in order to grade all businesses.
</p>


<h3>Value</h3>

<p>A character representing the grade assigned to the restaurant in
question ('A', 'B', 'C' etc).
</p>

<hr>
<h2 id='percentileSeek'>Find percentile values (to match a set of global proportions).</h2><span id='topic+percentileSeek'></span>

<h3>Description</h3>

<p><code>percentileSeek</code> returns a set of percentiles to be applied across
subunits (e.g. ZIP codes) of a larger area (e.g. a jurisdiction), so as to
rank items within each subunit (e.g. restaurants) and group these items into
grade categories. <code>percentileSeek</code> allows the user to set the desired
global proportion of items in each grade category.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>percentileSeek(scores, z, desired.props, restaurant.tol = 10,
  max.iterations = 20, resolve.ties = FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="percentileSeek_+3A_scores">scores</code></td>
<td>
<p>Numeric vector of size <code>n</code>, where <code>n</code> is the number is restaurants
to be graded. <code>scores[i]</code> represents the mean or raw
inspection score for restaurant <code>i</code>.</p>
</td></tr>
<tr><td><code id="percentileSeek_+3A_z">z</code></td>
<td>
<p>Character vector representing ZIP codes. <code>z[i]</code> is the ZIP code for
restaurant <code>i</code>.</p>
</td></tr>
<tr><td><code id="percentileSeek_+3A_desired.props">desired.props</code></td>
<td>
<p>Numeric vector representing desired global grade
proportions across the entire jurisdiction. <code>desired.props[j]</code> is the desired
proportion of total (gradeable) restaurants in the <code>j</code>th highest
grading category.</p>
</td></tr>
<tr><td><code id="percentileSeek_+3A_restaurant.tol">restaurant.tol</code></td>
<td>
<p>Integer value representing the maximum difference in
number of restaurants suggested by <code>desired.props</code> and the actual
number of restaurants in each of the top <code>(length(desired.props) - 1)</code>
grade categories.</p>
</td></tr>
<tr><td><code id="percentileSeek_+3A_max.iterations">max.iterations</code></td>
<td>
<p>Integer value specifying the maximum number of
calls of the <code><a href="#topic+updateGamma">updateGamma</a></code> percentile update function
for each of the sought after percentiles.</p>
</td></tr>
<tr><td><code id="percentileSeek_+3A_resolve.ties">resolve.ties</code></td>
<td>
<p>Boolean value specifying interpretation of how the
function's returned percentiles will be applied across subunits. Should
<em>as close to</em> (desired.props[1])% of restaurants in a ZIP code receive
an &quot;A&quot; grade, and <em>as close to</em> (desired.props[2])% of restaurants in a
ZIP code receive &quot;B&quot; grades (<code>resolve.ties = TRUE</code> case)? Or should the
returned percentiles be interpretted as R <a href="stats.html#topic+quantile">quantile</a> <code>Type = 1</code>
percentiles, and <em>at least</em> (desired.props[1])% of restaurants in a ZIP
code receive &quot;A&quot; grades?</p>
</td></tr>
</table>


<h3>Details</h3>

<p>In our documentation, we use the language &ldquo;ZIP code&rdquo; and &ldquo;restaurant&rdquo;,
however, our algorithms and code can be applied much more broadly to other
inspected or scored entities; and percentile cutoffs can be sought in subunits
(of a larger area) that are not ZIP codes. Where &ldquo;ZIP code&rdquo; is referenced,
please read &ldquo;ZIP code or other subunit of a larger area&rdquo; and &ldquo;restaurant&rdquo;
should read &ldquo;restaurant or other entity to be graded&rdquo;.
</p>
<p><code>percentileSeek</code> was designed for situations in which a significant
number of ties in the scores of items within subunits (e.g. ties in restaurant
inspection scores in ZIP codes) result in the obvious choice of percentiles
(namely those obtained from the desired proportions) not yielding the desired
proportions globally. <code>percentileSeek</code> will iterate over different values
for the first percentile (using the update process described in the
<code><a href="#topic+updateGamma">updateGamma</a></code> documentation) until the proportion of (gradeable)
restaurants scoring &ldquo;A&rdquo; grades (when ZIP cutoffs are percentile values) is
within <code>(restaurant.tol/ no.gradeable.rests)</code> of the desired proportion
of As, where <code>no.gradeable.rests</code> is the number of gradeable restaurants,
and gradeable restaurants are those that have both ZIP code and inspection
score information. The algorithm will then seek to find a larger percentile to
match the proportion of gradeable restaurants scoring &ldquo;B&rdquo; grades with the
desired proportion of Bs and so on, until the proportions of restaurants
gaining the top <code>(lengh(desired.props) - 1)</code> grades are within the required
tolerance of their desired proportions. Note: there is thus no requirement
that the proportion of restaurants gaining the worst grade matches the desired
proportion for worst grade - these can be quite different (depending on the
number of restaurants being graded and the number of grade categories) and no
error will be reported.
</p>
<p>Of course, <code>percentileSeek</code> can only find a solution if one exists.  It
could be the case that it is simply not possible with a particular set of
scores to match the desired proportions. We have included some failsafes to
catch some of the simplest instances in which no solution will exist. For instance, one
possible reason for failure is selecting a desired proportion of &ldquo;A&rdquo; grades that
is below the global minimum proportion of &ldquo;A&rdquo;s.  Totaling the number of
restaurants with the best inspection scores in their ZIP codes and dividing by
the number of gradeable restaurants provides the global minimum proportion of
&ldquo;A&rdquo;s. Running <code>percentileSeek</code> can be a useful way to test whether a
solution is likely to exist. If reported results of the <code>percentileSeek</code>
function are outwith the standard [0, 1] interval for percentiles, or if the
number of iterations exceeds the maximum number of iterations, this could be
indicative that no solution exists.
</p>
<p>An example of when the <code>percentileSeek</code> function could be used outside
of the restaurant context is if you were tasked with finding the top 3 percent
of students in a state.  We know that each school has its own GPA system and
so comparing students by raw GPA does not make sense. We could thus desire to
perform a percentile adjustment at each school and select the top 3 percent of
students at each school. Unfortunately, some schools do not utilize the full
spectrum of GPA scores available and so it may be the case that the top 5
percent of students at school 1 have the same GPA and cannot be
distinguished from one another. Using <code>percentileSeek</code> with each
restaurant replaced by a student, each restaurant's inspection score replaced
by the student's GPA and each ZIP code replaced by a school, we could
investigate whether it is possible to satisfy the 3 percent globally desired
proportion.  <code>percentileSeek</code> would reduce the percentile applied across
schools (from the initial 3 percent), which would still select the 5 percent
of students at school 1 for nomination, but would try to take advantage of
the fact that some schools do use more of their GPA scale. Of course, issues
of fairness do arise and one wonders why school 2, which distinguishes its
students better than school 1, should have fewer students represented in the
globally selected 3 percent. We only advocate the use of <code>percentileSeek</code>
for situations in which there is good reason to demand certain global
proportions. In the school selection case, this may be that there are only
finite resources available to be given to the top 3 percent of students and it is
simply not possible to extend these resources to the top 3 percent of students
at each school. In the restaurant case, we desire to select the top
restaurants in each ZIP code to be assigned an 'A' grade; however we also do
not want to design a grading system that is seen to inflate grades compared to
an unadjusted grading system (one based on absolute uniform grade cutoffs
across the whole jurisdiction).
</p>


<h3>Value</h3>

<p>A numeric vector with the percentiles to be applied to each ZIP code
so as to achieve the desired proportion of grades.
</p>

<hr>
<h2 id='updateGamma'>Update Gamma (percentile value).</h2><span id='topic+updateGamma'></span>

<h3>Description</h3>

<p><code>updateGamma</code> is the percentile update function called by
<code><a href="#topic+percentileSeek">percentileSeek</a></code> as <code><a href="#topic+percentileSeek">percentileSeek</a></code> attempts to
match a set of grade proportions to a set of <code>desired.props</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>updateGamma(scores, z, desired.props, gamma.perc, index.to.update,
  restaurant.tol = 10, iter = 1, max.iterations = 20, gamma_upper = NA,
  gamma_lower = NA, resolve.ties = FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="updateGamma_+3A_scores">scores</code></td>
<td>
<p>Numeric vector of size <code>n</code>, where <code>n</code> is the number is restaurants
to be graded. <code>scores[i]</code> represents the mean or raw
inspection score for restaurant <code>i</code>.</p>
</td></tr>
<tr><td><code id="updateGamma_+3A_z">z</code></td>
<td>
<p>Character vector representing ZIP codes. <code>z[i]</code> is the ZIP code for
restaurant <code>i</code>.</p>
</td></tr>
<tr><td><code id="updateGamma_+3A_desired.props">desired.props</code></td>
<td>
<p>Numeric vector representing desired global grade
proportions across the entire jurisdiction. <code>desired.props[j]</code> is the desired
proportion of total (gradeable) restaurants in the <code>j</code>th highest
grading category.</p>
</td></tr>
<tr><td><code id="updateGamma_+3A_gamma.perc">gamma.perc</code></td>
<td>
<p>Numeric vector representing an initial set of percentiles.</p>
</td></tr>
<tr><td><code id="updateGamma_+3A_index.to.update">index.to.update</code></td>
<td>
<p>Integer value in the set
<code>1:(length(desired.props)-1)</code> that represents the particular
percentile to be updated in the current run of <code>updateGamma</code>.
(Percentiles are not updated simultaneously, but rather are updated
sequentially with the smallest percentiles being the first to be updated.)</p>
</td></tr>
<tr><td><code id="updateGamma_+3A_restaurant.tol">restaurant.tol</code></td>
<td>
<p>Integer value representing the maximum difference in
number of restaurants suggested by <code>desired.props</code> and the actual
number of restaurants in each of the top <code>(length(desired.props) -
1)</code> grade categories.</p>
</td></tr>
<tr><td><code id="updateGamma_+3A_iter">iter</code></td>
<td>
<p>Integer value representing the current iteration of <code>updateGamma</code>.</p>
</td></tr>
<tr><td><code id="updateGamma_+3A_max.iterations">max.iterations</code></td>
<td>
<p>Integer value specifying the maximum number of
calls of the <code><a href="#topic+updateGamma">updateGamma</a></code> percentile update function
for each of the sought after percentiles.</p>
</td></tr>
<tr><td><code id="updateGamma_+3A_gamma_upper">gamma_upper</code></td>
<td>
<p>Numeric or NA value representing a value of
<code>gamma.perc[index.to.update]</code> that results in too many restaurants
gaining the desired grade proportion.</p>
</td></tr>
<tr><td><code id="updateGamma_+3A_gamma_lower">gamma_lower</code></td>
<td>
<p>Numeric or NA value representing a value of
<code>gamma.perc[index.to.update]</code> that results in too few restaurants
gaining the desired grade proportion.</p>
</td></tr>
<tr><td><code id="updateGamma_+3A_resolve.ties">resolve.ties</code></td>
<td>
<p>Boolean value specifying interpretation of how the
function's returned percentile will be applied across the subunits see:
<a href="#topic+percentileSeek">percentileSeek</a>. Should <em>as close to</em> (desired.props[1])% of
restaurants in a ZIP code receive an &quot;A&quot; grade, and <em>as close to</em>
(desired.props[2])% of restaurants in a ZIP code receive &quot;B&quot; grades
(<code>resolve.ties = TRUE</code> case)? Or should the returned percentiles be
interpretted as R <a href="stats.html#topic+quantile">quantile</a> <code>Type = 1</code> percentiles, and
<em>at least</em> (desired.props[1])% of restaurants in a ZIP code receive
an &quot;A&quot; grade?</p>
</td></tr>
</table>


<h3>Details</h3>

<p><code>updateGamma</code> performs the update of
<code>gamma.perc[index.to.update]</code>. In particular, <code>gamma.perc[index.to.update]</code> will
be updated until either the number of updates has reached
<code>max.iterations</code>, or the difference between the proportion of
(gradeable) restaurants scoring the <code>(index.to.update)</code>th highest grade
is within <code>(restaurant.tol/ no.gradeable.rests)</code> of the desired
proportion, where <code>no.gradeable.rests</code> is the number of gradeable
restaurants (restaurants that have both ZIP code and inspection score
information).  Initially, <code>gamma.perc[index.to.update]</code> is updated
according to the rule <code>gamma.perc[index.to.update] &lt;-
(gamma.perc[index.to.update] - diff.aj.desired)</code>, where <code>diff.aj.desired</code>
is the difference between the actual proportion of restaurants assigned the grade
of interest and the desired proportion. However, if the algorithm locates
values of <code>gamma.perc[index.to.update]</code> that produce grade proportions
that are both higher and lower than the desired proportion,
<code>gamma_upper</code> and <code>gamma_lower</code> respectively, the update rule
becomes <code>gamma.perc[index.to.update]&lt;- 0.5*(gamma_upper +
gamma_lower)</code>, as in the bisection root finding method.
</p>


<h3>Value</h3>

<p>A numeric value representing a percentile to be applied to each ZIP code
so as to achieve a particular desired proportion of grades.
</p>

<hr>
<h2 id='X.kc'>Example Inspection Scores Matrix.</h2><span id='topic+X.kc'></span>

<h3>Description</h3>

<p>A small dataset of inspection scores.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>X.kc
</code></pre>


<h3>Format</h3>

<p>A matrix with 4 columns and ~1500 rows, where each row represents
one business and each column is one inspection cycle.
<code>X.kc[i,j]</code> represents the inspection score for the
<code>i</code>th restaurant in the <code>j</code>th most recent inspection.</p>


<h3>Details</h3>

<p><code>X.kc</code> contains restaurant inspection information from 11 randomly
chosen ZIP codes in the King County (WA) jurisdiction. Establishments and ZIP
codes are masked. Inspection information is limited to the 01-01-2012 to
03-25-2016 time period.
</p>

<hr>
<h2 id='zips.kc'>Example ZIP Code Vector.</h2><span id='topic+zips.kc'></span>

<h3>Description</h3>

<p>A vector of ZIP codes.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>zips.kc
</code></pre>


<h3>Format</h3>

<p>A character vector with a length that matches the number of rows of <code>X.kc</code> (i.e. <code>zips.kc</code> has
~1500 elements).  Each entry represents the ZIP code of one business.</p>


<h3>Details</h3>

<p><code>zips.kc[i]</code> represents the ZIP code for the restaurant represented in
the <code>i</code>th row of the <code>X.kc</code> inspection scores matrix. ZIP codes in
<code>zips.kc</code> have the format &quot;zip.j&quot; where j is an integer between 1 and
11, i.e., ZIP codes are masked. In this masking step, we also demonstrate
that our functions can be applied not solely over character vectors of real
ZIP codes, but any vector of character strings representing the same facet
for all restaurants can be used in the grading process.
</p>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
