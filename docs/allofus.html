<!DOCTYPE html><html lang="en"><head><title>Help for package allofus</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {allofus}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#allofus-package'><p>allofus: Interface for 'All of Us' Researcher Workbench</p></a></li>
<li><a href='#+25+26gt+3B+25'><p>Pipe operator</p></a></li>
<li><a href='#aou_atlas_cohort'><p>Retrieve a cohort from ATLAS for use in All of Us</p></a></li>
<li><a href='#aou_bucket_to_workspace'><p>Move files from a bucket to your workspace</p></a></li>
<li><a href='#aou_codebook'><p>All of Us Modified Codebook</p></a></li>
<li><a href='#aou_cohort_example'><p>Example cohort definition and SQL query from ATLAS</p></a></li>
<li><a href='#aou_collect'><p>Collect a tbl object and convert integer64 columns to double</p></a></li>
<li><a href='#aou_compute'><p>Compute a dplyr tbl SQL query into a temp table</p></a></li>
<li><a href='#aou_concept_codes'><p>Concept codes and survey answers</p></a></li>
<li><a href='#aou_concept_set'><p>Get occurrences of a concept set from AoU for a given cohort</p></a></li>
<li><a href='#aou_connect'><p>Create a connection to the database in All of Us</p></a></li>
<li><a href='#aou_create_temp_table'><p>Creates a temporary table from a local data frame or tibble</p></a></li>
<li><a href='#aou_health_history'><p>All of Us Health History Codebook</p></a></li>
<li><a href='#aou_join'><p>Join current query to another table</p></a></li>
<li><a href='#aou_ls_bucket'><p>List the current files in your bucket</p></a></li>
<li><a href='#aou_ls_workspace'><p>List the current files in your workspace</p></a></li>
<li><a href='#aou_observation_period'><p>Generate an observation period table</p></a></li>
<li><a href='#aou_session_info'><p>Print session information for the AoU R environment</p></a></li>
<li><a href='#aou_sql'><p>Execute a SQL query on the All of Us database</p></a></li>
<li><a href='#aou_survey'><p>Function to query allofus observation table for survey responses</p></a></li>
<li><a href='#aou_table_info'><p>Table of tables, columns, and use for researchers from the CT data dictionary</p></a></li>
<li><a href='#aou_tables'><p>List tables in the AoU Database</p></a></li>
<li><a href='#aou_workspace_to_bucket'><p>Save a file from your workspace to your bucket</p></a></li>
<li><a href='#CAST'><p>Date add function to be passed along to SQL</p></a></li>
<li><a href='#DATE_ADD'><p>Date add function to be passed along to SQL</p></a></li>
<li><a href='#DATE_DIFF'><p>Date add function to be passed along to SQL</p></a></li>
<li><a href='#on_workbench'><p>Check to see whether you are on the All of Us workbench</p></a></li>
<li><a href='#STRING_AGG'><p>Date add function to be passed along to SQL</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Interface for 'All of Us' Researcher Workbench</td>
</tr>
<tr>
<td>Version:</td>
<td>1.2.0</td>
</tr>
<tr>
<td>Description:</td>
<td>Streamline use of the 'All of Us' Researcher Workbench (<a href="https://www.researchallofus.org/data-tools/workbench/">https://www.researchallofus.org/data-tools/workbench/</a>)with tools to extract and manipulate data from the 'All of Us' database. Increase interoperability with the Observational Health Data Science and Informatics ('OHDSI') tool stack by decreasing reliance of 'All of Us' tools and allowing for cohort creation via 'Atlas'. Improve reproducible and transparent research using 'All of Us'.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file LICENSE</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>LazyData:</td>
<td>true</td>
</tr>
<tr>
<td>Imports:</td>
<td>cli, tidyr, magrittr, dplyr (&ge; 1.1.4), glue, bigrquery (&ge;
1.5.1), purrr, stats, utils, dbplyr (&ge; 2.5.0), sessioninfo,
rlang, stringr, DBI, lifecycle, bit64</td>
</tr>
<tr>
<td>Suggests:</td>
<td>knitr, rmarkdown, testthat (&ge; 3.0.0), kableExtra, DT,
googlesheets4, tibble, forcats, gh, SqlRender (&ge; 1.6.0)</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.3.2</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://roux-ohdsi.github.io/allofus/">https://roux-ohdsi.github.io/allofus/</a>,
<a href="https://github.com/roux-ohdsi/allofus">https://github.com/roux-ohdsi/allofus</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/roux-ohdsi/allofus/issues">https://github.com/roux-ohdsi/allofus/issues</a></td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 2.10)</td>
</tr>
<tr>
<td>Config/testthat/edition:</td>
<td>3</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2024-11-05 21:22:35 UTC; robcavanaugh</td>
</tr>
<tr>
<td>Author:</td>
<td>Louisa Smith <a href="https://orcid.org/0000-0001-9029-4644"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cph],
  Rob Cavanaugh <a href="https://orcid.org/0000-0002-2114-6565"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre, cph]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Rob Cavanaugh &lt;r.cavanaugh@northeastern.edu&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2024-11-06 08:10:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='allofus-package'>allofus: Interface for 'All of Us' Researcher Workbench</h2><span id='topic+allofus'></span><span id='topic+allofus-package'></span>

<h3>Description</h3>

<p>Streamline use of the 'All of Us' Researcher Workbench (<a href="https://www.researchallofus.org/data-tools/workbench/">https://www.researchallofus.org/data-tools/workbench/</a>)with tools to extract and manipulate data from the 'All of Us' database. Increase interoperability with the Observational Health Data Science and Informatics ('OHDSI') tool stack by decreasing reliance of 'All of Us' tools and allowing for cohort creation via 'Atlas'. Improve reproducible and transparent research using 'All of Us'.
</p>


<h3>Author(s)</h3>

<p><strong>Maintainer</strong>: Rob Cavanaugh <a href="mailto:r.cavanaugh@northeastern.edu">r.cavanaugh@northeastern.edu</a> (<a href="https://orcid.org/0000-0002-2114-6565">ORCID</a>) [copyright holder]
</p>
<p>Authors:
</p>

<ul>
<li><p> Louisa Smith <a href="mailto:l.smith@northeastern.edu">l.smith@northeastern.edu</a> (<a href="https://orcid.org/0000-0001-9029-4644">ORCID</a>) [copyright holder]
</p>
</li></ul>



<h3>See Also</h3>

<p>Useful links:
</p>

<ul>
<li> <p><a href="https://roux-ohdsi.github.io/allofus/">https://roux-ohdsi.github.io/allofus/</a>
</p>
</li>
<li> <p><a href="https://github.com/roux-ohdsi/allofus">https://github.com/roux-ohdsi/allofus</a>
</p>
</li>
<li><p> Report bugs at <a href="https://github.com/roux-ohdsi/allofus/issues">https://github.com/roux-ohdsi/allofus/issues</a>
</p>
</li></ul>


<hr>
<h2 id='+25+26gt+3B+25'>Pipe operator</h2><span id='topic++25+3E+25'></span>

<h3>Description</h3>

<p>See <code>magrittr::<a href="magrittr.html#topic+pipe">%&gt;%</a></code> for details.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>lhs %&gt;% rhs
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="+2B25+2B26gt+2B3B+2B25_+3A_lhs">lhs</code></td>
<td>
<p>A value or the magrittr placeholder.</p>
</td></tr>
<tr><td><code id="+2B25+2B26gt+2B3B+2B25_+3A_rhs">rhs</code></td>
<td>
<p>A function call using the magrittr semantics.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>The result of calling <code>rhs(lhs)</code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>1:10 %&gt;% sum()
</code></pre>

<hr>
<h2 id='aou_atlas_cohort'>Retrieve a cohort from ATLAS for use in All of Us</h2><span id='topic+aou_atlas_cohort'></span>

<h3>Description</h3>

<p>Retrieves a cohort definition from ATLAS and generates the cohort in All of
Us. Observation periods are first generated for each subject using the
<code>aou_observation_period()</code> function.The resulting cohort is a table with the
cohort start and end dates for each person_id.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_atlas_cohort(
  cohort_definition,
  cohort_sql,
  debug = FALSE,
  collect = FALSE,
  ...,
  con = getOption("aou.default.con")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_atlas_cohort_+3A_cohort_definition">cohort_definition</code></td>
<td>
<p>A cohort definition generated using
<code style="white-space: pre;">&#8288;getCohortDefinition() from ROhdsiWebApi&#8288;</code></p>
</td></tr>
<tr><td><code id="aou_atlas_cohort_+3A_cohort_sql">cohort_sql</code></td>
<td>
<p>The cohort_sql generated using <code style="white-space: pre;">&#8288;getCohortSql() from ROhdsiWebApi&#8288;</code></p>
</td></tr>
<tr><td><code id="aou_atlas_cohort_+3A_debug">debug</code></td>
<td>
<p>Print the query to the console; useful for debugging.</p>
</td></tr>
<tr><td><code id="aou_atlas_cohort_+3A_collect">collect</code></td>
<td>
<p>Whether to bring the resulting table into local memory
(<code>collect = TRUE</code>) as a dataframe or leave as a reference to a database
table (for continued analysis using, e.g., <code>dbplyr</code>). Defaults to <code>FALSE.</code></p>
</td></tr>
<tr><td><code id="aou_atlas_cohort_+3A_...">...</code></td>
<td>
<p>Further arguments passed along to <code>collect()</code> if <code>collect = TRUE</code></p>
</td></tr>
<tr><td><code id="aou_atlas_cohort_+3A_con">con</code></td>
<td>
<p>Connection to the allofus SQL database. Defaults to
getOption(&quot;aou.default.con&quot;), which is set automatically if you use
<code>aou_connect()</code></p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function is based on a similar function in
<a href="https://github.com/cmayer2/r4aou">https://github.com/cmayer2/r4aou</a> with some tweaks to generate the
appropriate observation periods and incorporate other package functions.
Please see the <a href="https://roux-ohdsi.github.io/allofus/vignettes/atlas.html">online vignette</a> for
additional details. Note that some cohorts may not be compatible with <code>aou_atlas_cohort()</code> but setting
generateStats = FALSE in <code>getCohortSql()</code> can resolve some issues.
</p>


<h3>Value</h3>

<p>A dataframe if <code>collect = TRUE</code>; a reference to a remote database
table if not. The SQL query used to generate the cohort is stored as an
attribute.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># generate a simple stroke cohort
# see https://atlas-demo.ohdsi.org/#/cohortdefinition/1788061
# If this cohort is not available, you can create one, or choose one already made.
# aou_cohort_example contains the results of
# cd &lt;- ROhdsiWebApi::getCohortDefinition(1788061, "https://atlas-demo.ohdsi.org/WebAPI")
# for some cohorts, you must use the argument generateStats = FALSE or the cohort (its stats)
# can't be generated on All of Us
# cd_sql &lt;- ROhdsiWebApi::getCohortSql(cd,
#                                      "https://atlas-demo.ohdsi.org/WebAPI",
#                                      generateStats = FALSE)

## Not run: 
# connect to the database
con &lt;- aou_connect()

cohort &lt;- aou_atlas_cohort(
  cohort_definition = aou_cohort_example$cd,
  cohort_sql = aou_cohort_example$cd_sql
)

# print query that was executed
cat(attr(cohort, "query"))

## End(Not run)

</code></pre>

<hr>
<h2 id='aou_bucket_to_workspace'>Move files from a bucket to your workspace</h2><span id='topic+aou_bucket_to_workspace'></span>

<h3>Description</h3>

<p>Retrieves a file from the workspace bucket and moves it into the
current persistent disk where it can be read into R, e.g., using a function
like read.csv().
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_bucket_to_workspace(
  file,
  directory = FALSE,
  bucket = getOption("aou.default.bucket")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_bucket_to_workspace_+3A_file">file</code></td>
<td>
<p>The name of a file in your bucket, a vector of multiple files, a
directory, or a file pattern (e.g. &quot;.csv&quot;).</p>
</td></tr>
<tr><td><code id="aou_bucket_to_workspace_+3A_directory">directory</code></td>
<td>
<p>Whether <code>file</code> refers to an entire directory you want to
move.</p>
</td></tr>
<tr><td><code id="aou_bucket_to_workspace_+3A_bucket">bucket</code></td>
<td>
<p>Bucket to retrieve file from. Defaults to
<code>getOption("aou.default.bucket")</code>, which is
<code>Sys.getenv('WORKSPACE_BUCKET')</code> unless specified otherwise.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function retrieves a file from your bucket and moves it into
your workspace where it can be read into R, e.g., using a function like
<code>write.csv()</code>. See
<a href="https://cloud.google.com/storage/docs/gsutil/commands/cp">https://cloud.google.com/storage/docs/gsutil/commands/cp</a> for details on
the underlying function.
</p>


<h3>Value</h3>

<p>Nothing
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# save a file to the bucket
tmp &lt;- tempdir()
write.csv(data.frame(x = 1), file.path(tmp, "testdata.csv"))
aou_workspace_to_bucket(file.path(tmp, "testdata.csv"))
# read the file back into the workspace
aou_bucket_to_workspace("testdata.csv")
# read in to your local environment
read.csv("testdata.csv")
file.remove("testdata.csv")


</code></pre>

<hr>
<h2 id='aou_codebook'>All of Us Modified Codebook</h2><span id='topic+aou_codebook'></span>

<h3>Description</h3>

<p>A data frame with rows from the publicly available All of Us
Survey Codebook mapped to the All of Us PPI Vocabulary available on Athena.
A small number of rows did not match between the codebook and the Athena
PPI Vocabulary.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_codebook
</code></pre>


<h3>Format</h3>

<p><code>aou_codebook</code> A data frame with 702 rows and 11 columns:
</p>

<dl>
<dt>concept_code</dt><dd><p>chr; Concept code from AOU codebook</p>
</dd>
<dt>concept_id</dt><dd><p>int; mapped concept_id from PPI vocabulary</p>
</dd>
<dt>concept_name</dt><dd><p>chr; Formatted text name of concept</p>
</dd>
<dt>concept_class_id</dt><dd><p>chr; type of survey item - question or answer</p>
</dd>
<dt>form_name</dt><dd><p>int; name of survey</p>
</dd>
<dt>field_type</dt><dd><p>chr; type of question (radio, text, checkbox etc.)</p>
</dd>
<dt>field_label</dt><dd><p>chr; The actual text of the question or answer</p>
</dd>
<dt>choices</dt><dd><p>int; choices for question if radio or checkbox</p>
</dd>
<dt>standard_concept</dt><dd><p>chr; Whether concept_id is a standard omop concept</p>
</dd>
<dt>valid_start_Date</dt><dd><p>chr; start date for concept</p>
</dd>
<dt>valid_end_Date</dt><dd><p>int; end date for concept</p>
</dd>
<dt>link</dt><dd><p>chr; link to survey pdf</p>
</dd>
</dl>



<h3>Details</h3>

<p>Questions relating to specific conditions are not included as part
of this table. They are instead available in the <code>aou_health_history</code>
table.
</p>

<ul>
<li><p><a href="https://docs.google.com/spreadsheets/d/1Ey8MScRYZ9QyS4izVYScISLMb62QEhSM-ErbG27dNtw/edit#gid=1832128489">All of Us codebook</a>
</p>
</li>
<li><p><a href="https://github.com/roux-ohdsi/allofus/blob/main/data-raw/pkg_data.R">Code to generate table</a>
</p>
</li></ul>


<hr>
<h2 id='aou_cohort_example'>Example cohort definition and SQL query from ATLAS</h2><span id='topic+aou_cohort_example'></span>

<h3>Description</h3>

<p>A data frame containing tables and columns in the All of Us
Controlled Tier Dataset v7 CDR Data Dictionary (C2022Q4R9) found here:
https://docs.google.com/spreadsheets/d/1XLVq84LLd0VZMioF2sPwyiaPw3EFp5c8o1CTWGPH-Yc/edit#gid=1815943286.
Note that the column 'value_source_value' has been manually added as it is
missing from the data dictionary.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_cohort_example
</code></pre>


<h3>Format</h3>

<p><code>aou_cohort_example</code>
</p>

<dl>
<dt>cd</dt><dd><p>Cohort definition object</p>
</dd>
<dt>cd_sql</dt><dd><p>SQL query for cohort definition</p>
</dd>
</dl>


<hr>
<h2 id='aou_collect'>Collect a tbl object and convert integer64 columns to double</h2><span id='topic+aou_collect'></span>

<h3>Description</h3>

<p>If you connect to the All of Us database via <code>aou_connect()</code>,
integer columns will be converted to the int64 class, which can represent
64-bit integers. This is safer than keeping as R's default integer class,
because some of the values of the ID columns in All of Us are larger than R
can handle as integers. However, this can make working with the local table
more difficult in RStudio as a vector of values will not match the int64
class. This is not a problem in Jupyter notebooks, meaning that code that
works on one platform may not work on another. A safe practice is to use
<code>aou_collect()</code>, which works just like <code>dplyr::collect()</code> except that any
integer values are converted to doubles. If this is not what you want, set
<code>convert_int64 = FALSE</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_collect(data, convert_int64 = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_collect_+3A_data">data</code></td>
<td>
<p>A reference to a remote database table (or unexecuted query)</p>
</td></tr>
<tr><td><code id="aou_collect_+3A_convert_int64">convert_int64</code></td>
<td>
<p>Do you want to convert integer values to doubles?
Defaults to <code>TRUE</code></p>
</td></tr>
<tr><td><code id="aou_collect_+3A_...">...</code></td>
<td>
<p>Other arguments passed to dplyr::collect()</p>
</td></tr>
</table>


<h3>Details</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Value</h3>

<p>a local dataframe
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# connect to database
con &lt;- aou_connect()

# returns 2 rows, as expected
dplyr::tbl(con, "concept") %&gt;%
  dplyr::filter(concept_id %in% c(1112807, 4167538)) %&gt;%
  aou_collect() %&gt;%
  dplyr::filter(concept_id %in% c(1112807, 4167538))

default_collect &lt;- dplyr::tbl(con, "concept") %&gt;%
  dplyr::filter(concept_id %in% c(1112807, 4167538)) %&gt;%
  dplyr::collect()
# returns 2 rows in Jupyter and 0 in RStudio
dplyr::filter(default_collect, concept_id %in% c(1112807, 4167538))

</code></pre>

<hr>
<h2 id='aou_compute'>Compute a dplyr tbl SQL query into a temp table</h2><span id='topic+aou_compute'></span>

<h3>Description</h3>

<p>Computes a temporary table from a dplyr chain that returns an
SQL query (e.g., tbl(con, table)) and returns the name of the temporary
table. May be useful to create intermediate tables to reduce long queries.
The temporary table will only exist for the current session and will nee to
be created again a new session.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_compute(data, ..., con = getOption("aou.default.con"))
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_compute_+3A_data">data</code></td>
<td>
<p>A reference to an unexecuted remote query (e.g., the result of a
<code>tbl(con, ...) %&gt;% ...</code> chain)</p>
</td></tr>
<tr><td><code id="aou_compute_+3A_...">...</code></td>
<td>
<p>Other arugments passed to <code>bigrquery::bq_table_download()</code> when
<code>collect = TRUE</code></p>
</td></tr>
<tr><td><code id="aou_compute_+3A_con">con</code></td>
<td>
<p>Connection to the allofus SQL database. Defaults to
<code>getOption("aou.default.con")</code>, which is created automatically with
<code>aou_connect()</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Value</h3>

<p>A reference to a temporary table in the database.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

con &lt;- aou_connect()
tmp_tbl &lt;- dplyr::tbl(con, "concept") %&gt;%
  dplyr::select(concept_id) %&gt;%
  head(10) %&gt;%
  aou_compute()

tmp_tbl

</code></pre>

<hr>
<h2 id='aou_concept_codes'>Concept codes and survey answers</h2><span id='topic+aou_concept_codes'></span>

<h3>Description</h3>

<p>A data frame containing concept codes (<code>code</code>) and text responses (<code>answer</code>) for
the SDOH and COPE surveys.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_concept_codes
</code></pre>


<h3>Format</h3>

<p>aou_concept_codes
</p>

<dl>
<dt>code</dt><dd><p>response from the observation table</p>
</dd>
<dt>answer</dt><dd><p>Text responses</p>
</dd>
</dl>


<hr>
<h2 id='aou_concept_set'>Get occurrences of a concept set from AoU for a given cohort</h2><span id='topic+aou_concept_set'></span>

<h3>Description</h3>

<p>Retrieves occurrences of a concept set from the All of Us
database for a given cohort.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_concept_set(
  cohort = NULL,
  concepts,
  start_date = NULL,
  end_date = NULL,
  domains = c("condition", "measurement", "observation", "procedure", "drug", "device",
    "visit"),
  output = "indicator",
  concept_set_name = "concept_set",
  min_n = 1,
  collect = FALSE,
  ...,
  con = getOption("aou.default.con")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_concept_set_+3A_cohort">cohort</code></td>
<td>
<p>Reference to a remote table or local dataframe with a column
called &quot;person_id&quot;, and (possibly) columns for <code>start_date</code> and <code>end_date</code>.
If not provided, defaults to entire All of Us cohort.</p>
</td></tr>
<tr><td><code id="aou_concept_set_+3A_concepts">concepts</code></td>
<td>
<p>a vector of concept ids</p>
</td></tr>
<tr><td><code id="aou_concept_set_+3A_start_date">start_date</code></td>
<td>
<p>chr; the name of the start_date column in the cohort table;
defaults to NULL to pull data across all dates</p>
</td></tr>
<tr><td><code id="aou_concept_set_+3A_end_date">end_date</code></td>
<td>
<p>chr; the name of the end_date column in the cohort table;
defaults to NULL to pull data across all dates</p>
</td></tr>
<tr><td><code id="aou_concept_set_+3A_domains">domains</code></td>
<td>
<p>chr; a vector of domains to search for the concepts in
(&quot;condition&quot;, &quot;measurement&quot;, &quot;observation&quot;, &quot;procedure&quot;, &quot;drug&quot;, &quot;device&quot;,
&quot;visit&quot;); defaults to all</p>
</td></tr>
<tr><td><code id="aou_concept_set_+3A_output">output</code></td>
<td>
<p>one of &quot;indicator&quot;, &quot;count&quot;, &quot;all&quot;; do you want to return a 1
if a person has any matching concepts and 0 if not (&quot;indicator&quot;), the
number of matching concepts per person (&quot;count&quot;), or all info about the
matching concepts (&quot;all&quot;). Defaults to &quot;indicator&quot;</p>
</td></tr>
<tr><td><code id="aou_concept_set_+3A_concept_set_name">concept_set_name</code></td>
<td>
<p>chr; If output = &quot;indicator&quot; or output = &quot;n&quot;, name
for that column. Defaults to &quot;concept_set&quot;.</p>
</td></tr>
<tr><td><code id="aou_concept_set_+3A_min_n">min_n</code></td>
<td>
<p>dbl; If output = &quot;indicator&quot;, the minimum number of occurrences
per person to consider the indicator true. Defaults to 1.</p>
</td></tr>
<tr><td><code id="aou_concept_set_+3A_collect">collect</code></td>
<td>
<p>Whether to bring the resulting table into local memory
(<code>collect = TRUE</code>) as a dataframe or leave as a reference to a database
table (for continued analysis using, e.g., <code>dbplyr</code>). Defaults to <code>FALSE.</code></p>
</td></tr>
<tr><td><code id="aou_concept_set_+3A_...">...</code></td>
<td>
<p>further arguments passed along to <code>collect()</code> if <code>collect = TRUE</code></p>
</td></tr>
<tr><td><code id="aou_concept_set_+3A_con">con</code></td>
<td>
<p>Connection to the allofus SQL database. Defaults to
<code>getOption("aou.default.con")</code>, which is created automatically with
<code>aou_connect()</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A dataframe if <code>collect = TRUE</code>; a reference to a remote database
table if not.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# indicator for any aspirin at any time

con &lt;- aou_connect()

aspirin_users &lt;- aou_concept_set(dplyr::tbl(con, "person"),
  concepts = 1191, concept_set_name = "aspirin", domains = "drug"
)

# starting with person table to create a cohort
people &lt;- dplyr::tbl(con, "person") %&gt;%
  dplyr::filter(person_id &lt; 2000000) %&gt;%
  dplyr::mutate(
    start = as.Date("2021-01-01"),
    end = as.Date("2023-12-31")
  )

dat &lt;- aou_concept_set(
  cohort = people,
  concepts = c(725115, 1612146, 1613031),
  start_date = "start",
  end_date = "end",
  concept_set_name = "CGM",
  output = "all"
)

</code></pre>

<hr>
<h2 id='aou_connect'>Create a connection to the database in All of Us</h2><span id='topic+aou_connect'></span>

<h3>Description</h3>

<p>Connects to the All of Us database and returns a
BigQueryConnection object. You can reference this object to query the
database using R and or SQL code. A message is printed with the connection
status (successful or not).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_connect(CDR = getOption("aou.default.cdr"), ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_connect_+3A_cdr">CDR</code></td>
<td>
<p>The name of the &quot;curated data repository&quot; to connect to. Defaults
to <code>getOption("aou.default.cdr")</code>, which is <code>Sys.getenv('WORKSPACE_CDR')</code>
if not specified otherwise (i.e., the &quot;mainline&quot; CDR). On the controlled
tier, specify the &quot;base&quot; CDR with <code>CDR = paste0(Sys.getenv('WORKSPACE_CDR'), "_base")</code>.</p>
</td></tr>
<tr><td><code id="aou_connect_+3A_...">...</code></td>
<td>
<p>Further arguments passed along to <code>DBI::dbConnect()</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>You can reference this object to connect to the All of Us database
and run SQL code using, e.g., <code>dbplyr</code> or <code>DBI</code>. A message is printed with
the connection status (successful or not). For RStudio users, setting quiet = TRUE
will silence most (but not all) billing messages.
</p>


<h3>Value</h3>

<p>A <code>BigQueryConnection</code> object. This object is also saved as an option
(<code>getOption("aou.default.con")</code>).
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
con &lt;- aou_connect()
# reference the observation table in the database
dplyr::tbl(con, "observation")
# print a list of the tables in the database
DBI::dbListTables(con)

</code></pre>

<hr>
<h2 id='aou_create_temp_table'>Creates a temporary table from a local data frame or tibble</h2><span id='topic+aou_create_temp_table'></span>

<h3>Description</h3>

<p>Experimental function that builds a local tibble into an SQL
query and generates a temporary table. Larger tables will be broken up into
consequitive SQL queries; making <code>nchar_batch</code> smaller can avoid errors but
will take longer. The table will only exist for the current connection
session and will need to be created again in a new session.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_create_temp_table(
  data,
  nchar_batch = 1e+06,
  ...,
  con = getOption("aou.default.con")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_create_temp_table_+3A_data">data</code></td>
<td>
<p>A local dataframe (or tibble)</p>
</td></tr>
<tr><td><code id="aou_create_temp_table_+3A_nchar_batch">nchar_batch</code></td>
<td>
<p>approximate number of characters to break up each SQL
query</p>
</td></tr>
<tr><td><code id="aou_create_temp_table_+3A_...">...</code></td>
<td>
<p>Not currently used</p>
</td></tr>
<tr><td><code id="aou_create_temp_table_+3A_con">con</code></td>
<td>
<p>Connection to the allofus SQL database. Defaults to
<code>getOption("aou.default.con")</code>, which is created automatically with
<code>aou_connect()</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Value</h3>

<p>a reference to a temporary table in the database with the data from
<code>df</code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
con &lt;- aou_connect()
df &lt;- data.frame(
  concept_id = c(
    439331, 4290245, 42535816, 46269813,
    2784565, 45765502, 434112, 4128031, 435640, 45876808
  ),
  category = c(
    "AB", "DELIV", "DELIV", "SA", "DELIV",
    "LB", "DELIV", "DELIV", "PREG", "SA"
  ),
  gest_value = c(NA, NA, NA, NA, NA, NA, NA, NA, 25, NA)
)
tmp_tbl &lt;- aou_create_temp_table(df)

</code></pre>

<hr>
<h2 id='aou_health_history'>All of Us Health History Codebook</h2><span id='topic+aou_health_history'></span>

<h3>Description</h3>

<p>This table consists of rows of the codebook pertaining to the health history
questions. In early All of Us surveys, these questions were asked separately
about the respondent and the respondent's family. In the current version, the
questions are asked on the same survey. The nested nature of these questions
makes them challenging to deal with. It can also be accessed in R using
<code>allofus::aou_health_history</code>.
</p>

<ul>
<li><p><a href="https://github.com/roux-ohdsi/allofus/blob/main/data-raw/pkg_data.R">Code to generate table</a>
</p>
</li></ul>



<h3>Usage</h3>

<pre><code class='language-R'>aou_health_history
</code></pre>


<h3>Format</h3>

<p><code>aou_health_history</code> A data frame with 1685  rows and 9 columns:
</p>

<dl>
<dt>question</dt><dd><p>chr; Question asked on survey</p>
</dd>
<dt>relative</dt><dd><p>chr; Person to whom the answer pertains</p>
</dd>
<dt>condition</dt><dd><p>chr; Formatted text name of concept</p>
</dd>
<dt>category</dt><dd><p>chr; Type of health condition</p>
</dd>
<dt>concept_code</dt><dd><p>chr; Concept code from AOU codebook</p>
</dd>
<dt>concept_id_specific</dt><dd><p>int; Concept id for the answer</p>
</dd>
<dt>concept_id_overall</dt><dd><p>int; Concept id for the condition overall</p>
</dd>
<dt>concept_id_question</dt><dd><p>int; Concept id for the overarching question</p>
</dd>
<dt>form_name</dt><dd><p>chr; Survey name</p>
</dd>
</dl>


<hr>
<h2 id='aou_join'>Join current query to another table</h2><span id='topic+aou_join'></span>

<h3>Description</h3>

<p>Joins two tables in the All of Us database. A less verbose
wrapper for the dplyr::*_join() functions with some added safeguards.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_join(
  data,
  table,
  type,
  by = NULL,
  suffix = c("_x", "_y"),
  x_as = NULL,
  y_as = NULL,
  ...,
  con = getOption("aou.default.con")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_join_+3A_data">data</code></td>
<td>
<p>unexecuted SQL query from dbplyr/dplyr.</p>
</td></tr>
<tr><td><code id="aou_join_+3A_table">table</code></td>
<td>
<p>the omop table (or other remote table in your schema) you wish
to join, as a character string, or a tbl object.</p>
</td></tr>
<tr><td><code id="aou_join_+3A_type">type</code></td>
<td>
<p>the type of join; types available in dplyr: &quot;left&quot;, &quot;right&quot;,
&quot;inner&quot;, &quot;anti&quot;, &quot;full&quot;, etc.</p>
</td></tr>
<tr><td><code id="aou_join_+3A_by">by</code></td>
<td>
<p>columns to join on</p>
</td></tr>
<tr><td><code id="aou_join_+3A_suffix">suffix</code></td>
<td>
<p>suffix preferences to add when joining data with the same
column names not specified in the by argument.</p>
</td></tr>
<tr><td><code id="aou_join_+3A_x_as">x_as</code></td>
<td>
<p>optional; a string for the name of the left table</p>
</td></tr>
<tr><td><code id="aou_join_+3A_y_as">y_as</code></td>
<td>
<p>optional; a string for the name of the right table</p>
</td></tr>
<tr><td><code id="aou_join_+3A_...">...</code></td>
<td>
<p>Additional arguments passed on to the join function</p>
</td></tr>
<tr><td><code id="aou_join_+3A_con">con</code></td>
<td>
<p>Connection to the allofus SQL database. Defaults to
<code>getOption("aou.default.con")</code>, which is created automatically with
<code>aou_connect()</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>There are a few good reasons to use aou_join() when possible over
the x_join functions from dplyr. First, it reduces the code necessary to join
an existing table to another table. Second, it includes checks/workarounds
for two sources of common errors using dbplyr: it automatically appends the
x_as and y_as arguments to the join call if they are not provided and it
changes the default suffix from .x/.y to _x/_y for cases with shared column
names not specified by the <code>by</code> argument which will result in a SQL error.
</p>


<h3>Value</h3>

<p>Reference to the remote table created by the join.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

con &lt;- aou_connect()
obs_tbl &lt;- dplyr::tbl(con, "observation") %&gt;%
  dplyr::select(-provider_id)
obs_tbl %&gt;%
  aou_join("person", type = "left", by = "person_id")

</code></pre>

<hr>
<h2 id='aou_ls_bucket'>List the current files in your bucket</h2><span id='topic+aou_ls_bucket'></span>

<h3>Description</h3>

<p>Lists all files in the bucket or files matching a certain
pattern.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_ls_bucket(
  pattern = "",
  silent = FALSE,
  recursive = TRUE,
  bucket = getOption("aou.default.bucket"),
  gsutil_args = ""
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_ls_bucket_+3A_pattern">pattern</code></td>
<td>
<p>Regular expression, such as &quot;*.csv&quot; or a single file name
e.g., &quot;mydata.csv&quot;. Default will find all files apart from notebooks
(.ipynb files).</p>
</td></tr>
<tr><td><code id="aou_ls_bucket_+3A_silent">silent</code></td>
<td>
<p>Whether to omit the names of files found. Defaults to <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="aou_ls_bucket_+3A_recursive">recursive</code></td>
<td>
<p>Whether to search subdirectories. Defaults to <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="aou_ls_bucket_+3A_bucket">bucket</code></td>
<td>
<p>Bucket to retrieve file from. Defaults to
<code>getOption("aou.default.bucket")</code>, which is
<code>Sys.getenv('WORKSPACE_BUCKET')</code> unless specified otherwise.</p>
</td></tr>
<tr><td><code id="aou_ls_bucket_+3A_gsutil_args">gsutil_args</code></td>
<td>
<p>A string containing other arguments passed to <code style="white-space: pre;">&#8288;gsutil ls&#8288;</code>.
See <a href="https://cloud.google.com/storage/docs/gsutil/commands/ls">https://cloud.google.com/storage/docs/gsutil/commands/ls</a> for details.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A vector of file names
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# list all files, including in subdirectories
aou_ls_bucket()
# list all csv files
aou_ls_bucket("*.csv")

</code></pre>

<hr>
<h2 id='aou_ls_workspace'>List the current files in your workspace</h2><span id='topic+aou_ls_workspace'></span>

<h3>Description</h3>

<p>Lists all data files in the workspace or files matching a
certain pattern.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_ls_workspace(pattern = "", silent = FALSE, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_ls_workspace_+3A_pattern">pattern</code></td>
<td>
<p>Regular expression, such as &quot;*.csv&quot; or a single file name
e.g., &quot;mydata.csv&quot;. Default will find all files apart from notebooks
(.ipynb, .Rmd, .qmd files).</p>
</td></tr>
<tr><td><code id="aou_ls_workspace_+3A_silent">silent</code></td>
<td>
<p>Whether to omit the names of files found. Defaults to <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="aou_ls_workspace_+3A_...">...</code></td>
<td>
<p>Other arguments passed to <code>list.files()</code></p>
</td></tr>
</table>


<h3>Value</h3>

<p>A vector of file names
</p>


<h3>Examples</h3>

<pre><code class='language-R'>my_workspace_files &lt;- aou_ls_workspace(silent = TRUE)
aou_ls_workspace("*.csv")
aou_ls_workspace(path = "data")

</code></pre>

<hr>
<h2 id='aou_observation_period'>Generate an observation period table</h2><span id='topic+aou_observation_period'></span>

<h3>Description</h3>

<p>Generates a temporary observation period table based the first
and last event in the electronic medical record data. Because some EHR
sites have contributed data from several decades ago, researchers might
want to consider further constraining this table to reasonable date ranges
of interest (e.g., setting all observation_period_start_date values to no
earlier than 01/01/2010).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_observation_period(
  cohort = NULL,
  collect = FALSE,
  ...,
  con = getOption("aou.default.con")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_observation_period_+3A_cohort">cohort</code></td>
<td>
<p>Reference to a remote table or local dataframe with a column
called &quot;person_id&quot;</p>
</td></tr>
<tr><td><code id="aou_observation_period_+3A_collect">collect</code></td>
<td>
<p>Whether to bring the resulting table into local memory
(<code>collect = TRUE</code>) as a dataframe or leave as a reference to a database
table (for continued analysis using, e.g., <code>dbplyr</code>). Defaults to <code>FALSE.</code></p>
</td></tr>
<tr><td><code id="aou_observation_period_+3A_...">...</code></td>
<td>
<p>Further arguments passed along to <code>collect()</code> if <code>collect = TRUE</code></p>
</td></tr>
<tr><td><code id="aou_observation_period_+3A_con">con</code></td>
<td>
<p>Connection to the allofus SQL database. Defaults to
getOption(&quot;aou.default.con&quot;), which is set automatically if you use
<code>aou_connect()</code></p>
</td></tr>
</table>


<h3>Details</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>
<p>The current observation period table in the All of Us OMOP CDM is not always
appropriate for cohorts generated using OHDSI tools such as ATLAS. Some
observation periods are overly short and some participants have hundreds of
observation periods.
</p>
<p>This function generates an observation period table from the first occurrence
of a clinical event in the EHR tables to the last clinical event in the EHR
tables. It will only return a single observation period per person_id in the
database. If <code>collect = FALSE</code>, the function returns a query to a temporary
table in the database which can be referenced by typical dplyr functions.
</p>
<p>Normal OMOP conventions for EHR suggest that long lapses of time between
clinical events may indicate that the person was not &quot;observed&quot; during this
period. However, due to the diverse nature of clinical EHR data contributed
to All of Us, it seems most conservative to assume that the person was
observed from their first to last clinical event. See
https://ohdsi.github.io/CommonDataModel/ehrObsPeriods.html for more details.
</p>
<p>Some users have clinical events going back to before the time of widespread
electronic medical record use (e.g., the 1980s and 1990s). This function
considers all EHR data in the database, regardless of the date of the
clinical event, but we recommend that users consider the implications of
including data from the 1980s and 1990s. It may be more prudent to exclude
data prior to a more recent cutoff date so that the EHR data is more likely
to be accurate, though this decision depends highly on the research question
(see example below).
</p>
<p>Users should note that the aou_observation_period function will only generate
observation periods for participants who have at least one clinical
observation. If participant in the AllofUs research program who did not
include electronic health record data are included in the cohort argument, or
elected to contribute data but have no data to contribute, they will not be
included in the generated observation period table.
</p>


<h3>Value</h3>

<p>A dataframe if <code>collect = TRUE</code>; a reference to a remote database
table if not. Columns will be &quot;person_id&quot;, &quot;observation_period_start_date&quot;,
and &quot;observation_period_end_date&quot;.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

library(dplyr)
con &lt;- aou_connect()

# create observation_period table for everyone
observation_period_tbl &lt;- aou_observation_period()

# create a cohort of participants with EHR data and at least one year
# of observation before they took the first survey

# first, create an index date as the first date a survey was taken
index_date_tbl &lt;- tbl(con, "ds_survey") %&gt;%
  group_by(person_id) %&gt;%
  summarize(index_date = as.Date(min(survey_datetime, na.rm = TRUE)),
            .groups = "drop")

# join with observation_period_tbl
cohort &lt;- tbl(con, "cb_search_person") %&gt;%
  filter(has_ehr_data == 1) %&gt;%
  inner_join(index_date_tbl, by = "person_id") %&gt;%
  inner_join(observation_period_tbl, by = "person_id") %&gt;%
  filter(
    observation_period_start_date &lt;= DATE_ADD(
      index_date,
      sql(paste0("INTERVAL ", -1, " year"))
    ),
    index_date &lt;= observation_period_end_date
  ) %&gt;%
  select(person_id, gender, sex_at_birth,
    race, ethnicity, age_at_consent,
    index_date, observation_period_start_date, observation_period_end_date)

# head(cohort)

# create an observation period table with a minimum start date (e.g., 2010-01-01)
# to only look at EHR data after that date
observation_period_tbl %&gt;%
  mutate(
    observation_period_start_date =
      if_else(observation_period_start_date &lt; as.Date("2010-01-01"),
        as.Date("2010-01-01"),
        observation_period_start_date
      )
  ) %&gt;%
  filter(observation_period_end_date &gt; as.Date("2010-01-01"))

</code></pre>

<hr>
<h2 id='aou_session_info'>Print session information for the AoU R environment</h2><span id='topic+aou_session_info'></span>

<h3>Description</h3>

<p>Returns a table of information that is necessary to fully
reproduce your analyses. Specifically, it includes R version, the packages
loaded and their versions, and the All of Us CDR release that you are
using.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_session_info(CDR = getOption("aou.default.cdr"))
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_session_info_+3A_cdr">CDR</code></td>
<td>
<p>The name of the CDR to use. Defaults to
<code>getOption("aou.default.cdr")</code></p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list with three elements: the platform, the AoU release, and the
packages
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
allofus::aou_session_info()

</code></pre>

<hr>
<h2 id='aou_sql'>Execute a SQL query on the All of Us database</h2><span id='topic+aou_sql'></span>

<h3>Description</h3>

<p>Executes an SQL query on the All of Us database
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_sql(
  query,
  collect = FALSE,
  debug = FALSE,
  ...,
  con = getOption("aou.default.con"),
  CDR = getOption("aou.default.cdr")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_sql_+3A_query">query</code></td>
<td>
<p>A SQL query (BigQuery dialect) to be executed. Interpreted with
<code>glue::glue()</code>, so expressions enclosed with braces will be evaluated.
References to <code>"{CDR}"</code> or <code>"{cdr}"</code> will be evaluated automatically (see
examples).</p>
</td></tr>
<tr><td><code id="aou_sql_+3A_collect">collect</code></td>
<td>
<p>Whether to bring the resulting table into local memory
(<code>collect = TRUE</code>) as a dataframe or leave as a reference to a database table (for
continued analysis using, e.g., <code>dbplyr</code>). Defaults to <code>FALSE.</code></p>
</td></tr>
<tr><td><code id="aou_sql_+3A_debug">debug</code></td>
<td>
<p>Print the query to the console; useful for debugging.</p>
</td></tr>
<tr><td><code id="aou_sql_+3A_...">...</code></td>
<td>
<p>All other arguments passed to <code>bigrquery::bq_table_download()</code> if
<code>collect = TRUE</code>.</p>
</td></tr>
<tr><td><code id="aou_sql_+3A_con">con</code></td>
<td>
<p>Connection to the allofus SQL database. Defaults to <code>getOption("aou.default.con")</code>,
which is created automatically with <code>aou_connect()</code>. Only needed if <code>collect = FALSE</code>.</p>
</td></tr>
<tr><td><code id="aou_sql_+3A_cdr">CDR</code></td>
<td>
<p>The name of the &quot;curated data repository&quot; that will be used in any
references of the form <code>"{CDR}"</code> or <code>"{cdr}"</code> in the query (see examples).
Defaults to <code>getOption("aou.default.cdr")</code>, which is
<code>Sys.getenv('WORKSPACE_CDR')</code> if not specified otherwise (i.e., the
&quot;mainline&quot; CDR). On the controlled tier, specify the &quot;base&quot; CDR with <code>CDR = paste0(Sys.getenv('WORKSPACE_CDR'), "_base")</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A dataframe if <code>collect = TRUE</code>; a reference to a remote database table if not.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

con &lt;- aou_connect()

# Examples based on AoU snippets
aou_sql("
  -- Compute the count of unique participants in our All of Us cohort.
  SELECT
  COUNT(DISTINCT person_id) AS total_number_of_participants
  FROM
  `{CDR}.person`
", collect = TRUE)

MEASUREMENT_OF_INTEREST &lt;- "hemoglobin"
aou_sql('
-- Compute summary information for our measurements of interest for our cohort.
--
-- PARAMETERS:
--   MEASUREMENT_OF_INTEREST: a case-insensitive string, such as "hemoglobin", to be compared
--                            to all measurement concept names to identify those of interest

WITH
  --
  -- Use a case insensitive string to search the measurement concept names of those
  -- measurements we do have in the measurements table.
  --
  labs_of_interest AS (
  SELECT
    measurement_concept_id,
    measurement_concept.concept_name AS measurement_name,
    unit_concept_id,
    unit_concept.concept_name AS unit_name
  FROM
    `{CDR}.measurement`
  LEFT JOIN `{CDR}.concept` AS measurement_concept
  ON measurement_concept.concept_id = measurement_concept_id
  LEFT JOIN `{CDR}.concept` AS unit_concept
  ON unit_concept.concept_id = unit_concept_id
  WHERE
    REGEXP_CONTAINS(measurement_concept.concept_name, r"(?i){MEASUREMENT_OF_INTEREST}")
  GROUP BY
    measurement_concept_id,
    unit_concept_id,
    measurement_concept.concept_name,
    unit_concept.concept_name
)
  --
  -- Summarize the information about each measurement concept of interest that our
  -- prior query identified.
  --
SELECT
  measurement_name AS measurement,
  IFNULL(unit_name, "NA") AS unit,
  COUNT(1) AS N,
  COUNTIF(value_as_number IS NULL
    AND (value_as_concept_id IS NULL
      OR value_as_concept_id = 0)) AS missing,
  MIN(value_as_number) AS min,
  MAX(value_as_number) AS max,
  AVG(value_as_number) AS avg,
  STDDEV(value_as_number) AS stddev,
  APPROX_QUANTILES(value_as_number, 4) AS quantiles,
  COUNTIF(value_as_number IS NOT NULL) AS num_numeric_values,
  COUNTIF(value_as_concept_id IS NOT NULL
      AND value_as_concept_id != 0) AS num_concept_values,
  COUNTIF(operator_concept_id IS NOT NULL) AS num_operators,
  IF(src_id = "PPI/PM", "PPI", "EHR") AS measurement_source,
  measurement_concept_id,
  unit_concept_id
FROM
  `{CDR}.measurement`
INNER JOIN
 labs_of_interest USING(measurement_concept_id, unit_concept_id)
LEFT JOIN
  `{CDR}.measurement_ext` USING(measurement_id)
GROUP BY
  measurement_concept_id,
  measurement_name,
  measurement_source,
  unit_concept_id,
  unit_name
ORDER BY
  N DESC
', collect = TRUE)

</code></pre>

<hr>
<h2 id='aou_survey'>Function to query allofus observation table for survey responses</h2><span id='topic+aou_survey'></span>

<h3>Description</h3>

<p>Extracts survey responses in a tidy format that also includes
‘skip’ responses and collapses across all versions of the person health /
personal medical history surveys. Currently responses in the ‘ds_survey’
table omit skipped responses. Responses are returned as Yes&quot; if the
respondent answered that the individual had the condition, No&quot; if the
respondent answered that the individual did not have that condition (or
omitted it when selecting from related conditions), a skip response if the
question was skipped, and NA if the respondent did not answer the question.
Returns a data frame or SQL tbl with the initial cohort table along with a
column for each question included in questions and answers foreach
person_id in the cells. To find the desired survey questions, use the all
of us data dictionary, survey codebook, Athena, data browser, or the
modified codebook which can be found in the allofus R package.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_survey(
  cohort = NULL,
  questions,
  question_output = "concept_code",
  clean_answers = TRUE,
  collect = FALSE,
  ...,
  con = getOption("aou.default.con")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_survey_+3A_cohort">cohort</code></td>
<td>
<p>Reference to a remote table or local dataframe with a column
called &quot;person_id&quot;</p>
</td></tr>
<tr><td><code id="aou_survey_+3A_questions">questions</code></td>
<td>
<p>either a vector of concept_ids or concept_codes for
questions to return results</p>
</td></tr>
<tr><td><code id="aou_survey_+3A_question_output">question_output</code></td>
<td>
<p>how to name the columns. Options include as the text
of the concept code (&quot;concept_code&quot;), as concept ids preceded by &quot;x_&quot;
(&quot;concept_id&quot;), or using a custom vector of column names matching the
vector of <code>questions</code>. Defaults to &quot;concept_code&quot;.</p>
</td></tr>
<tr><td><code id="aou_survey_+3A_clean_answers">clean_answers</code></td>
<td>
<p>whether to clean the answers to the survey questions.
Defaults to TRUE.</p>
</td></tr>
<tr><td><code id="aou_survey_+3A_collect">collect</code></td>
<td>
<p>Whether to bring the resulting table into local memory
(<code>collect = TRUE</code>) as a dataframe or leave as a reference to a database
table (for continued analysis using, e.g., <code>dbplyr</code>). Defaults to <code>FALSE.</code></p>
</td></tr>
<tr><td><code id="aou_survey_+3A_...">...</code></td>
<td>
<p>additional arguments passed to <code>collect()</code> when <code>collect = TRUE</code></p>
</td></tr>
<tr><td><code id="aou_survey_+3A_con">con</code></td>
<td>
<p>connection to the allofus SQL database. Defaults to
getOption(&quot;aou.default.con&quot;), which is created automatically with
<code>aou_connect()</code></p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function will return a dataframe or SQL tbl with the initial
cohort table along with a column for each question included in <code>questions</code>
and answers for each person_id in the cells. The column names (questions)
can be returned as the concept_code or concept_id or by providing new
column names. For each question, a column with the suffix &quot;_date&quot; is
included with the date on which the question was answered. When questions
can have multiple answers (&quot;checkbox&quot;-style questions), answers are
returned as a comma-separated string.
</p>
<p>To find the desired survey questions, use the all of us data dictionary,
survey codebook, athena, data browser, or the allofus R package modified
codebook which can be found here:
https://roux-ohdsi.github.io/allofus/vignettes/searchable_codebook.html For
questions regarding an individual's health history or family health
history, the function requires the specific concept_id (or concept_code)
for individual in question, whether that is &quot;self&quot; or another relative.
Responses are returned as &quot;Yes&quot; if the respondent answered that the
individual had the condition, &quot;No&quot; if the respondent answered that the
individual did not have that condition (or omitted it when selecting from
related conditions), a skip response if the question was skipped, and NA if
the respondent did not answer the question.
</p>


<h3>Value</h3>

<p>A dataframe if <code>collect = TRUE</code>; a reference to a remote database
table if not.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

con &lt;- aou_connect()
cohort &lt;- dplyr::tbl(con, "person") %&gt;%
  dplyr::filter(person_id &gt; 5000000) %&gt;%
  dplyr::select(person_id, year_of_birth, gender_concept_id)

aou_survey(
  cohort,
  questions = c(1585375, 1586135),
  question_output = "concept_code"
)
aou_survey(
  cohort,
  questions = c(1585811, 1585386),
  question_output = c("pregnancy", "insurance")
)
aou_survey(
  cohort,
  questions = c(1585375, 1586135, 1740719, 43529932),
  question_output = c("income", "birthplace", "grandpa_bowel_obstruction", "t2dm"),
  collect = FALSE
)

aou_survey(cohort,
  questions = 1384452,
  question_output = "osteoarthritis"
) %&gt;%
  dplyr::count(osteoarthritis)

</code></pre>

<hr>
<h2 id='aou_table_info'>Table of tables, columns, and use for researchers from the CT data dictionary</h2><span id='topic+aou_table_info'></span>

<h3>Description</h3>

<p>A data from with rows of the All of Us codebook pertaining to
the health history questions. In early All of Us surveys, these questions
were asked separately about the respondent and the respondent's family. In
the current version, the questions are asked on the same survey. The nested
nature of these questions can make them challenging to extract and analyze.
</p>

<ul>
<li><p><a href="https://github.com/roux-ohdsi/allofus/blob/main/data-raw/more_data.R">Code to generate table</a>
</p>
</li></ul>



<h3>Usage</h3>

<pre><code class='language-R'>aou_table_info
</code></pre>


<h3>Format</h3>

<p><code>aou_table_info</code>
</p>

<dl>
<dt>table_name</dt><dd><p>chr; name of the table</p>
</dd>
<dt>columns</dt><dd><p>chr; columns in the table</p>
</dd>
<dt>recommended_for_research</dt><dd><p>chr; whether the table is recomended for research</p>
</dd>
</dl>


<hr>
<h2 id='aou_tables'>List tables in the AoU Database</h2><span id='topic+aou_tables'></span>

<h3>Description</h3>

<p>Prints a list of all of the tables in the All of Us Big Query
Database.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_tables(remove_na = TRUE, ..., con = getOption("aou.default.con"))
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_tables_+3A_remove_na">remove_na</code></td>
<td>
<p>Whether to remove tables that are not in the data
dictionary. Defaults to <code>TRUE</code></p>
</td></tr>
<tr><td><code id="aou_tables_+3A_...">...</code></td>
<td>
<p>Not currently used</p>
</td></tr>
<tr><td><code id="aou_tables_+3A_con">con</code></td>
<td>
<p>Connection to the allofus SQL database. Defaults to
<code>getOption("aou.default.con")</code>, which is created automatically with
<code>aou_connect()</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A dataframe with the table names and the number of columns
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
con &lt;- aou_connect()
aou_tables()

</code></pre>

<hr>
<h2 id='aou_workspace_to_bucket'>Save a file from your workspace to your bucket</h2><span id='topic+aou_workspace_to_bucket'></span>

<h3>Description</h3>

<p>Moves a file saved in on the persistent disk to the workspace
bucket, where it can be stored even if a compute environment is deleted.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aou_workspace_to_bucket(
  file,
  directory = FALSE,
  bucket = getOption("aou.default.bucket")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aou_workspace_to_bucket_+3A_file">file</code></td>
<td>
<p>The name of a file in your bucket, a vector of multiple files, a
directory, or a file pattern (e.g. &quot;.csv&quot;). See Details.</p>
</td></tr>
<tr><td><code id="aou_workspace_to_bucket_+3A_directory">directory</code></td>
<td>
<p>Whether <code>file</code> refers to an entire directory you want to
move.</p>
</td></tr>
<tr><td><code id="aou_workspace_to_bucket_+3A_bucket">bucket</code></td>
<td>
<p>Bucket to save files to. Defaults to
<code>getOption("aou.default.bucket")</code>, which is
<code>Sys.getenv('WORKSPACE_BUCKET')</code> unless specified otherwise.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function moves a file saved in a workspace to a bucket, where
it can be retrieved even if the environment is deleted. To use, first save
the desired object as a file to the workspace (e.g., <code>write.csv(object, "filename.csv")</code>) and then run this function (e.g.,
<code>aou_workspace_to_bucket(files = "filename.csv")</code>). See
<a href="https://cloud.google.com/storage/docs/gsutil/commands/cp">https://cloud.google.com/storage/docs/gsutil/commands/cp</a> for details on
the underlying function.
</p>


<h3>Value</h3>

<p>Nothing
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# create test files in a temporary directory
tmp &lt;- tempdir()
write.csv(data.frame(x = 1), file.path(tmp, "testdata1.csv"))
write.csv(data.frame(y = 2), file.path(tmp, "testdata2.csv"))
# save a file to the bucket
aou_workspace_to_bucket(file.path(tmp, "testdata1.csv"))
# save multiple files at once
aou_workspace_to_bucket(c(file.path(tmp, "testdata1.csv"), file.path(tmp, "testdata2.csv")))
# save an entire directory
aou_workspace_to_bucket(tmp, directory = TRUE)

</code></pre>

<hr>
<h2 id='CAST'>Date add function to be passed along to SQL</h2><span id='topic+CAST'></span>

<h3>Description</h3>

<p>Date add function to be passed along to SQL
</p>


<h3>Usage</h3>

<pre><code class='language-R'>CAST(...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="CAST_+3A_...">...</code></td>
<td>
<p>additional arguments passed to dbplyr SQL</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Internal, passed along to dbplyr SQL.
</p>

<hr>
<h2 id='DATE_ADD'>Date add function to be passed along to SQL</h2><span id='topic+DATE_ADD'></span>

<h3>Description</h3>

<p>Date add function to be passed along to SQL
</p>


<h3>Usage</h3>

<pre><code class='language-R'>DATE_ADD(...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="DATE_ADD_+3A_...">...</code></td>
<td>
<p>additional arguments passed to dbplyr SQL</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Internal, passed along to dbplyr SQL.
</p>

<hr>
<h2 id='DATE_DIFF'>Date add function to be passed along to SQL</h2><span id='topic+DATE_DIFF'></span>

<h3>Description</h3>

<p>Date add function to be passed along to SQL
</p>


<h3>Usage</h3>

<pre><code class='language-R'>DATE_DIFF(...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="DATE_DIFF_+3A_...">...</code></td>
<td>
<p>additional arguments passed to dbplyr SQL</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Internal, passed along to dbplyr SQL.
</p>

<hr>
<h2 id='on_workbench'>Check to see whether you are on the All of Us workbench</h2><span id='topic+on_workbench'></span>

<h3>Description</h3>

<p>Use this function to check whether you are on the All of Us
Researcher Workbench. This is useful for writing code that can be used both
on the workbench and locally.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>on_workbench()
</code></pre>


<h3>Value</h3>

<p>TRUE if you are on the workbench, FALSE otherwise
</p>


<h3>Examples</h3>

<pre><code class='language-R'>on_workbench()
</code></pre>

<hr>
<h2 id='STRING_AGG'>Date add function to be passed along to SQL</h2><span id='topic+STRING_AGG'></span>

<h3>Description</h3>

<p>Date add function to be passed along to SQL
</p>


<h3>Usage</h3>

<pre><code class='language-R'>STRING_AGG(...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="STRING_AGG_+3A_...">...</code></td>
<td>
<p>additional arguments passed to dbplyr SQL</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Internal, passed along to dbplyr SQL.
</p>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
