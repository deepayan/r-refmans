<!DOCTYPE html><html><head><title>Help for package transfR</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {transfR}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#as_transfr'><p>Create transfR object</p></a></li>
<li><a href='#Blavet'><p>Blavet French river dataset</p></a></li>
<li><a href='#convolution'><p>Convolution of net rainfall with unit hydrograph</p></a></li>
<li><a href='#hdist'><p>Geographical distance between catchments</p></a></li>
<li><a href='#inversion'><p>Estimate net rainfall by inversion</p></a></li>
<li><a href='#lagtime'><p>Lag time estimation</p></a></li>
<li><a href='#mixr'><p>Transfer of net rainfall to ungauged catchments</p></a></li>
<li><a href='#Oudon'><p>Oudon French river dataset</p></a></li>
<li><a href='#plot'><p>Plot transfR object</p></a></li>
<li><a href='#quick_transfr'><p>Transfer of observed discharge from gauged catchments to ungauged catchments</p></a></li>
<li><a href='#rapriori'><p>Net rainfall a priori estimation</p></a></li>
<li><a href='#transfR-package'><p>Transfer of Hydrograph from Gauged to Ungauged Catchments</p></a></li>
<li><a href='#uh'><p>Unit hydrograph estimation</p></a></li>
<li><a href='#velocity'><p>Streamflow velocity estimation</p></a></li>
<li><a href='#weightr'><p>Weights of donor catchments</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Transfer of Hydrograph from Gauged to Ungauged Catchments</td>
</tr>
<tr>
<td>Version:</td>
<td>1.0.11</td>
</tr>
<tr>
<td>Date:</td>
<td>2023-10-02</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 4.1.0), stars (&ge; 0.4-0), sf (&ge; 0.8-0)</td>
</tr>
<tr>
<td>Imports:</td>
<td>doParallel, foreach, units, Rdpack</td>
</tr>
<tr>
<td>RdMacros:</td>
<td>Rdpack</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>Suggests:</td>
<td>knitr, rmarkdown, elevatr, progress, whitebox</td>
</tr>
<tr>
<td>Description:</td>
<td>A geomorphology-based hydrological modelling for transferring
    streamflow measurements from gauged to ungauged catchments. Inverse
    modelling enables to estimate net rainfall from streamflow measurements 
    following Boudhraâ et al. (2018) &lt;<a href="https://doi.org/10.1080%2F02626667.2018.1425801">doi:10.1080/02626667.2018.1425801</a>&gt;. 
    Resulting net rainfall is then estimated on the ungauged catchments 
    by spatial interpolation in order to finally simulate streamflow 
    following de Lavenne et al. (2016) &lt;<a href="https://doi.org/10.1002%2F2016WR018716">doi:10.1002/2016WR018716</a>&gt;.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a></td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://gitlab.irstea.fr/HYCAR-Hydro/transfr">https://gitlab.irstea.fr/HYCAR-Hydro/transfr</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://gitlab.irstea.fr/HYCAR-Hydro/transfr/-/issues">https://gitlab.irstea.fr/HYCAR-Hydro/transfr/-/issues</a></td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>yes</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>Author:</td>
<td>Alban de Lavenne <a href="https://orcid.org/0000-0002-9448-3490"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre],
  Christophe Cudennec
    <a href="https://orcid.org/0000-0002-1707-8926"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [ths],
  Tom Loree [ctb],
  Hervé Squividant [ctb]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Alban de Lavenne &lt;alban.delavenne@inrae.fr&gt;</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.2.3</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2023-10-02 09:42:51 UTC; delavenne</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2023-10-02 12:20:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='as_transfr'>Create transfR object</h2><span id='topic+as_transfr'></span>

<h3>Description</h3>

<p>Create a transfR object or add new attributes to a transfR object.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>as_transfr(
  object,
  st,
  uc,
  lagtime,
  surface,
  delineation,
  outlet,
  centroid,
  uh,
  hl
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="as_transfr_+3A_object">object</code></td>
<td>
<p>object of class <code>transfR</code></p>
</td></tr>
<tr><td><code id="as_transfr_+3A_st">st</code></td>
<td>
<p>spatio-temporal arrays of class <code>stars</code>. Observed discharge must be described by the column name 'Qobs'.
Time should be the first dimension, space the second dimension. If no unit is provided, Qobs is assumed to be in [m3/s]
and RnInv is assumed to be in [mm/h] (or [mm/d] at daily time step).</p>
</td></tr>
<tr><td><code id="as_transfr_+3A_uc">uc</code></td>
<td>
<p>vector of the streamflow velocities of the catchments. If no unit is provided, <code>uc</code> is assumed to be in [m/s].</p>
</td></tr>
<tr><td><code id="as_transfr_+3A_lagtime">lagtime</code></td>
<td>
<p>vector of the lag times of the catchments. If no unit is provided, <code>lagtime</code> is assumed to be in [h].</p>
</td></tr>
<tr><td><code id="as_transfr_+3A_surface">surface</code></td>
<td>
<p>vector of the surfaces of the catchments. If no unit is provided, <code>surface</code> is assumed to be in [km2].</p>
</td></tr>
<tr><td><code id="as_transfr_+3A_delineation">delineation</code></td>
<td>
<p>spatial layer of the boundary of the catchments of class <code>sfc_POLYGON</code>.</p>
</td></tr>
<tr><td><code id="as_transfr_+3A_outlet">outlet</code></td>
<td>
<p>spatial layer of the outlets of the catchments of class <code>sfc_POINT</code>.</p>
</td></tr>
<tr><td><code id="as_transfr_+3A_centroid">centroid</code></td>
<td>
<p>spatial layer of the centroids of the catchments of class <code>sfc_POINT</code>.</p>
</td></tr>
<tr><td><code id="as_transfr_+3A_uh">uh</code></td>
<td>
<p>list of the unit hydrographs of the catchments.</p>
</td></tr>
<tr><td><code id="as_transfr_+3A_hl">hl</code></td>
<td>
<p>hydraulic length of class <code>stars</code>, <code>matrix</code> or <code>vector</code>. If no unit is provided, <code>hl</code>
is assumed to be in [m]. See details below.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function creates an object of class <code>transfR</code> or increment an existing <code>transfR</code> object
with new attributes. It can be used to gather and organize most of the inputs and outputs of the other functions
like streamflow velocities, unit hydrograph, a priori on net rainfall, inversions and simulations of every catchments.
</p>
<p>This function can be used to organise the two user inputs required for a conventional use of the package, namely <code>st</code>
and <code>hl</code>. The hydraulic lengths are defined as the flow path length from each pixel to the outlet within
the river network (Cudennec et al. 2004; Aouissi et al. 2013). Catchment delineations and hydraulic lengths
need to be prepared beforehand by the user. This package does not provide functions to create them.
However, several GIS software offer possibilities to extract them from a digital elevation model
such as GRASS toolkits (Jasiewicz and Metz 2011),
Whitebox GAT (see Lindsay (2016) or <a href="https://github.com/jblindsay/whitebox-tools">WhiteboxTools</a>),
TauDEM (D. Tarboton, Utah State University)
or online services (see Squividant et al. (2015) for catchment delineation in the Brittany French region).
</p>


<h3>Value</h3>

<p>An object of class transfR.
</p>


<h3>References</h3>

<p>Aouissi J, Pouget J, Boudhraâ H, Storer G, Cudennec C (2013).
&ldquo;Joint spatial, topological and scaling analysis framework of river-network geomorphometry.&rdquo;
<em>Géomorphologie : relief, processus, environnement</em>, <b>19</b>(1), 7&ndash;16.
<a href="https://doi.org/10.4000/geomorphologie.10082">doi:10.4000/geomorphologie.10082</a>.
</p>
<p>Cudennec C, Fouad Y, Gatot IS, Duchesne J (2004).
&ldquo;A geomorphological explanation of the unit hydrograph concept.&rdquo;
<em>Hydrological Processes</em>, <b>18</b>(4), 603&ndash;621.
<a href="https://doi.org/10.1002/hyp.1368">doi:10.1002/hyp.1368</a>.
</p>
<p>Jasiewicz J, Metz M (2011).
&ldquo;A new GRASS GIS toolkit for Hortonian analysis of drainage networks.&rdquo;
<em>Computers &amp; Geosciences</em>, <b>37</b>(8), 1162&ndash;1173.
<a href="https://doi.org/10.1016/j.cageo.2011.03.003">doi:10.1016/j.cageo.2011.03.003</a>.
</p>
<p>Lindsay JB (2016).
&ldquo;Whitebox GAT: A case study in geomorphometric analysis.&rdquo;
<em>Computers &amp; Geosciences</em>, <b>95</b>, 75&ndash;84.
<a href="https://doi.org/10.1016/j.cageo.2016.07.003">doi:10.1016/j.cageo.2016.07.003</a>.
</p>
<p>Squividant H, Bera R, Aurousseau P, Cudennec C (2015).
&ldquo;Online watershed boundary delineation: sharing models through Spatial Data Infrastructures.&rdquo;
<em>Proceedings of the International Association of Hydrological Sciences</em>, <b>368</b>, 144&ndash;149.
<a href="https://doi.org/10.5194/piahs-368-144-2015">doi:10.5194/piahs-368-144-2015</a>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(Oudon)
object &lt;- as_transfr(st = Oudon$obs, hl = Oudon$hl)
</code></pre>

<hr>
<h2 id='Blavet'>Blavet French river dataset</h2><span id='topic+Blavet'></span>

<h3>Description</h3>

<p>'Blavet' is a dataset of the Blavet French river in Brittany peninsula and two neighouring rivers (Claie and Coët-Organ). It contains all the necessary inputs to test the package and perform discharge prediction at the outlet of six catchments:
</p>

<ul>
<li> <p>J5613010  Evel at Guénin (316 km²)
</p>
</li>
<li> <p>J5618310  Fremeur et Guénin (15.1 km²)
</p>
</li>
<li> <p>J5618320  Fremeur et Pluméliau (5.88 km²)
</p>
</li>
<li> <p>J5704810  Coët-Organ at Quistinic (47.7 km²)
</p>
</li>
<li> <p>J8433020  Claie at Saint-Jean-Brévelay (135 km²)
</p>
</li>
<li> <p>AgrHys  Coët-Dan at Naizin (4.9 km²)
</p>
</li></ul>

<p>Hourly discharge observations of the six catchments are provided for one hydrological year, from 2013-10-01 to 2014-10-01. It has been extracted from the French HYDRO database (http://www.hydro.eaufrance.fr). Discharge observations for the Coët-Dan river is provided by the AgrHys Environment Research Observatories (Fovet et al. 2018) managed by INRAE (https://www6.inrae.fr/ore_agrhys_eng). Catchment delineations and respective maps of hydraulic length have been extracted from a digital elevation model of 100 m resolution.
</p>


<h3>Format</h3>

<p>'Blavet' is a list of three objects:
</p>

<ul>
<li> <p>hl  A list of stars objects containing the six rasters maps of hydraulic length.
</p>
</li>
<li> <p>obs  A stars object with two dimensions (time and space, with catchment delineations as spatial support) and one attribute (discharge observations).
</p>
</li>
<li> <p>network A sf object of the [French TOPAGE river network](https://bdtopage.eaufrance.fr/). It can be downloaded using the Web Feature Service (WFS) &quot;Sandre - Eau France&quot;, as shown in the example below.
</p>
</li></ul>


<h3>Source</h3>

<p>http://www.hydro.eaufrance.fr
</p>
<p>https://www6.inrae.fr/ore_agrhys_eng
</p>
<p>http://bdtopage.eaufrance.fr
</p>


<h3>References</h3>

<p>Fovet O, Ruiz L, Gruau G, Akkal N, Aquilina L, Busnot S, Dupas R, Durand P, Faucheux M, Fauvel Y, Fléchard C, Gilliet N, Grimaldi C, Hamon Y, Jaffrezic A, Jeanneau L, Labasque T, Henaff GL, Mérot P, Molénat J, Petitjean P, Pierson-Wickmann A, Squividant H, Viaud V, Walter C, Gascuel-Odoux C (2018).
&ldquo;AgrHyS: An Observatory of Response Times in Agro-Hydro Systems.&rdquo;
<em>Vadose Zone Journal</em>, <b>17</b>(1), 180066.
<a href="https://doi.org/10.2136/vzj2018.04.0066">doi:10.2136/vzj2018.04.0066</a>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
# Working directory
wd &lt;- tempdir(check = TRUE)
# Define a bbox that will encompass the catchments of the study area
blavet_bbox &lt;- st_bbox(c(xmin = -3.3, xmax = -2.7, ymax = 48.11, ymin = 47.77),
                           crs = st_crs(4326))
# Download a French Topage river network within the bbox using the "Sandre - Eau France" WFS
download.file(url = paste0("https://services.sandre.eaufrance.fr/geo/topage2019",
                     "?request=GetFeature&amp;service=WFS&amp;version=2.0.0",
                     "&amp;typeName=CoursEau_FXX_Topage2019",
                     "&amp;outputFormat=application/json;
                     paste0(blavet_bbox[c("ymin","xmin","ymax","xmax")],
                            collapse=",")),
              destfile = file.path(wd,"CoursEau_FXX_Topage2019.geojson"))
CoursEau_Topage2019 &lt;- st_read(dsn = file.path(wd,"CoursEau_FXX_Topage2019.geojson"),
                               drivers = "GeoJSON", stringsAsFactors = FALSE, quiet = FALSE,
                               query = "SELECT gid FROM CoursEau_FXX_Topage2019")

## End(Not run)
</code></pre>

<hr>
<h2 id='convolution'>Convolution of net rainfall with unit hydrograph</h2><span id='topic+convolution'></span><span id='topic+convolution.default'></span><span id='topic+convolution.units'></span><span id='topic+convolution.transfR'></span>

<h3>Description</h3>

<p>Simulate the discharge by a convolution between the unit hydrograph and the net rainfall.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>convolution(Rn, ...)

## Default S3 method:
convolution(Rn, uh, continuous = FALSE, ...)

## S3 method for class 'units'
convolution(Rn, uh, ...)

## S3 method for class 'transfR'
convolution(
  Rn,
  Rcol = "RnSim",
  Qcol = "Qsim",
  save_donor = FALSE,
  verbose = TRUE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="convolution_+3A_rn">Rn</code></td>
<td>
<p>net rainfall vector or an object of class <code>transfR</code></p>
</td></tr>
<tr><td><code id="convolution_+3A_...">...</code></td>
<td>
<p>further arguments passed to or from other methods</p>
</td></tr>
<tr><td><code id="convolution_+3A_uh">uh</code></td>
<td>
<p>unit hydrograph vector</p>
</td></tr>
<tr><td><code id="convolution_+3A_continuous">continuous</code></td>
<td>
<p>boolean indicating if, when one time step might be influenced by past or future rainfall
(according to the time span of the unit hydrograph), no simulated value is provided</p>
</td></tr>
<tr><td><code id="convolution_+3A_rcol">Rcol</code></td>
<td>
<p>name of the space-time attribute for the discharge simulation in the <code>transfR</code> object</p>
</td></tr>
<tr><td><code id="convolution_+3A_qcol">Qcol</code></td>
<td>
<p>name of the space-time attribute for the net rainfall in the <code>transfR</code> object</p>
</td></tr>
<tr><td><code id="convolution_+3A_save_donor">save_donor</code></td>
<td>
<p>boolean indicating if additional discharge simulations should be computed using the
net rainfall of each individual donor catchment instead of just the weighted average net rainfall. This
requires that <code>save_donor</code> was TRUE when using <a href="#topic+mixr">mixr</a></p>
</td></tr>
<tr><td><code id="convolution_+3A_verbose">verbose</code></td>
<td>
<p>boolean indicating if information messages should be written to the console</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An object of the same class of <code>Rn</code>. If <code>Rn</code> is a transfR object,
the same transfR object incremented by the new computed attributes.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(Oudon)
icatch &lt;- 1
uc &lt;- velocity(hl = Oudon$hl[[icatch]])
uh &lt;- uh(hl = Oudon$hl[[icatch]], uc = uc, deltat = units::set_units(1,"h"))$prob
Rn &lt;- units::set_units(c(1,5,2), "mm/h")
Qsim &lt;- convolution(Rn = Rn, uh = uh)
</code></pre>

<hr>
<h2 id='hdist'>Geographical distance between catchments</h2><span id='topic+hdist'></span><span id='topic+hdist.sfc'></span><span id='topic+hdist.sf'></span><span id='topic+hdist.stars'></span><span id='topic+hdist.transfR'></span>

<h3>Description</h3>

<p>Calculate distances between two sets of catchments using their spatial support.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>hdist(x, y, ...)

## S3 method for class 'sfc'
hdist(
  x,
  y,
  method = "rghosh",
  gres = 5,
  ditself = FALSE,
  maxsample = 25000,
  proj = NULL,
  parallel = FALSE,
  cores = NULL,
  verbose = TRUE,
  ...
)

## S3 method for class 'sf'
hdist(x, y, ...)

## S3 method for class 'stars'
hdist(x, y, ...)

## S3 method for class 'transfR'
hdist(x, y, method = "rghosh", weightO = 0.8, weightC = 0.2, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="hdist_+3A_x">x</code></td>
<td>
<p>sf, stars or transfR object of the first catchments</p>
</td></tr>
<tr><td><code id="hdist_+3A_y">y</code></td>
<td>
<p>sf, stars or transfR object of the second catchments</p>
</td></tr>
<tr><td><code id="hdist_+3A_...">...</code></td>
<td>
<p>further arguments passed to or from other methods</p>
</td></tr>
<tr><td><code id="hdist_+3A_method">method</code></td>
<td>
<p>the method to use for computing distance. This must be one of &quot;ghosh&quot;,
&quot;rghosh&quot;, &quot;points&quot;, &quot;centroids&quot;, &quot;combined&quot;</p>
</td></tr>
<tr><td><code id="hdist_+3A_gres">gres</code></td>
<td>
<p>resolution of spatial discretisation (number of points by km²) for Ghosh
distance</p>
</td></tr>
<tr><td><code id="hdist_+3A_ditself">ditself</code></td>
<td>
<p>logical value indicating if the distance to itself should be computed.
It will add one row and one column in the distance matrix. Only used if method is &quot;ghosh&quot;</p>
</td></tr>
<tr><td><code id="hdist_+3A_maxsample">maxsample</code></td>
<td>
<p>maximum size of sampling points for each catchments during spatial discretisation</p>
</td></tr>
<tr><td><code id="hdist_+3A_proj">proj</code></td>
<td>
<p>logical indicating if spatial layer are using a projection. If TRUE, euclidean
distance is used. If FALSE, the great-circle distance is used</p>
</td></tr>
<tr><td><code id="hdist_+3A_parallel">parallel</code></td>
<td>
<p>logical indicating if the computation should be parallelised</p>
</td></tr>
<tr><td><code id="hdist_+3A_cores">cores</code></td>
<td>
<p>the number of cores to use for parallel execution if <code>parallel</code> is TRUE.
If not specified, the number of cores is set to the value of <code>parallel::detectCores()</code></p>
</td></tr>
<tr><td><code id="hdist_+3A_verbose">verbose</code></td>
<td>
<p>boolean indicating if information messages should be written to the console</p>
</td></tr>
<tr><td><code id="hdist_+3A_weighto">weightO</code></td>
<td>
<p>weight given to the distance between outlets if method is &quot;combined&quot;</p>
</td></tr>
<tr><td><code id="hdist_+3A_weightc">weightC</code></td>
<td>
<p>weight given to the distance between centroids if method is &quot;combined&quot;</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The <code>method</code> &quot;ghosh&quot; refers to a simplification of the distance defined
by Ghosh (1951) as proposed by Gottschalk (1993); Gottschalk et al. (2011).
The rescaled Ghosh distance (<code>method</code> &quot;rghosh&quot;) is calculted following de Lavenne et al. (2016).
</p>


<h3>Value</h3>

<p>A matrix of class units with the catchments of <code>x</code> organised in rows
and the catchments of <code>y</code> organised in columns.
</p>


<h3>References</h3>

<p>Ghosh B (1951).
&ldquo;Random distances within a rectangle and between two rectangles.&rdquo;
<em>Bull. Calcutta Math. Soc</em>, <b>43</b>(1), 17&ndash;24.
</p>
<p>Gottschalk L (1993).
&ldquo;Interpolation of runoff applying objective methods.&rdquo;
<em>Stochastic Hydrology and Hydraulics</em>, <b>7</b>(4), 269&ndash;281.
<a href="https://doi.org/10.1007/BF01581615">doi:10.1007/BF01581615</a>.
</p>
<p>Gottschalk L, Leblois E, Skøien JO (2011).
&ldquo;Distance measures for hydrological data having a support.&rdquo;
<em>J. Hydrol.</em>, <b>402</b>(3-4), 415&ndash;421.
<a href="https://doi.org/10.1016/j.jhydrol.2011.03.020">doi:10.1016/j.jhydrol.2011.03.020</a>.
</p>
<p>de Lavenne A, Skøien JO, Cudennec C, Curie F, Moatar F (2016).
&ldquo;Transferring measured discharge time series: Large-scale comparison of Top-kriging to geomorphology-based inverse modeling.&rdquo;
<em>Water Resources Research</em>, <b>52</b>(7), 5555&ndash;5576.
<a href="https://doi.org/10.1002/2016WR018716">doi:10.1002/2016WR018716</a>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(Oudon)
catchments &lt;- st_geometry(Oudon$obs)
hdist(x = catchments[1:2], y = catchments[3:5], gres = 5, method = "rghosh")
</code></pre>

<hr>
<h2 id='inversion'>Estimate net rainfall by inversion</h2><span id='topic+inversion'></span><span id='topic+inversion.default'></span><span id='topic+inversion.units'></span><span id='topic+inversion.transfR'></span>

<h3>Description</h3>

<p>Estimate net rainfall by inverse modelling, where the model is a convolution between net rainfall
and a unit hydrograph in order to simulate discharge.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>inversion(Qobs, ...)

## Default S3 method:
inversion(Qobs, uh, RnAp, deltat, ...)

## S3 method for class 'units'
inversion(
  Qobs,
  uh,
  RnAp,
  deltat,
  Bd = 0.01,
  Dd = 1,
  Bp = 0.001,
  Tp = 20,
  Ad = 0.01,
  Ap = 0.9,
  warmup = 10,
  cooldown = 8,
  dosplit = TRUE,
  split = 30,
  fixedpar = TRUE,
  parallel = FALSE,
  cores = NULL,
  ...
)

## S3 method for class 'transfR'
inversion(Qobs, verbose = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="inversion_+3A_qobs">Qobs</code></td>
<td>
<p>discharge vector or object of class <code>transfR</code>. If no unit is provided,
<code>Qobs</code> is assumed to be in [mm/h]</p>
</td></tr>
<tr><td><code id="inversion_+3A_...">...</code></td>
<td>
<p>further arguments passed to or from other methods</p>
</td></tr>
<tr><td><code id="inversion_+3A_uh">uh</code></td>
<td>
<p>unit hydrograph vector</p>
</td></tr>
<tr><td><code id="inversion_+3A_rnap">RnAp</code></td>
<td>
<p>net rainfall a priori. If no unit is provided, <code>RnAp</code> is assumed to be in [mm/h]</p>
</td></tr>
<tr><td><code id="inversion_+3A_deltat">deltat</code></td>
<td>
<p>time step of the time series. If no unit is provided, <code>deltat</code> is assumed to be in [min]</p>
</td></tr>
<tr><td><code id="inversion_+3A_bd">Bd</code></td>
<td>
<p>parameter used to maintain a minimum value of standart deviation for low discharge values.
If no unit is provided, <code>Bd</code> is assumed to be in [mm/h]</p>
</td></tr>
<tr><td><code id="inversion_+3A_dd">Dd</code></td>
<td>
<p>decorrelation time of discharge errors. If no unit is provided, <code>Dd</code> is assumed to be
in [h]</p>
</td></tr>
<tr><td><code id="inversion_+3A_bp">Bp</code></td>
<td>
<p>parameter used to maintain a minimum value of standart deviation for low net rainfall values.
If no unit is provided, <code>Bp</code> is assumed to be in [mm/h]</p>
</td></tr>
<tr><td><code id="inversion_+3A_tp">Tp</code></td>
<td>
<p>decorrelation time of net rainfall errors. If no unit is provided, <code>Tp</code> is assumed to
be in [h]</p>
</td></tr>
<tr><td><code id="inversion_+3A_ad">Ad</code></td>
<td>
<p>parameter equivalent to the coefficient of variation of the discharge measurement error. If
no unit is provided, <code>Ad</code> is assumed to be dimensionless</p>
</td></tr>
<tr><td><code id="inversion_+3A_ap">Ap</code></td>
<td>
<p>parameter equivalent to the coefficient of variation of the net rainfall error. If no unit
is provided, <code>Ap</code> is assumed to be dimensionless</p>
</td></tr>
<tr><td><code id="inversion_+3A_warmup">warmup</code></td>
<td>
<p>length of the warmup period. If no unit is provided, <code>warmup</code> is assumed to be in [days]</p>
</td></tr>
<tr><td><code id="inversion_+3A_cooldown">cooldown</code></td>
<td>
<p>length of the period removed at the end of the simulation. If no unit is provided,
<code>cooldown</code> is assumed to be in [days]</p>
</td></tr>
<tr><td><code id="inversion_+3A_dosplit">dosplit</code></td>
<td>
<p>boolean, if true the inversion is performed by
subperiods of length defined by <code>split</code></p>
</td></tr>
<tr><td><code id="inversion_+3A_split">split</code></td>
<td>
<p>length the subperiods if dosplit is true. If no unit is provided, <code>split</code> is assumed to be
in [days]</p>
</td></tr>
<tr><td><code id="inversion_+3A_fixedpar">fixedpar</code></td>
<td>
<p>boolean, if false Ap and Ad are calibrated dynamically according to the coefficient of variation of
RnAp and Qobs respectively (see details)</p>
</td></tr>
<tr><td><code id="inversion_+3A_parallel">parallel</code></td>
<td>
<p>boolean, if true the splitting of the inversion
by subperiods is parallelised</p>
</td></tr>
<tr><td><code id="inversion_+3A_cores">cores</code></td>
<td>
<p>the number of cores to use for parallel execution if <code>parallel</code> is TRUE. If not specified, the number of cores is set to the value of <code>parallel::detectCores()</code></p>
</td></tr>
<tr><td><code id="inversion_+3A_verbose">verbose</code></td>
<td>
<p>boolean indicating if information messages should be written to the console</p>
</td></tr>
</table>


<h3>Details</h3>

<p>In a convolution between the unit hydrograph (<code>uh</code>) and net rainfall that is simulating
streamflow at the outltet (<code>Qobs</code>), and where net rainfall is the only unknown variable, this function estimates
net rainfall by inversion (Tarantola and Valette 1982; Menke 1989; Boudhraâ et al. 2018). It requires an
a priori on this net rainfall (that could be estimated by the function <a href="#topic+rapriori">rapriori</a>), a description
of the errors on the discharge (<code>Ad</code>, <code>Bd</code>, <code>Dd</code>) and on the net rainfall (<code>Ap</code>,
<code>Bp</code>, <code>Tp</code>) that are assumed to be Gaussian and unbiased. Default values of these parameters
are taken from de Lavenne et al. (2016). If <code>fixedpar</code> is deactivated, <code>Ap</code>
is estimated at 20
of variation of Qobs.
</p>
<p>It is recommanded to use <code>warmup</code> and <code>cooldown</code> periods in order to reduce the problem of oscillations
created by inversion.
</p>
<p>If <code>object</code> is provided, results are stored as a new space-time attribute in the <code>object</code>
called &quot;RnAp&quot;.
</p>


<h3>Value</h3>

<p>An object of the same class of <code>Qobs</code>. If <code>Qobs</code> is a transfR object,
the same transfR object incremented by the new computed attributes.
</p>


<h3>References</h3>

<p>Boudhraâ H, Cudennec C, Andrieu H, Slimani M (2018).
&ldquo;Net rainfall estimation by the inversion of a geomorphology-based transfer function and discharge deconvolution.&rdquo;
<em>Hydrological Sciences Journal</em>, <b>63</b>(2), 285&ndash;301.
<a href="https://doi.org/10.1080/02626667.2018.1425801">doi:10.1080/02626667.2018.1425801</a>.
</p>
<p>de Lavenne A, Skøien JO, Cudennec C, Curie F, Moatar F (2016).
&ldquo;Transferring measured discharge time series: Large-scale comparison of Top-kriging to geomorphology-based inverse modeling.&rdquo;
<em>Water Resources Research</em>, <b>52</b>(7), 5555&ndash;5576.
<a href="https://doi.org/10.1002/2016WR018716">doi:10.1002/2016WR018716</a>.
</p>
<p>Menke W (1989).
<em>Geophysical data analysis: discrete inverse theory</em>, volume 45.
Academic Press.
</p>
<p>Tarantola A, Valette B (1982).
&ldquo;Inverse problems= quest for information.&rdquo;
<em>Journal of Geophysics</em>, <b>50</b>(3), 150&ndash;170.
</p>


<h3>See Also</h3>

<p><a href="#topic+rapriori">rapriori</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(Oudon)
icatch &lt;- 1 # Catchment index
itime &lt;- 1:1000 # Using the first values for a quicker example
Qobs &lt;- Oudon$obs[["Qobs"]][itime,icatch]
Qspec &lt;- units::set_units(Qobs/st_area(st_geometry(Oudon$obs)[icatch]), "mm/h")
deltat &lt;- units::set_units(1, "h")
uc &lt;- velocity(hl = Oudon$hl[[icatch]])
uh &lt;- uh(hl = Oudon$hl[[icatch]], uc = uc, deltat = units::set_units(1,"h"))$prob
RnAp &lt;- rapriori(Qobs = Qspec, lagtime = lagtime(hl = Oudon$hl[[icatch]], uc = uc),
deltat = deltat)
RnInv &lt;- inversion(Qobs = Qspec, RnAp = RnAp, uh = uh, deltat = deltat)
</code></pre>

<hr>
<h2 id='lagtime'>Lag time estimation</h2><span id='topic+lagtime'></span><span id='topic+lagtime.default'></span><span id='topic+lagtime.units'></span><span id='topic+lagtime.stars'></span><span id='topic+lagtime.transfR'></span>

<h3>Description</h3>

<p>Estimate the lag time of the catchment.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>lagtime(hl, ...)

## Default S3 method:
lagtime(hl, uc, ...)

## S3 method for class 'units'
lagtime(hl, uc, method = 1, ...)

## S3 method for class 'stars'
lagtime(hl, ...)

## S3 method for class 'transfR'
lagtime(hl, verbose = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="lagtime_+3A_hl">hl</code></td>
<td>
<p>hydraulic length of class <code>transfR</code> or <code>stars</code> or <code>matrix</code> or <code>vector</code>.
If no unit is provided, <code>hl</code> is assumed to be in [m].</p>
</td></tr>
<tr><td><code id="lagtime_+3A_...">...</code></td>
<td>
<p>further arguments passed to or from other methods</p>
</td></tr>
<tr><td><code id="lagtime_+3A_uc">uc</code></td>
<td>
<p>streamflow velocity. If no unit is provided, <code>uc</code> is assumed to be in [m/s].</p>
</td></tr>
<tr><td><code id="lagtime_+3A_method">method</code></td>
<td>
<p>integer describing the method to use for lag time estimation. Possible values: 1 (see details).</p>
</td></tr>
<tr><td><code id="lagtime_+3A_verbose">verbose</code></td>
<td>
<p>boolean indicating if information messages should be written to the console.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function estimates the lag time of the catchment. It can be used to estimate one of the
inputs of the function <a href="#topic+rapriori">rapriori</a>. If <code>method</code> is 1, the lag time is estimated
from the ratio of the mean hydraulic length (<code>hl</code>) and the average streamflow velocity (<code>uc</code>).
</p>


<h3>Value</h3>

<p>A numeric value of class units, or if <code>hl</code> is a transfR object,
the same transfR object incremented by the &quot;lagtime&quot; attribute.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(Oudon)
icatch &lt;- 1
lagtime(Oudon$hl[[icatch]], uc = units::set_units(0.5, "m/s"))
</code></pre>

<hr>
<h2 id='mixr'>Transfer of net rainfall to ungauged catchments</h2><span id='topic+mixr'></span>

<h3>Description</h3>

<p>Combine the net rainfall of gauged catchments to simulate the net rainfall
of an ungauged catchment.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>mixr(
  obs,
  sim,
  mdist,
  distance = "rghosh",
  gres = 5,
  weightO = 0.8,
  weightC = 0.2,
  parallel = FALSE,
  cores = NULL,
  power = 1,
  ndonors = 5,
  donors = NULL,
  maxdist = 50000,
  flexible_donor = TRUE,
  cv = FALSE,
  save_donor = FALSE,
  verbose = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="mixr_+3A_obs">obs</code></td>
<td>
<p>&quot;transfR&quot; object of the gauged catchments</p>
</td></tr>
<tr><td><code id="mixr_+3A_sim">sim</code></td>
<td>
<p>&quot;transfR&quot; object of the ungauged catchments</p>
</td></tr>
<tr><td><code id="mixr_+3A_mdist">mdist</code></td>
<td>
<p>the distance matrix between gauged and ungauged catchments as computed by
the function <a href="#topic+hdist">hdist</a></p>
</td></tr>
<tr><td><code id="mixr_+3A_distance">distance</code></td>
<td>
<p>the method to use for computing distance matrix if <code>mdist</code> is not provided.
Possible values are &quot;ghosh&quot;, &quot;rghosh&quot;, &quot;points&quot;, &quot;centroids&quot;, &quot;combined&quot; as available
in the function <a href="#topic+hdist">hdist</a></p>
</td></tr>
<tr><td><code id="mixr_+3A_gres">gres</code></td>
<td>
<p>resolution of spatial discretisation (number of points by km²) for Ghosh
distance (see the function <a href="#topic+hdist">hdist</a>)</p>
</td></tr>
<tr><td><code id="mixr_+3A_weighto">weightO</code></td>
<td>
<p>weight given to the distance between outlets if <code>distance</code> is &quot;combined&quot;
(see the function <a href="#topic+hdist">hdist</a>)</p>
</td></tr>
<tr><td><code id="mixr_+3A_weightc">weightC</code></td>
<td>
<p>weight given to the distance between centroids if <code>distance</code> is &quot;combined&quot;
(see the function <a href="#topic+hdist">hdist</a>)</p>
</td></tr>
<tr><td><code id="mixr_+3A_parallel">parallel</code></td>
<td>
<p>logical indicating if the computation should be parallelised</p>
</td></tr>
<tr><td><code id="mixr_+3A_cores">cores</code></td>
<td>
<p>the number of cores to use for parallel execution if <code>parallel</code> is TRUE.
If not specified, the number of cores is set to the value of <code>parallel::detectCores()</code></p>
</td></tr>
<tr><td><code id="mixr_+3A_power">power</code></td>
<td>
<p>exponent applied in the inverse distance weighting strategy as defined by the function
<a href="#topic+weightr">weightr</a></p>
</td></tr>
<tr><td><code id="mixr_+3A_ndonors">ndonors</code></td>
<td>
<p>maximum number of catchments to be used to simulate discharge of an ungauged
catchment as defined by the function <a href="#topic+weightr">weightr</a></p>
</td></tr>
<tr><td><code id="mixr_+3A_donors">donors</code></td>
<td>
<p>vector of catchments id from which donors are selected. If empty, the <code>ndonors</code> closest
catchments are used</p>
</td></tr>
<tr><td><code id="mixr_+3A_maxdist">maxdist</code></td>
<td>
<p>maximum distance between a gauged and an ungauged catchment to allow the net rainfall
to be transfered. This threshold is applied on the <code>mdist</code> distance matrix. If no units is provided,
<code>maxdist</code> is assumed to be in [m].</p>
</td></tr>
<tr><td><code id="mixr_+3A_flexible_donor">flexible_donor</code></td>
<td>
<p>boolean indicating if the donor catchments can change during the simulation period
according to the availability of discharge observations. See <a href="#topic+weightr">weightr</a> for more details</p>
</td></tr>
<tr><td><code id="mixr_+3A_cv">cv</code></td>
<td>
<p>boolean indicating if cross validation evaluation should be done. If true, it will estimate
the net rainfall of every gauged catchments (<code>obs</code>) as if they were ungauged (leave-one-out evaluation)</p>
</td></tr>
<tr><td><code id="mixr_+3A_save_donor">save_donor</code></td>
<td>
<p>boolean indicating if the net rainfall of each of the <code>ndonors</code> catchments
should be stored in the sim object for further analysis. If true, it is adding three new space-time attributes
in the <code>sim</code> object called &quot;RnDonor&quot;, &quot;Idonor&quot; and &quot;Wdonor&quot; describing the net rainfall, the id and
the weight of the donor catchments respectively</p>
</td></tr>
<tr><td><code id="mixr_+3A_verbose">verbose</code></td>
<td>
<p>boolean indicating if information messages should be written to the console</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function is a wrapper function for <a href="#topic+hdist">hdist</a> and <a href="#topic+weightr">weightr</a> to directly estimate
the net rainfall on a set of ungauged catchments (<code>sim</code>) from a set of gauged catchments (<code>obs</code>).
It returns the simulated net rainfall as a new space-time attribute in the <code>sim</code> object called &quot;RnSim&quot;.
The simulated net rainfall of a given ungauged catchment <code class="reqn">i</code> is a weighted average of the net rainfalls
of <code>ndonors</code> gauged catchments <code class="reqn">j</code>:
</p>
<p style="text-align: center;"><code class="reqn">R_n^i =\Sigma_{j=1}^{ndonors} R_n^j \cdot \lambda_j</code>
</p>

<p>where <code class="reqn">\lambda_j</code> are defined by an inverse distance weighting function (see <a href="#topic+weightr">weightr</a>).
</p>


<h3>Value</h3>

<p>The <code>sim</code> object incremented by the new computed attributes.
</p>


<h3>See Also</h3>

<p><a href="#topic+hdist">hdist</a>, <a href="#topic+weightr">weightr</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(Oudon)
object &lt;- as_transfr(st = Oudon$obs, hl = Oudon$hl)
object &lt;- velocity(object)
object &lt;- uh(object)
object &lt;- lagtime(object)
object &lt;- rapriori(object)
object &lt;- inversion(object, parallel = TRUE, cores = 2)
mdist  &lt;- hdist(x = object, y = object, method = "rghosh")
object &lt;- mixr(obs = object, mdist = mdist, parallel = TRUE, cores=2,
cv = TRUE, flexible_donor = TRUE, save_donor = FALSE)
object &lt;- convolution(object, save_donor = FALSE)
plot(object, i = 1, attribute = c("Qobs", "Qsim"))
</code></pre>

<hr>
<h2 id='Oudon'>Oudon French river dataset</h2><span id='topic+Oudon'></span>

<h3>Description</h3>

<p>'Oudon' is a dataset of the Oudon French river, part of the wider Loire Catchment. It contains all the necessary inputs to test the package and perform discharge prediction at the outlet of six sub-catchments:
</p>

<ul>
<li> <p>M3771810  Oudon at Châtelais (734 km²)
</p>
</li>
<li> <p>M3774010  Chéran at la Boissière (85 km²)
</p>
</li>
<li> <p>M3823010  Verzée at Bourg-d'Iré (205 km²)
</p>
</li>
<li> <p>M3834030  Argos at Sainte-Gemmes-d'Andigné (153 km²)
</p>
</li>
<li> <p>M3851810  Oudon at Segré (1310 km²)
</p>
</li>
<li> <p>M3711810  Oudon at Cossé-le-Vivien (133 km²)
</p>
</li></ul>

<p>Hourly discharge observations of the six sub-catchments (Oudon French river) are provided from 2019-12-01 to 2020-03-01, and extracted from the French HYDRO database (http://www.hydro.eaufrance.fr). Catchment delineations and respective maps of hydraulic length have been extracted from a digital elevation model of 100 m resolution.
</p>


<h3>Format</h3>

<p>'Oudon' is a list of two objects:
</p>

<ul>
<li> <p>hl  A list of stars objects containing the six rasters maps of hydraulic length.
</p>
</li>
<li> <p>obs  A stars object with two dimensions (time and space, with catchment delineations as spatial support) and one attribute (discharge observations).
</p>
</li></ul>


<h3>Source</h3>

<p>http://www.hydro.eaufrance.fr</p>

<hr>
<h2 id='plot'>Plot transfR object</h2><span id='topic+plot'></span><span id='topic+plot.transfR'></span>

<h3>Description</h3>

<p>Plot transfR object.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'transfR'
plot(
  x,
  y,
  i,
  attribute,
  main = sprintf("Catchment %i", i),
  xlab,
  ylab,
  format,
  at,
  nticks = 5,
  type = "l",
  lwd = 2,
  las = 1,
  cex.names = 1,
  col = c("#045a8d", "#fb8072", "#bebada", "#ffffb3", "#8dd3c7"),
  keeplocal = TRUE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="plot_+3A_x">x</code></td>
<td>
<p>transfR object</p>
</td></tr>
<tr><td><code id="plot_+3A_y">y</code></td>
<td>
<p>ignored</p>
</td></tr>
<tr><td><code id="plot_+3A_i">i</code></td>
<td>
<p>spatial index to plot</p>
</td></tr>
<tr><td><code id="plot_+3A_attribute">attribute</code></td>
<td>
<p>attribute of the transfR object to plot</p>
</td></tr>
<tr><td><code id="plot_+3A_main">main</code></td>
<td>
<p>a main title for the plot, see also <a href="graphics.html#topic+title">title</a></p>
</td></tr>
<tr><td><code id="plot_+3A_xlab">xlab</code></td>
<td>
<p>a label for the x axis, defaults to a description of x</p>
</td></tr>
<tr><td><code id="plot_+3A_ylab">ylab</code></td>
<td>
<p>a label for the y axis, defaults to a description of y</p>
</td></tr>
<tr><td><code id="plot_+3A_format">format</code></td>
<td>
<p>format for labels of time series on x axis</p>
</td></tr>
<tr><td><code id="plot_+3A_at">at</code></td>
<td>
<p>a date-time or date object for ticks on x axis</p>
</td></tr>
<tr><td><code id="plot_+3A_nticks">nticks</code></td>
<td>
<p>number of ticks on x axis</p>
</td></tr>
<tr><td><code id="plot_+3A_type">type</code></td>
<td>
<p>1-character string giving the type of plot desired (for details,
see <a href="graphics.html#topic+plot">plot</a>)</p>
</td></tr>
<tr><td><code id="plot_+3A_lwd">lwd</code></td>
<td>
<p>the line width (for details, see <a href="graphics.html#topic+par">par</a>)</p>
</td></tr>
<tr><td><code id="plot_+3A_las">las</code></td>
<td>
<p>the style of axis labels (for details, see <a href="graphics.html#topic+par">par</a>)</p>
</td></tr>
<tr><td><code id="plot_+3A_cex.names">cex.names</code></td>
<td>
<p>expansion factor for axis names (for details, see <a href="graphics.html#topic+barplot">barplot</a>)</p>
</td></tr>
<tr><td><code id="plot_+3A_col">col</code></td>
<td>
<p>a specification for the default plotting color (for details, see <a href="graphics.html#topic+par">par</a>)</p>
</td></tr>
<tr><td><code id="plot_+3A_keeplocal">keeplocal</code></td>
<td>
<p>boolean to preserve local graphical parameters</p>
</td></tr>
<tr><td><code id="plot_+3A_...">...</code></td>
<td>
<p>further specifications, see <a href="graphics.html#topic+plot">plot</a></p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>data(Oudon)
object &lt;- as_transfr(st = Oudon$obs, hl = Oudon$hl)
plot(object, attribute = "Qobs")
</code></pre>

<hr>
<h2 id='quick_transfr'>Transfer of observed discharge from gauged catchments to ungauged catchments</h2><span id='topic+quick_transfr'></span>

<h3>Description</h3>

<p>Wrap up all the modelling steps into one function for a quick implementation of this R package.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>quick_transfr(
  obs,
  sim,
  velocity = "loire2016",
  distance = "rghosh",
  gres = 5,
  weightO = 0.8,
  weightC = 0.2,
  power = 1,
  ndonors = 5,
  maxdist = 50000,
  flexible_donor = TRUE,
  cv = FALSE,
  save_donor = FALSE,
  warmup = 10,
  cooldown = 8,
  dosplit = TRUE,
  split = 30,
  parallel = FALSE,
  cores = NULL,
  verbose = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="quick_transfr_+3A_obs">obs</code></td>
<td>
<p>&quot;transfR&quot; object of the gauged catchments</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_sim">sim</code></td>
<td>
<p>&quot;transfR&quot; object of the ungauged catchments</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_velocity">velocity</code></td>
<td>
<p>character string describing the method to estimate the streamflow velocity.
See <a href="#topic+velocity">velocity</a> for the available options (<code>method</code> argument)</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_distance">distance</code></td>
<td>
<p>character string describing the method to compute the distance between catchments.
See <a href="#topic+hdist">hdist</a> for the available options (<code>method</code> argument)</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_gres">gres</code></td>
<td>
<p>resolution of spatial discretisation (number of points by km²) for Ghosh
distance. See <a href="#topic+hdist">hdist</a> for more details</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_weighto">weightO</code></td>
<td>
<p>weight given to the distance between outlets if distance method is &quot;combined&quot;.
See <a href="#topic+hdist">hdist</a> for more details</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_weightc">weightC</code></td>
<td>
<p>weight given to the distance between centroids if distance method is &quot;combined&quot;.
See <a href="#topic+hdist">hdist</a> for more details</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_power">power</code></td>
<td>
<p>exponent applied in the inverse distance weighting strategy. See <a href="#topic+weightr">weightr</a> for more details</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_ndonors">ndonors</code></td>
<td>
<p>maximum number of catchments to be used to simulate discharge of an ungauged
catchment. See <a href="#topic+weightr">weightr</a> for more details</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_maxdist">maxdist</code></td>
<td>
<p>maximum distance between a gauged and an ungauged catchment to allow the net rainfall
to be transfered. This threshold is applied on the <code>mdist</code> distance matrix. If no units is provided,
<code>maxdist</code> is assumed to be in [m]. See <a href="#topic+mixr">mixr</a> for more details</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_flexible_donor">flexible_donor</code></td>
<td>
<p>boolean indicating if the donor catchments can change during the simulation period
according to the availability of discharge observations. See <a href="#topic+weightr">weightr</a> for more details</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_cv">cv</code></td>
<td>
<p>boolean indicating if cross validation evaluation should be done. If true, it will estimate
the net rainfall of every gauged catchments (<code>obs</code>) as if they were ungauged (leave-one-out evaluation)</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_save_donor">save_donor</code></td>
<td>
<p>boolean indicating if the net rainfall of each of the <code>ndonors</code> catchments
should be stored in the sim object for further analysis. If true, it is adding three new space-time attributes
in the <code>sim</code> object called &quot;RnDonor&quot;, &quot;Idonor&quot; and &quot;Wdonor&quot; describing the net rainfall, the id and
the weight of the donor catchments respectively. See <a href="#topic+mixr">mixr</a> for more details</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_warmup">warmup</code></td>
<td>
<p>length of the warmup period. If no unit is provided, <code>warmup</code> is assumed to be in [days].
See <a href="#topic+inversion">inversion</a> for more details</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_cooldown">cooldown</code></td>
<td>
<p>length of the period removed at the end of the simulation. If no unit is provided,
<code>cooldown</code> is assumed to be in [days]. See <a href="#topic+inversion">inversion</a> for more details</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_dosplit">dosplit</code></td>
<td>
<p>boolean, if true the inversion is performed by
subperiods of length defined by <code>split</code>. See <a href="#topic+inversion">inversion</a> for more details</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_split">split</code></td>
<td>
<p>length the subperiods if dosplit is true. If no unit is provided, <code>split</code> is assumed to be
in [days]. See <a href="#topic+inversion">inversion</a> for more details</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_parallel">parallel</code></td>
<td>
<p>logical indicating if the computation should be parallelised</p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_cores">cores</code></td>
<td>
<p>the number of cores to use for parallel execution if <code>parallel</code> is TRUE.
If not specified, the number of cores is set to the value of <code>parallel::detectCores()</code></p>
</td></tr>
<tr><td><code id="quick_transfr_+3A_verbose">verbose</code></td>
<td>
<p>boolean indicating if information messages should be written to the console</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function applies sequentially the following functions: <a href="#topic+velocity">velocity</a>, <a href="#topic+uh">uh</a>,
<a href="#topic+lagtime">lagtime</a>, <a href="#topic+rapriori">rapriori</a>, <a href="#topic+inversion">inversion</a>, <a href="#topic+hdist">hdist</a>, <a href="#topic+mixr">mixr</a> and <a href="#topic+convolution">convolution</a>.
Please refer to the help of each of these functions and to <a href="#topic+transfR-package">transfR-package</a> for a general description of the
modelling approach.
</p>


<h3>Value</h3>

<p>The <code>sim</code> object incremented by the new computed attributes
</p>


<h3>See Also</h3>

<p><a href="#topic+velocity">velocity</a>, <a href="#topic+uh">uh</a>, <a href="#topic+lagtime">lagtime</a>, <a href="#topic+rapriori">rapriori</a>, <a href="#topic+inversion">inversion</a>,
<a href="#topic+hdist">hdist</a>, <a href="#topic+mixr">mixr</a>, <a href="#topic+convolution">convolution</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(Oudon)
obs &lt;- as_transfr(st = Oudon$obs[,,1:3], hl = Oudon$hl[1:3]) #gauged catchments
sim &lt;- as_transfr(st = Oudon$obs[,,4:6], hl = Oudon$hl[4:6]) #catchments considered as ungauged
sim &lt;- quick_transfr(obs, sim)
</code></pre>

<hr>
<h2 id='rapriori'>Net rainfall a priori estimation</h2><span id='topic+rapriori'></span><span id='topic+rapriori.default'></span><span id='topic+rapriori.units'></span><span id='topic+rapriori.transfR'></span>

<h3>Description</h3>

<p>A priori estimate of net rainfall as required for the inversion.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>rapriori(Qobs, ...)

## Default S3 method:
rapriori(Qobs, area, lagtime, deltat, ...)

## S3 method for class 'units'
rapriori(Qobs, area, lagtime, deltat, ...)

## S3 method for class 'transfR'
rapriori(Qobs, verbose = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="rapriori_+3A_qobs">Qobs</code></td>
<td>
<p>vector of discharge value or object of class <code>transfR</code>. If no unit is provided,
<code>Qobs</code> is assumed to be in [m3/s].</p>
</td></tr>
<tr><td><code id="rapriori_+3A_...">...</code></td>
<td>
<p>further arguments passed to or from other methods</p>
</td></tr>
<tr><td><code id="rapriori_+3A_area">area</code></td>
<td>
<p>drainage area of the catchment. If no unit is provided, <code>area</code> is assumed to be in [km2].</p>
</td></tr>
<tr><td><code id="rapriori_+3A_lagtime">lagtime</code></td>
<td>
<p>lag time value of the catchment. If no unit is provided, <code>lagtime</code> is assumed to be in [h].</p>
</td></tr>
<tr><td><code id="rapriori_+3A_deltat">deltat</code></td>
<td>
<p>time step of the time series. If no unit is provided, <code>deltat</code> is assumed to be in [min].</p>
</td></tr>
<tr><td><code id="rapriori_+3A_verbose">verbose</code></td>
<td>
<p>boolean indicating if information messages should be written to the console</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function estimates an a priori of the net rainfall from Qobs. It converts Qobs to specific
discharge and removes the delay caused by transfer time in the river network (given by <code>lagtime</code>
and that could be estimated from the function <a href="#topic+lagtime">lagtime</a>). If an object of class <code>transfR</code> is provided,
<code>area</code> is estimated from its <code>st</code> attribute. Results are stored as a new space-time attribute,
called &quot;RnAp&quot;, in the <code>transfR</code> object.
</p>


<h3>Value</h3>

<p>An object of the same class of <code>Qobs</code>. If <code>Qobs</code> is a transfR object,
the same transfR object incremented by the new &quot;RnAp&quot; computed attributes.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(Oudon)
icatch &lt;- 1
Qobs &lt;- Oudon$obs[["Qobs"]][,icatch]
Qspec &lt;- units::set_units(Qobs/st_area(st_geometry(Oudon$obs)[icatch]), "mm/h")
deltat &lt;- units::set_units(1,"h")
uc &lt;- velocity(hl = Oudon$hl[[icatch]])
uh &lt;- uh(hl = Oudon$hl[[icatch]], uc = uc, deltat = deltat)$prob
RnAp &lt;- rapriori(Qobs = Qspec, lagtime = lagtime(hl = Oudon$hl[[icatch]], uc = uc),
deltat = deltat)
</code></pre>

<hr>
<h2 id='transfR-package'>Transfer of Hydrograph from Gauged to Ungauged Catchments</h2><span id='topic+transfR'></span><span id='topic+transfR-package'></span>

<h3>Description</h3>

<p>This R package aims to propose a geomorphology-based hydrological modelling to transfer streamflow measurements from gauged catchments to ungauged catchments, i.e. where there is no station monitoring the streamflow. It follows a runoff-runoff approach, i.e. it directly combines the observed streamflow series available at monitoring stations to estimate the streamflow series anywhere else in the surroundings rivers and without the need to implement a full rainfall-runoff model. The package itself and theoretical aspects of the approach are presented in detail and discussed by de Lavenne et al. (2023). <br /><br />
</p>
<p>## &mdash; Short description of the modelling approach
</p>
<p>The hydrological modelling is based on a description of the hydro-geomorphometry of the river network which can be easily observed for any given outlet. An inversion of this model for a gauged catchment allows the observed streamflow series being deconvoluted in order to estimate an almost scale-independent signal, namely the net rainfall (Boudhraâ et al. 2018). Transferring this estimate of the net rainfall series to a targeted ungauged catchment then allows simulating the streamflow there. The use of streamflow observations from several gauged catchments of the neighbourhood increases the robustness of the simulation (de Lavenne et al. 2016). The methodology has first been implemented on a few catchments in semiarid Tunisia at the event time scale (Boudhraâ et al. 2009), then in dense configurations of neighbouring and nesting catchments in France with mainly temperate oceanic climate (de Lavenne et al. 2015; de Lavenne et al. 2016; de Lavenne and Cudennec 2019) and in snow-influenced Québec, Canada (Ecrepont et al. 2019). <br /><br />
</p>
<p>## &mdash; Functions and objects
</p>
<p>To implement the method, it is advised to explore the following functions in this order:
</p>

<ul>
<li> <p><code><a href="#topic+as_transfr">as_transfr</a></code> create a &ldquo;transfR&rdquo; database from a &ldquo;stars&rdquo; object and morphometric description of the catchments (hydraulic lengths)
</p>
</li>
<li> <p><code><a href="#topic+velocity">velocity</a></code> estimates the main model parameter, i.e. the streamflow velocity, from different regionalisation strategies
</p>
</li>
<li> <p><code><a href="#topic+uh">uh</a></code> estimates a simple linear model, i.e. the unit hydrograph, based on the analysis of catchment geomorphology and streamflow velocity
</p>
</li>
<li> <p><code><a href="#topic+rapriori">rapriori</a></code> provides an a priori on the net rainfall, as needed for the model's inversion
</p>
</li>
<li> <p><code><a href="#topic+inversion">inversion</a></code> estimates the net rainfall by an inverse modelling
</p>
</li>
<li> <p><code><a href="#topic+hdist">hdist</a></code> computes hydrological distances between catchments, such as the rescaled Ghosh distances
</p>
</li>
<li> <p><code><a href="#topic+mixr">mixr</a></code> estimates the net rainfall of one catchment by averaging the net rainfall of neighbouring gauged catchments and according to hydrological distances
</p>
</li>
<li> <p><code><a href="#topic+convolution">convolution</a></code> computes the convolution of the net rainfall by the unit hydrograph to estimate streamflow
</p>
</li></ul>

<p>## &mdash; How to get started
</p>
<p>This package comes with two datasets (<a href="#topic+Blavet">Blavet</a> and <a href="#topic+Oudon">Oudon</a>) that contains all the necessary inputs to test the package and perform discharge prediction. Users are advised to check the 'Get started with transfR' vignette (<code>vignette("V01_get_started", package = "transfR")</code>) that provides a complete implementation of the method with the Oudon dataset. Two additional vignettes are proposed to help the preparation of input data: a spatiotemporal array of observed discharge (<code>vignette("V02_inputs_preparation_stars", package = "transfR")</code>) and a morphometric description of the catchments (<code>vignette("V03_inputs_preparation_whitebox", package = "transfR")</code>). In addition, each function comes with different examples.
</p>
<p>A detailed description of the modelling approach and the package has been published by de Lavenne et al. (2023): the theoretical aspects of each modelling step are described in more detail, arguments justifying the default values used in the functions are presented, and limitations of the approach are discussed for a consistent implementation of the approach.
</p>
<p>For the French region of Brittany, a <a href="https://geosas.fr/simfen/">web service</a> using this package was developed to facilitate the implementation of the method without the need for the user to have programming skills in R or to collect the necessary input data (Dallery et al. 2020).
</p>


<h3>References</h3>

<p>Boudhraâ H, Cudennec C, Slimani M, Andrieu H (2009).
&ldquo;Hydrograph transposition between basins through a geomorphology-based deconvolution-reconvolution approach.&rdquo;
<em>IAHS publication</em>, <b>333</b>, 76.
</p>
<p>Boudhraâ H, Cudennec C, Andrieu H, Slimani M (2018).
&ldquo;Net rainfall estimation by the inversion of a geomorphology-based transfer function and discharge deconvolution.&rdquo;
<em>Hydrological Sciences Journal</em>, <b>63</b>(2), 285&ndash;301.
<a href="https://doi.org/10.1080/02626667.2018.1425801">doi:10.1080/02626667.2018.1425801</a>.
</p>
<p>Ecrepont S, Cudennec C, Anctil F, Jaffrézic A (2019).
&ldquo;PUB in Québec: A robust geomorphology-based deconvolution-reconvolution framework for the spatial transposition of hydrographs.&rdquo;
<em>Journal of Hydrology</em>, <b>570</b>, 378&ndash;392.
<a href="https://doi.org/10.1016/j.jhydrol.2018.12.052">doi:10.1016/j.jhydrol.2018.12.052</a>.
</p>
<p>Dallery D, Squividant H, de Lavenne A, Launay J, Cudennec C (2020).
&ldquo;An end-user-friendly hydrological Web Service for hydrograph prediction in ungauged basins.&rdquo;
<em>Hydrological Sciences Journal</em>, 1&ndash;9.
<a href="https://doi.org/10.1080/02626667.2020.1797045">doi:10.1080/02626667.2020.1797045</a>.
</p>
<p>de Lavenne A, Boudhraâ H, Cudennec C (2015).
&ldquo;Streamflow prediction in ungauged basins through geomorphology-based hydrograph transposition.&rdquo;
<em>Hydrology Research</em>, <b>46</b>(2), 291–302.
<a href="https://doi.org/10.2166/nh.2013.099">doi:10.2166/nh.2013.099</a>.
</p>
<p>de Lavenne A, Skøien JO, Cudennec C, Curie F, Moatar F (2016).
&ldquo;Transferring measured discharge time series: Large-scale comparison of Top-kriging to geomorphology-based inverse modeling.&rdquo;
<em>Water Resources Research</em>, <b>52</b>(7), 5555&ndash;5576.
<a href="https://doi.org/10.1002/2016WR018716">doi:10.1002/2016WR018716</a>.
</p>
<p>de Lavenne A, Cudennec C (2019).
&ldquo;Assessment of freshwater discharge into a coastal bay through multi-basin ensemble hydrological modelling.&rdquo;
<em>Science of The Total Environment</em>, <b>669</b>, 812 - 820.
ISSN 0048-9697, <a href="https://doi.org/10.1016/j.scitotenv.2019.02.387">doi:10.1016/j.scitotenv.2019.02.387</a>.
</p>
<p>de Lavenne A, Loree T, Squividant H, Cudennec C (2023).
&ldquo;The transfR toolbox for transferring observed streamflow series to ungauged basins based on their hydrogeomorphology.&rdquo;
<em>Environmental Modelling &amp; Software</em>, <b>159</b>, 105562.
ISSN 1364-8152, <a href="https://doi.org/10.1016/j.envsoft.2022.105562">doi:10.1016/j.envsoft.2022.105562</a>.
</p>

<hr>
<h2 id='uh'>Unit hydrograph estimation</h2><span id='topic+uh'></span><span id='topic+uh.default'></span><span id='topic+uh.units'></span><span id='topic+uh.stars'></span><span id='topic+uh.transfR'></span>

<h3>Description</h3>

<p>Estimate the unit hydrograph from a sample of hydraulic lengths and a streamflow velocity.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>uh(hl, ...)

## Default S3 method:
uh(hl, uc, deltat, ...)

## S3 method for class 'units'
uh(hl, uc, deltat, ...)

## S3 method for class 'stars'
uh(hl, ...)

## S3 method for class 'transfR'
uh(hl, verbose = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="uh_+3A_hl">hl</code></td>
<td>
<p>hydraulic length of class <code>stars</code>, <code>matrix</code>, <code>vector</code> or <code>transfR</code>.
If no unit is provided, <code>hl</code> is assumed to be in [m].</p>
</td></tr>
<tr><td><code id="uh_+3A_...">...</code></td>
<td>
<p>further arguments passed to or from other methods</p>
</td></tr>
<tr><td><code id="uh_+3A_uc">uc</code></td>
<td>
<p>streamflow velocity. If no unit is provided, <code>uc</code> is assumed to be in [m/s].</p>
</td></tr>
<tr><td><code id="uh_+3A_deltat">deltat</code></td>
<td>
<p>time step of the time series. If no unit is provided, <code>deltat</code> is assumed to be in [min].</p>
</td></tr>
<tr><td><code id="uh_+3A_verbose">verbose</code></td>
<td>
<p>boolean indicating if information messages should be written to the console</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function estimates the unit hydrograph from geomorphometric information.
A travel time to the outlet is estimated by assuming an average streamflow velocity (<code>uc</code>)
within the river network and  by applying <code>uc</code> over the sample of hydraulic lengths (<code>hl</code>).
The unit hydrograph is the probability distribution of this travel time to the outlet
given at each time step (<code>deltat</code>).
</p>


<h3>Value</h3>

<p>A data.frame with vectors of class units, or if <code>hl</code> is a transfR object,
the same transfR object incremented by the &quot;uh&quot; attribute.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(Oudon)
uh1 &lt;- uh(hl=Oudon$hl[[1]], uc=units::set_units(0.5,"m/s"),
deltat=units::set_units(1,"h"))
plot(units::set_units(uh1$max_time,"h"), cumsum(uh1$prob), type = "b",
xlab = "Travel~time", ylab = "Probability~of~non-exceedance")

object &lt;- as_transfr(st = Oudon$obs, hl = Oudon$hl)
object &lt;- velocity(object)
object &lt;- uh(object)
plot(object, i = 1, attribute = c("uh"))
</code></pre>

<hr>
<h2 id='velocity'>Streamflow velocity estimation</h2><span id='topic+velocity'></span><span id='topic+velocity.default'></span><span id='topic+velocity.units'></span><span id='topic+velocity.stars'></span><span id='topic+velocity.transfR'></span>

<h3>Description</h3>

<p>Estimate streamflow velocity in average over the catchment.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>velocity(hl, ...)

## Default S3 method:
velocity(hl, lagtime, method = "loire2016", ...)

## S3 method for class 'units'
velocity(hl, lagtime = NULL, method = "loire2016", ...)

## S3 method for class 'stars'
velocity(hl, ...)

## S3 method for class 'transfR'
velocity(hl, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="velocity_+3A_hl">hl</code></td>
<td>
<p>hydraulic length of class <code>stars</code>, <code>matrix</code>, <code>vector</code> or <code>transfR</code>.
If no unit is provided, <code>hl</code> is assumed to be in [m].</p>
</td></tr>
<tr><td><code id="velocity_+3A_...">...</code></td>
<td>
<p>further arguments passed to or from other methods</p>
</td></tr>
<tr><td><code id="velocity_+3A_lagtime">lagtime</code></td>
<td>
<p>lag time of the catchment. If no unit is provided, <code>lagtime</code> is assumed to be in [h].</p>
</td></tr>
<tr><td><code id="velocity_+3A_method">method</code></td>
<td>
<p>character string describing the method to estimate the velocity. One of &quot;loire2016&quot; (default), &quot;brittany2013&quot;
or &quot;lagtime&quot; (see details).</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Estimate the average streamflow velocity of the catchment from three different
approaches. Method &quot;lagtime&quot; estimates the velocity from the ratio between the mean
hydraulic length and the lag time of the catchment. Method &quot;loire2016&quot; estimates the
velocity from a regression based on hydraulic length only:
</p>
<p style="text-align: center;"><code class="reqn">a \cdot hl^b</code>
</p>

<p>where <code class="reqn">a=4.38e-4</code> and <code class="reqn">b=0.69</code> have been calibrated over the Loire river basin (de Lavenne et al. 2016).
Method &quot;brittany2013&quot; used a similar regression calibrated for the French Brittany region where <code class="reqn">a=8.59e-4</code>
and <code class="reqn">b=0.61</code> (de Lavenne 2013).
</p>


<h3>Value</h3>

<p>A numeric value of class units, or if <code>hl</code> is a transfR object,
the same transfR object incremented by the &quot;uc&quot; attribute.
</p>


<h3>References</h3>

<p>de Lavenne A (2013).
<em>Modélisation hydrologique à base géomorphologique de bassins versants non jaugés par régionalisation et transposition d'hydrogramme</em>.
Ph.D. thesis, Agrocampus-Ouest Rennes.
<a href="https://hal.inrae.fr/tel-02810356">https://hal.inrae.fr/tel-02810356</a>.
</p>
<p>de Lavenne A, Skøien JO, Cudennec C, Curie F, Moatar F (2016).
&ldquo;Transferring measured discharge time series: Large-scale comparison of Top-kriging to geomorphology-based inverse modeling.&rdquo;
<em>Water Resources Research</em>, <b>52</b>(7), 5555&ndash;5576.
<a href="https://doi.org/10.1002/2016WR018716">doi:10.1002/2016WR018716</a>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(Oudon)
velocity(Oudon$hl[[1]], method = "loire2016")

object &lt;- as_transfr(st = Oudon$obs, hl = Oudon$hl)
object &lt;- velocity(object)
object$uc
</code></pre>

<hr>
<h2 id='weightr'>Weights of donor catchments</h2><span id='topic+weightr'></span>

<h3>Description</h3>

<p>Estimate the weighting applied at each time step and to each gauged catchment (donors) for the calculation
of the average net rainfall of an ungauged catchment
</p>


<h3>Usage</h3>

<pre><code class='language-R'>weightr(Rn, distances, ndonors = 5, donors, power = 1, flexible_donor = TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="weightr_+3A_rn">Rn</code></td>
<td>
<p>net rainfall matrix of donor catchments (rows for time index, and columns for donors index)</p>
</td></tr>
<tr><td><code id="weightr_+3A_distances">distances</code></td>
<td>
<p>vector of the distances to each donor catchment (see <a href="#topic+hdist">hdist</a>)</p>
</td></tr>
<tr><td><code id="weightr_+3A_ndonors">ndonors</code></td>
<td>
<p>maximum number of donor catchments to use</p>
</td></tr>
<tr><td><code id="weightr_+3A_donors">donors</code></td>
<td>
<p>vector of catchments id from which donors are selected. If empty, the <code>ndonors</code> closest
catchments are used</p>
</td></tr>
<tr><td><code id="weightr_+3A_power">power</code></td>
<td>
<p>exponent applied in the inverse distance weighting function (see details)</p>
</td></tr>
<tr><td><code id="weightr_+3A_flexible_donor">flexible_donor</code></td>
<td>
<p>boolean indicating if the donor catchments can change during the simulation period
according to the availability of discharge observations (see details)</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function returns a matrix of weights for each time steps (rows) and each gauged catchments
(columns) for the calculation of the average net rainfall of an ungauged catchment (see <a href="#topic+mixr">mixr</a>).
The weights <code class="reqn">\lambda</code> are estimated by an inverse distance weighting function (de Lavenne et al. 2016):
</p>
<p style="text-align: center;"><code class="reqn">\lambda_i=\frac{1}{d_i^p}</code>
</p>

<p style="text-align: center;"><code class="reqn">\Sigma_{i=1}^{ndonors}\lambda_i=1</code>
</p>

<p>where <code class="reqn">d</code> is the <code>distances</code> argument and <code class="reqn">p</code> is the <code>power</code> argument. The weights are rescaled
so the sum is equal to 1.
</p>
<p>Two strategies to handle missing data in the <code>Rn</code> matrix are possible.
If <code>flexible_donor</code> is TRUE, donors catchments are redefined at each time steps, and are chosen among
the ones that are effectively gauged at this given time step. This aims to keep a constant number of donor
catchments throughout the simulation period.
If <code>flexible_donor</code> is FALSE, the donor catchments are chosen once within all the gauged catchments,
regardless of missing data and remain the same throughout the entire simulation period. This stability of
donor catchments might however leads to a reduced number of donors (below <code>ndonors</code>) during periods
of missing data.
</p>


<h3>Value</h3>

<p>A matrix with the same dimensions as <code>Rn</code>.
</p>


<h3>References</h3>

<p>de Lavenne A, Skøien JO, Cudennec C, Curie F, Moatar F (2016).
&ldquo;Transferring measured discharge time series: Large-scale comparison of Top-kriging to geomorphology-based inverse modeling.&rdquo;
<em>Water Resources Research</em>, <b>52</b>(7), 5555&ndash;5576.
<a href="https://doi.org/10.1002/2016WR018716">doi:10.1002/2016WR018716</a>.
</p>


<h3>See Also</h3>

<p><a href="#topic+hdist">hdist</a>, <a href="#topic+mixr">mixr</a>
</p>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
