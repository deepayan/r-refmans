<!DOCTYPE html><html lang="en"><head><title>Help for package airGRdatassim</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {airGRdatassim}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#airGRdatassim'><p>Ensemble-Based Data Assimilation with GR Hydrological Models</p></a></li>
<li><a href='#CreateInputsPert'><p>Generation of ensemble model inputs for data assimilation</p></a></li>
<li><a href='#RunModel_DA'><p>Run discharge simulations with ensemble-based data assimilation</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Ensemble-Based Data Assimilation with GR Hydrological Models</td>
</tr>
<tr>
<td>Version:</td>
<td>0.1.3</td>
</tr>
<tr>
<td>Date:</td>
<td>2021-02-08</td>
</tr>
<tr>
<td>Depends:</td>
<td>airGR (&ge; 1.6.9.27)</td>
</tr>
<tr>
<td>Imports:</td>
<td>graphics, grDevices, stats, utils</td>
</tr>
<tr>
<td>Suggests:</td>
<td>knitr, rmarkdown</td>
</tr>
<tr>
<td>Description:</td>
<td>Add-on to the 'airGR' package which provides the tools to assimilate observed discharges in daily GR hydrological models. The package consists in two functions allowing to perform the assimilation of observed discharges via the Ensemble Kalman filter or the Particle filter as described in Piazzi et al. (2021) &lt;<a href="https://doi.org/10.1029%2F2020WR028390">doi:10.1029/2020WR028390</a>&gt;.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://gitlab.irstea.fr/HYCAR-Hydro/airgrdatassim/-/issues">https://gitlab.irstea.fr/HYCAR-Hydro/airgrdatassim/-/issues</a></td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2021-02-08 13:20:56 UTC; irstea</td>
</tr>
<tr>
<td>Author:</td>
<td>Gaia Piazzi <a href="https://orcid.org/0000-0002-4167-0794"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [aut],
  Olivier Delaigue <a href="https://orcid.org/0000-0002-7668-8468"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre],
  Guillaume Thirel <a href="https://orcid.org/0000-0002-1444-1830"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [ctb],
  Maxime Logez <a href="https://orcid.org/0000-0001-9843-0495"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [ctb]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Olivier Delaigue &lt;airGR@inrae.fr&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2021-02-11 15:30:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='airGRdatassim'>Ensemble-Based Data Assimilation with GR Hydrological Models</h2><span id='topic+airGRdatassim'></span>

<h3>Description</h3>

<p>Add-on to the 'airGR' package which provides the tools to assimilate observed discharges in daily GR hydrological models. The package consists in two functions allowing to perform the assimilation of observed discharges via the Ensemble Kalman filter or the Particle filter as described in Piazzi et al. (2021) &lt;doi:10.1029/2020WR028390&gt;. airGRdatassim currently runs on daily hydrological models (GR4J, GR5J and GR6J, with and without the CemaNeige snow model). The package is developed at INRAE-Antony (<a href="https://webgr.inrae.fr/en/home/">Catchment Hydrology research group</a> of the HYCAR Research Unit, France). More information about the efficiency of these data assimilation schemes with GR5J can be found in Piazzi et al. (accepted). <br /><br />
</p>
<p>## &mdash; Functions and objects
</p>
<p>The airGRdatassim package allows users of GR hydrological models to assimilate discharge observations with the aim of improving streamflow simulations.
The package has been designed to allow the choice between two sequential ensemble-based data assimilation (DA) techniques, namely the Ensemble Kalman filter (EnKF) and the Particle filter (PF). <br />
The functions are coded in R and both their names and arguments are consistent with the airGR package. <br />
</p>
<p>With the aim of providing a user-friendly package, airGRdatassim relies on two main functions: <br />
- <code><a href="#topic+CreateInputsPert">CreateInputsPert</a></code> generates the probabilistic model inputs to perform ensemble-based DA when accounting for the uncertainty in meteorological forcings; <br />
- <code><a href="#topic+RunModel_DA">RunModel_DA</a></code> performs streamflow ensemble simulations with the assimilation of observed discharges through the EnKF or the PF schemes. <br /> <br />
</p>
<p>Consistently with the airGR package, both structure and class of function arguments are specifically defined to prevent from mis-use and to ensure the flexibility of functions. Advanced users wishing to apply the package to their own models will need to comply with these imposed structures and refer to the package source codes to get all the specification requirements. <br /><br />
</p>
<p>## &mdash; Models
</p>
<p>DA schemes are designed to be coupled with GR daily hydrological models, which are implemented in the airGR package. These models can be called within the airGRdatassim package using the following airGR functions (use the command '?airGR' to get the references of the GR models): <br />
- <code><a href="airGR.html#topic+RunModel_GR4J">RunModel_GR4J</a></code>: four-parameter daily lumped hydrological model <br />
- <code><a href="airGR.html#topic+RunModel_GR5J">RunModel_GR5J</a></code>: five-parameter daily lumped hydrological model <br />
- <code><a href="airGR.html#topic+RunModel_GR6J">RunModel_GR6J</a></code>: six-parameter daily lumped hydrological model  <br />
- <code><a href="airGR.html#topic+RunModel_CemaNeigeGR4J">RunModel_CemaNeigeGR4J</a></code>: combined use of GR4J and CemaNeige    <br />
- <code><a href="airGR.html#topic+RunModel_CemaNeigeGR5J">RunModel_CemaNeigeGR5J</a></code>: combined use of GR5J and CemaNeige    <br />
- <code><a href="airGR.html#topic+RunModel_CemaNeigeGR6J">RunModel_CemaNeigeGR6J</a></code>: combined use of GR6J and CemaNeige    <br /><br />
</p>
<p>## &mdash; How to get started
</p>
<p>Because airGRdatassim is an airGR-based package, specific airGR functions should be jointly used to ensure the proper use of the airGRdatassim tools. Indeed, before performing the DA-based streamflow simulations, the hydrological model needs to be calibrated through the airGR calibration function. Therefore, the following steps are recommended: <br />
</p>
<p>1. refer to the help for <code><a href="airGR.html#topic+Calibration_Michel">Calibration_Michel</a></code> in the airGR package, run the provided example and then refer to the help for <code>CreateCalibOptions</code> to understand how a model calibration is prepared/made; <br />
2. refer to the help for <code><a href="#topic+CreateInputsPert">CreateInputsPert</a></code> to understand how the probabilistic model inputs are generated, if the uncertainty in meteorological forcings is taken into account; <br />
3. refer to the help for <code><a href="#topic+RunModel_DA">RunModel_DA</a></code> to understand how to perform the DA-based streamflow simulations; <br />
4. refer to the help for <code><a href="airGR.html#topic+ErrorCrit_NSE">ErrorCrit_NSE</a></code> and <code><a href="airGR.html#topic+CreateInputsCrit">CreateInputsCrit</a></code> in the airGR package to understand how the computation of an error criterion is prepared/made. <br />
</p>
<p>For more information and to get started with the package, you can refer to the vignette: <br />
<code>vignette("get_started", package = "airGRdatassim")</code>. <br /><br />
</p>
<p>## &mdash; References
</p>
<p>- Piazzi, G., Thirel, G., Perrin, C. and Delaigue, O. (accepted). Sequential data assimilation for streamflow forecasting: assessing the sensitivity to uncertainties and updated variables of a conceptual hydrological model. Water Resources Research, doi: <a href="https://doi.org/10.1029/2020WR028390">10.1029/2020WR028390</a>.
</p>

<hr>
<h2 id='CreateInputsPert'>Generation of ensemble model inputs for data assimilation</h2><span id='topic+CreateInputsPert'></span><span id='topic++5B.InputsPert'></span><span id='topic+plot.InputsPert'></span>

<h3>Description</h3>

<p>Function which perturbs the model inputs to generate probabilistic meteorological forcings required to perform ensemble-based data assimilation.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>CreateInputsPert(FUN_MOD, DatesR, Precip = NULL,
                 PotEvap = NULL, TempMean = NULL,
                 ZInputs = NULL, HypsoData = NULL, NLayers = 5,
                 NbMbr = 50, Seed = NULL)

## S3 method for class 'InputsPert'
x[i]

## S3 method for class 'InputsPert'
plot(x, which = "all", main = NULL,
     ColPrecip = "royalblue", ColPotEvap = "green3",
     ask = prod(par("mfcol")) &lt; length(which) &amp;&amp; dev.interactive(), ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="CreateInputsPert_+3A_fun_mod">FUN_MOD</code></td>
<td>
<p>[function] hydrological model function (e.g. <code><a href="airGR.html#topic+RunModel_GR5J">RunModel_GR5J</a></code>, <code><a href="airGR.html#topic+RunModel_CemaNeigeGR5J">RunModel_CemaNeigeGR5J</a></code>)</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_datesr">DatesR</code></td>
<td>
<p>[POSIXct] vector of dates</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_precip">Precip</code></td>
<td>
<p>(optional) [numeric] time series of total precipitation to perturb [mm/d]</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_potevap">PotEvap</code></td>
<td>
<p>(optional) [numeric] time series of potential evapotranspiration to perturb [mm/d]</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_tempmean">TempMean</code></td>
<td>
<p>(optional) [numeric] time series of mean air temperature [Â°C] (not perturbed), required to create the CemaNeige module inputs</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_zinputs">ZInputs</code></td>
<td>
<p>(optional) [numeric] real giving the mean elevation of the Precip and Temp series (before extrapolation) [m], possibly used to create the CemaNeige module inputs</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_hypsodata">HypsoData</code></td>
<td>
<p>(optional) [numeric] vector of 101 reals: min, q01 to q99 and max of catchment elevation distribution [m], if not defined a single elevation is used for CemaNeige</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_nlayers">NLayers</code></td>
<td>
<p>(optional) [numeric] integer giving the number of elevation layers requested [-], required to create CemaNeige module inputs, default=5</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_nbmbr">NbMbr</code></td>
<td>
<p>(optional) [numeric] number of ensemble members (minimum of 20 recommanded for the EnKF scheme and of 30 for the PF scheme)</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_seed">Seed</code></td>
<td>
<p>(optional) [numeric] seed of random number generator</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_x">x</code></td>
<td>
<p>[InputsPert] containing the vector of dates (<em>POSIXt</em>) and the time series of numeric values list perturbed</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_i">i</code></td>
<td>
<p>[integer] of the indices to subset a time series or [character] names of the elements to extract</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_which">which</code></td>
<td>
<p>(optional) [character] choice of plots (e.g. <code>"Precip"</code> or <code>"PotEvap"</code>, default = <code>"all"</code>)</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_main">main</code></td>
<td>
<p>(optional) [character] an overall title for the plot (see <code><a href="graphics.html#topic+title">title</a></code>)</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_colprecip">ColPrecip</code>, <code id="CreateInputsPert_+3A_colpotevap">ColPotEvap</code></td>
<td>
<p>(optional) [character] color to be used for perturbed precipitation and perturbed potential evapotransipration (in any format that <code><a href="grDevices.html#topic+col2rgb">col2rgb</a></code> accepts)</p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_ask">ask</code></td>
<td>
<p>(optional) [logical] if <code>TRUE</code>, the user is asked before each plot, see <code><a href="graphics.html#topic+par">par</a>(ask = .)</code></p>
</td></tr>
<tr><td><code id="CreateInputsPert_+3A_...">...</code></td>
<td>
<p>other parameters to be passed through to plotting functions</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function generates an ensemble of precipitation or/and potential evapotranspiration time series, from data provided as function argument/s. The mean air temperature required to create CemaNeige inputs is not perturbed.
<br /><br />
Probabilistic forcing/s is/are generated by stochastically perturbing the meteorological variable/s through a multiplicative stochastic noise, according to the methodology proposed by Clark et al. (2008).
<br /><br />
The random perturbations are provided through a first-order autoregressive model relying on a fractional error parameter equal to 0.65 and a temporal decorrelation length of 1 day for rainfall and 2 days for potential evapotranspiration.
<br /><br />
In order to ensure reproducible results, <em>Seed</em> can be set to fix the randomness in the generation of perturbations.
<br /><br />
For further details, see the references section.
<br /><br />
Nota: The function can be applied when using GR4J, GR5J and GR6J models (i.e. daily model time step), with or withouth the CemaNeige module.
</p>
<p>On the graphical outputs: <br />
- solid line: medians of the input values <br />
- polygon: minima and maxima of the input values <br />
</p>


<h3>Value</h3>

<p><em>InputsPert</em>[list] object of class <em>InputsModel</em> containing the ensembles of perturbed model inputs required to perform data assimilation:
</p>

<table>
<tr>
 <td style="text-align: left;">
     <em>$DatesR </em> </td><td style="text-align: left;"> [POSIXlt] vector of dates
                          </td>
</tr>
<tr>
 <td style="text-align: left;"></td>
</tr>
<tr>
 <td style="text-align: left;">
     <em>$Precip </em> </td><td style="text-align: left;"> [numeric] matrix (dim(NbTime, NbMbr)) of ensemblist time series of perturbed total precipitation [mm/d] (with NbTime the length of the period; generated only if the precipitation time series is provided as a function argument)
                          </td>
</tr>
<tr>
 <td style="text-align: left;"></td>
</tr>
<tr>
 <td style="text-align: left;">
     <em>$PotEvap</em> </td><td style="text-align: left;"> [numeric] matrix (dim(NbTime, NbMbr)) of ensemblist time series of perturbed potential evapotranspiration [mm/d] (generated only if the time series of potential evapotranspiration is provided as a function argument)
                          </td>
</tr>
<tr>
 <td style="text-align: left;"></td>
</tr>
<tr>
 <td style="text-align: left;">
     <em>$NbMbr  </em> </td><td style="text-align: left;"> [integer] atomic vector of number of ensemble members
  </td>
</tr>

</table>



<h3>Author(s)</h3>

<p>Gaia Piazzi, Olivier Delaigue
</p>


<h3>References</h3>

<p>- Clark, M. P., Rupp, D. E., Woods, R. A., Zheng, X., Ibbitt, R. P., Slater, A. G. et al. (2008). Hydrological data assimilation with the ensemble Kalman filter: Use of streamflow observations to update states in a distributed hydrological model. Advances in Water Resources, 31(10), 1309-1324, doi: <a href="https://doi.org/10.1016/j.advwatres.2008.06.005">10.1016/j.advwatres.2008.06.005</a>
<br /><br />
- Piazzi, G., Thirel, G., Perrin, C. and Delaigue, O. (accepted). Sequential data assimilation for streamflow forecasting: assessing the sensitivity to uncertainties and updated variables of a conceptual hydrological model. Water Resources Research, doi: <a href="https://doi.org/10.1029/2020WR028390">10.1029/2020WR028390</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+RunModel_DA">RunModel_DA</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>library(airGRdatassim)

## loading catchment data
data(L0123001, package = "airGR")

## preparation of the InputsModel object
InputsModel &lt;- CreateInputsModel(FUN_MOD = RunModel_GR5J, DatesR = BasinObs$DatesR,
                                 Precip = BasinObs$P, PotEvap = BasinObs$E)

## run period selection
IndRun &lt;- seq(which(format(BasinObs$DatesR, format = "%Y-%m-%d")=="2006-01-01"),
              which(format(BasinObs$DatesR, format = "%Y-%m-%d")=="2006-01-31"))

## preparation of perturbed meteorological ensemble
InputsPert &lt;- CreateInputsPert(FUN_MOD = RunModel_GR5J,
                               DatesR = BasinObs$DatesR,
                               Precip = BasinObs$P,
                               PotEvap = BasinObs$E,
                               NbMbr = 100L)
str(InputsPert)

## results preview
oldpar &lt;- par(mfrow = c(2, 1))
plot(InputsPert)
par(oldpar)

## results preview on a subset on one perturbed variable
oldpar &lt;- par(mfrow = c(1, 1))
plot(InputsPert[IndRun], which = "PotEvap")
par(oldpar)
</code></pre>

<hr>
<h2 id='RunModel_DA'>Run discharge simulations with ensemble-based data assimilation</h2><span id='topic+RunModel_DA'></span><span id='topic++5B.OutputsModelDA'></span><span id='topic+plot.OutputsModelDA'></span>

<h3>Description</h3>

<p>Function which performs discharge ensemble simulations with the assimilation of observed discharges through the Ensemble Kalman filter (EnKF) or the Particle filter (PF) schemes. More information about the efficiency of these data assimilation schemes with GR4J can be found in Piazzi et al. (accepted).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>RunModel_DA(InputsModel, InputsPert = NULL, Qobs = NULL,
            IndRun,
            FUN_MOD, Param,
            DaMethod = c("EnKF", "PF", "none"), NbMbr = NULL,
            StateEnKF = NULL, StatePert = NULL,
            Seed = NULL)

## S3 method for class 'OutputsModelDA'
x[i]

## S3 method for class 'OutputsModelDA'
plot(x, Qobs = NULL, main = NULL,
     ColSim = "orangered", ColObs = par("fg"), ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="RunModel_DA_+3A_inputsmodel">InputsModel</code></td>
<td>
<p>[list] object of class <em>InputsModel</em> containing the data required to run the model  (see <code><a href="airGR.html#topic+CreateInputsModel">CreateInputsModel</a></code> for details)</p>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_inputspert">InputsPert</code></td>
<td>
<p>(optional) [list] object of class <em>InputsModel</em> containing the ensembles of perturbed data required to evaluate the model probabilistic outputs, if the uncertainty in meteorological forcings is taken into account. The variables data proposed in <em>InputsPert</em> will erase the variables data given in <em>InputsModel</em></p>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_qobs">Qobs</code></td>
<td>
<p>(optional) [numeric] time series of observed flow [mm/d]</p>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_indrun">IndRun</code></td>
<td>
<p>[numeric] index of period to be used for the model run [-]</p>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_fun_mod">FUN_MOD</code></td>
<td>
<p>[function] daily hydrological model functions (GR4J, GR5J or GR6J; e.g. <code><a href="airGR.html#topic+RunModel_GR5J">RunModel_GR5J</a></code>, <code><a href="airGR.html#topic+RunModel_CemaNeigeGR5J">RunModel_CemaNeigeGR5J</a></code>)</p>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_param">Param</code></td>
<td>
<p>[numeric] vector of model parameters (number of parameters depends on the used hydrological model, from 4 parameters in GR4J up to 10 parameters in GR6J with CemaNeige)</p>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_damethod">DaMethod</code></td>
<td>
<p>[character] name of the data assimilation technique:
</p>

<table>
<tr>
 <td style="text-align: left;">
    "EnKF" </td><td style="text-align: left;"> discharge assimilation via Ensemble Kalman filter                   </td>
</tr>
<tr>
 <td style="text-align: left;">
    "PF"   </td><td style="text-align: left;"> discharge assimilation via Particle filter                          </td>
</tr>
<tr>
 <td style="text-align: left;">
    "none" </td><td style="text-align: left;"> discharge assimilation is not performed (i.e. open-loop simulation) </td>
</tr>
<tr>
 <td style="text-align: left;">
  </td>
</tr>

</table>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_nbmbr">NbMbr</code></td>
<td>
<p>(optional) [numeric] number of ensemble members (minimum of 20 recommanded for the EnKF scheme and of 30 for the PF scheme; by default=<code>NULL</code>: 50 if <em>InputsPert</em> is not set or <em>InputsPert$NbMbr</em> otherwise)</p>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_stateenkf">StateEnKF</code></td>
<td>
<p>[character] vector of the names of state variables to be updated via EnKF:
</p>

<table>
<tr>
 <td style="text-align: left;">
    "Prod" </td><td style="text-align: left;"> level of the production store [mm]                             </td>
</tr>
<tr>
 <td style="text-align: left;">
    "Rout" </td><td style="text-align: left;"> level of the routing store [mm]                                </td>
</tr>
<tr>
 <td style="text-align: left;">
    "UH1"  </td><td style="text-align: left;"> unit hydrograph 1 levels [mm] (not defined for the GR5J model) </td>
</tr>
<tr>
 <td style="text-align: left;">
    "UH2"  </td><td style="text-align: left;"> unit hydrograph 2 levels [mm]
  </td>
</tr>

</table>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_statepert">StatePert</code></td>
<td>
<p>[character] vector of the names of state variables to be perturbed via EnKF or PF:
</p>

<table>
<tr>
 <td style="text-align: left;">
    "Prod" </td><td style="text-align: left;"> level of the production store [mm]                             </td>
</tr>
<tr>
 <td style="text-align: left;">
    "Rout" </td><td style="text-align: left;"> level of the routing store [mm]                                </td>
</tr>
<tr>
 <td style="text-align: left;">
    "UH1   </td><td style="text-align: left;"> unit hydrograph 1 levels [mm] (not defined for the GR5J model) </td>
</tr>
<tr>
 <td style="text-align: left;">
    "UH2"  </td><td style="text-align: left;"> unit hydrograph 2 levels [mm]
  </td>
</tr>

</table>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_seed">Seed</code></td>
<td>
<p>(optional) [numeric] seed of random number generator</p>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_x">x</code></td>
<td>
<p>[OutputsModelDA] containing the vector of dates (<em>POSIXt</em>) and the time series of numeric values DA model outputs</p>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_i">i</code></td>
<td>
<p>[integer] of the indices to subset a time series or [character] names of the elements to extract</p>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_main">main</code></td>
<td>
<p>(optional) [character] an overall title for the plot (see <code><a href="graphics.html#topic+title">title</a></code>)</p>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_colsim">ColSim</code>, <code id="RunModel_DA_+3A_colobs">ColObs</code></td>
<td>
<p>(optional) [character] color to be used for simulated flow and observed flow (in any format that <code><a href="grDevices.html#topic+col2rgb">col2rgb</a></code> accepts)</p>
</td></tr>
<tr><td><code id="RunModel_DA_+3A_...">...</code></td>
<td>
<p>other parameters to be passed through to plotting functions</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Discharge observations are sequentially assimilated at each time step (if <em>DaMethod</em> != &quot;none&quot;) via the EnKF or PF schemes. Because of the sequential approach, the analysis states resulting from the assimilation procedure at time step <em>t</em> are used as initial states at the following prediction time step <em>t + 1</em>.
<br /><br />
When accounting for the uncertainty in model inputs (see <em>InputsPert</em>), the ensemble discharge simulations are driven by perfect meteorological forecasts, which are generated according to the methodology proposed by Clark et al. (2008) (see <code><a href="#topic+CreateInputsPert">CreateInputsPert</a></code> for details).
<br /><br />
It is possible to enable/disable the update of specific state variables via EnKF by defining/not defining their names in <em>StateEnKF</em>. Please note that <em>StateEnKF</em> is therefore required only when using the EnKF.
<br /><br />
Both the PF and EnKF can account for uncertainty in model states by perturbing the state variables specified in <em>StatePert</em> (Salamon and Feyen, 2009). It is noteworthy that, when using the EnKF, the perturbation is allowed only for the state variables included in <em>StateEnKF</em>. If the state uncertainty is taken into account, the initial states at the prediction time step <em>t + 1</em> are the perturbed analysis states resulting from the assimilation and perturbation procedures at time step <em>t</em>.
<br /><br />
In order to ensure reproducible results, <em>Seed</em> can be set to fix the randomness in the generation of perturbations.
<br /><br />
For further details and guidelines on the choice of the DA technique, see the references section.
<br /><br />
Nota: The function can be applied when using GR4J, GR5J and GR6J models (i.e. daily model time step), with or withouth the CemaNeige module (see <code><a href="airGR.html#topic+airGR">airGR</a></code> package).
</p>


<h3>Value</h3>

<p>[list] runModel_DA function provides a list containing the outputs organised as follows:
</p>

<table>
<tr>
 <td style="text-align: left;">
    <em>$DatesR     </em> </td><td style="text-align: left;"> [POSIXlt] series of dates (length of IndRun)
            </td>
</tr>
<tr>
 <td style="text-align: left;">
            </td>
</tr>
<tr>
 <td style="text-align: left;">
    <em>$QsimEns    </em> </td><td style="text-align: left;"> [numeric] matrix (dim(NbTime, NbMbr)) of ensemble discharge simulations
            </td>
</tr>
<tr>
 <td style="text-align: left;">
            </td>
</tr>
<tr>
 <td style="text-align: left;">
    <em>$EnsStateBkg</em> </td><td style="text-align: left;"> [numeric] array (dim(NbTime, NbMbr, Nstate)) of ensemble values of background model states (before the filter update)
            </td>
</tr>
<tr>
 <td style="text-align: left;">
            </td>
</tr>
<tr>
 <td style="text-align: left;">
    <em>$EnsStateA  </em> </td><td style="text-align: left;"> [numeric] array (dim(NbTime, NbMbr, Nstate)) of ensemble values of analysis model states (after the filter update)
            </td>
</tr>
<tr>
 <td style="text-align: left;">
            </td>
</tr>
<tr>
 <td style="text-align: left;">
    <em>$NbTime     </em> </td><td style="text-align: left;"> [integer] atomic vector of length of IndRun
            </td>
</tr>
<tr>
 <td style="text-align: left;">
            </td>
</tr>
<tr>
 <td style="text-align: left;">
    <em>$NbMbr      </em> </td><td style="text-align: left;"> [integer] atomic vector of number of ensemble members
            </td>
</tr>
<tr>
 <td style="text-align: left;">
            </td>
</tr>
<tr>
 <td style="text-align: left;">
    <em>$NbState    </em> </td><td style="text-align: left;"> [integer] atomic vector of number of of model states
         </td>
</tr>

</table>

<p>On the graphical outputs: <br />
- solid line: medians of the input values <br />
- polygon: minima and maxima of the input values <br />
</p>


<h3>Author(s)</h3>

<p>Gaia Piazzi, Olivier Delaigue
</p>


<h3>References</h3>

<p>- Clark, M. P., Rupp, D. E., Woods, R. A., Zheng, X., Ibbitt, R. P., Slater, A. G. et al. (2008). Hydrological data assimilation with the ensemble Kalman filter: Use of streamflow observations to update states in a distributed hydrological model. Advances in Water Resources, 31(10), 1309-1324, doi: <a href="https://doi.org/10.1016/j.advwatres.2008.06.005">10.1016/j.advwatres.2008.06.005</a>
<br /><br />
- Piazzi, G., Thirel, G., Perrin, C. and Delaigue, O. (accepted). Sequential data assimilation for streamflow forecasting: assessing the sensitivity to uncertainties and updated variables of a conceptual hydrological model. Water Resources Research, doi: <a href="https://doi.org/10.1029/2020WR028390">10.1029/2020WR028390</a>.
<br /><br />
- Salamon, P. and Feyen, L. (2009). Assessing parameter, precipitation, and predictive uncertainty in a distributed hydrological model using sequential data assimilation with the particle filter. Journal of Hydrology, 376(3-4), 428-442, doi: <a href="https://doi.org/10.1016/j.jhydrol.2009.07.051">10.1016/j.jhydrol.2009.07.051</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+CreateInputsPert">CreateInputsPert</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>library(airGRdatassim)

## loading catchment data
data(L0123001, package = "airGR")
Param &lt;- c(X1 = 194.243, X2 = -0.088, X3 = 117.740, X4 = 1.680, X5 = 0.000)

## run period selection
IndRun &lt;- seq(which(format(BasinObs$DatesR, format = "%Y-%m-%d")=="2006-01-01"),
              which(format(BasinObs$DatesR, format = "%Y-%m-%d")=="2006-01-31"))

## preparation of the InputsModel object
InputsModel &lt;- CreateInputsModel(FUN_MOD = RunModel_GR5J, DatesR = BasinObs$DatesR,
                                 Precip = BasinObs$P, PotEvap = BasinObs$E)

## number of ensemble members
## minimum of 20 recommanded for the EnKF scheme
## minimum of 30 recommanded for the PF scheme
NbMbr &lt;- 20L

## preparation of perturbed meteorological ensemble
InputsPert &lt;- CreateInputsPert(FUN_MOD = RunModel_GR5J,
                               DatesR = BasinObs$DatesR,
                               Precip = BasinObs$P, PotEvap = BasinObs$E,
                               NbMbr = NbMbr)

## simulation with DA via EnKF
OutputsModelDA &lt;- RunModel_DA(InputsModel = InputsModel,
                              InputsPert = InputsPert,
                              Qobs = BasinObs$Qmm,
                              IndRun = IndRun,
                              FUN_MOD = RunModel_GR5J, Param = Param,
                              DaMethod = "EnKF", NbMbr = NbMbr,
                              StateEnKF = c("Prod", "Rout"),
                              StatePert = c("Prod", "Rout"))

## results preview
plot(OutputsModelDA, Qobs = BasinObs$Qmm[IndRun])

## results preview on a subset
plot(OutputsModelDA[1:10], Qobs = BasinObs$Qmm[IndRun][1:10])
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
