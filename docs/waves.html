<!DOCTYPE html><html><head><title>Help for package waves</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {waves}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#aggregate_spectra'><p>Aggregate data based on grouping variables and a user-provided</p>
function</a></li>
<li><a href='#filter_spectra'><p>Filter spectral data frame based on Mahalanobis distance</p></a></li>
<li><a href='#format_cv'><p>Format multiple trials with or without overlapping genotypes into</p>
training and test sets according to user-provided cross validation scheme</a></li>
<li><a href='#get_mode'><p>Internal utility functions</p></a></li>
<li><a href='#ikeogu.2017'><p>Example vis-NIRS and reference dataset</p></a></li>
<li><a href='#plot_spectra'><p>Plot spectral data, highlighting outliers as identified using</p>
Mahalanobis distance</a></li>
<li><a href='#predict_spectra'><p>Use provided model object to predict trait values with input dataset</p></a></li>
<li><a href='#pretreat_spectra'><p>Pretreat spectral data according to user-designated method</p></a></li>
<li><a href='#rename'><p>Functions renamed in waves 0.2.0</p></a></li>
<li><a href='#save_model'><p>Save spectral prediction model and model performance statistics</p></a></li>
<li><a href='#test_spectra'><p>Test the performance of spectral models</p></a></li>
<li><a href='#train_spectra'><p>Train a model based predict reference values with spectral data</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Title:</td>
<td>Vis-NIR Spectral Analysis Wrapper</td>
</tr>
<tr>
<td>Version:</td>
<td>0.2.5</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Jenna Hershberger &lt;jmh579@cornell.edu&gt;</td>
</tr>
<tr>
<td>Description:</td>
<td>Originally designed application in the context of
    resource-limited plant research and breeding programs, 'waves'
    provides an open-source solution to spectral data processing and model
    development by bringing useful packages together into a streamlined
    pipeline.  This package is wrapper for functions related to the
    analysis of point visible and near-infrared reflectance measurements.
    It includes visualization, filtering, aggregation, preprocessing,
    cross-validation set formation, model training, and prediction
    functions to enable open-source association of spectral and reference
    data. This package is documented in a peer-reviewed manuscript in the
    Plant Phenome Journal &lt;<a href="https://doi.org/10.1002%2Fppj2.20012">doi:10.1002/ppj2.20012</a>&gt;.  Specialized
    cross-validation schemes are described in detail in Jarquín et al.
    (2017) &lt;<a href="https://doi.org/10.3835%2Fplantgenome2016.12.0130">doi:10.3835/plantgenome2016.12.0130</a>&gt;. Example data is from
    Ikeogu et al. (2017) &lt;<a href="https://doi.org/10.1371%2Fjournal.pone.0188918">doi:10.1371/journal.pone.0188918</a>&gt;.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file LICENSE</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://github.com/GoreLab/waves">https://github.com/GoreLab/waves</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/GoreLab/waves/issues">https://github.com/GoreLab/waves/issues</a></td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 3.5)</td>
</tr>
<tr>
<td>Imports:</td>
<td>caret, dplyr, ggplot2, lifecycle, magrittr, pls, prospectr,
randomForest, readr, rlang, scales, spectacles, stringr,
tibble, tidyr (&ge; 1.0), tidyselect</td>
</tr>
<tr>
<td>Suggests:</td>
<td>testthat (&ge; 2.1.0), knitr, rmarkdown</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>LazyData:</td>
<td>true</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.2.3</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr, rmarkdown</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2023-12-12 16:39:18 UTC; Jenna</td>
</tr>
<tr>
<td>Author:</td>
<td>Jenna Hershberger <a href="https://orcid.org/0000-0002-3147-6867"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre],
  Michael Gore [ths],
  NSF BREAD IOS-1543958 [fnd]</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2023-12-12 18:00:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='aggregate_spectra'>Aggregate data based on grouping variables and a user-provided
function</h2><span id='topic+aggregate_spectra'></span>

<h3>Description</h3>

<p>Use grouping variables to collapse spectral <code>data.frame</code> by
mean or median. Recommended for use after <code><a href="#topic+filter_spectra">filter_spectra</a></code>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aggregate_spectra(df, grouping.colnames, reference.value.colname,
  agg.function)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="aggregate_spectra_+3A_df">df</code></td>
<td>
<p><code>data.frame</code> object containing one or multiple columns of
grouping variables (must be consistent within each group), column of
reference values (optional), and columns of spectra. Spectral column names
must start with &quot;X&quot;.</p>
</td></tr>
<tr><td><code id="aggregate_spectra_+3A_grouping.colnames">grouping.colnames</code></td>
<td>
<p>Names of columns to be used as grouping variables.
Minimum 2 variables required. Default is c(&quot;trial&quot;, &quot;plot&quot;).</p>
</td></tr>
<tr><td><code id="aggregate_spectra_+3A_reference.value.colname">reference.value.colname</code></td>
<td>
<p>Name of reference column to be aggregated
along with spectra. Default is &quot;reference&quot;</p>
</td></tr>
<tr><td><code id="aggregate_spectra_+3A_agg.function">agg.function</code></td>
<td>
<p>Name of function (string format) to be used for sample
aggregation. Must be either &quot;mean&quot; or &quot;median&quot;. Default is &quot;mean&quot;.</p>
</td></tr>
</table>


<h3>Value</h3>

<p><code>data.frame</code> object <code>df</code> aggregated based on grouping
column by <code>agg.function</code>
</p>


<h3>Author(s)</h3>

<p>Jenna Hershberger <a href="mailto:jmh579@cornell.edu">jmh579@cornell.edu</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>library(magrittr)
aggregated.test &lt;- ikeogu.2017 %&gt;%
  dplyr::select(-TCC) %&gt;%
  na.omit() %&gt;%
  aggregate_spectra(
    grouping.colnames = c("study.name"),
    reference.value.colname = "DMC.oven",
    agg.function = "mean"
  )
aggregated.test[1:5, 1:5]
</code></pre>

<hr>
<h2 id='filter_spectra'>Filter spectral data frame based on Mahalanobis distance</h2><span id='topic+filter_spectra'></span>

<h3>Description</h3>

<p>Determine Mahalanobis distances of observations (rows) within a
given <code>data.frame</code> with spectral data. Option to filter out
observations based on these distances.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>filter_spectra(df, filter, return.distances, num.col.before.spectra,
  window.size, verbose)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="filter_spectra_+3A_df">df</code></td>
<td>
<p><code>data.frame</code> object containing columns of spectra and rows of
observations. Spectral columns must be labeled with an &quot;X&quot; and then the
wavelength (example: &quot;X740&quot; = 740nm). Left-most column must be unique ID.
May also contain columns of metadata between the unique ID and spectral
columns. Cannot contain any missing values. Metadata column names may not
start with &quot;X&quot;.</p>
</td></tr>
<tr><td><code id="filter_spectra_+3A_filter">filter</code></td>
<td>
<p>boolean that determines whether or not the input
<code>data.frame</code> will be filtered. If <code>TRUE</code>, <code>df</code> will be
filtered according to squared Mahalanobis distance with a 95% cutoff from
a chi-square distribution with degrees of freedom = number of spectral
columns. If <code>FALSE</code>, a column of squared Mahalanobis distances
<code>h.distance</code> will be added to the right side of df and all rows will
be returned. Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="filter_spectra_+3A_return.distances">return.distances</code></td>
<td>
<p>boolean that determines whether a column of squared
Mahalanobis distances will be included in output <code>data.frame</code>. If
<code>TRUE</code>, a column of Mahalanobis distances for each row will be added
to the right side of <code>df</code>. Default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="filter_spectra_+3A_num.col.before.spectra">num.col.before.spectra</code></td>
<td>
<p>number of columns to the left of the spectral
matrix in <code>df</code>. Default is 4.</p>
</td></tr>
<tr><td><code id="filter_spectra_+3A_window.size">window.size</code></td>
<td>
<p>number defining the size of window to use when calculating
the covariance of the spectra (required to calculate Mahalanobis distance).
Default is 10.</p>
</td></tr>
<tr><td><code id="filter_spectra_+3A_verbose">verbose</code></td>
<td>
<p>If <code>TRUE</code>, the number of rows removed through filtering
will be printed to the console. Default is <code>TRUE</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function uses a chi-square distribution with 95% cutoff where
degrees of freedom = number of wavelengths (columns) in the input
<code>data.frame</code>.
</p>


<h3>Value</h3>

<p>If <code>filter</code> is <code>TRUE</code>, returns filtered data frame
<code>df</code> and reports the number of rows removed. The Mahalanobis distance
with a cutoff of 95% of chi-square distribution (degrees of freedom =
number of wavelengths) is used as filtering criteria. If <code>filter</code> is
<code>FALSE</code>, returns full input df with column <code>h.distances</code>
containing the Mahalanobis distance for each row.
</p>


<h3>Author(s)</h3>

<p>Jenna Hershberger <a href="mailto:jmh579@cornell.edu">jmh579@cornell.edu</a>
</p>


<h3>References</h3>

<p>Johnson, R.A., and D.W. Wichern. 2007. Applied Multivariate
Statistical Analysis (6th Edition). pg 189
</p>


<h3>Examples</h3>

<pre><code class='language-R'>library(magrittr)
filtered.test &lt;- ikeogu.2017 %&gt;%
  dplyr::select(-TCC) %&gt;%
  na.omit() %&gt;%
  filter_spectra(
    df = .,
    filter = TRUE,
    return.distances = TRUE,
    num.col.before.spectra = 5,
    window.size = 15
  )
filtered.test[1:5, c(1:5, (ncol(filtered.test) - 5):ncol(filtered.test))]
</code></pre>

<hr>
<h2 id='format_cv'>Format multiple trials with or without overlapping genotypes into
training and test sets according to user-provided cross validation scheme</h2><span id='topic+format_cv'></span>

<h3>Description</h3>

<p>Standalone function that is also used within
<code><a href="#topic+train_spectra">train_spectra</a></code> to divide trials or studies into training and
test sets based on overlap in trial environments and genotype entries
</p>


<h3>Usage</h3>

<pre><code class='language-R'>format_cv(
  trial1,
  trial2,
  trial3 = NULL,
  cv.scheme,
  stratified.sampling = TRUE,
  proportion.train = 0.7,
  seed = NULL,
  remove.genotype = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="format_cv_+3A_trial1">trial1</code></td>
<td>
<p><code>data.frame</code> object that is for use only when
<code>cv.scheme</code> is provided. Contains the trial to be tested in subsequent
model training functions. The first column contains unique identifiers,
second contains genotypes, third contains reference values, followed by
spectral columns. Include no other columns to right of spectra! Column
names of spectra must start with &quot;X&quot;, reference column must be named
&quot;reference&quot;, and genotype column must be named &quot;genotype&quot;.</p>
</td></tr>
<tr><td><code id="format_cv_+3A_trial2">trial2</code></td>
<td>
<p><code>data.frame</code> object that is for use only when
<code>cv.scheme</code> is provided. This data.frame contains a trial that has
overlapping genotypes with <code>trial1</code> but that were grown in a different
site/year (different environment). Formatting must be consistent with
<code>trial1</code>.</p>
</td></tr>
<tr><td><code id="format_cv_+3A_trial3">trial3</code></td>
<td>
<p><code>data.frame</code> object that is for use only when
<code>cv.scheme</code> is provided. This data.frame contains a trial that may or
may not contain genotypes that overlap with <code>trial1</code>. Formatting must
be consistent with <code>trial1</code>.</p>
</td></tr>
<tr><td><code id="format_cv_+3A_cv.scheme">cv.scheme</code></td>
<td>
<p>A cross validation (CV) scheme from Jarquín et al., 2017.
Options for <code>cv.scheme</code> include:
</p>

<ul>
<li><p> &quot;CV1&quot;: untested lines in tested environments
</p>
</li>
<li><p> &quot;CV2&quot;: tested lines in tested environments
</p>
</li>
<li><p> &quot;CV0&quot;: tested lines in untested environments
</p>
</li>
<li><p> &quot;CV00&quot;: untested lines in untested environments
</p>
</li></ul>
</td></tr>
<tr><td><code id="format_cv_+3A_stratified.sampling">stratified.sampling</code></td>
<td>
<p>If <code>TRUE</code>, training and test
sets will be selected using stratified random sampling. Default is
<code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="format_cv_+3A_proportion.train">proportion.train</code></td>
<td>
<p>Fraction of samples to include in the training set.
Default is 0.7.</p>
</td></tr>
<tr><td><code id="format_cv_+3A_seed">seed</code></td>
<td>
<p>Number used in the function <code>set.seed()</code> for reproducible
randomization. If <code>NULL</code>, no seed is set. Default is <code>NULL</code>.</p>
</td></tr>
<tr><td><code id="format_cv_+3A_remove.genotype">remove.genotype</code></td>
<td>
<p>boolean that, if <code>TRUE</code>, removes the &quot;genotype&quot;
column is removed from the output <code>data.frame</code>. Default is
<code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Use of a cross-validation scheme requires a column in the input
<code>data.frame</code> named &quot;genotype&quot; to ensure proper sorting of training and
test sets. Variables <code>trial1</code> and <code>trial2</code> are required, while
<code>trial 3</code> is optional.
</p>


<h3>Value</h3>

<p>List of data.frames ($train.set, $test.set) compiled according to
user-provided cross validation scheme.
</p>


<h3>Author(s)</h3>

<p>Jenna Hershberger <a href="mailto:jmh579@cornell.edu">jmh579@cornell.edu</a>
</p>


<h3>References</h3>

<p>Jarquín, D., C. Lemes da Silva, R. C. Gaynor, J. Poland, A.
Fritz, R. Howard, S. Battenfield, and J. Crossa. 2017. Increasing
genomic-enabled prediction accuracy by modeling genotype × environment
interactions in Kansas wheat. Plant Genome 10(2):1-15.
&lt;doi:10.3835/plantgenome2016.12.0130&gt;
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Must have a column called "genotype", so we'll create a fake one for now
# We will use CV00, which does not require any overlap in genotypes
# In real scenarios, CV schemes that rely on genotypes should not be applied
# when genotypes are unknown, as in this case.
library(magrittr)
trials &lt;- ikeogu.2017 %&gt;%
  dplyr::mutate(genotype = 1:nrow(ikeogu.2017)) %&gt;% # fake for this example
  dplyr::rename(reference = DMC.oven) %&gt;%
  dplyr::select(
    study.name, sample.id, genotype, reference,
    tidyselect::starts_with("X")
  )
trial1 &lt;- trials %&gt;%
  dplyr::filter(study.name == "C16Mcal") %&gt;%
  dplyr::select(-study.name)
trial2 &lt;- trials %&gt;%
  dplyr::filter(study.name == "C16Mval") %&gt;%
  dplyr::select(-study.name)
cv.list &lt;- format_cv(
  trial1 = trial1, trial2 = trial2, cv.scheme = "CV00",
  stratified.sampling = FALSE, remove.genotype = TRUE
)
cv.list$train.set[1:5, 1:5]
cv.list$test.set[1:5, 1:5]
</code></pre>

<hr>
<h2 id='get_mode'>Internal utility functions</h2><span id='topic+get_mode'></span>

<h3>Description</h3>

<p>Get the mode of a set of numbers. Used in getting summary of
results within [train_spectra()]
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_mode(vector.input)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="get_mode_+3A_vector.input">vector.input</code></td>
<td>
<p>The mode of this vector of numbers will be calculated
by this function</p>
</td></tr>
</table>


<h3>Value</h3>

<p>mode of the numbers in 'vector.input'
</p>

<hr>
<h2 id='ikeogu.2017'>Example vis-NIRS and reference dataset</h2><span id='topic+ikeogu.2017'></span>

<h3>Description</h3>

<p>The 'ikeogu.2017' data set contains raw vis-NIRS scans, total
carotenoid content, and cassava root dry matter content (using the oven
method) from the 2017 PLOS One paper by Ikeogu et al. This dataset contains
a subset of the original scans and reference values from the supplementary
files of the paper.
'ikeogu.2017' is a 'data.frame' that contains the following columns:
</p>

<ul>
<li><p> study.name = Name of the study as described in Ikeogu et al. (2017).
</p>
</li>
<li><p> sample.id = Unique identifier for each individual root sample
</p>
</li>
<li><p> DMC.oven = Cassava root dry matter content, the percentage of dry
weight relative to fresh weight of a sample after oven drying.
</p>
</li>
<li><p> TCC = Total carotenoid content (<code class="reqn">\mu g/g</code>, unknown whether on a
fresh or dry weight basis) as measured by
high performance liquid chromatography
</p>
</li>
<li><p> X350:X2500 = spectral reflectance measured with the QualitySpec Trek:
S-10016 vis-NIR spectrometer.
Each cell represents the mean of 150 scans on a single root at a single wavelength.
</p>
</li></ul>



<h3>Usage</h3>

<pre><code class='language-R'>ikeogu.2017
</code></pre>


<h3>Format</h3>

<p>An object of class <code>tbl_df</code> (inherits from <code>tbl</code>, <code>data.frame</code>) with 175 rows and 2155 columns.
</p>


<h3>Author(s)</h3>

<p>Original authors: Ikeogu, U.N., F. Davrieux, D. Dufour, H. Ceballos,
C.N. Egesi, and J. Jannink. Reformatted by Jenna Hershberger.
</p>


<h3>References</h3>

<p>Ikeogu, U.N., F. Davrieux, D. Dufour, H. Ceballos, C.N. Egesi, et
al. 2017. Rapid analyses of dry matter content and carotenoids in fresh
cassava roots using a portable visible and near infrared spectrometer
(Vis/NIRS). PLOS One 12(12): 1–17. doi: 10.1371/journal.pone.0188918.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>library(magrittr)
library(ggplot2)
data(ikeogu.2017)
ikeogu.2017[1:10, 1:10]
ikeogu.2017 %&gt;%
  dplyr::select(-starts_with("X")) %&gt;%
  dplyr::group_by(study.name) %&gt;%
  tidyr::gather(trait, value, c(DMC.oven:TCC), na.rm = TRUE) %&gt;%
  ggplot2::ggplot(aes(x = study.name, y = value, fill = study.name)) +
  facet_wrap(~trait, scales = "free_y", nrow = 2) +
  geom_boxplot()
</code></pre>

<hr>
<h2 id='plot_spectra'>Plot spectral data, highlighting outliers as identified using
Mahalanobis distance</h2><span id='topic+plot_spectra'></span>

<h3>Description</h3>

<p>Generates a <code><a href="ggplot2.html#topic+ggplot">ggplot</a></code> object of given
spectra, with wavelength on the x axis and given spectral values on the y.
Mahalanobis distance is used to calculate outliers, which are both
identified on the plot. Rows from the original dataframe are printed to the
console for each outlier that is identified.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>plot_spectra(
  df,
  num.col.before.spectra = 1,
  window.size = 10,
  detect.outliers = TRUE,
  color = NULL,
  alternate.title = NULL,
  verbose = TRUE,
  wavelengths = deprecated()
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="plot_spectra_+3A_df">df</code></td>
<td>
<p><code>data.frame</code> object containing columns of spectra.
Spectral columns must be labeled with an &quot;X&quot; and then the wavelength
(example: &quot;X740&quot; = 740nm). Left-most column must be unique ID. May also
contain columns of metadata between the unique ID and spectral columns.
Cannot contain any missing values. Metadata column names may not start
with &quot;X&quot;.</p>
</td></tr>
<tr><td><code id="plot_spectra_+3A_num.col.before.spectra">num.col.before.spectra</code></td>
<td>
<p>Number of columns to the left of the spectral
matrix (including unique ID). Default is 1.</p>
</td></tr>
<tr><td><code id="plot_spectra_+3A_window.size">window.size</code></td>
<td>
<p>number defining the size of window to use when calculating
the covariance of the spectra (required to calculate Mahalanobis distance).
Default is 10.</p>
</td></tr>
<tr><td><code id="plot_spectra_+3A_detect.outliers">detect.outliers</code></td>
<td>
<p>Boolean indicating whether spectra should be filtered
before plotting. If <code>TRUE</code>, outliers are indicated by color in the
resulting plot. If <code>verbose</code> is also set to <code>TRUE</code>, outlier
metadata will be printed to the console. Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="plot_spectra_+3A_color">color</code></td>
<td>
<p>String or vector of strings indicating colors to be passed to
<code><a href="ggplot2.html#topic+ggplot">ggplot</a></code>. Default is default
<code><a href="ggplot2.html#topic+ggplot">ggplot</a></code> colors.</p>
</td></tr>
<tr><td><code id="plot_spectra_+3A_alternate.title">alternate.title</code></td>
<td>
<p>String to be used as plot title. If
<code>detect.outliers</code> is <code>TRUE</code>, a descriptive title will be supplied.
If <code>detect.outliers</code> is <code>FALSE</code>, default is no title will be used.</p>
</td></tr>
<tr><td><code id="plot_spectra_+3A_verbose">verbose</code></td>
<td>
<p>If <code>TRUE</code>, the number of rows removed through filtering
will be printed to the console. Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="plot_spectra_+3A_wavelengths">wavelengths</code></td>
<td>
<p>DEPRECATED <code>wavelengths</code> is no
longer supported; this information is now inferred from
<code>df</code> column names</p>
</td></tr>
</table>


<h3>Value</h3>

<p>If verbose, prints unique ID and metadata for rows identified as
outliers. Returns plot of spectral data with non-outliers in blue and
outliers in red. X-axis is wavelengths and y-axis is spectral values.
</p>


<h3>Author(s)</h3>

<p>Jenna Hershberger <a href="mailto:jmh579@cornell.edu">jmh579@cornell.edu</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
library(magrittr)
ikeogu.2017 %&gt;%
  dplyr::rename(unique.id = sample.id) %&gt;%
  dplyr::select(unique.id, dplyr::everything(), -TCC) %&gt;%
  na.omit() %&gt;%
  plot_spectra(
    df = .,
    num.col.before.spectra = 5,
    window.size = 15,
    detect.outliers = TRUE,
    color = NULL,
    alternate.title = NULL,
    verbose = TRUE
  )

</code></pre>

<hr>
<h2 id='predict_spectra'>Use provided model object to predict trait values with input dataset</h2><span id='topic+predict_spectra'></span>

<h3>Description</h3>

<p>Loads an existing model and cross-validation performance
statistics (created with <code><a href="#topic+save_model">save_model</a></code>) and makes predictions
based on new spectra.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>predict_spectra(
  input.data,
  model.stats.location,
  model.location,
  model.method = "pls",
  wavelengths = deprecated()
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="predict_spectra_+3A_input.data">input.data</code></td>
<td>
<p><code>data.frame</code> object of spectral data for input into a
spectral prediction model. First column contains unique identifiers
followed by spectral columns. Include no other columns to right of spectra!
Column names of spectra must start with &quot;X&quot;.</p>
</td></tr>
<tr><td><code id="predict_spectra_+3A_model.stats.location">model.stats.location</code></td>
<td>
<p>String containing file path (including file name)
to save location of &quot;(model.name)_stats.csv&quot; as output from the
<code><a href="#topic+save_model">save_model</a></code> function.</p>
</td></tr>
<tr><td><code id="predict_spectra_+3A_model.location">model.location</code></td>
<td>
<p>String containing file path (including file name) to
location where the trained model (&quot;(model.name).Rds&quot;) was saved as output
by the <code><a href="#topic+save_model">save_model</a></code> function.</p>
</td></tr>
<tr><td><code id="predict_spectra_+3A_model.method">model.method</code></td>
<td>
<p>Model type to use for training. Valid options include:
</p>
 <ul>
<li><p> &quot;pls&quot;: Partial least squares regression (Default) </p>
</li>
<li>
<p>&quot;rf&quot;: Random forest </p>
</li>
<li><p> &quot;svmLinear&quot;: Support vector machine with linear
kernel </p>
</li>
<li><p> &quot;svmRadial&quot;: Support vector machine with radial kernel </p>
</li></ul>
</td></tr>
<tr><td><code id="predict_spectra_+3A_wavelengths">wavelengths</code></td>
<td>
<p>DEPRECATED <code>wavelengths</code> is no
longer supported; this information is now inferred from <code>input.data</code>
column names</p>
</td></tr>
</table>


<h3>Value</h3>

<p><code>data.frame</code> object of predictions for each sample (row). First
column is unique identifier supplied by <code>input.data</code> and second is
predicted values
</p>


<h3>Author(s)</h3>

<p>Jenna Hershberger <a href="mailto:jmh579@cornell.edu">jmh579@cornell.edu</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
ikeogu.2017 %&gt;%
  dplyr::select(sample.id, dplyr::starts_with("X")) %&gt;%
  predict_spectra(
    input.data = .,
    model.stats.location = paste0(
      getwd(),
      "/my_model_stats.csv"
    ),
    model.location = paste0(getwd(), "/my_model.Rds")
  )

## End(Not run)

</code></pre>

<hr>
<h2 id='pretreat_spectra'>Pretreat spectral data according to user-designated method</h2><span id='topic+pretreat_spectra'></span>

<h3>Description</h3>

<p>Pretreatment, also known as preprocessing, is often used to
increase the signal to noise ratio in vis-NIR datasets. The <em>waves</em>
function <code>pretreat_spectra</code> applies common spectral pretreatment
methods such as standard normal variate and the Savitzky-Golay filter.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>pretreat_spectra(
  df,
  test.data = NULL,
  pretreatment = 1,
  preprocessing.method = deprecated(),
  wavelengths = deprecated()
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="pretreat_spectra_+3A_df">df</code></td>
<td>
<p><code>data.frame</code> object containing spectral data. First column(s)
(optional) include metadata (with or without reference value column)
followed by spectral columns. Spectral column names must be formatted as
&quot;X&quot; followed by wavelength Include no other columns to right of spectra! No
missing values permitted.</p>
</td></tr>
<tr><td><code id="pretreat_spectra_+3A_test.data">test.data</code></td>
<td>
<p><code>data.frame</code> object with same format as train.data.
Will be appended to <code>df</code> during pretreatment so that the same
transformations are applied to each row. Default is <code>NULL</code>.</p>
</td></tr>
<tr><td><code id="pretreat_spectra_+3A_pretreatment">pretreatment</code></td>
<td>
<p>Number or list of numbers 1:13 corresponding to
desired pretreatment method(s):
</p>

<ol>
<li><p> Raw data (default)
</p>
</li>
<li><p> Standard normal variate (SNV)
</p>
</li>
<li><p> SNV and first derivative
</p>
</li>
<li><p> SNV and second derivative
</p>
</li>
<li><p> First derivative
</p>
</li>
<li><p> Second derivative
</p>
</li>
<li><p> Savitzky–Golay filter (SG)
</p>
</li>
<li><p> SNV and SG
</p>
</li>
<li><p> Gap-segment derivative (window size = 11)
</p>
</li>
<li><p> SG and first derivative (window size = 5)
</p>
</li>
<li><p> SG and first derivative (window size = 11)
</p>
</li>
<li><p> SG and second derivative (window size = 5)
</p>
</li>
<li><p> SG and second derivative (window size = 11)
</p>
</li></ol>
</td></tr>
<tr><td><code id="pretreat_spectra_+3A_preprocessing.method">preprocessing.method</code></td>
<td>
<p>DEPRECATED <code>preprocessing.method</code>
has been renamed &quot;pretreatment&quot;</p>
</td></tr>
<tr><td><code id="pretreat_spectra_+3A_wavelengths">wavelengths</code></td>
<td>
<p>DEPRECATED <code>wavelengths</code> is no
longer supported; this information is now inferred from <code>df</code>
column names</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Pretreated <code>df</code>' (or list of <code>data.frame</code>s) with
reference column intact
</p>


<h3>Author(s)</h3>

<p>Jenna Hershberger <a href="mailto:jmh579@cornell.edu">jmh579@cornell.edu</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pretreat_spectra(df = ikeogu.2017, pretreatment = 3)[1:5, 1:5]
</code></pre>

<hr>
<h2 id='rename'>Functions renamed in waves 0.2.0</h2><span id='topic+AggregateSpectra'></span><span id='topic+DoPreprocessing'></span><span id='topic+FilterSpectra'></span><span id='topic+FormatCV'></span><span id='topic+PlotSpectra'></span><span id='topic+PredictFromSavedModel'></span><span id='topic+SaveModel'></span><span id='topic+TestModelPerformance'></span><span id='topic+TrainSpectralModel'></span>

<h3>Description</h3>

<p>&lsquo;r lifecycle::badge(&rsquo;deprecated')'
</p>
<p>waves 0.2.0 renamed a number of functions to ensure that every function
name adheres to the tidyverse style guide.
</p>
<p>* 'AggregateSpectra()' -&gt; 'aggregate_spectra()'
* 'DoPreprocessing()' -&gt; 'pretreat_spectra()'
* 'FilterSpectra()' -&gt; 'filter_spectra()'
* 'FormatCV()' -&gt; 'format_cv()'
* 'PlotSpectra()' -&gt; 'plot_spectra()'
* 'PredictFromSavedModel()' -&gt; 'predict_spectra()'
* 'SaveModel()' -&gt; 'save_model()'
* 'TestModelPerformance()' -&gt; 'test_spectra()'
* 'TrainSpectralModel()' -&gt; 'train_spectra()'
</p>


<h3>Usage</h3>

<pre><code class='language-R'>AggregateSpectra(
  df,
  grouping.colnames = c("unique.id"),
  reference.value.colname = "reference",
  agg.function = "mean"
)

DoPreprocessing(df, test.data = NULL, pretreatment = 1)

FilterSpectra(
  df,
  filter = TRUE,
  return.distances = FALSE,
  num.col.before.spectra = 4,
  window.size = 10,
  verbose = TRUE
)

FormatCV(
  trial1,
  trial2,
  trial3 = NULL,
  cv.scheme,
  stratified.sampling = TRUE,
  proportion.train = 0.7,
  seed = NULL,
  remove.genotype = FALSE
)

PlotSpectra(
  df,
  num.col.before.spectra = 1,
  window.size = 10,
  detect.outliers = TRUE,
  color = NULL,
  alternate.title = NULL,
  verbose = TRUE
)

PredictFromSavedModel(
  input.data,
  model.stats.location,
  model.location,
  model.method = "pls"
)

SaveModel(
  df,
  save.model = TRUE,
  pretreatment = 1,
  model.save.folder = NULL,
  model.name = "PredictionModel",
  best.model.metric = "RMSE",
  k.folds = 5,
  proportion.train = 0.7,
  tune.length = 50,
  model.method = "pls",
  num.iterations = 10,
  stratified.sampling = TRUE,
  cv.scheme = NULL,
  trial1 = NULL,
  trial2 = NULL,
  trial3 = NULL,
  verbose = TRUE
)

TestModelPerformance(
  train.data,
  num.iterations,
  test.data = NULL,
  pretreatment = 1,
  k.folds = 5,
  proportion.train = 0.7,
  tune.length = 50,
  model.method = "pls",
  best.model.metric = "RMSE",
  stratified.sampling = TRUE,
  cv.scheme = NULL,
  trial1 = NULL,
  trial2 = NULL,
  trial3 = NULL,
  split.test = FALSE,
  verbose = TRUE
)

TrainSpectralModel(
  df,
  num.iterations,
  test.data = NULL,
  k.folds = 5,
  proportion.train = 0.7,
  tune.length = 50,
  model.method = "pls",
  best.model.metric = "RMSE",
  stratified.sampling = TRUE,
  cv.scheme = NULL,
  trial1 = NULL,
  trial2 = NULL,
  trial3 = NULL,
  split.test = FALSE,
  verbose = TRUE
)
</code></pre>

<hr>
<h2 id='save_model'>Save spectral prediction model and model performance statistics</h2><span id='topic+save_model'></span>

<h3>Description</h3>

<p>Given a set of pretreatment methods, saves the best spectral
prediction model and model statistics to <code>model.save.folder</code> as
<code>model.name.Rds</code> and <code>model.name_stats.csv</code> respectively. If only
one pretreatment method is supplied, results from that method are stored.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>save_model(
  df,
  write.model = TRUE,
  pretreatment = 1,
  model.save.folder = NULL,
  model.name = "PredictionModel",
  best.model.metric = "RMSE",
  k.folds = 5,
  proportion.train = 0.7,
  tune.length = 50,
  model.method = "pls",
  num.iterations = 10,
  stratified.sampling = TRUE,
  cv.scheme = NULL,
  trial1 = NULL,
  trial2 = NULL,
  trial3 = NULL,
  seed = 1,
  verbose = TRUE,
  save.model = deprecated(),
  wavelengths = deprecated(),
  autoselect.preprocessing = deprecated(),
  preprocessing.method = deprecated()
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="save_model_+3A_df">df</code></td>
<td>
<p><code>data.frame</code> object. First column contains unique identifiers,
second contains reference values, followed by spectral columns. Include no
other columns to right of spectra! Column names of spectra must start with
&quot;X&quot; and reference column must be named &quot;reference&quot;</p>
</td></tr>
<tr><td><code id="save_model_+3A_write.model">write.model</code></td>
<td>
<p>If <code>TRUE</code>, the trained model will be saved in .Rds
format to the location specified by <code>model.save.folder</code>. If
<code>FALSE</code>, the best model will be output by the function but will not
save to a file. Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="save_model_+3A_pretreatment">pretreatment</code></td>
<td>
<p>Number or list of numbers 1:13 corresponding to
desired pretreatment method(s):
</p>

<ol>
<li><p> Raw data (default)
</p>
</li>
<li><p> Standard normal variate (SNV)
</p>
</li>
<li><p> SNV and first derivative
</p>
</li>
<li><p> SNV and second derivative
</p>
</li>
<li><p> First derivative
</p>
</li>
<li><p> Second derivative
</p>
</li>
<li><p> Savitzky–Golay filter (SG)
</p>
</li>
<li><p> SNV and SG
</p>
</li>
<li><p> Gap-segment derivative (window size = 11)
</p>
</li>
<li><p> SG and first derivative (window size = 5)
</p>
</li>
<li><p> SG and first derivative (window size = 11)
</p>
</li>
<li><p> SG and second derivative (window size = 5)
</p>
</li>
<li><p> SG and second derivative (window size = 11)
</p>
</li></ol>
</td></tr>
<tr><td><code id="save_model_+3A_model.save.folder">model.save.folder</code></td>
<td>
<p>Path to folder where model will be saved. If not
provided, will save to working directory.</p>
</td></tr>
<tr><td><code id="save_model_+3A_model.name">model.name</code></td>
<td>
<p>Name that model will be saved as in
<code>model.save.folder</code>. Default is &quot;PredictionModel&quot;.</p>
</td></tr>
<tr><td><code id="save_model_+3A_best.model.metric">best.model.metric</code></td>
<td>
<p>Metric used to decide which model is best. Must be
either &quot;RMSE&quot; or &quot;Rsquared&quot;</p>
</td></tr>
<tr><td><code id="save_model_+3A_k.folds">k.folds</code></td>
<td>
<p>Number indicating the number of folds for k-fold
cross-validation during model training. Default is 5.</p>
</td></tr>
<tr><td><code id="save_model_+3A_proportion.train">proportion.train</code></td>
<td>
<p>Fraction of samples to include in the training set.
Default is 0.7.</p>
</td></tr>
<tr><td><code id="save_model_+3A_tune.length">tune.length</code></td>
<td>
<p>Number delineating search space for tuning of the PLSR
hyperparameter <code>ncomp</code>. Must be set to 5 when using the random forest
algorithm (<code>model.method == rf</code>). Default is 50.</p>
</td></tr>
<tr><td><code id="save_model_+3A_model.method">model.method</code></td>
<td>
<p>Model type to use for training. Valid options include:
</p>
 <ul>
<li><p> &quot;pls&quot;: Partial least squares regression (Default) </p>
</li>
<li>
<p>&quot;rf&quot;: Random forest </p>
</li>
<li><p> &quot;svmLinear&quot;: Support vector machine with linear
kernel </p>
</li>
<li><p> &quot;svmRadial&quot;: Support vector machine with radial kernel </p>
</li></ul>
</td></tr>
<tr><td><code id="save_model_+3A_num.iterations">num.iterations</code></td>
<td>
<p>Number of training iterations to perform</p>
</td></tr>
<tr><td><code id="save_model_+3A_stratified.sampling">stratified.sampling</code></td>
<td>
<p>If <code>TRUE</code>, training and test sets will be
selected using stratified random sampling. This term is only used if
<code>test.data == NULL</code>. Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="save_model_+3A_cv.scheme">cv.scheme</code></td>
<td>
<p>A cross validation (CV) scheme from Jarquín et al., 2017.
Options for <code>cv.scheme</code> include:
</p>

<ul>
<li><p> &quot;CV1&quot;: untested lines in tested environments
</p>
</li>
<li><p> &quot;CV2&quot;: tested lines in tested environments
</p>
</li>
<li><p> &quot;CV0&quot;: tested lines in untested environments
</p>
</li>
<li><p> &quot;CV00&quot;: untested lines in untested environments
</p>
</li></ul>
</td></tr>
<tr><td><code id="save_model_+3A_trial1">trial1</code></td>
<td>
<p><code>data.frame</code> object that is for use only when
<code>cv.scheme</code> is provided. Contains the trial to be tested in subsequent
model training functions. The first column contains unique identifiers,
second contains genotypes, third contains reference values, followed by
spectral columns. Include no other columns to right of spectra! Column
names of spectra must start with &quot;X&quot;, reference column must be named
&quot;reference&quot;, and genotype column must be named &quot;genotype&quot;.</p>
</td></tr>
<tr><td><code id="save_model_+3A_trial2">trial2</code></td>
<td>
<p><code>data.frame</code> object that is for use only when
<code>cv.scheme</code> is provided. This data.frame contains a trial that has
overlapping genotypes with <code>trial1</code> but that were grown in a different
site/year (different environment). Formatting must be consistent with
<code>trial1</code>.</p>
</td></tr>
<tr><td><code id="save_model_+3A_trial3">trial3</code></td>
<td>
<p><code>data.frame</code> object that is for use only when
<code>cv.scheme</code> is provided. This data.frame contains a trial that may or
may not contain genotypes that overlap with <code>trial1</code>. Formatting must
be consistent with <code>trial1</code>.</p>
</td></tr>
<tr><td><code id="save_model_+3A_seed">seed</code></td>
<td>
<p>Integer to be used internally as input for <code>set.seed()</code>.
Only used if <code>stratified.sampling = TRUE</code>. In all other cases, seed
is set to the current iteration number. Default is 1.</p>
</td></tr>
<tr><td><code id="save_model_+3A_verbose">verbose</code></td>
<td>
<p>If <code>TRUE</code>, the number of rows removed through filtering
will be printed to the console. Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="save_model_+3A_save.model">save.model</code></td>
<td>
<p>DEPRECATED <code>save.model = FALSE</code> is no
longer supported; this function will always return a saved model.</p>
</td></tr>
<tr><td><code id="save_model_+3A_wavelengths">wavelengths</code></td>
<td>
<p>DEPRECATED <code>wavelengths</code> is no
longer supported; this information is now inferred from <code>df</code>
column names</p>
</td></tr>
<tr><td><code id="save_model_+3A_autoselect.preprocessing">autoselect.preprocessing</code></td>
<td>
<p>DEPRECATED
<code>autoselect.preprocessing = FALSE</code> is no longer supported. If
multiple pretreatment methods are supplied, the best will be automatically
selected as the model to be saved.</p>
</td></tr>
<tr><td><code id="save_model_+3A_preprocessing.method">preprocessing.method</code></td>
<td>
<p>DEPRECATED <code>preprocessing.method</code>
has been renamed &quot;pretreatment&quot;</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Wrapper that uses <code><a href="#topic+pretreat_spectra">pretreat_spectra</a></code>,
<code><a href="#topic+format_cv">format_cv</a></code>, and <code><a href="#topic+train_spectra">train_spectra</a></code> functions.
</p>


<h3>Value</h3>

<p>List of model stats (in <code>data.frame</code>) and trained model object.
If the parameter <code>write.model</code> is TRUE, both objects are saved to
<code>model.save.folder</code>. To use the optimally trained model for
predictions, use tuned parameters from <code>$bestTune</code>.
</p>


<h3>Author(s)</h3>

<p>Jenna Hershberger <a href="mailto:jmh579@cornell.edu">jmh579@cornell.edu</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
library(magrittr)
test.model &lt;- ikeogu.2017 %&gt;%
  dplyr::filter(study.name == "C16Mcal") %&gt;%
  dplyr::rename(reference = DMC.oven,
                unique.id = sample.id) %&gt;%
  dplyr::select(unique.id, reference, dplyr::starts_with("X")) %&gt;%
  na.omit() %&gt;%
  save_model(
    df = .,
    write.model = FALSE,
    pretreatment = 1:13,
    model.name = "my_prediction_model",
    tune.length = 3,
    num.iterations = 3
  )
summary(test.model$best.model)
test.model$best.model.stats

</code></pre>

<hr>
<h2 id='test_spectra'>Test the performance of spectral models</h2><span id='topic+test_spectra'></span>

<h3>Description</h3>

<p>Wrapper that trains models based spectral data to predict
reference values and reports model performance statistics
</p>


<h3>Usage</h3>

<pre><code class='language-R'>test_spectra(
  train.data,
  num.iterations,
  test.data = NULL,
  pretreatment = 1,
  k.folds = 5,
  proportion.train = 0.7,
  tune.length = 50,
  model.method = "pls",
  best.model.metric = "RMSE",
  stratified.sampling = TRUE,
  cv.scheme = NULL,
  trial1 = NULL,
  trial2 = NULL,
  trial3 = NULL,
  split.test = FALSE,
  seed = 1,
  verbose = TRUE,
  wavelengths = deprecated(),
  preprocessing = deprecated(),
  output.summary = deprecated(),
  rf.variable.importance = deprecated()
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="test_spectra_+3A_train.data">train.data</code></td>
<td>
<p><code>data.frame</code> object of spectral data for input into a
spectral prediction model. First column contains unique identifiers, second
contains reference values, followed by spectral columns. Include no other
columns to right of spectra! Column names of spectra must start with &quot;X&quot;
and reference column must be named &quot;reference&quot;.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_num.iterations">num.iterations</code></td>
<td>
<p>Number of training iterations to perform</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_test.data">test.data</code></td>
<td>
<p><code>data.frame</code> with same specifications as <code>df</code>. Use
if specific test set is desired for hyperparameter tuning. If <code>NULL</code>,
function will automatically train with a stratified sample of 70%. Default
is <code>NULL</code>.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_pretreatment">pretreatment</code></td>
<td>
<p>Number or list of numbers 1:13 corresponding to
desired pretreatment method(s):
</p>

<ol>
<li><p> Raw data (default)
</p>
</li>
<li><p> Standard normal variate (SNV)
</p>
</li>
<li><p> SNV and first derivative
</p>
</li>
<li><p> SNV and second derivative
</p>
</li>
<li><p> First derivative
</p>
</li>
<li><p> Second derivative
</p>
</li>
<li><p> Savitzky–Golay filter (SG)
</p>
</li>
<li><p> SNV and SG
</p>
</li>
<li><p> Gap-segment derivative (window size = 11)
</p>
</li>
<li><p> SG and first derivative (window size = 5)
</p>
</li>
<li><p> SG and first derivative (window size = 11)
</p>
</li>
<li><p> SG and second derivative (window size = 5)
</p>
</li>
<li><p> SG and second derivative (window size = 11)
</p>
</li></ol>
</td></tr>
<tr><td><code id="test_spectra_+3A_k.folds">k.folds</code></td>
<td>
<p>Number indicating the number of folds for k-fold
cross-validation during model training. Default is 5.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_proportion.train">proportion.train</code></td>
<td>
<p>Fraction of samples to include in the training set.
Default is 0.7.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_tune.length">tune.length</code></td>
<td>
<p>Number delineating search space for tuning of the PLSR
hyperparameter <code>ncomp</code>. Must be set to 5 when using the random forest
algorithm (<code>model.method == rf</code>). Default is 50.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_model.method">model.method</code></td>
<td>
<p>Model type to use for training. Valid options include:
</p>
 <ul>
<li><p> &quot;pls&quot;: Partial least squares regression (Default) </p>
</li>
<li>
<p>&quot;rf&quot;: Random forest </p>
</li>
<li><p> &quot;svmLinear&quot;: Support vector machine with linear
kernel </p>
</li>
<li><p> &quot;svmRadial&quot;: Support vector machine with radial kernel </p>
</li></ul>
</td></tr>
<tr><td><code id="test_spectra_+3A_best.model.metric">best.model.metric</code></td>
<td>
<p>Metric used to decide which model is best. Must be
either &quot;RMSE&quot; or &quot;Rsquared&quot;</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_stratified.sampling">stratified.sampling</code></td>
<td>
<p>If <code>TRUE</code>, training and test sets will be
selected using stratified random sampling. This term is only used if
<code>test.data == NULL</code>. Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_cv.scheme">cv.scheme</code></td>
<td>
<p>A cross validation (CV) scheme from Jarquín et al., 2017.
Options for <code>cv.scheme</code> include:
</p>

<ul>
<li><p> &quot;CV1&quot;: untested lines in tested environments
</p>
</li>
<li><p> &quot;CV2&quot;: tested lines in tested environments
</p>
</li>
<li><p> &quot;CV0&quot;: tested lines in untested environments
</p>
</li>
<li><p> &quot;CV00&quot;: untested lines in untested environments
</p>
</li></ul>
</td></tr>
<tr><td><code id="test_spectra_+3A_trial1">trial1</code></td>
<td>
<p><code>data.frame</code> object that is for use only when
<code>cv.scheme</code> is provided. Contains the trial to be tested in subsequent
model training functions. The first column contains unique identifiers,
second contains genotypes, third contains reference values, followed by
spectral columns. Include no other columns to right of spectra! Column
names of spectra must start with &quot;X&quot;, reference column must be named
&quot;reference&quot;, and genotype column must be named &quot;genotype&quot;.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_trial2">trial2</code></td>
<td>
<p><code>data.frame</code> object that is for use only when
<code>cv.scheme</code> is provided. This data.frame contains a trial that has
overlapping genotypes with <code>trial1</code> but that were grown in a different
site/year (different environment). Formatting must be consistent with
<code>trial1</code>.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_trial3">trial3</code></td>
<td>
<p><code>data.frame</code> object that is for use only when
<code>cv.scheme</code> is provided. This data.frame contains a trial that may or
may not contain genotypes that overlap with <code>trial1</code>. Formatting must
be consistent with <code>trial1</code>.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_split.test">split.test</code></td>
<td>
<p>boolean that allows for a fixed training set and a split
test set. Example// train model on data from two breeding programs and a
stratified subset (70%) of a third and test on the remaining samples
(30%)  of the third. If <code>FALSE</code>, the entire provided test set
<code>test.data</code> will remain as a testing set or if none is provided, 30%
of the provided <code>train.data</code> will be used for testing. Default is
<code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_seed">seed</code></td>
<td>
<p>Integer to be used internally as input for <code>set.seed()</code>.
Only used if <code>stratified.sampling = TRUE</code>. In all other cases, seed
is set to the current iteration number. Default is 1.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_verbose">verbose</code></td>
<td>
<p>If <code>TRUE</code>, the number of rows removed through filtering
will be printed to the console. Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_wavelengths">wavelengths</code></td>
<td>
<p>DEPRECATED <code>wavelengths</code> is no
longer supported; this information is now inferred from <code>df</code>
column names</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_preprocessing">preprocessing</code></td>
<td>
<p>DEPRECATED please use
<code>pretreatment</code> to specify the specific pretreatment(s) to test.
For behavior identical to that of <code>preprocessing = TRUE</code>, set
<code>pretreatment = 1:13</code>'.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_output.summary">output.summary</code></td>
<td>
<p>DEPRECATED <code>output.summary = FALSE</code>
is no longer supported; a summary of output is always returned alongside
the full performance statistics.</p>
</td></tr>
<tr><td><code id="test_spectra_+3A_rf.variable.importance">rf.variable.importance</code></td>
<td>
<p>DEPRECATED
<code>rf.variable.importance = FALSE</code> is no longer supported; variable
importance results are always returned if the <code>model.method</code> is
set to 'pls' or 'rf'.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Calls <code><a href="#topic+pretreat_spectra">pretreat_spectra</a></code>, <code><a href="#topic+format_cv">format_cv</a></code>,
and <code><a href="#topic+train_spectra">train_spectra</a></code> functions.
</p>


<h3>Value</h3>

<p><code>list</code> of 5 objects:
</p>

<ol>
<li><p> 'model.list' is a <code>list</code> of trained model objects, one for each
pretreatment method specified by the <code>pretreatment</code> argument.
Each model is trained with all rows of <code>df</code>.
</p>
</li>
<li><p> 'summary.model.performance' is a <code>data.frame</code> containing summary
statistics across all model training iterations and pretreatments.
See below for a description of the summary statistics provided.
</p>
</li>
<li><p> 'model.performance' is a <code>data.frame</code> containing performance
statistics for each iteration of model training separately (see below).
</p>
</li>
<li><p> 'predictions' is a <code>data.frame</code> containing both reference and
predicted values for each test set entry in each iteration of
model training.
</p>
</li>
<li><p> 'importance' is a <code>data.frame</code> containing variable importance
results for each wavelength at each iteration of model training.
If <code>model.method</code> is not &quot;pls&quot; or &quot;rf&quot;, this list item is <code>NULL</code>.
</p>
</li></ol>

<p>'summary.model.performance' and 'model.performance' <code>data.frames</code>
summary statistics include:
</p>

<ul>
<li><p> Tuned parameters depending on the model algorithm:
</p>

<ul>
<li> <p><strong>Best.n.comp</strong>, the best number of components
</p>
</li>
<li> <p><strong>Best.ntree</strong>, the best number of trees in an RF model
</p>
</li>
<li> <p><strong>Best.mtry</strong>, the best number of variables to include at
every decision point in an RF model
</p>
</li></ul>

</li>
<li> <p><strong>RMSECV</strong>, the root mean squared error of cross-validation
</p>
</li>
<li> <p><strong>R2cv</strong>, the coefficient of multiple determination of
cross-validation for PLSR models
</p>
</li>
<li> <p><strong>RMSEP</strong>, the root mean squared error of prediction
</p>
</li>
<li> <p><strong>R2p</strong>, the squared Pearson’s correlation between predicted and
observed test set values
</p>
</li>
<li> <p><strong>RPD</strong>, the ratio of standard deviation of observed test set
values to RMSEP
</p>
</li>
<li> <p><strong>RPIQ</strong>, the ratio of performance to interquartile difference
</p>
</li>
<li> <p><strong>CCC</strong>, the concordance correlation coefficient
</p>
</li>
<li> <p><strong>Bias</strong>, the average difference between the predicted and
observed values
</p>
</li>
<li> <p><strong>SEP</strong>, the standard error of prediction
</p>
</li>
<li> <p><strong>R2sp</strong>, the squared Spearman’s rank correlation between
predicted and observed test set values
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Jenna Hershberger <a href="mailto:jmh579@cornell.edu">jmh579@cornell.edu</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
library(magrittr)
ikeogu.2017 %&gt;%
  dplyr::rename(reference = DMC.oven,
                unique.id = sample.id) %&gt;%
  dplyr::select(unique.id, reference, dplyr::starts_with("X")) %&gt;%
  na.omit() %&gt;%
  test_spectra(
    train.data = .,
    tune.length = 3,
    num.iterations = 3,
    pretreatment = 1
  )

</code></pre>

<hr>
<h2 id='train_spectra'>Train a model based predict reference values with spectral data</h2><span id='topic+train_spectra'></span>

<h3>Description</h3>

<p>Trains spectral prediction models using one of several
algorithms and sampling procedures.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>train_spectra(
  df,
  num.iterations,
  test.data = NULL,
  k.folds = 5,
  proportion.train = 0.7,
  tune.length = 50,
  model.method = "pls",
  best.model.metric = "RMSE",
  stratified.sampling = TRUE,
  cv.scheme = NULL,
  trial1 = NULL,
  trial2 = NULL,
  trial3 = NULL,
  split.test = FALSE,
  seed = 1,
  verbose = TRUE,
  save.model = deprecated(),
  rf.variable.importance = deprecated(),
  output.summary = deprecated(),
  return.model = deprecated()
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="train_spectra_+3A_df">df</code></td>
<td>
<p><code>data.frame</code> object. First column contains unique identifiers,
second contains reference values, followed by spectral columns. Include no
other columns to right of spectra! Column names of spectra must start with
&quot;X&quot; and reference column must be named &quot;reference&quot;</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_num.iterations">num.iterations</code></td>
<td>
<p>Number of training iterations to perform</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_test.data">test.data</code></td>
<td>
<p><code>data.frame</code> with same specifications as <code>df</code>. Use
if specific test set is desired for hyperparameter tuning. If <code>NULL</code>,
function will automatically train with a stratified sample of 70%. Default
is <code>NULL</code>.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_k.folds">k.folds</code></td>
<td>
<p>Number indicating the number of folds for k-fold
cross-validation during model training. Default is 5.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_proportion.train">proportion.train</code></td>
<td>
<p>Fraction of samples to include in the training set.
Default is 0.7.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_tune.length">tune.length</code></td>
<td>
<p>Number delineating search space for tuning of the PLSR
hyperparameter <code>ncomp</code>. Must be set to 5 when using the random forest
algorithm (<code>model.method == rf</code>). Default is 50.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_model.method">model.method</code></td>
<td>
<p>Model type to use for training. Valid options include:
</p>
 <ul>
<li><p> &quot;pls&quot;: Partial least squares regression (Default) </p>
</li>
<li>
<p>&quot;rf&quot;: Random forest </p>
</li>
<li><p> &quot;svmLinear&quot;: Support vector machine with linear
kernel </p>
</li>
<li><p> &quot;svmRadial&quot;: Support vector machine with radial kernel </p>
</li></ul>
</td></tr>
<tr><td><code id="train_spectra_+3A_best.model.metric">best.model.metric</code></td>
<td>
<p>Metric used to decide which model is best. Must be
either &quot;RMSE&quot; or &quot;Rsquared&quot;</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_stratified.sampling">stratified.sampling</code></td>
<td>
<p>If <code>TRUE</code>, training and test sets will be
selected using stratified random sampling. This term is only used if
<code>test.data == NULL</code>. Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_cv.scheme">cv.scheme</code></td>
<td>
<p>A cross validation (CV) scheme from Jarquín et al., 2017.
Options for <code>cv.scheme</code> include:
</p>

<ul>
<li><p> &quot;CV1&quot;: untested lines in tested environments
</p>
</li>
<li><p> &quot;CV2&quot;: tested lines in tested environments
</p>
</li>
<li><p> &quot;CV0&quot;: tested lines in untested environments
</p>
</li>
<li><p> &quot;CV00&quot;: untested lines in untested environments
</p>
</li></ul>
</td></tr>
<tr><td><code id="train_spectra_+3A_trial1">trial1</code></td>
<td>
<p><code>data.frame</code> object that is for use only when
<code>cv.scheme</code> is provided. Contains the trial to be tested in subsequent
model training functions. The first column contains unique identifiers,
second contains genotypes, third contains reference values, followed by
spectral columns. Include no other columns to right of spectra! Column
names of spectra must start with &quot;X&quot;, reference column must be named
&quot;reference&quot;, and genotype column must be named &quot;genotype&quot;.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_trial2">trial2</code></td>
<td>
<p><code>data.frame</code> object that is for use only when
<code>cv.scheme</code> is provided. This data.frame contains a trial that has
overlapping genotypes with <code>trial1</code> but that were grown in a different
site/year (different environment). Formatting must be consistent with
<code>trial1</code>.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_trial3">trial3</code></td>
<td>
<p><code>data.frame</code> object that is for use only when
<code>cv.scheme</code> is provided. This data.frame contains a trial that may or
may not contain genotypes that overlap with <code>trial1</code>. Formatting must
be consistent with <code>trial1</code>.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_split.test">split.test</code></td>
<td>
<p>boolean that allows for a fixed training set and a split
test set. Example// train model on data from two breeding programs and a
stratified subset (70%) of a third and test on the remaining samples
(30%)  of the third. If <code>FALSE</code>, the entire provided test set
<code>test.data</code> will remain as a testing set or if none is provided, 30%
of the provided <code>train.data</code> will be used for testing. Default is
<code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_seed">seed</code></td>
<td>
<p>Integer to be used internally as input for <code>set.seed()</code>.
Only used if <code>stratified.sampling = TRUE</code>. In all other cases, seed
is set to the current iteration number. Default is 1.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_verbose">verbose</code></td>
<td>
<p>If <code>TRUE</code>, the number of rows removed through filtering
will be printed to the console. Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_save.model">save.model</code></td>
<td>
<p>DEPRECATED <code>save.model = FALSE</code> is no
longer supported; this function will always return a saved model.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_rf.variable.importance">rf.variable.importance</code></td>
<td>
<p>DEPRECATED
<code>rf.variable.importance = FALSE</code> is no longer supported; variable
importance results are always returned if the <code>model.method</code> is
set to 'pls' or 'rf'.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_output.summary">output.summary</code></td>
<td>
<p>DEPRECATED <code>output.summary = FALSE</code>
is no longer supported; a summary of output is always returned alongside
the full performance statistics.</p>
</td></tr>
<tr><td><code id="train_spectra_+3A_return.model">return.model</code></td>
<td>
<p>DEPRECATED <code>return.model = FALSE</code>
is no longer supported; a trained model object is always returned
alongside the full performance statistics and summary.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>list of the following:
</p>

<ol>
<li> <p><code>model</code> is a model object trained with all rows of <code>df</code>.
</p>
</li>
<li> <p><code>summary.model.performance</code> is a <code>data.frame</code> with model
performance statistics in summary format (2 rows, one with mean and one
with standard deviation of all training iterations).
</p>
</li>
<li> <p><code>full.model.performance</code> is a <code>data.frame</code> with model
performance statistics in long format
(number of rows = <code>num.iterations</code>)
</p>
</li>
<li> <p><code>predictions</code> is a <code>data.frame</code> containing predicted values
for each test set entry at each iteration of model training.
</p>
</li>
<li> <p><code>importance</code> is a <code>data.frame</code> that contains variable
importance for each wavelength. Only available for <code>model.method</code>
options &quot;rf&quot; and &quot;pls&quot;.
</p>
</li></ol>

<p>Included summary statistics:
</p>

<ul>
<li><p> Tuned parameters depending on the model algorithm:
</p>

<ul>
<li> <p><strong>Best.n.comp</strong>, the best number of components
</p>
</li>
<li> <p><strong>Best.ntree</strong>, the best number of trees in an RF model
</p>
</li>
<li> <p><strong>Best.mtry</strong>, the best number of variables to include at
every decision point in an RF model
</p>
</li></ul>

</li>
<li> <p><strong>RMSECV</strong>, the root mean squared error of cross-validation
</p>
</li>
<li> <p><strong>R2cv</strong>, the coefficient of multiple determination of
cross-validation for PLSR models
</p>
</li>
<li> <p><strong>RMSEP</strong>, the root mean squared error of prediction
</p>
</li>
<li> <p><strong>R2p</strong>, the squared Pearson’s correlation between predicted and
observed test set values
</p>
</li>
<li> <p><strong>RPD</strong>, the ratio of standard deviation of observed test set
values to RMSEP
</p>
</li>
<li> <p><strong>RPIQ</strong>, the ratio of performance to interquartile difference
</p>
</li>
<li> <p><strong>CCC</strong>, the concordance correlation coefficient
</p>
</li>
<li> <p><strong>Bias</strong>, the average difference between the predicted and
observed values
</p>
</li>
<li> <p><strong>SEP</strong>, the standard error of prediction
</p>
</li>
<li> <p><strong>R2sp</strong>, the squared Spearman’s rank correlation between
predicted and observed test set values
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Jenna Hershberger <a href="mailto:jmh579@cornell.edu">jmh579@cornell.edu</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
library(magrittr)
ikeogu.2017 %&gt;%
  dplyr::filter(study.name == "C16Mcal") %&gt;%
  dplyr::rename(reference = DMC.oven,
                unique.id = sample.id) %&gt;%
  dplyr::select(unique.id, reference, dplyr::starts_with("X")) %&gt;%
  na.omit() %&gt;%
  train_spectra(
    df = .,
    tune.length = 3,
    num.iterations = 3,
    best.model.metric = "RMSE",
    stratified.sampling = TRUE
  ) %&gt;%
  summary()

</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
