<!DOCTYPE html><html lang="en"><head><title>Help for package trtswitch</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {trtswitch}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#trtswitch-package'><p>Treatment Switching</p></a></li>
<li><a href='#aml'><p>Acute myelogenous leukemia survival data from the survival package</p></a></li>
<li><a href='#bscpp'><p>B-Spline Basis for Polynomial Splines</p></a></li>
<li><a href='#findInterval3'><p>Find Interval Numbers of Indices</p></a></li>
<li><a href='#heart'><p>Stanford heart transplant data from the survival package</p></a></li>
<li><a href='#immdef'><p>Simulated CONCORDE trial data from the rpsftm package</p></a></li>
<li><a href='#ingots'><p>The binary data from Cox and Snell (1989, pp. 10-11).</p></a></li>
<li><a href='#ipcw'><p>Inverse Probability of Censoring Weights (IPCW) Method</p>
for Treatment Switching</a></li>
<li><a href='#ipe'><p>Iterative Parameter Estimation (IPE) for Treatment Switching</p></a></li>
<li><a href='#kmdiff'><p>Estimate of Milestone Survival Difference</p></a></li>
<li><a href='#kmest'><p>Kaplan-Meier Estimates of Survival Curve</p></a></li>
<li><a href='#liferegr'><p>Parametric Regression Models for Failure Time Data</p></a></li>
<li><a href='#logisregr'><p>Logistic Regression Models for Binary Data</p></a></li>
<li><a href='#lrtest'><p>Log-Rank Test of Survival Curve Difference</p></a></li>
<li><a href='#nscpp'><p>Natural Cubic Spline Basis</p></a></li>
<li><a href='#phregr'><p>Proportional Hazards Regression Models</p></a></li>
<li><a href='#print.liferegr'><p>Print liferegr Object</p></a></li>
<li><a href='#print.logisregr'><p>Print logisregr Object</p></a></li>
<li><a href='#print.phregr'><p>Print phregr Object</p></a></li>
<li><a href='#qrcpp'><p>QR Decomposition of a Matrix</p></a></li>
<li><a href='#rawdata'><p>A simulated time-to-event data set with 10 replications</p></a></li>
<li><a href='#residuals_phregr'><p>Residuals for Proportional Hazards Regression Models</p></a></li>
<li><a href='#rmdiff'><p>Estimate of Restricted Mean Survival Time Difference</p></a></li>
<li><a href='#rmest'><p>Estimate of Restricted Mean Survival Time</p></a></li>
<li><a href='#rpsftm'><p>Rank Preserving Structural Failure Time Model (RPSFTM) for</p>
Treatment Switching</a></li>
<li><a href='#sexagg'><p>Urinary tract infection data from the logistf package</p></a></li>
<li><a href='#shilong'><p>The randomized clinical trial SHIVA data in long format from the</p>
ipcwswitch package</a></li>
<li><a href='#six'><p>The repeated measures data from the &quot;Six Cities&quot; study of the health</p>
effects of air pollution (Ware et al. 1984).</a></li>
<li><a href='#splineDesigncpp'><p>B-Spline Design Matrix</p></a></li>
<li><a href='#survfit_phregr'><p>Survival Curve for Proportional Hazards Regression Models</p></a></li>
<li><a href='#survsplit'><p>Split a survival data set at specified cut points</p></a></li>
<li><a href='#tobin'><p>Tobin's tobit data from the survival package</p></a></li>
<li><a href='#tsegest'><p>The Two-Stage Estimation (TSE) Method Using g-estimation</p>
for Treatment Switching</a></li>
<li><a href='#tsegestsim'><p>Simulate Survival Data for Two-Stage Estimation Method Using</p>
g-estimation</a></li>
<li><a href='#tsesimp'><p>The Simple Two-Stage Estimation (TSE) Method for Treatment</p>
Switching</a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Treatment Switching</td>
</tr>
<tr>
<td>Version:</td>
<td>0.1.4</td>
</tr>
<tr>
<td>Date:</td>
<td>2025-03-19</td>
</tr>
<tr>
<td>Description:</td>
<td>Implements rank-preserving structural failure time model (RPSFTM), iterative parameter estimation (IPE), inverse probability of censoring weights (IPCW), and two-stage estimation (TSE) methods for treatment switching in randomized clinical trials.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a> | <a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a> [expanded from: GPL (&ge; 2)]</td>
</tr>
<tr>
<td>Imports:</td>
<td>Rcpp (&ge; 1.0.9)</td>
</tr>
<tr>
<td>LinkingTo:</td>
<td>Rcpp</td>
</tr>
<tr>
<td>Suggests:</td>
<td>testthat (&ge; 3.0.0), dplyr (&ge; 1.1.4), survival (&ge; 3.5-7),
geepack (&ge; 1.3.12), ggplot2 (&ge; 3.3.6), knitr (&ge; 1.45),
rmarkdown (&ge; 2.25)</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.3.1</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>yes</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 2.10)</td>
</tr>
<tr>
<td>LazyData:</td>
<td>true</td>
</tr>
<tr>
<td>Config/testthat/edition:</td>
<td>3</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2025-03-20 02:23:35 UTC; kaife</td>
</tr>
<tr>
<td>Author:</td>
<td>Kaifeng Lu <a href="https://orcid.org/0000-0002-6160-7119"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [aut,
    cre]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Kaifeng Lu &lt;kaifenglu@gmail.com&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2025-03-20 04:10:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='trtswitch-package'>Treatment Switching</h2><span id='topic+trtswitch-package'></span>

<h3>Description</h3>

<p>Implements rank-preserving structural failure time model
(RPSFTM), iterative parameter estimation (IPE), inverse probability of
censoring weights (IPCW), and two-stage estimation (TSE) methods for
treatment switching in randomized clinical trials.
</p>


<h3>Details</h3>

<p>To enable bootstrapping of the parameter estimates, we implements
many standard survival analysis methods in C++. These include but are not
limited to Kaplan-Meier estimates of the survival curves, log-rank tests,
accelerate failure time models, and Cox proportional hazards models.
</p>
<p>All treatment switching adjustment methods allow treatment switching
in both treatment arms, stratification and covariates adjustment.
For the AFT models, stratification factors are included as covariates
(main effects only or all-way interactions) because SAS PROC LIFEREG
does not have the strata statement. The RPSFTM, IPE and TSE methods
can be used with or without recensoring. The IPCW method can produce
stabilized and truncated weights.
</p>
<p>The <code>treat</code> variable adopts a treatment-before-control order,
except with 1/0 or TRUE/FALSE coding.
</p>


<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>References</h3>

<p>James M. Robins and Anastasios A. Tsiatis.
Correcting for non-compliance in randomized trials using rank preserving
structural failure time models.
Communications in Statistics. 1991;20(8):2609-2631.
</p>
<p>Ian R. White, Adbel G. Babiker, Sarah Walker, and Janet H. Darbyshire.
Randomization-based methods for correcting for treatment changes:
Examples from the CONCORDE trial.
Statistics in Medicine. 1999;18:2617-2634.
</p>
<p>Michael Branson and John Whitehead.
Estimating a treatment effect in survival studies in which patients
switch treatment.
Statistics in Medicine. 2002;21:2449-2463.
</p>
<p>Ian R White.
Letter to the Editor: Estimating treatment effects in randomized
trials with treatment switching.
Statistics in Medicine. 2006;25:1619-1622.
</p>
<p>James M. Robins and Dianne M. Finkelstein.
Correcting for noncompliance and dependent censoring in an AIDS clinical
trial with inverse probability of censoring weighted (IPCW) log-rank tests.
Biometrics. 2000;56:779-788.
</p>
<p>Nicholas R. Latimer, Keith R. Abrams, Paul C. Lambert, Michael K. Crowther,
Allan J. Wailoo, Jonathan P. Morden, Ron L. Akehurst, and
Michael J. Campbell.
Adjusting for treatment switching in randomised controlled trials - A
simulation study and a simplified two-stage method.
Statistical Methods in Medical Research. 2017;26(2):724-751.
</p>
<p>Nicholas R. Latimer, Ian R. White, Kate Tilling, and Ulrike Siebert.
Improved two-stage estimation to adjust for treatment switching in
randomised trials: g-estimation to address time-dependent confounding.
Statistical Methods in Medical Research. 2020;29(10):2900-2918.
</p>

<hr>
<h2 id='aml'>Acute myelogenous leukemia survival data from the survival package</h2><span id='topic+aml'></span>

<h3>Description</h3>

<p>Survival in patients with acute myelogenous leukemia.
</p>

<dl>
<dt><code>time</code></dt><dd><p>Survival or censoring time</p>
</dd>
<dt><code>status</code></dt><dd><p>censoring status</p>
</dd>
<dt><code>x</code></dt><dd><p>maintenance chemotherapy given or not</p>
</dd>
</dl>



<h3>Usage</h3>

<pre><code class='language-R'>aml
</code></pre>


<h3>Format</h3>

<p>An object of class <code>data.frame</code> with 23 rows and 3 columns.
</p>

<hr>
<h2 id='bscpp'>B-Spline Basis for Polynomial Splines</h2><span id='topic+bscpp'></span>

<h3>Description</h3>

<p>Computes the B-spline basis matrix for a given polynomial
spline.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>bscpp(
  x = NA_real_,
  df = NA_integer_,
  knots = NA_real_,
  degree = 3L,
  intercept = 0L,
  boundary_knots = NA_real_,
  warn_outside = 1L
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="bscpp_+3A_x">x</code></td>
<td>
<p>A numeric vector representing the predictor variable.</p>
</td></tr>
<tr><td><code id="bscpp_+3A_df">df</code></td>
<td>
<p>Degrees of freedom, specifying the number of columns in the
basis matrix. If <code>df</code> is provided, the function automatically
selects <code>df - degree - intercept</code> internal knots based on
appropriate quantiles of <code>x</code>, ignoring any missing values.</p>
</td></tr>
<tr><td><code id="bscpp_+3A_knots">knots</code></td>
<td>
<p>A numeric vector specifying the internal breakpoints
that define the spline. If not provided, <code>df</code> must be specified.</p>
</td></tr>
<tr><td><code id="bscpp_+3A_degree">degree</code></td>
<td>
<p>An integer specifying the degree of the piecewise
polynomial. The default value is <code>3</code>, which corresponds to
cubic splines.</p>
</td></tr>
<tr><td><code id="bscpp_+3A_intercept">intercept</code></td>
<td>
<p>A logical value indicating whether to include an
intercept in the basis. The default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="bscpp_+3A_boundary_knots">boundary_knots</code></td>
<td>
<p>A numeric vector of length 2 specifying the
boundary points where the B-spline basis should be anchored.
If not supplied, the default is the range of non-missing values
in <code>x</code>.</p>
</td></tr>
<tr><td><code id="bscpp_+3A_warn_outside">warn_outside</code></td>
<td>
<p>A logical value indicating whether a warning
should be issued if any values of <code>x</code> fall outside the
specified boundary knots.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A matrix with dimensions <code>c(length(x), df)</code>. If
<code>df</code> is provided, the matrix will have <code>df</code> columns.
Alternatively, if <code>knots</code> are supplied, the number of columns
will be <code>length(knots) + degree + intercept</code>. The matrix
contains attributes that correspond to the arguments
passed to the <code>bscpp</code> function.
</p>


<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
bscpp(women$height, df = 5)

</code></pre>

<hr>
<h2 id='findInterval3'>Find Interval Numbers of Indices</h2><span id='topic+findInterval3'></span>

<h3>Description</h3>

<p>The implementation of <code>findInterval()</code> in R from
Advanced R by Hadley Wickham. Given a vector of non-decreasing
breakpoints in v, find the interval containing each element of x; i.e.,
if <code>i &lt;- findInterval3(x,v)</code>, for each index <code>j</code> in <code>x</code>,
<code>v[i[j]] &lt;= x[j] &lt; v[i[j] + 1]</code>, where <code>v[0] := -Inf</code>,
<code>v[N+1] := +Inf</code>, and <code>N = length(v)</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>findInterval3(x, v)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="findInterval3_+3A_x">x</code></td>
<td>
<p>The numeric vector of interest.</p>
</td></tr>
<tr><td><code id="findInterval3_+3A_v">v</code></td>
<td>
<p>The vector of break points.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A vector of <code>length(x)</code> with values in <code>0:N</code> where
<code>N = length(v)</code>.
</p>


<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>x &lt;- 2:18
v &lt;- c(5, 10, 15) # create two bins [5,10) and [10,15)
cbind(x, findInterval3(x, v))

</code></pre>

<hr>
<h2 id='heart'>Stanford heart transplant data from the survival package</h2><span id='topic+heart'></span>

<h3>Description</h3>

<p>Survival of patients on the waiting list for the Stanford heart
transplant program.
</p>

<dl>
<dt><code>start, stop, event</code></dt><dd><p>entry and exit time and status for
the time interval</p>
</dd>
<dt><code>age</code></dt><dd><p>age-48 years</p>
</dd>
<dt><code>year</code></dt><dd><p>year of acceptance (in years after Nov 1, 1967)</p>
</dd>
<dt><code>surgery</code></dt><dd><p>prior bypass surgery 1=yes, 0=no</p>
</dd>
<dt><code>transplant</code></dt><dd><p>received transplant 1=yes, 0=no</p>
</dd>
<dt><code>id</code></dt><dd><p>patient id</p>
</dd>
</dl>



<h3>Usage</h3>

<pre><code class='language-R'>heart
</code></pre>


<h3>Format</h3>

<p>An object of class <code>data.frame</code> with 172 rows and 8 columns.
</p>

<hr>
<h2 id='immdef'>Simulated CONCORDE trial data from the rpsftm package</h2><span id='topic+immdef'></span>

<h3>Description</h3>

<p>Patients were randomly assigned to receive treatment immediately
or deferred, and those in the deferred arm could cross over and
receive treatment. The primary endpoint was time to disease progression.
</p>

<dl>
<dt><code>id</code></dt><dd><p>Patient identification number</p>
</dd>
<dt><code>def</code></dt><dd><p>Indicator that the participant was assigned to
the deferred treatment arm</p>
</dd>
<dt><code>imm</code></dt><dd><p>Indicator that the participant was assigned to
the immediate treatment arm</p>
</dd>
<dt><code>censyrs</code></dt><dd><p>The censoring time, in years, corresponding to
the close of study minus the time of entry for each patient</p>
</dd>
<dt><code>xo</code></dt><dd><p>Indicator that crossover occurred</p>
</dd>
<dt><code>xoyrs</code></dt><dd><p>The time, in years, from entry to switching, or
0 for patients in the immediate arm</p>
</dd>
<dt><code>prog</code></dt><dd><p>Indicator of disease progression (1), or
censoring (0)</p>
</dd>
<dt><code>progyrs</code></dt><dd><p>Time, in years, from entry to disease
progression or censoring</p>
</dd>
<dt><code>entry</code></dt><dd><p>The time of entry into the study, measured in years
from the date of randomisation</p>
</dd>
</dl>



<h3>Usage</h3>

<pre><code class='language-R'>immdef
</code></pre>


<h3>Format</h3>

<p>An object of class <code>data.frame</code> with 1000 rows and 9 columns.
</p>

<hr>
<h2 id='ingots'>The binary data from Cox and Snell (1989, pp. 10-11).</h2><span id='topic+ingots'></span>

<h3>Description</h3>

<p>The dataset consits of the number of ingots not ready for rolling
and the number of ingots ready for rolling for a number of
combinations of heating time and soaking time.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ingots
</code></pre>


<h3>Format</h3>

<p>An object of class <code>tbl_df</code> (inherits from <code>tbl</code>, <code>data.frame</code>) with 25 rows and 4 columns.
</p>


<h3>Details</h3>


<dl>
<dt><code>Heat</code></dt><dd><p>The heating time</p>
</dd>
<dt><code>Soak</code></dt><dd><p>The soaking time</p>
</dd>
<dt><code>NotReady</code></dt><dd><p>Response indicator, with a value 1 for units
not ready for rolling (event) and a value of 0 for units ready for
rolling (nonevent)</p>
</dd>
<dt><code>Freq</code></dt><dd><p>The frequency of occurrence of each combination of
<code>Heat</code>, <code>Soak</code>, and <code>NotReady</code></p>
</dd>
</dl>


<hr>
<h2 id='ipcw'>Inverse Probability of Censoring Weights (IPCW) Method
for Treatment Switching</h2><span id='topic+ipcw'></span>

<h3>Description</h3>

<p>Uses the inverse probability of censoring weights (IPCW)
method to obtain the hazard ratio estimate of the Cox model to
adjust for treatment switching.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ipcw(
  data,
  id = "id",
  stratum = "",
  tstart = "tstart",
  tstop = "tstop",
  event = "event",
  treat = "treat",
  swtrt = "swtrt",
  swtrt_time = "swtrt_time",
  swtrt_time_lower = "",
  swtrt_time_upper = "",
  base_cov = "",
  numerator = "",
  denominator = "",
  logistic_switching_model = FALSE,
  strata_main_effect_only = TRUE,
  firth = FALSE,
  flic = FALSE,
  ns_df = 3,
  relative_time = TRUE,
  stabilized_weights = TRUE,
  trunc = 0,
  trunc_upper_only = TRUE,
  swtrt_control_only = TRUE,
  alpha = 0.05,
  ties = "efron",
  boot = TRUE,
  n_boot = 1000,
  seed = NA
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ipcw_+3A_data">data</code></td>
<td>
<p>The input data frame that contains the following variables:
</p>

<ul>
<li> <p><code>id</code>: The id to identify observations belonging to the same
subject for counting process data with time-dependent covariates.
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>tstart</code>: The starting time of the time interval for
counting-process data with time-dependent covariates.
</p>
</li>
<li> <p><code>tstop</code>: The stopping time of the time interval for
counting-process data with time-dependent covariates.
</p>
</li>
<li> <p><code>event</code>: The event indicator, 1=event, 0=no event.
</p>
</li>
<li> <p><code>treat</code>: The randomized treatment indicator, 1=treatment,
0=control.
</p>
</li>
<li> <p><code>swtrt</code>: The treatment switch indicator, 1=switch, 0=no switch.
</p>
</li>
<li> <p><code>swtrt_time</code>: The time from randomization to treatment switch.
</p>
</li>
<li> <p><code>swtrt_time_lower</code>: The lower bound of treatment switching time.
</p>
</li>
<li> <p><code>swtrt_time_upper</code>: The upper bound of treatment switching time.
</p>
</li>
<li> <p><code>base_cov</code>: The baseline covariates (excluding treat) used in
the outcome model.
</p>
</li>
<li> <p><code>numerator</code>: The baseline covariates (excluding treat) used in
the switching model for the numerator for stabilized weights.
</p>
</li>
<li> <p><code>denominator</code>: The baseline and time-dependent covariates
(excluding treat) used in the switching model for the denominator.
</p>
</li></ul>
</td></tr>
<tr><td><code id="ipcw_+3A_id">id</code></td>
<td>
<p>The name of the id variable in the input data.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_stratum">stratum</code></td>
<td>
<p>The name(s) of the stratum variable(s) in the input data.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_tstart">tstart</code></td>
<td>
<p>The name of the tstart variable in the input data.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_tstop">tstop</code></td>
<td>
<p>The name of the tstop variable in the input data.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_event">event</code></td>
<td>
<p>The name of the event variable in the input data.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_treat">treat</code></td>
<td>
<p>The name of the treatment variable in the input data.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_swtrt">swtrt</code></td>
<td>
<p>The name of the swtrt variable in the input data.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_swtrt_time">swtrt_time</code></td>
<td>
<p>The name of the swtrt_time variable in the input data.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_swtrt_time_lower">swtrt_time_lower</code></td>
<td>
<p>The name of the swtrt_time_lower variable in
the input data.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_swtrt_time_upper">swtrt_time_upper</code></td>
<td>
<p>The name of the swtrt_time_upper variable in
the input data.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_base_cov">base_cov</code></td>
<td>
<p>The names of baseline covariates (excluding
treat) in the input data for the Cox model.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_numerator">numerator</code></td>
<td>
<p>The names of baseline covariates
(excluding treat) in the input data for the numerator switching
model for stabilized weights.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_denominator">denominator</code></td>
<td>
<p>The names of baseline and time-dependent
covariates (excluding treat) in the input data for the denominator
switching model.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_logistic_switching_model">logistic_switching_model</code></td>
<td>
<p>Whether a pooled logistic regression
switching model is used.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_strata_main_effect_only">strata_main_effect_only</code></td>
<td>
<p>Whether to only include the strata main
effects in the logistic regression switching model. Defaults to
<code>TRUE</code>, otherwise all possible strata combinations will be
considered in the switching model.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_firth">firth</code></td>
<td>
<p>Whether the Firth's bias reducing penalized likelihood
should be used. The default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_flic">flic</code></td>
<td>
<p>Whether to apply intercept correction to obtain more
accurate predicted probabilities. The default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_ns_df">ns_df</code></td>
<td>
<p>Degrees of freedom for the natural cubic spline for
visit-specific intercepts of the pooled logistic regression model.
Defaults to 3 for two internal knots at the 33 and 67 percentiles
of the artificial censoring times due to treatment switching.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_relative_time">relative_time</code></td>
<td>
<p>Whether to use the time relative to
<code>swtrt_time_lower</code> as the intercepts for the pooled logistic
regression model. The default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_stabilized_weights">stabilized_weights</code></td>
<td>
<p>Whether to use the stabilized weights.
The default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_trunc">trunc</code></td>
<td>
<p>The truncation fraction of the weight distribution.
Defaults to 0 for no truncation in weights.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_trunc_upper_only">trunc_upper_only</code></td>
<td>
<p>Whether to truncate the weights from the upper
end of the weight distribution only. Defaults to <code>TRUE</code>, otherwise
the weights will be truncated from both the lower and upper ends of
the distribution.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_swtrt_control_only">swtrt_control_only</code></td>
<td>
<p>Whether treatment switching occurred only in
the control group. The default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_alpha">alpha</code></td>
<td>
<p>The significance level to calculate confidence intervals.
The default value is 0.05.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_ties">ties</code></td>
<td>
<p>The method for handling ties in the Cox model, either
&quot;breslow&quot; or &quot;efron&quot; (default).</p>
</td></tr>
<tr><td><code id="ipcw_+3A_boot">boot</code></td>
<td>
<p>Whether to use bootstrap to obtain the confidence
interval for hazard ratio. Defaults to <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_n_boot">n_boot</code></td>
<td>
<p>The number of bootstrap samples.</p>
</td></tr>
<tr><td><code id="ipcw_+3A_seed">seed</code></td>
<td>
<p>The seed to reproduce the bootstrap results. The default is
missing, in which case, the seed from the environment will be used.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>We use the following steps to obtain the hazard ratio estimate
and confidence interval had there been no treatment switching:
</p>

<ul>
<li><p> Exclude observations after treatment switch.
</p>
</li>
<li><p> Set up the crossover and event indicators for the last time interval
for each subject.
</p>
</li>
<li><p> For time-dependent covariates Cox switching models, replicate unique
event times across treatment arms within each subject.
</p>
</li>
<li><p> Fit the denominator switching model (and the numerator switching model
for stabilized weights) to obtain the inverse probability
of censoring weights. This can be a Cox model with time-dependent
covariates or a pooled logistic regression model. For pooled logistic
regression switching model, the probability of remaining uncensored
(i.e., not switching) will be calculated by subtracting the
predicted probability of switching from 1 and then multiplied over
time up to the current time point.
</p>
</li>
<li><p> Fit the weighted Cox model to the censored outcome survival times
to obtain the hazard ratio estimate.
</p>
</li>
<li><p> Use either robust sandwich variance or bootstrapping to construct the
p-value and confidence interval for the hazard ratio.
If bootstrapping is used, the confidence interval
and corresponding p-value are calculated based on a t-distribution with
<code>n_boot - 1</code> degrees of freedom.
</p>
</li></ul>



<h3>Value</h3>

<p>A list with the following components:
</p>

<ul>
<li> <p><code>logrank_pvalue</code>:  The two-sided p-value of the log-rank test
for an intention-to-treat (ITT) analysis.
</p>
</li>
<li> <p><code>cox_pvalue</code>: The two-sided p-value for treatment effect based on
the Cox model.
</p>
</li>
<li> <p><code>hr</code>: The estimated hazard ratio from the Cox model.
</p>
</li>
<li> <p><code>hr_CI</code>: The confidence interval for hazard ratio.
</p>
</li>
<li> <p><code>hr_CI_type</code>: The type of confidence interval for hazard ratio,
either &quot;Cox model&quot; or &quot;bootstrap&quot;.
</p>
</li>
<li> <p><code>data_switch</code>: A list of input data for the switching models by
treatment group.
</p>
</li>
<li> <p><code>fit_switch</code>: A list of fitted switching models for the
denominator and numerator by treatment group.
</p>
</li>
<li> <p><code>data_outcome</code>: The input data for the outcome Cox model
including the inverse probability of censoring weights.
</p>
</li>
<li> <p><code>fit_outcome</code>: The fitted outcome Cox model.
</p>
</li>
<li> <p><code>settings</code>: A list with the following components:
</p>

<ul>
<li> <p><code>logistic_switching_model</code>: Whether a pooled logistic
regression switching model is used.
</p>
</li>
<li> <p><code>strata_main_effect_only</code>: Whether to only include the
strata main effects in the logistic regression switching model.
</p>
</li>
<li> <p><code>firth</code>: Whether the Firth's bias reducing penalized likelihood
should be used.
</p>
</li>
<li> <p><code>flic</code>: Whether to apply intercept correction to obtain more
accurate predicted probabilities.
</p>
</li>
<li> <p><code>ns_df</code>: Degrees of freedom for the natural cubic spline.
</p>
</li>
<li> <p><code>relative_time</code>: Whether to use the relative time as the
intercepts.
</p>
</li>
<li> <p><code>stabilized_weights</code>: Whether to use the stabilized weights.
</p>
</li>
<li> <p><code>trunc</code>: The truncation fraction of the weight distribution.
</p>
</li>
<li> <p><code>trunc_upper_only</code>: Whether to truncate the weights from the
upper end of the distribution only.
</p>
</li>
<li> <p><code>swtrt_control_only</code> Whether treatment switching occurred only
in the control group.
</p>
</li>
<li> <p><code>alpa</code>: The significance level to calculate confidence
intervals.
</p>
</li>
<li> <p><code>ties</code>: The method for handling ties in the Cox model.
</p>
</li>
<li> <p><code>boot</code>: Whether to use bootstrap to obtain the confidence
interval for hazard ratio.
</p>
</li>
<li> <p><code>n_boot</code>: The number of bootstrap samples.
</p>
</li>
<li> <p><code>seed</code>: The seed to reproduce the bootstrap results.
</p>
</li></ul>

</li>
<li> <p><code>hr_boots</code>: The bootstrap hazard ratio estimates if <code>boot</code> is
<code>TRUE</code>.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>References</h3>

<p>James M. Robins and Dianne M. Finkelstein.
Correcting for noncompliance and dependent censoring in an AIDS clinical
trial with inverse probability of censoring weighted (IPCW) log-rank tests.
Biometrics. 2000;56:779-788.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# Example 1: pooled logistic regression switching model

sim1 &lt;- tsegestsim(
  n = 500, allocation1 = 2, allocation2 = 1, pbprog = 0.5, 
  trtlghr = -0.5, bprogsl = 0.3, shape1 = 1.8, 
  scale1 = 0.000025, shape2 = 1.7, scale2 = 0.000015, 
  pmix = 0.5, admin = 5000, pcatnotrtbprog = 0.5, 
  pcattrtbprog = 0.25, pcatnotrt = 0.2, pcattrt = 0.1, 
  catmult = 0.5, tdxo = 1, ppoor = 0.1, pgood = 0.04, 
  ppoormet = 0.4, pgoodmet = 0.2, xomult = 1.4188308, 
  milestone = 546, swtrt_control_only = TRUE,
  outputRawDataset = 1, seed = 2000)

fit1 &lt;- ipcw(
  sim1$paneldata, id = "id", tstart = "tstart", 
  tstop = "tstop", event = "died", treat = "trtrand", 
  swtrt = "xo", swtrt_time = "xotime", 
  swtrt_time_lower = "timePFSobs",
  swtrt_time_upper = "xotime_upper", base_cov = "bprog", 
  numerator = "bprog", denominator = "bprog*catlag", 
  logistic_switching_model = TRUE, ns_df = 3,
  relative_time = TRUE, swtrt_control_only = TRUE, 
  boot = FALSE)
  
c(fit1$hr, fit1$hr_CI) 

# Example 2: time-dependent covariates Cox switching model

fit2 &lt;- ipcw(
  shilong, id = "id", tstart = "tstart", tstop = "tstop", 
  event = "event", treat = "bras.f", swtrt = "co", 
  swtrt_time = "dco", 
  base_cov = c("agerand", "sex.f", "tt_Lnum", "rmh_alea.c", 
               "pathway.f"),
  numerator = c("agerand", "sex.f", "tt_Lnum", "rmh_alea.c", 
                "pathway.f"),
  denominator = c("agerand", "sex.f", "tt_Lnum", "rmh_alea.c",
                  "pathway.f", "ps", "ttc", "tran"),
  swtrt_control_only = FALSE, boot = FALSE)

c(fit2$hr, fit2$hr_CI)

</code></pre>

<hr>
<h2 id='ipe'>Iterative Parameter Estimation (IPE) for Treatment Switching</h2><span id='topic+ipe'></span>

<h3>Description</h3>

<p>Obtains the causal parameter estimate from the
accelerated failure-time (AFT) model and the hazard ratio estimate
from the Cox model to adjust for treatment switching.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ipe(
  data,
  id = "id",
  stratum = "",
  time = "time",
  event = "event",
  treat = "treat",
  rx = "rx",
  censor_time = "censor_time",
  base_cov = "",
  aft_dist = "weibull",
  strata_main_effect_only = 1,
  treat_modifier = 1,
  recensor = TRUE,
  admin_recensor_only = TRUE,
  autoswitch = TRUE,
  alpha = 0.05,
  ties = "efron",
  tol = 1e-06,
  boot = FALSE,
  n_boot = 1000,
  seed = NA
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ipe_+3A_data">data</code></td>
<td>
<p>The input data frame that contains the following variables:
</p>

<ul>
<li> <p><code>id</code>: The subject id.
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>time</code>: The survival time for right censored data.
</p>
</li>
<li> <p><code>event</code>: The event indicator, 1=event, 0=no event.
</p>
</li>
<li> <p><code>treat</code>: The randomized treatment indicator, 1=treatment,
0=control.
</p>
</li>
<li> <p><code>rx</code>: The proportion of time on active treatment.
</p>
</li>
<li> <p><code>censor_time</code>: The administrative censoring time. It should
be provided for all subjects including those who had events.
</p>
</li>
<li> <p><code>base_cov</code>: The baseline covariates (excluding treat).
</p>
</li></ul>
</td></tr>
<tr><td><code id="ipe_+3A_id">id</code></td>
<td>
<p>The name of the id variable in the input data.</p>
</td></tr>
<tr><td><code id="ipe_+3A_stratum">stratum</code></td>
<td>
<p>The name(s) of the stratum variable(s) in the input data.</p>
</td></tr>
<tr><td><code id="ipe_+3A_time">time</code></td>
<td>
<p>The name of the time variable in the input data.</p>
</td></tr>
<tr><td><code id="ipe_+3A_event">event</code></td>
<td>
<p>The name of the event variable in the input data.</p>
</td></tr>
<tr><td><code id="ipe_+3A_treat">treat</code></td>
<td>
<p>The name of the treatment variable in the input data.</p>
</td></tr>
<tr><td><code id="ipe_+3A_rx">rx</code></td>
<td>
<p>The name of the rx variable in the input data.</p>
</td></tr>
<tr><td><code id="ipe_+3A_censor_time">censor_time</code></td>
<td>
<p>The name of the censor_time variable in the input data.</p>
</td></tr>
<tr><td><code id="ipe_+3A_base_cov">base_cov</code></td>
<td>
<p>The names of baseline covariates (excluding
treat) in the input data for the outcome Cox model.</p>
</td></tr>
<tr><td><code id="ipe_+3A_aft_dist">aft_dist</code></td>
<td>
<p>The assumed distribution for time to event for the AFT
model. Options include &quot;exponential&quot;, &quot;weibull&quot; (default),
&quot;loglogistic&quot;, and &quot;lognormal&quot;.</p>
</td></tr>
<tr><td><code id="ipe_+3A_strata_main_effect_only">strata_main_effect_only</code></td>
<td>
<p>Whether to only include the strata main
effects in the AFT model. Defaults to <code>TRUE</code>, otherwise all
possible strata combinations will be considered in the AFT model.</p>
</td></tr>
<tr><td><code id="ipe_+3A_treat_modifier">treat_modifier</code></td>
<td>
<p>The optional sensitivity parameter for the
constant treatment effect assumption.</p>
</td></tr>
<tr><td><code id="ipe_+3A_recensor">recensor</code></td>
<td>
<p>Whether to apply recensoring to counterfactual
survival times. Defaults to <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="ipe_+3A_admin_recensor_only">admin_recensor_only</code></td>
<td>
<p>Whether to apply recensoring to administrative
censoring times only. Defaults to <code>TRUE</code>. If <code>FALSE</code>,
recensoring will be applied to the actual censoring times for dropouts.</p>
</td></tr>
<tr><td><code id="ipe_+3A_autoswitch">autoswitch</code></td>
<td>
<p>Whether to exclude recensoring for treatment arms
with no switching. Defaults to <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="ipe_+3A_alpha">alpha</code></td>
<td>
<p>The significance level to calculate confidence intervals.</p>
</td></tr>
<tr><td><code id="ipe_+3A_ties">ties</code></td>
<td>
<p>The method for handling ties in the Cox model, either
&quot;breslow&quot; or &quot;efron&quot; (default).</p>
</td></tr>
<tr><td><code id="ipe_+3A_tol">tol</code></td>
<td>
<p>The desired accuracy (convergence tolerance) for <code>psi</code>.</p>
</td></tr>
<tr><td><code id="ipe_+3A_boot">boot</code></td>
<td>
<p>Whether to use bootstrap to obtain the confidence
interval for hazard ratio. Defaults to <code>FALSE</code>, in which case,
the confidence interval will be constructed to match the log-rank
test p-value.</p>
</td></tr>
<tr><td><code id="ipe_+3A_n_boot">n_boot</code></td>
<td>
<p>The number of bootstrap samples.</p>
</td></tr>
<tr><td><code id="ipe_+3A_seed">seed</code></td>
<td>
<p>The seed to reproduce the bootstrap results. The default is
missing, in which case, the seed from the environment will be used.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>We use the following steps to obtain the hazard ratio estimate
and confidence interval had there been no treatment switching:
</p>

<ul>
<li><p> Use IPE to estimate the causal parameter <code class="reqn">\psi</code> based on the AFT
model for the observed survival times for the experimental arm and
the counterfactual survival times for the control arm,
</p>
<p style="text-align: center;"><code class="reqn">U_{i,\psi} = T_{C_i} + e^{\psi}T_{E_i}</code>
</p>

</li>
<li><p> Fit the Cox proportional hazards model to the observed survival times
for the experimental group and the counterfactual survival times
for the control group to obtain the hazard ratio estimate.
</p>
</li>
<li><p> Use either the log-rank test p-value for the intention-to-treat (ITT)
analysis or bootstrap to construct the confidence interval for
hazard ratio. If bootstrapping is used, the confidence interval
and corresponding p-value are calculated based on a t-distribution with
<code>n_boot - 1</code> degrees of freedom.
</p>
</li></ul>



<h3>Value</h3>

<p>A list with the following components:
</p>

<ul>
<li> <p><code>psi</code>: The estimated causal parameter.
</p>
</li>
<li> <p><code>psi_CI</code>: The confidence interval for <code>psi</code>.
</p>
</li>
<li> <p><code>psi_CI_type</code>: The type of confidence interval for <code>psi</code>,
i.e., &quot;log-rank p-value&quot; or &quot;bootstrap&quot;.
</p>
</li>
<li> <p><code>logrank_pvalue</code>: The two-sided p-value of the log-rank test
for the ITT analysis.
</p>
</li>
<li> <p><code>cox_pvalue</code>: The two-sided p-value for treatment effect based on
the Cox model.
</p>
</li>
<li> <p><code>hr</code>: The estimated hazard ratio from the Cox model.
</p>
</li>
<li> <p><code>hr_CI</code>: The confidence interval for hazard ratio.
</p>
</li>
<li> <p><code>hr_CI_type</code>: The type of confidence interval for hazard ratio,
either &quot;log-rank p-value&quot; or &quot;bootstrap&quot;.
</p>
</li>
<li> <p><code>Sstar</code>: A data frame containing the counterfactual untreated
survival times and event indicators for each treatment group.
</p>
</li>
<li> <p><code>kmstar</code>: A data frame containing the Kaplan-Meier estimates
based on the counterfactual untreated survival times by treatment arm.
</p>
</li>
<li> <p><code>data_aft</code>: The input data for the AFT model for
estimating <code>psi</code>.
</p>
</li>
<li> <p><code>fit_aft</code>: The fitted AFT model for estimating <code>psi</code>.
</p>
</li>
<li> <p><code>data_outcome</code>: The input data for the outcome Cox model.
</p>
</li>
<li> <p><code>fit_outcome</code>: The fitted outcome Cox model.
</p>
</li>
<li> <p><code>settings</code>: A list with the following components:
</p>

<ul>
<li> <p><code>aft_dist</code>: The distribution for time to event for the AFT
model.
</p>
</li>
<li> <p><code>strata_main_effect_only</code>: Whether to only include the strata
main effects in the AFT model.
</p>
</li>
<li> <p><code>treat_modifier</code>: The sensitivity parameter for the constant
treatment effect assumption.
</p>
</li>
<li> <p><code>recensor</code>: Whether to apply recensoring to counterfactual
survival times.
</p>
</li>
<li> <p><code>admin_recensor_only</code>: Whether to apply recensoring to
administrative censoring times only.
</p>
</li>
<li> <p><code>autoswitch</code>: Whether to exclude recensoring for treatment
arms with no switching.
</p>
</li>
<li> <p><code>alpha</code>: The significance level to calculate confidence
intervals.
</p>
</li>
<li> <p><code>ties</code>: The method for handling ties in the Cox model.
</p>
</li>
<li> <p><code>tol</code>: The desired accuracy (convergence tolerance)
for <code>psi</code>.
</p>
</li>
<li> <p><code>boot</code>: Whether to use bootstrap to obtain the confidence
interval for hazard ratio.
</p>
</li>
<li> <p><code>n_boot</code>: The number of bootstrap samples.
</p>
</li>
<li> <p><code>seed</code>: The seed to reproduce the bootstrap results.
</p>
</li></ul>

</li>
<li> <p><code>hr_boots</code>: The bootstrap hazard ratio estimates if <code>boot</code> is
<code>TRUE</code>.
</p>
</li>
<li> <p><code>psi_boots</code>: The bootstrap <code>psi</code> estimates if <code>boot</code> is
<code>TRUE</code>.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>References</h3>

<p>Michael Branson and John Whitehead.
Estimating a treatment effect in survival studies in which patients
switch treatment.
Statistics in Medicine. 2002;21:2449-2463.
</p>
<p>Ian R White.
Letter to the Editor: Estimating treatment effects in randomized
trials with treatment switching.
Statistics in Medicine. 2006;25:1619-1622.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
library(dplyr)

# Example 1: one-way treatment switching (control to active)

data &lt;- immdef %&gt;% mutate(rx = 1-xoyrs/progyrs)

fit1 &lt;- ipe(
  data, id = "id", time = "progyrs", event = "prog", treat = "imm", 
  rx = "rx", censor_time = "censyrs", aft_dist = "weibull",
  boot = FALSE)

c(fit1$hr, fit1$hr_CI)

# Example 2: two-way treatment switching (illustration only)

# the eventual survival time
shilong1 &lt;- shilong %&gt;%
  arrange(bras.f, id, tstop) %&gt;%
  group_by(bras.f, id) %&gt;%
  slice(n()) %&gt;%
  select(-c("ps", "ttc", "tran"))

shilong2 &lt;- shilong1 %&gt;%
  mutate(rx = ifelse(co, ifelse(bras.f == "MTA", dco/ady, 
                                1 - dco/ady),
                     ifelse(bras.f == "MTA", 1, 0)))

fit2 &lt;- ipe(
  shilong2, id = "id", time = "tstop", event = "event",
  treat = "bras.f", rx = "rx", censor_time = "dcut",
  base_cov = c("agerand", "sex.f", "tt_Lnum", "rmh_alea.c",
               "pathway.f"),
  aft_dist = "weibull", boot = FALSE)

c(fit2$hr, fit2$hr_CI)

</code></pre>

<hr>
<h2 id='kmdiff'>Estimate of Milestone Survival Difference</h2><span id='topic+kmdiff'></span>

<h3>Description</h3>

<p>Obtains the estimate of milestone survival difference
between two treatment groups.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>kmdiff(
  data,
  rep = "",
  stratum = "",
  treat = "treat",
  time = "time",
  event = "event",
  milestone = NA_real_,
  survDiffH0 = 0,
  conflev = 0.95
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="kmdiff_+3A_data">data</code></td>
<td>
<p>The input data frame that contains the following variables:
</p>

<ul>
<li> <p><code>rep</code>: The replication for by-group processing.
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>treat</code>: The treatment.
</p>
</li>
<li> <p><code>time</code>: The possibly right-censored survival time.
</p>
</li>
<li> <p><code>event</code>: The event indicator.
</p>
</li></ul>
</td></tr>
<tr><td><code id="kmdiff_+3A_rep">rep</code></td>
<td>
<p>The name of the replication variable in the input data.</p>
</td></tr>
<tr><td><code id="kmdiff_+3A_stratum">stratum</code></td>
<td>
<p>The name of the stratum variable in the input data.</p>
</td></tr>
<tr><td><code id="kmdiff_+3A_treat">treat</code></td>
<td>
<p>The name of the treatment variable in the input data.</p>
</td></tr>
<tr><td><code id="kmdiff_+3A_time">time</code></td>
<td>
<p>The name of the time variable in the input data.</p>
</td></tr>
<tr><td><code id="kmdiff_+3A_event">event</code></td>
<td>
<p>The name of the event variable in the input data.</p>
</td></tr>
<tr><td><code id="kmdiff_+3A_milestone">milestone</code></td>
<td>
<p>The milestone time at which to calculate the
survival probability.</p>
</td></tr>
<tr><td><code id="kmdiff_+3A_survdiffh0">survDiffH0</code></td>
<td>
<p>The difference in milestone survival probabilities
under the null hypothesis. Defaults to 0 for superiority test.</p>
</td></tr>
<tr><td><code id="kmdiff_+3A_conflev">conflev</code></td>
<td>
<p>The level of the two-sided confidence interval for
the difference in milestone survival probabilities. Defaults to 0.95.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame with the following variables:
</p>

<ul>
<li> <p><code>rep</code>: The replication.
</p>
</li>
<li> <p><code>milestone</code>: The milestone time relative to randomization.
</p>
</li>
<li> <p><code>survDiffH0</code>: The difference in milestone survival probabilities
under the null hypothesis.
</p>
</li>
<li> <p><code>surv1</code>: The estimated milestone survival probability for
the treatment group.
</p>
</li>
<li> <p><code>surv2</code>: The estimated milestone survival probability for
the control group.
</p>
</li>
<li> <p><code>survDiff</code>: The estimated difference in milestone survival
probabilities.
</p>
</li>
<li> <p><code>vsurv1</code>: The variance for surv1.
</p>
</li>
<li> <p><code>vsurv2</code>: The variance for surv2.
</p>
</li>
<li> <p><code>vsurvDiff</code>: The variance for survDiff.
</p>
</li>
<li> <p><code>survDiffZ</code>: The Z-statistic value.
</p>
</li>
<li> <p><code>survDiffPValue</code>: The one-sided p-value.
</p>
</li>
<li> <p><code>lower</code>: The lower bound of confidence interval.
</p>
</li>
<li> <p><code>upper</code>: The upper bound of confidence interval.
</p>
</li>
<li> <p><code>conflev</code>: The level of confidence interval.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
df &lt;- kmdiff(data = rawdata, rep = "iterationNumber",
             stratum = "stratum", treat = "treatmentGroup",
             time = "timeUnderObservation", event = "event",
             milestone = 12)
head(df)

</code></pre>

<hr>
<h2 id='kmest'>Kaplan-Meier Estimates of Survival Curve</h2><span id='topic+kmest'></span>

<h3>Description</h3>

<p>Obtains the Kaplan-Meier estimates of the survival curve.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>kmest(
  data,
  rep = "",
  stratum = "",
  time = "time",
  event = "event",
  conftype = "log-log",
  conflev = 0.95,
  keep_censor = 0L
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="kmest_+3A_data">data</code></td>
<td>
<p>The input data frame that contains the following variables:
</p>

<ul>
<li> <p><code>rep</code>: The replication for by-group processing.
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>time</code>: The possibly right-censored survival time.
</p>
</li>
<li> <p><code>event</code>: The event indicator.
</p>
</li></ul>
</td></tr>
<tr><td><code id="kmest_+3A_rep">rep</code></td>
<td>
<p>The name(s) of the replication variable(s) in the input data.</p>
</td></tr>
<tr><td><code id="kmest_+3A_stratum">stratum</code></td>
<td>
<p>The name(s) of the stratum variable(s) in the input data.</p>
</td></tr>
<tr><td><code id="kmest_+3A_time">time</code></td>
<td>
<p>The name of the time variable in the input data.</p>
</td></tr>
<tr><td><code id="kmest_+3A_event">event</code></td>
<td>
<p>The name of the event variable in the input data.</p>
</td></tr>
<tr><td><code id="kmest_+3A_conftype">conftype</code></td>
<td>
<p>The type of the confidence interval. One of &quot;none&quot;,
&quot;plain&quot;, &quot;log&quot;, &quot;log-log&quot; (the default), or &quot;arcsin&quot;.
The arcsin option bases the intervals on asin(sqrt(survival)).</p>
</td></tr>
<tr><td><code id="kmest_+3A_conflev">conflev</code></td>
<td>
<p>The level of the two-sided confidence interval for
the survival probabilities. Defaults to 0.95.</p>
</td></tr>
<tr><td><code id="kmest_+3A_keep_censor">keep_censor</code></td>
<td>
<p>Whether to retain the censoring time in the output
data frame.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame with the following variables:
</p>

<ul>
<li> <p><code>size</code>: The number of subjects in the stratum.
</p>
</li>
<li> <p><code>time</code>: The event time.
</p>
</li>
<li> <p><code>nrisk</code>: The number of subjects at risk.
</p>
</li>
<li> <p><code>nevent</code>: The number of subjects having the event.
</p>
</li>
<li> <p><code>ncensor</code>: The number of censored subjects.
</p>
</li>
<li> <p><code>survival</code>: The Kaplan-Meier estimate of the survival probability.
</p>
</li>
<li> <p><code>stderr</code>: The standard error of the estimated survival
probability based on the Greendwood formula.
</p>
</li>
<li> <p><code>lower</code>: The lower bound of confidence interval if requested.
</p>
</li>
<li> <p><code>upper</code>: The upper bound of confidence interval if requested.
</p>
</li>
<li> <p><code>conflev</code>: The level of confidence interval if requested.
</p>
</li>
<li> <p><code>conftype</code>: The type of confidence interval if requested.
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>rep</code>: The replication.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
kmest(data = aml, stratum = "x", time = "time", event = "status")

</code></pre>

<hr>
<h2 id='liferegr'>Parametric Regression Models for Failure Time Data</h2><span id='topic+liferegr'></span>

<h3>Description</h3>

<p>Obtains the parameter estimates from parametric
regression models with uncensored, right censored, left censored, or
interval censored data.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>liferegr(
  data,
  rep = "",
  stratum = "",
  time = "time",
  time2 = "",
  event = "event",
  covariates = "",
  weight = "",
  offset = "",
  id = "",
  dist = "weibull",
  robust = FALSE,
  plci = FALSE,
  alpha = 0.05
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="liferegr_+3A_data">data</code></td>
<td>
<p>The input data frame that contains the following variables:
</p>

<ul>
<li> <p><code>rep</code>: The replication for by-group processing.
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>time</code>: The follow-up time for right censored data, or
the left end of each interval for interval censored data.
</p>
</li>
<li> <p><code>time2</code>: The right end of each interval for interval
censored data.
</p>
</li>
<li> <p><code>event</code>: The event indicator, 1=event, 0=no event.
</p>
</li>
<li> <p><code>covariates</code>: The values of baseline covariates.
</p>
</li>
<li> <p><code>weight</code>: The weight for each observation.
</p>
</li>
<li> <p><code>offset</code>: The offset for each observation.
</p>
</li>
<li> <p><code>id</code>: The optional subject ID to group the score residuals
in computing the robust sandwich variance.
</p>
</li></ul>
</td></tr>
<tr><td><code id="liferegr_+3A_rep">rep</code></td>
<td>
<p>The name(s) of the replication variable(s) in the input data.</p>
</td></tr>
<tr><td><code id="liferegr_+3A_stratum">stratum</code></td>
<td>
<p>The name(s) of the stratum variable(s) in the input data.</p>
</td></tr>
<tr><td><code id="liferegr_+3A_time">time</code></td>
<td>
<p>The name of the time variable or the left end of each
interval for interval censored data in the input data.</p>
</td></tr>
<tr><td><code id="liferegr_+3A_time2">time2</code></td>
<td>
<p>The name of the right end of each interval for
interval censored data in the input data.</p>
</td></tr>
<tr><td><code id="liferegr_+3A_event">event</code></td>
<td>
<p>The name of the event variable in the input data
for right censored data.</p>
</td></tr>
<tr><td><code id="liferegr_+3A_covariates">covariates</code></td>
<td>
<p>The vector of names of baseline covariates
in the input data.</p>
</td></tr>
<tr><td><code id="liferegr_+3A_weight">weight</code></td>
<td>
<p>The name of the weight variable in the input data.</p>
</td></tr>
<tr><td><code id="liferegr_+3A_offset">offset</code></td>
<td>
<p>The name of the offset variable in the input data.</p>
</td></tr>
<tr><td><code id="liferegr_+3A_id">id</code></td>
<td>
<p>The name of the id variable in the input data.</p>
</td></tr>
<tr><td><code id="liferegr_+3A_dist">dist</code></td>
<td>
<p>The assumed distribution for time to event. Options include
&quot;exponential&quot;, &quot;weibull&quot;, &quot;lognormal&quot;, and &quot;loglogistic&quot; to be
modeled on the log-scale, and &quot;normal&quot; and &quot;logistic&quot; to be modeled
on the original scale.</p>
</td></tr>
<tr><td><code id="liferegr_+3A_robust">robust</code></td>
<td>
<p>Whether a robust sandwich variance estimate should be
computed. In the presence of the id variable, the score residuals
will be aggregated for each id when computing the robust sandwich
variance estimate.</p>
</td></tr>
<tr><td><code id="liferegr_+3A_plci">plci</code></td>
<td>
<p>Whether to obtain profile likelihood confidence interval.</p>
</td></tr>
<tr><td><code id="liferegr_+3A_alpha">alpha</code></td>
<td>
<p>The two-sided significance level.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>There are two ways to specify the model, one for right censored
data through the time and event variables, and the other for interval
censored data through the time (lower) and time2 (upper) variables.
For the second form, we follow the convention used in SAS PROC LIFEREG:
</p>

<ul>
<li><p> If lower is not missing, upper is not missing, and lower is equal
to upper, then there is no censoring and the event occurred at
time lower.
</p>
</li>
<li><p> If lower is not missing, upper is not missing, and lower &lt; upper,
then the event time is censored within the interval (lower, upper).
</p>
</li>
<li><p> If lower is missing, but upper is not missing, then upper will be
used as the left censoring value.
</p>
</li>
<li><p> If lower is not missing, but upper is missing, then lower will be
used as the right censoring value.
</p>
</li>
<li><p> If lower is not missing, upper is not missing, but lower &gt; upper,
or if both lower and upper are missing, then the observation will
not be used.
</p>
</li></ul>



<h3>Value</h3>

<p>A list with the following components:
</p>

<ul>
<li> <p><code>sumstat</code>: The data frame of summary statistics of model fit
with the following variables:
</p>

<ul>
<li> <p><code>n</code>: The number of observations.
</p>
</li>
<li> <p><code>nevents</code>: The number of events.
</p>
</li>
<li> <p><code>loglik0</code>: The log-likelihood under null.
</p>
</li>
<li> <p><code>loglik1</code>: The maximum log-likelihood.
</p>
</li>
<li> <p><code>niter</code>: The number of Newton-Raphson iterations.
</p>
</li>
<li> <p><code>dist</code>: The assumed distribution.
</p>
</li>
<li> <p><code>p</code>: The number of parameters, including the intercept,
regression coefficients associated with the covariates, and
the log scale parameters for the strata.
</p>
</li>
<li> <p><code>nvar</code>: The number of regression coefficients associated
with the covariates (excluding the intercept).
</p>
</li>
<li> <p><code>robust</code>: Whether the robust sandwich variance estimate
is requested.
</p>
</li>
<li> <p><code>rep</code>: The replication.
</p>
</li></ul>

</li>
<li> <p><code>parest</code>: The data frame of parameter estimates with the
following variables:
</p>

<ul>
<li> <p><code>param</code>: The name of the covariate for the parameter estimate.
</p>
</li>
<li> <p><code>beta</code>: The parameter estimate.
</p>
</li>
<li> <p><code>sebeta</code>: The standard error of parameter estimate.
</p>
</li>
<li> <p><code>z</code>: The Wald test statistic for the parameter.
</p>
</li>
<li> <p><code>expbeta</code>: The exponentiated parameter estimate.
</p>
</li>
<li> <p><code>vbeta</code>: The covariance matrix for parameter estimates.
</p>
</li>
<li> <p><code>lower</code>: The lower limit of confidence interval.
</p>
</li>
<li> <p><code>upper</code>: The upper limit of confidence interval.
</p>
</li>
<li> <p><code>p</code>: The p-value from the chi-square test.
</p>
</li>
<li> <p><code>method</code>: The method to compute the confidence interval and
p-value.
</p>
</li>
<li> <p><code>sebeta_naive</code>: The naive standard error of parameter estimate
if robust variance is requested.
</p>
</li>
<li> <p><code>vbeta_naive</code>: The naive covariance matrix for parameter
estimates if robust variance is requested.
</p>
</li>
<li> <p><code>rep</code>: The replication.
</p>
</li></ul>

</li>
<li> <p><code>p</code>: The number of parameters.
</p>
</li>
<li> <p><code>nvar</code>: The number of columns of the design matrix excluding
the intercept.
</p>
</li>
<li> <p><code>param</code>: The parameter names.
</p>
</li>
<li> <p><code>beta</code>: The parameter estimate.
</p>
</li>
<li> <p><code>vbeta</code>: The covariance matrix for parameter estimates.
</p>
</li>
<li> <p><code>vbeta_naive</code>: The naive covariance matrix for parameter estimates.
</p>
</li>
<li> <p><code>terms</code>: The terms object.
</p>
</li>
<li> <p><code>xlevels</code>: A record of the levels of the factors used in fitting.
</p>
</li>
<li> <p><code>data</code>: The input data.
</p>
</li>
<li> <p><code>rep</code>: The name(s) of the replication variable(s).
</p>
</li>
<li> <p><code>stratum</code>: The name(s) of the stratum variable(s).
</p>
</li>
<li> <p><code>time</code>: The name of the time variable.
</p>
</li>
<li> <p><code>time2</code>: The name of the time2 variable.
</p>
</li>
<li> <p><code>event</code>: The name of the event variable.
</p>
</li>
<li> <p><code>covariates</code>: The names of baseline covariates.
</p>
</li>
<li> <p><code>weight</code>: The name of the weight variable.
</p>
</li>
<li> <p><code>offset</code>: The name of the offset variable.
</p>
</li>
<li> <p><code>id</code>: The name of the id variable.
</p>
</li>
<li> <p><code>dist</code>: The assumed distribution for time to event.
</p>
</li>
<li> <p><code>robust</code>: Whether a robust sandwich variance estimate should be
computed.
</p>
</li>
<li> <p><code>plci</code>: Whether to obtain profile likelihood confidence interval.
</p>
</li>
<li> <p><code>alpha</code>: The two-sided significance level.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>References</h3>

<p>John D. Kalbfleisch and Ross L. Prentice.
The Statistical Analysis of Failure Time Data.
Wiley: New York, 1980.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
library(dplyr)

# right censored data
(fit1 &lt;- liferegr(
  data = rawdata %&gt;% mutate(treat = 1*(treatmentGroup == 1)),
  rep = "iterationNumber", stratum = "stratum",
  time = "timeUnderObservation", event = "event",
  covariates = "treat", dist = "weibull"))

# tobit regression for left censored data
(fit2 &lt;- liferegr(
  data = tobin %&gt;% mutate(time = ifelse(durable&gt;0, durable, NA)),
  time = "time", time2 = "durable",
  covariates = c("age", "quant"), dist = "normal"))

</code></pre>

<hr>
<h2 id='logisregr'>Logistic Regression Models for Binary Data</h2><span id='topic+logisregr'></span>

<h3>Description</h3>

<p>Obtains the parameter estimates from logistic regression
models with binary data.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>logisregr(
  data,
  rep = "",
  event = "event",
  covariates = "",
  freq = "",
  weight = "",
  offset = "",
  id = "",
  link = "logit",
  robust = FALSE,
  firth = FALSE,
  bc = FALSE,
  flic = FALSE,
  plci = FALSE,
  alpha = 0.05
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="logisregr_+3A_data">data</code></td>
<td>
<p>The input data frame that contains the following variables:
</p>

<ul>
<li> <p><code>rep</code>: The replication for by-group processing.
</p>
</li>
<li> <p><code>event</code>: The event indicator, 1=event, 0=no event.
</p>
</li>
<li> <p><code>covariates</code>: The values of baseline covariates.
</p>
</li>
<li> <p><code>freq</code>: The frequency for each observation.
</p>
</li>
<li> <p><code>weight</code>: The weight for each observation.
</p>
</li>
<li> <p><code>offset</code>: The offset for each observation.
</p>
</li>
<li> <p><code>id</code>: The optional subject ID to group the score residuals
in computing the robust sandwich variance.
</p>
</li></ul>
</td></tr>
<tr><td><code id="logisregr_+3A_rep">rep</code></td>
<td>
<p>The name(s) of the replication variable(s) in the input data.</p>
</td></tr>
<tr><td><code id="logisregr_+3A_event">event</code></td>
<td>
<p>The name of the event variable in the input data.</p>
</td></tr>
<tr><td><code id="logisregr_+3A_covariates">covariates</code></td>
<td>
<p>The vector of names of baseline covariates
in the input data.</p>
</td></tr>
<tr><td><code id="logisregr_+3A_freq">freq</code></td>
<td>
<p>The name of the frequency variable in the input data.
The frequencies must be the same for all observations within each
cluster as indicated by the id. Thus freq is the cluster frequency.</p>
</td></tr>
<tr><td><code id="logisregr_+3A_weight">weight</code></td>
<td>
<p>The name of the weight variable in the input data.</p>
</td></tr>
<tr><td><code id="logisregr_+3A_offset">offset</code></td>
<td>
<p>The name of the offset variable in the input data.</p>
</td></tr>
<tr><td><code id="logisregr_+3A_id">id</code></td>
<td>
<p>The name of the id variable in the input data.</p>
</td></tr>
<tr><td><code id="logisregr_+3A_link">link</code></td>
<td>
<p>The link function linking the response probabilities to the
linear predictors. Options include &quot;logit&quot; (default), &quot;probit&quot;, and
&quot;cloglog&quot; (complementary log-log).</p>
</td></tr>
<tr><td><code id="logisregr_+3A_robust">robust</code></td>
<td>
<p>Whether a robust sandwich variance estimate should be
computed. In the presence of the id variable, the score residuals
will be aggregated for each id when computing the robust sandwich
variance estimate.</p>
</td></tr>
<tr><td><code id="logisregr_+3A_firth">firth</code></td>
<td>
<p>Whether the firth's bias reducing penalized likelihood
should be used. The default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="logisregr_+3A_bc">bc</code></td>
<td>
<p>Whether to apply firth's bias correction for noncanonical
parameterization and weighted logistic regression. The default is
<code>FALSE</code>, in which case, the penalized likelihood with Jeffreys
prior will be used.</p>
</td></tr>
<tr><td><code id="logisregr_+3A_flic">flic</code></td>
<td>
<p>Whether to apply intercept correction to obtain more
accurate predicted probabilities. The default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="logisregr_+3A_plci">plci</code></td>
<td>
<p>Whether to obtain profile likelihood confidence interval.</p>
</td></tr>
<tr><td><code id="logisregr_+3A_alpha">alpha</code></td>
<td>
<p>The two-sided significance level.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Fitting a logistic regression model using Firth's bias reduction method
is equivalent to penalization of the log-likelihood by the Jeffreys prior.
Firth's penalized log-likelihood is given by
</p>
<p style="text-align: center;"><code class="reqn">l(\beta) + \frac{1}{2} \log(\mbox{det}(I(\beta)))</code>
</p>

<p>and the components of the gradient <code class="reqn">g(\beta)</code> are computed as
</p>
<p style="text-align: center;"><code class="reqn">g(\beta_j) + \frac{1}{2} \mbox{trace}\left(I(\beta)^{-1}
\frac{\partial I(\beta)}{\partial \beta_j}\right)</code>
</p>

<p>The Hessian matrix is not modified by this penalty.
</p>
<p>Firth's method reduces bias in maximum likelihood estimates of
coefficients, but it introduces a bias toward one-half in the
predicted probabilities.
</p>
<p>A straightforward modification to Firth’s logistic regression to
achieve unbiased average predicted probabilities involves a post hoc
adjustment of the intercept. This approach, known as Firth’s logistic
regression with intercept correction (FLIC), preserves the
bias-corrected effect estimates. By excluding the intercept from
penalization, it ensures that we don't sacrifice the accuracy of
effect estimates to improve the predictions.
</p>


<h3>Value</h3>

<p>A list with the following components:
</p>

<ul>
<li> <p><code>sumstat</code>: The data frame of summary statistics of model fit
with the following variables:
</p>

<ul>
<li> <p><code>n</code>: The number of subjects.
</p>
</li>
<li> <p><code>nevents</code>: The number of events.
</p>
</li>
<li> <p><code>loglik0</code>: The (penalized) log-likelihood under null.
</p>
</li>
<li> <p><code>loglik1</code>: The maximum (penalized) log-likelihood.
</p>
</li>
<li> <p><code>niter</code>: The number of Newton-Raphson iterations.
</p>
</li>
<li> <p><code>p</code>: The number of parameters, including the intercept,
and regression coefficients associated with the covariates.
</p>
</li>
<li> <p><code>link</code>: The link function.
</p>
</li>
<li> <p><code>robust</code>: Whether a robust sandwich variance estimate should
be computed.
</p>
</li>
<li> <p><code>firth</code>: Whether the firth's penalized likelihood is used.
</p>
</li>
<li> <p><code>bc</code>: Whether to apply firth's bias correction for noncanonical
parameterization and weighted logistic regression.
</p>
</li>
<li> <p><code>flic</code>: Whether to apply intercept correction.
</p>
</li>
<li> <p><code>loglik0_unpenalized</code>: The unpenalized log-likelihood under null.
</p>
</li>
<li> <p><code>loglik1_unpenalized</code>: The maximum unpenalized log-likelihood.
</p>
</li>
<li> <p><code>rep</code>: The replication.
</p>
</li></ul>

</li>
<li> <p><code>parest</code>: The data frame of parameter estimates with the
following variables:
</p>

<ul>
<li> <p><code>param</code>: The name of the covariate for the parameter estimate.
</p>
</li>
<li> <p><code>beta</code>: The parameter estimate.
</p>
</li>
<li> <p><code>sebeta</code>: The standard error of parameter estimate.
</p>
</li>
<li> <p><code>z</code>: The Wald test statistic for the parameter.
</p>
</li>
<li> <p><code>expbeta</code>: The exponentiated parameter estimate.
</p>
</li>
<li> <p><code>vbeta</code>: The covariance matrix for parameter estimates.
</p>
</li>
<li> <p><code>lower</code>: The lower limit of confidence interval.
</p>
</li>
<li> <p><code>upper</code>: The upper limit of confidence interval.
</p>
</li>
<li> <p><code>p</code>: The p-value from the chi-square test.
</p>
</li>
<li> <p><code>method</code>: The method to compute the confidence interval and
p-value.
</p>
</li>
<li> <p><code>sebeta_naive</code>: The naive standard error of parameter estimate.
</p>
</li>
<li> <p><code>vbeta_naive</code>: The naive covariance matrix of parameter
estimates.
</p>
</li>
<li> <p><code>rep</code>: The replication.
</p>
</li></ul>

</li>
<li> <p><code>fitted</code>: The data frame with the following variables:
</p>

<ul>
<li> <p><code>linear_predictors</code>: The linear fit on the link function scale.
</p>
</li>
<li> <p><code>fitted_values</code>: The fitted probabilities of having an event,
obtained by transforming the linear predictors by the inverse of
the link function.
</p>
</li>
<li> <p><code>rep</code>: The replication.
</p>
</li></ul>

</li>
<li> <p><code>p</code>: The number of parameters.
</p>
</li>
<li> <p><code>link</code>: The link function.
</p>
</li>
<li> <p><code>param</code>: The parameter names.
</p>
</li>
<li> <p><code>beta</code>: The parameter estimate.
</p>
</li>
<li> <p><code>vbeta</code>: The covariance matrix for parameter estimates.
</p>
</li>
<li> <p><code>vbeta_naive</code>: The naive covariance matrix for parameter estimates.
</p>
</li>
<li> <p><code>linear_predictors</code>: The linear fit on the link function scale.
</p>
</li>
<li> <p><code>fitted_values</code>: The fitted probabilities of having an event.
</p>
</li>
<li> <p><code>terms</code>: The terms object.
</p>
</li>
<li> <p><code>xlevels</code>: A record of the levels of the factors used in fitting.
</p>
</li>
<li> <p><code>data</code>: The input data.
</p>
</li>
<li> <p><code>rep</code>: The name(s) of the replication variable(s).
</p>
</li>
<li> <p><code>event</code>: The name of the event variable.
</p>
</li>
<li> <p><code>covariates</code>: The names of baseline covariates.
</p>
</li>
<li> <p><code>freq</code>: The name of the freq variable.
</p>
</li>
<li> <p><code>weight</code>: The name of the weight variable.
</p>
</li>
<li> <p><code>offset</code>: The name of the offset variable.
</p>
</li>
<li> <p><code>id</code>: The name of the id variable.
</p>
</li>
<li> <p><code>robust</code>: Whether a robust sandwich variance estimate should be
computed.
</p>
</li>
<li> <p><code>bc</code>: Whether to apply firth's bias correction for noncanonical
parameterization and weighted logistic regression.
</p>
</li>
<li> <p><code>firth</code>: Whether to use the firth's bias reducing penalized
likelihood.
</p>
</li>
<li> <p><code>flic</code>: Whether to apply intercept correction.
</p>
</li>
<li> <p><code>plci</code>: Whether to obtain profile likelihood confidence interval.
</p>
</li>
<li> <p><code>alpha</code>: The two-sided significance level.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>References</h3>

<p>David Firth.
Bias Reduction of Maximum Likelihood Estimates.
Biometrika 1993; 80:27–38.
</p>
<p>Georg Heinze and Michael Schemper.
A solution to the problem of separation in logistic regression.
Statistics in Medicine 2002;21:2409–2419.
</p>
<p>Rainer Puhr, Georg Heinze, Mariana Nold, Lara Lusa, and
Angelika Geroldinger.
Firth's logistic regression with rare events: accurate effect
estimates and predictions?
Statistics in Medicine 2017; 36:2302-2317.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
(fit1 &lt;- logisregr(
  ingots, event = "NotReady", covariates = "Heat*Soak", freq = "Freq"))

</code></pre>

<hr>
<h2 id='lrtest'>Log-Rank Test of Survival Curve Difference</h2><span id='topic+lrtest'></span>

<h3>Description</h3>

<p>Obtains the log-rank test using the Fleming-Harrington
family of weights.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>lrtest(
  data,
  rep = "",
  stratum = "",
  treat = "treat",
  time = "time",
  event = "event",
  rho1 = 0,
  rho2 = 0
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="lrtest_+3A_data">data</code></td>
<td>
<p>The input data frame that contains the following variables:
</p>

<ul>
<li> <p><code>rep</code>: The replication for by-group processing.
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>treat</code>: The treatment.
</p>
</li>
<li> <p><code>time</code>: The possibly right-censored survival time.
</p>
</li>
<li> <p><code>event</code>: The event indicator.
</p>
</li></ul>
</td></tr>
<tr><td><code id="lrtest_+3A_rep">rep</code></td>
<td>
<p>The name of the replication variable in the input data.</p>
</td></tr>
<tr><td><code id="lrtest_+3A_stratum">stratum</code></td>
<td>
<p>The name of the stratum variable in the input data.</p>
</td></tr>
<tr><td><code id="lrtest_+3A_treat">treat</code></td>
<td>
<p>The name of the treatment variable in the input data.</p>
</td></tr>
<tr><td><code id="lrtest_+3A_time">time</code></td>
<td>
<p>The name of the time variable in the input data.</p>
</td></tr>
<tr><td><code id="lrtest_+3A_event">event</code></td>
<td>
<p>The name of the event variable in the input data.</p>
</td></tr>
<tr><td><code id="lrtest_+3A_rho1">rho1</code></td>
<td>
<p>The first parameter of the Fleming-Harrington family of
weighted log-rank test. Defaults to 0 for conventional log-rank test.</p>
</td></tr>
<tr><td><code id="lrtest_+3A_rho2">rho2</code></td>
<td>
<p>The second parameter of the Fleming-Harrington family of
weighted log-rank test. Defaults to 0 for conventional log-rank test.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame with the following variables:
</p>

<ul>
<li> <p><code>uscore</code>: The numerator of the log-rank test statistic.
</p>
</li>
<li> <p><code>vscore</code>: The variance of the log-rank score test statistic.
</p>
</li>
<li> <p><code>logRankZ</code>: The Z-statistic value.
</p>
</li>
<li> <p><code>logRankPValue</code>: The one-sided p-value.
</p>
</li>
<li> <p><code>rho1</code>: The first parameter of the Fleming-Harrington weights.
</p>
</li>
<li> <p><code>rho2</code>: The second parameter of the Fleming-Harrington weights.
</p>
</li>
<li> <p><code>rep</code>: The replication.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
df &lt;- lrtest(data = rawdata, rep = "iterationNumber",
             stratum = "stratum", treat = "treatmentGroup",
             time = "timeUnderObservation", event = "event",
             rho1 = 0.5, rho2 = 0)
head(df)

</code></pre>

<hr>
<h2 id='nscpp'>Natural Cubic Spline Basis</h2><span id='topic+nscpp'></span>

<h3>Description</h3>

<p>Computes the B-spline basis matrix for a natural cubic
spline.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>nscpp(
  x = NA_real_,
  df = NA_integer_,
  knots = NA_real_,
  intercept = 0L,
  boundary_knots = NA_real_
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="nscpp_+3A_x">x</code></td>
<td>
<p>A numeric vector representing the predictor variable.
Missing values are allowed.</p>
</td></tr>
<tr><td><code id="nscpp_+3A_df">df</code></td>
<td>
<p>Degrees of freedom, specifying the number of columns in
the basis matrix. If <code>df</code> is provided, the function selects
<code>df - 1 - intercept</code> internal knots based on appropriate
quantiles of <code>x</code>, ignoring any missing values.</p>
</td></tr>
<tr><td><code id="nscpp_+3A_knots">knots</code></td>
<td>
<p>A numeric vector specifying the internal breakpoints
that define the spline. If provided, the number of degrees of
freedom will be determined by the length of <code>knots</code>.</p>
</td></tr>
<tr><td><code id="nscpp_+3A_intercept">intercept</code></td>
<td>
<p>A logical value indicating whether to include an
intercept in the basis. The default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="nscpp_+3A_boundary_knots">boundary_knots</code></td>
<td>
<p>A numeric vector of length 2 specifying the
boundary points where the natural boundary conditions are applied
and the B-spline basis is anchored. If not supplied, the default
is the range of non-missing values in <code>x</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A matrix with dimensions <code>c(length(x), df)</code>, where
<code>df</code> is either provided directly or computed as
<code>length(knots) + 1 + intercept</code> when <code>knots</code> are supplied.
The matrix contains attributes that correspond to the arguments
passed to the <code>nscpp</code> function.
</p>


<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
nscpp(women$height, df = 5)

</code></pre>

<hr>
<h2 id='phregr'>Proportional Hazards Regression Models</h2><span id='topic+phregr'></span>

<h3>Description</h3>

<p>Obtains the hazard ratio estimates from the proportional
hazards regression model with right censored or counting process data.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>phregr(
  data,
  rep = "",
  stratum = "",
  time = "time",
  time2 = "",
  event = "event",
  covariates = "",
  weight = "",
  offset = "",
  id = "",
  ties = "efron",
  robust = FALSE,
  est_basehaz = TRUE,
  est_resid = TRUE,
  firth = FALSE,
  plci = FALSE,
  alpha = 0.05
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="phregr_+3A_data">data</code></td>
<td>
<p>The input data frame that contains the following variables:
</p>

<ul>
<li> <p><code>rep</code>: The replication for by-group processing.
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>time</code>: The follow-up time for right censored data, or
the left end of each interval for counting process data.
</p>
</li>
<li> <p><code>time2</code>: The right end of each interval for counting process
data. Intervals are assumed to be open on the left
and closed on the right, and event indicates whether an event
occurred at the right end of each interval.
</p>
</li>
<li> <p><code>event</code>: The event indicator, 1=event, 0=no event.
</p>
</li>
<li> <p><code>covariates</code>: The values of baseline covariates (and
time-dependent covariates in each interval for counting
process data).
</p>
</li>
<li> <p><code>weight</code>: The weight for each observation.
</p>
</li>
<li> <p><code>offset</code>: The offset for each observation.
</p>
</li>
<li> <p><code>id</code>: The optional subject ID for counting process data
with time-dependent covariates.
</p>
</li></ul>
</td></tr>
<tr><td><code id="phregr_+3A_rep">rep</code></td>
<td>
<p>The name(s) of the replication variable(s) in the input data.</p>
</td></tr>
<tr><td><code id="phregr_+3A_stratum">stratum</code></td>
<td>
<p>The name(s) of the stratum variable(s) in the input data.</p>
</td></tr>
<tr><td><code id="phregr_+3A_time">time</code></td>
<td>
<p>The name of the time variable or the left end of each
interval for counting process data in the input data.</p>
</td></tr>
<tr><td><code id="phregr_+3A_time2">time2</code></td>
<td>
<p>The name of the right end of each interval for counting
process data in the input data.</p>
</td></tr>
<tr><td><code id="phregr_+3A_event">event</code></td>
<td>
<p>The name of the event variable in the input data.</p>
</td></tr>
<tr><td><code id="phregr_+3A_covariates">covariates</code></td>
<td>
<p>The vector of names of baseline and time-dependent
covariates in the input data.</p>
</td></tr>
<tr><td><code id="phregr_+3A_weight">weight</code></td>
<td>
<p>The name of the weight variable in the input data.</p>
</td></tr>
<tr><td><code id="phregr_+3A_offset">offset</code></td>
<td>
<p>The name of the offset variable in the input data.</p>
</td></tr>
<tr><td><code id="phregr_+3A_id">id</code></td>
<td>
<p>The name of the id variable in the input data.</p>
</td></tr>
<tr><td><code id="phregr_+3A_ties">ties</code></td>
<td>
<p>The method for handling ties, either &quot;breslow&quot; or
&quot;efron&quot; (default).</p>
</td></tr>
<tr><td><code id="phregr_+3A_robust">robust</code></td>
<td>
<p>Whether a robust sandwich variance estimate should be
computed. In the presence of the id variable, the score residuals
will be aggregated for each id when computing the robust sandwich
variance estimate.</p>
</td></tr>
<tr><td><code id="phregr_+3A_est_basehaz">est_basehaz</code></td>
<td>
<p>Whether to estimate the baseline hazards.
Defaults to <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="phregr_+3A_est_resid">est_resid</code></td>
<td>
<p>Whether to estimate the martingale residuals.
Defaults to <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="phregr_+3A_firth">firth</code></td>
<td>
<p>Whether to use Firth’s penalized likelihood method.
Defaults to <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="phregr_+3A_plci">plci</code></td>
<td>
<p>Whether to obtain profile likelihood confidence interval.</p>
</td></tr>
<tr><td><code id="phregr_+3A_alpha">alpha</code></td>
<td>
<p>The two-sided significance level.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list with the following components:
</p>

<ul>
<li> <p><code>sumstat</code>: The data frame of summary statistics of model fit
with the following variables:
</p>

<ul>
<li> <p><code>n</code>: The number of observations.
</p>
</li>
<li> <p><code>nevents</code>: The number of events.
</p>
</li>
<li> <p><code>loglik0</code>: The (penalized) log-likelihood under null.
</p>
</li>
<li> <p><code>loglik1</code>: The maximum (penalized) log-likelihood.
</p>
</li>
<li> <p><code>scoretest</code>: The score test statistic.
</p>
</li>
<li> <p><code>niter</code>: The number of Newton-Raphson iterations.
</p>
</li>
<li> <p><code>ties</code>: The method for handling ties, either &quot;breslow&quot; or
&quot;efron&quot;.
</p>
</li>
<li> <p><code>p</code>: The number of columns of the Cox model design matrix.
</p>
</li>
<li> <p><code>robust</code>: Whether to use the robust variance estimate.
</p>
</li>
<li> <p><code>firth</code>: Whether to use Firth's penalized likelihood method.
</p>
</li>
<li> <p><code>loglik0_unpenalized</code>: The unpenalized log-likelihood under null.
</p>
</li>
<li> <p><code>loglik1_unpenalized</code>: The maximum unpenalized log-likelihood.
</p>
</li>
<li> <p><code>rep</code>: The replication.
</p>
</li></ul>

</li>
<li> <p><code>parest</code>: The data frame of parameter estimates with the
following variables:
</p>

<ul>
<li> <p><code>param</code>: The name of the covariate for the parameter estimate.
</p>
</li>
<li> <p><code>beta</code>: The log hazard ratio estimate.
</p>
</li>
<li> <p><code>sebeta</code>: The standard error of log hazard ratio estimate.
</p>
</li>
<li> <p><code>z</code>: The Wald test statistic for log hazard ratio.
</p>
</li>
<li> <p><code>expbeta</code>: The hazard ratio estimate.
</p>
</li>
<li> <p><code>vbeta</code>: The covariance matrix for parameter estimates.
</p>
</li>
<li> <p><code>lower</code>: The lower limit of confidence interval.
</p>
</li>
<li> <p><code>upper</code>: The upper limit of confidence interval.
</p>
</li>
<li> <p><code>p</code>: The p-value from the chi-square test.
</p>
</li>
<li> <p><code>method</code>: The method to compute the confidence interval and
p-value.
</p>
</li>
<li> <p><code>sebeta_naive</code>: The naive standard error of log hazard ratio
estimate if robust variance is requested.
</p>
</li>
<li> <p><code>vbeta_naive</code>: The naive covariance matrix for parameter
estimates if robust variance is requested.
</p>
</li>
<li> <p><code>rep</code>: The replication.
</p>
</li></ul>

</li>
<li> <p><code>basehaz</code>: The data frame of baseline hazards with the following
variables (if est_basehaz is TRUE):
</p>

<ul>
<li> <p><code>time</code>: The observed event time.
</p>
</li>
<li> <p><code>nrisk</code>: The number of patients at risk at the time point.
</p>
</li>
<li> <p><code>nevent</code>: The number of events at the time point.
</p>
</li>
<li> <p><code>haz</code>: The baseline hazard at the time point.
</p>
</li>
<li> <p><code>varhaz</code>: The variance of the baseline hazard at the time point
assuming the parameter beta is known.
</p>
</li>
<li> <p><code>gradhaz</code>: The gradient of the baseline hazard with respect to
beta at the time point (in the presence of covariates).
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>rep</code>: The replication.
</p>
</li></ul>

</li>
<li> <p><code>residuals</code>: The martingale residuals.
</p>
</li>
<li> <p><code>p</code>: The number of parameters.
</p>
</li>
<li> <p><code>param</code>: The parameter names.
</p>
</li>
<li> <p><code>beta</code>: The parameter estimate.
</p>
</li>
<li> <p><code>vbeta</code>: The covariance matrix for parameter estimates.
</p>
</li>
<li> <p><code>vbeta_naive</code>: The naive covariance matrix for parameter estimates.
</p>
</li>
<li> <p><code>terms</code>: The terms object.
</p>
</li>
<li> <p><code>xlevels</code>: A record of the levels of the factors used in fitting.
</p>
</li>
<li> <p><code>data</code>: The input data.
</p>
</li>
<li> <p><code>rep</code>: The name(s) of the replication variable(s).
</p>
</li>
<li> <p><code>stratum</code>: The name(s) of the stratum variable(s).
</p>
</li>
<li> <p><code>time</code>: The name of the time varaible.
</p>
</li>
<li> <p><code>time2</code>: The name of the time2 variable.
</p>
</li>
<li> <p><code>event</code>: The name of the event variable.
</p>
</li>
<li> <p><code>covariates</code>: The names of baseline covariates.
</p>
</li>
<li> <p><code>weight</code>: The name of the weight variable.
</p>
</li>
<li> <p><code>offset</code>: The name of the offset variable.
</p>
</li>
<li> <p><code>id</code>: The name of the id variable.
</p>
</li>
<li> <p><code>ties</code>: The method for handling ties.
</p>
</li>
<li> <p><code>robust</code>: Whether a robust sandwich variance estimate should be
computed.
</p>
</li>
<li> <p><code>est_basehaz</code>: Whether to estimate the baseline hazards.
</p>
</li>
<li> <p><code>est_resid</code>: Whether to estimate the martingale residuals.
</p>
</li>
<li> <p><code>firth</code>: Whether to use Firth's penalized likelihood method.
</p>
</li>
<li> <p><code>plci</code>: Whether to obtain profile likelihood confidence interval.
</p>
</li>
<li> <p><code>alpha</code>: The two-sided significance level.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>References</h3>

<p>Per K. Anderson and Richard D. Gill.
Cox's regression model for counting processes, a large sample study.
Annals of Statistics 1982; 10:1100-1120.
</p>
<p>Terry M. Therneau and Patricia M. Grambsch.
Modeling Survival Data: Extending the Cox Model.
Springer-Verlag, 2000.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
library(dplyr)

# Example 1 with right-censored data
(fit1 &lt;- phregr(
  data = rawdata %&gt;% mutate(treat = 1*(treatmentGroup == 1)),
  rep = "iterationNumber", stratum = "stratum",
  time = "timeUnderObservation", event = "event",
  covariates = "treat", est_basehaz = FALSE, est_resid = FALSE))

# Example 2 with counting process data and robust variance estimate
(fit2 &lt;- phregr(
  data = heart %&gt;% mutate(rx = as.numeric(transplant) - 1),
  time = "start", time2 = "stop", event = "event",
  covariates = c("rx", "age"), id = "id",
  robust = TRUE, est_basehaz = TRUE, est_resid = TRUE))

</code></pre>

<hr>
<h2 id='print.liferegr'>Print liferegr Object</h2><span id='topic+print.liferegr'></span>

<h3>Description</h3>

<p>Prints the concise information of liferegr fit.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'liferegr'
print(x, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="print.liferegr_+3A_x">x</code></td>
<td>
<p>The liferegr object to print.</p>
</td></tr>
<tr><td><code id="print.liferegr_+3A_...">...</code></td>
<td>
<p>Ensures that all arguments starting from &quot;...&quot; are named.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A printout from the fit of an accelerated failue time model.
</p>


<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>

<hr>
<h2 id='print.logisregr'>Print logisregr Object</h2><span id='topic+print.logisregr'></span>

<h3>Description</h3>

<p>Prints the concise information of logisregr fit.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'logisregr'
print(x, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="print.logisregr_+3A_x">x</code></td>
<td>
<p>The logisregr object to print.</p>
</td></tr>
<tr><td><code id="print.logisregr_+3A_...">...</code></td>
<td>
<p>Ensures that all arguments starting from &quot;...&quot; are named.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A printout from the fit of a logistic regression model.
</p>


<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>

<hr>
<h2 id='print.phregr'>Print phregr Object</h2><span id='topic+print.phregr'></span>

<h3>Description</h3>

<p>Prints the concise information of phregr fit.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'phregr'
print(x, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="print.phregr_+3A_x">x</code></td>
<td>
<p>The phregr object to print.</p>
</td></tr>
<tr><td><code id="print.phregr_+3A_...">...</code></td>
<td>
<p>Ensures that all arguments starting from &quot;...&quot; are named.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A printout from the fit of a Cox proportional hazards model.
</p>


<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>

<hr>
<h2 id='qrcpp'>QR Decomposition of a Matrix</h2><span id='topic+qrcpp'></span>

<h3>Description</h3>

<p>Computes the QR decomposition of a matrix.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>qrcpp(X, tol = 1e-12)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="qrcpp_+3A_x">X</code></td>
<td>
<p>A numeric matrix whose QR decomposition is to be computed.</p>
</td></tr>
<tr><td><code id="qrcpp_+3A_tol">tol</code></td>
<td>
<p>The tolerance for detecting linear dependencies in the
columns of <code>X</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function performs Householder QR with column pivoting:
Given an <code class="reqn">m</code>-by-<code class="reqn">n</code> matrix <code class="reqn">A</code> with <code class="reqn">m \geq n</code>,
the following algorithm computes <code class="reqn">r = \textrm{rank}(A)</code> and
the factorization <code class="reqn">Q^T A P</code> equal to
</p>

<table>
<tr>
 <td style="text-align: center;">
| </td><td style="text-align: center;"> <code class="reqn">R_{11}</code> </td><td style="text-align: center;"> <code class="reqn">R_{12}</code> </td><td style="text-align: center;"> | </td><td style="text-align: center;"> <code class="reqn">r</code> </td>
</tr>
<tr>
 <td style="text-align: center;">
| </td><td style="text-align: center;"> 0 </td><td style="text-align: center;"> 0 </td><td style="text-align: center;"> | </td><td style="text-align: center;"> <code class="reqn">m-r</code> </td>
</tr>
<tr>
 <td style="text-align: center;">
</td><td style="text-align: center;"> <code class="reqn">r</code> </td><td style="text-align: center;"> <code class="reqn">n-r</code> </td><td style="text-align: center;"> </td><td style="text-align: center;">
</td>
</tr>

</table>

<p>with <code class="reqn">Q = H_1 \cdots H_r</code> and <code class="reqn">P = P_1 \cdots P_r</code>.
The upper triangular part of <code class="reqn">A</code>
is overwritten by the upper triangular part of <code class="reqn">R</code> and
components <code class="reqn">(j+1):m</code> of
the <code class="reqn">j</code>th Householder vector are stored in <code class="reqn">A((j+1):m, j)</code>.
The permutation <code class="reqn">P</code> is encoded in an integer vector <code>pivot</code>.
</p>


<h3>Value</h3>

<p>A list with the following components:
</p>

<ul>
<li> <p><code>qr</code>: A matrix with the same dimensions as <code>X</code>. The upper
triangle contains the <code>R</code> of the decomposition and the lower
triangle contains Householder vectors (stored in compact form).
</p>
</li>
<li> <p><code>rank</code>: The rank of <code>X</code> as computed by the decomposition.
</p>
</li>
<li> <p><code>pivot</code>: The column permutation for the pivoting strategy used
during the decomposition.
</p>
</li>
<li> <p><code>Q</code>: The complete <code class="reqn">m</code>-by-<code class="reqn">m</code> orthogonal matrix <code class="reqn">Q</code>.
</p>
</li>
<li> <p><code>R</code>: The complete <code class="reqn">m</code>-by-<code class="reqn">n</code> upper triangular
matrix <code class="reqn">R</code>.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>References</h3>

<p>Gene N. Golub and Charles F. Van Loan.
Matrix Computations, second edition. Baltimore, Maryland:
The John Hopkins University Press, 1989, p.235.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
hilbert &lt;- function(n) { i &lt;- 1:n; 1 / outer(i - 1, i, `+`) }
h9 &lt;- hilbert(9)
qrcpp(h9)

</code></pre>

<hr>
<h2 id='rawdata'>A simulated time-to-event data set with 10 replications</h2><span id='topic+rawdata'></span>

<h3>Description</h3>

<p>A simulated data set with stratification and delayed treatment effect:
</p>

<dl>
<dt><code>iterationNumber</code></dt><dd><p>The iteration number</p>
</dd>
<dt><code>arrivalTime</code></dt><dd><p>The enrollment time for the subject</p>
</dd>
<dt><code>stratum</code></dt><dd><p>The stratum for the subject</p>
</dd>
<dt><code>treatmentGroup</code></dt><dd><p>The treatment group for the subject</p>
</dd>
<dt><code>timeUnderObservation</code></dt><dd><p>The time under observation since
randomization</p>
</dd>
<dt><code>event</code></dt><dd><p>Whether the subject experienced the event</p>
</dd>
<dt><code>dropoutEvent</code></dt><dd><p>Whether the subject dropped out</p>
</dd>
</dl>



<h3>Usage</h3>

<pre><code class='language-R'>rawdata
</code></pre>


<h3>Format</h3>

<p>An object of class <code>data.frame</code> with 4910 rows and 7 columns.
</p>

<hr>
<h2 id='residuals_phregr'>Residuals for Proportional Hazards Regression Models</h2><span id='topic+residuals_phregr'></span>

<h3>Description</h3>

<p>Obtains the martingale, deviance, score, or Schoenfeld
residuals for a proportional hazards regression model.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>residuals_phregr(
  fit_phregr,
  type = c("martingale", "deviance", "score", "schoenfeld", "dfbeta", "dfbetas",
    "scaledsch"),
  collapse = FALSE,
  weighted = (type %in% c("dfbeta", "dfbetas"))
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="residuals_phregr_+3A_fit_phregr">fit_phregr</code></td>
<td>
<p>The output from the <code>phregr</code> call.</p>
</td></tr>
<tr><td><code id="residuals_phregr_+3A_type">type</code></td>
<td>
<p>The type of residuals desired, with options including
<code>"martingale"</code>, <code>"deviance"</code>, <code>"score"</code>,
<code>"schoenfeld"</code>, <code>"dfbeta"</code>, <code>"dfbetas"</code>, and
<code>"scaledsch"</code>.</p>
</td></tr>
<tr><td><code id="residuals_phregr_+3A_collapse">collapse</code></td>
<td>
<p>Whether to collapse the residuals by <code>id</code>.
This is not applicable for Schoenfeld type residuals.</p>
</td></tr>
<tr><td><code id="residuals_phregr_+3A_weighted">weighted</code></td>
<td>
<p>Whether to compute weighted residuals.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>For score and Schoenfeld type residuals, the proportional hazards model
must include at least one covariate. The algorithms for <code>deviance</code>,
<code>dfbeta</code>, <code>dfbetas</code>, and <code>scaledsch</code> residuals follow
the <code>residuals.coxph</code> function in the <code>survival</code> package.
</p>


<h3>Value</h3>

<p>For martingale and deviance residuals, the result is a vector
with one element corresponding to each subject (without <code>collapse</code>).
For score residuals, the result is a matrix where each row represents
a subject and each column corresponds to a variable. The row order
aligns with the input data used in the original fit. For Schoenfeld
residuals, the result is a matrix with one row for each event and
one column per variable. These rows are sorted by time within strata,
with the attributes <code>stratum</code> and <code>time</code> included.
</p>
<p>Score residuals represent each individual's contribution to the score
vector. Two commonly used transformations of this are <code>dfbeta</code>,
which represents the approximate change in the coefficient vector
if the observation is excluded, and <code>dfbetas</code>, which gives the
approximate change in the coefficients scaled by the standard error
of the coefficients.
</p>


<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>References</h3>

<p>Terry M. Therneau, Patricia M. Grambsch, and Thomas M. Fleming.
Martingale based residuals for survival models.
Biometrika 1990; 77:147-160.
</p>
<p>Patricia M. Grambsch and Terry M. Therneau.
Proportional hazards tests and diagnostics based on weighted residuals.
Biometrika 1994; 81:515-26.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
library(dplyr)

# Example 1 with right-censored data
fit1 &lt;- phregr(data = rawdata %&gt;% filter(iterationNumber == 1) %&gt;%
                 mutate(treat = 1*(treatmentGroup == 1)),
               stratum = "stratum",
               time = "timeUnderObservation", event = "event",
               covariates = "treat")

ressco &lt;- residuals_phregr(fit1, type = "score")

# Example 2 with counting process data
fit2 &lt;- phregr(data = heart %&gt;% mutate(rx = as.numeric(transplant) - 1),
               time = "start", time2 = "stop", event = "event",
               covariates = c("rx", "age"), id = "id", robust = TRUE)

resssch &lt;- residuals_phregr(fit2, type = "scaledsch")

</code></pre>

<hr>
<h2 id='rmdiff'>Estimate of Restricted Mean Survival Time Difference</h2><span id='topic+rmdiff'></span>

<h3>Description</h3>

<p>Obtains the estimate of restricted mean survival time
difference between two treatment groups.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>rmdiff(
  data,
  rep = "",
  stratum = "",
  treat = "treat",
  time = "time",
  event = "event",
  milestone = NA_real_,
  rmstDiffH0 = 0,
  conflev = 0.95,
  biascorrection = 0L
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="rmdiff_+3A_data">data</code></td>
<td>
<p>The input data frame that contains the following variables:
</p>

<ul>
<li> <p><code>rep</code>: The replication for by-group processing.
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>treat</code>: The treatment.
</p>
</li>
<li> <p><code>time</code>: The possibly right-censored survival time.
</p>
</li>
<li> <p><code>event</code>: The event indicator.
</p>
</li></ul>
</td></tr>
<tr><td><code id="rmdiff_+3A_rep">rep</code></td>
<td>
<p>The name of the replication variable in the input data.</p>
</td></tr>
<tr><td><code id="rmdiff_+3A_stratum">stratum</code></td>
<td>
<p>The name of the stratum variable in the input data.</p>
</td></tr>
<tr><td><code id="rmdiff_+3A_treat">treat</code></td>
<td>
<p>The name of the treatment variable in the input data.</p>
</td></tr>
<tr><td><code id="rmdiff_+3A_time">time</code></td>
<td>
<p>The name of the time variable in the input data.</p>
</td></tr>
<tr><td><code id="rmdiff_+3A_event">event</code></td>
<td>
<p>The name of the event variable in the input data.</p>
</td></tr>
<tr><td><code id="rmdiff_+3A_milestone">milestone</code></td>
<td>
<p>The milestone time at which to calculate the
restricted mean survival time.</p>
</td></tr>
<tr><td><code id="rmdiff_+3A_rmstdiffh0">rmstDiffH0</code></td>
<td>
<p>The difference in restricted mean survival times
under the null hypothesis. Defaults to 0 for superiority test.</p>
</td></tr>
<tr><td><code id="rmdiff_+3A_conflev">conflev</code></td>
<td>
<p>The level of the two-sided confidence interval for
the difference in restricted mean survival times. Defaults to 0.95.</p>
</td></tr>
<tr><td><code id="rmdiff_+3A_biascorrection">biascorrection</code></td>
<td>
<p>Whether to apply bias correction for the
variance estimate of individual restricted mean survival times.
Defaults to no bias correction.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame with the following variables:
</p>

<ul>
<li> <p><code>rep</code>: The replication number.
</p>
</li>
<li> <p><code>milestone</code>: The milestone time relative to randomization.
</p>
</li>
<li> <p><code>rmstDiffH0</code>: The difference in restricted mean survival times
under the null hypothesis.
</p>
</li>
<li> <p><code>rmst1</code>: The estimated restricted mean survival time for
the treatment group.
</p>
</li>
<li> <p><code>rmst2</code>: The estimated restricted mean survival time for
the control group.
</p>
</li>
<li> <p><code>rmstDiff</code>: The estimated difference in restricted mean
survival times.
</p>
</li>
<li> <p><code>vrmst1</code>: The variance for rmst1.
</p>
</li>
<li> <p><code>vrmst2</code>: The variance for rmst2.
</p>
</li>
<li> <p><code>vrmstDiff</code>: The variance for rmstDiff.
</p>
</li>
<li> <p><code>rmstDiffZ</code>: The Z-statistic value.
</p>
</li>
<li> <p><code>rmstDiffPValue</code>: The one-sided p-value.
</p>
</li>
<li> <p><code>lower</code>: The lower bound of confidence interval.
</p>
</li>
<li> <p><code>upper</code>: The upper bound of confidence interval.
</p>
</li>
<li> <p><code>conflev</code>: The level of confidence interval.
</p>
</li>
<li> <p><code>biascorrection</code>: Whether to apply bias correction for the
variance estimate of individual restricted mean survival times.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
df &lt;- rmdiff(data = rawdata, rep = "iterationNumber",
             stratum = "stratum", treat = "treatmentGroup",
             time = "timeUnderObservation", event = "event",
             milestone = 12)
head(df)

</code></pre>

<hr>
<h2 id='rmest'>Estimate of Restricted Mean Survival Time</h2><span id='topic+rmest'></span>

<h3>Description</h3>

<p>Obtains the estimate of restricted means survival time
for each stratum.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>rmest(
  data,
  rep = "",
  stratum = "",
  time = "time",
  event = "event",
  milestone = NA_real_,
  conflev = 0.95,
  biascorrection = 0L
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="rmest_+3A_data">data</code></td>
<td>
<p>The input data frame that contains the following variables:
</p>

<ul>
<li> <p><code>rep</code>: The replication for by-group processing.
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>time</code>: The possibly right-censored survival time.
</p>
</li>
<li> <p><code>event</code>: The event indicator.
</p>
</li></ul>
</td></tr>
<tr><td><code id="rmest_+3A_rep">rep</code></td>
<td>
<p>The name of the replication variable in the input data.</p>
</td></tr>
<tr><td><code id="rmest_+3A_stratum">stratum</code></td>
<td>
<p>The name of the stratum variable in the input data.</p>
</td></tr>
<tr><td><code id="rmest_+3A_time">time</code></td>
<td>
<p>The name of the time variable in the input data.</p>
</td></tr>
<tr><td><code id="rmest_+3A_event">event</code></td>
<td>
<p>The name of the event variable in the input data.</p>
</td></tr>
<tr><td><code id="rmest_+3A_milestone">milestone</code></td>
<td>
<p>The milestone time at which to calculate the
restricted mean survival time.</p>
</td></tr>
<tr><td><code id="rmest_+3A_conflev">conflev</code></td>
<td>
<p>The level of the two-sided confidence interval for
the survival probabilities. Defaults to 0.95.</p>
</td></tr>
<tr><td><code id="rmest_+3A_biascorrection">biascorrection</code></td>
<td>
<p>Whether to apply bias correction for the
variance estimate. Defaults to no bias correction.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame with the following variables:
</p>

<ul>
<li> <p><code>rep</code>: The replication.
</p>
</li>
<li> <p><code>stratum</code>: The stratum variable.
</p>
</li>
<li> <p><code>size</code>: The number of subjects in the stratum.
</p>
</li>
<li> <p><code>milestone</code>: The milestone time relative to randomization.
</p>
</li>
<li> <p><code>rmst</code>: The estimate of restricted mean survival time.
</p>
</li>
<li> <p><code>stderr</code>: The standard error of the estimated rmst.
</p>
</li>
<li> <p><code>lower</code>: The lower bound of confidence interval if requested.
</p>
</li>
<li> <p><code>upper</code>: The upper bound of confidence interval if requested.
</p>
</li>
<li> <p><code>conflev</code>: The level of confidence interval if requested.
</p>
</li>
<li> <p><code>biascorrection</code>: Whether to apply bias correction for the
variance estimate.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
rmest(data = aml, stratum = "x",
      time = "time", event = "status", milestone = 24)

</code></pre>

<hr>
<h2 id='rpsftm'>Rank Preserving Structural Failure Time Model (RPSFTM) for
Treatment Switching</h2><span id='topic+rpsftm'></span>

<h3>Description</h3>

<p>Obtains the causal parameter estimate from the
log-rank test and the hazard ratio estimate from the Cox model
to adjust for treatment switching.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>rpsftm(
  data,
  id = "id",
  stratum = "",
  time = "time",
  event = "event",
  treat = "treat",
  rx = "rx",
  censor_time = "censor_time",
  base_cov = "",
  low_psi = -1,
  hi_psi = 1,
  n_eval_z = 100,
  treat_modifier = 1,
  recensor = TRUE,
  admin_recensor_only = TRUE,
  autoswitch = TRUE,
  gridsearch = FALSE,
  alpha = 0.05,
  ties = "efron",
  tol = 1e-06,
  boot = FALSE,
  n_boot = 1000,
  seed = NA
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="rpsftm_+3A_data">data</code></td>
<td>
<p>The input data frame that contains the following variables:
</p>

<ul>
<li> <p><code>id</code>: The subject id.
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>time</code>: The survival time for right censored data.
</p>
</li>
<li> <p><code>event</code>: The event indicator, 1=event, 0=no event.
</p>
</li>
<li> <p><code>treat</code>: The randomized treatment indicator, 1=treatment,
0=control.
</p>
</li>
<li> <p><code>rx</code>: The proportion of time on active treatment.
</p>
</li>
<li> <p><code>censor_time</code>: The administrative censoring time. It should
be provided for all subjects including those who had events.
</p>
</li>
<li> <p><code>base_cov</code>: The baseline covariates (excluding treat).
</p>
</li></ul>
</td></tr>
<tr><td><code id="rpsftm_+3A_id">id</code></td>
<td>
<p>The name of the id variable in the input data.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_stratum">stratum</code></td>
<td>
<p>The name(s) of the stratum variable(s) in the input data.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_time">time</code></td>
<td>
<p>The name of the time variable in the input data.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_event">event</code></td>
<td>
<p>The name of the event variable in the input data.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_treat">treat</code></td>
<td>
<p>The name of the treatment variable in the input data.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_rx">rx</code></td>
<td>
<p>The name of the rx variable in the input data.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_censor_time">censor_time</code></td>
<td>
<p>The name of the censor_time variable in the input data.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_base_cov">base_cov</code></td>
<td>
<p>The names of baseline covariates (excluding
treat) in the input data for the outcome Cox model.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_low_psi">low_psi</code></td>
<td>
<p>The lower limit of the causal parameter.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_hi_psi">hi_psi</code></td>
<td>
<p>The upper limit of the causal parameter.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_n_eval_z">n_eval_z</code></td>
<td>
<p>The number of points between <code>low_psi</code> and
<code>hi_psi</code> (inclusive) at which to evaluate the log-rank
Z-statistics.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_treat_modifier">treat_modifier</code></td>
<td>
<p>The optional sensitivity parameter for the
constant treatment effect assumption.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_recensor">recensor</code></td>
<td>
<p>Whether to apply recensoring to counterfactual
survival times. Defaults to <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_admin_recensor_only">admin_recensor_only</code></td>
<td>
<p>Whether to apply recensoring to administrative
censoring times only. Defaults to <code>TRUE</code>. If <code>FALSE</code>,
recensoring will be applied to the actual censoring times for dropouts.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_autoswitch">autoswitch</code></td>
<td>
<p>Whether to exclude recensoring for treatment arms
with no switching. Defaults to <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_gridsearch">gridsearch</code></td>
<td>
<p>Whether to use grid search to estimate the causal
parameter <code>psi</code>. Defaults to <code>FALSE</code>, in which case, a root
finding algorithm will be used.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_alpha">alpha</code></td>
<td>
<p>The significance level to calculate confidence intervals.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_ties">ties</code></td>
<td>
<p>The method for handling ties in the Cox model, either
&quot;breslow&quot; or &quot;efron&quot; (default).</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_tol">tol</code></td>
<td>
<p>The desired accuracy (convergence tolerance) for <code>psi</code>.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_boot">boot</code></td>
<td>
<p>Whether to use bootstrap to obtain the confidence
interval for hazard ratio. Defaults to <code>FALSE</code>, in which case,
the confidence interval will be constructed to match the log-rank
test p-value.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_n_boot">n_boot</code></td>
<td>
<p>The number of bootstrap samples.</p>
</td></tr>
<tr><td><code id="rpsftm_+3A_seed">seed</code></td>
<td>
<p>The seed to reproduce the bootstrap results. The default is
missing, in which case, the seed from the environment will be used.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>We use the following steps to obtain the hazard ratio estimate
and confidence interval had there been no treatment switching:
</p>

<ul>
<li><p> Use RPSFTM to estimate the causal parameter <code class="reqn">\psi</code> based on the
log-rank test for counterfactual untreated survival times for
both arms: </p>
<p style="text-align: center;"><code class="reqn">U_{i,\psi} = T_{C_i} +  e^{\psi}T_{E_i}</code>
</p>

</li>
<li><p> Fit the Cox proportional hazards model to the observed survival times
for the experimental group and the counterfactual survival times
for the control group to obtain the hazard ratio estimate.
</p>
</li>
<li><p> Use either the log-rank test p-value for the intention-to-treat (ITT)
analysis or bootstrap to construct the confidence interval for
hazard ratio. If bootstrapping is used, the confidence interval
and corresponding p-value are calculated based on a t-distribution with
<code>n_boot - 1</code> degrees of freedom.
</p>
</li></ul>



<h3>Value</h3>

<p>A list with the following components:
</p>

<ul>
<li> <p><code>psi</code>: The estimated causal parameter.
</p>
</li>
<li> <p><code>psi_CI</code>: The confidence interval for <code>psi</code>.
</p>
</li>
<li> <p><code>psi_CI_type</code>: The type of confidence interval for <code>psi</code>,
i.e., &quot;grid search&quot;, &quot;root finding&quot;, or &quot;bootstrap&quot;.
</p>
</li>
<li> <p><code>logrank_pvalue</code>: The two-sided p-value of the log-rank test
for the ITT analysis.
</p>
</li>
<li> <p><code>cox_pvalue</code>: The two-sided p-value for treatment effect based on
the Cox model.
</p>
</li>
<li> <p><code>hr</code>: The estimated hazard ratio from the Cox model.
</p>
</li>
<li> <p><code>hr_CI</code>: The confidence interval for hazard ratio.
</p>
</li>
<li> <p><code>hr_CI_type</code>: The type of confidence interval for hazard ratio,
either &quot;log-rank p-value&quot; or &quot;bootstrap&quot;.
</p>
</li>
<li> <p><code>eval_z</code>: A data frame containing the log-rank test Z-statistics
evaluated at a sequence of <code>psi</code> values. Used to plot and check
if the range of <code>psi</code> values to search for the solution and
limits of confidence interval of <code>psi</code> need be modified.
</p>
</li>
<li> <p><code>Sstar</code>: A data frame containing the counterfactual untreated
survival times and event indicators for each treatment group.
</p>
</li>
<li> <p><code>kmstar</code>: A data frame containing the Kaplan-Meier estimates
based on the counterfactual untreated survival times by treatment arm.
</p>
</li>
<li> <p><code>data_outcome</code>: The input data for the outcome Cox model.
</p>
</li>
<li> <p><code>fit_outcome</code>: The fitted outcome Cox model.
</p>
</li>
<li> <p><code>settings</code>: A list with the following components:
</p>

<ul>
<li> <p><code>low_psi</code>: The lower limit of the causal parameter.
</p>
</li>
<li> <p><code>hi_psi</code>: The upper limit of the causal parameter.
</p>
</li>
<li> <p><code>n_eval_z</code>: The number of points between <code>low_psi</code> and
<code>hi_psi</code> (inclusive) at which to evaluate the log-rank
Z-statistics.
</p>
</li>
<li> <p><code>treat_modifier</code>: The sensitivity parameter for the
constant treatment effect assumption.
</p>
</li>
<li> <p><code>recensor</code>: Whether to apply recensoring to counterfactual
survival times.
</p>
</li>
<li> <p><code>admin_recensor_only</code>: Whether to apply recensoring to
administrative censoring times only.
</p>
</li>
<li> <p><code>autoswitch</code>: Whether to exclude recensoring for treatment
arms with no switching.
</p>
</li>
<li> <p><code>gridsearch</code>: Whether to use grid search to estimate the
causal parameter <code>psi</code>.
</p>
</li>
<li> <p><code>alpha</code>: The significance level to calculate confidence
intervals.
</p>
</li>
<li> <p><code>ties</code>: The method for handling ties in the Cox model.
</p>
</li>
<li> <p><code>tol</code>: The desired accuracy (convergence tolerance)
for <code>psi</code>.
</p>
</li>
<li> <p><code>boot</code>: Whether to use bootstrap to obtain the confidence
interval for hazard ratio.
</p>
</li>
<li> <p><code>n_boot</code>: The number of bootstrap samples.
</p>
</li>
<li> <p><code>seed</code>: The seed to reproduce the bootstrap results.
</p>
</li></ul>

</li>
<li> <p><code>hr_boots</code>: The bootstrap hazard ratio estimates if <code>boot</code> is
<code>TRUE</code>.
</p>
</li>
<li> <p><code>psi_boots</code>: The bootstrap <code>psi</code> estimates if <code>boot</code> is
<code>TRUE</code>.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>References</h3>

<p>James M. Robins and Anastasios A. Tsiatis.
Correcting for non-compliance in randomized trials using rank preserving
structural failure time models.
Communications in Statistics. 1991;20(8):2609-2631.
</p>
<p>Ian R. White, Adbel G. Babiker, Sarah Walker, and Janet H. Darbyshire.
Randomization-based methods for correcting for treatment changes:
Examples from the CONCORDE trial.
Statistics in Medicine. 1999;18:2617-2634.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
library(dplyr)

# Example 1: one-way treatment switching (control to active)

data &lt;- immdef %&gt;% mutate(rx = 1-xoyrs/progyrs)

fit1 &lt;- rpsftm(
  data, id = "id", time = "progyrs", event = "prog", treat = "imm",
  rx = "rx", censor_time = "censyrs", boot = FALSE)

c(fit1$hr, fit1$hr_CI)

# Example 2: two-way treatment switching (illustration only)

# the eventual survival time
shilong1 &lt;- shilong %&gt;%
  arrange(bras.f, id, tstop) %&gt;%
  group_by(bras.f, id) %&gt;%
  slice(n()) %&gt;%
  select(-c("ps", "ttc", "tran"))

shilong2 &lt;- shilong1 %&gt;%
  mutate(rx = ifelse(co, ifelse(bras.f == "MTA", dco/ady, 
                                1 - dco/ady),
                     ifelse(bras.f == "MTA", 1, 0)))

fit2 &lt;- rpsftm(
  shilong2, id = "id", time = "tstop", event = "event",
  treat = "bras.f", rx = "rx", censor_time = "dcut",
  base_cov = c("agerand", "sex.f", "tt_Lnum", "rmh_alea.c",
               "pathway.f"),
  low_psi = -3, hi_psi = 3, boot = FALSE)

c(fit2$hr, fit2$hr_CI)

</code></pre>

<hr>
<h2 id='sexagg'>Urinary tract infection data from the logistf package</h2><span id='topic+sexagg'></span>

<h3>Description</h3>

<p>This data set deals with urinary tract infection in sexually active
college women, along with covariate information on age an
contraceptive use. The variables are all binary and coded
in 1 (condition is present) and 0 (condition is absent).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>sexagg
</code></pre>


<h3>Format</h3>

<p>An object of class <code>data.frame</code> with 36 rows and 9 columns.
</p>


<h3>Details</h3>


<dl>
<dt><code>case</code></dt><dd><p>urinary tract infection, the study outcome variable</p>
</dd>
<dt><code>age</code></dt><dd><p>&gt;= 24 years</p>
</dd>
<dt><code>dia</code></dt><dd><p>use of diaphragm</p>
</dd>
<dt><code>oc</code></dt><dd><p>use of oral contraceptive</p>
</dd>
<dt><code>vic</code></dt><dd><p>use of condom</p>
</dd>
<dt><code>vicl</code></dt><dd><p>use of lubricated condom</p>
</dd>
<dt><code>vis</code></dt><dd><p>use of spermicide</p>
</dd>
</dl>


<hr>
<h2 id='shilong'>The randomized clinical trial SHIVA data in long format from the
ipcwswitch package</h2><span id='topic+shilong'></span>

<h3>Description</h3>

<p>The original SHIdat data set contains an anonymized excerpt of data from
the SHIVA01 trial. This was the first randomized clinical trial that
aimed at comparing molecularly targeted therapy based on tumor
profiling (MTA) versus conventional therapy (CT) for advanced cancer.
Patients were randomly assigned to receive the active or control
treatment and may switch to the other arm or subsequent anti-cancer
therapy upon disease progression.
The restructured data is in the long format.
</p>

<dl>
<dt><code>id</code></dt><dd><p>The patient's identifier</p>
</dd>
<dt><code>tstart</code></dt><dd><p>The start of the time interval</p>
</dd>
<dt><code>tstop</code></dt><dd><p>The end of the time interval</p>
</dd>
<dt><code>event</code></dt><dd><p>Whether the patient died at the end of the interval</p>
</dd>
<dt><code>agerand</code></dt><dd><p>The patient's age (in years) at randomization</p>
</dd>
<dt><code>sex.f</code></dt><dd><p>The patients' gender, either Male or Female</p>
</dd>
<dt><code>tt_Lnum</code></dt><dd><p>The number of previous lines of treatment</p>
</dd>
<dt><code>rmh_alea.c</code></dt><dd><p>The Royal Marsden Hospital score segregated
into two categories</p>
</dd>
<dt><code>pathway.f</code></dt><dd><p>The molecular pathway altered (the hormone
receptors pathway, the PI3K/ AKT/mTOR pathway, and the RAF/MEK pathway)</p>
</dd>
<dt><code>bras.f</code></dt><dd><p>The patient's randomized arm, either MTA or CT</p>
</dd>
<dt><code>ps</code></dt><dd><p>The ECOG performance status</p>
</dd>
<dt><code>ttc</code></dt><dd><p>The presence of concomitant treatments</p>
</dd>
<dt><code>tran</code></dt><dd><p>The use of platelet transfusions</p>
</dd>
<dt><code>dpd</code></dt><dd><p>The relative day of a potential progression</p>
</dd>
<dt><code>dco</code></dt><dd><p>The relative day of treatment switching</p>
</dd>
<dt><code>ady</code></dt><dd><p>The relative day of the latest news</p>
</dd>
<dt><code>dcut</code></dt><dd><p>The relative day of administrative cutoff</p>
</dd>
<dt><code>pd</code></dt><dd><p>Whether the patient had disease progression</p>
</dd>
<dt><code>co</code></dt><dd><p>Whether the patient switched treatment</p>
</dd>
</dl>



<h3>Usage</h3>

<pre><code class='language-R'>shilong
</code></pre>


<h3>Format</h3>

<p>An object of class <code>data.frame</code> with 602 rows and 19 columns.
</p>

<hr>
<h2 id='six'>The repeated measures data from the &quot;Six Cities&quot; study of the health
effects of air pollution (Ware et al. 1984).</h2><span id='topic+six'></span>

<h3>Description</h3>

<p>The data analyzed are the 16 selected cases in Lipsitz et al. (1994).
The binary response is the wheezing status of 16 children at ages 9,
10, 11, and 12 years. A value of 1 of wheezing status indicates the
occurrence of wheezing. The explanatory variables city of residence,
age, and maternal smoking status at the particular age.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>six
</code></pre>


<h3>Format</h3>

<p>An object of class <code>tbl_df</code> (inherits from <code>tbl</code>, <code>data.frame</code>) with 64 rows and 6 columns.
</p>


<h3>Details</h3>


<dl>
<dt><code>case</code></dt><dd><p>case id</p>
</dd>
<dt><code>city</code></dt><dd><p>city of residence</p>
</dd>
<dt><code>age</code></dt><dd><p>age of the child</p>
</dd>
<dt><code>smoke</code></dt><dd><p>maternal smoking status</p>
</dd>
<dt><code>wheeze</code></dt><dd><p>wheezing status</p>
</dd>
</dl>


<hr>
<h2 id='splineDesigncpp'>B-Spline Design Matrix</h2><span id='topic+splineDesigncpp'></span>

<h3>Description</h3>

<p>Computes the design matrix for B-splines based on the
specified <code>knots</code> and evaluated at the values in <code>x</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>splineDesigncpp(
  knots = NA_real_,
  x = NA_real_,
  ord = 4L,
  derivs = as.integer(c(0))
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="splineDesigncpp_+3A_knots">knots</code></td>
<td>
<p>A numeric vector specifying the positions of the knots,
including both boundary and internal knots.</p>
</td></tr>
<tr><td><code id="splineDesigncpp_+3A_x">x</code></td>
<td>
<p>A numeric vector of values where the B-spline functions
or their derivatives will be evaluated. The values of <code>x</code>
must lie within the range of the &quot;inner&quot; knots, i.e., between
<code>knots[ord]</code> and <code>knots[length(knots) - (ord - 1)]</code>.</p>
</td></tr>
<tr><td><code id="splineDesigncpp_+3A_ord">ord</code></td>
<td>
<p>A positive integer indicating the order of the B-spline.
This corresponds to the number of coefficients in each piecewise
polynomial segment, where <code>ord = degree + 1</code>.</p>
</td></tr>
<tr><td><code id="splineDesigncpp_+3A_derivs">derivs</code></td>
<td>
<p>An integer vector specifying the order of derivatives
to be evaluated at the corresponding <code>x</code> values. Each value
must be between <code>0</code> and <code>ord - 1</code>, and the vector is
conceptually recycled to match the length of <code>x</code>.
The default is <code>0</code>, meaning the B-spline functions themselves
are evaluated.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A matrix with dimensions
<code>c(length(x), length(knots) - ord)</code>. Each row corresponds
to a value in <code>x</code> and contains the coefficients of the
B-splines, or the specified derivatives, as defined by the
<code>knots</code> and evaluated at that particular value of <code>x</code>.
The total number of B-splines is <code>length(knots) - ord</code>,
with each B-spline defined by a set of <code>ord</code> consecutive knots.
</p>


<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
splineDesigncpp(knots = 1:10, x = 4:7)
splineDesigncpp(knots = 1:10, x = 4:7, derivs = 1)

</code></pre>

<hr>
<h2 id='survfit_phregr'>Survival Curve for Proportional Hazards Regression Models</h2><span id='topic+survfit_phregr'></span>

<h3>Description</h3>

<p>Obtains the predicted survivor function for a proportional
hazards regression model.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>survfit_phregr(
  fit_phregr,
  newdata,
  sefit = TRUE,
  conftype = "log-log",
  conflev = 0.95
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="survfit_phregr_+3A_fit_phregr">fit_phregr</code></td>
<td>
<p>The output from the <code>phregr</code> call.</p>
</td></tr>
<tr><td><code id="survfit_phregr_+3A_newdata">newdata</code></td>
<td>
<p>A data frame with the same variable names as those that
appear in the <code>phregr</code> call. For right-censored data, one curve is
produced per row to represent a cohort whose covariates correspond to
the values in <code>newdata</code>. For counting-process data, one curve is
produced per <code>id</code> in <code>newdata</code> to present the survival curve
along the path of time-dependent covariates at the observed event
times in the data used to fit <code>phregr</code>.</p>
</td></tr>
<tr><td><code id="survfit_phregr_+3A_sefit">sefit</code></td>
<td>
<p>Whether to compute the standard error of the survival
estimates.</p>
</td></tr>
<tr><td><code id="survfit_phregr_+3A_conftype">conftype</code></td>
<td>
<p>The type of the confidence interval. One of <code>"none"</code>,
<code>"plain"</code>, <code>"log"</code>, <code>"log-log"</code> (the default), or
<code>"arcsin"</code>. The <code>arcsin</code> option bases the intervals on
<code>asin(sqrt(surv))</code>.</p>
</td></tr>
<tr><td><code id="survfit_phregr_+3A_conflev">conflev</code></td>
<td>
<p>The level of the two-sided confidence interval for
the survival probabilities. Defaults to 0.95.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>If <code>newdata</code> is not provided and there is no covariate, survival
curves based on the <code>basehaz</code> data frame will be produced.
</p>


<h3>Value</h3>

<p>A data frame with the following variables:
</p>

<ul>
<li> <p><code>id</code>: The id of the subject for counting-process data with
time-dependent covariates.
</p>
</li>
<li> <p><code>time</code>: The observed times in the data used to fit
<code>phregr</code>.
</p>
</li>
<li> <p><code>nrisk</code>: The number of patients at risk at the time point in the
data used to fit <code>phregr</code>.
</p>
</li>
<li> <p><code>nevent</code>: The number of patients having event at the time point
in the data used to fit <code>phregr</code>.
</p>
</li>
<li> <p><code>cumhaz</code>: The cumulative hazard at the time point.
</p>
</li>
<li> <p><code>surv</code>: The estimated survival probability at the time point.
</p>
</li>
<li> <p><code>sesurv</code>: The standard error of the estimated survival probability.
</p>
</li>
<li> <p><code>lower</code>: The lower confidence limit for survival probability.
</p>
</li>
<li> <p><code>upper</code>: The upper confidence limit for survival probability.
</p>
</li>
<li> <p><code>conflev</code>: The level of the two-sided confidence interval.
</p>
</li>
<li> <p><code>conftype</code>: The type of the confidence interval.
</p>
</li>
<li> <p><code>covariates</code>: The values of covariates based on <code>newdata</code>.
</p>
</li>
<li> <p><code>stratum</code>: The stratum of the subject.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>References</h3>

<p>Terry M. Therneau and Patricia M. Grambsch.
Modeling Survival Data: Extending the Cox Model.
Springer-Verlag, 2000.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
library(dplyr)

# Example 1 with right-censored data
fit1 &lt;- phregr(data = rawdata %&gt;% filter(iterationNumber == 1) %&gt;%
                 mutate(treat = 1*(treatmentGroup == 1)),
               stratum = "stratum",
               time = "timeUnderObservation", event = "event",
               covariates = "treat")

surv1 &lt;- survfit_phregr(fit1,
                        newdata = data.frame(
                          stratum = as.integer(c(1,1,2,2)),
                          treat = c(1,0,1,0)))

# Example 2 with counting process data and robust variance estimate
fit2 &lt;- phregr(data = heart %&gt;% mutate(rx = as.numeric(transplant) - 1),
               time = "start", time2 = "stop", event = "event",
               covariates = c("rx", "age"), id = "id", robust = TRUE)

surv2 &lt;- survfit_phregr(fit2,
                        newdata = data.frame(
                          id = c(4,4,11,11),
                          age = c(-7.737,-7.737,-0.019,-0.019),
                          start = c(0,36,0,26),
                          stop = c(36,39,26,153),
                          rx = c(0,1,0,1)))

</code></pre>

<hr>
<h2 id='survsplit'>Split a survival data set at specified cut points</h2><span id='topic+survsplit'></span>

<h3>Description</h3>

<p>For a given survival dataset and specified cut times,
each record is split into multiple subrecords at each cut time.
The resulting dataset is in counting process format, with each
subrecord containing a start time, stop time, and event status.
This is adapted from the survsplit.c function from the survival package.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>survsplit(tstart, tstop, cut)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="survsplit_+3A_tstart">tstart</code></td>
<td>
<p>The starting time of the time interval for
counting-process data.</p>
</td></tr>
<tr><td><code id="survsplit_+3A_tstop">tstop</code></td>
<td>
<p>The stopping time of the time interval for
counting-process data.</p>
</td></tr>
<tr><td><code id="survsplit_+3A_cut">cut</code></td>
<td>
<p>The vector of cut points.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame with the following variables:
</p>

<ul>
<li> <p><code>row</code>: The row number of the observation in the input data
(starting from 0).
</p>
</li>
<li> <p><code>start</code>: The starting time of the resulting subrecord.
</p>
</li>
<li> <p><code>stop</code>: The stopping time of the resulting subrecord.
</p>
</li>
<li> <p><code>censor</code>: Whether the subrecord lies strictly within a record
in the input data.
</p>
</li>
<li> <p><code>interval</code>: The interval number.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
survsplit(15, 60, c(10, 30, 40))

</code></pre>

<hr>
<h2 id='tobin'>Tobin's tobit data from the survival package</h2><span id='topic+tobin'></span>

<h3>Description</h3>

<p>Data from Tobin's original paper.
</p>

<dl>
<dt><code>durable</code></dt><dd><p>Durable goods purchase</p>
</dd>
<dt><code>age</code></dt><dd><p>Age in years</p>
</dd>
<dt><code>quant</code></dt><dd><p>Liquidity ratio (x 1000)</p>
</dd>
</dl>



<h3>Usage</h3>

<pre><code class='language-R'>tobin
</code></pre>


<h3>Format</h3>

<p>An object of class <code>data.frame</code> with 20 rows and 3 columns.
</p>

<hr>
<h2 id='tsegest'>The Two-Stage Estimation (TSE) Method Using g-estimation
for Treatment Switching</h2><span id='topic+tsegest'></span>

<h3>Description</h3>

<p>Obtains the causal parameter estimate of the logistic
regression switching model and the hazard ratio estimate of
the Cox model to adjust for treatment switching.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>tsegest(
  data,
  id = "id",
  stratum = "",
  tstart = "tstart",
  tstop = "tstop",
  event = "event",
  treat = "treat",
  censor_time = "censor_time",
  pd = "pd",
  pd_time = "pd_time",
  swtrt = "swtrt",
  swtrt_time = "swtrt_time",
  swtrt_time_upper = "",
  base_cov = "",
  conf_cov = "",
  low_psi = -3,
  hi_psi = 3,
  n_eval_z = 100,
  strata_main_effect_only = TRUE,
  firth = FALSE,
  flic = FALSE,
  recensor = TRUE,
  admin_recensor_only = TRUE,
  swtrt_control_only = TRUE,
  alpha = 0.05,
  ties = "efron",
  tol = 1e-06,
  offset = 1,
  boot = TRUE,
  n_boot = 1000,
  seed = NA
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="tsegest_+3A_data">data</code></td>
<td>
<p>The input data frame that contains the following variables:
</p>

<ul>
<li> <p><code>id</code>: The id to identify observations belonging to the same
subject for counting process data with time-dependent covariates.
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>tstart</code>: The starting time of the time interval for
counting-process data with time-dependent covariates.
</p>
</li>
<li> <p><code>tstop</code>: The stopping time of the time interval for
counting-process data with time-dependent covariates.
</p>
</li>
<li> <p><code>event</code>: The event indicator, 1=event, 0=no event.
</p>
</li>
<li> <p><code>treat</code>: The randomized treatment indicator, 1=treatment,
0=control.
</p>
</li>
<li> <p><code>censor_time</code>: The administrative censoring time. It should
be provided for all subjects including those who had events.
</p>
</li>
<li> <p><code>pd</code>: The disease progression indicator, 1=PD, 0=no PD.
</p>
</li>
<li> <p><code>pd_time</code>: The time from randomization to PD.
</p>
</li>
<li> <p><code>swtrt</code>: The treatment switch indicator, 1=switch, 0=no switch.
</p>
</li>
<li> <p><code>swtrt_time</code>: The time from randomization to treatment switch.
</p>
</li>
<li> <p><code>swtrt_time_upper</code>: The upper bound of treatment switching time.
</p>
</li>
<li> <p><code>base_cov</code>: The baseline covariates (excluding treat).
</p>
</li>
<li> <p><code>conf_cov</code>: The confounding variables for predicting
treatment switching (excluding treat).
</p>
</li></ul>
</td></tr>
<tr><td><code id="tsegest_+3A_id">id</code></td>
<td>
<p>The name of the id variable in the input data.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_stratum">stratum</code></td>
<td>
<p>The name(s) of the stratum variable(s) in the input data.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_tstart">tstart</code></td>
<td>
<p>The name of the tstart variable in the input data.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_tstop">tstop</code></td>
<td>
<p>The name of the tstop variable in the input data.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_event">event</code></td>
<td>
<p>The name of the event variable in the input data.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_treat">treat</code></td>
<td>
<p>The name of the treatment variable in the input data.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_censor_time">censor_time</code></td>
<td>
<p>The name of the censor_time variable in the input data.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_pd">pd</code></td>
<td>
<p>The name of the pd variable in the input data.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_pd_time">pd_time</code></td>
<td>
<p>The name of the pd_time variable in the input data.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_swtrt">swtrt</code></td>
<td>
<p>The name of the swtrt variable in the input data.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_swtrt_time">swtrt_time</code></td>
<td>
<p>The name of the swtrt_time variable in the input data.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_swtrt_time_upper">swtrt_time_upper</code></td>
<td>
<p>The name of the swtrt_time_upper variable in the
input data.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_base_cov">base_cov</code></td>
<td>
<p>The names of baseline covariates (excluding
treat) in the input data for the Cox model.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_conf_cov">conf_cov</code></td>
<td>
<p>The names of confounding variables (excluding
treat) in the input data for the logistic regression switching model.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_low_psi">low_psi</code></td>
<td>
<p>The lower limit of the causal parameter.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_hi_psi">hi_psi</code></td>
<td>
<p>The upper limit of the causal parameter.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_n_eval_z">n_eval_z</code></td>
<td>
<p>The number of points between <code>low_psi</code> and
<code>hi_psi</code> (inclusive) at which to evaluate the Wald
statistics for the coefficient of the counterfactual in the logistic
regression switching model.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_strata_main_effect_only">strata_main_effect_only</code></td>
<td>
<p>Whether to only include the strata main
effects in the logistic regression switching model. Defaults to
<code>TRUE</code>, otherwise all possible strata combinations will be
considered in the switching model.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_firth">firth</code></td>
<td>
<p>Whether the Firth's bias reducing penalized likelihood
should be used. The default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_flic">flic</code></td>
<td>
<p>Whether to apply intercept correction to obtain more
accurate predicted probabilities. The default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_recensor">recensor</code></td>
<td>
<p>Whether to apply recensoring to counterfactual
survival times. Defaults to <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_admin_recensor_only">admin_recensor_only</code></td>
<td>
<p>Whether to apply recensoring to administrative
censoring times only. Defaults to <code>TRUE</code>. If <code>FALSE</code>,
recensoring will be applied to the actual censoring times for dropouts.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_swtrt_control_only">swtrt_control_only</code></td>
<td>
<p>Whether treatment switching occurred only in
the control group. The default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_alpha">alpha</code></td>
<td>
<p>The significance level to calculate confidence intervals.
The default value is 0.05.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_ties">ties</code></td>
<td>
<p>The method for handling ties in the Cox model, either
&quot;breslow&quot; or &quot;efron&quot; (default).</p>
</td></tr>
<tr><td><code id="tsegest_+3A_tol">tol</code></td>
<td>
<p>The desired accuracy (convergence tolerance) for <code>psi</code>.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_offset">offset</code></td>
<td>
<p>The offset to calculate the time to event, PD, and
treatment switch. We can set <code>offset</code> equal to 1 (default),
1/30.4375, or 1/365.25 if the time unit is day, month, or year.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_boot">boot</code></td>
<td>
<p>Whether to use bootstrap to obtain the confidence
interval for hazard ratio. Defaults to <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_n_boot">n_boot</code></td>
<td>
<p>The number of bootstrap samples.</p>
</td></tr>
<tr><td><code id="tsegest_+3A_seed">seed</code></td>
<td>
<p>The seed to reproduce the bootstrap results. The default is
missing, in which case, the seed from the environment will be used.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>We use the following steps to obtain the hazard ratio estimate
and confidence interval had there been no treatment switching:
</p>

<ul>
<li><p> Use a pooled logistic regression switching model to estimate
the causal parameter <code class="reqn">\psi</code> based on the patients in the
control group  who had disease progression:
</p>
<p style="text-align: center;"><code class="reqn">\textrm{logit}(p(E_{ik})) = \alpha U_{i,\psi} + 
  \sum_{j} \beta_j x_{ijk}</code>
</p>

<p>where <code class="reqn">E_{ik}</code> is the observed switch indicator for individual
<code class="reqn">i</code> at observation <code class="reqn">k</code>,
</p>
<p style="text-align: center;"><code class="reqn">U_{i,\psi} = T_{C_i} + e^{\psi}T_{E_i}</code>
</p>

<p>is the counterfactual survival time for individual <code class="reqn">i</code> given a
specific value for <code class="reqn">\psi</code>, and <code class="reqn">x_{ijk}</code> are the confounders
for individual <code class="reqn">i</code> at observation <code class="reqn">k</code>.
When applied from a secondary baseline, <code class="reqn">U_{i,\psi}</code>
refers to post-secondary baseline counterfactual survival, where
<code class="reqn">T_{C_i}</code> corresponds to the time spent after the secondary baseline
on control treatment, and <code class="reqn">T_{E_i}</code> corresponds to the time spent
after the secondary baseline on the experimental treatment.
</p>
</li>
<li><p> Search for <code class="reqn">\psi</code> such that the estimate of <code class="reqn">\alpha</code> is close
to zero. This will be the estimate of the caual parameter. The
confidence interval for <code class="reqn">\psi</code> can be obtained as the value of
<code class="reqn">\psi</code> such that the corresponding two-sided p-value for
testing <code class="reqn">H_0:\alpha = 0</code> in the switching model is equal to the
nominal significance level.
</p>
</li>
<li><p> Derive the counterfactual survival times for control patients
had there been no treatment switching.
</p>
</li>
<li><p> Fit the Cox proportional hazards model to the observed survival times
for the experimental group and the counterfactual survival times
for the control group to obtain the hazard ratio estimate.
</p>
</li>
<li><p> If bootstrapping is used, the confidence interval and corresponding
p-value for hazard ratio are calculated based on a t-distribution with
<code>n_boot - 1</code> degrees of freedom.
</p>
</li></ul>



<h3>Value</h3>

<p>A list with the following components:
</p>

<ul>
<li> <p><code>psi</code>: The estimated causal parameter for the control group.
</p>
</li>
<li> <p><code>psi_CI</code>: The confidence interval for <code>psi</code>.
</p>
</li>
<li> <p><code>psi_CI_type</code>: The type of confidence interval for <code>psi</code>,
i.e., &quot;logistic model&quot; or &quot;bootstrap&quot;.
</p>
</li>
<li> <p><code>logrank_pvalue</code>: The two-sided p-value of the log-rank test
for an intention-to-treat (ITT) analysis.
</p>
</li>
<li> <p><code>cox_pvalue</code>: The two-sided p-value for treatment effect based on
the Cox model.
</p>
</li>
<li> <p><code>hr</code>: The estimated hazard ratio from the Cox model.
</p>
</li>
<li> <p><code>hr_CI</code>: The confidence interval for hazard ratio.
</p>
</li>
<li> <p><code>hr_CI_type</code>: The type of confidence interval for hazard ratio,
either &quot;Cox model&quot; or &quot;bootstrap&quot;.
</p>
</li>
<li> <p><code>analysis_switch</code>: A list of data and analysis results related to
treatment switching.
</p>

<ul>
<li> <p><code>data_switch</code>: The list of input data for the time from
secondary baseline to switch by treatment group. The variables
include <code>id</code>, <code>stratum</code> (if applicable), <code>swtrt</code>,
and <code>swtrt_time</code>. If <code>swtrt == 0</code>, then <code>swtrt_time</code>
is censored at the time from secondary baseline to either
death or censoring.
</p>
</li>
<li> <p><code>km_switch</code>: The list of Kaplan-Meier plots for the time
from secondary baseline to switch by treatment group.
</p>
</li>
<li> <p><code>eval_z</code>: The list of data by treatment group containing
the Wald statistics for the coefficient of the counterfactual
in the logistic regression switching model, evaluated at
a sequence of <code>psi</code> values. Used to plot and check
if the range of <code>psi</code> values to search for the solution
and limits of confidence interval of <code>psi</code> need be modified.
</p>
</li>
<li> <p><code>data_nullcox</code>: The list of input data for counterfactual
survival times for the null Cox model by treatment group.
</p>
</li>
<li> <p><code>fit_nullcox</code>: The list of fitted null Cox models for
counterfactual survival times by treatment group, which contains
the martingale residuals.
</p>
</li>
<li> <p><code>data_logis</code>: The list of input data for pooled logistic
regression models for treatment switching using g-estimation.
</p>
</li>
<li> <p><code>fit_logis</code>: The list of fitted pooled logistic regression
models for treatment switching using g-estimation.
</p>
</li></ul>

</li>
<li> <p><code>data_outcome</code>: The input data for the outcome Cox model.
</p>
</li>
<li> <p><code>fit_outcome</code>: The fitted outcome Cox model.
</p>
</li>
<li> <p><code>settings</code>: A list with the following components:
</p>

<ul>
<li> <p><code>low_psi</code>: The lower limit of the causal parameter.
</p>
</li>
<li> <p><code>hi_psi</code>: The upper limit of the causal parameter.
</p>
</li>
<li> <p><code>n_eval_z</code>: The number of points between <code>low_psi</code> and
<code>hi_psi</code> (inclusive) at which to evaluate the Wald statistics
for the coefficient for the counterfactual in the logistic
regression switching model.
</p>
</li>
<li> <p><code>strata_main_effect_only</code>: Whether to only include the strata
main effects in the logistic regression switching model.
</p>
</li>
<li> <p><code>firth</code>: Whether the Firth's penalized likelihood is used.
</p>
</li>
<li> <p><code>flic</code>: Whether to apply intercept correction.
</p>
</li>
<li> <p><code>recensor</code>: Whether to apply recensoring to counterfactual
survival times.
</p>
</li>
<li> <p><code>admin_recensor_only</code>: Whether to apply recensoring to
administrative censoring times only.
</p>
</li>
<li> <p><code>swtrt_control_only</code>: Whether treatment switching occurred
only in the control group.
</p>
</li>
<li> <p><code>alpha</code>: The significance level to calculate confidence
intervals.
</p>
</li>
<li> <p><code>ties</code>: The method for handling ties in the Cox model.
</p>
</li>
<li> <p><code>tol</code>: The desired accuracy (convergence tolerance)
for <code>psi</code>.
</p>
</li>
<li> <p><code>offset</code>: The offset to calculate the time to event, PD, and
treatment switch.
</p>
</li>
<li> <p><code>boot</code>: Whether to use bootstrap to obtain the confidence
interval for hazard ratio.
</p>
</li>
<li> <p><code>n_boot</code>: The number of bootstrap samples.
</p>
</li>
<li> <p><code>seed</code>: The seed to reproduce the bootstrap results.
</p>
</li></ul>

</li>
<li> <p><code>psi_trt</code>: The estimated causal parameter for the experimental
group if <code>swtrt_control_only</code> is <code>FALSE</code>.
</p>
</li>
<li> <p><code>psi_trt_CI</code>: The confidence interval for <code>psi_trt</code> if
<code>swtrt_control_only</code> is <code>FALSE</code>.
</p>
</li>
<li> <p><code>hr_boots</code>: The bootstrap hazard ratio estimates if <code>boot</code> is
<code>TRUE</code>.
</p>
</li>
<li> <p><code>psi_boots</code>: The bootstrap <code>psi</code> estimates if <code>boot</code> is
<code>TRUE</code>.
</p>
</li>
<li> <p><code>psi_trt_boots</code>: The bootstrap <code>psi_trt</code> estimates if
<code>boot</code> is <code>TRUE</code> and <code>swtrt_control_only</code> is
<code>FALSE</code>.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>References</h3>

<p>NR Latimer, IR White, K Tilling, and U Siebert.
Improved two-stage estimation to adjust for treatment switching in
randomised trials: g-estimation to address time-dependent confounding.
Statistical Methods in Medical Research. 2020;29(10):2900-2918.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# Example 1: one-way treatment switching (control to active)

sim1 &lt;- tsegestsim(
  n = 500, allocation1 = 2, allocation2 = 1, pbprog = 0.5, 
  trtlghr = -0.5, bprogsl = 0.3, shape1 = 1.8, 
  scale1 = 0.000025, shape2 = 1.7, scale2 = 0.000015, 
  pmix = 0.5, admin = 5000, pcatnotrtbprog = 0.5, 
  pcattrtbprog = 0.25, pcatnotrt = 0.2, pcattrt = 0.1, 
  catmult = 0.5, tdxo = 1, ppoor = 0.1, pgood = 0.04, 
  ppoormet = 0.4, pgoodmet = 0.2, xomult = 1.4188308, 
  milestone = 546, swtrt_control_only = TRUE,
  outputRawDataset = 1, seed = 2000)
  
fit1 &lt;- tsegest(
  data = sim1$paneldata, id = "id", 
  tstart = "tstart", tstop = "tstop", event = "died", 
  treat = "trtrand", censor_time = "censor_time", 
  pd = "progressed", pd_time = "timePFSobs", swtrt = "xo", 
  swtrt_time = "xotime", swtrt_time_upper = "xotime_upper",
  base_cov = "bprog", conf_cov = "bprog*catlag", 
  low_psi = -3, hi_psi = 3, strata_main_effect_only = TRUE,
  recensor = TRUE, admin_recensor_only = TRUE, 
  swtrt_control_only = TRUE, alpha = 0.05, ties = "efron", 
  tol = 1.0e-6, boot = FALSE)
  
c(fit1$hr, fit1$hr_CI)

# Example 2: two-way treatment switching

sim2 &lt;- tsegestsim(
  n = 500, allocation1 = 2, allocation2 = 1, pbprog = 0.5, 
  trtlghr = -0.5, bprogsl = 0.3, shape1 = 1.8, 
  scale1 = 0.000025, shape2 = 1.7, scale2 = 0.000015, 
  pmix = 0.5, admin = 5000, pcatnotrtbprog = 0.5, 
  pcattrtbprog = 0.25, pcatnotrt = 0.2, pcattrt = 0.1, 
  catmult = 0.5, tdxo = 1, ppoor = 0.1, pgood = 0.04, 
  ppoormet = 0.4, pgoodmet = 0.2, xomult = 1.4188308, 
  milestone = 546, swtrt_control_only = FALSE,
  outputRawDataset = 1, seed = 2000)
  
fit2 &lt;- tsegest(
  data = sim2$paneldata, id = "id", 
  tstart = "tstart", tstop = "tstop", event = "died", 
  treat = "trtrand", censor_time = "censor_time", 
  pd = "progressed", pd_time = "timePFSobs", swtrt = "xo", 
  swtrt_time = "xotime", swtrt_time_upper = "xotime_upper",
  base_cov = "bprog", conf_cov = "bprog*catlag", 
  low_psi = -3, hi_psi = 3, strata_main_effect_only = TRUE,
  recensor = TRUE, admin_recensor_only = TRUE, 
  swtrt_control_only = FALSE, alpha = 0.05, ties = "efron", 
  tol = 1.0e-6, boot = FALSE)
  
c(fit2$hr, fit2$hr_CI)

</code></pre>

<hr>
<h2 id='tsegestsim'>Simulate Survival Data for Two-Stage Estimation Method Using
g-estimation</h2><span id='topic+tsegestsim'></span>

<h3>Description</h3>

<p>Obtains the simulated data for baseline prognosis,
disease progression, treatment switching, death, and
time-dependent covariates.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>tsegestsim(
  n = 500L,
  allocation1 = 2L,
  allocation2 = 1L,
  pbprog = 0.5,
  trtlghr = -0.5,
  bprogsl = 0.3,
  shape1 = 1.8,
  scale1 = 2.5e-05,
  shape2 = 1.7,
  scale2 = 1.5e-05,
  pmix = 0.5,
  admin = 5000,
  pcatnotrtbprog = 0.5,
  pcattrtbprog = 0.25,
  pcatnotrt = 0.2,
  pcattrt = 0.1,
  catmult = 0.5,
  tdxo = 1,
  ppoor = 0.1,
  pgood = 0.04,
  ppoormet = 0.4,
  pgoodmet = 0.2,
  xomult = 1.4188308,
  milestone = 546,
  swtrt_control_only = 1L,
  outputRawDataset = 1L,
  seed = NA_integer_
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="tsegestsim_+3A_n">n</code></td>
<td>
<p>The total sample size for two treatment arms combined.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_allocation1">allocation1</code></td>
<td>
<p>The number of subjects in the active treatment group
in a randomization block.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_allocation2">allocation2</code></td>
<td>
<p>The number of subjects in the control group in
a randomization block.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_pbprog">pbprog</code></td>
<td>
<p>The probability of having poor prognosis at baseline.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_trtlghr">trtlghr</code></td>
<td>
<p>The treatment effect in terms of log hazard ratio.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_bprogsl">bprogsl</code></td>
<td>
<p>The poor prognosis effect in terms of log hazard ratio.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_shape1">shape1</code></td>
<td>
<p>The shape parameter for the Weibull event distribution
for the first component.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_scale1">scale1</code></td>
<td>
<p>The scale parameter for the Weibull event distribution
for the first component.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_shape2">shape2</code></td>
<td>
<p>The shape parameter for the Weibull event distribution
for the second component.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_scale2">scale2</code></td>
<td>
<p>The scale parameter for the Weibull event distribution
for the second component.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_pmix">pmix</code></td>
<td>
<p>The mixing probability of the first component Weibull
distribution.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_admin">admin</code></td>
<td>
<p>The administrative censoring time.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_pcatnotrtbprog">pcatnotrtbprog</code></td>
<td>
<p>The probability of developing metastatic disease
on control treatment with poor baseline prognosis.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_pcattrtbprog">pcattrtbprog</code></td>
<td>
<p>The probability of developing metastatic disease
on active treatment with poor baseline prognosis.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_pcatnotrt">pcatnotrt</code></td>
<td>
<p>The probability of developing metastatic disease
on control treatment with good baseline prognosis.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_pcattrt">pcattrt</code></td>
<td>
<p>The probability of developing metastatic disease
on active treatment with good baseline prognosis.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_catmult">catmult</code></td>
<td>
<p>The impact of metastatic disease on shortening remaining
survival time.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_tdxo">tdxo</code></td>
<td>
<p>Whether treatment crossover depends on time-dependent
covariates between disease progression and treatment switching.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_ppoor">ppoor</code></td>
<td>
<p>The probability of switching for poor baseline prognosis
with no metastatic disease.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_pgood">pgood</code></td>
<td>
<p>The probability of switching for good baseline prognosis
with no metastatic disease.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_ppoormet">ppoormet</code></td>
<td>
<p>The probability of switching for poor baseline prognosis
after developing metastatic disease.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_pgoodmet">pgoodmet</code></td>
<td>
<p>The probability of switching for good baseline prognosis
after developing metastatic disease.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_xomult">xomult</code></td>
<td>
<p>The direct effect of crossover on extending remaining
survival time.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_milestone">milestone</code></td>
<td>
<p>The milestone to calculate restricted mean survival
time.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_swtrt_control_only">swtrt_control_only</code></td>
<td>
<p>Whether treatment switching occurred only in
the control group.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_outputrawdataset">outputRawDataset</code></td>
<td>
<p>Whether to output the raw data set.</p>
</td></tr>
<tr><td><code id="tsegestsim_+3A_seed">seed</code></td>
<td>
<p>The seed to reproduce the simulation results.
The seed from the environment will be used if left unspecified.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list with two data frames.
</p>

<ul>
<li> <p><code>sumdata</code>: A data frame with the following variables:
</p>

<ul>
<li> <p><code>simtrueconstmean</code>: The true control group restricted mean
survival time (RMST).
</p>
</li>
<li> <p><code>simtrueconstlb</code>: The lower bound for control group RMST.
</p>
</li>
<li> <p><code>simtrueconstub</code>: The upper bound for control group RMST.
</p>
</li>
<li> <p><code>simtrueconstse</code>: The standard error for control group RMST.
</p>
</li>
<li> <p><code>simtrueexpstmean</code>: The true experimental group restricted
mean survival time (RMST).
</p>
</li>
<li> <p><code>simtrueexpstlb</code>: The lower bound for experimental group RMST.
</p>
</li>
<li> <p><code>simtrueexpstub</code>: The upper bound for experimental group RMST.
</p>
</li>
<li> <p><code>simtrueexpstse</code>: The standard error for experimental group
RMST.
</p>
</li>
<li> <p><code>simtrue_coxwbprog_hr</code>: The treatment hazard ratio from the
Cox model adjusting for baseline prognosis.
</p>
</li>
<li> <p><code>simtrue_cox_hr</code>: The treatment hazard ratio from the Cox
model without adjusting for baseline prognosis.
</p>
</li></ul>

</li>
<li> <p><code>paneldata</code>: A counting process style data frame with the
following variables:
</p>

<ul>
<li> <p><code>id</code>: The subject ID.
</p>
</li>
<li> <p><code>trtrand</code>: The randomized treatment arm.
</p>
</li>
<li> <p><code>bprog</code>: Whether the patient had poor baseline prognosis.
</p>
</li>
<li> <p><code>tstart</code>: The left end of time interval.
</p>
</li>
<li> <p><code>tstop</code>: The right end of time interval.
</p>
</li>
<li> <p><code>died</code>: Whether the patient died.
</p>
</li>
<li> <p><code>progressed</code>: Whether the patient had disease progression.
</p>
</li>
<li> <p><code>timePFSobs</code>: The observed time of disease progression at
regular scheduled visits.
</p>
</li>
<li> <p><code>progtdc</code>: The time-dependent covariate for progression.
</p>
</li>
<li> <p><code>catevent</code>: Whether the patient developed metastatic disease.
</p>
</li>
<li> <p><code>cattime</code>: When the patient developed metastatic disease.
</p>
</li>
<li> <p><code>cattdc</code>: The time-dependent covariate for cat event.
</p>
</li>
<li> <p><code>catlag</code>: The lagged value of <code>cattdc</code>.
</p>
</li>
<li> <p><code>xo</code>: Whether the patient switched treatment.
</p>
</li>
<li> <p><code>xotime</code>: When the patient switched treatment.
</p>
</li>
<li> <p><code>xotdc</code>: The time-dependent covariate for treatment
switching.
</p>
</li>
<li> <p><code>xotime_upper</code>: The upper bound of treatment switching time.
</p>
</li>
<li> <p><code>censor_time</code>: The administrative censoring time.
</p>
</li></ul>

</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
sim1 &lt;- tsegestsim(
  n = 500, allocation1 = 2, allocation2 = 1, pbprog = 0.5, 
  trtlghr = -0.5, bprogsl = 0.3, shape1 = 1.8, 
  scale1 = 0.000025, shape2 = 1.7, scale2 = 0.000015, 
  pmix = 0.5, admin = 5000, pcatnotrtbprog = 0.5, 
  pcattrtbprog = 0.25, pcatnotrt = 0.2, pcattrt = 0.1, 
  catmult = 0.5, tdxo = 1, ppoor = 0.1, pgood = 0.04, 
  ppoormet = 0.4, pgoodmet = 0.2, xomult = 1.4188308, 
  milestone = 546, outputRawDataset = 1, seed = 2000)

</code></pre>

<hr>
<h2 id='tsesimp'>The Simple Two-Stage Estimation (TSE) Method for Treatment
Switching</h2><span id='topic+tsesimp'></span>

<h3>Description</h3>

<p>Obtains the causal parameter estimate of the AFT model
for switching after disease progression and the hazard ratio estimate
of the outcome Cox model to adjust for treatment switching.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>tsesimp(
  data,
  id = "id",
  stratum = "",
  time = "time",
  event = "event",
  treat = "treat",
  censor_time = "censor_time",
  pd = "pd",
  pd_time = "pd_time",
  swtrt = "swtrt",
  swtrt_time = "swtrt_time",
  base_cov = "",
  base2_cov = "",
  aft_dist = "weibull",
  strata_main_effect_only = TRUE,
  recensor = TRUE,
  admin_recensor_only = TRUE,
  swtrt_control_only = TRUE,
  alpha = 0.05,
  ties = "efron",
  offset = 1,
  boot = TRUE,
  n_boot = 1000,
  seed = NA
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="tsesimp_+3A_data">data</code></td>
<td>
<p>The input data frame that contains the following variables:
</p>

<ul>
<li> <p><code>id</code>: The subject id.
</p>
</li>
<li> <p><code>stratum</code>: The stratum.
</p>
</li>
<li> <p><code>time</code>: The survival time for right censored data.
</p>
</li>
<li> <p><code>event</code>: The event indicator, 1=event, 0=no event.
</p>
</li>
<li> <p><code>treat</code>: The randomized treatment indicator, 1=treatment,
0=control.
</p>
</li>
<li> <p><code>censor_time</code>: The administrative censoring time. It should
be provided for all subjects including those who had events.
</p>
</li>
<li> <p><code>pd</code>: The disease progression indicator, 1=PD, 0=no PD.
</p>
</li>
<li> <p><code>pd_time</code>: The time from randomization to PD.
</p>
</li>
<li> <p><code>swtrt</code>: The treatment switch indicator, 1=switch, 0=no switch.
</p>
</li>
<li> <p><code>swtrt_time</code>: The time from randomization to treatment switch.
</p>
</li>
<li> <p><code>base_cov</code>: The baseline covariates (excluding treat).
</p>
</li>
<li> <p><code>base2_cov</code>: The baseline and secondary baseline
covariates (excluding swtrt).
</p>
</li></ul>
</td></tr>
<tr><td><code id="tsesimp_+3A_id">id</code></td>
<td>
<p>The name of the id variable in the input data.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_stratum">stratum</code></td>
<td>
<p>The name(s) of the stratum variable(s) in the input data.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_time">time</code></td>
<td>
<p>The name of the time variable in the input data.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_event">event</code></td>
<td>
<p>The name of the event variable in the input data.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_treat">treat</code></td>
<td>
<p>The name of the treatment variable in the input data.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_censor_time">censor_time</code></td>
<td>
<p>The name of the censor_time variable in the input data.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_pd">pd</code></td>
<td>
<p>The name of the pd variable in the input data.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_pd_time">pd_time</code></td>
<td>
<p>The name of the pd_time variable in the input data.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_swtrt">swtrt</code></td>
<td>
<p>The name of the swtrt variable in the input data.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_swtrt_time">swtrt_time</code></td>
<td>
<p>The name of the swtrt_time variable in the input data.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_base_cov">base_cov</code></td>
<td>
<p>The names of baseline covariates (excluding
treat) in the input data for the outcome Cox model.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_base2_cov">base2_cov</code></td>
<td>
<p>The names of secondary baseline covariates
(excluding swtrt) in the input data for the AFT model for
post-progression survival.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_aft_dist">aft_dist</code></td>
<td>
<p>The assumed distribution for time to event for the AFT
model. Options include &quot;exponential&quot;, &quot;weibull&quot; (default),
&quot;loglogistic&quot;, and &quot;lognormal&quot;.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_strata_main_effect_only">strata_main_effect_only</code></td>
<td>
<p>Whether to only include the strata main
effects in the AFT model. Defaults to <code>TRUE</code>, otherwise all
possible strata combinations will be considered in the AFT model.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_recensor">recensor</code></td>
<td>
<p>Whether to apply recensoring to counterfactual
survival times. Defaults to <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_admin_recensor_only">admin_recensor_only</code></td>
<td>
<p>Whether to apply recensoring to administrative
censoring times only. Defaults to <code>TRUE</code>. If <code>FALSE</code>,
recensoring will be applied to the actual censoring times for dropouts.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_swtrt_control_only">swtrt_control_only</code></td>
<td>
<p>Whether treatment switching occurred only in
the control group. The default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_alpha">alpha</code></td>
<td>
<p>The significance level to calculate confidence intervals.
The default value is 0.05.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_ties">ties</code></td>
<td>
<p>The method for handling ties in the Cox model, either
&quot;breslow&quot; or &quot;efron&quot; (default).</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_offset">offset</code></td>
<td>
<p>The offset to calculate the time to event, PD, and
treatment switch. We can set <code>offset</code> equal to 1 (default),
1/30.4375, or 1/365.25 if the time unit is day, month, or year.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_boot">boot</code></td>
<td>
<p>Whether to use bootstrap to obtain the confidence
interval for hazard ratio. Defaults to <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_n_boot">n_boot</code></td>
<td>
<p>The number of bootstrap samples.</p>
</td></tr>
<tr><td><code id="tsesimp_+3A_seed">seed</code></td>
<td>
<p>The seed to reproduce the bootstrap results. The default is
missing, in which case, the seed from the environment will be used.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>We use the following steps to obtain the hazard ratio estimate
and confidence interval had there been no treatment switching:
</p>

<ul>
<li><p> Fit an AFT model to post-progression survival data to estimate
the causal parameter <code class="reqn">\psi</code> based on the patients
in the control group who had disease progression.
</p>
</li>
<li><p> Derive the counterfactual survival times for control patients
had there been no treatment switching.
</p>
</li>
<li><p> Fit the Cox proportional hazards model to the observed survival times
for the experimental group and the counterfactual survival times
for the control group to obtain the hazard ratio estimate.
</p>
</li>
<li><p> If bootstrapping is used, the confidence interval and corresponding
p-value for hazard ratio are calculated based on a t-distribution with
<code>n_boot - 1</code> degrees of freedom.
</p>
</li></ul>



<h3>Value</h3>

<p>A list with the following components:
</p>

<ul>
<li> <p><code>psi</code>: The estimated causal parameter for the control group.
</p>
</li>
<li> <p><code>psi_CI</code>: The confidence interval for <code>psi</code>.
</p>
</li>
<li> <p><code>psi_CI_type</code>: The type of confidence interval for <code>psi</code>,
i.e., &quot;AFT model&quot; or &quot;bootstrap&quot;.
</p>
</li>
<li> <p><code>logrank_pvalue</code>: The two-sided p-value of the log-rank test
for an intention-to-treat (ITT) analysis.
</p>
</li>
<li> <p><code>cox_pvalue</code>: The two-sided p-value for treatment effect based on
the Cox model.
</p>
</li>
<li> <p><code>hr</code>: The estimated hazard ratio from the Cox model.
</p>
</li>
<li> <p><code>hr_CI</code>: The confidence interval for hazard ratio.
</p>
</li>
<li> <p><code>hr_CI_type</code>: The type of confidence interval for hazard ratio,
either &quot;Cox model&quot; or &quot;bootstrap&quot;.
</p>
</li>
<li> <p><code>data_aft</code>: A list of input data for the AFT model by treatment
group.
</p>
</li>
<li> <p><code>fit_aft</code>: A list of fitted AFT models by treatment group.
</p>
</li>
<li> <p><code>data_outcome</code>: The input data for the outcome Cox model.
</p>
</li>
<li> <p><code>fit_outcome</code>: The fitted outcome Cox model.
</p>
</li>
<li> <p><code>settings</code>: A list with the following components:
</p>

<ul>
<li> <p><code>aft_dist</code>: The distribution for time to event for the AFT
model.
</p>
</li>
<li> <p><code>strata_main_effect_only</code>: Whether to only include the strata
main effects in the AFT model.
</p>
</li>
<li> <p><code>recensor</code>: Whether to apply recensoring to counterfactual
survival times.
</p>
</li>
<li> <p><code>admin_recensor_only</code>: Whether to apply recensoring to
administrative censoring times only.
</p>
</li>
<li> <p><code>swtrt_control_only</code>: Whether treatment switching occurred
only in the control group.
</p>
</li>
<li> <p><code>alpha</code>: The significance level to calculate confidence
intervals.
</p>
</li>
<li> <p><code>ties</code>: The method for handling ties in the Cox model.
</p>
</li>
<li> <p><code>offset</code>: The offset to calculate the time to event, PD, and
treatment switch.
</p>
</li>
<li> <p><code>boot</code>: Whether to use bootstrap to obtain the confidence
interval for hazard ratio.
</p>
</li>
<li> <p><code>n_boot</code>: The number of bootstrap samples.
</p>
</li>
<li> <p><code>seed</code>: The seed to reproduce the bootstrap results.
</p>
</li></ul>

</li>
<li> <p><code>psi_trt</code>: The estimated causal parameter for the experimental
group if <code>swtrt_control_only</code> is <code>FALSE</code>.
</p>
</li>
<li> <p><code>psi_trt_CI</code>: The confidence interval for <code>psi_trt</code> if
<code>swtrt_control_only</code> is <code>FALSE</code>.
</p>
</li>
<li> <p><code>hr_boots</code>: The bootstrap hazard ratio estimates if <code>boot</code> is
<code>TRUE</code>.
</p>
</li>
<li> <p><code>psi_boots</code>: The bootstrap <code>psi</code> estimates if <code>boot</code> is
<code>TRUE</code>.
</p>
</li>
<li> <p><code>psi_trt_boots</code>: The bootstrap <code>psi_trt</code> estimates if
<code>boot</code> is <code>TRUE</code> and <code>swtrt_control_only</code> is
<code>FALSE</code>.
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Kaifeng Lu, <a href="mailto:kaifenglu@gmail.com">kaifenglu@gmail.com</a>
</p>


<h3>References</h3>

<p>Nicholas R Latimer, KR Abrams, PC Lambert, MK Crowther, AJ Wailoo,
JP Morden, RL Akehurst, and MJ Campbell.
Adjusting for treatment switching in randomised controlled trials - A
simulation study and a simplified two-stage method.
Statistical Methods in Medical Research. 2017;26(2):724-751.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
library(dplyr)

# the eventual survival time
shilong1 &lt;- shilong %&gt;%
  arrange(bras.f, id, tstop) %&gt;%
  group_by(bras.f, id) %&gt;%
  slice(n()) %&gt;%
  select(-c("ps", "ttc", "tran"))

# the last value of time-dependent covariates before pd
shilong2 &lt;- shilong %&gt;%
  filter(pd == 0 | tstart &lt;= dpd) %&gt;%
  arrange(bras.f, id, tstop) %&gt;%
  group_by(bras.f, id) %&gt;%
  slice(n()) %&gt;%
  select(bras.f, id, ps, ttc, tran)

# combine baseline and time-dependent covariates
shilong3 &lt;- shilong1 %&gt;%
  left_join(shilong2, by = c("bras.f", "id"))

# apply the two-stage method
fit1 &lt;- tsesimp(
  data = shilong3, id = "id", time = "tstop", event = "event",
  treat = "bras.f", censor_time = "dcut", pd = "pd",
  pd_time = "dpd", swtrt = "co", swtrt_time = "dco",
  base_cov = c("agerand", "sex.f", "tt_Lnum", "rmh_alea.c",
                "pathway.f"),
  base2_cov = c("agerand", "sex.f", "tt_Lnum", "rmh_alea.c",
                "pathway.f", "ps", "ttc", "tran"),
  aft_dist = "weibull", alpha = 0.05,
  recensor = TRUE, swtrt_control_only = FALSE, offset = 1,
  boot = FALSE)

c(fit1$hr, fit1$hr_CI)

</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
