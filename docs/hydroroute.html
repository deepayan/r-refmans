<!DOCTYPE html><html lang="en"><head><title>Help for package hydroroute</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {hydroroute}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#estimate_AE'><p>Estimate Associated Events</p></a></li>
<li><a href='#extract_AE'><p>Extract Associated Events</p></a></li>
<li><a href='#get_lag'><p>Get Lag</p></a></li>
<li><a href='#get_lag_dir'><p>Get Lag from Input Directory</p></a></li>
<li><a href='#get_lag_file'><p>Get Lag from Input File</p></a></li>
<li><a href='#merge_time'><p>Merge Events</p></a></li>
<li><a href='#peaktrace'><p>Trace Longitudinal Hydropeaking Waves Along a River Section</p></a></li>
<li><a href='#routing'><p>Estimate Models and Make Predictions</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Trace Longitudinal Hydropeaking Waves</td>
</tr>
<tr>
<td>Version:</td>
<td>0.1.2</td>
</tr>
<tr>
<td>Description:</td>
<td>Implements an empirical approach referred to as PeakTrace which uses multiple hydrographs to detect and follow hydropower plant-specific hydropeaking waves at the sub-catchment scale and to describe how hydropeaking flow parameters change along the longitudinal flow path. The method is based on the identification of associated events and uses (linear) regression models to describe translation and retention processes between neighboring hydrographs. Several regression model results are combined to arrive at a power plant-specific model. The approach is proposed and validated in Greimel et al. (2022) &lt;<a href="https://doi.org/10.1002%2Frra.3978">doi:10.1002/rra.3978</a>&gt;. The identification of associated events is based on the event detection implemented in 'hydropeak'.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a></td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 4.1.0)</td>
</tr>
<tr>
<td>Imports:</td>
<td>dplyr, ggpmisc, ggplot2, gridExtra, hydropeak, lubridate,
parallel, reshape2, stats, utils, scales</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.2.3</td>
</tr>
<tr>
<td>Suggests:</td>
<td>rmarkdown, knitr</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2023-02-08 07:43:08 UTC; gruen</td>
</tr>
<tr>
<td>Author:</td>
<td>Bettina Grün <a href="https://orcid.org/0000-0001-7265-4773"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [cre, ctb],
  Julia Haider [aut],
  Franz Greimel <a href="https://orcid.org/0000-0002-8000-1227"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [ctb]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Bettina Grün &lt;Bettina.Gruen@R-project.org&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2023-02-08 13:20:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='estimate_AE'>Estimate Associated Events</h2><span id='topic+estimate_AE'></span>

<h3>Description</h3>

<p>For two neighboring stations, potential associated
events (AEs) are determined according to the time lag and
metric (amplitude) difference allowed. For all potential AEs,
parabolas are fitted to the histogram obtained for the relative
difference in amplitude binned into intervals from -1 to 1 of
width 0.1 by fixing the vertex at the inner maximum of the
histogram and the width is determined by minimizing the average
squared distances between the parabola and the histogram data
along arbitrary symmetric ranges from the inner maximum.  Based
on the fitted parabola, cut points with the x-axis are
determined such that only those potential AEs are retained
where the relative difference is within these cut points. If
this automatic scheme does not succeed to determine suitable
cut points, e.g., because the estimated cut points are outside
-1 and 1, then a strict criterion for the relative difference
in amplitude is imposed to identify AEs considering only
deviations of at most 10%.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>estimate_AE(
  Sx,
  Sy,
  relation,
  timeLag = c(1, 1, 1),
  metricLag = c(1, 1),
  unique = c("time", "metric"),
  TimeFormat = "%Y-%m-%d %H:%M",
  tz = "Etc/GMT-1",
  settings = NULL
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="estimate_AE_+3A_sx">Sx</code></td>
<td>
<p>Data frame that consists of flow fluctuation events and
computed metrics (see
<code><a href="hydropeak.html#topic+get_events">hydropeak::get_events()</a></code>) of
an upstream hydrograph <code class="reqn">S_{x}</code>.</p>
</td></tr>
<tr><td><code id="estimate_AE_+3A_sy">Sy</code></td>
<td>
<p>Data frame that consists of flow fluctuation events and
computed metrics (see
<code><a href="hydropeak.html#topic+get_events">hydropeak::get_events()</a></code>) of
a downstream hydrograph <code class="reqn">S_{y}</code>.</p>
</td></tr>
<tr><td><code id="estimate_AE_+3A_relation">relation</code></td>
<td>
<p>Data frame that contains the relation between
upstream and downstream hydrograph. Must only contain two rows
(one for each hydrograph) in order of their location in
downstream direction.  See the appended example data
<code>relation.csv</code> or the vignette for details on the
structure. See <code><a href="#topic+get_lag">get_lag()</a></code> for further
information about the relation and the lag between the
hydrographs.</p>
</td></tr>
<tr><td><code id="estimate_AE_+3A_timelag">timeLag</code></td>
<td>
<p>Numeric vector specifying factors to alter the
interval to capture events from the downstream hydrograph. By
default it is <code>timeLag = c(1, 1, 1)</code>, this refers to
matches within a time slot <code class="reqn">\pm</code> the mean translation time
from <code>relation</code>. For exact time matches, <code>timeLag =
c(0, 1, 0)</code> must be specified.</p>
</td></tr>
<tr><td><code id="estimate_AE_+3A_metriclag">metricLag</code></td>
<td>
<p>Numeric vector specifying factors to alter the
interval of relative metric deviations to capture events from
the downstream hydrograph. By default. it is <code>metricLag =
c(1, 1)</code>, such that events are filtered where the amplitude at
<code class="reqn">S_{y}</code> is at least 0, i.e., amplitude at <code class="reqn">S_{x} -
1 \cdot</code> amplitude at <code class="reqn">S_{x}</code>, and at most two times
the amplitude at <code class="reqn">S_{x}</code>, i.e., <code class="reqn">S_{x} + 1 \cdot</code>
amplitude at <code class="reqn">S_{x}</code>.  For exact matches,
<code>metricLag = c(0, 0)</code> must be specified.</p>
</td></tr>
<tr><td><code id="estimate_AE_+3A_unique">unique</code></td>
<td>
<p>Character string specifying if the potential AEs which
meet the <code>timeLag</code> and <code>metricLag</code> condition should
be filtered to contain only unique events using <code>"time"</code>,
i.e., by selecting those where the time difference is smallest
compared to the specified factor of the mean translation time, or using
<code>"metric"</code>, i.e., by selecting those where the relative
difference in amplitude is smallest (default: <code>"time"</code>).</p>
</td></tr>
<tr><td><code id="estimate_AE_+3A_timeformat">TimeFormat</code></td>
<td>
<p>Character string giving the date-time format of
the date-time column in the input data frame (default:
&quot;%Y-%m-%d %H:%M&quot;).</p>
</td></tr>
<tr><td><code id="estimate_AE_+3A_tz">tz</code></td>
<td>
<p>Character string specifying the time zone to be used for
the conversion (default: &quot;Etc/GMT-1&quot;).</p>
</td></tr>
<tr><td><code id="estimate_AE_+3A_settings">settings</code></td>
<td>
<p>Data.frame with 3 rows and columns
<code>station.x</code>, <code>station.y</code>, <code>bound</code>, <code>lag</code>,
<code>metric</code>. <code>lag</code> needs to correspond to the unique
value specified in argument <code>timeLag</code> and <code>bound</code>
needs to contain <code>"lower"</code>, <code>"inner"</code>,
<code>"upper"</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A nested list containing the estimated settings, the
histogram obtained for the relative difference data with
estimated cut points, and the obtained &ldquo;real&rdquo; AEs.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># file paths
Sx &lt;- system.file("testdata", "Events", "100000_2_2014-01-01_2014-02-28.csv",
                  package = "hydroroute")
Sy &lt;- system.file("testdata", "Events", "200000_2_2014-01-01_2014-02-28.csv",
                  package = "hydroroute")
relation &lt;- system.file("testdata", "relation.csv", package = "hydroroute")

# read data
Sx &lt;- utils::read.csv(Sx)
Sy &lt;- utils::read.csv(Sy)
relation &lt;- utils::read.csv(relation)
relation &lt;- relation[1:2, ]

# estimate AE, exact time matches
results &lt;- estimate_AE(Sx, Sy, relation, timeLag = c(0, 1, 0))
results$settings
results$plot_threshold
results$real_AE
</code></pre>

<hr>
<h2 id='extract_AE'>Extract Associated Events</h2><span id='topic+extract_AE'></span>

<h3>Description</h3>

<p>For given relation and event data return the
associated events which comply with the conditions specified in
the settings.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>extract_AE(
  relation_path,
  events_path,
  settings_path,
  unique = c("time", "metric"),
  inputdec = ".",
  inputsep = ",",
  saveResults = FALSE,
  outdir = tempdir(),
  TimeFormat = "%Y-%m-%d %H:%M",
  tz = "Etc/GMT-1"
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="extract_AE_+3A_relation_path">relation_path</code></td>
<td>
<p>Character string containing the path of the file where
the relation file is to be read from with
<code><a href="utils.html#topic+read.csv">utils::read.csv()</a></code>. The file must contain a
column <code>ID</code> that contains the gauging station ID's in the file have to be
in order of their location in downstream direction.</p>
</td></tr>
<tr><td><code id="extract_AE_+3A_events_path">events_path</code></td>
<td>
<p>Character string containing the path of the directory
where the event files corresponding to the 'relation' file are located. Only
relevant files in this directory will be used, i.e., files that are related to
the 'relation' file.</p>
</td></tr>
<tr><td><code id="extract_AE_+3A_settings_path">settings_path</code></td>
<td>
<p>Character string containing the path of the file where
the settings file is to be read from with
<code><a href="utils.html#topic+read.csv">utils::read.csv()</a></code>. The file must be in the format
of the output of <code><a href="#topic+peaktrace">peaktrace()</a></code>.</p>
</td></tr>
<tr><td><code id="extract_AE_+3A_unique">unique</code></td>
<td>
<p>Character string specifying if the potential AEs which
meet the <code>timeLag</code> and <code>metricLag</code> condition should
be filtered to contain only unique events using <code>"time"</code>,
i.e., by selecting those where the time difference is smallest
compared to the specified factor of the mean translation time, or using
<code>"metric"</code>, i.e., by selecting those where the relative
difference in amplitude is smallest (default: <code>"time"</code>).</p>
</td></tr>
<tr><td><code id="extract_AE_+3A_inputdec">inputdec</code></td>
<td>
<p>Character string for decimal points in input data.</p>
</td></tr>
<tr><td><code id="extract_AE_+3A_inputsep">inputsep</code></td>
<td>
<p>Field separator character string for input data.</p>
</td></tr>
<tr><td><code id="extract_AE_+3A_saveresults">saveResults</code></td>
<td>
<p>A logical. If <code>FALSE</code> (default), the extracted AEs are not saved.
Otherwise the extracted AEs are written to a csv file.</p>
</td></tr>
<tr><td><code id="extract_AE_+3A_outdir">outdir</code></td>
<td>
<p>Character string naming a directory where the extraced AEs
should be saved to.</p>
</td></tr>
<tr><td><code id="extract_AE_+3A_timeformat">TimeFormat</code></td>
<td>
<p>Character string giving the date-time format of the
date-time column in the input data frame (default: &quot;%Y-%m-%d %H:%M&quot;).</p>
</td></tr>
<tr><td><code id="extract_AE_+3A_tz">tz</code></td>
<td>
<p>Character string specifying the time zone to be used for the
conversion (default: &quot;Etc/GMT-1&quot;).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame containing &ldquo;real&rdquo; AEs (i.e., events
where the time differences and the relative difference in
amplitude is within the limits and cut points provided by the
file in <code>settings_path</code>). If no AEs can be found between the first
two neighboring stations, <code>NULL</code> is returned. Otherwise the function
returns all &ldquo;real&rdquo; AEs that could be found along the river section
specified in the file from <code>relation_path</code>. A warning is issued when
the extraction is stopped early and shows the <code>IDs</code> for which no
AEs are determined.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>relation_path &lt;- system.file("testdata", "relation.csv", package = "hydroroute")
events_path &lt;- system.file("testdata", "Events", package = "hydroroute")
settings_path &lt;- system.file("testdata", "Q_event_2_AMP-LAG_aut_settings.csv",
                                   package = "hydroroute")
real_AE &lt;- extract_AE(relation_path, events_path, settings_path)
</code></pre>

<hr>
<h2 id='get_lag'>Get Lag</h2><span id='topic+get_lag'></span>

<h3>Description</h3>

<p>Given a data frame (time series) of measurements
and a vector of gauging station ID's in order of their location
in downstream direction, the lag (the amount of passing time
between two gauging stations) is estimated based on the
cross-correlation function (ccf) of the time series of two
adjacent gauging stations
(<code><a href="stats.html#topic+ccf">stats::ccf()</a></code>).  To ensure that the
same time period is used for every gauging station,
intersecting time steps are determined. These time steps are
used to estimate the lags. The result of
<code><a href="stats.html#topic+ccf">stats::ccf()</a></code> is rounded to four
decimals before selecting the optimal time lag so that minimal
differences are neglected.  If there are multiple time steps
with the highest correlation, the smallest time step is
considered. If the highest correlation corresponds to a zero
lag or positive lag (note that the result should usually be negative as
measurements at the lower gauge are later recorded as
measurements at the upper gauge), a time step of length 1 is
selected and a warning message is generated.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_lag(
  Q,
  relation,
  steplength = 15,
  lag.max = 20,
  na.action = na.pass,
  mc.cores = getOption("mc.cores", 2L),
  tz = "Etc/GMT-1",
  format = "%Y.%m.%d %H:%M",
  cols = c(1, 2, 3)
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="get_lag_+3A_q">Q</code></td>
<td>
<p>Data frame (time series) of measurements which
contains at least a column with the gauging station ID's
(default: column index 1), a column with date-time values in
character representation (default: column index 2) and a column
with flow measurements (default: column index 3).  If the column
indices differ from <code>c(1, 2, 3)</code>, they have to be
specified in the <code>cols</code> argument in the format <code>c(i,
j, k)</code>.</p>
</td></tr>
<tr><td><code id="get_lag_+3A_relation">relation</code></td>
<td>
<p>A character vector containing the gauging station
ID's in order of their location in downstream direction.</p>
</td></tr>
<tr><td><code id="get_lag_+3A_steplength">steplength</code></td>
<td>
<p>Numeric value that specifies the length between
time steps in minutes (default: <code>15</code> minutes). As time
steps have to be equispaced, this is used by
<code><a href="hydropeak.html#topic+flow">hydropeak::flow()</a></code> to get a
compatible format and fill missing time steps with <code>NA</code>.</p>
</td></tr>
<tr><td><code id="get_lag_+3A_lag.max">lag.max</code></td>
<td>
<p>Numeric value that specifies the maximum lag at
which to calculate the ccf in
<code><a href="stats.html#topic+ccf">stats::ccf()</a></code> (default: <code>20</code>).</p>
</td></tr>
<tr><td><code id="get_lag_+3A_na.action">na.action</code></td>
<td>
<p>Function to be called to handle missing values in
<code><a href="stats.html#topic+ccf">stats::ccf()</a></code> (default:
<code>na.pass</code>).</p>
</td></tr>
<tr><td><code id="get_lag_+3A_mc.cores">mc.cores</code></td>
<td>
<p>Number of cores to use with
<code><a href="parallel.html#topic+mclapply">parallel::mclapply()</a></code>. On
Windows, this is set to 1.</p>
</td></tr>
<tr><td><code id="get_lag_+3A_tz">tz</code></td>
<td>
<p>Character string specifying the time zone to be used for
internal conversion (default: <code>Etc/GMT-1</code>).</p>
</td></tr>
<tr><td><code id="get_lag_+3A_format">format</code></td>
<td>
<p>Character string giving the date-time format of the
date-time column in the input data frame <code>Q</code>. This is
passed to <code><a href="hydropeak.html#topic+flow">hydropeak::flow()</a></code>, to
get a compatible format (default: <code>YYYY.mm.dd HH:MM</code>).</p>
</td></tr>
<tr><td><code id="get_lag_+3A_cols">cols</code></td>
<td>
<p>Integer vector specifying column indices in <code>Q</code>.
The default indices are 1 (ID), 2 (date-time) and 3 (flow rate,
Q).  This is passed to
<code><a href="hydropeak.html#topic+flow">hydropeak::flow()</a></code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A character vector which contains the estimated cumulative
lag between neighboring gauging stations in the format
<code>HH:MM</code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>Q_path &lt;- system.file("testdata", "Q.csv", package = "hydroroute")
Q &lt;- utils::read.csv(Q_path)

relation_path &lt;- system.file("testdata", "relation.csv",
                            package = "hydroroute")
relation &lt;- utils::read.csv(relation_path)
# from relation data frame
get_lag(Q, relation$ID, format = "%Y-%m-%d %H:%M", tz = "Etc/GMT-1")

# station ID's in downstream direction as vector
relation &lt;- c("100000", "200000", "300000", "400000")
get_lag(Q, relation, format = "%Y-%m-%d %H:%M", tz = "Etc/GMT-1")
</code></pre>

<hr>
<h2 id='get_lag_dir'>Get Lag from Input Directory</h2><span id='topic+get_lag_dir'></span>

<h3>Description</h3>

<p>Given a file path it reads a data frame (time series)
of measurements. For each <code>relation</code> file in the
provided directory path it calls
<code><a href="#topic+get_lag_file">get_lag_file()</a></code>.  Make sure that
the file with Q data and the relation files have the same
separator (<code>inputsep</code>) and character for decimal points
(<code>inputdec</code>). Gauging station ID's in the <code>relation</code>
files have to be in order of their location in downstream
direction. The resulting lags are appended to the relation
files. The resulting list of relation files can be returned and
each relation file can be saved to its input path.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_lag_dir(
  Q,
  relation,
  steplength = 15,
  lag.max = 20,
  na.action = na.pass,
  tz = "Etc/GMT-1",
  format = "%Y.%m.%d %H:%M",
  cols = c(1, 2, 3),
  inputsep = ",",
  inputdec = ".",
  relation_pattern = "relation",
  save = FALSE,
  mc.cores = getOption("mc.cores", 2L),
  overwrite = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="get_lag_dir_+3A_q">Q</code></td>
<td>
<p>Data frame or character string. If it is a data frame, it
corresponds to the <code>Q</code> data frame in
<code><a href="#topic+get_lag">get_lag()</a></code>.  It contains at least a
column with the gauging station ID's (default: column index 1), a
column with date-time values in character representation
(default: column index 2) and a column with flow measurements
(default: column index 3). If the column indices differ from
<code>c(1, 2, 3)</code>, they have to be specified as <code>cols</code>
argument in the format <code>c(i, j, k)</code>. If it is a character
string, it contains the path to the corresponding file which is
then read within the function with
<code><a href="utils.html#topic+read.csv">utils::read.csv()</a></code>.</p>
</td></tr>
<tr><td><code id="get_lag_dir_+3A_relation">relation</code></td>
<td>
<p>A character string containing the path to the
directory where the relation files are located. They are read
within the function with
<code><a href="utils.html#topic+read.csv">utils::read.csv()</a></code>.</p>
</td></tr>
<tr><td><code id="get_lag_dir_+3A_steplength">steplength</code></td>
<td>
<p>Numeric value that specifies the length between
time steps in minutes (default: <code>15</code> minutes). As time
steps have to be equispaced, this is used by
<code><a href="hydropeak.html#topic+flow">hydropeak::flow()</a></code> to get a
compatible format and fill missing time steps with <code>NA</code>.</p>
</td></tr>
<tr><td><code id="get_lag_dir_+3A_lag.max">lag.max</code></td>
<td>
<p>Maximum lag at which to calculate the ccf in
<code><a href="stats.html#topic+ccf">stats::ccf()</a></code> (default: <code>20</code>).</p>
</td></tr>
<tr><td><code id="get_lag_dir_+3A_na.action">na.action</code></td>
<td>
<p>Function to be called to handle missing values in
<code><a href="stats.html#topic+ccf">stats::ccf()</a></code> (default:
<code>na.pass</code>).</p>
</td></tr>
<tr><td><code id="get_lag_dir_+3A_tz">tz</code></td>
<td>
<p>Character string specifying the time zone to be used for
internal conversion (default: <code>Etc/GMT-1</code>).</p>
</td></tr>
<tr><td><code id="get_lag_dir_+3A_format">format</code></td>
<td>
<p>Character string giving the date-time format of the
date-time column in the input data frame <code>Q</code>. This is
passed to <code><a href="hydropeak.html#topic+flow">hydropeak::flow()</a></code>, to
get a compatible format (default: <code>YYYY.mm.dd HH:MM</code>).</p>
</td></tr>
<tr><td><code id="get_lag_dir_+3A_cols">cols</code></td>
<td>
<p>Integer vector specifying column indices in the input
data frame which contain gauging station ID, date-time and flow
rate to be renamed. The default indices are 1 (ID), 2
(date-time) and 3 (flow rate, Q).</p>
</td></tr>
<tr><td><code id="get_lag_dir_+3A_inputsep">inputsep</code></td>
<td>
<p>Field separator character string for input data.</p>
</td></tr>
<tr><td><code id="get_lag_dir_+3A_inputdec">inputdec</code></td>
<td>
<p>Character string for decimal points in input data.</p>
</td></tr>
<tr><td><code id="get_lag_dir_+3A_relation_pattern">relation_pattern</code></td>
<td>
<p>Character string containing a regular
expression to filter <code>relation</code> files (default: <code>relation</code>, to
filter files that contain <code>relation</code> with no restriction) (see
<code><a href="base.html#topic+grep">base::grep()</a></code>).</p>
</td></tr>
<tr><td><code id="get_lag_dir_+3A_save">save</code></td>
<td>
<p>A logical. If <code>FALSE</code> (default) the lag, appended
to the relation file, overwrites the original <code>relation</code>
input file.</p>
</td></tr>
<tr><td><code id="get_lag_dir_+3A_mc.cores">mc.cores</code></td>
<td>
<p>Number of cores to use with
<code><a href="parallel.html#topic+mclapply">parallel::mclapply()</a></code>. On
Windows, this is set to 1.</p>
</td></tr>
<tr><td><code id="get_lag_dir_+3A_overwrite">overwrite</code></td>
<td>
<p>A logical. If <code>FALSE</code> (default), it produces
an error if a <code>LAG</code> column already exists in the
<code>relation</code> file. Otherwise, it overwrites an existing
column.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns invisibly a list of data frames where each list
element represents a <code>relation</code> file from the input
directory. Optionally, the data frames are used to overwrite the existing
<code>relation</code> files with the appended <code>LAG</code> column.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>Q_file &lt;- system.file("testdata", "Q.csv", package = "hydroroute")
relations_path &lt;- system.file("testdata", package = "hydroroute")
lag_list &lt;- get_lag_dir(Q_file, relations_path, inputsep = ",",
                        inputdec = ".", format = "%Y-%m-%d %H:%M",
                        overwrite = TRUE)
lag_list
</code></pre>

<hr>
<h2 id='get_lag_file'>Get Lag from Input File</h2><span id='topic+get_lag_file'></span>

<h3>Description</h3>

<p>Given a file path it reads a data frame (time series)
of measurements which combines several gauging station ID's and calls
<code><a href="#topic+get_lag">get_lag()</a></code>. The relation (ID's) of
gauging stations is read from a file (provided through the file path).
The file with <code>Q</code> data and the relation file need to 
have the same separator (<code>inputsep</code>) and character for
decimal points (<code>inputdec</code>). Gauging station ID's have to
be in order of their location in downstream direction. The
resulting lag is appended to the relation file. This can be
saved to a file.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_lag_file(
  Q_file,
  relation_file,
  steplength = 15,
  lag.max = 20,
  na.action = na.pass,
  tz = "Etc/GMT-1",
  format = "%Y.%m.%d %H:%M",
  cols = c(1, 2, 3),
  inputsep = ";",
  inputdec = ".",
  save = FALSE,
  outfile = file.path(tempdir(), "relation.csv"),
  mc.cores = getOption("mc.cores", 2L),
  overwrite = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="get_lag_file_+3A_q_file">Q_file</code></td>
<td>
<p>Data frame or character string. If it is a data
frame, it corresponds to the <code>Q</code> data frame in
<code><a href="#topic+get_lag">get_lag()</a></code>.  It contains at least a
column with the gauging station ID's (default: column index 1), a
column with date-time values in character representation
(default: column index 2) and a column with flow measurements
(default: column index 3). If the column indices differ from
<code>c(1, 2, 3)</code>, they have to be specified as <code>cols</code>
argument in the format <code>c(i, j, k)</code>. If it is a character
string, it contains the path to the corresponding file which is
then read within the function with
<code><a href="utils.html#topic+read.csv">utils::read.csv()</a></code>.</p>
</td></tr>
<tr><td><code id="get_lag_file_+3A_relation_file">relation_file</code></td>
<td>
<p>A character string containing the path to the
relation file. It is read within the function with
<code><a href="utils.html#topic+read.csv">utils::read.csv()</a></code>.  The file must
contain a column <code>ID</code> that contains the gauging station
ID's in order of their location in downstream direction. The
lag will then be appended as column to the data frame. For more
details on the relation file, see the vignette.</p>
</td></tr>
<tr><td><code id="get_lag_file_+3A_steplength">steplength</code></td>
<td>
<p>Numeric value that specifies the length between
time steps in minutes (default: <code>15</code> minutes). As time
steps have to be equispaced, this is used by
<code><a href="hydropeak.html#topic+flow">hydropeak::flow()</a></code> to get a
compatible format and fill missing time steps with <code>NA</code>.</p>
</td></tr>
<tr><td><code id="get_lag_file_+3A_lag.max">lag.max</code></td>
<td>
<p>Maximum lag at which to calculate the ccf in
<code><a href="stats.html#topic+ccf">stats::ccf()</a></code> (default: <code>20</code>).</p>
</td></tr>
<tr><td><code id="get_lag_file_+3A_na.action">na.action</code></td>
<td>
<p>Function to be called to handle missing values in
<code><a href="stats.html#topic+ccf">stats::ccf()</a></code> (default:
<code>na.pass</code>).</p>
</td></tr>
<tr><td><code id="get_lag_file_+3A_tz">tz</code></td>
<td>
<p>Character string specifying the time zone to be used for
internal conversion (default: <code>Etc/GMT-1</code>).</p>
</td></tr>
<tr><td><code id="get_lag_file_+3A_format">format</code></td>
<td>
<p>Character string giving the date-time format of the
date-time column in the input data frame <code>Q</code>. This is
passed to <code><a href="hydropeak.html#topic+flow">hydropeak::flow()</a></code>, to
get a compatible format (default: <code>YYYY.mm.dd HH:MM</code>).</p>
</td></tr>
<tr><td><code id="get_lag_file_+3A_cols">cols</code></td>
<td>
<p>Integer vector specifying column indices in the input
data frame which contain gauging station ID, date-time and flow
rate to be renamed. The default indices are 1 (ID), 2
(date-time) and 3 (flow rate, Q).</p>
</td></tr>
<tr><td><code id="get_lag_file_+3A_inputsep">inputsep</code></td>
<td>
<p>Character string for the field separator in input
data.</p>
</td></tr>
<tr><td><code id="get_lag_file_+3A_inputdec">inputdec</code></td>
<td>
<p>Character string for decimal points in input data.</p>
</td></tr>
<tr><td><code id="get_lag_file_+3A_save">save</code></td>
<td>
<p>A logical. If <code>FALSE</code> (default) the lag, appended
to the relation file, is not written to a file, otherwise it is
written to <code>outfile</code>.</p>
</td></tr>
<tr><td><code id="get_lag_file_+3A_outfile">outfile</code></td>
<td>
<p>A character string naming a file path and name where the
output file should be written to.</p>
</td></tr>
<tr><td><code id="get_lag_file_+3A_mc.cores">mc.cores</code></td>
<td>
<p>Number of cores to use with
<code><a href="parallel.html#topic+mclapply">parallel::mclapply()</a></code>. On
Windows, this is set to 1.</p>
</td></tr>
<tr><td><code id="get_lag_file_+3A_overwrite">overwrite</code></td>
<td>
<p>A logical. If <code>FALSE</code> (default), it produces
an error if a <code>LAG</code> column already exists in the
<code>relation</code> file. Otherwise, it overwrites an existing
column.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns invisibly the data frame of the relation data with
the estimated cumulative lag between neighboring gauging
stations in the format <code>HH:MM</code> appended.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>Q_file &lt;- system.file("testdata", "Q.csv", package = "hydroroute")
relation_file &lt;- system.file("testdata", "relation.csv",
                             package = "hydroroute")
get_lag_file(Q_file, relation_file, inputsep = ",", inputdec = ".",
             format = "%Y-%m-%d %H:%M", save = FALSE, overwrite = TRUE)

Q_file &lt;- read.csv(Q_file)
get_lag_file(Q_file, relation_file, inputsep = ",", inputdec = ".",
             format = "%Y-%m-%d %H:%M", save = FALSE, overwrite = TRUE)
</code></pre>

<hr>
<h2 id='merge_time'>Merge Events</h2><span id='topic+merge_time'></span>

<h3>Description</h3>

<p>Given two event data frames of neighboring stations
<code class="reqn">S_{x}</code> and <code class="reqn">S_{y}</code> that consist of flow
fluctuation events and computed metrics (see
<code><a href="hydropeak.html#topic+get_events">hydropeak::get_events()</a></code>),
the translation time indicated by the relation file as well as
<code>timeLag</code> between these two stations is subtracted from
<code class="reqn">S_{y}</code> and events are merged where matches according
to differences allowed to <code>timeLag</code> can be found.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>merge_time(
  Sx,
  Sy,
  relation,
  timeLag = c(1, 1, 1),
  TimeFormat = "%Y-%m-%d %H:%M",
  tz = "Etc/GMT-1"
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="merge_time_+3A_sx">Sx</code></td>
<td>
<p>Data frame that consists of flow fluctuation events and computed
metrics (see <code><a href="hydropeak.html#topic+get_events">hydropeak::get_events()</a></code>)
of an upstream hydrograph <code class="reqn">S_{x}</code>.</p>
</td></tr>
<tr><td><code id="merge_time_+3A_sy">Sy</code></td>
<td>
<p>Data frame that consists of flow fluctuation events and computed
metrics (see <code><a href="hydropeak.html#topic+get_events">hydropeak::get_events()</a></code>)
of a downstream hydrograph <code class="reqn">S_{y}</code>.</p>
</td></tr>
<tr><td><code id="merge_time_+3A_relation">relation</code></td>
<td>
<p>Data frame that contains the relation between upstream and
downstream hydrograph. Must only contain two rows (one for each hydrograph)
in order of their location in downstream direction.
See the appended example data <code>relation.csv</code> or vignette for details on
the structure. See <code><a href="#topic+get_lag">get_lag()</a></code> for further information
about the relation and the lag between the hydrographs.</p>
</td></tr>
<tr><td><code id="merge_time_+3A_timelag">timeLag</code></td>
<td>
<p>Numeric vector specifying factors to alter the interval to capture
events from the downstream hydrograph. By default it is
<code>timeLag = c(1, 1, 1)</code>, this refers to matches within a time slot
<code class="reqn">\pm</code> the mean translation time from <code>relation</code>. For exact time
matches, <code>timeLag = c(0, 1, 0)</code> must be specified.</p>
</td></tr>
<tr><td><code id="merge_time_+3A_timeformat">TimeFormat</code></td>
<td>
<p>Character string giving the date-time format of the
date-time column in the input data frame  (default: &quot;%Y-%m-%d %H:%M&quot;).</p>
</td></tr>
<tr><td><code id="merge_time_+3A_tz">tz</code></td>
<td>
<p>Character string specifying the time zone to be used for the
conversion (default: &quot;Etc/GMT-1&quot;).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Data frame that has a matched event at <code class="reqn">S_{x}</code> and
<code class="reqn">S_{y}</code> in each row. If no matches are detected,
<code>NULL</code> is returned.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>Sx &lt;- system.file("testdata", "Events", "100000_2_2014-01-01_2014-02-28.csv",
                  package = "hydroroute")
Sy &lt;- system.file("testdata", "Events", "200000_2_2014-01-01_2014-02-28.csv",
                  package = "hydroroute")
relation &lt;- system.file("testdata", "relation.csv", package = "hydroroute")
# read data
Sx &lt;- utils::read.csv(Sx)
Sy &lt;- utils::read.csv(Sy)
relation &lt;- utils::read.csv(relation)
relation &lt;- relation[1:2, ]

# exact matches
merged &lt;- merge_time(Sx, Sy, relation, timeLag = c(0, 1, 0))
head(merged)

# matches within +/- mean translation time
merged &lt;- merge_time(Sx, Sy, relation)
head(merged)
</code></pre>

<hr>
<h2 id='peaktrace'>Trace Longitudinal Hydropeaking Waves Along a River Section</h2><span id='topic+peaktrace'></span>

<h3>Description</h3>

<p>Estimates all settings based on the &lsquo;relation&rsquo; file of a river
section. The function uses a single &lsquo;relation&rsquo; file and determines the
settings for all neighboring stations with
<code><a href="#topic+estimate_AE">estimate_AE()</a></code> for all event types specified in
<code>event_type</code>. It fits models to describe translation and retention
processes between neighboring hydrographs, and generates plots
(see vignette for details). Given a file with initial values (see vignette),
predictions are made and visualized in a plot.
Optionally, the results can be written to a directory.
All files need to have the same separator (<code>inputsep</code>) and
character for decimal points (<code>inputdec</code>).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>peaktrace(
  relation_path,
  events_path,
  initial_values_path,
  settings_path,
  unique = c("time", "metric"),
  inputdec = ".",
  inputsep = ",",
  event_type = c(2, 4),
  saveResults = FALSE,
  outdir = tempdir(),
  TimeFormat = "%Y-%m-%d %H:%M",
  tz = "Etc/GMT-1",
  formula = y ~ x,
  model = stats::lm,
  FKM_MAX = 65,
  impute_method = base::max,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="peaktrace_+3A_relation_path">relation_path</code></td>
<td>
<p>Character string containing the path of the file where
the relation file is to be read from with
<code><a href="utils.html#topic+read.csv">utils::read.csv()</a></code>. The file must contain a
column <code>ID</code> that contains the gauging station ID. ID's in the file have to be
in order of their location in downstream direction.</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_events_path">events_path</code></td>
<td>
<p>Character string containing the path of the directory
where the event files corresponding to the &lsquo;relation&rsquo; file are located. Only
relevant files in this directory will be used, i.e., files that are related to
the &lsquo;relation&rsquo; file.</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_initial_values_path">initial_values_path</code></td>
<td>
<p>Character string containing the path of the file
which contains initial values for predictions (see vignette).</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_settings_path">settings_path</code></td>
<td>
<p>Character string containing the path where the
settings files are to be read from with
<code><a href="utils.html#topic+read.csv">utils::read.csv()</a></code> if
available. The settings files must be in the format of the
output of <code><a href="#topic+peaktrace">peaktrace()</a></code>. If missing or
incomplete, the settings are determined automatically.</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_unique">unique</code></td>
<td>
<p>Character string specifying if the potential AEs which
meet the <code>timeLag</code> and <code>metricLag</code> condition should
be filtered to contain only unique events using <code>"time"</code>,
i.e., by selecting those where the time difference is smallest
compared to the specified factor of the mean translation time, or using
<code>"metric"</code>, i.e., by selecting those where the relative
difference in amplitude is smallest (default: <code>"time"</code>).</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_inputdec">inputdec</code></td>
<td>
<p>Character string for decimal points in input data.</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_inputsep">inputsep</code></td>
<td>
<p>Field separator character string for input data.</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_event_type">event_type</code></td>
<td>
<p>Vector specifying the event type that is used to identify
event files by their file names
(see <code><a href="hydropeak.html#topic+get_events">hydropeak::get_events()</a></code>).
Default: <code>c(2, 4)</code>, i.e., increasing and decreasing events.</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_saveresults">saveResults</code></td>
<td>
<p>A logical. If <code>FALSE</code> (default), the generated plots
and the estimated settings are not saved. Otherwise the settings are written
to a csv file and the plots are saved as png and pdf files.</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_outdir">outdir</code></td>
<td>
<p>Character string naming a directory where the estimated
settings should be saved to.</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_timeformat">TimeFormat</code></td>
<td>
<p>Character string giving the date-time format of the
date-time column in the input data frame (default: &quot;%Y-%m-%d %H:%M&quot;).</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_tz">tz</code></td>
<td>
<p>Character string specifying the time zone to be used for the
conversion (default: &quot;Etc/GMT-1&quot;).</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_formula">formula</code></td>
<td>
<p>An object of class <code><a href="stats.html#topic+formula">stats::formula()</a></code>
to fit models.</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_model">model</code></td>
<td>
<p>Function which specifies the method used for fitting models
(default: <code><a href="stats.html#topic+lm">stats::lm()</a></code>). The model class must have a
<code><a href="stats.html#topic+predict">stats::predict()</a></code> function.</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_fkm_max">FKM_MAX</code></td>
<td>
<p>Numeric value that specifies the maximum fkm (see &lsquo;relation&rsquo;
file) for which predictions seem valid.</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_impute_method">impute_method</code></td>
<td>
<p>Function which specifies the method used for imputing
missing values in initial values based on potential AEs
(default: <code><a href="base.html#topic+max">base::max()</a></code>).'</p>
</td></tr>
<tr><td><code id="peaktrace_+3A_...">...</code></td>
<td>
<p>Additional arguments to be passed to the function specified in
argument <code>model</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A nested list containing an element for each event type in order as
defined in <code>event_type</code>. Each element contains again six elements,
namely a data frame of estimated settings, a '<code>gtable</code>' object that specifies
the combined plot of all stations (plot it with
<code><a href="grid.html#topic+grid.draw">grid::grid.draw()</a></code>), a data frame containing
&ldquo;real&rdquo; AEs (i.e., events where the relative difference in amplitude is within
the estimated cut points), a grid of scatterplots ('gtable' object) for
neighboring hydrographs with a regression line for each metric, a data
frame of results of the model fitting where each row contains the
corresponding stations and metric, the model type (default: &quot;lm&quot;), formula,
coefficients, number of observations and <code class="reqn">R^2</code>, and a plot of predicted
values based on the &ldquo;initial values&rdquo;.
</p>

<hr>
<h2 id='routing'>Estimate Models and Make Predictions</h2><span id='topic+routing'></span>

<h3>Description</h3>

<p>Performs the &ldquo;routing&rdquo; procedure, i.e., based on associated events,
it uses (linear) models to describe translation and retention processes
between neighboring hydrographs.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>routing(
  real_AE,
  initials,
  relation,
  formula = y ~ x,
  model = stats::lm,
  FKM_MAX = 65,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="routing_+3A_real_ae">real_AE</code></td>
<td>
<p>Data frame that contains real AEs of two neighboring hydrographs
estimated with <code><a href="#topic+estimate_AE">estimate_AE()</a></code>.</p>
</td></tr>
<tr><td><code id="routing_+3A_initials">initials</code></td>
<td>
<p>Data frame that contains initial values for predictions
(see vignette).</p>
</td></tr>
<tr><td><code id="routing_+3A_relation">relation</code></td>
<td>
<p>Data frame that contains the relation between upstream and
downstream hydrograph. Must only contain two rows (one for each hydrograph)
in order of their location in downstream direction.
See the appended example data <code>relation.csv</code> or vignette for details on
the structure. See <code><a href="#topic+get_lag">get_lag()</a></code> for further information
about the relation and the lag between the hydrographs.</p>
</td></tr>
<tr><td><code id="routing_+3A_formula">formula</code></td>
<td>
<p>An object of class <code><a href="stats.html#topic+formula">stats::formula()</a></code>
to fit models.</p>
</td></tr>
<tr><td><code id="routing_+3A_model">model</code></td>
<td>
<p>Function which specifies the method used for fitting models
(default: <code><a href="stats.html#topic+lm">stats::lm()</a></code>). The model class must have a
<code><a href="stats.html#topic+predict">stats::predict()</a></code> function.</p>
</td></tr>
<tr><td><code id="routing_+3A_fkm_max">FKM_MAX</code></td>
<td>
<p>Numeric value that specifies the maximum fkm (see relation
file) for which predictions seem valid.</p>
</td></tr>
<tr><td><code id="routing_+3A_...">...</code></td>
<td>
<p>Additional arguments to be passed to the function specified in
argument <code>model</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A nested list containing a grid of scatterplots ('gtable' object) for
neighboring hydrographs with a regression line for each metric, a data
frame of results of the model fitting where each row contains the
corresponding stations and metric, the model type (default: &quot;lm&quot;), formula,
coefficients, number of observations and <code class="reqn">R^2</code>, and a plot of predicted
values based on the &ldquo;initial values&rdquo;.
</p>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
