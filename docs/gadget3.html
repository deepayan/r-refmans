<!DOCTYPE html><html><head><title>Help for package gadget3</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {gadget3}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#aaa_lang'><p>Gadget3 language utilities</p></a></li>
<li><a href='#aab_env'><p>Gadget3 global environment</p></a></li>
<li><a href='#action_age'><p>Gadget3 age action</p></a></li>
<li><a href='#action_grow'><p>Gadget3 growth action</p></a></li>
<li><a href='#action_mature'><p>Gadget3 maturity action</p></a></li>
<li><a href='#action_migrate'><p>Gadget3 migration action</p></a></li>
<li><a href='#action_naturalmortality'><p>Gadget3 natural mortality action</p></a></li>
<li><a href='#action_order'><p>Standard gadget3 order of actions</p></a></li>
<li><a href='#action_predate'><p>Gadget3 predation actions</p></a></li>
<li><a href='#action_renewal'><p>Gadget3 renewal actions</p></a></li>
<li><a href='#action_report'><p>Gadget3 report actions</p></a></li>
<li><a href='#action_spawn'><p>Gadget3 spawning action</p></a></li>
<li><a href='#action_tagging'><p>Gadget3 tag-release action</p></a></li>
<li><a href='#action_time'><p>Gadget3 timekeeping actions</p></a></li>
<li><a href='#eval'><p>Evaluate G3 forumulas</p></a></li>
<li><a href='#formula_utils'><p>Gadget3 formula helpers</p></a></li>
<li><a href='#init_val'><p>Gadget3 parameter value setter</p></a></li>
<li><a href='#language'><p>G3 language extensions to R</p></a></li>
<li><a href='#likelihood_bounds_penalty'><p>Gadget3 likelihood bounds_penalty action</p></a></li>
<li><a href='#likelihood_catchdistribution'><p>Gadget3 likelihood actions</p></a></li>
<li><a href='#likelihood_random'><p>Gadget3 random effects likelihood actions</p></a></li>
<li><a href='#likelihood_tagging_ckmr'><p>Gadget3 CKMR likelihood</p></a></li>
<li><a href='#likelihood_understocking'><p>Gadget3 likelihood understocking action</p></a></li>
<li><a href='#params'><p>Gadget3 parameter helpers</p></a></li>
<li><a href='#run_desc'><p>Gadget3 actions into R code</p></a></li>
<li><a href='#run_r'><p>Gadget3 actions into R code</p></a></li>
<li><a href='#run_tmb'><p>Gadget3 actions into TMB code</p></a></li>
<li><a href='#step'><p>G3 stock_* transformation functions</p></a></li>
<li><a href='#stock'><p>Gadget3 stock storage</p></a></li>
<li><a href='#stock_age'><p>Gadget3 stock age dimensions</p></a></li>
<li><a href='#stock_areas'><p>Gadget3 stock area dimensions</p></a></li>
<li><a href='#stock_tag'><p>Gadget3 tag dimension</p></a></li>
<li><a href='#stock_time'><p>Gadget3 stock time dimensions</p></a></li>
<li><a href='#suitability'><p>Gadget3 suitability formulae</p></a></li>
<li><a href='#timedata'><p>Gadget3 time-based data</p></a></li>
<li><a href='#timevariable'><p>Gadget3 time-based formulas</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Globally-Applicable Area Disaggregated General Ecosystem Toolbox
V3</td>
</tr>
<tr>
<td>Version:</td>
<td>0.11-1</td>
</tr>
<tr>
<td>Date:</td>
<td>2024-03-19</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Jamie Lentin &lt;lentinj@shuttlethread.com&gt;</td>
</tr>
<tr>
<td>Description:</td>
<td>A framework to assist creation of marine ecosystem models,
             generating either 'R' or 'C++' code which can then be optimised using
             the 'TMB' package and standard 'R' tools. Principally designed to
             reproduce gadget2 models in 'TMB', but can be extended beyond
             gadget2's capabilities.
             Kasper Kristensen, Anders Nielsen, Casper W. Berg, Hans Skaug, Bradley M. Bell (2016) &lt;<a href="https://doi.org/10.18637%2Fjss.v070.i05">doi:10.18637/jss.v070.i05</a>&gt; "TMB: Automatic Differentiation and Laplace Approximation.".
             Begley, J., &amp; Howell, D. (2004) <a href="https://core.ac.uk/download/pdf/225936648.pdf">https://core.ac.uk/download/pdf/225936648.pdf</a> "An overview of Gadget, the globally applicable area-disaggregated general ecosystem toolbox. ICES.".</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://gadget-framework.github.io/gadget3/">https://gadget-framework.github.io/gadget3/</a>,
<a href="https://github.com/gadget-framework/gadget3/">https://github.com/gadget-framework/gadget3/</a></td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 4.0.0)</td>
</tr>
<tr>
<td>Imports:</td>
<td>digest, rlang (&ge; 0.4.5), stats, TMB (&ge; 1.7.0), utils,</td>
</tr>
<tr>
<td>Suggests:</td>
<td>dplyr, knitr, magrittr (&ge; 1.5), rmarkdown, unittest (&ge; 1.4)</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a></td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.0.2</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2024-03-19 11:53:03 UTC; lentinj</td>
</tr>
<tr>
<td>Author:</td>
<td>Jamie Lentin <a href="https://orcid.org/0000-0001-5727-2996"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre],
  Bjarki Thor Elvarsson
    <a href="https://orcid.org/0000-0001-5855-1188"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [aut],
  William Butler <a href="https://orcid.org/0000-0002-3286-0748"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut],
  Marine and Freshwater Research Institute (Iceland) [cph]</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2024-03-19 13:50:06 UTC</td>
</tr>
</table>
<hr>
<h2 id='aaa_lang'>Gadget3 language utilities</h2><span id='topic+g3_native'></span><span id='topic+g3_global_formula'></span>

<h3>Description</h3>

<p>Produce objects with special meaning to gadget3
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_native(r, cpp, depends = c())
g3_global_formula(f = ~noop, init_val = NULL)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="aaa_lang_+3A_r">r</code></td>
<td>

<p>An R <a href="base.html#topic+function">function</a> to decorate with a 'C++' equivalent
</p>
</td></tr>
<tr><td><code id="aaa_lang_+3A_cpp">cpp</code></td>
<td>
<p>Either: </p>

<ol>
<li><p>A character string containing the 'C++' equivalent as a Lambda function
</p>
</li>
<li><p>A character string containing 'C++' function template definition, calling the function <code> __fn__</code>
</p>
</li>
<li><p>A <a href="base.html#topic+list">list</a> of type-casts to use when calling an equivalently named native function
</p>
</li></ol>
</td></tr>
<tr><td><code id="aaa_lang_+3A_depends">depends</code></td>
<td>

<p>A <a href="base.html#topic+list">list</a> of string names of dependent functions.
The content of this and the initial <code>[]</code> for any Lambda function should match.
</p>
</td></tr>
<tr><td><code id="aaa_lang_+3A_f">f</code></td>
<td>

<p>An optional <a href="stats.html#topic+formula">formula</a> to modify the content of a globablly-defined variable
</p>
</td></tr>
<tr><td><code id="aaa_lang_+3A_init_val">init_val</code></td>
<td>

<p>An optiona <a href="stats.html#topic+formula">formula</a> to set the initial value of a globally-defined variable
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>These functions are generally for gadget3 development, but made available so actions can be produced outside the package.
</p>


<h3>Value</h3>



<h4>g3_native</h4>

<p>Returns a function that can be used in formulas for both R and TMB-based models.
</p>



<h4>g3_global_formula</h4>

<p>Returns a <a href="stats.html#topic+formula">formula</a> that will be defined globally, and this can preserve state across timesteps.
</p>



<h3>Examples</h3>

<pre><code class='language-R'># The definition of g3_env$ratio_add_vec looks like:
eg_ratio_add_vec &lt;- g3_native(r = function(orig_vec, orig_amount,
                                        new_vec, new_amount) {
    ((orig_vec * orig_amount + new_vec * new_amount)
      /
    avoid_zero_vec(orig_amount + new_amount))
}, cpp = '[&amp;avoid_zero_vec](vector&lt;Type&gt; orig_vec, vector&lt;Type&gt; orig_amount,
                            vector&lt;Type&gt; new_vec, vector&lt;Type&gt; new_amount)
                            -&gt; vector&lt;Type&gt; {
    return (orig_vec * orig_amount + new_vec * new_amount)
             /
           avoid_zero_vec(orig_amount + new_amount);
}', depends = c('avoid_zero_vec'))
# eg_ratio_add_vec() can then be used in formulas, both in R &amp; TMB.

# Define a random walk action, using g3_global_formula to keep track of
# previous value. NB: my_randomwalk_prevrec must be unique in a model
random_walk_action &lt;- g3_formula(quote({
    if (cur_time &gt; 0) nll &lt;- nll + dnorm(x, stock__prevrec, 1, 1)
    my_randomwalk_prevrec &lt;- x
}), x = 'TODO', my_randomwalk_prevrec = g3_global_formula(init_val = 0.0))

</code></pre>

<hr>
<h2 id='aab_env'>Gadget3 global environment</h2><span id='topic+g3_env'></span><span id='topic+ADREPORT'></span><span id='topic+as_integer'></span><span id='topic+as.numeric'></span><span id='topic+assert_msg'></span><span id='topic+avoid_zero'></span><span id='topic+avoid_zero_vec'></span><span id='topic+bounded'></span><span id='topic+bounded_vec'></span><span id='topic+g3_matrix_vec'></span><span id='topic+lgamma_vec'></span><span id='topic+logspace_add'></span><span id='topic+logspace_add_vec'></span><span id='topic+normalize_vec'></span><span id='topic+nvl'></span><span id='topic+pow_vec'></span><span id='topic+print_array'></span><span id='topic+ratio_add_vec'></span><span id='topic+REPORT'></span><span id='topic+REprintf'></span><span id='topic+Rprintf'></span>

<h3>Description</h3>

<p>Functions available to any gadget3 model
</p>


<h3>Details</h3>

<p><code>g3_env</code> is the top-level <a href="base.html#topic+environment">environment</a> that any gadget3 model uses,
populated with utility functions.
</p>
<p>NB: Several functions have <code>_vec</code> variants.
Due to TMB limitations these should be used when you have a vector not scalar input.
</p>


<h3>ADREPORT</h3>

<p>TMB's <code>ADREPORT</code> function. See <a href="TMB.html#topic+sdreport">sdreport</a> documentation</p>


<h3>as_integer</h3>

<p>C++ compatible equivalent to <code><a href="base.html#topic+as.integer">as.integer</a></code></p>


<h3>as.numeric</h3>

<p>R <code><a href="#topic+as.numeric">as.numeric</a></code> or TMB <code>asDouble</code></p>


<h3>assert_msg</h3>

<p>C++/R function that ensures expression is true, or stops model.
</p>
<pre>assert_msg(x &gt; 0, "x must be positive")</pre>


<h3>avoid_zero / avoid_zero_vec</h3>

<p>Adds small value to input to ensure output is never zero
</p>


<h3>bounded / bounded_vec</h3>

<p>Ensures <var>x</var> is within limits <var>a</var> &amp; <var>b</var>.
</p>
<pre>bounded_vec(x, 100, 1000)</pre>


<h3>g3_matrix_vec</h3>

<p>Apply matrix transformation <var>tf</var> to vector <var>vec</var>, return resultant vector.
</p>
<pre>g3_matrix_vec(tf, vec)</pre>


<h3>lgamma_vec</h3>

<p>Vector equivalent of <code><a href="base.html#topic+lgamma">lgamma</a></code></p>


<h3>logspace_add / logspace_add_vec</h3>

<p>TMB's <code>logspace_add</code>, essentially a differentiable version of <code><a href="base.html#topic+pmax">pmax</a></code>.
</p>


<h3>normalize_vec</h3>

<p>Divide vector <var>a</var> by it's sum, i.e. so it now sums to 1
</p>


<h3>nvl</h3>

<p>Return first non-null argument.
NB: No C++ implementation.
</p>


<h3>pow_vec</h3>

<p>Vector equivalent of <code><a href="base.html#topic++5E">^</a></code></p>


<h3>print_array</h3>

<p>Utility to pretty-print array <var>ar</var>
</p>


<h3>ratio_add_vec</h3>

<p>Sum <var>orig_vec</var> &amp; <var>new_vec</var> according to ratio of <var>orig_amount</var> &amp; <var>new_amount</var>
</p>


<h3>REPORT</h3>

<p>TMB's <code>REPORT</code> function.
</p>


<h3>REprintf</h3>

<p>Equivalent of RCpp <a href="https://teuder.github.io/rcpp4everyone_en/060_printing_massages.html#rprintf-reprintf">REprintf</a>
</p>


<h3>Rprintf</h3>

<p>Equivalent of RCpp <a href="https://teuder.github.io/rcpp4everyone_en/060_printing_massages.html#rprintf-reprintf">Rprintf</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Call g3's avoid_zero_vec directly from R
g3_env$avoid_zero_vec(c(0, 0.001, 1, 100))
</code></pre>

<hr>
<h2 id='action_age'>Gadget3 age action</h2><span id='topic+g3a_age'></span>

<h3>Description</h3>

<p>Add ageing actions to a g3 model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3a_age(
        stock,
        output_stocks = list(),
        output_ratios = rep(1/length(output_stocks),
        times = length(output_stocks)),
        run_f = ~cur_step_final,
        run_at = g3_action_order$age,
        transition_at = g3_action_order$age)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="action_age_+3A_stock">stock</code></td>
<td>

<p><code><a href="#topic+g3_stock">g3_stock</a></code> to age.
</p>
</td></tr>
<tr><td><code id="action_age_+3A_output_stocks">output_stocks</code></td>
<td>

<p>List of <code><a href="#topic+g3_stock">g3_stock</a></code>s that oldest specimens in <var>stock</var> should move into.
</p>
</td></tr>
<tr><td><code id="action_age_+3A_output_ratios">output_ratios</code></td>
<td>

<p>Vector of proportions for how to distribute into <var>output_stocks</var>, default evenly spread.
</p>
</td></tr>
<tr><td><code id="action_age_+3A_run_f">run_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> specifying a condition for running this action, default is end of model year.
</p>
</td></tr>
<tr><td><code id="action_age_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
<tr><td><code id="action_age_+3A_transition_at">transition_at</code></td>
<td>

<p>Integer order that transition actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An action (i.e. list of formula objects) that will, for the given <var>stock</var>...</p>

<ol>
<li><p>Move the final age group into temporary storage, <code>stock__transitioning_num</code> / <code>stock__transitioning_wgt</code>
</p>
</li>
<li><p>Move the contents of all other age groups into the age group above
</p>
</li>
<li><p>Move the contents of the temporary storage into <var>output_stocks</var>
</p>
</li></ol>

<p>If <var>stock</var> has only one age, and <var>output_stocks</var> has been specified, then the contentes will be moved,
if <var>output_stocks</var> is empty, then the action will do nothing.
</p>


<h3>See Also</h3>

<p><a href="https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stockmature">https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stockmature</a>,
<code><a href="#topic+g3_stock">g3_stock</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
ling_imm &lt;- g3_stock('ling_imm', seq(20, 156, 4)) %&gt;% g3s_age(3, 10)
ling_mat &lt;- g3_stock('ling_mat', seq(20, 156, 4)) %&gt;% g3s_age(5, 15)

# Ageing for immature ling
age_action &lt;- g3a_age(ling_imm,
    output_stocks = list(ling_mat))
</code></pre>

<hr>
<h2 id='action_grow'>Gadget3 growth action</h2><span id='topic+g3a_grow_lengthvbsimple'></span><span id='topic+g3a_grow_weightsimple'></span><span id='topic+g3a_grow_impl_bbinom'></span><span id='topic+g3a_growmature'></span>

<h3>Description</h3>

<p>Add growth/maturity actions to a g3 model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3a_grow_lengthvbsimple(
        linf_f = g3_parameterized('Linf', by_stock = by_stock),
        kappa_f = g3_parameterized('K', by_stock = by_stock),
        by_stock = TRUE)

g3a_grow_weightsimple(
        alpha_f = g3_parameterized('walpha', by_stock = by_stock),
        beta_f = g3_parameterized('wbeta', by_stock = by_stock),
        by_stock = TRUE)

g3a_grow_impl_bbinom(
        delta_len_f = g3a_grow_lengthvbsimple(by_stock = by_stock),
        delta_wgt_f = g3a_grow_weightsimple(by_stock = by_stock),
        beta_f = g3_parameterized('bbin', by_stock = by_stock),
        maxlengthgroupgrowth,
        by_stock = TRUE)

g3a_growmature(stock, impl_f, maturity_f = ~0, output_stocks = list(), 
    output_ratios = rep(1/length(output_stocks), times = length(output_stocks)), 
    transition_f = ~cur_step_final, run_f = ~TRUE,
    run_at = g3_action_order$grow,
    transition_at = g3_action_order$mature)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="action_grow_+3A_linf_f">linf_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> to substitute for <code class="reqn">L_\infty</code>.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_kappa_f">kappa_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> to substitute for <code class="reqn">\kappa</code>.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_alpha_f">alpha_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> to substitute for <code class="reqn">\alpha</code>.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_beta_f">beta_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> to substitute for <code class="reqn">\beta</code>.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_maxlengthgroupgrowth">maxlengthgroupgrowth</code></td>
<td>

<p>An integer with the maximum length groups an individual can jump in one step.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_stock">stock</code></td>
<td>

<p><code><a href="#topic+g3_stock">g3_stock</a></code> to grow.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_delta_len_f">delta_len_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> defining a non-negative vector for mean increase in length for <code>stock</code>
for each lengthgroup, as defined by <code><a href="#topic+g3a_grow_lengthvbsimple">g3a_grow_lengthvbsimple</a></code>.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_delta_wgt_f">delta_wgt_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> defining the corresponding weight increase as a matrix of
lengthgroup to lengthgroup delta for <code>stock</code>, as defined by <code><a href="#topic+g3a_grow_weightsimple">g3a_grow_weightsimple</a></code>.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_by_stock">by_stock</code></td>
<td>

<p>Change the default parameterisation (e.g. to be by 'species'), see <code><a href="#topic+g3_parameterized">g3_parameterized</a></code>.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_impl_f">impl_f</code></td>
<td>

<p>A pair of <a href="stats.html#topic+formula">formula</a> objects, as defined by <code><a href="#topic+g3a_grow_impl_bbinom">g3a_grow_impl_bbinom</a></code>.
Both define a matrix of length groups <code>i</code> to length group deltas <code>j</code> (0..<var>maxlengthgroupgrowth</var>),
the values in the first indicate the proportion of individuals moving from <code>i</code> to <code>i + j</code>,
the values in the second indicate the corresponding weight increase of individuals moving from <code>i</code> to <code>i + j</code>.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_maturity_f">maturity_f</code></td>
<td>

<p>A maturity <a href="stats.html#topic+formula">formula</a>, as defined by <code><a href="#topic+g3a_mature_constant">g3a_mature_constant</a></code>.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_output_stocks">output_stocks</code></td>
<td>

<p>List of <code><a href="#topic+g3_stock">g3_stock</a></code>s that maturing <var>stock</var> should move into.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_output_ratios">output_ratios</code></td>
<td>

<p>Vector of proportions for how to distribute into <var>output_stocks</var>, summing to 1, default evenly spread.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_transition_f">transition_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> specifying a contition for running maturation steps as well as growth, default final step of year.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_run_f">run_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> specifying a condition for running this action, default always runs.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
<tr><td><code id="action_grow_+3A_transition_at">transition_at</code></td>
<td>

<p>Integer order that transition actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>A model can have any number of <code>g3a_growmature</code> actions, so long as the
calling arguments are different. For instance, <code>run_f = ~age == 5</code> and
<code>run_f = ~age == 7</code>.
</p>
<p><var>impl_f</var>'s dependent variables are analysed to see what will affect growth.
If nothing but <code>cur_step_size</code> will affect growth, then growth will only
be recalculated when the step size changes.
</p>


<h3>Value</h3>



<h4>g3a_grow_lengthvbsimple</h4>

<p>Returns a <a href="stats.html#topic+formula">formula</a> for use as <var>delta_len_f</var>:
</p>
<p style="text-align: center;"><code class="reqn"> {{\Delta}L}_i = ( L_\infty - L_i )(1 - e^{-\kappa{\Delta}t}) </code>
</p>

<p>Where <code class="reqn"> \Delta{t} </code> is the length of the current timestep.
</p>



<h4>g3a_grow_weightsimple</h4>

<p>Returns a <a href="stats.html#topic+formula">formula</a> for use as <var>delta_wgt_f</var>:
</p>
<p style="text-align: center;"><code class="reqn"> {{\Delta}W}_{i,j} = \alpha ( (L_i + {{\Delta}L}_j)^\beta - {L_i}^\beta ) </code>
</p>

<p>Where <code class="reqn"> \Delta{t} </code> is the length of the current timestep,
<code class="reqn"> {{\Delta}L} </code> is all possible length group increases i.e <code>0..maxlengthgroupgrowth</code>.
</p>



<h4>g3a_grow_impl_bbinom</h4>

<p><a href="stats.html#topic+formula">formula</a> object converting mean growths using beta-binomia distribution. See <a href="https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#beta-binomial">https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#beta-binomial</a></p>



<h4>g3a_growmature</h4>

<p>An action (i.e. list of formula objects) that will, for the given <var>stock</var>...</p>

<ol>
<li><p>Move any maturing individuals into temporary storage, <code>stock__transitioning_num</code> / <code>stock__transitioning_wgt</code>
</p>
</li>
<li><p>Calculate increase in length/weight using <var>growth_f</var> and <var>impl_f</var>
</p>
</li>
<li><p>Move the contents of the temporary storage into <var>output_stocks</var>
</p>
</li></ol>



<h3>See Also</h3>

<p><a href="https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stockgrowth">https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stockgrowth</a>,
<code><a href="#topic+g3_stock">g3_stock</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ling_imm &lt;- g3_stock(c(species = 'ling', 'imm'), seq(20, 156, 4))
ling_mat &lt;- g3_stock(c(species = 'ling', 'mat'), seq(20, 156, 4))

# Growth / maturity for immature ling
growth_action &lt;- g3a_growmature(ling_imm,
    impl_f = g3a_grow_impl_bbinom(
        # Parameters will be ling.Linf, ling.K
        g3a_grow_lengthvbsimple(by_stock = 'species'),
        # Parameters will be ling_imm.walpha, ling_imm.wbeta
        g3a_grow_weightsimple(),
        maxlengthgroupgrowth = 15),
    maturity_f = g3a_mature_constant(
        alpha = g3_parameterized('ling.mat1', scale = 0.001),
        l50 = g3_parameterized('ling.mat2')),
        output_stocks = list(ling_mat))
</code></pre>

<hr>
<h2 id='action_mature'>Gadget3 maturity action</h2><span id='topic+g3a_mature_continuous'></span><span id='topic+g3a_mature_constant'></span><span id='topic+g3a_mature'></span>

<h3>Description</h3>

<p>Add maturity actions to a g3 model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3a_mature_continuous(
        alpha = g3_parameterized('mat.alpha', by_stock = by_stock),
        l50 = g3_parameterized('mat.l50', by_stock = by_stock),
        beta = 0,
        a50 = 0,
        by_stock = TRUE)

g3a_mature_constant(alpha = NULL, l50 = NA, beta = NULL, a50 = NA, gamma = NULL, 
    k50 = NA)

g3a_mature(stock, maturity_f, output_stocks, output_ratios = rep(1/length(output_stocks), 
    times = length(output_stocks)), run_f = ~TRUE,
    run_at = g3_action_order$grow,
    transition_at = g3_action_order$mature)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="action_mature_+3A_alpha">alpha</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> to substitute for <code class="reqn">\alpha</code>.
</p>
</td></tr>
<tr><td><code id="action_mature_+3A_l50">l50</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> to substitute for <code class="reqn">l_{50}</code>. Must be defined if <var>alpha</var> is defined.
</p>
</td></tr>
<tr><td><code id="action_mature_+3A_beta">beta</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> to substitute for <code class="reqn">\beta</code>.
</p>
</td></tr>
<tr><td><code id="action_mature_+3A_a50">a50</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> to substitute for <code class="reqn">a_{50}</code>. Must be defined if <var>beta</var> is defined.
</p>
</td></tr>
<tr><td><code id="action_mature_+3A_gamma">gamma</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> to substitute for <code class="reqn">\gamma</code>.
</p>
</td></tr>
<tr><td><code id="action_mature_+3A_k50">k50</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> to substitute for <code class="reqn">k_{50}</code>. Must be defined if <var>gamma</var> is defined.
</p>
</td></tr>
<tr><td><code id="action_mature_+3A_by_stock">by_stock</code></td>
<td>

<p>Change the default parameterisation (e.g. to be by 'species'), see <code><a href="#topic+g3_parameterized">g3_parameterized</a></code>.
</p>
</td></tr>
<tr><td><code id="action_mature_+3A_stock">stock</code></td>
<td>

<p><code><a href="#topic+g3_stock">g3_stock</a></code> to mature.
</p>
</td></tr>
<tr><td><code id="action_mature_+3A_maturity_f">maturity_f</code></td>
<td>

<p>A maturity <a href="stats.html#topic+formula">formula</a>, as defined by <code><a href="#topic+g3a_mature_constant">g3a_mature_constant</a></code>.
</p>
</td></tr>
<tr><td><code id="action_mature_+3A_output_stocks">output_stocks</code></td>
<td>

<p>List of <code><a href="#topic+g3_stock">g3_stock</a></code>s that maturing <var>stock</var> should move into.
</p>
</td></tr>
<tr><td><code id="action_mature_+3A_output_ratios">output_ratios</code></td>
<td>

<p>Vector of proportions for how to distribute into <var>output_stocks</var>, summing to 1, default evenly spread.
</p>
</td></tr>
<tr><td><code id="action_mature_+3A_run_f">run_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> specifying a condition for running this action, default always runs.
</p>
</td></tr>
<tr><td><code id="action_mature_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
<tr><td><code id="action_mature_+3A_transition_at">transition_at</code></td>
<td>

<p>Integer order that transition actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Generally you would use <code><a href="#topic+g3a_growmature">g3a_growmature</a></code>, which does both growth
and maturity at the same time.
</p>
<p>A model can have any number of <code>g3a_mature</code> actions, so long as the
calling arguments are different. For instance, <code>run_f = ~age == 5</code> and
<code>run_f = ~age == 7</code>.
</p>


<h3>Value</h3>



<h4>g3a_mature_continuous</h4>

<p>A <a href="stats.html#topic+formula">formula</a> object representing
</p>
<p style="text-align: center;"><code class="reqn"> m_0 * (\alpha \Delta{L} + \beta \Delta{t})^\top </code>
</p>


<dl>
<dt><code class="reqn">m_0</code></dt><dd><p>The <code><a href="#topic+g3a_mature_constant">g3a_mature_constant</a></code> formula, as defined below, using parameters supplied to <code><a href="#topic+g3a_mature_continuous">g3a_mature_continuous</a></code></p>
</dd>
<dt><code class="reqn">\Delta{L}</code></dt><dd><p>Vector of all possible changes in length, as per current growth matrix (see <a href="#topic+g3a_grow_impl_bbinom">g3a_grow_impl_bbinom</a>)</p>
</dd>
<dt><code class="reqn">\Delta{t}</code></dt><dd><p>Length of the current timestep</p>
</dd>
</dl>




<h4>g3a_mature_constant</h4>

<p>A <a href="stats.html#topic+formula">formula</a> object with the following equation
</p>
<p style="text-align: center;"><code class="reqn"> \frac{1}{ 1 + e^{-\alpha(l - l_{50}) -\beta(a - a_{50}) -\gamma(k - k_{50})}} </code>
</p>


<dl>
<dt><code class="reqn">l</code></dt><dd><p>length of stock</p>
</dd>
<dt><code class="reqn">l_{50}</code></dt><dd><p>length of stock when 50% are mature</p>
</dd>
<dt><code class="reqn">a</code></dt><dd><p>age of stock</p>
</dd>
<dt><code class="reqn">a_{50}</code></dt><dd><p>age of stock when 50% are mature</p>
</dd>
<dt><code class="reqn">k</code></dt><dd><p>weight of stock</p>
</dd>
<dt><code class="reqn">k_{50}</code></dt><dd><p>weight of stock when 50% are mature</p>
</dd>
</dl>




<h4>g3a_mature</h4>

<p>An action (i.e. list of formula objects) that will, for the given <var>stock</var>...</p>

<ol>
<li><p>Move any maturing individuals into temporary storage, <code>stock__transitioning_num</code> / <code>stock__transitioning_wgt</code>
</p>
</li>
<li><p>Move the contents of the temporary storage into <var>output_stocks</var>
</p>
</li></ol>



<h3>See Also</h3>

<p><a href="https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stockmature">https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stockmature</a>,
<code><a href="#topic+g3a_growmature">g3a_growmature</a></code>,
<code><a href="#topic+g3_stock">g3_stock</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ling_imm &lt;- g3_stock('ling_imm', seq(20, 156, 4))
ling_mat &lt;- g3_stock('ling_mat', seq(20, 156, 4))

# Maturity for immature ling
maturity_action &lt;- g3a_mature(ling_imm,
    maturity_f = g3a_mature_continuous(),
    output_stocks = list(ling_mat))
</code></pre>

<hr>
<h2 id='action_migrate'>Gadget3 migration action</h2><span id='topic+g3a_migrate_normalize'></span><span id='topic+g3a_migrate'></span>

<h3>Description</h3>

<p>Add migration to a g3 model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3a_migrate_normalize(row_total = 1)

g3a_migrate(stock, migrate_f, normalize_f = g3a_migrate_normalize(),
            run_f = TRUE,
            run_at = g3_action_order$migrate)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="action_migrate_+3A_row_total">row_total</code></td>
<td>

<p>When calculating the proportion of individuals that will stay in place, use this total
for what rows are expected to sum to.
</p>
</td></tr>
<tr><td><code id="action_migrate_+3A_stock">stock</code></td>
<td>

<p>The <code><a href="#topic+g3_stock">g3_stock</a></code> that will migrate in this action.
</p>
</td></tr>
<tr><td><code id="action_migrate_+3A_migrate_f">migrate_f</code></td>
<td>

<p>A formula describing the migration in terms of (source) <code>area</code> and <code>dest_area</code>.
</p>
</td></tr>
<tr><td><code id="action_migrate_+3A_normalize_f">normalize_f</code></td>
<td>

<p>Function to normalize a vector of possible destinations, to make sure fish
aren't added or destroyed.
</p>
</td></tr>
<tr><td><code id="action_migrate_+3A_run_f">run_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> specifying a condition for running this action, default always runs.
</p>
</td></tr>
<tr><td><code id="action_migrate_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that spawning actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>To restrict movement to a particular step in a year, or a particular area, use <var>run_f</var>.
For example:
</p>

<dl>
<dt><code>cur_step == 1</code></dt><dd><p>Migration will happen on first step of every year</p>
</dd>
<dt><code>cur_step == 1 &amp;&amp; cur_year &gt;= 1990</code></dt><dd><p>Migration will happen on first step of every year after 1990</p>
</dd>
<dt><code>cur_step == 2 &amp;&amp; area = 1</code></dt><dd><p>Migration will happen on second step of every year, in the first area</p>
</dd>
</dl>

<p>Multiple migration actions can be added, for a separate spring and autumn migration, for instance.
</p>
<p>The action will define the following stock instance variables for each given <var>stock</var>:
</p>

<dl>
<dt><var>stock__migratematrix</var></dt><dd><p><code class="reqn">a \times a</code> array, containing proportion of (stock) moved from one area to another. If NaN, no movement has occurred</p>
</dd>
</dl>



<h3>Value</h3>



<h4>g3a_migrate_normalize</h4>

<p>A formula transforming <code>stock__migratematrix[,stock__area_idx]</code> (i.e.
all possible destinations from a given area) by:
</p>

<ol>
<li><p>Squaring so values are all positive
</p>
</li>
<li><p>Altering the proportion of static individuals so a row sums to <var>row_total</var>
</p>
</li>
<li><p>Dividing by row_total so a row sums to 1
</p>
</li></ol>




<h4>g3a_migrate</h4>

<p>An action (i.e. list of formula objects) that will, for the given <var>stock</var>...</p>

<ol>
<li><p>Fill in <var>stock__migratematrix</var> using <var>migrate_f</var> and <var>normalize_f</var>
</p>
</li>
<li><p>Apply movement to <var>stock</var>
</p>
</li></ol>



<h3>See Also</h3>

<p><code><a href="#topic+g3_stock">g3_stock</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
areas &lt;- list(a=1, b=2, c=3, d=4)

# NB: stock doesn't live in b, so won't figure in stock_acd__migratematrix
stock_acd &lt;- (g3_stock('stock_acd', seq(10, 40, 10))
    %&gt;% g3s_livesonareas(areas[c('a', 'c', 'd')]))

movement_action &lt;- list(
    g3a_migrate(
        stock_acd,
        # In spring, individuals in area 'a' will migrate to 'd'.
        ~if (area == area_a &amp;&amp; dest_area == area_d) 0.8 else 0,
        run_f = ~cur_step == 2),
    g3a_migrate(
        stock_acd,
        # In autumn, individuals in all areas will migrate to 'a'
        ~if (dest_area == area_a) 0.8 else 0,
        run_f = ~cur_step == 4),
    list())
</code></pre>

<hr>
<h2 id='action_naturalmortality'>Gadget3 natural mortality action</h2><span id='topic+g3a_naturalmortality_exp'></span><span id='topic+g3a_naturalmortality'></span>

<h3>Description</h3>

<p>Add natural mortality to a g3 model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3a_naturalmortality_exp(
        param_f = g3_parameterized('M', by_stock = by_stock, by_age = TRUE),
        by_stock = TRUE,
        action_step_size_f = ~cur_step_size)

g3a_naturalmortality(
        stock,
        mortality_f = g3a_naturalmortality_exp(),
        run_f = TRUE,
        run_at = g3_action_order$naturalmortality)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="action_naturalmortality_+3A_param_f">param_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> to substitute for <code class="reqn">m</code>.
</p>
</td></tr>
<tr><td><code id="action_naturalmortality_+3A_action_step_size_f">action_step_size_f</code></td>
<td>

<p>How much model time passes in between runs of action? defaults to <code>~cur_step_size</code>, i.e. every step.
Use <code>action_step_size_f = 1</code> if action only runs yearly.
</p>
</td></tr>
<tr><td><code id="action_naturalmortality_+3A_by_stock">by_stock</code></td>
<td>

<p>Change the default parameterisation (e.g. to be by 'species'), see <code><a href="#topic+g3_parameterized">g3_parameterized</a></code>.
</p>
</td></tr>
<tr><td><code id="action_naturalmortality_+3A_stock">stock</code></td>
<td>

<p><code><a href="#topic+g3_stock">g3_stock</a></code> mortality applies to.
</p>
</td></tr>
<tr><td><code id="action_naturalmortality_+3A_mortality_f">mortality_f</code></td>
<td>

<p>A mortality <a href="stats.html#topic+formula">formula</a>, as defined by <code><a href="#topic+g3a_naturalmortality_exp">g3a_naturalmortality_exp</a></code>.
</p>
</td></tr>
<tr><td><code id="action_naturalmortality_+3A_run_f">run_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> specifying a condition for running this action, default always runs.
</p>
</td></tr>
<tr><td><code id="action_naturalmortality_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>A model can have any number of <code>g3a_naturalmortality</code> actions, so long as the
calling arguments are different. For instance, <code>run_f = ~age == 5</code> and
<code>run_f = ~age == 7</code>.
</p>


<h3>Value</h3>



<h4>g3a_naturalmortality_exp</h4>

<p>A <a href="stats.html#topic+formula">formula</a> object with the following equation
</p>
<p style="text-align: center;"><code class="reqn"> e^{-m \Delta t} </code>
</p>


<dl>
<dt><code class="reqn">\Delta t</code></dt><dd><p>length of current timestep</p>
</dd>
</dl>




<h4>g3a_naturalmortality</h4>

<p>An action (i.e. list of formula objects) that will, for the given <var>stock</var>...</p>

<ol>
<li><p>Remove a proportion of each stock group as calculated by the mortality formula <code>mortality_f</code>
</p>
</li></ol>



<h3>See Also</h3>

<p><a href="https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stocknatmort">https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stocknatmort</a>,
<code><a href="#topic+g3a_growmature">g3a_growmature</a></code>,
<code><a href="#topic+g3_stock">g3_stock</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
ling_imm &lt;- g3_stock('ling_imm', seq(20, 156, 4)) %&gt;% g3s_age(3, 10)

# Natural mortality for immature ling
naturalmortality_action &lt;- g3a_naturalmortality(ling_imm)

# NB: M is used in both g3a_naturalmortality and g3a_renewal_initabund, to
# customise, you need to make sure the definitions are in sync, for example:

M &lt;- g3_parameterized('M', by_stock = TRUE, by_age = FALSE)
actions &lt;- list(
    g3a_naturalmortality(ling_imm,
        g3a_naturalmortality_exp(M)),
    g3a_initialconditions_normalparam(ling_imm,
        factor_f = g3a_renewal_initabund(M = M)),
    NULL)
</code></pre>

<hr>
<h2 id='action_order'>Standard gadget3 order of actions</h2><span id='topic+g3_action_order'></span>

<h3>Description</h3>

<p>Constant defining standard order of actions
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_action_order

</code></pre>


<h3>Details</h3>

<p>All gadget3 actions have a <var>run_at</var> parameter. This decides the point in
the model that the action will happen relative to others.
</p>
<p>The defaults for these are set via <code>g3_action_order</code>.
</p>


<h3>Value</h3>

<p>A named integer list
</p>


<h3>See Also</h3>

<p><a href="https://gadget-framework.github.io/gadget2/userguide/chap-order.html">https://gadget-framework.github.io/gadget2/userguide/chap-order.html</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># The default action order
unlist(g3_action_order)

# View single value
g3_action_order$age

</code></pre>

<hr>
<h2 id='action_predate'>Gadget3 predation actions</h2><span id='topic+g3a_predate_catchability_totalfleet'></span><span id='topic+g3a_predate_catchability_numberfleet'></span><span id='topic+g3a_predate_catchability_linearfleet'></span><span id='topic+g3a_predate_catchability_effortfleet'></span><span id='topic+g3a_predate_catchability_quotafleet'></span><span id='topic+g3a_predate_fleet'></span><span id='topic+g3a_predate_totalfleet'></span>

<h3>Description</h3>

<p>Add predation to a g3 model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3a_predate_catchability_totalfleet(E)

g3a_predate_catchability_numberfleet(E)

g3a_predate_catchability_linearfleet(E)

g3a_predate_catchability_effortfleet(catchability_fs, E)

g3a_predate_catchability_quotafleet(quota_table, E,
                                    sum_stocks = list(),
                                    recalc_f = NULL)

g3a_predate_fleet(fleet_stock, prey_stocks, suitabilities, catchability_f,
    overconsumption_f = quote(
        logspace_add_vec(stock__consratio * -1e3, 0.95 * -1e3) / -1e3 ),
    run_f = ~TRUE, run_at = g3_action_order$predate)

# NB: Deprecated interface, use g3a_predate_fleet with g3a_predate_catchability_totalfleet
g3a_predate_totalfleet(fleet_stock, prey_stocks, suitabilities, amount_f,
    overconsumption_f = quote(
        logspace_add_vec(stock__consratio * -1e3, 0.95 * -1e3) / -1e3 ),
    run_f = ~TRUE, run_at = g3_action_order$predate)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="action_predate_+3A_fleet_stock">fleet_stock</code></td>
<td>

<p><code><a href="#topic+g3_stock">g3_stock</a></code> that describes the harvesting fleet.
</p>
</td></tr>
<tr><td><code id="action_predate_+3A_prey_stocks">prey_stocks</code></td>
<td>

<p>List of <code><a href="#topic+g3_stock">g3_stock</a></code>s that maturing <var>stock</var> should move into.
</p>
</td></tr>
<tr><td><code id="action_predate_+3A_suitabilities">suitabilities</code></td>
<td>

<p>Either a list of stock names to <a href="stats.html#topic+formula">formula</a> objects, with an optional unnamed
default option, or a <a href="stats.html#topic+formula">formula</a> object (which is always used).
</p>
<p>Each <a href="stats.html#topic+formula">formula</a> should define suitability of a stock, for example
by using <code><a href="#topic+g3_suitability_exponentiall50">g3_suitability_exponentiall50</a></code>.
</p>
</td></tr>
<tr><td><code id="action_predate_+3A_catchability_f">catchability_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> generated by one of the <code>g3a_predate_catchability_*</code> functions,
which define the total biomass a fleet is able to catch.
</p>
</td></tr>
<tr><td><code id="action_predate_+3A_e">E</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> defining total catch a fleet can harvest at the current time/area (totalfleet/numberfleet),
or a scaling factor used to define the stock caught (linearfleet/effortfleet/quotafleet).
</p>
</td></tr>
<tr><td><code id="action_predate_+3A_catchability_fs">catchability_fs</code></td>
<td>

<p>Either a list of stock names to <a href="stats.html#topic+formula">formula</a> objects, with an optional unnamed
default option, or a <a href="stats.html#topic+formula">formula</a> object (which is always used).
</p>
</td></tr>
<tr><td><code id="action_predate_+3A_quota_table">quota_table</code></td>
<td>

<p>A data.frame with 'biomass' and 'quota' columns,
'biomass' a numeric column, an upper bound for total biomass amount, the final value always being <code>Inf</code>.
'quota' being a list of <code><a href="stats.html#topic+formula">formula</a></code>s, defining the quota for each, e.g. with <code><a href="#topic+g3_parameterized">g3_parameterized</a></code>.
</p>
</td></tr>
<tr><td><code id="action_predate_+3A_sum_stocks">sum_stocks</code></td>
<td>

<p>Either a list of <a href="#topic+g3_stock">g3_stock</a> objects to sum when choosing a value from <var>quote_table</var>,
or <code>NULL</code>, in which case choose the quota based on the current prey.
</p>
</td></tr>
<tr><td><code id="action_predate_+3A_recalc_f">recalc_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> denoting when to recalculate the current quota. For example <code>~cur_step == 1</code>
will ensure the quota is only recalculated at the beginning of the year.
</p>
</td></tr>
<tr><td><code id="action_predate_+3A_amount_f">amount_f</code></td>
<td>

<p>Equivalent to <var>E</var> passed to <a href="#topic+g3a_predate_catchability_totalfleet">g3a_predate_catchability_totalfleet</a>.
</p>
</td></tr>
<tr><td><code id="action_predate_+3A_overconsumption_f">overconsumption_f</code></td>
<td>

<p>Overconsumption rule, a formula that should cap all values in <var>stock__consratio</var> to &lt;= 95
</p>
</td></tr>
<tr><td><code id="action_predate_+3A_run_f">run_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> specifying a condition for running this action, default always runs.
</p>
</td></tr>
<tr><td><code id="action_predate_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p><code>g3a_predate_fleet</code> will, given a <code><a href="#topic+g3_fleet">g3_fleet</a></code> &quot;predator&quot; and <code><a href="#topic+g3_stock">g3_stock</a></code> prey,
add predation into a model. The behaviour is driven by 2 parameters:
</p>

<dl>
<dt><var>suitabilities</var></dt><dd><p>Defines a predator's preference within a prey stock, normally one of the suitability functions, e.g. <code><a href="#topic+g3_suitability_exponentiall50">g3_suitability_exponentiall50</a></code> </p>
</dd>
<dt><var>catchability_f</var></dt><dd><p>Defines a predator's overall requirements, set with one of the catchability functions, e.g. <code><a href="#topic+g3a_predate_catchability_totalfleet">g3a_predate_catchability_totalfleet</a></code>  </p>
</dd>
</dl>

<p>For the definition of each catchability function, see the values section below.
</p>


<h4>Details for custom actions</h4>

<p>The actions will define the following stock instance variables for each given <var>fleet_stock</var> and <var>prey_stock</var>:
</p>

<dl>
<dt><var>prey_stock__suit_fleet_stock</var></dt><dd><p>Suitability of (prey_stock) for (fleet_stock), in a prey array.
i.e. the result of calculating the formula in <var>suitabilities</var> for the current state of the prey</p>
</dd>
<dt><var>prey_stock__predby_predstock</var></dt><dd><p>Biomass of (prey_stock) caught by (fleet_stock), in a prey array</p>
</dd>
<dt><var>fleet_stock__catch</var></dt><dd><p>Biomass of all prey caught by (fleet stock), in a fleet array</p>
</dd>
<dt><var>prey_stock__totalpredate</var></dt><dd><p>Biomass of total consumed (prey_stock), in a prey array</p>
</dd>
<dt><var>prey_stock__consratio</var></dt><dd><p>Ratio of prey_stock__totalpredate / (current biomass), capped by <var>overconsumption_f</var></p>
</dd>
</dl>

<p>A model can have any number of <code>g3a_predate_*</code> actions, so long as the
calling arguments are different. For instance, <code>run_f = ~age == 5</code> and
<code>run_f = ~age == 7</code>.
</p>



<h3>Value</h3>



<h4>g3a_predate_catchability_totalfleet</h4>

<p>A <a href="stats.html#topic+formula">formula</a> that defines a fleet's desired catch by total biomass (e.g. landings data):
</p>
<p style="text-align: center;"><code class="reqn"> \frac{E N_{sl} W_{sl}}{\displaystyle \sum_{\it stocks} \sum_{\it lengths} N_{sl} W_{sl}} </code>
</p>


<dl>
<dt><code class="reqn">E</code></dt><dd><p><var>E</var> argument, biomass caught by fleet. Generally a <code><a href="#topic+g3_timeareadata">g3_timeareadata</a></code> table containing landings data, with year/step/area/weight columns</p>
</dd>
<dt><code class="reqn">N</code></dt><dd><p>Number of stock in length cell</p>
</dd>
<dt><code class="reqn">W</code></dt><dd><p>Mean weight of stock in length cell</p>
</dd>
</dl>




<h4>g3a_predate_catchability_numberfleet</h4>

<p>A <a href="stats.html#topic+formula">formula</a> that defines a fleet's desired catch by total number of stock landed (not the biomass):
</p>
<p style="text-align: center;"><code class="reqn"> \frac{E N_{sl}}{\displaystyle \sum_{\it stocks} \sum_{\it lengths} N_{sl}} </code>
</p>


<dl>
<dt><code class="reqn">E</code></dt><dd><p><var>E</var> argument, numbers caught by fleet. Generally a <code><a href="#topic+g3_timeareadata">g3_timeareadata</a></code> table containing landings data, or a constant quota</p>
</dd>
<dt><code class="reqn">N</code></dt><dd><p>Number of stock in length cell</p>
</dd>
</dl>




<h4>g3a_predate_catchability_linearfleet</h4>

<p>A <a href="stats.html#topic+formula">formula</a> object that defines a linear relationship between desired catch and available biomass:
</p>
<p style="text-align: center;"><code class="reqn"> E \Delta t N_{sl} W_{sl} </code>
</p>


<dl>
<dt><code class="reqn">E</code></dt><dd><p><var>E</var> argument, scaling factor for the stock that is to be caught, per month</p>
</dd>
<dt><code class="reqn">\Delta t</code></dt><dd><p>length of current timestep in months</p>
</dd>
<dt><code class="reqn">N</code></dt><dd><p>Number of stock in length cell</p>
</dd>
<dt><code class="reqn">W</code></dt><dd><p>Mean weight of stock in length cell</p>
</dd>
</dl>




<h4>g3a_predate_catchability_effortfleet</h4>

<p>This is a multi-species extension to linearfleet, allowing differently-parameterized catchability per-stock.
Returns a <a href="stats.html#topic+formula">formula</a> object that defines:
</p>
<p style="text-align: center;"><code class="reqn"> c_{s} E \Delta t N_{sl} W_{sl} </code>
</p>


<dl>
<dt><code class="reqn">c_{s}</code></dt><dd><p><var>catchability_fs</var> argument for the current stock</p>
</dd>
<dt><code class="reqn">E</code></dt><dd><p><var>E</var> argument, scaling factor for the stock that is to be caught, per month</p>
</dd>
<dt><code class="reqn">\Delta t</code></dt><dd><p>length of current timestep in months</p>
</dd>
<dt><code class="reqn">N</code></dt><dd><p>Number of stock in length cell</p>
</dd>
<dt><code class="reqn">W</code></dt><dd><p>Mean weight of stock in length cell</p>
</dd>
</dl>




<h4>g3a_predate_catchability_quotafleet</h4>

<p>A <a href="stats.html#topic+formula">formula</a> onject that defines catch based on the available biomass of the stock multiplied by a scaling factor set according to a simple harvest control rule:
</p>
<p style="text-align: center;"><code class="reqn"> q E \Delta t N_{sl} W_{sl} </code>
</p>


<dl>
<dt><code class="reqn">q</code></dt><dd>
<p>quota selected from <var>quota_table</var>, corresponding to the total biomass of <var>sum_stocks</var>.
For example, given <code>data.frame(biomass = c(10000, Inf), quota = I(list(g3_parameterized('quota.low'), g3_parameterized('quota.high'))))</code>,
'quota.low' will be chosen when total biomass is less than 10000, otherwise 'quota.high' will be used.
</p>
</dd>
<dt><code class="reqn">E</code></dt><dd><p><var>E</var> argument, scaling factor for the stock that is to be caught, per month</p>
</dd>
<dt><code class="reqn">\Delta t</code></dt><dd><p>length of current timestep</p>
</dd>
<dt><code class="reqn">N</code></dt><dd><p>Number of stock in length cell</p>
</dd>
<dt><code class="reqn">W</code></dt><dd><p>Mean weight of stock in length cell</p>
</dd>
</dl>

<p>...if <var>recalc_f</var> is set, this will only be recaculated when true. Any other step
will use the previous value.
</p>



<h4>g3a_predate_fleet</h4>

<p>An action (i.e. list of formula objects) that will...</p>

<ol>
<li><p>Zero fleet and prey catch counters
</p>
</li>
<li><p>For each prey, collect maximum desired by fleet for all prey, into a <var>prey_stock__predby_predstock</var> variable
</p>
</li>
<li><p>After all fleet consumption is done, scale consumption using <var>catchability_f</var>, sum into <var>prey_stock__totalpredate</var>
</p>
</li>
<li><p>After all consumption is done, temporarily convert <var>prey_stock__predby_predstock</var> to a proprotion of <var>prey_stock__totalpredate</var>
</p>
</li>
<li><p>Calculate <var>prey_stock__consratio</var> (ratio of consumed to available), capping using <var>overconsumption_f</var>. Update <var>prey_stock__num</var>
</p>
</li>
<li><p>Recalculate <var>prey_stock__predby_predstock</var>, <var>fleet_stock__catch</var>, post-overconsumption
</p>
</li></ol>



<h3>See Also</h3>

<p><a href="https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stockpredator">https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stockpredator</a>,
<code><a href="#topic+g3_stock">g3_stock</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
areas &lt;- c(a = 1, b = 2)
ling_imm &lt;- g3_stock(c(species = 'ling', 'imm'), seq(20, 156, 4)) %&gt;% g3s_age(3, 10)
ling_mat &lt;- g3_stock(c(species = 'ling', 'mat'), seq(20, 156, 4)) %&gt;% g3s_age(5, 15)
lln &lt;- g3_fleet('lln') %&gt;% g3s_livesonareas(areas[c('a', 'b')])

# Invent a lln_landings table
lln_landings &lt;- expand.grid(
    year = 1999:2000,
    step = c(1, 2),
    area = areas[c('a', 'b')])
lln_landings$total_weight &lt;- floor(runif(nrow(lln_landings), min=100, max=999))

# g3a_predate_catchability_totalfleet(): Set catch accordings to landings data
predate_action &lt;- g3a_predate_fleet(
    lln,
    list(ling_imm, ling_mat),
    suitabilities = g3_suitability_exponentiall50(by_stock = 'species'),
    catchability_f = g3a_predate_catchability_totalfleet(
        g3_timeareadata('lln_landings', lln_landings, "total_weight") ))

# g3a_predate_catchability_numberfleet(): Fixed quota of 1000 fish
predate_action &lt;- g3a_predate_fleet(
    lln,
    list(ling_imm, ling_mat),
    suitabilities = g3_suitability_exponentiall50(by_stock = 'species'),
    catchability_f = g3a_predate_catchability_numberfleet(
        g3_parameterized(
            'quota',
            value = 1000,
            by_predator = TRUE,
            scale = 0.5,
            optimise = FALSE) ))
attr(suppressWarnings(g3_to_r(list(predate_action))), 'parameter_template')
</code></pre>

<hr>
<h2 id='action_renewal'>Gadget3 renewal actions</h2><span id='topic+g3a_renewal_vonb_recl'></span><span id='topic+g3a_renewal_vonb_t0'></span><span id='topic+g3a_renewal_vonb'></span><span id='topic+g3a_renewal_initabund'></span><span id='topic+g3a_initialconditions'></span><span id='topic+g3a_initialconditions_normalparam'></span><span id='topic+g3a_initialconditions_normalcv'></span><span id='topic+g3a_renewal'></span><span id='topic+g3a_renewal_normalparam'></span><span id='topic+g3a_renewal_normalcv'></span>

<h3>Description</h3>

<p>Add renewal / initialconditions to a g3 model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3a_renewal_vonb_recl(
        Linf = g3_parameterized('Linf', value = 1, by_stock = by_stock),
        K = g3_parameterized('K', value = 1, by_stock = by_stock),
        recl = g3_parameterized('recl', by_stock = by_stock),
        recage = g3_parameterized('recage', by_stock = FALSE, optimise = FALSE),
        by_stock = TRUE)

g3a_renewal_vonb_t0(
        Linf = g3_parameterized('Linf', value = 1, by_stock = by_stock),
        K = g3_parameterized('K', value = 1, by_stock = by_stock),
        t0 = g3_parameterized('t0', by_stock = by_stock),
        by_stock = TRUE)

g3a_renewal_initabund(
    scalar = g3_parameterized('init.scalar', value = 1, by_stock = by_stock),
    init = g3_parameterized('init', value = 1, by_stock = by_stock, by_age = TRUE),
    M = g3_parameterized('M', by_stock = by_stock, by_age = TRUE),
    init_F = g3_parameterized('init.F', by_stock = by_stock_f),
    recage = g3_parameterized('recage', by_stock = FALSE, optimise = FALSE),
    proportion_f = ~1,
    by_stock = TRUE,
    by_stock_f = FALSE)

g3a_initialconditions(stock, num_f, wgt_f, run_f = ~cur_time == 0L,
        run_at = g3_action_order$initial)

g3a_initialconditions_normalparam(
        stock,
        factor_f = g3a_renewal_initabund(by_stock = by_stock),
        mean_f = g3a_renewal_vonb_t0(by_stock = by_stock),
        stddev_f = g3_parameterized('init.sd', value = 10,
            by_stock = by_stock, by_age = by_age),
        alpha_f = g3_parameterized('walpha', by_stock = wgt_by_stock),
        beta_f = g3_parameterized('wbeta', by_stock = wgt_by_stock),
        age_offset = quote( cur_step_size ),
        by_stock = TRUE,
        by_age = FALSE,
        wgt_by_stock = TRUE,
        run_f = ~cur_time == 0L,
        run_at = g3_action_order$initial)

g3a_initialconditions_normalcv(
        stock,
        factor_f = g3a_renewal_initabund(by_stock = by_stock),
        mean_f = g3a_renewal_vonb_t0(by_stock = by_stock),
        cv_f = g3_parameterized('lencv', by_stock = by_stock, value = 0.1,
            optimise = FALSE),
        alpha_f = g3_parameterized('walpha', by_stock = wgt_by_stock),
        beta_f = g3_parameterized('wbeta', by_stock = wgt_by_stock),
        age_offset = quote( cur_step_size ),
        by_stock = TRUE,
        by_age = FALSE,
        wgt_by_stock = TRUE,
        run_f = ~cur_time == 0L,
        run_at = g3_action_order$initial)

g3a_renewal(stock, num_f, wgt_f, run_f = ~TRUE,
        run_at = g3_action_order$renewal)

g3a_renewal_normalparam(
        stock,
        factor_f = g3_parameterized('rec',
            by_stock = by_stock,
            by_year = TRUE,
            scale = g3_parameterized(
                name = 'rec.scalar',
                by_stock = by_stock),
            ifmissing = NaN),
        mean_f = g3a_renewal_vonb_t0(by_stock = by_stock),
        stddev_f = g3_parameterized('rec.sd', value = 10, by_stock = by_stock),
        alpha_f = g3_parameterized('walpha', by_stock = wgt_by_stock),
        beta_f = g3_parameterized('wbeta', by_stock = wgt_by_stock),
        by_stock = TRUE,
        wgt_by_stock = TRUE,
        run_age = quote(stock__minage),
        run_projection = FALSE,
        run_step = 1,
        run_f = NULL,
        run_at = g3_action_order$renewal)

g3a_renewal_normalcv(
        stock,
        factor_f = g3_parameterized('rec',
            by_stock = by_stock,
            by_year = TRUE,
            scale = g3_parameterized(
                name = 'rec.scalar',
                by_stock = by_stock),
            ifmissing = NaN),
        mean_f = g3a_renewal_vonb_t0(by_stock = by_stock),
        cv_f = g3_parameterized('lencv', by_stock = by_stock, value = 0.1,
            optimise = FALSE),
        alpha_f = g3_parameterized('walpha', by_stock = wgt_by_stock),
        beta_f = g3_parameterized('wbeta', by_stock = wgt_by_stock),
        by_stock = TRUE,
        wgt_by_stock = TRUE,
        run_age = quote(stock__minage),
        run_projection = FALSE,
        run_step = 1,
        run_f = NULL,
        run_at = g3_action_order$renewal)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="action_renewal_+3A_stock">stock</code></td>
<td>

<p>The <code><a href="#topic+g3_stock">g3_stock</a></code> to apply to
</p>
</td></tr>
<tr><td><code id="action_renewal_+3A_num_f">num_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> that produces a lengthgroup vector of number of individuals for the current age/area/... length group.
</p>
</td></tr>
<tr><td><code id="action_renewal_+3A_wgt_f">wgt_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> that produces a lenghgroup vector of mean weight for the current age/area/... length group.
</p>
</td></tr>
<tr><td><code id="action_renewal_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
<tr><td><code id="action_renewal_+3A_factor_f">factor_f</code>, <code id="action_renewal_+3A_mean_f">mean_f</code>, <code id="action_renewal_+3A_stddev_f">stddev_f</code>, <code id="action_renewal_+3A_alpha_f">alpha_f</code>, <code id="action_renewal_+3A_beta_f">beta_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> substituted into normalparam calcuations, see below.
</p>
</td></tr>
<tr><td><code id="action_renewal_+3A_cv_f">cv_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> substituted into normalcv calcuations, basically <code>stddev_f = mean_f * cv_f</code>, see below.
</p>
</td></tr>
<tr><td><code id="action_renewal_+3A_age_offset">age_offset</code></td>
<td>

<p>Replace <code>age</code> with <code>age - age_offset</code> in <var>mean_f</var>. Used to simulate initialconditions at time &quot;-1&quot;.
</p>
</td></tr>
<tr><td><code id="action_renewal_+3A_run_age">run_age</code></td>
<td>
<p>Age to run renewals for, used as <code>age == (run_age)</code> into default <var>run_f</var></p>
</td></tr>
<tr><td><code id="action_renewal_+3A_run_projection">run_projection</code></td>
<td>
<p>Boolean. Run renewal in projection years? If false adds <code>!cur_year_projection</code> into default <var>run_f</var></p>
</td></tr>
<tr><td><code id="action_renewal_+3A_run_step">run_step</code></td>
<td>
<p>Which step to perform renewal in, or <code>NULL</code> for continuous renewal. Adds <code>cur_step == (run_step)</code> into default <var>run_f</var></p>
</td></tr>
<tr><td><code id="action_renewal_+3A_run_f">run_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> specifying a condition for running this action,
For initialconditions defaults to first timestep.
For renewal, the default is a combination of <var>run_age</var>, <var>run_step</var> &amp; <var>run_projection</var>.
</p>
</td></tr>
<tr><td><code id="action_renewal_+3A_linf">Linf</code>, <code id="action_renewal_+3A_k">K</code>, <code id="action_renewal_+3A_t0">t0</code>, <code id="action_renewal_+3A_recl">recl</code></td>
<td>
<p><a href="stats.html#topic+formula">formula</a> substituted into vonb calcuations, see below.</p>
</td></tr>
<tr><td><code id="action_renewal_+3A_recage">recage</code></td>
<td>
<p><a href="stats.html#topic+formula">formula</a> substituted into initial abundance and vonb calcuations, see below.</p>
</td></tr>
<tr><td><code id="action_renewal_+3A_proportion_f">proportion_f</code>, <code id="action_renewal_+3A_scalar">scalar</code>, <code id="action_renewal_+3A_init">init</code>, <code id="action_renewal_+3A_m">M</code>, <code id="action_renewal_+3A_init_f">init_F</code></td>
<td>
<p><a href="stats.html#topic+formula">formula</a> substituted into initial abundance calcuations, see below.</p>
</td></tr>
<tr><td><code id="action_renewal_+3A_by_stock">by_stock</code>, <code id="action_renewal_+3A_wgt_by_stock">wgt_by_stock</code>, <code id="action_renewal_+3A_by_stock_f">by_stock_f</code>, <code id="action_renewal_+3A_by_age">by_age</code></td>
<td>
<p>Controls how parameters are grouped, see <code><a href="#topic+g3_parameterized">g3_parameterized</a></code></p>
</td></tr>
</table>


<h3>Details</h3>

<p>A model can have any number of <code>g3a_renewal_*</code> actions, so long as the
calling arguments are different. For instance, <code>run_f = ~age == 5</code> and
<code>run_f = ~age == 7</code>.
</p>
<p>The <code>g3a_renewal_*</code> actions will define the following stock instance variables for <var>stock</var>:
</p>

<dl>
<dt><var>stock__renewalnum</var></dt><dd><p>Extra individuals added to the stock</p>
</dd>
<dt><var>stock__renewalwgt</var></dt><dd><p>Mean weight of added individuals</p>
</dd>
</dl>



<h3>Value</h3>



<h4>g3a_renewal_vonb_recl</h4>

<p>A <a href="stats.html#topic+formula">formula</a> object representing
</p>
<p style="text-align: center;"><code class="reqn"> L_{\infty} * {1 - e^{-1 * \kappa * (a - (a_{0} + \frac{\log(1 - L_{0}/L_{\infty})}{\kappa}  ))}} </code>
</p>


<dl>
<dt><code class="reqn">L_{0}</code></dt><dd><p>Substituted for <var>recl</var></p>
</dd>
<dt><code class="reqn">L_{\infty}</code></dt><dd><p>Substituted for <var>Linf</var></p>
</dd>
<dt><code class="reqn">\kappa</code></dt><dd><p>Substituted for <var>K</var></p>
</dd>
<dt><code class="reqn">a_{0}</code></dt><dd><p>Substituted for <var>recage</var></p>
</dd>
</dl>

<p><strong>NB:</strong> <code><a href="#topic+g3a_initialconditions_normalparam">g3a_initialconditions_normalparam</a></code> will replace <code class="reqn">a</code> with <code class="reqn">a - \Delta{t}</code>, see <var>age_offset</var>
</p>



<h4>g3a_renewal_vonb_t0</h4>

<p>A <a href="stats.html#topic+formula">formula</a> object representing
</p>
<p style="text-align: center;"><code class="reqn"> L_{\infty} * (1 - e^{-1 * \kappa * (a - t_{0}) }) </code>
</p>


<dl>
<dt><code class="reqn">L_{\infty}</code></dt><dd><p>Substituted for <var>Linf</var></p>
</dd>
<dt><code class="reqn">\kappa</code></dt><dd><p>Substituted for <var>K</var></p>
</dd>
<dt><code class="reqn">t_{0}</code></dt><dd><p>Substituted for <var>t0</var></p>
</dd>
</dl>

<p><strong>NB:</strong> <code><a href="#topic+g3a_initialconditions_normalparam">g3a_initialconditions_normalparam</a></code> will replace <code class="reqn">a</code> with <code class="reqn">a - \Delta{t}</code>, see <var>age_offset</var>
</p>



<h4>g3a_renewal_vonb</h4>

<p>An alias for <code>g3a_renewal_vonb_recl</code>()</p>



<h4>g3a_renewal_initabund</h4>

<p>A <a href="stats.html#topic+formula">formula</a> object representing
</p>
<p style="text-align: center;"><code class="reqn"> scalar * init * e^{-1 * (M + F_{0}) * (a - a_{0}) } * proportion </code>
</p>


<dl>
<dt>scalar</dt><dd><p>Substituted for <var>scalar</var></p>
</dd>
<dt>init</dt><dd><p>Substituted for <var>init</var></p>
</dd>
<dt><code class="reqn">M</code></dt><dd><p>Substituted for <var>M</var></p>
</dd>
<dt><code class="reqn">F_{0}</code></dt><dd><p>Substituted for <var>init_F</var></p>
</dd>
<dt><code class="reqn">a_{0}</code></dt><dd><p>Substituted for <var>recage</var></p>
</dd>
<dt>proportion</dt><dd><p>Substituted for <var>proportion</var></p>
</dd>
</dl>




<h4>g3a_initialconditions / g3a_renewal</h4>

<p>An action (i.e. list of formula objects) that will, for the given <var>stock</var>, iterate over each
area/age/etc. combination, and generate a lengthgroup vector of new individuals and weights using
<var>num_f</var> and <var>wgt_f</var>.
</p>
<p>renewal will add fish to the existing collection, whereas initialconditions will assume the stock is currently empty.
</p>



<h4>g3a_initialconditions_normalparam / g3a_renewal_normalparam</h4>

<p>As <a href="#topic+g3a_initialconditions">g3a_initialconditions</a> / <a href="#topic+g3a_renewal">g3a_renewal</a>, but the following formulae are used to calculate num/wgt:
</p>
<p style="text-align: center;"><code class="reqn">n = e^{-(\frac{L - \mu}{\sigma})^2 / 2}</code>
</p>

<p style="text-align: center;"><code class="reqn">N = F 10000 \frac{n}{\sum n}</code>
</p>

<p style="text-align: center;"><code class="reqn">W = \alpha L^{\beta}</code>
</p>


<dl>
<dt><code class="reqn">L</code></dt><dd><p>Midlength of length groups for current area/age/...</p>
</dd>
<dt><code class="reqn">F</code></dt><dd><p>Substituted for <var>factor_f</var></p>
</dd>
<dt><code class="reqn">\mu</code></dt><dd><p>Substituted for <var>mean_f</var></p>
</dd>
<dt><code class="reqn">\sigma</code></dt><dd><p>Substituted for <var>stddev_f</var></p>
</dd>
<dt><code class="reqn">\alpha</code></dt><dd><p>Substituted for <var>alpha_f</var></p>
</dd>
<dt><code class="reqn">\beta</code></dt><dd><p>Substituted for <var>beta_f</var></p>
</dd>
</dl>




<h4>g3a_initialconditions_normalcv / g3a_renewal_normalcv</h4>

<p>As <a href="#topic+g3a_initialconditions">g3a_initialconditions</a> / <a href="#topic+g3a_renewal">g3a_renewal</a>, but the following formulae are used to calculate num/wgt:
</p>
<p style="text-align: center;"><code class="reqn">n = e^{-(\frac{L - \mu}{\mu * {CV}})^2 / 2}</code>
</p>

<p style="text-align: center;"><code class="reqn">N = F 10000 \frac{n}{\sum n}</code>
</p>

<p style="text-align: center;"><code class="reqn">W = \alpha L^{\beta}</code>
</p>


<dl>
<dt><code class="reqn">L</code></dt><dd><p>Midlength of length groups for current area/age/...</p>
</dd>
<dt><code class="reqn">F</code></dt><dd><p>Substituted for <var>factor_f</var></p>
</dd>
<dt><code class="reqn">\mu</code></dt><dd><p>Substituted for <var>mean_f</var></p>
</dd>
<dt><code class="reqn">CV</code></dt><dd><p>Substituted for <var>cv_f</var></p>
</dd>
<dt><code class="reqn">\alpha</code></dt><dd><p>Substituted for <var>alpha_f</var></p>
</dd>
<dt><code class="reqn">\beta</code></dt><dd><p>Substituted for <var>beta_f</var></p>
</dd>
</dl>




<h3>See Also</h3>

<p><a href="https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stockinitial">https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stockinitial</a>,
<a href="https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stockrenew">https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stockrenew</a>,
<code><a href="#topic+g3_stock">g3_stock</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
ling_imm &lt;- g3_stock('ling_imm', seq(20, 156, 4)) %&gt;% g3s_age(3, 10)

initialconditions_action &lt;- g3a_initialconditions_normalparam(
    ling_imm,
    by_age = TRUE)  # per-age init.sd parameters
renewal_action &lt;- g3a_renewal_normalparam(
    ling_imm,
    run_step = 2)  # Renewal happens in spring

# To get a single ling_imm.lencv parameter instead of init.sd
initialconditions_action &lt;- g3a_initialconditions_normalcv(
    ling_imm)
renewal_action &lt;- g3a_renewal_normalcv(
    ling_imm,
    run_step = 2)  # Renewal happens in spring

## Plots
par(mar = c(4,2,2,1), cex.main = 1)
curve(g3_eval(g3a_renewal_vonb_t0(Linf = 20, K = 0.8, t0 = 0), age = x),
    0, 10, col = 2, xlab = "age", main = "g3a_renewal_vonb_t0(Linf = 20, K = 0.8..1.4, t0 = 0)")
curve(g3_eval(g3a_renewal_vonb_t0(Linf = 20, K = 1.0, t0 = 0), age = x),
    0, 10, col = 1, add = TRUE)
curve(g3_eval(g3a_renewal_vonb_t0(Linf = 20, K = 1.2, t0 = 0), age = x),
    0, 10, col = 3, add = TRUE)
curve(g3_eval(g3a_renewal_vonb_t0(Linf = 20, K = 1.4, t0 = 0), age = x),
    0, 10, col = 4, add = TRUE)

</code></pre>

<hr>
<h2 id='action_report'>Gadget3 report actions</h2><span id='topic+g3a_report_stock'></span><span id='topic+g3a_report_history'></span><span id='topic+g3a_report_detail'></span>

<h3>Description</h3>

<p>Add report to a g3 model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3a_report_stock(report_stock, input_stock, report_f,
    include_adreport = FALSE,
    run_f = TRUE,
    run_at = g3_action_order$report)

g3a_report_history(
        actions,
        var_re = "__num$|__wgt$",
        out_prefix = "hist_",
        run_f = TRUE,
        run_at = g3_action_order$report)

g3a_report_detail(actions,
    run_f = quote( g3_param('report_detail', optimise = FALSE, value = 1L) == 1 ),
    abundance_run_at = g3_action_order$report_early,
    run_at = g3_action_order$report)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="action_report_+3A_report_stock">report_stock</code></td>
<td>

<p>The <code><a href="#topic+g3_stock">g3_stock</a></code> to aggregate into
</p>
</td></tr>
<tr><td><code id="action_report_+3A_input_stock">input_stock</code></td>
<td>

<p>The <code><a href="#topic+g3_stock">g3_stock</a></code> that will be aggregated
</p>
</td></tr>
<tr><td><code id="action_report_+3A_report_f">report_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> specifying what to collect, for instance <code>g3_formula( stock_ss(input_stock__num) )</code> or <code>g3_formula( stock_ss(input_stock__wgt) )</code>.
</p>
</td></tr>
<tr><td><code id="action_report_+3A_actions">actions</code></td>
<td>

<p>List of actions that model will consist of.
</p>
</td></tr>
<tr><td><code id="action_report_+3A_var_re">var_re</code></td>
<td>

<p>Regular expression specifying variables to log history for.
</p>
</td></tr>
<tr><td><code id="action_report_+3A_out_prefix">out_prefix</code></td>
<td>

<p>Prefix to add to history report output, e.g. <code>hist_ling_imm__num</code>.
</p>
</td></tr>
<tr><td><code id="action_report_+3A_include_adreport">include_adreport</code></td>
<td>

<p>Should the aggregated value get ADREPORT'ed?
</p>
</td></tr>
<tr><td><code id="action_report_+3A_abundance_run_at">abundance_run_at</code></td>
<td>

<p>Integer order that abundance will be collected within the model. Note that by default it's collected at the start, not the end
</p>
</td></tr>
<tr><td><code id="action_report_+3A_run_f">run_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> specifying a condition for running this action, default always runs.
</p>
</td></tr>
<tr><td><code id="action_report_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The actions will define the following variables in your model:
</p>

<dl>
<dt><var>report_stock</var>__<var>instance_name</var></dt><dd>
<p>Results of collating <var>input_stock</var>__<var>instance_name</var>, where
<var>instance_name</var> is defined by the first instance variable in <var>report_f</var>.
For example, if <var>report_f</var> is <code>~input_stock__num</code>, then we will report <code>report_stock__num</code>.
</p>
</dd>
</dl>

<p>A model can have any number of <code>g3a_report_*</code> actions, so long as the
calling arguments are different. For instance, <code>run_f = ~age == 5</code> and
<code>run_f = ~age == 7</code>.
</p>


<h3>Value</h3>



<h4>g3a_report_stock</h4>

<p>An action (i.e. list of formula objects) that will...</p>

<ol>
<li><p>Iterate over <var>input_stock</var>, collecting data into <var>report_stock</var>
</p>
</li>
<li><p>Add the contents of <var>report_stock</var>__<var>instance_name</var> to the model report
</p>
</li></ol>



<h4>g3a_report_history</h4>

<p>An action (i.e. list of formula objects) that will store the current state of each variable found matching <var>var_re</var>.
</p>



<h4>g3a_report_detailed</h4>

<p>Uses <a href="#topic+g3a_report_history">g3a_report_history</a> to generate detailed reports suitable for use in <code>g3_fit</code>.
</p>



<h3>See Also</h3>

<p><code><a href="#topic+g3_stock">g3_stock</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
ling_imm &lt;- g3_stock('ling_imm', seq(20, 156, 4)) %&gt;% g3s_age(3, 10)

# Report that aggregates ages together
agg_report &lt;- g3_stock('agg_report', c(1)) %&gt;%
    g3s_agegroup(list(young = 1:3, old = 4:5)) %&gt;%
    g3s_time(year = 2000:2002)
# Generate dissaggregated report by cloning the source stock, adding time
raw_report &lt;- g3s_clone(ling_imm, 'raw_report') %&gt;%
    g3s_time(year = 2000:2002)

actions &lt;- list(
    g3a_age(ling_imm),
    g3a_report_stock(agg_report, ling_imm, g3_formula( stock_ss(ling_imm__num) ),
        include_adreport = TRUE),
    g3a_report_stock(raw_report, ling_imm, g3_formula( stock_ss(ling_imm__num) )))
# "raw_report__num" and "agg_report__num" will be available in the model report
# In addition, agg_report__num will be included in TMB::sdreport() output

# Report history of all "__num" and "__wgt" variables
actions &lt;- c(actions, list(g3a_report_history(actions)))

# Report history of just "ling_imm__num"
actions &lt;- c(actions, list(g3a_report_history(actions, "^ling_imm__num$")))

# Add a detail report suitable for g3_fit
actions &lt;- c(actions, list(g3a_report_detail(actions)))
</code></pre>

<hr>
<h2 id='action_spawn'>Gadget3 spawning action</h2><span id='topic+g3a_spawn_recruitment_fecundity'></span><span id='topic+g3a_spawn_recruitment_simplessb'></span><span id='topic+g3a_spawn_recruitment_ricker'></span><span id='topic+g3a_spawn_recruitment_bevertonholt'></span><span id='topic+g3a_spawn_recruitment_hockeystick'></span><span id='topic+g3a_spawn'></span>

<h3>Description</h3>

<p>Add spawning to a g3 model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3a_spawn_recruitment_fecundity(p0, p1, p2, p3, p4)

g3a_spawn_recruitment_simplessb(mu)

g3a_spawn_recruitment_ricker(mu, lambda)

g3a_spawn_recruitment_bevertonholt(mu, lambda)

g3a_spawn_recruitment_hockeystick(r0, blim)

g3a_spawn(
        stock,
        recruitment_f,
        proportion_f = 1,
        mortality_f = 0,
        weightloss_f = 0,
        output_stocks = list(),
        output_ratios = rep(1 / length(output_stocks), times = length(output_stocks)),
        mean_f = g3a_renewal_vonb_t0(by_stock = by_stock),
        stddev_f = g3_parameterized('rec.sd', value = 10, by_stock = by_stock),
        alpha_f = g3_parameterized('walpha', by_stock = wgt_by_stock),
        beta_f = g3_parameterized('wbeta', by_stock = wgt_by_stock),
        by_stock = TRUE,
        wgt_by_stock = TRUE,
        run_f = ~TRUE,
        run_at = g3_action_order$spawn,
        recruit_at = g3_action_order$renewal)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="action_spawn_+3A_p0">p0</code>, <code id="action_spawn_+3A_p1">p1</code>, <code id="action_spawn_+3A_p2">p2</code>, <code id="action_spawn_+3A_p3">p3</code>, <code id="action_spawn_+3A_p4">p4</code></td>
<td>
<p>Substituted into <code>g3a_spawn_recruitment_fecundity</code> formula, see below.</p>
</td></tr>
<tr><td><code id="action_spawn_+3A_mu">mu</code>, <code id="action_spawn_+3A_lambda">lambda</code>, <code id="action_spawn_+3A_r0">r0</code>, <code id="action_spawn_+3A_blim">blim</code></td>
<td>
<p>Substituted into <code>g3a_spawn_recruitment_*</code> formula, see below.</p>
</td></tr>
<tr><td><code id="action_spawn_+3A_stock">stock</code></td>
<td>

<p>The mature <code><a href="#topic+g3_stock">g3_stock</a></code> that will spawn in this action.
</p>
</td></tr>
<tr><td><code id="action_spawn_+3A_recruitment_f">recruitment_f</code></td>
<td>

<p>A list of <a href="stats.html#topic+formula">formula</a> generated by one of the <code>g3a_spawn_recruitment_*</code> functions, containing
</p>

<dl>
<dt>s</dt><dd><p>Formula run for each subset of stock</p>
</dd>
<dt>r</dt><dd><p>Final formula for calculating number of recruits for spawning action</p>
</dd>
</dl>

</td></tr>
<tr><td><code id="action_spawn_+3A_proportion_f">proportion_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> generated by one of the <a href="#topic+g3_suitability_+2A">g3_suitability_*</a> functions, describing
the proportion of stock that will spawn at this timestep.
</p>
</td></tr>
<tr><td><code id="action_spawn_+3A_mortality_f">mortality_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> generated by one of the <a href="#topic+g3_suitability_+2A">g3_suitability_*</a> functions, describing
the proportion of spawning stock that will die during spawning.
</p>
</td></tr>
<tr><td><code id="action_spawn_+3A_weightloss_f">weightloss_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> generated by one of the <a href="#topic+g3_suitability_+2A">g3_suitability_*</a> functions, describing
the overall weight loss during spawning.
</p>
</td></tr>
<tr><td><code id="action_spawn_+3A_output_stocks">output_stocks</code></td>
<td>

<p>List of <code><a href="#topic+g3_stock">g3_stock</a></code>s that will be spawned into.
</p>
</td></tr>
<tr><td><code id="action_spawn_+3A_output_ratios">output_ratios</code></td>
<td>

<p>Vector of proportions for how to distribute into <var>output_stocks</var>, summing to 1, default evenly spread.
</p>
</td></tr>
<tr><td><code id="action_spawn_+3A_mean_f">mean_f</code>, <code id="action_spawn_+3A_stddev_f">stddev_f</code>, <code id="action_spawn_+3A_alpha_f">alpha_f</code>, <code id="action_spawn_+3A_beta_f">beta_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> substituted into stock structure calculations, see <a href="#topic+g3a_renewal_normalparam">g3a_renewal_normalparam</a> for details.
</p>
</td></tr>
<tr><td><code id="action_spawn_+3A_run_f">run_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> specifying a condition for running this action, default always runs.
</p>
</td></tr>
<tr><td><code id="action_spawn_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that spawning actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
<tr><td><code id="action_spawn_+3A_recruit_at">recruit_at</code></td>
<td>

<p>Integer order that recruitment from spawning will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
<tr><td><code id="action_spawn_+3A_by_stock">by_stock</code>, <code id="action_spawn_+3A_wgt_by_stock">wgt_by_stock</code></td>
<td>
<p>Controls how parameters are grouped, see <code><a href="#topic+g3_parameterized">g3_parameterized</a></code></p>
</td></tr>
</table>


<h3>Details</h3>

<p>To restrict spawning to a particular step in a year, or a particular area, use <var>run_f</var>.
For example:
</p>

<dl>
<dt><code>cur_step == 1</code></dt><dd><p>Spawning will happen on first step of every year</p>
</dd>
<dt><code>cur_step == 1 &amp;&amp; cur_year &gt;= 1990</code></dt><dd><p>Spawning will happen on first step of every year after 1990</p>
</dd>
<dt><code>cur_step == 2 &amp;&amp; area = 1</code></dt><dd><p>Spawning will happen on second step of every year, in the first area</p>
</dd>
</dl>

<p>The action will define the following stock instance variables for each given <var>stock</var> and <var>output_stock</var>:
</p>

<dl>
<dt><var>stock__spawnprop</var></dt><dd><p>Proportion of (stock) that are spawning in this spawning event</p>
</dd>
<dt><var>stock__spawningnum</var></dt><dd><p>Numbers of (stock) that are spawning in this spawning event</p>
</dd>
<dt><var>output_stock__spawnednum</var></dt><dd><p>Numbers of (output_stock) that will be produced in this spawning event</p>
</dd>
</dl>



<h3>Value</h3>



<h4>g3a_spawn_recruitment_fecundity</h4>

<p>A pair of <a href="stats.html#topic+formula">formula</a> objects:
</p>
<p style="text-align: center;"><code class="reqn"> S = l ^{p_{1}} a^{p_{2}} (p N_{al})^{p_{3}} W_{al}^{p_{4}} </code>
</p>

<p style="text-align: center;"><code class="reqn"> R = p_{0} S </code>
</p>


<dl>
<dt><code class="reqn">N_{al}</code></dt><dd><p>Number of parent stock</p>
</dd>
<dt><code class="reqn">W_{al}</code></dt><dd><p>Weight of parent stock</p>
</dd>
<dt><code class="reqn">p</code></dt><dd><p>Proportion of parent stock spawning, from <var>proportion_f</var></p>
</dd>
<dt><code class="reqn">p_{0..4}</code></dt><dd><p>Arguments provided to function</p>
</dd>
</dl>




<h4>g3a_spawn_recruitment_simplessb</h4>

<p>A pair of <a href="stats.html#topic+formula">formula</a> objects:
</p>
<p style="text-align: center;"><code class="reqn"> S = N_{al} p  W_{al} </code>
</p>

<p style="text-align: center;"><code class="reqn"> R = \mu S </code>
</p>


<dl>
<dt><code class="reqn">N_{al}</code></dt><dd><p>Number of parent stock</p>
</dd>
<dt><code class="reqn">W_{al}</code></dt><dd><p>Weight of parent stock</p>
</dd>
<dt><code class="reqn">p</code></dt><dd><p>Proportion of parent stock spawning, from <var>proportion_f</var></p>
</dd>
<dt>μ</dt><dd><p>Argument provided to function</p>
</dd>
</dl>




<h4>g3a_spawn_recruitment_ricker</h4>

<p>A pair of <a href="stats.html#topic+formula">formula</a> objects:
</p>
<p style="text-align: center;"><code class="reqn"> S = N_{al} p  W_{al} </code>
</p>

<p style="text-align: center;"><code class="reqn"> R = \mu S e^{-\lambda S} </code>
</p>


<dl>
<dt><code class="reqn">N_{al}</code></dt><dd><p>Number of parent stock</p>
</dd>
<dt><code class="reqn">W_{al}</code></dt><dd><p>Weight of parent stock</p>
</dd>
<dt><code class="reqn">p</code></dt><dd><p>Proportion of parent stock spawning, from <var>proportion_f</var></p>
</dd>
<dt>μ</dt><dd><p>Argument provided to function</p>
</dd>
<dt>λ</dt><dd><p>Argument provided to function</p>
</dd>
</dl>




<h4>g3a_spawn_recruitment_bevertonholt</h4>

<p>A pair of <a href="stats.html#topic+formula">formula</a> objects:
</p>
<p style="text-align: center;"><code class="reqn"> S = N_{al} p  W_{al} </code>
</p>

<p style="text-align: center;"><code class="reqn"> R = \frac{\mu S}{\lambda + S} </code>
</p>


<dl>
<dt><code class="reqn">N_{al}</code></dt><dd><p>Number of parent stock</p>
</dd>
<dt><code class="reqn">W_{al}</code></dt><dd><p>Weight of parent stock</p>
</dd>
<dt><code class="reqn">p</code></dt><dd><p>Proportion of parent stock spawning, from <var>proportion_f</var></p>
</dd>
<dt>μ</dt><dd><p>Argument provided to function</p>
</dd>
<dt>λ</dt><dd><p>Argument provided to function</p>
</dd>
</dl>




<h4>g3a_spawn_recruitment_hockeystick</h4>

<p>A pair of <a href="stats.html#topic+formula">formula</a> objects:
</p>
<p style="text-align: center;"><code class="reqn"> S = N_{al} p  W_{al} </code>
</p>

<p style="text-align: center;"><code class="reqn"> R = R_0 \min{( S / B_{lim}, 1)} </code>
</p>


<dl>
<dt><code class="reqn">N_{al}</code></dt><dd><p>Number of parent stock</p>
</dd>
<dt><code class="reqn">W_{al}</code></dt><dd><p>Weight of parent stock</p>
</dd>
<dt><code class="reqn">p</code></dt><dd><p>Proportion of parent stock spawning, from <var>proportion_f</var></p>
</dd>
<dt><code class="reqn">R_0</code></dt><dd><p>Argument <code>r0</code> provided to function</p>
</dd>
<dt><code class="reqn">B_{lim}</code></dt><dd><p>Argument <code>blim</code> provided to function</p>
</dd>
</dl>

<p><strong>NB:</strong> This formula is differentiable, despite using <code>min()</code> in the
definition above.
</p>



<h4>g3a_spawn</h4>

<p>An action (i.e. list of formula objects) that will, for the given <var>stock</var>...</p>

<ol>
<li><p>Use <var>proportion_f</var> to calculate the total parent <var>stock</var> that will spawn
</p>
</li>
<li><p>Use <var>recruitment_f</var> to derive the total newly spawned stock
</p>
</li>
<li><p>Apply <var>weightloss_f</var> and <var>mortality_f</var> to the parent <var>stock</var>
</p>
</li></ol>
<p> ... then, at recruitment stage ... </p>

<ol>
<li><p>Recruit evenly into <var>output_stocks</var>, using <var>mean_f</var>, <var>stddev_f</var>, <var>alpha_f</var>, <var>beta_f</var>
as-per <a href="#topic+g3a_renewal_normalparam">g3a_renewal_normalparam</a>
</p>
</li></ol>



<h3>See Also</h3>

<p><a href="https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stocknatmort">https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec:stocknatmort</a>,
<code><a href="#topic+g3a_naturalmortality">g3a_naturalmortality</a></code>,
<code><a href="#topic+g3_stock">g3_stock</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
ling_imm &lt;- g3_stock('ling_imm', seq(20, 156, 4)) %&gt;% g3s_age(3, 10)
ling_mat &lt;- g3_stock('ling_mat', seq(20, 156, 4)) %&gt;% g3s_age(3, 10)

spawn_action &lt;- g3a_spawn(
    # Spawn from ling_mat
    ling_mat,
    # Use Ricker Recruitment Function to calculate # of recruits from total biomass
    recruitment_f = g3a_spawn_recruitment_ricker(
        g3_parameterized("ricker.mu"),
        g3_parameterized("ricker.lambda")),
    # Proportion of ling_mat spawning exponential relationship based on length
    proportion_f = g3_suitability_exponentiall50(
        alpha = g3_parameterized("spawn.prop.alpha", scale = -1),
        l50 = g3_parameterized("spawn.prop.l50")),
    # Proportion of ling_mat dying during spawning linear relationship to length
    mortality_f = g3_suitability_straightline(
        alpha = g3_parameterized("spawn.mort.alpha"),
        beta = g3_parameterized("spawn.mort.beta")),
    # Weightloss of ling_mat during spawning a constant
    weightloss_f = g3_parameterized("spawn.weightloss"),
    # Spawn into ling_imm
    output_stocks = list(ling_imm),
    # Spawned stock structure, as-per g3a_renewal_normalparam()
    mean_f = 50,
    stddev_f = 0.9,
    alpha_f = 1,
    beta_f = 1,
    # Spawning should happen on the first step of every year
    run_f = ~cur_step==1)
</code></pre>

<hr>
<h2 id='action_tagging'>Gadget3 tag-release action</h2><span id='topic+g3a_predate_tagrelease'></span><span id='topic+g3a_tag_shedding'></span>

<h3>Description</h3>

<p>Add tag-release to a g3 model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3a_predate_tagrelease(
       fleet_stock, prey_stocks, suitabilities, catchability_f,
       output_tag_f, mortality_f = 0, run_f = ~TRUE,
       run_at = g3_action_order$predate, ...)

g3a_tag_shedding(stocks, tagshed_f, run_f = ~TRUE,
       run_at = g3_action_order$straying)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="action_tagging_+3A_fleet_stock">fleet_stock</code></td>
<td>
<p>Tagging fleet, see <a href="#topic+g3a_predate_fleet">g3a_predate_fleet</a></p>
</td></tr>
<tr><td><code id="action_tagging_+3A_prey_stocks">prey_stocks</code></td>
<td>
<p>Stocks fleet harvests, see <a href="#topic+g3a_predate_fleet">g3a_predate_fleet</a></p>
</td></tr>
<tr><td><code id="action_tagging_+3A_suitabilities">suitabilities</code></td>
<td>
<p>See <a href="#topic+g3a_predate_fleet">g3a_predate_fleet</a></p>
</td></tr>
<tr><td><code id="action_tagging_+3A_catchability_f">catchability_f</code></td>
<td>
<p>See <a href="#topic+g3a_predate_fleet">g3a_predate_fleet</a></p>
</td></tr>
<tr><td><code id="action_tagging_+3A_output_tag_f">output_tag_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> specifying which numeric tag (see <a href="#topic+g3s_tag">g3s_tag</a>) stock will be released into.
Implemented with a <a href="#topic+g3_timeareadata">g3_timeareadata</a> table, e.g.
</p>
</td></tr>
<tr><td><code id="action_tagging_+3A_mortality_f">mortality_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> generated by one of the <a href="#topic+g3_suitability_+2A">g3_suitability_*</a> functions, describing
the proportion of tagged stock that will die during tagging.
</p>
</td></tr>
<tr><td><code id="action_tagging_+3A_stocks">stocks</code></td>
<td>
<p>Stocks that will shed tags</p>
</td></tr>
<tr><td><code id="action_tagging_+3A_tagshed_f">tagshed_f</code></td>
<td>
<p><a href="stats.html#topic+formula">formula</a> for proportion that will shed tags at this point</p>
</td></tr>
<tr><td><code id="action_tagging_+3A_run_f">run_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> specifying a condition for running this action, default always runs.
</p>
</td></tr>
<tr><td><code id="action_tagging_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that spawning actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
<tr><td><code id="action_tagging_+3A_...">...</code></td>
<td>
<p>Any further options for <a href="#topic+g3a_predate_fleet">g3a_predate_fleet</a></p>
</td></tr>
</table>


<h3>Value</h3>



<h4>g3a_predate_tagrelease</h4>

<p>An action (i.e. list of formula objects) that will...</p>

<ol>
<li><p>Harvest as-per <a href="#topic+g3a_predate_fleet">g3a_predate_fleet</a>
</p>
</li>
<li><p>Use <var>mortality_f</var> to apply tagging mortality to harvested stock
</p>
</li>
<li><p>Use <var>output_tag_f</var> to decide what tag should be applied to harvested stock
</p>
</li>
<li><p>Put harvested stock back into general circulation
</p>
</li></ol>



<h4>g3a_tag_shedding</h4>

<p>An action (i.e. list of formula objects) that will...</p>

<ol>
<li><p>For each <var>stock</var>, move the proportion <var>tagshed_f</var> back to the &quot;untagged&quot; tag
</p>
</li></ol>



<h3>See Also</h3>

<p><code><a href="#topic+g3a_predate_fleet">g3a_predate_fleet</a></code>,
<code><a href="#topic+g3s_tag">g3s_tag</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

tags &lt;- c('H1-00', 'H1-01')
tags &lt;- structure(seq_along(tags), names = tags)

prey_a &lt;- g3_stock('prey_a', seq(1, 10)) %&gt;% g3s_tag(tags)
fleet_a &lt;- g3_fleet('fleet_a')

actions &lt;- list(
    # NB: If g3_tag() is used in the stock, initialconditions/renewal
    # will only renew into tag == 0 (i.e. untagged)
    g3a_predate_tagrelease(
        # Setup as-per g3a_predate_fleet
        fleet_a,
        list(prey_a),
        suitabilities = list(prey_a = 1),
        catchability_f = g3a_predate_catchability_numberfleet(~100),
        
        # Optional tag mortality suitability
        mortality_f = g3_suitability_straightline(
            g3_parameterized('mort_alpha'),
            g3_parameterized('mort_beta')),

        # Formula to decide which tag to output into, generate table
        # with one tag per year
        output_tag_f = g3_timeareadata('fleet_a_tags', data.frame(
            year = 2000:2001,
            tag = tags[c('H1-00', 'H1-01')],
            stringsAsFactors = FALSE), value_field = "tag"),

        # Experiment only happens in spring
        run_f = ~cur_step == 2),

    g3a_tag_shedding(
        list(prey_a),
        # i.e. 0.125 will loose their tag each step
        tagshed_f = log(8)))
</code></pre>

<hr>
<h2 id='action_time'>Gadget3 timekeeping actions</h2><span id='topic+g3a_time'></span>

<h3>Description</h3>

<p>Add timekeeping to a g3 model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3a_time(
        start_year,
        end_year,
        step_lengths = c(12),
        final_year_steps = quote( length(step_lengths) ),
        project_years = g3_parameterized("project_years", value = 0, optimise = FALSE),
        retro_years = g3_parameterized("retro_years", value = 0, optimise = FALSE),
        run_at = g3_action_order$time)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="action_time_+3A_start_year">start_year</code></td>
<td>

<p>Year model run will start.
</p>
</td></tr>
<tr><td><code id="action_time_+3A_end_year">end_year</code></td>
<td>

<p>After this year, model run will stop.
</p>
</td></tr>
<tr><td><code id="action_time_+3A_step_lengths">step_lengths</code></td>
<td>

<p>Either an MFDB time grouping, e.g. <code>mfdb::mfdb_timestep_quarterly</code>, or a
vector of step lengths which should should sum to 12,
for example, <code>c(3,3,3,3)</code> for quarterly steps within a year.
</p>
</td></tr>
<tr><td><code id="action_time_+3A_final_year_steps">final_year_steps</code></td>
<td>

<p>Number of steps of final year to include. Either as an integer or quoted
code, in which case it will be calcuated when the model runs.
For example:
</p>

<dl>
<dt><code>0</code></dt><dd><p>Model stops before the start of <var>end_year</var> (it is exclusive)</p>
</dd>
<dt><code>length(step_lengths)</code></dt><dd><p>Model stops at the end of <var>end_year</var> (it is inclusive)</p>
</dd>
<dt><code>2</code></dt><dd><p>Model stops at the second step of <var>end_year</var>, mid-year if <var>step_lengths</var> is quarterly</p>
</dd>
</dl>

</td></tr>
<tr><td><code id="action_time_+3A_project_years">project_years</code></td>
<td>

<p>Number of years to continue running after the &quot;end&quot; of the model. Must be <code>&gt;= 0</code>
</p>
<p>Defaults to an unoptimized <code>project_years</code> parameter, set to 0 (i.e. no projection).
Generally, you would change this parameter in the parameter template, rather than changing here.
</p>
</td></tr>
<tr><td><code id="action_time_+3A_retro_years">retro_years</code></td>
<td>

<p>Adjust <var>end_year</var> to finish model early. Must be <code>&gt;= 0</code>
Can be used in conjunction with <var>project_years</var> to project instead.
</p>
<p>The true end year of the model will be <code>end_year - retro_years + project_years</code>.
</p>
<p>Defaults to an unoptimized <code>retro_years</code> parameter, set to 0.
Generally, you would change this parameter in the parameter template, rather than changing here.
</p>
</td></tr>
<tr><td><code id="action_time_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The actions will define the following variables in your model:
</p>

<dl>
<dt><var>cur_time</var></dt><dd><p>Current iteration of model, starts at 0 and increments until finished</p>
</dd>
<dt><var>cur_step</var></dt><dd><p>Current step within individual year</p>
</dd>
<dt><var>cur_step_size</var></dt><dd><p>Proportion of year this step contains, e.g. quarterly = 3/12</p>
</dd>
<dt><var>cur_year</var></dt><dd><p>Current year</p>
</dd>
<dt><var>cur_step_final</var></dt><dd><p>TRUE iff this is the final step of the year</p>
</dd>
<dt><var>cur_year_projection</var></dt><dd><p>TRUE iff we are currently projecting past <var>end_year</var></p>
</dd>
<dt><var>total_steps</var></dt><dd><p>Total # of iterations (including projection) before model stops</p>
</dd>
<dt><var>total_years</var></dt><dd><p>Total # of years (including projection) before model stops</p>
</dd>
</dl>



<h3>Value</h3>



<h4>g3a_time</h4>

<p>An action (i.e. list of formula objects) that will...</p>

<ol>
<li><p>Define <var>cur_*</var> variables listed above
</p>
</li>
<li><p>If we've reached the end of the model, return <var>nll</var>
</p>
</li></ol>



<h3>Examples</h3>

<pre><code class='language-R'># Run model 2000..2004, in quarterly steps
time_action &lt;- g3a_time(
    start_year = 2000,
    end_year = 2004,
    c(3, 3, 3, 3))
</code></pre>

<hr>
<h2 id='eval'>Evaluate G3 forumulas</h2><span id='topic+g3_eval'></span>

<h3>Description</h3>

<p>Evaluate G3 formulas / code outside a model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_eval(f, ...)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="eval_+3A_f">f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> object or <a href="base.html#topic+quote">quote</a>d code to be evaluated
</p>
</td></tr>
<tr><td><code id="eval_+3A_...">...</code></td>
<td>

<p>Named items to add to the formula's environment,
or a single list / environment to use.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Allows snippets of gadget3 code to be run outside a model. This could
be done with regular <code><a href="base.html#topic+eval">eval</a></code>, however, <code>g3_eval</code> does a number of things first:
</p>

<ol>
<li><p> The global <code><a href="#topic+g3_env">g3_env</a></code> is in the environment, so functions such as <code><a href="#topic+avoid_zero">avoid_zero</a></code> can be used
</p>
</li>
<li><p> If substituting a <code><a href="#topic+g3_stock">g3_stock</a></code>, all definitions such as <code>stock__minlen</code> will also be substituted
</p>
</li>
<li> <p><code>g3_param('x')</code> will pull <code>param.x</code> from the environment
</p>
</li></ol>



<h3>Value</h3>

<p>Result of evaluating <var>f</var>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Evaluate suitiability function for given stocks
g3_eval(
    g3_suitability_andersen(0,1,2,3,4),
    predstock = g3_stock('pred', 11:20),
    stock = g3_stock('prey', 1:10))

# Parameters can be filled in with "param." items in environment
g3_eval(quote( g3_param('x') ), param.x = 88)
g3_eval(
    g3_parameterized('lln.alpha', by_stock = TRUE, value = 99),
    stock = g3_stock("fish", 1:10),
    param.fish.lln.alpha = 123)

# Graph gadget3's built-in logspace_add()
if (interactive()) {
  curve(g3_eval(quote( logspace_add(a, 10) ), a = x), 0, 50)
}

</code></pre>

<hr>
<h2 id='formula_utils'>Gadget3 formula helpers</h2><span id='topic+g3_formula'></span>

<h3>Description</h3>

<p>Tools to create R formulas
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_formula(code, ...)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="formula_utils_+3A_code">code</code></td>
<td>

<p>Unevaluated code to be turned into a formula
</p>
</td></tr>
<tr><td><code id="formula_utils_+3A_...">...</code></td>
<td>

<p>Named items to add to the formula's environment,
or a single list / environment to use.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>When using <code>~</code>, the local environment is attached to the code.
This can leak unwanted variables into a model. This allows you to avoid
the problem without resorting to <a href="base.html#topic+local">local</a>.
</p>


<h3>Value</h3>

<p>A <a href="stats.html#topic+formula">formula</a> object, with environment created from <var>...</var>.
Can then be used anywhere in gadget3 that accepts a <a href="stats.html#topic+formula">formula</a>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# g3_formula is identical to defining a formula within local():
stopifnot(all.equal(
    g3_formula(x + 1, z = 44),
    local({ z = 44; ~x + 1 })
    ))

# If the code is destined for CRAN, you need to quote() to avoid check errors:
stopifnot(all.equal(
    g3_formula(quote( x + 1 ), z = 44),
    local({ z = 44; ~x + 1 })
    ))
</code></pre>

<hr>
<h2 id='init_val'>Gadget3 parameter value setter</h2><span id='topic+g3_init_val'></span>

<h3>Description</h3>

<p>Helper for setting initial parameter value
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_init_val(
        param_template,
        name_spec,
        value = NULL,
        spread = NULL,
        lower = if (!is.null(spread)) value * (1 - spread),
        upper = if (!is.null(spread)) value * (1 + spread),
        optimise = !is.null(lower) &amp; !is.null(upper),
        parscale = if (is.null(lower) || is.null(upper)) NULL else 'auto',
        random = NULL,
        auto_exponentiate = TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="init_val_+3A_param_template">param_template</code></td>
<td>

<p>A parameter template generated by <code><a href="#topic+g3_to_r">g3_to_r</a></code> or <code><a href="#topic+g3_to_tmb">g3_to_tmb</a></code>
</p>
</td></tr>
<tr><td><code id="init_val_+3A_name_spec">name_spec</code></td>
<td>

<p>A glob-like string to match parameter names, see Details
</p>
</td></tr>
<tr><td><code id="init_val_+3A_value">value</code></td>
<td>

<p>Numeric value / vector of values to set for value / 'value' column in template.
Original value left if NULL
</p>
</td></tr>
<tr><td><code id="init_val_+3A_spread">spread</code></td>
<td>

<p>Shortcut for setting <var>lower</var> &amp; <var>upper</var>.
</p>
</td></tr>
<tr><td><code id="init_val_+3A_lower">lower</code></td>
<td>

<p>Numeric value / vector of values to set for 'lower' column in template.
Original value left if NULL
</p>
</td></tr>
<tr><td><code id="init_val_+3A_upper">upper</code></td>
<td>

<p>Numeric value / vector of values to set for 'upper' column in template.
Original value left if NULL
</p>
</td></tr>
<tr><td><code id="init_val_+3A_optimise">optimise</code></td>
<td>

<p>Boolean value to set for 'optimise' column in template.
Default is true iff both lower and upper are non-NULL.
Original value left if NULL
</p>
</td></tr>
<tr><td><code id="init_val_+3A_parscale">parscale</code></td>
<td>

<p>Numeric value / vector of values to set for 'parscale' column in template.
Default (<code>auto</code>) is difference between lower &amp; upper (or NULL if they're not set).
Original value left if NULL
</p>
</td></tr>
<tr><td><code id="init_val_+3A_random">random</code></td>
<td>

<p>Boolean value to set for 'random' column in template.
Original value left if NULL
</p>
</td></tr>
<tr><td><code id="init_val_+3A_auto_exponentiate">auto_exponentiate</code></td>
<td>

<p>If TRUE, will implicitly match parameters ending with &quot;_exp&quot;,
and if this is the case <code>log</code> all <var>value</var>/<var>lower</var>/<var>upper</var> values
</p>
</td></tr>
</table>


<h3>Details</h3>

<p><var>name_spec</var> is a glob (or wildcard) matching parameters.
It is a string separated by <code>.</code>, where each part can be:
</p>

<ol>
<li><p>A wildcard matching anything (<code>*</code>), or a matching anything with a prefix, e.g. <code>m*</code>
</p>
</li>
<li><p>A wildcard matching any number (<code>#</code>), or a matching a number with a prefix, e.g. <code>age*</code>
</p>
</li>
<li><p>A range of numbers, e.g. <code>[1979-1984]</code>
</p>
</li>
<li><p>A choice of options can be separated with <code>|</code>, e.g. <code>init|rec</code> or <code>[1979-1984]|[2000-2003]</code>
</p>
</li></ol>



<h3>Value</h3>

<p>A new parameter template list/table containing modifications</p>


<h3>See Also</h3>

<p><code><a href="#topic+g3_parameterized">g3_parameterized</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># A parameter template, would already be got via. attr(g3_to_tmb(...), "parameter_template")
pt &lt;- data.frame(
    switch = c(
        paste0('fish.init.', 1:9),
        paste0('fish.rec.', 1990:2000),
        'fish.M'),
    value = NA,
    lower = NA,
    upper = NA,
    parscale = NA,
    optimise = FALSE,
    random = FALSE)

# Set all fish.init.# parameters to optimise
pt &lt;- g3_init_val(pt, 'fish.init.#', 4, spread = 8)

# Set a fixed value for any .M
pt &lt;- g3_init_val(pt, '*.M', value = 0.3, optimise = FALSE)

# Set a fixed value for a range of recruitment years, optimise the rest
pt |&gt;
    g3_init_val('*.rec.#', value = 4, lower = 0, upper = 10) |&gt;
    g3_init_val('*.rec.[1993-1996]', value = 0, optimise = FALSE) |&gt;
    identity() -&gt; pt

pt
</code></pre>

<hr>
<h2 id='language'>G3 language extensions to R</h2><span id='topic+g3_idx'></span><span id='topic+g3_param'></span><span id='topic+g3_param_vector'></span><span id='topic+g3_param_table'></span><span id='topic+g3_with'></span>

<h3>Description</h3>

<p>Additional meta-functions available for use in G3 formula.
</p>


<h3>Details</h3>

<p>Whilst used as functions, these functions alter the code output of the model,
rather than appearing directly.
</p>


<h3>g3_idx</h3>

<p>Adds a <code>- 1</code> to the supplied expression, but only in C++ (which has 0-based
indexes). Under R the expression is passed through unchanged.
</p>
<p><em>Note:</em> This is generally for internal use, as <code>[[</code> will do this
automatically for you.
</p>
<p>For example, <code>g3_idx(a)</code> will be replaced with <code>a</code> in R output
and <code>a - 1</code> in C++ output.
</p>


<h3>g3_param</h3>

<p>Reference a scalar parameter by name. Arguments:
</p>

<dl>
<dt>name</dt><dd><p>Variable name for parameter. Required</p>
</dd>
<dt>value</dt><dd><p>Initial value in model parameter_template. Default 0</p>
</dd>
<dt>optimise</dt><dd><p>Initial optimise setting in parameter_template. Default TRUE</p>
</dd>
<dt>random</dt><dd><p>Initial random setting in parameter_template. Default FALSE</p>
</dd>
<dt>lower</dt><dd><p>Initial lower setting in parameter_template. Default NA</p>
</dd>
<dt>upper</dt><dd><p>Initial upper setting in parameter_template. Default NA</p>
</dd>
</dl>

<p>For example, <code>g3_param("ling.Linf")</code> will register a scalar parameter
called <var>ling.Linf</var>, available in the model parameter template, and be
replaced by a reference to that parameter.
</p>
<p><code>g3_param("ling.Linf")</code> can be used multiple times, to refer to the same
value.  
</p>


<h3>g3_param_vector</h3>

<p>Reference a vector parameter by name. Arguments:
</p>

<dl>
<dt>name</dt><dd><p>Variable name for parameter. Required</p>
</dd>
<dt>value</dt><dd><p>Initial value for use in model paramter_template. Default 0</p>
</dd>
</dl>

<p>Same as <code>g3_param</code>, but the parameter will be expected to be a vector.
You can then dereference with <code>[[</code>.
</p>
<p>For example, <code>g3_param_vector("lingimm.M")[[age - 3 + 1]]</code>.
</p>


<h3>g3_param_table</h3>

<p>Reference a lookup-table of parameters.
</p>

<dl>
<dt>name</dt><dd><p>Variable name for parameter. Required</p>
</dd>
<dt>table</dt><dd><p>A data.frame, one column for each variable to check, one row for possible values. Required</p>
</dd>
<dt>value</dt><dd><p>Initial value for use in model parameter_template. Default 0</p>
</dd>
<dt>optimise</dt><dd><p>Initial optimise setting in parameter_template. Default TRUE</p>
</dd>
<dt>random</dt><dd><p>Initial random setting in parameter_template. Default FALSE</p>
</dd>
<dt>lower</dt><dd><p>Initial lower setting in parameter_template. Default NA</p>
</dd>
<dt>upper</dt><dd><p>Initial upper setting in parameter_template. Default NA</p>
</dd>
<dt>ifmissing</dt><dd><p>Value to return when outside of table bounds. Default NaN with warning if a value is missing</p>
</dd>
</dl>

<p>This is similar to providing a vector, but can use values in the model to
provide bounds-checking.
</p>
<p>The function takes 2 arguments, a prefix for the generated parameters, and a
data.frame of variables to possible values. <code><a href="base.html#topic+expand.grid">expand.grid</a></code> can be
used to produce a cross product of all provided variables.
</p>
<p><em>Note:</em> The variables referenced will need to be integer variables, most
likely iteration variables such as <code>cur_year</code>, <code>age</code>,
<code>area</code>...
</p>
<p>For example, the following: <code>g3_param_table('lingimm.M', expand.grid(age = seq(ling_imm__minage,
  ling_imm__maxage)))</code> will generate parameters
<var>lingimm.M.3</var>..<var>lingimm.M.10</var>, assuming that ling_imm has ages 3..10.
</p>
<p>The call to <code>g3_param_table</code> will be replaced with
<code>param[[paste("lingimm.M", age, sep = ".")]]</code>, or equivalent code
in C++.
</p>


<h3>g3_with</h3>

<p><code>g3_with(var1 := val1, var2 := val2, { x &lt;- val1 * val2 })</code>
is equivalent to
<code>local({var1 &lt;- val1, var2 &lt;- val2, { x &lt;&lt;- val1 * val2 } })</code>
</p>
<p>However, we don't make a new environment for the code block in R, only in C++.
</p>

<hr>
<h2 id='likelihood_bounds_penalty'>Gadget3 likelihood bounds_penalty action</h2><span id='topic+g3l_bounds_penalty'></span>

<h3>Description</h3>

<p>Add a liklihood penalty for parameters leaving the bounds set in parameter_template
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3l_bounds_penalty(
        actions_or_parameter_template,
        weight = 1,
        run_at = g3_action_order$likelihood)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="likelihood_bounds_penalty_+3A_actions_or_parameter_template">actions_or_parameter_template</code></td>
<td>

<p>Either:
</p>
<p>A list of actions, to extract parameters from and to add bounds to.
</p>
<p>A parameter template generated by <code><a href="#topic+g3_to_tmb">g3_to_tmb</a></code>, with <var>optimise</var>, <var>lower</var>, <var>upper</var> populated,
bounds for the parameters will be hard-coded.
</p>
</td></tr>
<tr><td><code id="likelihood_bounds_penalty_+3A_weight">weight</code></td>
<td>

<p>Weighting applied to this likelihood component.
</p>
</td></tr>
<tr><td><code id="likelihood_bounds_penalty_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Whilst lower/upper can be passed to <code><a href="stats.html#topic+optim">optim</a></code>, not all methods can use them.
Adding <code>g3l_bounds_penalty</code> OTOH can be used with any method.
</p>


<h3>Value</h3>



<h4>g3l_bounds_penalty</h4>

<p>An action (i.e. list of formula objects) that will...
If a <var>actions</var> list is supplied, add a large number to likelihood when any parameter is outside bounds.
Bounds are updated whenever <code><a href="#topic+g3_tmb_adfun">g3_tmb_adfun</a></code> is run.
</p>
<p>If a <var>parameter_template</var> is supplied, add a large number to likelihood when outside the bounds in the template.
The bounds are baked into the model at this point.
</p>



<h3>Examples</h3>

<pre><code class='language-R'>
anch &lt;- g3_stock('anch', seq(20, 156, 4)) %&gt;% g3s_age(3, 10)
actions &lt;- list(
  g3a_time(1990, 1994),
  g3a_growmature(anch, g3a_grow_impl_bbinom(
    maxlengthgroupgrowth = 38L)),
  g3a_naturalmortality(anch),
  g3a_initialconditions_normalparam(anch),
  g3a_renewal_normalparam(anch,
    run_step = NULL),
  g3a_age(anch),
  NULL)

# Generate code with bounds added
model_code &lt;- g3_to_tmb(c(actions, list(g3l_bounds_penalty(actions))))

attr(model_code, "parameter_template") %&gt;%
  # Set lower / upper bounds for initial conditions
  g3_init_val("*.init.#", 10, lower = 0.001, upper = 200) %&gt;%
  identity() -&gt; params.in

# The objective function produced by g3_tmb_adfun() will honour the bounds
# above, without having to pass them to stats::optim()
</code></pre>

<hr>
<h2 id='likelihood_catchdistribution'>Gadget3 likelihood actions</h2><span id='topic+g3l_distribution_sumofsquares'></span><span id='topic+g3l_distribution_multinomial'></span><span id='topic+g3l_distribution_multivariate'></span><span id='topic+g3l_distribution_surveyindices_log'></span><span id='topic+g3l_distribution_surveyindices_linear'></span><span id='topic+g3l_distribution_sumofsquaredlogratios'></span><span id='topic+g3_distribution_preview'></span><span id='topic+g3l_abundancedistribution'></span><span id='topic+g3l_catchdistribution'></span>

<h3>Description</h3>

<p>Gather nll in a g3 model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3l_distribution_sumofsquares(over = c("area"))

g3l_distribution_multinomial(epsilon = 10)

g3l_distribution_multivariate(rho_f, sigma_f, over = c("area"))

g3l_distribution_surveyindices_log(alpha = NULL, beta = 1)

g3l_distribution_surveyindices_linear(alpha = NULL, beta = 1)

g3l_distribution_sumofsquaredlogratios(epsilon = 10)

g3l_abundancedistribution(
        nll_name,
        obs_data,
        fleets = list(),
        stocks,
        function_f,
        transform_fs = list(),
        missing_val = 0,
        area_group = NULL,
        report = FALSE,
        nll_breakdown = FALSE,
        weight = substitute(
            g3_param(n, optimise = FALSE, value = 1),
            list(n = paste0(nll_name, "_weight"))),
        run_at = g3_action_order$likelihood)

g3l_catchdistribution(
        nll_name,
        obs_data,
        fleets = list(),
        stocks,
        function_f,
        transform_fs = list(),
        missing_val = 0,
        area_group = NULL,
        report = FALSE,
        nll_breakdown = FALSE,
        weight = substitute(
            g3_param(n, optimise = FALSE, value = 1),
            list(n = paste0(nll_name, "_weight"))),
        run_at = g3_action_order$likelihood)

g3_distribution_preview(
        obs_data,
        fleets = list(),
        stocks = list(),
        area_group = NULL)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="likelihood_catchdistribution_+3A_over">over</code></td>
<td>

<p>When comparing proportions of lengthgroups, specifies the dimensions that define the total.
For example the default &quot;area&quot; means the proprtion of the current lengthgroup to all individuals
in that area.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_rho_f">rho_f</code>, <code id="likelihood_catchdistribution_+3A_sigma_f">sigma_f</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> substituted into multivariate calcuations, see below.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_epsilon">epsilon</code></td>
<td>

<p>Value to be used whenever the calculated probability is very unlikely. Default 10.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_alpha">alpha</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> substituted into surveyindices calcuations to fix intercept of linear regression,
or NULL if not fixed. See below.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_beta">beta</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> substituted into surveyindices calcuations to fix slope of linear regression,
or NULL if not fixed. See below.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_nll_name">nll_name</code></td>
<td>

<p>Character string, used to define the variable name for <var>obsstock</var> and <var>modelstock</var>.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_obs_data">obs_data</code></td>
<td>

<p>Data.frame of observation data, for example the results of
<a href="mfdb.html#topic+mfdb_sample_count">mfdb_sample_count</a>.
</p>
<p>Should at least have a year column, and a length or weight column.
For more information, see &quot;obs_data and data aggregation&quot; below.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_fleets">fleets</code></td>
<td>

<p>A list of <code><a href="#topic+g3_stock">g3_stock</a></code> objects to collect catch data for.
If empty, will collect abundance data for <var>stocks</var> instead.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_stocks">stocks</code></td>
<td>

<p>A list of <code><a href="#topic+g3_stock">g3_stock</a></code> objects to collect catch or abundance data for,
depending if <var>stocks</var> were provided.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_function_f">function_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> to compare <var>obsstock__x</var> to <var>modelstock__x</var> and generate nll,
defined by one of the <var>g3l_distribution_</var>* functions.
</p>
<p>This will be adapted to compare either number (<var>modelstock__num</var>) or weight (<var>modelstock__wgt</var>)
depending on what columns <var>obs_data</var> has.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_transform_fs">transform_fs</code></td>
<td>

<p>A list of dimension name to formula to apply to model data before collating. See examples.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_missing_val">missing_val</code></td>
<td>

<p>Where there are missing values in the incoming data, value to replace them with.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_area_group">area_group</code></td>
<td>

<p><a href="mfdb.html#topic+mfdb_group">mfdb_group</a> or list mapping area names used in
<var>obs_data</var> to integer model areas, see &quot;obs_data and data aggregation&quot;
below.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_report">report</code></td>
<td>

<p>If TRUE, add model and observation arrays to the model report, called
<code>cdist_<var>nll_name</var>_model__num/wgt</code> and <code>cdist_<var>nll_name</var>_obs__num/wgt</code>
respectively
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_nll_breakdown">nll_breakdown</code></td>
<td>

<p>Should the nll report be broken down by time? <code>TRUE</code> / <code>FALSE</code>
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_weight">weight</code></td>
<td>

<p>Weighting applied to this likelihood component. Default is a <code>g3_param</code>
that defaults to 1, allowing weights to be altered without recompiling.
</p>
</td></tr>
<tr><td><code id="likelihood_catchdistribution_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The actions will define the following variables in your model:
</p>

<dl>
<dt><var>obsstock</var>__num/wgt</dt><dd><p>A <code><a href="#topic+g3_stock">g3_stock</a></code> instance that contains all observations in an array</p>
</dd>
<dt><var>modelstock</var>__num/wgt</dt><dd><p>A <code><a href="#topic+g3_stock">g3_stock</a></code> instance that groups in an identical fashion to <var>obsstock</var>,
that will be filled with the model's predicted values</p>
</dd>
</dl>

<p>The model report will contain nll_cdist_<var>nll_name</var>__num and/or nll_cdist_<var>nll_name</var>__wgt, depending on
the columns in <var>obs_data</var> (a number column will compare by individuals, and produce a corresponding num report).
If <var>nll_breakdown</var> is <code>TRUE</code>, this will be an array with one entry per timestep.
</p>
<p><var>g3l_abundancedistribution</var> compares abundance of stocks, <var>g3l_catchdistribution</var> compares fleet catch.
Thus providing fleets is mandatory for <var>g3l_catchdistribution</var>, and an error for <var>g3l_abundancedistribution</var>.
</p>


<h4>obs_data and data aggregation</h4>

<p>The <var>obs_data</var> data.frame, as well as providing the observation data to
compare the model data against, controls the grouping of model data to
compare to the observation data, by inspecting the MFDB column attributes
produced by e.g. <a href="mfdb.html#topic+mfdb_sample_count">mfdb_sample_count</a>.
</p>
<p>Metadata columns describe the observation datapoint in that row. The
columns should be from this list:
</p>

<dl>
<dt>year</dt><dd>
<p>Required.
Year for the data point. Gaps in years will result in no comparison for that year
</p>
</dd>
<dt>step</dt><dd>
<p>Optional.
If there is no step column, then the data is assumed to be yearly, and
the model data for all timesteps will be summed before comparing.
</p>
<p>Model timestep for the data point. Gaps in steps will result in no comparison for that year/step.
</p>
</dd>
<dt>length</dt><dd>
<p>Optional.
If missing all lengthgroups in the model will be summed to compare to
the data.
</p>
<p>The column can be a factor, as generated by <code><a href="base.html#topic+cut">cut</a>()</code>, e.g
<code>cut(raw_length, c(seq(0, 50, by = 10), Inf), right = FALSE)</code>
for an open-ended upper group.
</p>
<p>The column can be character strings also formatted as factors as above.
The column entries are assumed to be sorted in order and converted back
to a factor.
</p>
<p>If <code>open_ended = c('lower', 'upper')</code> was used when querying MFDB
for the data, then the bottom/top length groups will be modified to
start from zero or be infinite respectively.
</p>
<p>Any missing lengthgroups (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
<dt>age</dt><dd>
<p>Optional.
If missing all age-groups (if any) in the model will be summed to compare to
the data.
</p>
<p>Model ages will be grouped by the same groupings as MFDB used, thus if
the data was formed with a query <code>age = mfdb_group(young = 1:3,
        old = 4:5)</code>, then the model data will similarly have 2 groups in it.
</p>
<p>Any missing ages (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
<dt>stock</dt><dd>
<p>Optional.
If this and stock_re are missing all stocks in <var>stocks</var> will be
summed to compare to the data.
</p>
<p>The values in the stocks column should match the names of the stocks
given in the <var>stocks</var> parameter. This column can be factor or
character.
</p>
<p>Any missing stocks (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
<dt>stock_re</dt><dd>
<p>Optional.
If this and stock are missing all stocks in <var>stocks</var> will be summed
to compare to the data.
</p>
<p>The values in the stocks column will be used as regular expressions to
match the names of the stocks given in the <var>stocks</var> parameter. For
example, '_mat_' will match both 'ghd_mat_f' and 'ghd_mat_m' and will
be compared against the sum of the 2 stocks.
</p>
<p>Any missing stocks (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
<dt>fleet</dt><dd>
<p>Optional.
If this and fleet_re are missing all fleets in <var>fleets</var> will be
summed to compare to the data.
</p>
<p>The values in the fleets column should match the names of the fleets
given in the <var>fleets</var> parameter. This column can be factor or
character.
</p>
<p>Any missing fleets (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
<dt>fleet_re</dt><dd>
<p>Optional.
If this and fleet are missing all fleets in <var>fleets</var> will be summed
to compare to the data.
</p>
<p>The values in the fleets column will be used as regular expressions to
match the names of the fleets given in the <var>fleets</var> parameter. For
example, '_trawl_' will match both 'fleet_trawl_is' and 'fleet_trawl_no' and will
be compared against the sum of the 2 fleets.
</p>
<p>Any missing fleets (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
<dt>area</dt><dd>
<p>Optional.
If missing all areas in the model will be summed to compare to
the data.
</p>
<p>Unlike other columns, the MFDB grouping here is ignored (the areas it
is grouping over aren't integer model areas). Instead, the
<var>area_group</var> parameter should describe how to map from the area
names used in the table to integer model areas.
</p>
<p>For example, if <code>area_group = list(north=1:2, south=3:5)</code>, then
the area column of <var>obs_data</var> should contain either &quot;north&quot; or
&quot;south&quot;, and corresponding model data will be summed from integer model
areas 1,2 and 3,4,5 respectively.
</p>
<p>If <var>area_group</var> is not supplied, then we assume that <var>obs_data</var>
area column will contain model area integers.
</p>
<p>Any missing areas (when there is otherwise data for that
year/step) will be compared to zero.
</p>
</dd>
</dl>

<p>Data columns contain the observation data to compare. There should be at
least one of:
</p>

<dl>
<dt>number</dt><dd>
<p>If a number column appears in <var>obs_data</var>, then the stock abundance
by individuals will be aggregated and compared to the <var>obs_data</var>
number column.
</p>
</dd>
<dt>weight</dt><dd>
<p>If a weight column appears in <var>obs_data</var>, then the total biomass of
the stock will be aggregated and compared to the <var>obs_data</var> number
column.
</p>
</dd>
</dl>

<p>You can use <code>g3_distribution_preview</code> to see how your observation data
will be converted into an array.
</p>



<h3>Value</h3>



<h4>g3l_distribution_sumofsquares</h4>

<p>Returns a <a href="stats.html#topic+formula">formula</a> for use as <var>function_f</var>:
</p>
<p style="text-align: center;"><code class="reqn"> \sum_{\it lengths} \Big( \frac{N_{tral}}{N_{tr}} - \frac{\nu_{tral}}{\nu_{tr}}  \Big) ^2 </code>
</p>


<dl>
<dt><code class="reqn">N_{tral}</code></dt><dd><p>Observation sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\nu_{tral}</code></dt><dd><p>Model sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">N_{tr}</code></dt><dd><p>Total observation sample size for current time/area (or dimensions set in <var>over</var>)</p>
</dd>
<dt><code class="reqn">\nu_{tr}</code></dt><dd><p>Total model sample size for current time/area (or dimensions set in <var>over</var>)</p>
</dd>
</dl>




<h4>g3l_distribution_multinomial</h4>

<p>Returns a <a href="stats.html#topic+formula">formula</a> for use as <var>function_f</var>:
</p>
<p style="text-align: center;"><code class="reqn">
      2 (
        \sum_{\it lengths} \log N_{tral}! -
        \log (\sum_{\it lengths} N_{tral})! -
        \sum_{\it lengths} ( N_{tral} \log min(\frac{\nu_{tral}}{\sum_{\it lengths} \nu_{tral}}, \frac{1}{l \epsilon}) )
      )
    </code>
</p>


<dl>
<dt><code class="reqn">N_{tral}</code></dt><dd><p>Observation sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\nu_{tral}</code></dt><dd><p>Model sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">l</code></dt><dd><p>Number of lengthgroups in sample</p>
</dd>
<dt><code class="reqn">\epsilon</code></dt><dd><p><var>epsilon</var> parameter</p>
</dd>
</dl>




<h4>g3l_distribution_multivariate</h4>

<p>Returns a <a href="stats.html#topic+formula">formula</a> for use as <var>function_f</var>, which calls TMB's <code>SCALE(AR1(rho), sigma)(x)</code>, where
<var>rho</var> and <var>sigma</var> are parameters, and <code>x</code> is defined as:
</p>
<p style="text-align: center;"><code class="reqn"> \frac{N_{tral}}{N_{tr}} - \frac{\nu_{tral}}{\nu_{tr}} </code>
</p>


<dl>
<dt><code class="reqn">N_{tral}</code></dt><dd><p>Observation sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\nu_{tral}</code></dt><dd><p>Model sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">N_{tr}</code></dt><dd><p>Total observation sample size for current time/area (or dimensions set in <var>over</var>)</p>
</dd>
<dt><code class="reqn">\nu_{tr}</code></dt><dd><p>Total model sample size for current time/area (or dimensions set in <var>over</var>)</p>
</dd>
</dl>

<p>For more information, see <a href="http://kaskr.github.io/adcomp/_book/Densities.html#autoregressive-processes">Autoregressive processes</a>
in the TMB book.
</p>



<h4>g3l_distribution_surveyindices_log</h4>

<p>Returns a <a href="stats.html#topic+formula">formula</a> for use as <var>function_f</var>:
</p>
<p style="text-align: center;"><code class="reqn">
      \sum_{\it time} (\alpha + \beta \log N_{tral} - \log \nu_{tral})^2
    </code>
</p>


<dl>
<dt><code class="reqn">N_{tral}</code></dt><dd><p>Observation sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\nu_{tral}</code></dt><dd><p>Model sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\alpha</code></dt><dd><p><var>alpha</var> parameter</p>
</dd>
<dt><code class="reqn">\beta</code></dt><dd><p><var>beta</var> parameter</p>
</dd>
</dl>

<p>If <var>alpha</var> or <var>beta</var> is not provided, then linear regression is
performed on <code class="reqn">N</code>, <code class="reqn">\nu</code> over time for each area/age/length combination.
The used values will be stored in a <code>cdist_<var>nll_name</var>_model__param</code> array and
reported after model run, whether calculated or hard-coded.
</p>



<h4>g3l_distribution_surveyindices_linear</h4>

<p>Returns a <a href="stats.html#topic+formula">formula</a> for use as <var>function_f</var>:
</p>
<p style="text-align: center;"><code class="reqn">
      \sum_{\it lengths} (\alpha + \beta N_{tral} - \nu_{tral})^2
    </code>
</p>


<dl>
<dt><code class="reqn">N_{tral}</code></dt><dd><p>Observation sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\nu_{tral}</code></dt><dd><p>Model sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\alpha</code></dt><dd><p><var>alpha</var> parameter</p>
</dd>
<dt><code class="reqn">\beta</code></dt><dd><p><var>beta</var> parameter</p>
</dd>
</dl>

<p>If <var>alpha</var> or <var>beta</var> is not provided, then linear regression is
performed on <code class="reqn">N</code>, <code class="reqn">\nu</code> over time for each area/age/length combination.
The used values will be stored in a <code>cdist_<var>nll_name</var>_model__param</code> array and
reported after model run, whether calculated or hard-coded.
</p>



<h4>g3l_distribution_sumofsquaredlogratios</h4>

<p>The equivalent of gadget2's <code>catchinkilos</code>.
</p>
<p>Returns a <a href="stats.html#topic+formula">formula</a> for use as <var>function_f</var>:
</p>
<p style="text-align: center;"><code class="reqn">
      \sum_{\it lengths} (log(N_{tral} + \epsilon) - log(\nu_{tral} + \epsilon))^2
    </code>
</p>


<dl>
<dt><code class="reqn">N_{tral}</code></dt><dd><p>Observation sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\nu_{tral}</code></dt><dd><p>Model sample size for current time/area/age/length combination</p>
</dd>
<dt><code class="reqn">\epsilon</code></dt><dd><p><var>epsilon</var> parameter</p>
</dd>
</dl>




<h4>g3l_abundancedistribution</h4>

<p>An action (i.e. list of formula objects) that will...</p>

<ol>
<li><p>For all <var>stocks</var>, collect catch data into <var>modelstock</var>__num or <var>modelstock</var>__wgt, depending on the columns provided in <var>obs_data</var>
</p>
</li>
<li><p>Compare <var>modelstock</var>__num/wgt with <var>obsstock</var>__num/wgt, using <var>function_f</var>
</p>
</li></ol>

<p>The output of <var>function_f</var> is summed over all stock dimensions (age/area) and time and added to <code>nll</code>.
</p>



<h4>g3l_catchdistribution</h4>

<p>An action (i.e. list of formula objects) that will...</p>

<ol>
<li><p>For all <var>fleets</var> and <var>stocks</var> combinations, collect catch data into <var>modelstock</var>__num or <var>modelstock</var>__wgt, depending on the columns provided in <var>obs_data</var>
</p>
</li>
<li><p>Compare <var>modelstock</var>__num/wgt with <var>obsstock</var>__num/wgt, using <var>function_f</var>
</p>
</li></ol>

<p>The output of <var>function_f</var> is summed over all stock dimensions (age/area) and time and added to <code>nll</code>.
</p>



<h4>g3_distribution_preview</h4>

<p>The input <var>obs_data</var> formatted as an array, applying the same rules that <code>g3l_*distribution</code> will.
</p>



<h3>See Also</h3>

<p><a href="https://gadget-framework.github.io/gadget2/userguide/chap-like.html">https://gadget-framework.github.io/gadget2/userguide/chap-like.html</a>,
<code><a href="#topic+g3_stock">g3_stock</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
ling_imm &lt;- g3_stock('ling_imm', seq(20, 156, 4)) %&gt;% g3s_age(3, 10)
ling_mat &lt;- g3_stock('ling_mat', seq(20, 156, 4)) %&gt;% g3s_age(5, 15)
lln &lt;- g3_fleet('lln')

# Invent a ldist.lln table for our tests
ldist.lln.raw &lt;- data.frame(
    year = c(1999, 2000),
    age = sample(5:9, 100, replace = TRUE),
    length = sample(10:70, 100, replace = TRUE),
    number = 1,
    stringsAsFactors = FALSE)

# Group length into 10-long bins
# NB: The last 2 bins will be empty, but gadget3 will use the factor levels, include them as zero
# NB: Generally one would use mfdb::mfdb_sample_count() source and group data for you
ldist.lln.raw |&gt; dplyr::group_by(
  year = year, age = age,
  length = cut(length, breaks = seq(10, 100, by = 10), right = FALSE)
) |&gt; dplyr::summarise(number = sum(number), .groups = 'keep') -&gt; ldist.lln

# Turn age into a factor, indicating all ages we should be interested in
ldist.lln$age &lt;- factor(ldist.lln$age, levels = 5:15)

# We can see the results of this being turned into an array:
g3_distribution_preview(ldist.lln)

likelihood_actions &lt;- list(
  g3l_catchdistribution(
    'ldist_lln',
    ldist.lln,
    fleets = list(lln),
    stocks = list(ling_imm, ling_mat),
    g3l_distribution_sumofsquares()))

# Make an (incomplete) model using the action, extract the observation array
fn &lt;- suppressWarnings(g3_to_r(likelihood_actions))
environment(fn)$cdist_sumofsquares_ldist_lln_obs__num

# Apply age-reading error matrix to model data
more_likelihood_actions &lt;- list(
  g3l_catchdistribution(
    'ldist_lln_readerror',
    ldist.lln,
    fleets = list(lln),
    stocks = list(ling_imm, ling_mat),
    transform_fs = list(age = g3_formula(
      g3_param_array('reader1matrix', value = diag(5))[g3_idx(preage), g3_idx(age)]
      )),
    g3l_distribution_sumofsquares()))

# Apply per-stock age-reading error matrix to model data
more_likelihood_actions &lt;- list(
  g3l_catchdistribution(
    'ldist_lln_readerror',
    ldist.lln,
    fleets = list(lln),
    stocks = list(ling_imm, ling_mat),
    transform_fs = list(age = g3_formula(stock_switch(stock,
      ling_imm = g3_param_array('imm_readermatrix',
          value = diag(ling_imm__maxage - ling_imm__minage + 1)
          )[ling_imm__preage_idx, ling_imm__age_idx],
      ling_mat = g3_param_array('mat_readermatrix',
          value = diag(ling_mat__maxage - ling_mat__minage + 1)
          )[ling_mat__preage_idx, ling_mat__age_idx],
      unused = 0))),
    g3l_distribution_sumofsquares()))
</code></pre>

<hr>
<h2 id='likelihood_random'>Gadget3 random effects likelihood actions</h2><span id='topic+g3l_random_dnorm'></span><span id='topic+g3l_random_walk'></span>

<h3>Description</h3>

<p>Add likelihood components for random effects
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3l_random_dnorm(
        nll_name,
        param_f,
        mean_f = 0,
        sigma_f = 1,
        log_f = TRUE,
        period = 'auto',
        nll_breakdown = FALSE,
        weight = substitute(
            g3_param(n, optimise = FALSE, value = 1),
            list(n = paste0(nll_name, "_weight"))),
        run_at = g3_action_order$likelihood)

g3l_random_walk(
        nll_name,
        param_f,
        sigma_f = 1,
        log_f = TRUE,
        period = 'auto',
        nll_breakdown = FALSE,
        weight = substitute(
            g3_param(n, optimise = FALSE, value = 1),
            list(n = paste0(nll_name, "_weight"))),
        run_at = g3_action_order$likelihood)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="likelihood_random_+3A_param_f">param_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> representing the value to apply <a href="stats.html#topic+dnorm">dnorm</a> to.
Invariably a <a href="#topic+g3_param">g3_param</a> for <a href="#topic+g3l_random_dnorm">g3l_random_dnorm</a>,
a <a href="#topic+g3_param_table">g3_param_table</a> with <var>cur_year</var> for <a href="#topic+g3l_random_walk">g3l_random_walk</a>.
</p>
</td></tr>
<tr><td><code id="likelihood_random_+3A_mean_f">mean_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> representing <var>mean</var> in <a href="stats.html#topic+dnorm">dnorm</a>.
</p>
</td></tr>
<tr><td><code id="likelihood_random_+3A_sigma_f">sigma_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> representing <var>sigma</var> in <a href="stats.html#topic+dnorm">dnorm</a>.
</p>
</td></tr>
<tr><td><code id="likelihood_random_+3A_log_f">log_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> representing <var>log</var> in <a href="stats.html#topic+dnorm">dnorm</a>.
</p>
</td></tr>
<tr><td><code id="likelihood_random_+3A_period">period</code></td>
<td>

<p>When <a href="stats.html#topic+dnorm">dnorm</a> should be recalculated. Once per <code>year</code> every <code>step</code>, or <code>single</code> for once.
The default, <code>auto</code>, will assume the input is generated by <code><a href="#topic+g3_parameterized">g3_parameterized</a></code> and will
derive the most appropriate option.
</p>
</td></tr>
<tr><td><code id="likelihood_random_+3A_nll_name">nll_name</code></td>
<td>

<p>Character string, used to define the variable name for <var>dnorm</var> output.
</p>
</td></tr>
<tr><td><code id="likelihood_random_+3A_nll_breakdown">nll_breakdown</code></td>
<td>

<p>Should the nll report be broken down by time? <code>TRUE</code> / <code>FALSE</code>
</p>
</td></tr>
<tr><td><code id="likelihood_random_+3A_weight">weight</code></td>
<td>

<p>Weighting applied to this likelihood component.
</p>
</td></tr>
<tr><td><code id="likelihood_random_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The model report will contain <code>nll_random_dnorm_dnorm_lin__dnorm</code>, the results of applying dnorm.
If <var>nll_breakdown</var> is <code>TRUE</code>, this will be an array with one entry per timestep.
</p>


<h3>Value</h3>



<h4>g3l_random_dnorm</h4>

<p>An action (i.e. list of formula objects) that will...</p>

<ol>
<li><p>On the final model step, calculate <code>dnorm(param_f, mean_f, sigma_f)</code> &amp; add to nll
</p>
</li></ol>



<h4>g3l_random_walk</h4>

<p>An action (i.e. list of formula objects) that will...</p>

<ol>
<li><p>Calculate <code>dnorm(param_f, previous param_f, sigma_f)</code> (at final year if period = year)
</p>
</li>
<li><p>Add to nll.
</p>
</li></ol>



<h3>Examples</h3>

<pre><code class='language-R'>

likelihood_actions &lt;- list(
    # Calculate dnorm() for the dnorm_log parameter
    g3l_random_dnorm('dnorm_log',
        g3_parameterized('dnorm_log', value = 0, random = TRUE),
        mean_f = 0),

    # Treat the walk_year.xxxx parameters as a random walk
    g3l_random_walk('walk_year',
        g3_parameterized('walk_year', by_year = TRUE, value = 0, random = TRUE))
)</code></pre>

<hr>
<h2 id='likelihood_tagging_ckmr'>Gadget3 CKMR likelihood</h2><span id='topic+g3l_tagging_ckmr'></span>

<h3>Description</h3>

<p>*Experimental* CKMR tagging likelihood
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3l_tagging_ckmr(
        nll_name,
        obs_data,
        fleets,
        parent_stocks,
        offspring_stocks,
        weight = substitute(
            g3_param(n, optimise = FALSE, value = 1),
            list(n = paste0(nll_name, "_weight"))),
        run_at = g3_action_order$likelihood)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="likelihood_tagging_ckmr_+3A_nll_name">nll_name</code></td>
<td>

<p>Character string, used to define the variable name for <var>obsstock</var> and <var>modelstock</var>.
</p>
</td></tr>
<tr><td><code id="likelihood_tagging_ckmr_+3A_obs_data">obs_data</code></td>
<td>

<p>Data.frame of observed mother-offspring pairs with columns year / parent_age / offspring_age / mo_pairs
</p>
</td></tr>
<tr><td><code id="likelihood_tagging_ckmr_+3A_fleets">fleets</code></td>
<td>

<p>A list of <code><a href="#topic+g3_stock">g3_stock</a></code> objects to collect catch data for.
</p>
</td></tr>
<tr><td><code id="likelihood_tagging_ckmr_+3A_parent_stocks">parent_stocks</code></td>
<td>

<p>A list of <code><a href="#topic+g3_stock">g3_stock</a></code> objects that are parents in a <a href="#topic+g3a_spawn">g3a_spawn</a> action
</p>
</td></tr>
<tr><td><code id="likelihood_tagging_ckmr_+3A_offspring_stocks">offspring_stocks</code></td>
<td>

<p>A list of <code><a href="#topic+g3_stock">g3_stock</a></code> objects that are <code>output_stocks</code> in a <a href="#topic+g3a_spawn">g3a_spawn</a> action
</p>
</td></tr>
<tr><td><code id="likelihood_tagging_ckmr_+3A_weight">weight</code></td>
<td>

<p>Weighting applied to this likelihood component. Default is a <code>g3_param</code>
that defaults to 1, allowing weights to be altered without recompiling.
</p>
</td></tr>
<tr><td><code id="likelihood_tagging_ckmr_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Implementation of CKMR based on <cite>Bravington, M.V., Skaug, H.J., &amp; Anderson, E.C. (2016). Close-Kin Mark-Recapture. Statistical Science, 31, 259-274.</cite>
</p>
<p>Only one kinship probability is implemented, mother-offspring with lethal
sampling, i.e. (3.2) in the paper. This is then used as a pseudo-likelihood
as per (4.1).
</p>


<h4>obs_data</h4>

<p>The <var>obs_data</var> data.frame provides observed pairs. Unlike other likelihood
mehthods, it has a fixed structure:
</p>

<dl>
<dt>year</dt><dd>
<p>Year of observation for the data point.
</p>
</dd>
<dt>parent_age</dt><dd>
<p>Age of the parent in an observed parent-offspring pair.
</p>
</dd>
<dt>offspring_age</dt><dd>
<p>Age of the offspring in an observed parent-offspring pair.
</p>
</dd>
<dt>mo_pairs</dt><dd>
<p>Number of pairs observed with these ages.
</p>
</dd>
</dl>




<h3>Value</h3>



<h4>g3l_tagging_ckmr</h4>

<p>An action (i.e. list of formula objects) that will...</p>

<ol>
<li><p>For all <var>parent_stocks</var> and <var>offspring_stocks</var>, collect spawing rate into
<var>modelhist</var>__spawning and <var>modelhist</var>__spawned, total number of parents and total number of spawned offspring respectively
</p>
</li>
<li><p>For all <var>fleets</var>, collect catch data into <var>modelhist</var>__catch
</p>
</li>
<li><p>For any observed pairs that year, include the probability of that event happening into <code>nll</code>
</p>
</li></ol>



<h3>See Also</h3>

<p><cite>Bravington, M.V., Skaug, H.J., &amp; Anderson, E.C. (2016). Close-Kin Mark-Recapture. Statistical Science, 31, 259-274.</cite>
<code><a href="#topic+g3_stock">g3_stock</a></code>
</p>

<hr>
<h2 id='likelihood_understocking'>Gadget3 likelihood understocking action</h2><span id='topic+g3l_understocking'></span>

<h3>Description</h3>

<p>Add rates of understocking in a g3 model to nll
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3l_understocking(
        prey_stocks,
        power_f = ~2,
        nll_breakdown = FALSE,
        weight = 1e+08,
        run_at = g3_action_order$likelihood)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="likelihood_understocking_+3A_prey_stocks">prey_stocks</code></td>
<td>

<p>A list of <code><a href="#topic+g3_stock">g3_stock</a></code> objects to collect catch data for
</p>
</td></tr>
<tr><td><code id="likelihood_understocking_+3A_power_f">power_f</code></td>
<td>

<p>A <a href="stats.html#topic+formula">formula</a> representing power coefficient <code class="reqn">p</code> to use.
</p>
</td></tr>
<tr><td><code id="likelihood_understocking_+3A_nll_breakdown">nll_breakdown</code></td>
<td>

<p>Should the nll report be broken down by time? <code>TRUE</code> / <code>FALSE</code>
</p>
</td></tr>
<tr><td><code id="likelihood_understocking_+3A_weight">weight</code></td>
<td>

<p>Weighting applied to this likelihood component.
</p>
</td></tr>
<tr><td><code id="likelihood_understocking_+3A_run_at">run_at</code></td>
<td>

<p>Integer order that actions will be run within model, see <code><a href="#topic+g3_action_order">g3_action_order</a></code>.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The model report will contain nll_understocking__wgt, the results of the formula below.
If <var>nll_breakdown</var> is <code>TRUE</code>, this will be an array with one entry per timestep.
</p>


<h3>Value</h3>



<h4>g3l_distribution_understocking</h4>

<p>An action (i.e. list of formula objects) that will...</p>

<ol>
<li><p>Sum the total biomass adjustment due to overstocking for each prey according to the formula
</p>
<p style="text-align: center;"><code class="reqn"> \ell = \sum_{\it time}\sum_{\it areas} \Big(\sum_{\it prey\_stocks} U_{trs} \Big)^p </code>
</p>

<p>Where <code class="reqn"> p </code> is the power coefficient from <var>power_f</var>,
<code class="reqn"> U_{trs} </code> is the total biomass adjustment to predator consumtion due to overconsumtion.
</p>
</li></ol>



<h3>Examples</h3>

<pre><code class='language-R'>
ling_imm &lt;- g3_stock('ling_imm', seq(20, 156, 4)) %&gt;% g3s_age(3, 10)
ling_mat &lt;- g3_stock('ling_mat', seq(20, 156, 4)) %&gt;% g3s_age(5, 15)
lln &lt;- g3_fleet('lln')

likelihood_actions &lt;- list(
  g3l_understocking(list(ling_imm, ling_mat)))
</code></pre>

<hr>
<h2 id='params'>Gadget3 parameter helpers</h2><span id='topic+g3_parameterized'></span>

<h3>Description</h3>

<p>Shortcuts to parameterise a model with g3_param
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_parameterized(
        name,
        by_stock = FALSE,
        by_predator = FALSE,
        by_year = FALSE,
        by_step = FALSE,
        by_age = FALSE,
        exponentiate = FALSE,
        avoid_zero = FALSE,
        scale = 1,
        offset = 0,
        ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="params_+3A_name">name</code></td>
<td>

<p>Suffix for parameter name.
</p>
</td></tr>
<tr><td><code id="params_+3A_by_stock">by_stock</code></td>
<td>

<p>Should there be individual parameters per-stock?
</p>

<dl>
<dt>FALSE</dt><dd><p>No</p>
</dd>
<dt>TRUE</dt><dd><p>Produce a <code>"stock_name.name"</code> parameter</p>
</dd>
<dt>character vector</dt><dd><p>Select the stock name_part(s) to use, e.g. to produce <code>"stock_species.name"</code> parameter with &quot;species&quot;</p>
</dd>
<dt>List of <code><a href="#topic+g3_stock">g3_stock</a></code> objects</dt><dd><p>Produce a parameter that applies to all given stocks</p>
</dd>
</dl>

</td></tr>
<tr><td><code id="params_+3A_by_predator">by_predator</code></td>
<td>

<p>Should there be individual parameters per-predator (read: per-fleet) stock?
</p>

<dl>
<dt>FALSE</dt><dd><p>No</p>
</dd>
<dt>TRUE</dt><dd><p>Produce a <code>"fleet_stock_name.name"</code> parameter</p>
</dd>
<dt>character vector</dt><dd><p>Select the stock name_part(s) to use, e.g. to produce <code>"fleet_country.name"</code> parameter with &quot;country&quot;</p>
</dd>
<dt>List of <code><a href="#topic+g3_stock">g3_stock</a></code> objects</dt><dd><p>Produce a parameter that applies to all given stocks</p>
</dd>
</dl>

</td></tr>
<tr><td><code id="params_+3A_by_year">by_year</code></td>
<td>

<p>Should there be individual parameters per model year?
</p>

<dl>
<dt>FALSE</dt><dd><p>No</p>
</dd>
<dt>TRUE</dt><dd><p>Produce a <code>"name.1998"</code> parameter for each year the model runs</p>
</dd>
<dt>1998:2099</dt><dd><p>Override the year range, so when projecting there will be sufficient parameters available.</p>
</dd>
</dl>

</td></tr>
<tr><td><code id="params_+3A_by_step">by_step</code></td>
<td>

<p>Should there be individual parameters per step within years?
</p>

<dl>
<dt>FALSE</dt><dd><p>No</p>
</dd>
<dt>TRUE</dt><dd><p>Produce a <code>"name.1"</code> seasonal parameter for each step, or <code>"name.1998.1"</code> for every timestep in the model if combined with <var>by_year</var>.</p>
</dd>
</dl>

</td></tr>
<tr><td><code id="params_+3A_by_age">by_age</code></td>
<td>

<p>Should there be individual parameters per stock age?
</p>

<dl>
<dt>FALSE</dt><dd><p>No</p>
</dd>
<dt>TRUE</dt><dd><p>Produce a <code>"name.4"</code> parameter for each age of the stock(s) in <var>by_stock</var></p>
</dd>
</dl>

</td></tr>
<tr><td><code id="params_+3A_exponentiate">exponentiate</code></td>
<td>
<p>Use <code>exp(value)</code> instead of the raw parameter value. Will add &quot;_exp&quot; to the parameter name.</p>
</td></tr>
<tr><td><code id="params_+3A_avoid_zero">avoid_zero</code></td>
<td>
<p>If TRUE, wrap parameter with <code>avoid_zero</code></p>
</td></tr>
<tr><td><code id="params_+3A_scale">scale</code></td>
<td>

<p>Use <code>scale * value</code> instead of the raw parameter value.
Either a numeric constant or character.
If character, add another parameter for scale, using the same <var>by_stock</var> value.
</p>
</td></tr>
<tr><td><code id="params_+3A_offset">offset</code></td>
<td>

<p>Use <code>value + offset</code> instead of the raw parameter value
Either a numeric constant or character.
If character, add another parameter for offset, using the same <var>by_stock</var> value.
</p>
</td></tr>
<tr><td><code id="params_+3A_...">...</code></td>
<td>
<p>Additional parameters passed through to <code><a href="#topic+g3_param">g3_param</a></code>, e.g. <var>optimise</var>, <var>random</var>, ...</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function provides shortcuts to common formulas used when parameterising a model.
</p>


<h3>Value</h3>

<p>A <a href="stats.html#topic+formula">formula</a> object defining the given parameters</p>


<h3>See Also</h3>

<p><code><a href="#topic+g3_param">g3_param</a></code>,
<code><a href="#topic+g3_param_table">g3_param_table</a></code>,
<code><a href="#topic+stock_prepend">stock_prepend</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
stock_a &lt;- g3_stock(c(species = 'stock', 'aaa'), seq(10, 35, 5)) %&gt;% g3s_age(1, 10)
stock_b &lt;- g3_stock(c(species = 'stock', 'bbb'), seq(10, 35, 5)) %&gt;% g3s_age(1, 10)

# Not by anything, so just a regular parameter
g3_parameterized('K')

# by_stock, so will use stock_prepend() to rename variables
g3_parameterized('K', by_stock = TRUE)

# Adding by_year or by_age turns it into a table
g3_parameterized('K', by_stock = TRUE, by_year = TRUE, by_age = TRUE)

# Can specify the name parts you want
g3_parameterized('K', by_stock = 'species', by_year = TRUE)

# Can give a list of stocks, in which case it works out name parts for you
g3_parameterized('K', by_stock = list(stock_a, stock_b))
g3_parameterized('K', by_stock = list(stock_a, stock_b), by_age = TRUE)
</code></pre>

<hr>
<h2 id='run_desc'>Gadget3 actions into R code</h2><span id='topic+g3_to_desc'></span>

<h3>Description</h3>

<p>Convert g3 actions into a character vector describing the model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_to_desc(actions, minor_steps = FALSE)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="run_desc_+3A_actions">actions</code></td>
<td>

<p>A list of actions (i.e. list of formula objects), as produced by <var>g3a_</var>* functions.
</p>
</td></tr>
<tr><td><code id="run_desc_+3A_minor_steps">minor_steps</code></td>
<td>

<p>Include minor steps (e.g. zeroing cumulative arrays)?  <code>TRUE</code> / <code>FALSE</code>
</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Character vector describing each step in the model. An action in a model may have generated
multiple steps (e.g. select each prey stock, scale total amount, apply overstocking), and there
will be a line in here for each.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
ling_imm &lt;- g3_stock('ling_imm', seq(20, 156, 4)) %&gt;% g3s_age(3, 10)

initialconditions_action &lt;- g3a_initialconditions_normalparam(
    ling_imm,
    by_age = TRUE)

# Timekeeping action
time_action &lt;- g3a_time(
    start_year = 2000,
    end_year = 2004,
    c(3, 3, 3, 3))

# Generate a list outlining the steps the model uses
as.list(g3_to_desc(list(initialconditions_action, time_action)))
</code></pre>

<hr>
<h2 id='run_r'>Gadget3 actions into R code</h2><span id='topic+g3_to_r'></span><span id='topic+print.g3_r'></span>

<h3>Description</h3>

<p>Convert g3 actions into an R function that can then be executed
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_to_r(actions, trace = FALSE, strict = FALSE)

## S3 method for class 'g3_r'
print(x, ..., with_environment = FALSE, with_template = FALSE)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="run_r_+3A_actions">actions</code></td>
<td>

<p>A list of actions (i.e. list of formula objects), as produced by <var>g3a_</var>* functions.
</p>
</td></tr>
<tr><td><code id="run_r_+3A_trace">trace</code></td>
<td>

<p>If TRUE, turn all comments into print statements.
</p>
</td></tr>
<tr><td><code id="run_r_+3A_strict">strict</code></td>
<td>

<p>If TRUE, enable extra sanity checking in actions. Any invalid conditions
(e.g. more/less fish after growth) will result in a warning.
</p>
</td></tr>
<tr><td><code id="run_r_+3A_x">x</code></td>
<td>

<p>The <code>g3_to_r</code>-generated function to print
</p>
</td></tr>
<tr><td><code id="run_r_+3A_with_environment">with_environment</code></td>
<td>

<p>If TRUE, list data stored in function environment when printing
</p>
</td></tr>
<tr><td><code id="run_r_+3A_with_template">with_template</code></td>
<td>

<p>If TRUE, show parameter template when printing
</p>
</td></tr>
<tr><td><code id="run_r_+3A_...">...</code></td>
<td>
<p>Other arguments</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A function that takes a <var>params</var> variable, that defines all <var>g3_param</var>s required by the model.
The following attributes will be set:
</p>

<dl>
<dt>actions</dt><dd><p>The original <var>actions</var> list given to the function</p>
</dd>
<dt>parameter_template</dt><dd><p>A list of all parameters expected by the model, to fill in</p>
</dd>
</dl>

<p>Use e.g. <code>attr(fn, 'parameter_template')</code> to retrieve them.
</p>
<p>Invariant model data will be stored as a closure, i.e. in <code>environment(fn)</code>.
This can be fetched with <code>environment(fn)$cdist_sumofsquares_ldist_gil_obs__num</code>.
</p>
<p>The function will return <var>nll</var> produced by the model.
You can also use <code>attributes(nll)</code> to get any report variables from the model.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
ling_imm &lt;- g3_stock(c(species = 'ling', 'imm'), seq(20, 156, 4)) %&gt;% g3s_age(3, 10)

initialconditions_action &lt;- g3a_initialconditions_normalparam(
    ling_imm,
    factor_f = g3a_renewal_initabund(by_stock_f = 'species'),
    by_stock = 'species',
    by_age = TRUE)

# Timekeeping action
time_action &lt;- g3a_time(
    start_year = 2000,
    end_year = 2004,
    c(3, 3, 3, 3))

# Generate a model from the above 2 actions
# NB: Obviously in reality we'd need more actions
fn &lt;- g3_to_r(list(initialconditions_action, time_action))

if (interactive()) {
  # Edit the resulting function
  fn &lt;- edit(fn)
}

param &lt;- attr(fn, 'parameter_template')
param$project_years &lt;- 0
param$ling.init.F &lt;- 0.4
param$ling.Linf &lt;- 160
param$ling.K &lt;- 90
param$ling.recl &lt;- 12
param$recage &lt;- g3_stock_def(ling_imm, 'minage')
param[grepl('^ling.init.sd.', names(param))] &lt;- 50.527220
param[grepl('^ling_imm.init.\\d+', names(param))] &lt;- 1
param$ling_imm.init.scalar &lt;- 200
param$ling_imm.walpha &lt;- 2.27567436711055e-06
param$ling_imm.wbeta &lt;- 3.20200445996187
param$ling_imm.M &lt;- 0.15

# Run the model with the provided parameters
nll &lt;- fn(param)

# Get the report from the last model run
report &lt;- attributes(nll)

# Fetch a value from the model data
environment(fn)$ling_imm__midlen

</code></pre>

<hr>
<h2 id='run_tmb'>Gadget3 actions into TMB code</h2><span id='topic+g3_to_tmb'></span><span id='topic+g3_tmb_adfun'></span><span id='topic+g3_tmb_par'></span><span id='topic+g3_tmb_lower'></span><span id='topic+g3_tmb_upper'></span><span id='topic+g3_tmb_parscale'></span><span id='topic+g3_tmb_relist'></span>

<h3>Description</h3>

<p>Turn g3 actions into CPP code that can be compiled using TMB
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_to_tmb(actions, trace = FALSE, strict = FALSE)

g3_tmb_adfun(cpp_code, parameters = attr(cpp_code, "parameter_template"),
    compile_flags =
        if (.Platform$OS.type == "windows") c("-O1", "-march=native")
        else c("-O3", "-flto", "-march=native"),
    work_dir = tempdir(),
    output_script = FALSE, ...)

g3_tmb_par(parameters, include_random = TRUE)

g3_tmb_lower(parameters)

g3_tmb_upper(parameters)

g3_tmb_parscale(parameters)

g3_tmb_relist(parameters, par)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="run_tmb_+3A_actions">actions</code></td>
<td>

<p>A list of actions (i.e. list of formula objects), as produced by <var>g3a_</var>* functions.
</p>
</td></tr>
<tr><td><code id="run_tmb_+3A_trace">trace</code></td>
<td>

<p>If TRUE, turn all comments into print statements.
</p>
</td></tr>
<tr><td><code id="run_tmb_+3A_strict">strict</code></td>
<td>

<p>If TRUE, enable extra sanity checking in actions. Any invalid conditions
(e.g. more/less fish after growth) will result in a warning.
</p>
</td></tr>
<tr><td><code id="run_tmb_+3A_cpp_code">cpp_code</code></td>
<td>

<p>cpp_code as produced by <var>g3_to_tmb</var>.
</p>
</td></tr>
<tr><td><code id="run_tmb_+3A_parameters">parameters</code></td>
<td>

<p>Parameter table as produced by <code>attr(g3_to_tmb(...), 'parameter_template')</code>,
modified to provide initial conditions, etc.
</p>
</td></tr>
<tr><td><code id="run_tmb_+3A_par">par</code></td>
<td>

<p>Parameter vector, as produced by one of </p>

<ol>
<li><p><code>nlminb(...)$par</code>
</p>
</li>
<li><p><code>obj.fun$env$last.par</code>
</p>
</li>
<li><p><code>g3_tmb_par()</code>
</p>
</li></ol>

<p>The first will not include random parameters by default, the others will.
</p>
</td></tr>
<tr><td><code id="run_tmb_+3A_include_random">include_random</code></td>
<td>

<p>Should random parameters assumed to be part of par? Should be <code>TRUE</code>
if using <code>obj.fun$fn</code>, <code>obj.fun$report</code> directly, e.g.
<code>obj.fun$fn(g3_tmb_par(param_tbl))</code>. In other cases, <code>FALSE</code>.
</p>
</td></tr>
<tr><td><code id="run_tmb_+3A_compile_flags">compile_flags</code></td>
<td>

<p>List of extra flags to compile with, use e.g. &quot;-g&quot; to enable debugging output.
</p>
</td></tr>
<tr><td><code id="run_tmb_+3A_work_dir">work_dir</code></td>
<td>

<p>Directory to write and compile .cpp files in. Defaults to R's current temporary directory
</p>
</td></tr>
<tr><td><code id="run_tmb_+3A_output_script">output_script</code></td>
<td>

<p>If <code>TRUE</code>, create a temporary R script that runs <a href="TMB.html#topic+MakeADFun">MakeADFun</a>, and return the location.
This can then be directly used with <a href="TMB.html#topic+gdbsource">gdbsource</a> or <code>callr::rscript</code>.
</p>
</td></tr>
<tr><td><code id="run_tmb_+3A_...">...</code></td>
<td>

<p>Any other options handed directly to <a href="TMB.html#topic+MakeADFun">MakeADFun</a>
</p>
</td></tr>
</table>


<h3>Details</h3>



<h4>g3_tmb_adfun</h4>

<p><code><a href="#topic+g3_tmb_adfun">g3_tmb_adfun</a></code> will do both the <a href="TMB.html#topic+compile">compile</a> and <a href="TMB.html#topic+MakeADFun">MakeADFun</a>
steps of making a model. If the code is identical to an already-loaded model then it
won't be recompiled, so repeated calls to <a href="#topic+g3_tmb_adfun">g3_tmb_adfun</a> to change <var>parameters</var> are fast.
</p>
<p>If <a href="TMB.html#topic+MakeADFun">MakeADFun</a> is crashing your R session, then you can use <var>output_script</var> to run
in a separate R session. Use this with <a href="TMB.html#topic+gdbsource">gdbsource</a> to debug your model.
</p>



<h3>Value</h3>



<h4>g3_to_tmb</h4>

<p>A string of C++ code that can be used as an input to <var>g3_tmb_adfun</var>, with the following attributes:
</p>

<dl>
<dt>actions</dt><dd><p>The original <var>actions</var> list given to the function</p>
</dd>
<dt>model_data</dt><dd><p>An environment containing data attached to the model</p>
</dd>
<dt>parameter_template</dt><dd><p>A data.frame to be filled in and used as <var>parameters</var> in the other <code>g3_tmb_*</code> functions</p>
</dd>
</dl>

<p>Use e.g. <code>attr(cpp_code, 'parameter_template')</code> to retrieve them.
</p>



<h4>g3_tmb_adfun</h4>

<p>An ADFun as produced by TMB's <a href="TMB.html#topic+MakeADFun">MakeADFun</a>, or location of temporary script if <var>output_script</var> is TRUE</p>



<h4>g3_tmb_par</h4>

<p>Values extracted from <var>parameters</var> table converted into a vector of values for <code>obj$fn(par)</code> or <code>nlminb</code></p>



<h4>g3_tmb_lower</h4>

<p>Lower bounds extracted from <var>parameters</var> table converted into a vector of values for <code>nlminb</code>. Random parameters are always excluded</p>



<h4>g3_tmb_upper</h4>

<p>Lower bounds extracted from <var>parameters</var> table converted into a vector of values for <code>nlminb</code>. Random parameters are always excluded</p>



<h4>g3_tmb_parscale</h4>

<p>Parscale extracted from <var>parameters</var> table, converted into a vector of values for <code>nlminb</code>. Random parameters are always excluded</p>



<h4>g3_tmb_relist</h4>

<p>The <var>parameters</var> table value column, but with optimised
values replaced with contents of <var>par</var> vector.
i.e. the inverse operation to <a href="#topic+g3_tmb_par">g3_tmb_par</a>.
<var>par</var> can either include or discount random variables.
</p>



<h3>Examples</h3>

<pre><code class='language-R'>
ling_imm &lt;- g3_stock(c(species = 'ling', 'imm'), seq(20, 156, 4)) %&gt;% g3s_age(3, 10)

initialconditions_action &lt;- g3a_initialconditions_normalparam(
    ling_imm,
    factor_f = g3a_renewal_initabund(by_stock_f = 'species'),
    by_stock = 'species',
    by_age = TRUE)

abundance_action &lt;- g3l_abundancedistribution(
    'abundance',
    data.frame(year = 2000:2004, number = 100),
    stocks = list(ling_imm),
    function_f = g3l_distribution_sumofsquares())

# Timekeeping action
time_action &lt;- g3a_time(
    start_year = 2000,
    end_year = 2004,
    c(3, 3, 3, 3))

# Generate a model from the above 2 actions
# NB: Obviously in reality we'd need more actions
cpp &lt;- g3_to_tmb(list(initialconditions_action, abundance_action, time_action))

if (interactive()) {
  # Edit the resulting code
  cpp &lt;- edit(cpp)
}

# Set initial conditions for parameters
tmb_param &lt;- attr(cpp, 'parameter_template')
tmb_param$value$project_years &lt;- 0
tmb_param$value$ling.init.F &lt;- 0.4
tmb_param$value$ling.Linf &lt;- 160
tmb_param$value$ling.K &lt;- 90
tmb_param$value$ling.t0 &lt;- 0
tmb_param[grepl('^ling.init.sd.', rownames(tmb_param)), 'value'] &lt;- 50.527220
tmb_param[grepl('^ling_imm.init.\\d+', rownames(tmb_param)), 'value'] &lt;- 1
tmb_param$value$ling_imm.init.scalar &lt;- 200
tmb_param$value$ling_imm.walpha &lt;- 2.27567436711055e-06
tmb_param$value$ling_imm.wbeta &lt;- 3.20200445996187
tmb_param[grepl('\\.M$', rownames(tmb_param)), 'value'] &lt;- 0.15

# We can set lower/upper bounds for multiple properties at once with grepl()
tmb_param[grepl('.', rownames(tmb_param)), 'lower'] &lt;- -1000
tmb_param[grepl('.', rownames(tmb_param)), 'upper'] &lt;- 1000

# parscale gives optim() a relative scale of parameters
tmb_param['parscale'] &lt;- 1




if (!( nzchar(Sys.getenv('GITHUB_CI')) &amp;&amp; .Platform$OS.type == "windows" )) {
  # Compile to a TMB ADFun
  tmb &lt;- g3_tmb_adfun(cpp, tmb_param)
}

# NB: TMB::gdbsource() requires both "R" and "gdb" to be available
# NB: gdbsource hangs on windows - https://github.com/kaskr/adcomp/issues/385
if (all(nzchar(Sys.which(c('gdb', 'R')))) &amp;&amp; .Platform$OS.type !="windows") {

  cpp_broken &lt;- g3_to_tmb(list(
    initialconditions_action,
    abundance_action,
    g3_formula(quote( stop("This model is broken") )),
    time_action))

  # Build the model in an isolated R session w/debugger
  writeLines(TMB::gdbsource(g3_tmb_adfun(
      cpp_broken,
      compile_flags = "-g",
      output_script = TRUE)))

}

if (!( nzchar(Sys.getenv('GITHUB_CI')) &amp;&amp; .Platform$OS.type == "windows" )) {
  # Perform a single run, using values in table
  result &lt;- tmb$fn(g3_tmb_par(tmb_param))
}

if (!( nzchar(Sys.getenv('GITHUB_CI')) &amp;&amp; .Platform$OS.type == "windows" )) {
  # perform optimisation using upper/lower/parscale from table
  fit &lt;- optim(tmb$par, tmb$fn, tmb$gr,
      method = "L-BFGS-B",
      upper = g3_tmb_upper(tmb_param),
      lower = g3_tmb_lower(tmb_param),
      control = list(maxit=10, parscale=g3_tmb_parscale(tmb_param)))
}

if (!( nzchar(Sys.getenv('GITHUB_CI')) &amp;&amp; .Platform$OS.type == "windows" )) {
  # perform optimisation without bounds
  fit &lt;- optim(tmb$par, tmb$fn, tmb$gr)
}

if (!( nzchar(Sys.getenv('GITHUB_CI')) &amp;&amp; .Platform$OS.type == "windows" )) {
  # Go back to a list of parameters, suitable for the R version
  # NB: This will not set the values for random parameters
  param_list &lt;- g3_tmb_relist(tmb_param, fit$par)
}

if (!( nzchar(Sys.getenv('GITHUB_CI')) &amp;&amp; .Platform$OS.type == "windows" )) {
  # Update parameters with values from last run, *including* random parameters.
  param_list &lt;- g3_tmb_relist(tmb_param, tmb$env$last.par)
}

if (!( nzchar(Sys.getenv('GITHUB_CI')) &amp;&amp; .Platform$OS.type == "windows" )) {
  # Rebuild, only including "Fun" (i.e. without auto-differentiation)
  # Result will only work for tmb$report
  tmb &lt;- g3_tmb_adfun(cpp, tmb_param, type = "Fun")
  result &lt;- tmb$report(g3_tmb_par(tmb_param))
}


</code></pre>

<hr>
<h2 id='step'>G3 stock_* transformation functions</h2><span id='topic+g3_step'></span><span id='topic+debug_label'></span><span id='topic+debug_trace'></span><span id='topic+stock_assert'></span><span id='topic+stock_ss'></span><span id='topic+stock_ssinv'></span><span id='topic+stock_switch'></span><span id='topic+stock_with'></span><span id='topic+stock_iterate'></span><span id='topic+stock_intersect'></span><span id='topic+stock_interact'></span><span id='topic+stock_prepend'></span>

<h3>Description</h3>

<p>Additional meta-functions to help manage writing stock-handling actions.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_step(step_f, recursing = FALSE, orig_env = environment(step_f))
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="step_+3A_step_f">step_f</code></td>
<td>
<p>Input <a href="stats.html#topic+formula">formula</a> containing references to functions below</p>
</td></tr>
<tr><td><code id="step_+3A_recursing">recursing</code></td>
<td>
<p>Only use default value</p>
</td></tr>
<tr><td><code id="step_+3A_orig_env">orig_env</code></td>
<td>
<p>Only use default value</p>
</td></tr>
</table>


<h3>Details</h3>

<p>All action producing functions will run their output through <code>g3_step</code>.
This means that the functions described here will be available in any gadget3
code.
</p>
<p>They handle translation of stock instance naming, so code can refer to e.g.
<code>stock__num</code> without having to translate naming to the final stock name,
and iterating over stock dimensions.
</p>


<h3>Value</h3>



<h4>g3_step</h4>

<p>A <a href="stats.html#topic+formula">formula</a> object with references to above functions replaced.
</p>



<h3>debug_label</h3>

<p>Add a comment to the code to act as a label for that step, when producing an
outline of the model. There shouldn't be more than one <code>debug_label</code>
call in a step.
</p>
<p>Models compiled with <code>trace = TRUE</code> will print the resultant string to stdout.
</p>


<h4>Arguments</h4>

<p>Any number of character strings, or <a href="#topic+g3_stock">g3_stock</a> variables. The latter
will be replaced with the final name.
</p>



<h3>debug_trace</h3>

<p>Identical to <a href="#topic+debug_label">debug_label</a>, but not considered a &quot;label&quot;, just a code
comment, so any number of calls can be added.
</p>


<h3>stock_assert</h3>

<p><code>stock_assert(expression, message, message/stock-var, ...)</code>
</p>
<p>Assert that <var>expression</var> is true, if not abort with a message.
</p>


<h3>stock_reshape</h3>

<p><code>stock_reshape(dest_stock, expression)</code>
</p>
<p>Output <var>expression</var> with it's length structure reshaped to match
<var>dest_stock</var>. The source stock is considered to be the first one
found in <var>expression</var>
</p>
<p>How this is achieved depends on the difference. If the source and
destination match then this is a no-op. Otherwise a transformation
matrix is generated and included into the model.
</p>


<h3>stock_ss</h3>

<p><code>stock_ss(stock_var, [ dimname = override, dimname = override, ... ])</code>
</p>
<p>Subsets <var>stock_var</var> to get a length vector for the current iteration
of <a href="#topic+stock_iterate">stock_iterate</a>(). If <var>dimname</var>s are supplied, then these
dimensions overwritten with the suppled override, which could be a missing
value, to preserve a dimension. See final example.
</p>
<p>Length is a missing value by default, i.e. we return length groups. To avoid
this happening, set <code>length = default</code> to iterate over length too.
</p>


<h3>stock_ssinv</h3>

<p><code>stock_ssinv(stock_var, [ dimname, dimname, ... ])</code>
</p>
<p>like <a href="#topic+stock_ss">stock_ss</a>(), but subset only the mentioned <var>dimname</var>s.
</p>


<h3>stock_switch</h3>

<p><code>stock_ss(stock, stock_name1 = expr, stock_name2 = expr, ... [ default ])</code>
</p>
<p>Switch based on name of <var>stock</var>, returning the relevant <var>expr</var> or
<var>default</var>. If no default supplied, then an unknown stock is an error.
</p>
<p><var>expr</var> is implicitly wrapped with <code><a href="#topic+stock_with">stock_with</a>(stock, ...)</code>,
so any references to the stock variable will work. If only default is provided,
then this is identical to calling <code><a href="#topic+stock_with">stock_with</a></code>.
</p>


<h3>stock_with</h3>

<p><code>stock_with(stock, expr)</code>
</p>
<p>Replaced with <var>expr</var> but with all stock variables of <var>stock</var> renamed
with their final name. This is generally needed when not iterating over a
stock, but e.g. zeroing or summing the whole thing.
</p>


<h3>stock_iterate</h3>

<p><code>stock_iterate(stock, expr)</code>
</p>
<p>Wrap <var>expr</var> with the code to iterate over vector dimensions in
<var>stock</var>, accessed using <code>stock_ss(stock)</code>.
</p>
<p>Which dimensions are iterated over is decided based on the call to
<code>stock_ss(stock)</code>. By default, stock_ss leaves length blank so will
iterate over a length vector for each dimension.
</p>
<p>You can iterate over each value individually with the following:
<code>stock_iterate(stock, stock_ss(stock, length = default) )</code>
</p>
<p>Current values for each dimension will be available as variables,
e.g. <code>area</code>, <code>age</code>, and can be used in formulae.
</p>


<h3>stock_intersect</h3>

<p><code>stock_intersect(stock, expr)</code>
</p>
<p>Wrap <var>expr</var> with the code to intersect all dimensions with
the dimensions of an outer <a href="#topic+stock_iterate">stock_iterate</a>().
</p>


<h3>stock_interact</h3>

<p><code>stock_interact(stock, expr, prefix = prefix)</code>
</p>
<p>Wrap <var>expr</var> with the code to interact with the dimensions of an outer
<a href="#topic+stock_iterate">stock_iterate</a>(). Interact means to intersect over area, but try the
combinatoral explosion of all other dimensions, i.e. what would make most
sense when 2 stocks interact in a predator-prey relationship.
</p>
<p>Additional variables will be prefixed with <var>prefix</var>.
</p>


<h3>stock_prepend</h3>

<p><code>stock_prepend(stock, param_call, name_part = NULL)</code>
</p>
<p>Converts a <a href="#topic+g3_param">g3_param</a> or <a href="#topic+g3_param_table">g3_param_table</a> call, prefixing the
parameter name with the stock name, and renaming any references to stock variables.
If <var>name_part</var> given, will only add given part(s) of the stock name.
</p>
<p>Returns <var>param_call</var> with the additions made.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
### debug_label
stock &lt;- g3_stock('halibut', 1:10) %&gt;% g3s_age(1,10)
prey_stock &lt;- g3_stock('herring', 1:3) %&gt;% g3s_age(1,3)
g3_step(~debug_trace("Zero ", stock, "-", prey_stock, " biomass-consuming counter"))

### stock_assert
stock &lt;- g3_stock('halibut', 1:10) %&gt;% g3s_age(1,10)
g3_step(~stock_assert(stock_with(stock, all(is.finite(stock__num))), stock, "__num became NaN/Inf"))

### stock_reshape
s &lt;- g3_stock('s', seq(3, 21, 3))
s__num &lt;- g3_stock_instance(s, 100)
agg &lt;- g3_stock('agg', c(3, 10, 21), open_ended = FALSE)
g3_eval(~stock_iterate(s, stock_reshape(agg, stock_ss(s__num))))

### stock_ss
stock &lt;- g3_stock('halibut', 1:10) %&gt;% g3s_age(1,10) %&gt;% g3s_livesonareas(1)
stock__num &lt;- g3_stock_instance(stock)
g3_step(~stock_iterate(stock, { x &lt;- x + stock_ss(stock__num) }))
g3_step(~stock_ss(stock__num, area = 5))
g3_step(~stock_ss(stock__num, age = i + 1))
g3_step(~stock_ss(stock__num, area = , age = j))

### stock_ssinv
stock &lt;- g3_stock('halibut', 1:10) %&gt;% g3s_age(1,10) %&gt;% g3s_livesonareas(1)
g3_step(~g3_step(~stock_ssinv(stock, 'age')))
g3_step(~g3_step(~stock_ssinv(stock, 'area')))

### stock_switch
stock &lt;- g3_stock('halibut', 1:10) ; fleet_stock &lt;- g3_fleet('igfs')
g3_step(~stock_switch(stock, halibut = 2, herring = 3, -1))
g3_step(~stock_switch(fleet_stock, halibut = 2, herring = 3, -1))
g3_step(~stock_switch(stock, halibut = stock__midlen, -1))

### stock_with
stock &lt;- g3_stock('halibut', 1:10)
g3_step(~stock_with(stock, sum(stock__num)))

### stock_iterate
stock &lt;- g3_stock('halibut', 1:10) %&gt;% g3s_age(1,10)
g3_step(~stock_iterate(stock, x &lt;- x + stock_ss(stock__num)))

### stock_intersect
stock &lt;- g3_stock('halibut', 1:10) %&gt;% g3s_age(1,10)
prey_stock &lt;- g3_stock('herring', 1:3) %&gt;% g3s_age(1,3)
g3_step(~stock_iterate(stock, stock_intersect(prey_stock, {
  x &lt;- x + stock_ss(stock__num) + stock_ss(prey_stock__num)
})))

### stock_interact
stock &lt;- g3_stock('halibut', 1:10) %&gt;% g3s_age(1,10)
prey_stock &lt;- g3_stock('herring', 1:3) %&gt;% g3s_age(1,3)
g3_step(~stock_iterate(stock, stock_interact(prey_stock, {
  x &lt;- x + stock_ss(stock__num) + stock_ss(prey_stock__num)
}, prefix = "prey" )))
</code></pre>

<hr>
<h2 id='stock'>Gadget3 stock storage</h2><span id='topic+g3_stock_def'></span><span id='topic+g3_stock_instance'></span><span id='topic+g3_stock'></span><span id='topic+g3_fleet'></span><span id='topic+g3s_clone'></span><span id='topic+g3_is_stock'></span>

<h3>Description</h3>

<p>Define multi-dimensional storage for use in models, mostly to contain state
about stocks.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_stock(var_name, lengthgroups, open_ended = TRUE)

g3_stock_instance(stock, init_value = NA, desc = "")

g3_fleet(var_name)

g3_stock_def(stock, name)

g3s_clone(inner_stock, var_name)

g3_is_stock(stock)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="stock_+3A_var_name">var_name</code></td>
<td>

<p>Prefix used for all instance variables of this stock. Can have multiple
parts that will be concatentated together, see example.
</p>
</td></tr>
<tr><td><code id="stock_+3A_lengthgroups">lengthgroups</code></td>
<td>

<p>Vector defining length groups, each entry defining the minimum value.
</p>
</td></tr>
<tr><td><code id="stock_+3A_open_ended">open_ended</code></td>
<td>

<p>If TRUE, final <var>lengthgroups</var> value defines a group <code>x:Inf</code>.
If FALSE, final <var>lengthgroups</var> value is the upper bound for the previous group.
</p>
</td></tr>
<tr><td><code id="stock_+3A_inner_stock">inner_stock</code></td>
<td>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> or <code><a href="#topic+g3_fleet">g3_fleet</a></code> object to clone.
</p>
</td></tr>
<tr><td><code id="stock_+3A_stock">stock</code></td>
<td>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> or <code><a href="#topic+g3_fleet">g3_fleet</a></code>.
</p>
</td></tr>
<tr><td><code id="stock_+3A_init_value">init_value</code></td>
<td>

<p>Intially the array will be filled with this constant, e.g. <code>1</code>, <code>0</code> or <code>NaN</code>
</p>
</td></tr>
<tr><td><code id="stock_+3A_desc">desc</code></td>
<td>

<p>Description of the array that will be included in models
</p>
</td></tr>
<tr><td><code id="stock_+3A_name">name</code></td>
<td>

<p>Name of definition to extract, e.g. <code>"minlen"</code>.
</p>
</td></tr>
</table>


<h3>Value</h3>



<h4>g3_stock</h4>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> with length groups
</p>



<h4>g3_stock_instance</h4>

<p>An array with dimensions matching the stock.
</p>



<h4>g3_fleet</h4>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> without length groups
</p>



<h4>g3s_clone</h4>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> with identical dimensions to <var>inner_stock</var> but with a new name.
</p>



<h4>g3_is_stock</h4>

<p><code>TRUE</code> iff <var>stock</var> is a <code><a href="#topic+g3_stock">g3_stock</a></code> object.
</p>



<h3>Examples</h3>

<pre><code class='language-R'>

# Define a stock with 3 lengthgroups
stock &lt;- g3_stock('name', c(1, 10, 100))

# Define a stock with a multi-part name. We can then dig out species name
stock &lt;- g3_stock(c(species = 'ling', 'imm'), c(1, 10, 100))
stopifnot( stock$name == 'ling_imm' )
stopifnot( stock$name_parts[['species']] == 'ling' )

# Use stock_instance define storage for mean weight of stock,
# has dimensions matching what was defined above.
g3_stock_instance(stock, 1, "Mean weight")

# Retrieve the upperlen for the stock
g3_stock_def(stock, 'upperlen')

# Define a stock, not-open-ended. Now only 2 groups long
stock &lt;- g3_stock('name', c(1, 10, 100), open_ended = FALSE)

# Use stock_instance to see what the array would look like
g3_stock_instance(stock)

# Fleets don't have lengthgroups
stock &lt;- g3_fleet('name') %&gt;% g3s_livesonareas(1)

# Use stock_instance to see what the array would look like
g3_stock_instance(stock)
</code></pre>

<hr>
<h2 id='stock_age'>Gadget3 stock age dimensions</h2><span id='topic+g3s_age'></span><span id='topic+g3s_agegroup'></span>

<h3>Description</h3>

<p>Add age dimensions to g3_stock classes
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3s_age(inner_stock, minage, maxage)

g3s_agegroup(inner_stock, agegroups)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="stock_age_+3A_inner_stock">inner_stock</code></td>
<td>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> that we extend with an age dimension
</p>
</td></tr>
<tr><td><code id="stock_age_+3A_minage">minage</code></td>
<td>

<p>Minimum age to store, integer.
</p>
</td></tr>
<tr><td><code id="stock_age_+3A_maxage">maxage</code></td>
<td>

<p>Maximum age to store, integer.
</p>
</td></tr>
<tr><td><code id="stock_age_+3A_agegroups">agegroups</code></td>
<td>

<p>(optionally named) list of vectors of ages, grouping them together.
</p>
</td></tr>
</table>


<h3>Value</h3>



<h4>g3s_age</h4>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> with an additional 'age' dimension.
</p>
<p>When iterating over the stock, iterate over each age in turn,
<var>age</var> will be set to the current integer age.
</p>
<p>When intersecting with another stock, only do anything if
<var>age</var> is betweem <var>minage</var> and <var>maxage</var>.
</p>
<p>If an age dimension already exists, it is redefined with new
parameters.
</p>



<h4>g3s_agegroup</h4>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> with an additional 'age' dimension.
</p>
<p>When iterating over the stock, iterate over each agegroup in turn,
<var>age</var> will be set to the first age in the group.
</p>
<p>When intersecting with another stock, only do anything if
<var>age</var> is part of one of the groups.
</p>



<h3>Examples</h3>

<pre><code class='language-R'>

# Define a stock with 3 lengthgroups and 3 ages
stock &lt;- g3_stock('name', c(1, 10, 100)) %&gt;%
    g3s_age(5, 10)

# Use stock_instance to see what the array would look like
g3_stock_instance(stock)

# Define a stock that groups age into "young" and "old"
stock &lt;- g3_stock('name', c(1, 10, 100)) %&gt;%
    g3s_agegroup(list(
        young = 5:7,
        old = 8:10))

# Use stock_instance to see what the array would look like
g3_stock_instance(stock)
</code></pre>

<hr>
<h2 id='stock_areas'>Gadget3 stock area dimensions</h2><span id='topic+g3_areas'></span><span id='topic+g3s_livesonareas'></span><span id='topic+g3s_areagroup'></span>

<h3>Description</h3>

<p>Add area dimensions to g3_stock classes
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_areas(area_names)

g3s_livesonareas(inner_stock, areas)

g3s_areagroup(inner_stock, areagroups)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="stock_areas_+3A_area_names">area_names</code></td>
<td>

<p>A character vector of area names to use in the model
</p>
</td></tr>
<tr><td><code id="stock_areas_+3A_inner_stock">inner_stock</code></td>
<td>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> that we extend with an area dimension
</p>
</td></tr>
<tr><td><code id="stock_areas_+3A_areas">areas</code></td>
<td>

<p>A vector of numeric areas that the stock is part of
</p>
</td></tr>
<tr><td><code id="stock_areas_+3A_areagroups">areagroups</code></td>
<td>

<p>A list mapping names to vectors of numeric areas the stock is part of
</p>
</td></tr>
</table>


<h3>Details</h3>

<p><code>g3s_livesonareas</code> breaks up a stock by area.
Within a model, areas are only referred to by integer, however if these are named
then that name will be used for report output.
</p>
<p>Each area will be defined as a variable in your model as <code>area_x</code>,
allowing you to use names in formulas, e.g. <code>run_f = quote( area == area_x )</code>.
</p>
<p><code>g3_areas</code> is a helper to map a set of names to an integer
</p>
<p>Inside a model each area will only be referred to by integer.
</p>
<p><code>g3s_areagroup</code> allows areas to be combined, this is mostly used internally
by <code><a href="#topic+g3l_catchdistribution">g3l_catchdistribution</a></code>.
</p>


<h3>Value</h3>



<h4>g3_areas</h4>

<p>A named integer vector, assigning each of <var>area_names</var> a number.
</p>



<h4>g3s_livesonareas</h4>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> with an additional 'area' dimension.
</p>
<p>When iterating over the stock, iterate over each area in turn,
<var>area</var> will be set to the current integer area.
</p>
<p>When intersecting with another stock, only do anything if
<var>area</var> is also part of our list of areas.
</p>



<h4>g3s_areagroup</h4>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> with an additional 'area' dimension.
</p>
<p>When iterating over the stock, iterate over each areagroup in turn,
<var>area</var> will be set to the first area in the group.
</p>
<p>When intersecting with another stock, only do anything if
<var>area</var> is part of one of the groups.
</p>



<h3>Examples</h3>

<pre><code class='language-R'>

# Make a lookup so we can refer to areas by name
area_names &lt;- g3_areas(c('a', 'b', 'c', 'd', 'e'))
stopifnot(area_names == c(a=1, b=2, c=3, d=4, e=5))

# Define a stock with 3 lengthgroups and 3 areas
stock &lt;- g3_stock('name', c(1, 10, 100)) %&gt;%
    g3s_livesonareas(area_names[c('a', 'b', 'c')])

# Area variables will be defined, so you can refer to them in formulas:
g3a_migrate(stock, g3_parameterized("migrate_spring"),
    run_f = ~area == area_b &amp;&amp; cur_step == 2)

# Use stock_instance to see what the array would look like
g3_stock_instance(stock)

# Define a stock that groups areas into "north" and "south"
stock &lt;- g3_stock('name', c(1, 10, 100)) %&gt;%
    g3s_areagroup(list(
        north = area_names[c('a', 'b', 'c')],
        south = area_names[c('d', 'e')]))

# Use stock_instance to see what the array would look like
g3_stock_instance(stock)
</code></pre>

<hr>
<h2 id='stock_tag'>Gadget3 tag dimension</h2><span id='topic+g3s_tag'></span>

<h3>Description</h3>

<p>Add tag dimensions to g3_stock classes
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3s_tag(inner_stock, tag_ids, force_untagged = TRUE)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="stock_tag_+3A_inner_stock">inner_stock</code></td>
<td>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> that we extend with an area dimension
</p>
</td></tr>
<tr><td><code id="stock_tag_+3A_tag_ids">tag_ids</code></td>
<td>

<p>A vector of numeric tags the stock can have, generated by <code>seq_along</code>, e.g.
Tag ID 0 is considered to be &quot;untagged&quot;.
</p>
</td></tr>
<tr><td><code id="stock_tag_+3A_force_untagged">force_untagged</code></td>
<td>

<p>If TRUE, if &quot;untagged&quot; tag 0 isn't present it will be added.
</p>
</td></tr>
</table>


<h3>Value</h3>



<h4>g3s_tag</h4>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> with an additional 'tag' dimension.
</p>
<p>When iterating over the stock, iterate over each tag in turn,
<var>tag</var> will be set to the current integer area.
</p>
<p>When interacting with another stock, iterate over each tag in turn,
the variable name will depend on the scenario, e.g. <var>prey_tag</var>.
</p>



<h3>Examples</h3>

<pre><code class='language-R'>

# Make a lookup of text names to integers
tags &lt;- c('H1-00', 'H1-01')
tags &lt;- structure(seq_along(tags), names = tags)

# prey_a can have any of these tags
prey_a &lt;- g3_stock('prey_a', seq(1, 10)) %&gt;% g3s_tag(tags)

# Use stock_instance to see what the array would look like
g3_stock_instance(prey_a)
</code></pre>

<hr>
<h2 id='stock_time'>Gadget3 stock time dimensions</h2><span id='topic+g3s_time_convert'></span><span id='topic+g3s_time'></span>

<h3>Description</h3>

<p>Add time dimensions to g3_stock classes
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3s_time_convert(year_or_time, step = NULL)

g3s_time(inner_stock, times, year = NULL, step = NULL)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="stock_time_+3A_year_or_time">year_or_time</code></td>
<td>

<p>Etiher vector of years, or vector of year &amp; step strings, e.g. &quot;1999-01&quot;.
</p>
</td></tr>
<tr><td><code id="stock_time_+3A_year">year</code></td>
<td>

<p>Vector of years, used to generate <var>times</var> if provided.
</p>
</td></tr>
<tr><td><code id="stock_time_+3A_step">step</code></td>
<td>

<p>Vector of steps, used to generate <var>times</var> if provided.
</p>
</td></tr>
<tr><td><code id="stock_time_+3A_inner_stock">inner_stock</code></td>
<td>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> that we extend with a time dimension
</p>
</td></tr>
<tr><td><code id="stock_time_+3A_times">times</code></td>
<td>

<p>A vector of year/step integers as generated by <var>g3s_time_convert</var>
</p>
</td></tr>
</table>


<h3>Value</h3>



<h4>g3s_time_convert</h4>

<p>A single integer vector representing <var>year</var> and <var>step</var>.
</p>
<p>If <var>step</var> is <code>NULL</code>, returns <var>year</var>, otherwise <code><var>year</var> * 1000 + <var>step</var></code>.
</p>



<h4>g3s_time</h4>

<p>A <code><a href="#topic+g3_stock">g3_stock</a></code> with an additional 'time' dimension.
</p>
<p>If <var>year</var>/<var>step</var> provided, time is defined by those, otherwise <var>times</var>.
</p>
<p>The <code><a href="#topic+g3_stock">g3_stock</a></code> will not support iterating,
only intersecting.
</p>
<p>When intersecting with another stock, only do anything if
<var>cur_year</var> and <var>cur_step</var> matches a time stored in the vector
</p>



<h3>Examples</h3>

<pre><code class='language-R'>

# Define a stock with 3 lengthgroups and 3 years, not continuous
# When used, all steps within a year will be aggregated, year 2002 will be ignored.
stock &lt;- g3_stock('name', c(1, 10, 100)) %&gt;%
    g3s_time(year = c(2000, 2001, 2003))

# Use stock_instance to see what the array would look like
g3_stock_instance(stock)

# Define a stock with 3 lengthgroups and 3 years, 2 steps
# The dimension will have 6 entries, 2000.1, 2000.2, 2001.1, 2001.2, 2002.1, 2002.2
stock &lt;- g3_stock('name', c(1, 10, 100)) %&gt;%
    g3s_time(year = c(2000, 2001, 2002), step = 1:2)

# Use stock_instance to see what the array would look like
g3_stock_instance(stock)

# g3s_time_convert is best used with a data.frame
data &lt;- read.table(header = TRUE, text = '
year step
2001 1
2001 2
# NB: No "2002 1"
2002 2
')
stock &lt;- g3_stock('name', c(1, 10, 100)) %&gt;%
    g3s_time(times = g3s_time_convert(data$year, data$step))

# Will also parse strings
g3s_time_convert(c("1999-01", "1999-02"))

# Use stock_instance to see what the array would look like
g3_stock_instance(stock)
</code></pre>

<hr>
<h2 id='suitability'>Gadget3 suitability formulae</h2><span id='topic+g3_suitability_+2A'></span><span id='topic+g3_suitability_exponentiall50'></span><span id='topic+g3_suitability_andersen'></span><span id='topic+g3_suitability_andersenfleet'></span><span id='topic+g3_suitability_gamma'></span><span id='topic+g3_suitability_exponential'></span><span id='topic+g3_suitability_straightline'></span><span id='topic+g3_suitability_constant'></span><span id='topic+g3_suitability_richards'></span>

<h3>Description</h3>

<p>Formula-returning functions describing length suitability relationships.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_suitability_exponentiall50(
    alpha = g3_parameterized("alpha", by_stock = by_stock, by_predator = by_predator),
    l50 = g3_parameterized("l50", by_stock = by_stock, by_predator = by_predator),
    by_stock = TRUE,
    by_predator = TRUE)

g3_suitability_andersen(p0, p1, p2, p3 = p4, p4, p5 = ~predstock__midlen)

g3_suitability_andersenfleet(
        p0 = g3_parameterized('andersen.p0', value = 0, optimise = FALSE,
                              by_stock = by_stock),
        p1 = g3_parameterized('andersen.p1', value = log(2),
                              by_stock = by_stock, by_predator = by_predator),
        p2 = g3_parameterized('andersen.p2', value = 1, optimise = FALSE,
                              by_stock = by_stock),
        p3 = g3_parameterized('andersen.p3', value = 0.1, exponentiate = exponentiate,
                              by_stock = by_stock, by_predator = by_predator),
        p4 = g3_parameterized('andersen.p4', value = 0.1, exponentiate = exponentiate,
                              by_stock = by_stock, by_predator = by_predator),
        p5 = quote( stock__maxmidlen ),
        by_stock = TRUE,
        by_predator = TRUE,
        exponentiate = TRUE)

g3_suitability_gamma(alpha, beta, gamma)

g3_suitability_exponential(alpha, beta, gamma, delta)

g3_suitability_straightline(alpha, beta)

g3_suitability_constant(alpha)

g3_suitability_richards(p0, p1, p2, p3, p4)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="suitability_+3A_alpha">alpha</code>, <code id="suitability_+3A_beta">beta</code>, <code id="suitability_+3A_gamma">gamma</code>, <code id="suitability_+3A_delta">delta</code>, <code id="suitability_+3A_l50">l50</code>, <code id="suitability_+3A_p0">p0</code>, <code id="suitability_+3A_p1">p1</code>, <code id="suitability_+3A_p2">p2</code>, <code id="suitability_+3A_p3">p3</code>, <code id="suitability_+3A_p4">p4</code>, <code id="suitability_+3A_p5">p5</code></td>
<td>

<p><a href="stats.html#topic+formula">formula</a> substituted into calcuations, see below.
</p>
</td></tr>
<tr><td><code id="suitability_+3A_by_stock">by_stock</code></td>
<td>

<p>Change the default parameterisation (e.g. to be by 'species'), passed through to default calls to
<code><a href="#topic+g3_parameterized">g3_parameterized</a></code>.
</p>
</td></tr>
<tr><td><code id="suitability_+3A_by_predator">by_predator</code></td>
<td>

<p>Change the default parameterisation (e.g. to be by 'fleet'), passed through to default calls to
<code><a href="#topic+g3_parameterized">g3_parameterized</a></code>.
</p>
</td></tr>
<tr><td><code id="suitability_+3A_exponentiate">exponentiate</code></td>
<td>

<p>Exponentiate parameters,passed through to default calls to
<code><a href="#topic+g3_parameterized">g3_parameterized</a></code>.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>When using these to describe a predator/prey relationship, the stock midlength <code class="reqn">l</code>
will refer to the prey midlength.
</p>


<h3>Value</h3>

<p>All functions return a <a href="stats.html#topic+formula">formula</a> for use in <code><a href="#topic+g3a_predate_fleet">g3a_predate_fleet</a></code>'s <var>suitabilities</var> argument:
</p>


<h4>g3_suitability_exponentiall50</h4>

<p>A logarithmic dependence on the length of the prey as given by the following equation
(note that the prey length dependence is actually dependant on the difference between the length of the prey and <code class="reqn">l_{50}</code>):
</p>
<p style="text-align: center;"><code class="reqn">
      \frac{1}{ 1 + e^{-\alpha (l - l_{50})} }
    </code>
</p>


<dl>
<dt><code class="reqn">l</code></dt><dd><p>Vector of stock midlength for each lengthgroup</p>
</dd>
<dt><code class="reqn">l_{50}</code></dt><dd><p>Length of the stock with a 50% probability of predation, from parameter <var>l50</var></p>
</dd>
</dl>




<h4>g3_suitability_andersen</h4>

<p>This is a more general suitability function that is dependant on the ratio of the predator length to the prey length as given by the following equation:
</p>
<p>If <code class="reqn">p_3 = p_4</code>:
</p>
<p style="text-align: center;"><code class="reqn">
      p_0 + p_2 e^{-\frac{(x - p_1)^2}{p_4}}
    </code>
</p>

<p>Otherwise:
</p>
<p style="text-align: center;"><code class="reqn">
      p_0
      + p_2 e^{-\frac{(x - p_1)^2}{p_4}} * \min(\max(p_1 - x, 0), 1)
      + p_2 e^{-\frac{(x - p_1)^2}{p_3}} * \min(\max(x, 0), 1)
    </code>
</p>

<p>...i.e if <code class="reqn">\log\frac{L}{l} &lt;= p_1</code> then <code class="reqn">p_3</code> used in place of <code class="reqn">p_4</code>.
</p>

<dl>
<dt><code class="reqn">x</code></dt><dd><p><code class="reqn">\log\frac{p_5}{l}</code></p>
</dd>
<dt><code class="reqn">L</code></dt><dd><p>Vector of predator midlength for each lengthgroup</p>
</dd>
<dt><code class="reqn">l</code></dt><dd><p>Vector of stock midlength for each lengthgroup</p>
</dd>
<dt><code class="reqn">p_0</code> .. <code class="reqn">p_4</code></dt><dd><p>Function parameter <var>p0</var> .. <var>p4</var></p>
</dd>
<dt><code class="reqn">p_5</code></dt><dd><p>Function parameter <var>p5</var>, if unspecified uses <code class="reqn">L</code>, Vector of predator midlength for each lengthgroup.</p>
</dd>
</dl>

<p>NB: Specifying <code class="reqn">p_5</code> is equivalent to using the <code>andersenfleet</code> function in gadget2.
</p>



<h4>g3_suitability_andersenfleet</h4>

<p>A simplified version of <code><a href="#topic+g3_suitability_andersen">g3_suitability_andersen</a></code>, suitable for predation by fleets,
as the defaults do not rely on the predator's length.
</p>



<h4>g3_suitability_gamma</h4>

<p>This is a suitability function that is more suitable for use when considering the predation by a fleet,
where the parameter <code class="reqn">\gamma</code> would represent the size of the mesh used by the fleet (specified in centimetres).
</p>
<p style="text-align: center;"><code class="reqn">
      (\frac{l}{(\alpha - 1)\beta\gamma}) ^ {(\alpha - 1) e^{\alpha - 1 - \frac{l}{\beta\gamma}}}
    </code>
</p>


<dl>
<dt><code class="reqn">l</code></dt><dd><p>Vector of stock midlength for each lengthgroup</p>
</dd>
<dt><code class="reqn">\alpha</code></dt><dd><p>Function parameter <var>alpha</var></p>
</dd>
<dt><code class="reqn">\beta</code></dt><dd><p>Function parameter <var>beta</var></p>
</dd>
<dt><code class="reqn">\gamma</code></dt><dd><p>Function parameter <var>gamma</var></p>
</dd>
</dl>

<p>This is a suitability function that is more suitable for use when
considering the predation by a fleet, where the parameter <code class="reqn">\gamma</code>
would represent the size of the mesh used by the fleet (specified in
centimetres).
</p>



<h4>g3_suitability_exponential</h4>

<p>This is a suitability function that has a logarithmic dependence on both the length of the predator and the length of the prey as given by the following equation:
</p>
<p style="text-align: center;"><code class="reqn">
      \frac{\delta}{1 + e^{-\alpha - \beta l - \gamma L}}
    </code>
</p>


<dl>
<dt><code class="reqn">L</code></dt><dd><p>Vector of predator midlength for each lengthgroup</p>
</dd>
<dt><code class="reqn">l</code></dt><dd><p>Vector of stock midlength for each lengthgroup</p>
</dd>
<dt><code class="reqn">\alpha</code></dt><dd><p>Function parameter <var>alpha</var></p>
</dd>
<dt><code class="reqn">\beta</code></dt><dd><p>Function parameter <var>beta</var></p>
</dd>
<dt><code class="reqn">\gamma</code></dt><dd><p>Function parameter <var>gamma</var></p>
</dd>
<dt><code class="reqn">\delta</code></dt><dd><p>Function parameter <var>delta</var></p>
</dd>
</dl>




<h4>g3_suitability_straightline</h4>

<p>Returns a <a href="stats.html#topic+formula">formula</a> for use in predation function's <var>suitabilities</var> argument:
</p>
<p style="text-align: center;"><code class="reqn">
      \alpha + \beta l
    </code>
</p>


<dl>
<dt><code class="reqn">l</code></dt><dd><p>Vector of stock midlength for each lengthgroup</p>
</dd>
<dt><code class="reqn">\alpha</code></dt><dd><p>Function parameter <var>alpha</var></p>
</dd>
<dt><code class="reqn">\beta</code></dt><dd><p>Function parameter <var>beta</var></p>
</dd>
</dl>




<h4>g3_suitability_constant</h4>

<p>Returns a <a href="stats.html#topic+formula">formula</a> for use in predation function's <var>suitabilities</var> argument:
</p>
<p style="text-align: center;"><code class="reqn">
      \alpha
    </code>
</p>


<dl>
<dt><code class="reqn">\alpha</code></dt><dd><p>Function parameter <var>alpha</var></p>
</dd>
</dl>




<h4>g3_suitability_richards</h4>

<p>Returns a <a href="stats.html#topic+formula">formula</a> for use in predation function's <var>suitabilities</var> argument:
</p>
<p style="text-align: center;"><code class="reqn">
      {\big( \frac{p_3}{1 + e^{-p_0 - p_1 l - p_2 L}} \big)}^{\frac{1}{p_4}}
    </code>
</p>


<dl>
<dt><code class="reqn">L</code></dt><dd><p>Vector of predator midlength for each lengthgroup</p>
</dd>
<dt><code class="reqn">l</code></dt><dd><p>Vector of stock midlength for each lengthgroup</p>
</dd>
<dt><code class="reqn">p_0</code> .. <code class="reqn">p_4</code></dt><dd><p>Function parameter <var>p0</var> .. <var>p4</var></p>
</dd>
</dl>

<p>This is an extension to <a href="#topic+g3_suitability_exponential">g3_suitability_exponential</a>.
</p>



<h3>See Also</h3>

<p><a href="https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec-suitability">https://gadget-framework.github.io/gadget2/userguide/chap-stock.html#sec-suitability</a>,
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
ling_imm &lt;- g3_stock(c(species = 'ling', 'imm'), seq(20, 156, 4)) %&gt;% g3s_age(3, 10)
ling_mat &lt;- g3_stock(c(species = 'ling', 'mat'), seq(20, 156, 4)) %&gt;% g3s_age(5, 15)
igfs &lt;- g3_fleet('igfs')

igfs_landings &lt;-
  structure(expand.grid(year=1990:1994, step=2, area=1, total_weight=1),
            area_group = list(`1` = 1))

# Generate a fleet predation action using g3_suitability_exponentiall50
predate_action &lt;- g3a_predate_fleet(
    igfs,
    list(ling_imm, ling_mat),
    suitabilities = list(
        ling_imm = g3_suitability_exponentiall50(
            g3_parameterized('lln.alpha', by_stock = 'species'),
            g3_parameterized('lln.l50', by_stock = 'species')),
        ling_mat = g3_suitability_exponentiall50(
            g3_parameterized('lln.alpha', by_stock = 'species'),
            g3_parameterized('lln.l50', by_stock = 'species'))),
    catchability = g3a_predate_catchability_totalfleet(
        g3_timeareadata('igfs_landings', igfs_landings)))

# You can use g3_eval to directly calculate values for a stock:
g3_eval(
    g3_suitability_exponentiall50(alpha = 0.2, l50 = 60),
    stock = g3_stock('x', seq(0, 100, 10)) )

## Plots
suit_plot &lt;- function (
    fn,
    stock = g3_stock('x', seq(0, 100, 10)),
    predstock__midlen = 140 ) {
  cols &lt;- rainbow(5)
  par(mar = c(2,2,2,2), cex.main = 1)

  plot(
    g3_stock_def(stock, 'midlen'),
    seq(0, 1, length.out = length(g3_stock_def(stock, 'midlen'))),
    main=deparse1(body(fn)),
    type = "n")
  for (a in seq_along(cols)) lines(
    g3_stock_def(stock, 'midlen'),
    g3_eval(fn(a), stock = stock, predstock__midlen = predstock__midlen),
    type = "o", col = cols[[a]] )
}

suit_plot(function (a) g3_suitability_exponentiall50(alpha = a * 0.1, l50 = 50))
suit_plot(function (a) g3_suitability_andersen(0, log(2), 1, p3 = a * 0.1, 0.1, 140))
suit_plot(function (a) g3_suitability_andersen(0, log(2), 1, 0.1, p4 = a * 0.1, 140))
suit_plot(function (a) g3_suitability_gamma(alpha = 2 + a * 0.1, beta = 1, gamma = 40))
suit_plot(function (a) g3_suitability_exponential(0, 0.01 * a, 0, 1))
suit_plot(function (a) g3_suitability_straightline(alpha = 0.1, beta = 0.01 * a))
suit_plot(function (a) g3_suitability_constant(a * 0.1))
suit_plot(function (a) g3_suitability_richards(0, 0.05, 0, 1, 0.1 * a))

</code></pre>

<hr>
<h2 id='timedata'>Gadget3 time-based data</h2><span id='topic+g3_timeareadata'></span>

<h3>Description</h3>

<p>Convert time-based data into a formula to lookup values
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_timeareadata(lookup_name, df, value_field = "total_weight", areas = NULL)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="timedata_+3A_lookup_name">lookup_name</code></td>
<td>

<p>A unique name for this lookup, e.g. <code>"igfs_landings"</code>.
</p>
</td></tr>
<tr><td><code id="timedata_+3A_df">df</code></td>
<td>

<p>A <a href="base.html#topic+data.frame">data.frame</a> with any of columns out of age, area, year and step, finally <var>value_field</var>.
</p>
</td></tr>
<tr><td><code id="timedata_+3A_value_field">value_field</code></td>
<td>

<p>Column name that contains output value.
</p>
</td></tr>
<tr><td><code id="timedata_+3A_areas">areas</code></td>
<td>

<p>Named integer vector of area names to integer values. See <code><a href="#topic+g3s_livesonareas">g3s_livesonareas</a></code>.
</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <a href="stats.html#topic+formula">formula</a> object that looks up <var>value_field</var> for the current
values of <code>age</code>, <code>area</code>, <code>cur_year</code> and <code>cur_step</code>,
depending on the columns in <var>df</var>. If there's no match, return 0.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
ling_imm &lt;- g3_stock(c(species = 'ling', 'imm'), seq(20, 156, 4)) %&gt;% g3s_age(3, 10)
ling_mat &lt;- g3_stock(c(species = 'ling', 'mat'), seq(20, 156, 4)) %&gt;% g3s_age(5, 15)
igfs &lt;- g3_fleet('igfs')

igfs_landings &lt;-
  structure(expand.grid(year=1990:1994, step=2, area=1, total_weight=1),
            area_group = list(`1` = 1))

# Generate a fleet predation action, use g3_timeareadata to supply landings
# NB: Since igfs_landings only contains values for step=2, there will be no
#     predation on other steps (since g3_timeareadata will return 0).
predate_action &lt;- g3a_predate_fleet(
    igfs,
    list(ling_imm, ling_mat),
    suitabilities = list(
        ling_imm = g3_suitability_exponentiall50(
            g3_parameterized('lln.alpha', by_stock = 'species'),
            g3_parameterized('lln.l50', by_stock = 'species')),
        ling_mat = g3_suitability_exponentiall50(
            g3_parameterized('lln.alpha', by_stock = 'species'),
            g3_parameterized('lln.l50', by_stock = 'species'))),
    catchability = g3a_predate_catchability_totalfleet(
        g3_timeareadata('igfs_landings', igfs_landings)))
</code></pre>

<hr>
<h2 id='timevariable'>Gadget3 time-based formulas</h2><span id='topic+g3_timevariable'></span>

<h3>Description</h3>

<p>Switch formula based on current time step
</p>


<h3>Usage</h3>

<pre><code class='language-R'>g3_timevariable(lookup_name, fs)

</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="timevariable_+3A_lookup_name">lookup_name</code></td>
<td>

<p>A unique name for this lookup, e.g. <code>"igfs_landings"</code>.
</p>
</td></tr>
<tr><td><code id="timevariable_+3A_fs">fs</code></td>
<td>

<p>A list of <a href="stats.html#topic+formula">formula</a> objects, named with either &quot;init&quot;, &quot;(year)&quot; or
&quot;(year)-(step)&quot;.
When the matching time step is reached, the value of the lookup will be changed.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This is mostly for backwards compatibility with gadget2, before using this,
consider other simpler options, e.g. <code><a href="#topic+g3_timeareadata">g3_timeareadata</a></code> or the
<var>by_year</var> option in <code><a href="#topic+g3_parameterized">g3_parameterized</a></code>.
</p>


<h3>Value</h3>

<p>A <a href="stats.html#topic+formula">formula</a> object that will switch values at the given time points.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
ling_imm &lt;- g3_stock('ling_imm', seq(20, 156, 4)) %&gt;% g3s_age(3, 10)

naturalmortality_action &lt;- g3a_naturalmortality(ling_imm,
    g3a_naturalmortality_exp( g3_timevariable("lingimm.M", list(
        # Start off using lingimm.M.early
        "init" = g3_parameterized("lingimm.M.early"),
        # At 2005 step 2, switch to lingimm.M.mid
        "2005-02" = g3_parameterized("lingimm.M.mid"),
        # At 2010 step 1, switch to lingimm.M.late
        "2010" = g3_parameterized("lingimm.M.late")))))
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
