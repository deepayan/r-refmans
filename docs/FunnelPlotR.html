<!DOCTYPE html><html><head><title>Help for package FunnelPlotR</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {FunnelPlotR}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#aggregate_func'><p>Aggregation function for record-level data, prior to plot.</p></a></li>
<li><a href='#build_limits_lookup'><p>Function to build funnel limits</p></a></li>
<li><a href='#calculate_limits'><p>Overdispersion-adjusted funnel limit calculation</p></a></li>
<li><a href='#draw_plot'><p>Funnel Plots drawing function</p></a></li>
<li><a href='#funnel_clean'><p>A clean funnel plot theme</p></a></li>
<li><a href='#funnel_grey'><p>A grey ggplot funnel theme</p></a></li>
<li><a href='#funnel_plot'><p>Funnel plots for comparing institutional performance</p></a></li>
<li><a href='#limits'><p>Funnel plot limits</p></a></li>
<li><a href='#outliers'><p>Funnel plot outliers</p></a></li>
<li><a href='#phi'><p>dispersion ratio, <code class="reqn">\phi</code>, for Funnel plots</p></a></li>
<li><a href='#phi_func'><p>Calculate overdispersion ratio</p></a></li>
<li><a href='#source_data'><p>source data used to create Funnel plots</p></a></li>
<li><a href='#tau_func'><p>Calculate the between group standard error (tau2) using a dispersion factor</p></a></li>
<li><a href='#tau2'><p>between groups variance, <code class="reqn">\tau^2</code>, for Funnel plots</p></a></li>
<li><a href='#transformed_zscore'><p>Transformation function for z-scoring</p></a></li>
<li><a href='#truncation'><p>Truncation function for NHSD method</p></a></li>
<li><a href='#winsorisation'><p>Winsorisation function</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Funnel Plots for Comparing Institutional Performance</td>
</tr>
<tr>
<td>Version:</td>
<td>0.4.2</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Chris Mainey &lt;c.mainey1@nhs.net&gt;</td>
</tr>
<tr>
<td>Description:</td>
<td>An implementation of methods presented by Spiegelhalter (2005) &lt;<a href="https://doi.org/10.1002%2Fsim.1970">doi:10.1002/sim.1970</a>&gt; Funnel plots for comparing institutional performance, for standardised ratios, ratios of counts and proportions with additive overdispersion adjustment.</td>
</tr>
<tr>
<td>Language:</td>
<td>en-GB</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file LICENSE</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://nhs-r-community.github.io/FunnelPlotR/">https://nhs-r-community.github.io/FunnelPlotR/</a>,
<a href="https://github.com/nhs-r-community/FunnelPlotR">https://github.com/nhs-r-community/FunnelPlotR</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/nhs-r-community/FunnelPlotR/issues">https://github.com/nhs-r-community/FunnelPlotR/issues</a></td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>Imports:</td>
<td>dplyr, ggrepel, ggplot2, scales</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.2.3</td>
</tr>
<tr>
<td>Suggests:</td>
<td>testthat (&ge; 3.0.0), knitr, rmarkdown, COUNT, tidyr, covr,
Cairo</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>Config/testthat/edition:</td>
<td>3</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2023-06-01 15:47:22 UTC; Christopher</td>
</tr>
<tr>
<td>Author:</td>
<td>Chris Mainey <a href="https://orcid.org/0000-0002-3018-6171"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre],
  Andrew Johnson [ctb],
  Matthew Bass [ctb],
  NHS-R Community [cph]</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2023-06-01 16:50:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='aggregate_func'>Aggregation function for record-level data, prior to plot.</h2><span id='topic+aggregate_func'></span>

<h3>Description</h3>

<p>Internal function to aggregate record-level data for plotting as a funnel.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aggregate_func(mod_plot)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="aggregate_func_+3A_mod_plot">mod_plot</code></td>
<td>
<p>A data frame of values to be aggregated.  Expected columns, 'group', 'numerator' and 'denominator'</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns an aggregated data.frame of the same columns, but summed by 'group', with a relative risk 'rr' column added.
</p>

<hr>
<h2 id='build_limits_lookup'>Function to build funnel limits</h2><span id='topic+build_limits_lookup'></span>

<h3>Description</h3>

<p>Internal function for funnel plot to build the control limits prior to plotting.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>build_limits_lookup(
  min_x,
  max_x,
  min_y,
  max_y,
  draw_adjusted,
  tau2,
  data_type,
  sr_method,
  target,
  multiplier,
  denominators
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="build_limits_lookup_+3A_draw_adjusted">draw_adjusted</code></td>
<td>
<p>TRUE/FALSE Use overdispersion adjustment</p>
</td></tr>
<tr><td><code id="build_limits_lookup_+3A_tau2">tau2</code></td>
<td>
<p>If using draw_adjusted, what is the tau2 (&quot;between&quot; standard error) to use?</p>
</td></tr>
<tr><td><code id="build_limits_lookup_+3A_data_type">data_type</code></td>
<td>
<p>SR, PR or RC. Used to set target reference</p>
</td></tr>
<tr><td><code id="build_limits_lookup_+3A_sr_method">sr_method</code></td>
<td>
<p>Which adjustment method is being used, SHMI or CQC?</p>
</td></tr>
<tr><td><code id="build_limits_lookup_+3A_target">target</code></td>
<td>
<p>target to be used to set centre line</p>
</td></tr>
<tr><td><code id="build_limits_lookup_+3A_multiplier">multiplier</code></td>
<td>
<p>Multiply ratio value by an amount.  Default is 1, but some mortality ratios use 100, for example.</p>
</td></tr>
<tr><td><code id="build_limits_lookup_+3A_min_preds">min_preds</code></td>
<td>
<p>Minimum predicted value for range of x-axis</p>
</td></tr>
<tr><td><code id="build_limits_lookup_+3A_max_preds">max_preds</code></td>
<td>
<p>Maximum predicted value for range of x-axis</p>
</td></tr>
<tr><td><code id="build_limits_lookup_+3A_min_ratio">min_ratio</code></td>
<td>
<p>Minimum ratio value for range of y-axis</p>
</td></tr>
<tr><td><code id="build_limits_lookup_+3A_max_ratio">max_ratio</code></td>
<td>
<p>Maximum ratio value for range of y-axis</p>
</td></tr>
<tr><td><code id="build_limits_lookup_+3A_draw_unadjusted">draw_unadjusted</code></td>
<td>
<p>TRUE/FALSE Draw Poisson distribution limits?</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data.frame with an index column and various control limits based on the index as an x-axis value.
</p>

<hr>
<h2 id='calculate_limits'>Overdispersion-adjusted funnel limit calculation</h2><span id='topic+calculate_limits'></span>

<h3>Description</h3>

<p>Add 95
</p>


<h3>Usage</h3>

<pre><code class='language-R'>calculate_limits(
  dfCI = dfCI,
  data_type = "SR",
  sr_method = "SHMI",
  multiplier = 1,
  tau2 = 0,
  target = target,
  draw_adjusted = draw_adjusted
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="calculate_limits_+3A_dfci">dfCI</code></td>
<td>
<p>Aggregated model input data</p>
</td></tr>
<tr><td><code id="calculate_limits_+3A_data_type">data_type</code></td>
<td>
<p>Type of data for adjustment and plotting: Indirectly Standardised ratio (\&quot;SR\&quot;), proportion (\&quot;PR\&quot;), or ratio of counts (\&quot;RC\&quot;).</p>
</td></tr>
<tr><td><code id="calculate_limits_+3A_sr_method">sr_method</code></td>
<td>
<p>Adjustment method for standardised ratios, can take the value \&quot;SHMI\&quot; or \&quot;CQC\&quot;. \&quot;SHMI\&quot; is default.</p>
</td></tr>
<tr><td><code id="calculate_limits_+3A_multiplier">multiplier</code></td>
<td>
<p>Multiplier to adjust limits if reporting by a multiplier, e.g. per 1000.</p>
</td></tr>
<tr><td><code id="calculate_limits_+3A_tau2">tau2</code></td>
<td>
<p>A 'between' standard deviation to add to the within standard deviation, S, to inflate limits.</p>
</td></tr>
<tr><td><code id="calculate_limits_+3A_target">target</code></td>
<td>
<p>The centre line of the plot. Mean for non-SRs or 1 for SR</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data.frame of with appended OD limits
</p>

<hr>
<h2 id='draw_plot'>Funnel Plots drawing function</h2><span id='topic+draw_plot'></span>

<h3>Description</h3>

<p>Internal function for drawing plot.  Do not use this directly, call 'funnel_plot()' instead.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>draw_plot(
  mod_plot_agg,
  limits,
  x_label,
  y_label,
  title,
  label,
  multiplier,
  draw_unadjusted,
  draw_adjusted,
  target,
  min_y,
  max_y,
  min_x,
  max_x,
  data_type,
  sr_method,
  theme,
  plot_cols
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="draw_plot_+3A_mod_plot_agg">mod_plot_agg</code></td>
<td>
<p>data.frame of containing numerator, denominator, ratio/proportion, SEs and limits</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_limits">limits</code></td>
<td>
<p>data.frame of limits from set_plot_range().</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_x_label">x_label</code></td>
<td>
<p>Title for the funnel plot x-axis.  Usually expected deaths, readmissions, incidents etc.</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_y_label">y_label</code></td>
<td>
<p>Title for the funnel plot y-axis.  Usually a standardised ratio.</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_title">title</code></td>
<td>
<p>Plot title</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_label">label</code></td>
<td>
<p>Whether to label outliers, highlighted groups, both or none. Default is &quot;outlier&quot;, by accepted values are: &quot;outlier&quot;, &quot;highlight&quot;, &quot;both&quot; or &quot;NA&quot;.</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_multiplier">multiplier</code></td>
<td>
<p>Scale relative risk and funnel by this factor. Default to 1, but 100 is used for HSMR</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_draw_unadjusted">draw_unadjusted</code></td>
<td>
<p>Draw exact limits based only on data points with no iterpolation. (default=FALSE)</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_draw_adjusted">draw_adjusted</code></td>
<td>
<p>Draw overdispersed limits using Spiegelhalter's (2012) tau2 (default=TRUE)</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_target">target</code></td>
<td>
<p>the calculated target value for the data type</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_min_y">min_y</code></td>
<td>
<p>Specify the plot range.</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_max_y">max_y</code></td>
<td>
<p>Specify the plot range.</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_min_x">min_x</code></td>
<td>
<p>Specify the plot range.</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_max_x">max_x</code></td>
<td>
<p>Specify the plot range.</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_data_type">data_type</code></td>
<td>
<p>the data type SR, PR or RC.</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_sr_method">sr_method</code></td>
<td>
<p>CQC or SHMI methods for standardised ratios</p>
</td></tr>
<tr><td><code id="draw_plot_+3A_theme">theme</code></td>
<td>
<p>a ggplot theme function.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list containing [1] the funnel plot as a ggplot2 object., [2]the limits table.
</p>

<hr>
<h2 id='funnel_clean'>A clean funnel plot theme</h2><span id='topic+funnel_clean'></span>

<h3>Description</h3>

<p>A ggplot theme function for clean looking funnel plots.  Try funnel_grey if you like the old one.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>funnel_clean()
</code></pre>


<h3>Value</h3>

<p>a list of ggplot theme items
</p>


<h3>See Also</h3>

<p>funnel_grey
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: funnel_plot(theme=funnel_clean())
</code></pre>

<hr>
<h2 id='funnel_grey'>A grey ggplot funnel theme</h2><span id='topic+funnel_grey'></span>

<h3>Description</h3>

<p>A classic ggplot theme function for funnel plots.  Try funnel_clean if you don't like the grey background.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>funnel_grey()
</code></pre>


<h3>Value</h3>

<p>a list of ggplot theme items
</p>


<h3>See Also</h3>

<p>funnel_clean
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: funnel_plot(theme=funnel_grey())
</code></pre>

<hr>
<h2 id='funnel_plot'>Funnel plots for comparing institutional performance</h2><span id='topic+funnel_plot'></span>

<h3>Description</h3>

<p>An implementation of funnel plots for indirectly standardised ratios, as described by Spiegelhalter (2005) &lt;https://doi.org/10.1002/sim.1970/&gt;.
There are several parameters for the input, with the assumption that you will want smooth,
overdispersed, funnel control limits.  Limits may be inflated for overdispersion based on the methods of DerSimonian &amp; Laird (1986), buy calculating a between unit standard deviation (<code class="reqn">\tau</code>)
and constructing an additive random effects models, originally used for meta-analyses of clinical trials data.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>funnel_plot(
  numerator,
  denominator,
  group,
  data_type = "SR",
  limit = 99,
  label = "outlier",
  highlight = NA,
  draw_unadjusted = FALSE,
  draw_adjusted = TRUE,
  sr_method = "SHMI",
  trim_by = 0.1,
  title = "Untitled Funnel Plot",
  multiplier = 1,
  x_label = "Expected",
  y_label,
  x_range = "auto",
  y_range = "auto",
  plot_cols = c("#FF7F0EFF", "#FF7F0EFF", "#1F77B4FF", "#1F77B4FF", "#9467BDFF",
    "#9467BDFF", "#2CA02CFF", "#2CA02CFF"),
  theme = funnel_clean(),
  label_outliers,
  Poisson_limits,
  OD_adjust,
  xrange,
  yrange,
  SHMI_rounding = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="funnel_plot_+3A_numerator">numerator</code></td>
<td>
<p>A vector of the numerator (observed events/counts) values.  Used as numerator of the Y-axis</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_denominator">denominator</code></td>
<td>
<p>A vector of denominator (predicted/population etc.)  Used as denominator of the Y-axis and the scale of the x-axis</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_group">group</code></td>
<td>
<p>A vector of group names as character or factor.  Used to aggregate and group points on plots</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_data_type">data_type</code></td>
<td>
<p>A string identifying the type of data used for in the plot, the adjustment used and the reference point. One of: &quot;SR&quot; for indirectly standardised ratios, such SHMI, &quot;PR&quot; for proportions, or &quot;RC&quot; for ratios of counts. Default is &quot;SR&quot;.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_limit">limit</code></td>
<td>
<p>Plot limits, accepted values are: 95 or 99, corresponding to 95% or 99.8% quantiles of the distribution. Default=99,and applies to OD limits if both OD and Poisson are used.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_label">label</code></td>
<td>
<p>Whether to label outliers, highlighted groups, both or none. Default is &quot;outlier&quot;, by accepted values are:<br />
</p>

<ul>
<li><p><code>"outlier"</code> - Labels upper and lower outliers, determined in relation to the 'limit' argument.
</p>
</li>
<li><p><code>"outlier_lower"</code> - Labels just and lower outliers, determined in relation to the 'limit' argument.
</p>
</li>
<li><p><code>"outlier_upper"</code> - Labels just upper, determined in relation to the 'limit' argument.
</p>
</li>
<li><p><code>"highlight"</code> - Labels the value(s) given in the 'highlight'argument.
</p>
</li>
<li><p><code>"both"</code> - Labels both the highlighted values(s), upper and lower outliers, determined in relation to the 'limit' argument.
</p>
</li>
<li><p><code>"both_lower"</code> - Labels both the highlighted values(s) and lower outliers, determined in relation to the 'limit' argument.
</p>
</li>
<li><p><code>"both_upper"</code> - Labels both the highlighted values(s) and upper outliers, determined in relation to the 'limit' argument.
</p>
</li>
<li><p><code>NA</code> - No labels applied
</p>
</li></ul>
</td></tr>
<tr><td><code id="funnel_plot_+3A_highlight">highlight</code></td>
<td>
<p>Single or vector of points to highlight, with a different colour and point style. Should correspond to values specified to 'group'. Default is NA, for no highlighting.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_draw_unadjusted">draw_unadjusted</code></td>
<td>
<p>Draw control limits without overdispersion adjustment. (default=FALSE)</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_draw_adjusted">draw_adjusted</code></td>
<td>
<p>Draw overdispersed limits using hierarchical model, assuming at group level, as described in Spiegelhalter (2012).
It calculates a second variance component ' for the 'between' standard deviation (<code class="reqn">\tau</code>), that is added to the 'within' standard deviation (sigma) (default=TRUE)</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_sr_method">sr_method</code></td>
<td>
<p>Method for adjustment when using indirectly standardised ratios (type=&quot;SR&quot;) Either &quot;CQC&quot; or &quot;SHMI&quot; (default). There are a few methods for standardisation.  &quot;CQC&quot;/Spiegelhalter
uses a square-root transformation and Winsorises (rescales the outer most values to a particular percentile).
SHMI, instead, uses log-transformation and doesn't Winsorise, but truncates the distribution before assessing overdisperison .
Both methods then calculate a dispersion ratio (<code class="reqn">\phi</code>) on this altered dataset.  This ratio is then used to scale the full dataset,
and the plot is drawn for the full dataset.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_trim_by">trim_by</code></td>
<td>
<p>Proportion of the distribution for winsorisation/truncation. Default is 10 % (0.1).  Note, this is applied in a two-sided
fashion, e.g. 10% refers to 10% at each end of the distribution (20% winsorised/truncated)</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_title">title</code></td>
<td>
<p>Plot title</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_multiplier">multiplier</code></td>
<td>
<p>Scale relative risk and funnel by this factor. Default to 1, but 100 sometime used, e.g. in some hospital mortality ratios.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_x_label">x_label</code></td>
<td>
<p>Title for the funnel plot x-axis.  Usually expected deaths, readmissions, incidents etc.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_y_label">y_label</code></td>
<td>
<p>Title for the funnel plot y-axis.  Usually a standardised ratio.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_x_range">x_range</code></td>
<td>
<p>Manually specify the y-axis min and max, in form c(min, max), e.g. c(0, 200). Default, &quot;auto&quot;, allows function to estimate range.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_y_range">y_range</code></td>
<td>
<p>Manually specify the y-axis min and max, in form c(min, max), e.g. c(0.7, 1.3). Default, &quot;auto&quot;, allows function to estimate range.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_plot_cols">plot_cols</code></td>
<td>
<p>A vector of 8 colours for funnel limits, in order: 95% Poisson (lower/upper), 99.8% Poisson (lower/upper), 95% OD-adjusted (lower/upper), 99.8% OD-adjusted (lower/upper).
Default has been chosen to avoid red and green which can lead to subconscious value judgements of good or bad.
Default is hex colours: c(&quot;#FF7F0EFF&quot;, &quot;#FF7F0EFF&quot;, &quot;#1F77B4FF&quot;,&quot;#1F77B4FF&quot;, &quot;#9467BDFF&quot;, &quot;#9467BDFF&quot;, &quot;#2CA02CFF&quot;, &quot;#2CA02CFF&quot;)</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_theme">theme</code></td>
<td>
<p>a ggplot theme function.  This can be a canned theme such as theme_bw(), a theme() with arguments, or your own custom theme function. Default is new funnel_clean(), but funnel_classic() is original format.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_label_outliers">label_outliers</code></td>
<td>
<p>Deprecated.  Please use the 'label' argument instead.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_poisson_limits">Poisson_limits</code></td>
<td>
<p>Deprecated.  Please use the 'draw_unadjusted' argument instead.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_od_adjust">OD_adjust</code></td>
<td>
<p>Deprecated.  Please use the 'draw_adjusted' argument instead.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_xrange">xrange</code></td>
<td>
<p>Deprecated.  Please use the 'x_range' argument instead.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_yrange">yrange</code></td>
<td>
<p>Deprecated.  Please use the 'y_range' argument instead.</p>
</td></tr>
<tr><td><code id="funnel_plot_+3A_shmi_rounding">SHMI_rounding</code></td>
<td>
<p>TRUE/FALSE, for SHMI calculation (standardised ratio, with SHMI truncation etc.), should you round the expected values to 2 decimal places (TRUE) or not (FALSE)</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Outliers are marked based on the grouping, and the limits chosen, corresponding to either 95% or 99.8% quantiles of the normal distribution.<br />
Labels can attached using the 'label' argument.<br />
Overdispersion can be factored in based on the methods in Spiegelhalter et al. (2012), set 'draw_adjusted' to FALSE to suppress this. <br />
To use Poisson limits set 'draw_unadjusted=TRUE'. <br />
The plot colours deliberately avoid red-amber-green colouring, but you could extract this from the ggplot object and change manually if you like.
Future versions of 'funnelplotr' may allow users to change this.
</p>


<h3>Value</h3>

<p>A fitted 'funnelplot' object.  A 'funnelplot' object is a list containing the following components:<br />
</p>
<table>
<tr><td><code>print</code></td>
<td>
<p>Prints the number of points, outliers and whether the plot has been adjusted, and prints the plot</p>
</td></tr>
<tr><td><code>plot</code></td>
<td>
<p>A ggplot object with the funnel plot and the appropriate limits</p>
</td></tr>
<tr><td><code>limits_lookup</code></td>
<td>
<p>A lookup table with selected limits for drawing a plot in software that requires limits.</p>
</td></tr>
<tr><td><code>aggregated_data</code></td>
<td>
<p>A data.frame of the the aggregated dataset used for the plot.</p>
</td></tr>
<tr><td><code>outlier</code></td>
<td>
<p>A data frame of outliers from the data.</p>
</td></tr>
<tr><td><code>tau2</code></td>
<td>
<p>The between-groups standard deviation, <code class="reqn">\tau^2</code>.</p>
</td></tr>
<tr><td><code>phi</code></td>
<td>
<p>The dispersion ratio, <code class="reqn">\phi</code>.</p>
</td></tr>
<tr><td><code>draw_adjusted</code></td>
<td>
<p>Whether overdispersion-adjusted limits were used.</p>
</td></tr>
<tr><td><code>draw_unadjusted</code></td>
<td>
<p>Whether unadjusted Poisson limits were used.</p>
</td></tr>
</table>


<h3>References</h3>

<p>DerSimonian &amp; Laird (1986)  Meta-analysis in clinical trials. &lt;doi:10.1016/0197-2456(86)90046-2&gt;
</p>
<p>Spiegelhalter (2005) Funnel plots for comparing institutional performance  &lt;doi:10.1002/sim.1970&gt;
</p>
<p>Spiegelhalter et al. (2012) Statistical methods for healthcare regulation: rating, screening and surveillance: &lt;doi:10.1111/j.1467-985X.2011.01010.x&gt;
</p>
<p>NHS Digital (2020) SHMI Methodology v .134 <a href="https://digital.nhs.uk/data-and-information/publications/ci-hub/summary-hospital-level-mortality-indicator-shmi">https://digital.nhs.uk/data-and-information/publications/ci-hub/summary-hospital-level-mortality-indicator-shmi</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># We will use the 'medpar' dataset from the 'COUNT' package.
# Little reformatting needed

library(COUNT)
data(medpar)
medpar$provnum&lt;-factor(medpar$provnum)
medpar$los&lt;-as.numeric(medpar$los)

mod&lt;- glm(los ~ hmo + died + age80 + factor(type)
      , family="poisson", data=medpar)

# Get predicted values for building ratio
medpar$prds&lt;- predict(mod, type="response")

# Draw plot, returning just the plot object
fp&lt;-funnel_plot(denominator=medpar$prds, numerator=medpar$los,
group = medpar$provnum, limit=95, title="An example funnel plot")

# Methods for viewing/extracting
print(fp)
plot(fp)
summary(fp)
limits(fp)
outliers(fp)
source_data(fp)
phi(fp)
tau2(fp)




</code></pre>

<hr>
<h2 id='limits'>Funnel plot limits</h2><span id='topic+limits'></span>

<h3>Description</h3>

<p>Limits class for funnel plots
</p>


<h3>Usage</h3>

<pre><code class='language-R'>limits(x)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="limits_+3A_x">x</code></td>
<td>
<p>object of class funnel plot</p>
</td></tr>
</table>

<hr>
<h2 id='outliers'>Funnel plot outliers</h2><span id='topic+outliers'></span>

<h3>Description</h3>

<p>Outliers class for funnel plots
</p>


<h3>Usage</h3>

<pre><code class='language-R'>outliers(x)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="outliers_+3A_x">x</code></td>
<td>
<p>object of class funnel plot</p>
</td></tr>
</table>

<hr>
<h2 id='phi'>dispersion ratio, <code class="reqn">\phi</code>, for Funnel plots</h2><span id='topic+phi'></span>

<h3>Description</h3>

<p>Phi class for funnel plots
</p>


<h3>Usage</h3>

<pre><code class='language-R'>phi(x)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="phi_+3A_x">x</code></td>
<td>
<p>object of class funnel plot</p>
</td></tr>
</table>

<hr>
<h2 id='phi_func'>Calculate overdispersion ratio</h2><span id='topic+phi_func'></span>

<h3>Description</h3>

<p>Internal function to perform the transformations for data types.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>phi_func(n, zscores)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="phi_func_+3A_n">n</code></td>
<td>
<p>Single numeric value for the count of the number of groups (and therefore z-scores)</p>
</td></tr>
<tr><td><code id="phi_func_+3A_zscores">zscores</code></td>
<td>
<p>Vector of z-scores z-scores to be used.  Commonly, this would be 'winsorised' first to remove impact of extreme outliers.  SHMI truncates instead, but this simply reduced the n as well as the z-score.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A numeric phi value
</p>

<hr>
<h2 id='source_data'>source data used to create Funnel plots</h2><span id='topic+source_data'></span>

<h3>Description</h3>

<p>Source data class for funnel plots
</p>


<h3>Usage</h3>

<pre><code class='language-R'>source_data(x)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="source_data_+3A_x">x</code></td>
<td>
<p>object of class funnel plot</p>
</td></tr>
</table>

<hr>
<h2 id='tau_func'>Calculate the between group standard error (tau2) using a dispersion factor</h2><span id='topic+tau_func'></span>

<h3>Description</h3>

<p>Internal function to calculate the additional, between group, standard error (tau2) to add to S2.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>tau_func(n, phi, S)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="tau_func_+3A_n">n</code></td>
<td>
<p>The number of groups for data items, e.g. hospitals trusts that z-scores are calculated at.</p>
</td></tr>
<tr><td><code id="tau_func_+3A_phi">phi</code></td>
<td>
<p>The dispersion ratio, where &gt; 1 means overdispersion</p>
</td></tr>
<tr><td><code id="tau_func_+3A_s">S</code></td>
<td>
<p>Standard error (within cluster, calculated in z-score process)</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A numeric Tau2 value
</p>

<hr>
<h2 id='tau2'>between groups variance, <code class="reqn">\tau^2</code>, for Funnel plots</h2><span id='topic+tau2'></span>

<h3>Description</h3>

<p>Tau2 class for funnel plots
</p>


<h3>Usage</h3>

<pre><code class='language-R'>tau2(x)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="tau2_+3A_x">x</code></td>
<td>
<p>object of class funnel plot</p>
</td></tr>
</table>

<hr>
<h2 id='transformed_zscore'>Transformation function for z-scoring</h2><span id='topic+transformed_zscore'></span>

<h3>Description</h3>

<p>Internal function to perform the transformations for data types.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>transformed_zscore(
  mod_plot_agg = mod_plot_agg,
  data_type = "SR",
  sr_method = "SHMI"
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="transformed_zscore_+3A_mod_plot_agg">mod_plot_agg</code></td>
<td>
<p>Aggregated model input data</p>
</td></tr>
<tr><td><code id="transformed_zscore_+3A_data_type">data_type</code></td>
<td>
<p>Type of data for adjustment and plotting: Indirectly Standardised ratio (\&quot;SR\&quot;), proportion (\&quot;PR\&quot;), or ratio of counts (\&quot;RC\&quot;).</p>
</td></tr>
<tr><td><code id="transformed_zscore_+3A_sr_method">sr_method</code></td>
<td>
<p>Adjustment method, can take the value \&quot;SHMI\&quot; or \&quot;CQC\&quot;. \&quot;SHMI\&quot; is default.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data.frame of original, aggregated data plus transformed z-score (unadjusted for overdispersion)
</p>

<hr>
<h2 id='truncation'>Truncation function for NHSD method</h2><span id='topic+truncation'></span>

<h3>Description</h3>

<p>Internal function to perform the truncation.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>truncation(mod_plot_agg = mod_plot_agg, trim_by = 0.1)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="truncation_+3A_mod_plot_agg">mod_plot_agg</code></td>
<td>
<p>Aggregated model input data</p>
</td></tr>
<tr><td><code id="truncation_+3A_trim_by">trim_by</code></td>
<td>
<p>The amount to truncate the distribution by, prior to transformation. 0.1 means 10% (at each end).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data.frame with truncated z-scores added
</p>

<hr>
<h2 id='winsorisation'>Winsorisation function</h2><span id='topic+winsorisation'></span>

<h3>Description</h3>

<p>Internal function to perform the Winsorisation.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>winsorisation(mod_plot_agg = mod_plot_agg, trim_by = 0.1)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="winsorisation_+3A_mod_plot_agg">mod_plot_agg</code></td>
<td>
<p>Aggregated model input data</p>
</td></tr>
<tr><td><code id="winsorisation_+3A_trim_by">trim_by</code></td>
<td>
<p>The amount to Winsorise the distribution by, prior to transformation. 0.1 means 10% (at each end).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data.frame with winsorised z-scores returned added
</p>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
