<!DOCTYPE html><html><head><title>Help for package R2BEAT</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {R2BEAT}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#allocation'>
<p>Sample sizes for each stratum</p></a></li>
<li><a href='#beat.1st'>
<p>Compute one stage multivariate optimal allocation.</p></a></li>
<li><a href='#beat.2st'>
<p>Multivariate optimal allocation for different domains in two stage statified sample design</p></a></li>
<li><a href='#beat.cv'>
<p>Computation of coefficient of variation (CV) for a given multivariate multiple allocation</p></a></li>
<li><a href='#build_dummy_variables'>
<p>Derives dummy variables from target variables to the sampling frame</p></a></li>
<li><a href='#check_input'>
<p>Check of coherence in the inputs for the allocation step</p></a></li>
<li><a href='#deft_start'>
<p>Starting values for the Design Effect (<code class="reqn">deft</code>)</p></a></li>
<li><a href='#design'>
<p>Sampling design variables</p></a></li>
<li><a href='#effst'>
<p>Estimator effect</p></a></li>
<li><a href='#errors'>
<p>Precision constraints (maximum CVs) as input for Bethel allocation</p></a></li>
<li><a href='#eval_2stage'>
<p>Evaluation of the two-stage sample design optimized solution by simulation</p></a></li>
<li><a href='#input_to_beat.2st_1'>
<p>Input dataframes for R2BEAT two-stages sample design (when a previous round of the survey is available, but no sampling frame)</p></a></li>
<li><a href='#input_to_beat.2st_2'>
<p>Prepares the design and psu file for two-stage sample design (when a previous round of the survey is available, but no sampling frame)</p></a></li>
<li><a href='#plot_sens'>
<p>Plot of the sensitivity analysis for some parameters by means of grid search</p></a></li>
<li><a href='#prepareInputToAllocation1'>
<p>Input dataframes for R2BEAT two-stages sample design when sampling frame is available</p></a></li>
<li><a href='#prepareInputToAllocation2'>
<p>Input dataframes for R2BEAT two-stages sample design when both sampling frame and a previous round of the survey are available</p></a></li>
<li><a href='#PSU_strat'>
<p>Information on Primary Stage Units (PSUs) stratification</p></a></li>
<li><a href='#rho'>
<p>Intraclass correlation coefficients for self and non self representative in the strata</p></a></li>
<li><a href='#select_PSU'>
<p>Select sample of primary stage units (PSU)</p></a></li>
<li><a href='#select_PSU2'>
<p>Select sample of primary stage units (PSU)</p></a></li>
<li><a href='#select_SSU'>
<p>Select sample of secondary stage units (SSU)</p></a></li>
<li><a href='#sens_names'>
<p>Function for better presentation of sensitivity information</p></a></li>
<li><a href='#sensitivity_min_SSU'>
<p>Sensitivity analysis for choosing minimum number of SSUs per PSU (sampling frame available)</p></a></li>
<li><a href='#sensitivity_min_SSU2'>
<p>Sensitivity analysis for choosing minimum number of SSUs per PSU (no sampling frame available)</p></a></li>
<li><a href='#strata'>
<p>Strata characteristics</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Multistage Sampling Allocation and Sample Selection</td>
</tr>
<tr>
<td>Description:</td>
<td>Multivariate optimal allocation for different domains in one and two stages stratified sample design. 'R2BEAT' extends the Neyman (1934) – Tschuprow (1923) allocation method to the case of several variables, adopting a generalization of the Bethel’s proposal (1989). 'R2BEAT' develops this methodology but, moreover, it allows to determine the sample allocation in the multivariate and multi-domains case of estimates for two-stage stratified samples. It also allows to perform both Primary Stage Units and Secondary Stage Units selection. This package requires the availability of 'ReGenesees', that can be installed from <a href="https://github.com/DiegoZardetto/ReGenesees">https://github.com/DiegoZardetto/ReGenesees</a>.</td>
</tr>
<tr>
<td>Version:</td>
<td>1.0.5</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 3.5.0), sampling, glue, methods, parallel, foreach,
doParallel</td>
</tr>
<tr>
<td>Suggests:</td>
<td>ReGenesees</td>
</tr>
<tr>
<td>Author:</td>
<td>Andrea Fasulo,Giulio Barcaroli,Stefano Falorsi,Alessio Guandalini,Daniela Pagliuca,Marco Dionisio Terribili </td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Andrea Fasulo &lt;fasulo@istat.it&gt;</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://joinup.ec.europa.eu/software/page/eupl">EUPL</a></td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://barcaroli.github.io/R2BEAT/">https://barcaroli.github.io/R2BEAT/</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/barcaroli/R2BEAT/issues">https://github.com/barcaroli/R2BEAT/issues</a></td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.1.1</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2023-05-25 09:18:28 UTC; Giulio</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2023-05-25 10:20:06 UTC</td>
</tr>
</table>
<hr>
<h2 id='allocation'>
Sample sizes for each stratum
</h2><span id='topic+allocation'></span>

<h3>Description</h3>

<p>Example data frame containing a given allocation.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(beat.example)
</code></pre>


<h3>Format</h3>

<p>The Strata data frame contains a row per each stratum with the following variables:
</p>

<dl>
<dt>SIZE</dt><dd>
<p>Stratum sample size (numeric)
</p>
</dd>
</dl>



<h3>Details</h3>

<p>Note: the names of the variables must be the ones indicated above.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Load example data
data(beat.example)
allocation
str(allocation)
</code></pre>

<hr>
<h2 id='beat.1st'>
Compute one stage multivariate optimal allocation.
</h2><span id='topic+beat.1st'></span>

<h3>Description</h3>

<p>Compute multivariate optimal allocation for different domains in one stage stratified sample design
</p>


<h3>Usage</h3>

<pre><code class='language-R'>     beat.1st(stratif, errors, minnumstrat=2, maxiter=200, maxiter1=25, epsilon=10^(-11))
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="beat.1st_+3A_stratif">stratif</code></td>
<td>
<p>Data frame of survey strata, for more details see, e.g.,<a href="#topic+strata">strata</a>.</p>
</td></tr>
<tr><td><code id="beat.1st_+3A_errors">errors</code></td>
<td>
<p>Data frame of expected coefficients of variation (CV) for each domain, for more details see, e.g.,<a href="#topic+errors">errors</a>.</p>
</td></tr>
<tr><td><code id="beat.1st_+3A_minnumstrat">minnumstrat</code></td>
<td>
<p>Minimum number of elementary units per strata (default=2).</p>
</td></tr>
<tr><td><code id="beat.1st_+3A_maxiter">maxiter</code></td>
<td>
<p> Maximum number of iterations (default=200) of the general procedure. This kind of iteration may be required by the fact that when in a stratum the number of allocated units is greater or equal to its population, that stratum is set as &quot;census stratum&quot;, and the whole procedure is re-initialised.</p>
</td></tr>
<tr><td><code id="beat.1st_+3A_maxiter1">maxiter1</code></td>
<td>
<p>Maximum number of iterations in Chromy algorithm (default=25).</p>
</td></tr>
<tr><td><code id="beat.1st_+3A_epsilon">epsilon</code></td>
<td>
<p>Tollerance for the maximum absolute differences between the expected CV and the realised CV with the allocation obtained in the last iteraction for all domains. The default is 10^(-11).</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The methodology is a generalization of Bethel multivariate allocation (1989) that extended the Neyman (1959) - Tchuprov (1923) allocation for multi-purpose and multi-domains surveys.
The generalized Bethel’s algorithm allows to determine the optimal sample size for each stratum in a stratified sample design. The overall sample size and the allocation among the different strata is determined starting from the accuracy constraints imposed in the survey on interest estimates.</p>


<h3>Value</h3>

<p>Object of class <code>list</code>. The list contains 4 objects:
</p>
<table>
<tr><td><code>n</code></td>
<td>
<p>Vector with the optimal sample size for each stratum.</p>
</td></tr>
<tr><td><code>file_strata</code></td>
<td>
<p>Data frame corresponding to the input data.frame <code>stratif</code> with the <code>n</code> optimal sample size column added.</p>
</td></tr>
<tr><td><code>alloc</code></td>
<td>
<p>Data frame with optimal (<code>ALLOC</code>), proportional (<code>PROP</code>), equal (<code>EQUAL</code>) sample size allocation.</p>
</td></tr>
<tr><td><code>sensitivity</code></td>
<td>
<p>Data frame with a summary of expected coefficients of variation (<code>Planned CV</code>), realized coefficients of variation with the given optimal allocation (<code>Actual CV</code>) and the sensitivity at 10% for each domain and each variable. Sensitivity can be a useful tool to help in finding the best allocation, because it provides a hint of the expected sample size variation for a 10% change in planned CVs.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Developed by Stefano Falorsi, Andrea Fasulo, Alessio Guandalini, Daniela Pagliuca, Marco D. Terribili.</p>


<h3>References</h3>

<p>Bethel, J. (1989)
<em>Sample allocation in multivariate surveys.</em>
Survey methodology, 15.1: 47-57.
</p>
<p>Cochran, W. (1977) 
<em>Sampling Techniques.</em> 
John Wiley &amp; Sons, Inc., New York
</p>
<p>Neyman, J. (1934). 
On the two different aspects of the representative method: the method of stratified sampling and the method of purposive selection. 
<em>Journal of the Royal Statistical Society</em>, 97(4): 558-625.
</p>
<p>Tschuprow, A. A. (1923). On the mathematical expectation of the moments of frequency distributions in the case of correlated observation. 
(Chapters 4-6). <em>Metron</em>, 2: 646-683.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Load example data
data(beat.example)

## Example 1
# Allocate the sample
allocation_1 &lt;- beat.1st(stratif=strata, errors=errors)

# The total sample size is
sum(allocation_1$n)

## Example 2
# Assume 5700 units is the maximum sample size to stick to our budget.
# Looking at allocation_1$sensitivity we can see that most of the 
# sensitivity is in DOM1 for REG1 and REG2 due to V1.
allocation_1$sensitivity
# We can relax the constraints increasing the expected coefficients of variation for X1 by 10%
errors1 &lt;- errors 
errors1[1,2] &lt;- errors[1,2]+errors[1,2]*0.1

# Try the new allocation 
allocation_2 &lt;- beat.1st(stratif=strata, errors=errors1)
sum(allocation_2$n)

## Example 3
# On the contrary, if we tighten the constraints decreasing the expected coefficients of variation 
# for X1 by 10%
errors2 &lt;- errors 
errors2[1,2] &lt;- errors[1,2]-errors[1,2]*0.1

# The new allocation leads to a larger sample than the first example 
allocation_3 &lt;- beat.1st(stratif=strata, errors=errors2)
sum(allocation_3$n)
</code></pre>

<hr>
<h2 id='beat.2st'>
Multivariate optimal allocation for different domains in two stage statified sample design
</h2><span id='topic+beat.2st'></span>

<h3>Description</h3>

<p>Compute multivariate optimal allocation for different domains corrected considering stratified two stages design
</p>


<h3>Usage</h3>

<pre><code class='language-R'>	beat.2st(stratif, errors, des_file, psu_file, rho, deft_start = NULL, 
    effst = NULL, epsilon1 = 5, mmdiff_deft = 1,maxi = 20, 
    epsilon = 10^(-11), minPSUstrat = 2, minnumstrat = 2, maxiter = 200, maxiter1 = 25)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="beat.2st_+3A_stratif">stratif</code></td>
<td>
<p>Data frame of survey strata, for more details see, e.g.,<a href="#topic+strata">strata</a>.</p>
</td></tr>
<tr><td><code id="beat.2st_+3A_errors">errors</code></td>
<td>
<p>Data frame of coefficients of variation for each domain, for more details see, e.g.,<a href="#topic+errors">errors</a>.</p>
</td></tr>
<tr><td><code id="beat.2st_+3A_des_file">des_file</code></td>
<td>
<p>Data frame containing information on sampling design variables, for more details see, e.g.,<a href="#topic+design">design</a>.</p>
</td></tr>
<tr><td><code id="beat.2st_+3A_psu_file">psu_file</code></td>
<td>
<p>Data frame containing information on primary stage units stratification, for more details see, e.g.,<a href="#topic+PSU_strat">PSU_strat</a>.</p>
</td></tr>
<tr><td><code id="beat.2st_+3A_rho">rho</code></td>
<td>
<p>Data frame of survey strata, for more details see, e.g.,<a href="#topic+rho">rho</a>.</p>
</td></tr>
<tr><td><code id="beat.2st_+3A_deft_start">deft_start</code></td>
<td>
<p>Data frame of survey strata, for taking into account the initial design effect on each variable, for more details see, e.g.,<a href="#topic+deft_start">deft_start</a>.</p>
</td></tr>
<tr><td><code id="beat.2st_+3A_effst">effst</code></td>
<td>
<p>Data frame of survey strata, for taking into account the estimator effect on each variable, for more details see, e.g.,<a href="#topic+effst">effst</a>.</p>
</td></tr>
<tr><td><code id="beat.2st_+3A_epsilon1">epsilon1</code></td>
<td>
<p>First stop condition: sample sizes differences beetween two iterations; iteration continues until the maximum of sample sizes differences is greater than the default value. The default is 5.</p>
</td></tr> 
<tr><td><code id="beat.2st_+3A_mmdiff_deft">mmdiff_deft</code></td>
<td>
<p>Second stop condition: defts differences beetween two iterations; iteration continues until the maximum of defts largest differences is greater than the default value. The default is 0.06.</p>
</td></tr>
<tr><td><code id="beat.2st_+3A_maxi">maxi</code></td>
<td>
<p>Third stop condition: maximum number of allowed iterations. The default is 20.</p>
</td></tr>
<tr><td><code id="beat.2st_+3A_epsilon">epsilon</code></td>
<td>
<p>The same as in function <a href="#topic+beat.1st">beat.1st</a>.</p>
</td></tr>
<tr><td><code id="beat.2st_+3A_minpsustrat">minPSUstrat</code></td>
<td>
<p>Minimum number of non-self-represenative PSUs to be selected in each stratum.</p>
</td></tr>
<tr><td><code id="beat.2st_+3A_minnumstrat">minnumstrat</code></td>
<td>
<p>The same as in function <a href="#topic+beat.1st">beat.1st</a>.</p>
</td></tr>
<tr><td><code id="beat.2st_+3A_maxiter">maxiter</code></td>
<td>
<p>The same as in function <a href="#topic+beat.1st">beat.1st</a>.</p>
</td></tr>
<tr><td><code id="beat.2st_+3A_maxiter1">maxiter1</code></td>
<td>
<p>The same as in function <a href="#topic+beat.1st">beat.1st</a>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The methodology is a generalization of Bethel multivariate allocation (1989) that extended the Neyman (1959) - Tchuprov (1923) allocation for multi-purpose and multi-domains surveys.
The generalized Bethel’s algorithm allows to determine the optimal sample size for each stratum in a stratified sample design. The overall sample size and the allocation among the different strata is determined starting from the accuracy constraints imposed in the survey on interest estimates.
The optimal allocation is obtained throught a procedure that converge in few iteractions:
</p>
<p>The first iteration is a computation of an initial allocation with the multivariate optimal allocation for different domains in one stages statified sample design (the methodology is a generalization for multidomains and multistages designs of Bethel multivariate allocation, 1989).
</p>
<p>The correction of the initial allocation is based on an iterative method calculating new allocations and is based on an inflaction of strata variances  using the design effect (Ganninger, 2010).
</p>


<h3>Value</h3>

<p>Object of class <code>list</code>. The list contains 8 objects:
</p>
<table>
<tr><td><code>iteractions</code></td>
<td>
<p>Data frame that for each iteraction provides a summary with the number of Primary Stage Units (<code>PSU_Total</code>) distinguish between Self-Representative (<code>PSU_SR</code>) from Non-Self-Representative (<code>PSU_NSR</code>) and the number of Secondary Stage Units (<code>SSU</code>). This output is also printed to the screen.</p>
</td></tr>
<tr><td><code>file_strata</code></td>
<td>
<p>Input data frame in <code>stratif</code> with the design effect for each variables in each stratum (<code>DEFT1 - DEFTn</code>) and the optimal sample size columns.</p>
</td></tr>
<tr><td><code>alloc</code></td>
<td>
<p>Data frame with optimal (<code>ALLOC</code>), proportional (<code>PROP</code>), equal (<code>EQUAL</code>) sample size allocation.</p>
</td></tr>
<tr><td><code>planned</code></td>
<td>
<p>Data frame with a summary of expected coefficients of variation for each variable in each domain.</p>
</td></tr>
<tr><td><code>expected</code></td>
<td>
<p>Data frame with a summary of realized coefficients of variation with the given optimal allocation for each variable in each domain.</p>
</td></tr>
<tr><td><code>sensitivity</code></td>
<td>
<p>Data frame with a summary of the sensitivity at 10% for each domain and each variable. Sensitivity can be a useful tool to help in finding the best allocation, because it provides a hint of the expected sample size variation for a 10% change in planned CVs.</p>
</td></tr>
<tr><td><code>deft_c</code></td>
<td>
<p>Data frame with the design effect for each variable in each domain in each iteraction. Note that <code>DEFT1_0 - DEFTn_0</code> is always equal to 1 if <code>deft_start</code> is <code>NULL</code>. Instead is equal to <code>deft_start</code>. While <code>DEFT1 - DEFTn</code> are the final design effect related to the given allocation.</p>
</td></tr>
<tr><td><code>param_alloc</code></td>
<td>
<p>A vector with a resume of all the parameter given for the allocation.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Developed by Stefano Falorsi, Andrea Fasulo, Alessio Guandalini, Daniela Pagliuca, Marco D. Terribili.
</p>


<h3>References</h3>

<p>Cochran, W. (1977) 
<em>Sampling Techniques.</em> 
John Wiley &amp; Sons, Inc., New York
</p>
<p>Ganninger, M. (2010). 
<em>Design effects: model-based versus design-based approach.</em> 
Vol. 3, p. 174. DEU.
</p>
<p>Neyman, J. (1934). 
On the two different aspects of the representative method: the method of stratified sampling and the method of purposive selection. 
<em>Journal of the Royal Statistical Society</em>, 97(4), 558-625.
</p>
<p>Tschuprow, A. A. (1923). On the mathematical expectation of the moments of frequency distributions in the case of correlated observation. 
(Chapters 4-6). <em>Metron</em>, 1923, 2: 646-683.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
# Load example data
data(beat.example)

## Example 1
# Allocate the sample
allocation2st_1 &lt;- beat.2st(stratif=strata, errors=errors,
des_file=design, psu_file=PSU_strat,rho=rho)
# The total ammount of sample size is 191 PSU (36 SR + 155 NSR) and 15147 SSU. 

## Example 2
# Assume 13000 SSUs is the maximum sample size to stick to our budget.
# Look at the sensitivity is in DOM1 for REG1 and REG2 due to V1.
allocation2st_1$sensitivity
# We can relax the constraints increasing the expected coefficients of variation for X1 by 10
errors1 &lt;- errors 
errors1[1,2] &lt;- errors[1,2]+errors[1,2]*0.1

# Try the new allocation 
allocation2st_2 &lt;- beat.2st(stratif=strata, errors=errors1,
des_file=design, psu_file=PSU_strat,rho=rho)

## Example 3
# On the contrary, if we tighten the constraints decreasing the expected coefficients of variation 
# for X1 by 10
errors2 &lt;- errors 
errors2[1,2] &lt;- errors[1,2]-errors[1,2]*0.1

# The new allocation leads to a larger sample than the first example (around 18000)
allocation2st_3 &lt;- beat.2st(stratif=strata, errors=errors2,
des_file=design, psu_file=PSU_strat,rho=rho)

## Example 4
# Sometimes some budget constraints concern the number of PSU involved in the survey.
# Tuning the PSUs number is possible modyfing the MINIMUM in des_file. 
# Assume to increase the MINIMUM from 48 to 60
design1 &lt;- design 
design1[,4] &lt;- 60
allocation2st_4 &lt;- beat.2st(stratif=strata, errors=errors2,
des_file=design1, psu_file=PSU_strat, rho=rho)

# The PSUs number is decreased, while the SSUs number increased 
# due to cluster intra-correlation effect.
# Under the same expected errors, to offset a slight reduction of PSUs (from 221 to 207) 
# an increase of SSUs involved is observed.
allocation2st_3$expected
allocation2st_4$expected

## Example 5
# On the contrary, assume to decrease the MINIMUM from 48 to 24.
# The SSUs number strongly decrease in the face of an increase of PSUs,
# always under the same expected errors.
design2 &lt;- design 
design2[,4] &lt;- 24
allocation2st_5 &lt;- beat.2st(stratif=strata, errors=errors2,
des_file=design2, psu_file=PSU_strat, rho=rho)
allocation2st_4$expected
allocation2st_5$expected


## Example 6
# Assume that the SSUs are in turn clusters, for instance households composed by individuals.
# In the previous examples we always derived optimal allocations
# for sample of SSUs (i.e. households, because
# DELTA = 1).
design
design1
design2
# For obtaining a sample in terms of the elements composing SSUs
# (i.e., individuals) is just sufficient to 
# modify the DELTA in des_file.
design3 &lt;- design 
design3$DELTA &lt;- 2.31
# DELTA_IND=2.31, the average size of household in Italy.
allocation2st_6 &lt;- beat.2st(stratif=strata, errors=errors,
des_file=design3, psu_file=PSU_strat, rho=rho)

## Example 7
# Complete workflow
library(readr)
pop &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/pop.RDS?raw=true")
library(R2BEAT)
cv &lt;- as.data.frame(list(DOM=c("DOM1","DOM2"),
                         CV1=c(0.02,0.03),
                         CV2=c(0.03,0.06),
                         CV3=c(0.03,0.06),
                         CV4=c(0.05,0.08)))
cv
samp_frame &lt;- pop
samp_frame$one &lt;- 1
id_PSU &lt;- "municipality"  
id_SSU &lt;- "id_ind"        
strata_var &lt;- "stratum"   
target_vars &lt;- c("income_hh","active","inactive","unemployed")   
deff_var &lt;- "stratum"     
domain_var &lt;- "region"  
delta =  1       # households = survey units
minimum &lt;- 50    # minimum number of SSUs to be interviewed in each selected PSU
deff_sugg &lt;- 1.5 # suggestion for the deff value

inp &lt;- prepareInputToAllocation1(samp_frame,
                                  id_PSU,
                                  id_SSU,
                                  strata_var,
                                  target_vars,
                                  deff_var,
                                  domain_var,
                                  minimum,
                                  delta,
                                  deff_sugg)
inp$desfile$MINIMUM &lt;- 50
alloc &lt;- beat.2st(stratif = inp$strata, 
                   errors = cv, 
                   des_file = inp$des_file, 
                   psu_file = inp$psu_file, 
                   rho = inp$rho, 
                   deft_start = NULL,
                   effst = inp$effst, 
                   minPSUstrat = 2,
                   minnumstrat = 50
)


## End(Not run)
</code></pre>

<hr>
<h2 id='beat.cv'>
Computation of coefficient of variation (CV) for a given multivariate multiple allocation
</h2><span id='topic+beat.cv'></span>

<h3>Description</h3>

<p>Compute the coefficients of variation considering a given multivariate optimal allocation.
</p>


<h3>Usage</h3>

<pre><code class='language-R'> 
beat.cv(n_file, stratif, errors, des_file, psu_file, rho, epsilon)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="beat.cv_+3A_n_file">n_file</code></td>
<td>
<p>Data frame containing the sample size allocated in each stratum, for more details, e.g.,<a href="#topic+allocation">allocation</a>.</p>
</td></tr>
<tr><td><code id="beat.cv_+3A_stratif">stratif</code></td>
<td>
<p>Data frame of survey strata, for more details see, e.g.,<a href="#topic+strata">strata</a>.</p>
</td></tr>
<tr><td><code id="beat.cv_+3A_errors">errors</code></td>
<td>
<p>Data frame of expected coefficients of variation (CV) for each domain, for more details see, e.g.,<a href="#topic+errors">errors</a>.</p>
</td></tr>
<tr><td><code id="beat.cv_+3A_des_file">des_file</code></td>
<td>
<p>Data frame containing information on sampling design variables, for more details see, e.g.,<a href="#topic+design">design</a>.</p>
</td></tr>
<tr><td><code id="beat.cv_+3A_psu_file">psu_file</code></td>
<td>
<p>Data frame containing information on primary stage units stratification, for more details see, e.g.,<a href="#topic+PSU_strat">PSU_strat</a>.</p>
</td></tr>
<tr><td><code id="beat.cv_+3A_rho">rho</code></td>
<td>
<p>Data frame of survey strata, for more details see, e.g.,<a href="#topic+rho">rho</a>.</p>
</td></tr>
<tr><td><code id="beat.cv_+3A_epsilon">epsilon</code></td>
<td>
<p>The same as in function <a href="#topic+beat.1st">beat.1st</a>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function enables to derive the expected coefficient of variation (CV) from a given allocation.
The function <code>beat.cv</code> returns the estimates expected accuracy in terms of coefficient of variation, for several variables in different domains, given a certain allocation among the different strata.
</p>


<h3>Value</h3>

<p>Object of class <code>list</code>. The list contains a set of <code>data.frame</code>, as many of the cross product between domain and interest variables, containing total estimates, population, variance and expected coefficient of variation for every domain modality.
For each domain and each variable is defined
</p>
<table>
<tr><td><code>Tot1</code></td>
<td>
<p>Total estimate</p>
</td></tr>
<tr><td><code>N</code></td>
<td>
<p>Measure of size</p>
</td></tr>
<tr><td><code>Varfin</code></td>
<td>
<p>The sample variance of the total estimate</p>
</td></tr>
<tr><td><code>CV</code></td>
<td>
<p>The coefficient of variation of the</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Developed by Stefano Falorsi, Andrea Fasulo, Alessio Guandalini, Daniela Pagliuca, Marco D. Terribili.</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 

# Load example data
data(beat.example)

## Example 1
# Calculate coefficients of variation, for two variables in two domains,
# given an allocation among the different strata.
allocation
cv1&lt;-beat.cv( n_file=allocation, stratif=strata, errors=errors,
des_file=design, psu_file=PSU_strat, rho=rho)

## Example 2
# Take the example 1 in beat.2st.
allocation2st_1 &lt;- beat.2st(stratif=strata, errors=errors,
des_file=design, psu_file=PSU_strat,rho=rho)
# The allocation obtained is 
allocation2st_1$alloc
# with these precision constraints 
errors
# and these expected coefficient of variation
allocation2st_1$expected

# Now, fit the output of beat.2st to allocation, that is
SIZE &lt;- allocation2st_1$alloc[-18,c(2)]
allocation1 &lt;- data.frame(SIZE)
# If apply beat.cv the same error in allocation2st_1$expected should be obtained.
# In fact
cv2&lt;-beat.cv( n_file=allocation1, stratif=strata, errors=errors,
des_file=design, psu_file=PSU_strat, rho=rho)
cv2

# Please, note that some very slightly differences may occur.

## End(Not run)
</code></pre>

<hr>
<h2 id='build_dummy_variables'>
Derives dummy variables from target variables to the sampling frame
</h2><span id='topic+build_dummy_variables'></span>

<h3>Description</h3>

<p>This function allow to derive dummy variables to the sampling frame (this is necessary if we want to differentiate precision constraints in the same domain level, for instance in the different regions).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>build_dummy_variables(frame,
                      domain_var,
                      initial_target_vars,
                      cv) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="build_dummy_variables_+3A_frame">frame</code></td>
<td>

<p>The sampling frame.
</p>
</td></tr>
<tr><td><code id="build_dummy_variables_+3A_domain_var">domain_var</code></td>
<td>

<p>In the sampling frame, the variable that identifies a given domain level.
</p>
</td></tr>
<tr><td><code id="build_dummy_variables_+3A_initial_target_vars">initial_target_vars</code></td>
<td>

<p>In the sampling frame, the initial set of target variables (non dummies)
</p>
</td></tr>
<tr><td><code id="build_dummy_variables_+3A_cv">cv</code></td>
<td>

<p>The initial set of precision constraints, related to the initial set of target variables.
</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list containing (i) frame: the sampling frame with the derived dummy variables, (ii) new_target_variables: a vector with the names of the total set of target variables (initial ones plus derived variables), (iii) cvnew: the dataframe containing the new set of precision constraints (related to the initial target variables plus the derived dummy variables)
</p>


<h3>Author(s)</h3>

<p>Giulio Barcaroli
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
load("frame_pop_EA.RData")
pop &lt;- frame_pop_EA
cv &lt;- as.data.frame(list(DOM = c("DOM1","DOM2"),
                         CV1 = c(0.10,0.20)))
cv
new &lt;- build_dummy_variables(frame = pop,
                             domain_var = "region",
                             initial_target_vars = "unemployed",
                             cv = cv)
head(new$frame)
new$new_target_vars
new$cvnew

## End(Not run)
</code></pre>

<hr>
<h2 id='check_input'>
Check of coherence in the inputs for the allocation step
</h2><span id='topic+check_input'></span>

<h3>Description</h3>

<p>Checks the coherence between the population in the strata dataset and the population calculated by the PSUs dataset
</p>


<h3>Usage</h3>

<pre><code class='language-R'>     check_input(strata,des,strata_var_strata,strata_var_des)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="check_input_+3A_strata">strata</code></td>
<td>
<p>strata dataset</p>
</td></tr>
<tr><td><code id="check_input_+3A_des">des</code></td>
<td>
<p>design dataset</p>
</td></tr>
<tr><td><code id="check_input_+3A_strata_var_strata">strata_var_strata</code></td>
<td>
<p>variable identifying stratum in strata dataset</p>
</td></tr>
<tr><td><code id="check_input_+3A_strata_var_des">strata_var_des</code></td>
<td>
<p>variable identifying stratum in design dataset</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Giulio Barcaroli</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(R2BEAT)

load("R2BEAT_ReGenesees.RData")   # ReGenesees design and calibration objects plus PSU data

RGdes &lt;- des                           # ReGenesees design object
RGcal &lt;- cal                           # ReGenesees calibrated object

strata_vars &lt;- c("stratum")            # variables of stratification
target_vars &lt;- c("income_hh",
                 "active",
                 "inactive",
                 "unemployed")         # target variables
deff_vars &lt;- "stratum"    # stratification variables for calculating deff and effst 
                          # (n.b: must coincide or be a subset of variables of stratification)
id_PSU &lt;- c("municipality")            # identification variable of PSUs
id_SSU &lt;- c("id_hh")                   # identification variable of SSUs
domain_vars &lt;- c("region")             # domain variables
inp1 &lt;- input_to_beat.2st_1(RGdes,
                            RGcal,
                            id_PSU,
                            id_SSU,
                            strata_vars,
                            target_vars,
                            deff_vars,
                            domain_vars)							
head(inp1$strata)
head(psu)
psu_id="municipality"        # Identifier of the PSU
stratum_var="stratum"        # Identifier of the stratum
mos_var="ind"                # Variable to be used as 'measure of size'
delta=1                      # Average number of SSUs for each selection unit
minimum &lt;- 50                # Minimum number of SSUs to be selected in each PSU
inp2 &lt;- input_to_beat.2st_2(psu,
                            psu_id,
                            stratum_var,
                            mos_var,
                            delta,
                            minimum)
head(inp2$psu_file)
head(inp2$des_file)
newstrata &lt;- check_input(strata=inp1$strata,
                         des=inp2$des_file,
                         strata_var_strata="STRATUM",
                         strata_var_des="STRATUM")

## End(Not run)
</code></pre>

<hr>
<h2 id='deft_start'>
Starting values for the Design Effect (<code class="reqn">deft</code>) 
</h2><span id='topic+deft_start'></span>

<h3>Description</h3>

<p>Example data frame containing the starting values for the Design Effect (<code class="reqn">deft</code>) .
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(beat.example)
</code></pre>


<h3>Format</h3>

<p>The Design Effect data frame contains a row per each stratum with the following variables: 
</p>

<dl>
<dt>STRATUM</dt><dd>
<p>Identifier of the stratum (numeric).
</p>
</dd> 
<dt>DEFT1</dt><dd>
<p>Starting values for the Design Effect in the stratum of the first variable (numeric).
</p>
</dd>
<dt>DEFTj</dt><dd>
<p>Starting values for the Design Effect in the stratum of the j-th variable (numeric).
</p>
</dd>
<dt>DEFTn</dt><dd>
<p>Starting values for the Design Effect in the stratum of the last variable (numeric).
</p>
</dd>
</dl>



<h3>Details</h3>

<p>Note: the names of the variables must be the ones indicated above.
</p>
<p>This is an optional input. 
The function <code>beat.2st</code> independently computes and updates the design effect.
However, it is possible to set the starting values of design effect for each variable in each stratum.
The design effect is the square root of the ratio of the actual sampling variance to the variance expected with the simple random sampling (SRS), on equal sample size.
Under SRS the desing effect is equal to 1. 
Usually, as increasing the stages of selection the design effect increases because it takes into account the &quot;clusterization&quot; of sampling units and the sample size in Self Representative (SR) and Non Self Representative (NSR) strata.
In practice, higher is the intraclass correlation, higher will be the design effect and much more sample size for satisfying the precision constraints is needed with respect to SRS. 
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
# Load example data
data(beat.example)
deft_start
str(deft_start)

## End(Not run)
</code></pre>

<hr>
<h2 id='design'>
Sampling design variables 
</h2><span id='topic+design'></span>

<h3>Description</h3>

<p>Example data frame containing variables for describing the sampling design. 
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(beat.example)
</code></pre>


<h3>Format</h3>

<p>The design data frame contains a row per each stratum with the following variables: 
</p>

<dl>
<dt>STRATUM</dt><dd>
<p>Identifier of the stratum (numeric)
</p>
</dd> 
<dt>STRAT_MOS</dt><dd>
<p>Measure of size of the stratum (numeric)
</p>
</dd>     
<dt>DELTA</dt><dd>
<p>The average size of Secondary Stage Units (SSU) in the strata. With respect to the sample on which we are interested in, it could be equal or greater than 1 (numeric). See details for a depth explanation.
</p>
</dd> 
<dt>MINIMUM</dt><dd>
<p>the minimum number of SSU to be selected in each PSU. It could be different in each stratum (numeric)
</p>
</dd> 
</dl>



<h3>Details</h3>

<p>Note: the names of the variables must be the ones indicated above.
</p>
<p>The sample design can be defined through a measure of size of the stratum, the average size of each SSU (&gt;=1) and the minimum number of SSU to be selected in each PSU.
In particular, if SSU are not cluster DELTA=1 and the sample size determined will be given in term of SSU.
Instead, when SSUs are, in turn, clusters (for instance, households composed by individuals), defining DELTA equal to the average size of SSUs, enables to derive a sample in term of individuals.
</p>
<p>Furthermore, modifying the MINIMUM it is possible to tune the number of PSU in the sample (see the example in <a href="#topic+beat.1st">beat.1st</a>). 
In fact, considering the same sample size, increasing the MINIMUM, less PSU will be involved in the sample, but worst estimates in term of expected coefficient of variations will be provided.
On the contrary, decreasing the MINIMUM, more PSU will be involved in the sample and better estimates will be obtained.
Instead, increasing the MINIMUM for obtaining the same expected errors, requests less PSU, but much more SSU. The contrary occurs decreasing the MINIMUM.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
# Load example data
data(beat.example)
design
str(design)

## End(Not run)
</code></pre>

<hr>
<h2 id='effst'>
Estimator effect
</h2><span id='topic+effst'></span>

<h3>Description</h3>

<p>Example data frame containing estimator effect, (<code class="reqn">effst</code>), in each stratum for each variable.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(beat.example)
</code></pre>


<h3>Format</h3>

<p>The estimator effect data frame contains a row per each stratum with the following variables: 
</p>

<dl>
<dt>STRATUM</dt><dd>
<p>Identifier of the stratum (numeric).
</p>
</dd> 
<dt>EFFST1</dt><dd>
<p>Estimator effect in the stratum of the first variable (numeric).
</p>
</dd>
<dt>EFFSTj</dt><dd>
<p>Estimator effect in the stratum of the j-th variable (numeric).
</p>
</dd>
<dt>EFFSTn</dt><dd>
<p>Estimator effect in the stratum of the last variable (numeric).
</p>
</dd>
</dl>



<h3>Details</h3>

<p>Note: the names of the variables must be the ones indicated above.
</p>
<p>The estimator effect, (<code class="reqn">effst</code>), provides a measure of the variance inflaction or reduction due to the use of a different estimator from the HT (Horvitz and Thompson, 1952).
It is equal to the ratio between the sampling variance of the estimator planned to be used and the sampling variance  of the HT. 
</p>
<p>Then, when the HT is used, (<code class="reqn">effst</code>) is equal to 1. 
However, always more often, different estimators, such as calibration estimator (Deville and Särndal, 1992) or generalized regression estimator GREG (Fuller, 2002 and references therein), are used.
Usually this kind of estimators take into account auxiliary variables that enables to increase the accuracy of the estimates, that is, they reduce their errors (CV). Then, their <code class="reqn">effst</code> is usually lower than 1.
</p>
<p>Therefore, taking into account the estimator effect when planning the survey can help in saving sample size or at least to more properly evatuate the allocation.  
</p>


<h3>References</h3>

<p>Deville, J.C., Särndal, C.E. (1992). 
Calibration estimators in survey sampling. 
<em>Journal of the American statistical Association</em>, 87(418): 376-38.
</p>
<p>Fuller, W.A.. (2002). 
Regression estimation for survey samples.
Survey Methodology 28(1): 5-23.
</p>
<p>Horvitz, D.G., Thompson, D.J. (1952) 
A generalization of sampling without replacement from a finite universe. 
<em>Journal of the American statistical Association</em>, 47(260): 663-685.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
# Load example data
data(beat.example)
effst
str(effst)

## End(Not run)
</code></pre>

<hr>
<h2 id='errors'>
Precision constraints (maximum CVs) as input for Bethel allocation
</h2><span id='topic+errors'></span>

<h3>Description</h3>

<p>Example data frame containing precision levels (expressed in terms of acceptable CV's).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(beat.example)
</code></pre>


<h3>Format</h3>

<p>The constraint data frame (errors) contains a row per each type of domain with the following variables:
</p>

<dl>
<dt>DOM</dt><dd><p>Type of domain code (factor).</p>
</dd> 
<dt>CV1</dt><dd><p>Planned coefficient of variation for first variable (numeric).</p>
</dd> 
<dt>CVj</dt><dd><p>Planned coefficient of variation for j-th variable (numeric).</p>
</dd>
<dt>CVn</dt><dd><p>Planned coefficient of variation for last variable (numeric).</p>
</dd> 
</dl>



<h3>Details</h3>

<p>Note: the names of the variables must be the ones indicated above.
</p>
<p>The coefficient of variation (CV) is a standardized measure of variance. 
It is often expressed as a percentage and is defined as the ratio between the standard deviation of the estimate and the estimate (or its absolute value). 
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
# Load example data
data(beat.example)
errors
str(errors)

## End(Not run)
</code></pre>

<hr>
<h2 id='eval_2stage'>
Evaluation of the two-stage sample design optimized solution by simulation
</h2><span id='topic+eval_2stage'></span>

<h3>Description</h3>

<p>The user can indicate the number of samples that must be selected by the optimized frame. First, the true values of the parameters are calculated from the frame. Then, for each sample the sampling estimates are calculated, together with the differences between them and the true values of the parameters.
At the end, an estimate of the CV is produced for each target variable, in order to compare them
with the precision constraints set at the beginning of the optimization process.
If the flag 'writeFiles' is set to TRUE, boxplots of distribution of the CV's in the different 
domains are produced for each Y variable ('cv.pdf'),
together with boxplot of the distributions of differences between estimates and values of the parameters
in the population ('differences.pdf').
</p>


<h3>Usage</h3>

<pre><code class='language-R'>eval_2stage(df,
            PSU_code,
            SSU_code,
            domain_var,
            target_vars,
            PSU_sampled,
            nsampl = 100, 
            writeFiles = TRUE) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="eval_2stage_+3A_df">df</code></td>
<td>

<p>The sampling frame.
</p>
</td></tr>
<tr><td><code id="eval_2stage_+3A_psu_code">PSU_code</code></td>
<td>

<p>In the sampling frame, the identifier of the PSU.
</p>
</td></tr>
<tr><td><code id="eval_2stage_+3A_ssu_code">SSU_code</code></td>
<td>

<p>In the sampling frame, the identifier of the SSU.
</p>
</td></tr>
<tr><td><code id="eval_2stage_+3A_domain_var">domain_var</code></td>
<td>

<p>In the sampling frame, the identifier of the domain of interest for the estimates.
</p>
</td></tr>
<tr><td><code id="eval_2stage_+3A_target_vars">target_vars</code></td>
<td>

<p>In the sampling frame, the variables used to produce the target estimates.
</p>
</td></tr>
<tr><td><code id="eval_2stage_+3A_psu_sampled">PSU_sampled</code></td>
<td>

<p>The set of selected PSUs.
</p>
</td></tr>
<tr><td><code id="eval_2stage_+3A_nsampl">nsampl</code></td>
<td>

<p>The number of samples to be drawn from the frame.
</p>
</td></tr>
<tr><td><code id="eval_2stage_+3A_writefiles">writeFiles</code></td>
<td>

<p>A flag to write in the work directory the outputs of the function. Default is TRUE.
</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list containing (i) the CV distribution in the domains, (ii) the bias distribution in the domains, (iii) the dataframe containing the sampling
estimates by domain
</p>


<h3>Author(s)</h3>

<p>Giulio Barcaroli
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(readr)
pop &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/pop.RDS?raw=true")
library(R2BEAT)
cv &lt;- as.data.frame(list(DOM=c("DOM1","DOM2"),
                         CV1=c(0.02,0.03),
                         CV2=c(0.03,0.05),
                         CV3=c(0.03,0.05),
                         CV4=c(0.05,0.08)))
samp_frame &lt;- pop
id_PSU &lt;- "municipality"  
id_SSU &lt;- "id_ind"        
strata_var &lt;- "stratum"   
target_vars &lt;- c("income_hh","active","inactive","unemployed")   # more than one
deff_var &lt;- "stratum"     
domain_var &lt;- "region"  
delta =  1     # households = survey units
minimum &lt;- 50  # minimum number of SSUs to be interviewed in each selected PSU
deff_sugg &lt;- 1.5  # suggestion for the deff value
inp &lt;- prepareInputToAllocation1(samp_frame,
                                id_PSU,
                                id_SSU,
                                strata_var,
                                target_vars,
                                deff_var,
                                domain_var,
                                minimum,
                                delta,
                                deff_sugg)
inp$desfile$MINIMUM &lt;- 50
alloc &lt;- beat.2st(stratif = inp$strata, 
                  errors = cv, 
                  des_file = inp$des_file, 
                  psu_file = inp$psu_file, 
                  rho = inp$rho, 
                  deft_start = NULL,
                  effst = inp$effst, 
                  minPSUstrat = 2,
                  minnumstrat = 50
                  )
sample_1st &lt;- select_PSU(alloc, type="ALLOC", pps=TRUE)

df=pop
df$one &lt;- 1
PSU_code="municipality"
SSU_code="id_ind"
target_vars &lt;- c("income_hh",
                 "active",
                 "inactive",
                 "unemployed")  

PSU_sampled &lt;- sample_1st$sample_PSU
eval &lt;- eval_2stage(df,
                    PSU_code,
                    SSU_code,
                    domain_var,
                    target_vars,
                    PSU_sampled,
                    nsampl=10, 
                    writeFiles=TRUE) 
eval$coeff_var
eval$rel_bias

## End(Not run)
</code></pre>

<hr>
<h2 id='input_to_beat.2st_1'>
Input dataframes for R2BEAT two-stages sample design (when a previous round of the survey is available, but no sampling frame)
</h2><span id='topic+input_to_beat.2st_1'></span>

<h3>Description</h3>

<p>Prepares the following input dataframes for R2BEAT two-stages sample design starting from ReGenesees design and/or calibrated objects:
1. strata
2. deff
3. effst
4. rho
</p>


<h3>Usage</h3>

<pre><code class='language-R'>     input_to_beat.2st_1(RGdes,
                        RGcal,
                        id_PSU,
                        id_SSU,
                        strata_vars,
                        target_vars,
                        deff_vars,
                        domain_vars)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="input_to_beat.2st_1_+3A_rgdes">RGdes</code></td>
<td>
<p>ReGenesees design object.</p>
</td></tr>
<tr><td><code id="input_to_beat.2st_1_+3A_rgcal">RGcal</code></td>
<td>
<p>ReGenesees calibrated object.</p>
</td></tr>
<tr><td><code id="input_to_beat.2st_1_+3A_id_psu">id_PSU</code></td>
<td>
<p>variables used as identifiers in ReGenesees objects.</p>
</td></tr>
<tr><td><code id="input_to_beat.2st_1_+3A_id_ssu">id_SSU</code></td>
<td>
<p>variables used as identifiers in ReGenesees objects.</p>
</td></tr>
<tr><td><code id="input_to_beat.2st_1_+3A_strata_vars">strata_vars</code></td>
<td>
<p>stratification variables used in ReGenesees objects.</p>
</td></tr>
<tr><td><code id="input_to_beat.2st_1_+3A_target_vars">target_vars</code></td>
<td>
<p>target variables.</p>
</td></tr>
<tr><td><code id="input_to_beat.2st_1_+3A_deff_vars">deff_vars</code></td>
<td>
<p>stratification variables to be used when calculating deff.</p>
</td></tr>
<tr><td><code id="input_to_beat.2st_1_+3A_domain_vars">domain_vars</code></td>
<td>
<p>the variables used to identify the domain of interest.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Giulio Barcaroli</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(readr)
des &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/des.rds?raw=true")
cal &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/cal.rds?raw=true")

library(R2BEAT)
RGdes &lt;- des                           # ReGenesees design object
RGcal &lt;- cal                           # ReGenesees calibrated object
strata_vars &lt;- c("stratum")            # variables of stratification
target_vars &lt;- c("income_hh",
                 "active",
                 "inactive",
                 "unemployed")         # target variables
deff_vars &lt;- "stratum"    # stratification variables for calculating deff and effst 
                          # (n.b: must coincide or be a subset of variables of stratification)
id_PSU &lt;- c("municipality")            # identification variable of PSUs
id_SSU &lt;- c("id_hh")                   # identification variable of SSUs
domain_vars &lt;- c("region")             # domain variables
inp1 &lt;- input_to_beat.2st_1(RGdes,
                            RGcal,
                            id_PSU,
                            id_SSU,
                            strata_vars,
                            target_vars,
                            deff_vars,
                            domain_vars)							
inp1$strata
inp1$deff
inp1$effst
inp1$rho

## End(Not run)
</code></pre>

<hr>
<h2 id='input_to_beat.2st_2'>
Prepares the design and psu file for two-stage sample design (when a previous round of the survey is available, but no sampling frame)
</h2><span id='topic+input_to_beat.2st_2'></span>

<h3>Description</h3>

<p>Prepares the design file for two-stage sample design on the basis of a dataset containing information on each PSU
</p>


<h3>Usage</h3>

<pre><code class='language-R'>     input_to_beat.2st_2(psu,psu_id,stratum_var,mos_var,delta,minimum)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="input_to_beat.2st_2_+3A_psu">psu</code></td>
<td>
<p>Dataframe containing information on each PSU.</p>
</td></tr>
<tr><td><code id="input_to_beat.2st_2_+3A_psu_id">psu_id</code></td>
<td>
<p>Identifier of each PSU in PSU dataframe.</p>
</td></tr>
<tr><td><code id="input_to_beat.2st_2_+3A_stratum_var">stratum_var</code></td>
<td>
<p>Identifier of stratum in PSU dataframe.</p>
</td></tr>
<tr><td><code id="input_to_beat.2st_2_+3A_mos_var">mos_var</code></td>
<td>
<p>Variable containing the number of selection units in each PSU.</p>
</td></tr>
<tr><td><code id="input_to_beat.2st_2_+3A_delta">delta</code></td>
<td>
<p>Average number of final number of SSU per each selection unit.</p>
</td></tr>
<tr><td><code id="input_to_beat.2st_2_+3A_minimum">minimum</code></td>
<td>
<p>Minimum number of selection units to be interviewed in each PSU.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Giulio Barcaroli</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(readr)
psu &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/psu.rds?raw=true")
head(psu)
library(R2BEAT)
psu_id="municipality"        # Identifier of the PSU
stratum_var="stratum"        # Identifier of the stratum
mos_var="ind"                # Variable to be used as 'measure of size'
delta=1                      # Average number of SSUs for each selection unit
minimum &lt;- 50                # Minimum number of SSUs to be selected in each PSU
inp2 &lt;- input_to_beat.2st_2(psu,
                            psu_id,
                            stratum_var,
                            mos_var,
                            delta,
                            minimum)
head(inp2$psu_file)
head(inp2$des_file)

## End(Not run)
</code></pre>

<hr>
<h2 id='plot_sens'>
Plot of the sensitivity analysis for some parameters by means of grid search 
</h2><span id='topic+plot_sens'></span>

<h3>Description</h3>

<p>This function allows to plot the results of the simulation carried out by using the function 'sensitivity'.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>plot_sens ( 
  x,
  min,
  max) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="plot_sens_+3A_x">x</code></td>
<td>
<p>The result of the 'sensitivity' function.</p>
</td></tr>
<tr><td><code id="plot_sens_+3A_min">min</code></td>
<td>
<p>minimum value of the parameter.</p>
</td></tr>
<tr><td><code id="plot_sens_+3A_max">max</code></td>
<td>
<p>maximum value of the parameter.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list containing the (i) vector of allocated PSUs in the iterations and (ii) the vector of allocated SSUs in the iterations
</p>


<h3>Author(s)</h3>

<p>Giulio Barcaroli</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(readr)
pop &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/pop.RDS?raw=true")
library(R2BEAT)
cv &lt;- as.data.frame(list(DOM=c("DOM1","DOM2"),
                         CV1=c(0.02,0.03),
                         CV2=c(0.03,0.05),
                         CV3=c(0.03,0.05),
                         CV4=c(0.04,0.08)))
cv
# parameters
samp_frame &lt;- pop
errors &lt;- cv
id_PSU &lt;- "municipality"  
id_SSU &lt;- "id_ind"        
strata_var &lt;- "stratum"  
target_vars &lt;- c("income_hh","active","inactive","unemployed")   # more than one
deff_var &lt;- "stratum"        
domain_var &lt;- "region"        
minimum &lt;- 50 # minimum number of SSUs to be interviewed in each selected PSU
# average dimension of the SSU in terms of elementary survey units
#delta =  nrow(pop) /length(unique(pop$id_hh))     
delta =  1  # average dimension of the SSU in terms of elementary survey units
deff_sugg &lt;- 1.5
min &lt;- 30
max &lt;- 80
sens &lt;- sensitivity_min_SSU (
  samp_frame,
  errors,
  id_PSU,
  id_SSU,
  strata_var,
  target_vars,
  deff_var,
  domain_var,
  minimum,
  delta,
  deff_sugg,
  min,
  max)
plot_sens(sens,min,max)

## End(Not run)
</code></pre>

<hr>
<h2 id='prepareInputToAllocation1'>
Input dataframes for R2BEAT two-stages sample design when sampling frame is available
</h2><span id='topic+prepareInputToAllocation1'></span>

<h3>Description</h3>

<p>In case of scenario 1 (no previous round of the survey available), prepares the following input dataframes for R2BEAT two-stages sample design starting from the sampling frame:
1. strata
2. deff
3. effst
4. rho
5. PSU_file
6. des_file
</p>


<h3>Usage</h3>

<pre><code class='language-R'>prepareInputToAllocation1 ( 
  samp_frame,
  id_PSU,
  id_SSU,
  strata_var,
  target_vars,
  deff_var,
  domain_var,
  minimum,
  delta,
  deff_sugg) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="prepareInputToAllocation1_+3A_samp_frame">samp_frame</code></td>
<td>
<p>The dataframe containing sampling units in the reference population.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation1_+3A_id_psu">id_PSU</code></td>
<td>
<p>variables used as identifiers in sampling frame.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation1_+3A_id_ssu">id_SSU</code></td>
<td>
<p>variables used as identifiers in sampling frame.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation1_+3A_strata_var">strata_var</code></td>
<td>
<p>stratification variable used in sampling frame.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation1_+3A_target_vars">target_vars</code></td>
<td>
<p>target variables.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation1_+3A_deff_var">deff_var</code></td>
<td>
<p>stratification variable to be used when calculating deff.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation1_+3A_domain_var">domain_var</code></td>
<td>
<p>the variable used to identify the domain of interest.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation1_+3A_minimum">minimum</code></td>
<td>
<p>minimum number of SSU to be selected from a PSU.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation1_+3A_delta">delta</code></td>
<td>
<p>average number of analysis units per sampling unit.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation1_+3A_deff_sugg">deff_sugg</code></td>
<td>
<p>suggested value of the deff.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list containing  (i) the vector of allocated PSUs in the iterations and (ii) the vector of allocated SSUs in the iterations
</p>


<h3>Author(s)</h3>

<p>Giulio Barcaroli</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(readr)
pop &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/pop.RDS?raw=true")
library(R2BEAT)
# parameters
samp_frame &lt;- pop
id_PSU &lt;- "municipality"  
id_SSU &lt;- "id_ind"        
strata_var &lt;- "stratum"  
target_vars &lt;- c("income_hh","active","inactive","unemployed") 
deff_var &lt;- "stratum"        
domain_var &lt;- "region"        
minimum &lt;- 50 # minimum number of SSUs to be interviewed in each selected PSU
# average dimension of the SSU in terms of elementary survey units
# delta =  nrow(pop) /length(unique(pop$id_hh))     
delta =  1     
deff_sugg &lt;- 1.5
# prepare inputs
inp &lt;- prepareInputToAllocation1(samp_frame,
                                 id_PSU,
                                 id_SSU,
                                 strata_var,
                                 target_vars,
                                 deff_var,
                                 domain_var,
                                 minimum,
                                 delta,
                                 deff_sugg)

## End(Not run)
</code></pre>

<hr>
<h2 id='prepareInputToAllocation2'>
Input dataframes for R2BEAT two-stages sample design when both sampling frame and a previous round of the survey are available
</h2><span id='topic+prepareInputToAllocation2'></span>

<h3>Description</h3>

<p>In case of scenario 2 (at least one previous round of the survey available), prepares the following input dataframes for R2BEAT two-stages sample design starting from the sampling frame:
1. strata
2. deff
3. effst
4. rho
5. PSU_file
6. des_file
</p>


<h3>Usage</h3>

<pre><code class='language-R'>prepareInputToAllocation2 ( 
  samp_frame,
  RGdes, 
  RGcal, 
  id_PSU, 
  id_SSU, 
  strata_var, 
  target_vars, 
  deff_var, 
  domain_var,
  delta,
  minimum) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="prepareInputToAllocation2_+3A_samp_frame">samp_frame</code></td>
<td>
<p>The dataframe containing sampling units in the reference population.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation2_+3A_rgdes">RGdes</code></td>
<td>
<p>The 'design' ReGenesees object.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation2_+3A_rgcal">RGcal</code></td>
<td>
<p>The 'calibration' ReGenesees object.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation2_+3A_id_psu">id_PSU</code></td>
<td>
<p>variables used as identifiers in sampling frame.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation2_+3A_id_ssu">id_SSU</code></td>
<td>
<p>variables used as identifiers in sampling frame.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation2_+3A_strata_var">strata_var</code></td>
<td>
<p>stratification variable used in sampling frame.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation2_+3A_target_vars">target_vars</code></td>
<td>
<p>target variables.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation2_+3A_deff_var">deff_var</code></td>
<td>
<p>stratification variable to be used when calculating deff.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation2_+3A_domain_var">domain_var</code></td>
<td>
<p>the variable used to identify the domain of interest.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation2_+3A_delta">delta</code></td>
<td>
<p>average number of analysis units per sampling unit.</p>
</td></tr>
<tr><td><code id="prepareInputToAllocation2_+3A_minimum">minimum</code></td>
<td>
<p>minimum number of SSU to be selected from a PSU.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list containing: (1) strata, (2) deff, (3) effst, (4) rho, (5) PSU_file, (6) des_file
</p>


<h3>Author(s)</h3>

<p>Giulio Barcaroli</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(readr)
samp &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/sample.rds?raw=true")
pop &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/pop.RDS?raw=true")
library(R2BEAT)
str(samp)
## Sample design description
library(ReGenesees)
samp$stratum_2 &lt;- as.factor(samp$stratum_2)
sample.des &lt;- e.svydesign(samp, 
                          ids= ~ municipality + id_hh, 
                          strata = ~ stratum_2, 
                          weights = ~ weight,
                          self.rep.str = ~ SR,
                          check.data = TRUE)
## Find and collapse lonely strata
ls &lt;- find.lon.strata(sample.des)
if (!is.null(ls)) sample.des &lt;- collapse.strata(sample.des)
## Calibration with known totals
totals &lt;- pop.template(sample.des,
             calmodel = ~ sex : cl_age, 
             partition = ~ region)
totals &lt;- fill.template(pop, totals, mem.frac = 10)
sample.cal &lt;- e.calibrate(sample.des, 
                          totals,
                          calmodel = ~ sex : cl_age, 
                          partition = ~ region,
                          calfun = "logit",
                          bounds = c(0.3, 2.6), 
                          aggregate.stage = 2,
                          force = FALSE)
samp_frame &lt;- pop
RGdes &lt;- sample.des
RGcal &lt;- sample.cal
strata_var &lt;- c("stratum")      
target_vars &lt;- c("income_hh",
                 "active",
                 "inactive",
                 "unemployed")   
weight_var &lt;- "weight"
deff_var &lt;- "stratum"            
id_PSU &lt;- c("municipality")      
id_SSU &lt;- c("id_hh")             
domain_var &lt;- c("region") 
delta &lt;- 1                   
minimum &lt;- 50     
inp &lt;- prepareInputToAllocation2 ( 
  samp_frame,
  RGdes, 
  RGcal, 
  id_PSU, 
  id_SSU, 
  strata_var, 
  target_vars, 
  deff_var, 
  domain_var,
  delta,
  minimum) 
head(inp$strata)
head(inp$deff)
head(inp$effst)
head(inp$rho)
head(inp$psu_file)
head(inp$des_file)

## End(Not run)
</code></pre>

<hr>
<h2 id='PSU_strat'>
Information on Primary Stage Units (PSUs) stratification   
</h2><span id='topic+PSU_strat'></span>

<h3>Description</h3>

<p>Example data frame containing information on Primary Stage Units (PSUs) stratification.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(beat.example)
</code></pre>


<h3>Format</h3>

<p>The PSU_strat data frame contains a row for each Primary Stage Units (PSUs) with the following variables: 
</p>

<dl>
<dt>STRATUM</dt><dd>
<p>Identifier of the stratum (numeric)
</p>
</dd> 
<dt>PSU_MOS</dt><dd>
<p>Measure of size of the primary stage unit (numeric)
</p>
</dd> 
<dt>PSU_ID</dt><dd>
<p>Identifier of the primary stage unit (numeric)
</p>
</dd> 
</dl>



<h3>Details</h3>

<p>Note: the names of the variables must be the ones indicated above.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
# Load example data
data(beat.example)
PSU_strat
str(PSU_strat)

## End(Not run)
</code></pre>

<hr>
<h2 id='rho'>
Intraclass correlation coefficients for self and non self representative in the strata
</h2><span id='topic+rho'></span>

<h3>Description</h3>

<p>Example data frame containing intraclass correlation <code class="reqn">\rho</code> in Self Representative (SR) and Non Self Representative (NSR) strata.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(beat.example)
</code></pre>


<h3>Format</h3>

<p>The intraclass correlation coefficienta (<code class="reqn">\rho</code>) data frame contains a row per each stratum with the following variables: 
</p>

<dl>
<dt>STRATUM</dt><dd>
<p>Identifier of the stratum (numeric)
</p>
</dd> 
<dt>RHO_AR1</dt><dd>
<p>intraclass correlation of the elementary units for each primary stage unit of the self representing area belonging to the stratum for the first variable. 
</p>
</dd>
<dt>RHO_ARj</dt><dd>
<p>intraclass correlation of the elementary units for each primary stage unit of the self representing area belonging to the stratum for the j-th variable. 
</p>
</dd>
<dt>RHO_ARn</dt><dd>
<p>intraclass correlation of the elementary units for each primary stage unit of the self representing area belonging to the stratum for the n-th variable.
</p>
</dd>
<dt>RHO_NAR1</dt><dd>
<p>intraclass correlation of the elementary units for each primary stage unit of the non self representing area belonging to the stratum for the first variable. 
</p>
</dd>
<dt>RHO_NARj</dt><dd>
<p>intraclass correlation of the elementary units for each primary stage unit of the non self representing area belonging to the stratum for the j-th variable. 
</p>
</dd>
<dt>RHO_NARn</dt><dd>
<p>intraclass correlation of the elementary units for each primary stage unit of the non self representing area belonging to the stratum for the n-th variable. 
</p>
</dd>
</dl>



<h3>Details</h3>

<p>Note: the names of the variables must be the ones indicated above.
</p>
<p>Intraclass correlation, <code class="reqn">\rho</code>, provide a measure of the cluster heterogeneity and they have a direct impact on the design effect (<a href="#topic+design">design</a>).
It can be indirectly computed from the design effect and the average minimum number of interviews in the Primary Stage Units (PSUs). 
The ideal situation is when all the clusters in which the population is divided are more heterogeneous possible within them. 
At the limit, if each cluster were a reduced copy of the population then it would be sufficient to extract one just to have the same information that would be obtained from a complete survey.
Then, more similar the units in the cluster are, higher the sample size must be (Cochran, 1977, Chapter 8).
</p>
<p>By definition, in SR strata <code class="reqn">\rho</code>, is equal to 1, because there is just a single PSU in SR strata.
In NSR strata usually, <code class="reqn">\rho</code> is usual higher than 1, because a double stage of selection is needed. 
</p>


<h3>References</h3>

<p>Cochran, W. (1977) 
<em>Sampling Techniques.</em> 
John Wiley &amp; Sons, Inc., New York.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
# Load example data
data(beat.example)
rho
str(rho)

## End(Not run)
</code></pre>

<hr>
<h2 id='select_PSU'>
Select sample of primary stage units (PSU)
</h2><span id='topic+select_PSU'></span>

<h3>Description</h3>

<p>Select sample of primary stage units (PSU) on the basis of the PSU allocated in the allocation step.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>     select_PSU(alloc, type="ALLOC", pps=TRUE, plot=TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="select_PSU_+3A_alloc">alloc</code></td>
<td>
<p>Output of the allocation step (beat.st)</p>
</td></tr>
<tr><td><code id="select_PSU_+3A_type">type</code></td>
<td>
<p>Type of SSU allocation (&quot;ALLOC&quot; = optimal, &quot;PROP&quot; = proportional to population size, &quot;EQUAL&quot; = equal size in each stratum)</p>
</td></tr>
<tr><td><code id="select_PSU_+3A_pps">pps</code></td>
<td>
<p>Type of PSU selection in strata (pps = TRUE &ndash;&gt; proportional to size, pps= FALSE&ndash;&gt; simple random sampling)</p>
</td></tr>
<tr><td><code id="select_PSU_+3A_plot">plot</code></td>
<td>
<p>If TRUE, a plot of PSUs and SSUs ditribution is produced</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list including: universe_PSU, sample_PSU
</p>


<h3>Author(s)</h3>

<p>Alessio Guandalini</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(readr)
pop &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/pop.RDS?raw=true")
library(R2BEAT)
cv &lt;- as.data.frame(list(DOM=c("DOM1","DOM2"),
                         CV1=c(0.02,0.03),
                         CV2=c(0.03,0.06),
                         CV3=c(0.03,0.06),
                         CV4=c(0.05,0.08)))
cv
samp_frame &lt;- pop
samp_frame$one &lt;- 1
id_PSU &lt;- "municipality"  
id_SSU &lt;- "id_ind"        
strata_var &lt;- "stratum"   
target_vars &lt;- c("income_hh","active","inactive","unemployed")   
deff_var &lt;- "stratum"     
domain_var &lt;- "region"  
delta =  1       # households = survey units
minimum &lt;- 50    # minimum number of SSUs to be interviewed in each selected PSU
deff_sugg &lt;- 1.5 # suggestion for the deff value

inp &lt;- prepareInputToAllocation1(samp_frame,
                                  id_PSU,
                                  id_SSU,
                                  strata_var,
                                  target_vars,
                                  deff_var,
                                  domain_var,
                                  minimum,
                                  delta,
                                  deff_sugg)
inp$desfile$MINIMUM &lt;- 50
alloc &lt;- beat.2st(stratif = inp$strata, 
                   errors = cv, 
                   des_file = inp$des_file, 
                   psu_file = inp$psu_file, 
                   rho = inp$rho, 
                   deft_start = NULL,
                   effst = inp$effst, 
                   minPSUstrat = 2,
                   minnumstrat = 50
)
sample_1st &lt;- select_PSU(alloc, type="ALLOC", pps=TRUE, plot=TRUE)
sample_1st$PSU_stats

## End(Not run)
</code></pre>

<hr>
<h2 id='select_PSU2'>
Select sample of primary stage units (PSU)
</h2><span id='topic+select_PSU2'></span>

<h3>Description</h3>

<p>Select sample of primary stage units (PSU) on the basis of the PSU allocated in the allocation step. This function differs from 'selectPSU' in that PSUs are not organized in sub-strata, but directly sampled with probability proportional to size in each sampling stratum.
It also allows an implicit stratification by giving a set of ordering variables for each PSU.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>     select_PSU2(alloc, 
     type="ALLOC", 
     var_ord=NULL, 
     des_file=des_file,
     psu_file = psu_file)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="select_PSU2_+3A_alloc">alloc</code></td>
<td>
<p>Output of the allocation step (beat.st)</p>
</td></tr>
<tr><td><code id="select_PSU2_+3A_type">type</code></td>
<td>
<p>Type of SSU allocation (&quot;ALLOC&quot; = optimal, &quot;PROP&quot; = proportional to population size, &quot;EQUAL&quot; = equal size in each stratum)</p>
</td></tr>
<tr><td><code id="select_PSU2_+3A_var_ord">var_ord</code></td>
<td>
<p>dataframe containing for all PSUs a set of variables to be used to order the PSUs</p>
</td></tr>
<tr><td><code id="select_PSU2_+3A_des_file">des_file</code></td>
<td>
<p>dataframe containing information on sampling strata</p>
</td></tr>
<tr><td><code id="select_PSU2_+3A_psu_file">psu_file</code></td>
<td>
<p>dataframe containing the list of Primary Sampling Units</p>
</td></tr>
</table>


<h3>Value</h3>

<p>list containing: (i) information on sampled PSUs (ii) list of selected PSUs
</p>


<h3>Author(s)</h3>

<p>Giulio Barcaroli</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(readr)
pop &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/pop.RDS?raw=true")
library(R2BEAT)
cv &lt;- as.data.frame(list(DOM=c("DOM1","DOM2"),
                         CV1=c(0.02,0.03),
                         CV2=c(0.03,0.06),
                         CV3=c(0.03,0.06),
                         CV4=c(0.05,0.08)))
cv
samp_frame &lt;- pop
samp_frame$one &lt;- 1
id_PSU &lt;- "municipality"  
id_SSU &lt;- "id_ind"        
strata_var &lt;- "stratum"   
target_vars &lt;- c("income_hh","active","inactive","unemployed")   
deff_var &lt;- "stratum"     
domain_var &lt;- "region"  
delta =  1       # households = survey units
minimum &lt;- 50    # minimum number of SSUs to be interviewed in each selected PSU
deff_sugg &lt;- 1.5 # suggestion for the deff value

inp &lt;- prepareInputToAllocation1(samp_frame,
                                 id_PSU,
                                 id_SSU,
                                 strata_var,
                                 target_vars,
                                 deff_var,
                                 domain_var,
                                 minimum,
                                 delta,
                                 deff_sugg)
inp$desfile$MINIMUM &lt;- 50
alloc &lt;- beat.2st(stratif = inp$strata, 
                  errors = cv, 
                  des_file = inp$des_file, 
                  psu_file = inp$psu_file, 
                  rho = inp$rho, 
                  deft_start = NULL,
                  effst = inp$effst, 
                  minPSUstrat = 2,
                  minnumstrat = 50
)
sample_1st &lt;- select_PSU2(alloc, type="ALLOC", var_ord=NULL, des_file=des_file)
head(sample_1st)

## End(Not run)
</code></pre>

<hr>
<h2 id='select_SSU'>
Select sample of secondary stage units (SSU)
</h2><span id='topic+select_SSU'></span>

<h3>Description</h3>

<p>Select sample of secondary stage units (SSU) from the population frame on the basis of the SSU allocated to each selected PSU
</p>


<h3>Usage</h3>

<pre><code class='language-R'>     select_SSU(df,PSU_code,SSU_code,PSU_sampled)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="select_SSU_+3A_df">df</code></td>
<td>
<p>Dataframe containing sampling units (SSUs)</p>
</td></tr>
<tr><td><code id="select_SSU_+3A_psu_code">PSU_code</code></td>
<td>
<p>Identifier of each PSU in dataframe containing sampling units</p>
</td></tr>
<tr><td><code id="select_SSU_+3A_ssu_code">SSU_code</code></td>
<td>
<p>Identifier of each SSU in dataframe containing sampling units</p>
</td></tr>
<tr><td><code id="select_SSU_+3A_psu_sampled">PSU_sampled</code></td>
<td>
<p>Dataframe containing selected PSUs</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A dataframe containing the units selected in the sample
</p>


<h3>Author(s)</h3>

<p>Giulio Barcaroli</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(readr)
pop &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/pop.RDS?raw=true")
library(R2BEAT)
cv &lt;- as.data.frame(list(DOM=c("DOM1","DOM2"),
                         CV1=c(0.02,0.03),
                         CV2=c(0.03,0.06),
                         CV3=c(0.03,0.06),
                         CV4=c(0.05,0.08)))
cv
samp_frame &lt;- pop
samp_frame$one &lt;- 1
id_PSU &lt;- "municipality"  
id_SSU &lt;- "id_ind"        
strata_var &lt;- "stratum"   
target_vars &lt;- c("income_hh","active","inactive","unemployed")   
deff_var &lt;- "stratum"     
domain_var &lt;- "region"  
delta =  1       # households = survey units
minimum &lt;- 50    # minimum number of SSUs to be interviewed in each selected PSU
deff_sugg &lt;- 1.5 # suggestion for the deff value

inp &lt;- prepareInputToAllocation1(samp_frame,
                                  id_PSU,
                                  id_SSU,
                                  strata_var,
                                  target_vars,
                                  deff_var,
                                  domain_var,
                                  minimum,
                                  delta,
                                  deff_sugg)
inp$desfile$MINIMUM &lt;- 50
alloc &lt;- beat.2st(stratif = inp$strata, 
                   errors = cv, 
                   des_file = inp$des_file, 
                   psu_file = inp$psu_file, 
                   rho = inp$rho, 
                   deft_start = NULL,
                   effst = inp$effst, 
                   minPSUstrat = 2,
                   minnumstrat = 50
)
sample_1st &lt;- select_PSU(alloc, type="ALLOC", pps=TRUE, plot=TRUE)
samp &lt;- select_SSU(df=pop,
                   PSU_code="municipality",
                   SSU_code="id_ind",
                   PSU_sampled=sample_1st$sample_PSU)

## End(Not run)
</code></pre>

<hr>
<h2 id='sens_names'>
Function for better presentation of sensitivity information
</h2><span id='topic+sens_names'></span>

<h3>Description</h3>

<p>This function allows to obtain a better presentation of sensitivity information, i.e. with the names of the variables and of the domains
</p>


<h3>Usage</h3>

<pre><code class='language-R'>sens_names(s,target_vars,strata)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="sens_names_+3A_s">s</code></td>
<td>
<p>The sensitivity output of the allocation step.</p>
</td></tr>
<tr><td><code id="sens_names_+3A_target_vars">target_vars</code></td>
<td>
<p>target variables.</p>
</td></tr>
<tr><td><code id="sens_names_+3A_strata">strata</code></td>
<td>
<p>strata dataframe used in the allocation step..</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A dataframe containing Sensitivity information
</p>


<h3>Author(s)</h3>

<p>Giulio Barcaroli</p>

<hr>
<h2 id='sensitivity_min_SSU'>
Sensitivity analysis for choosing minimum number of SSUs per PSU (sampling frame available)
</h2><span id='topic+sensitivity_min_SSU'></span>

<h3>Description</h3>

<p>This function allows to analyse the different results in terms 
of first stage size (number of PSUs) and second stage size (number of SSUs),
when varying the values of the minimum number of SSU per single PSU)
The name of the parameter has to be given, together with the minimum and
maximum value. On the basis of these minimum and maximum values, 10 different values will be used for carrying out the allocation.
The output will be a graphical one.
To be used only in the scenario when no previous rounds of the survey are 
available, and a frame complete with values of target variables is available.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>sensitivity_min_SSU (samp_frame, 
                     errors, 
                     id_PSU, 
                     id_SSU, 
                     strata_var, 
                     target_vars, 
                     deff_var, 
                     domain_var, 
                     delta, 
                     deff_sugg,
                     min, 
                     max, 
                     plot) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="sensitivity_min_SSU_+3A_samp_frame">samp_frame</code></td>
<td>
<p>The dataframe containing sampling units in the reference population.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU_+3A_errors">errors</code></td>
<td>
<p>Precision constraints.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU_+3A_id_psu">id_PSU</code></td>
<td>
<p>variables used as identifiers in sampling frame.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU_+3A_id_ssu">id_SSU</code></td>
<td>
<p>variables used as identifiers in sampling frame.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU_+3A_strata_var">strata_var</code></td>
<td>
<p>stratification variable used in sampling frame.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU_+3A_target_vars">target_vars</code></td>
<td>
<p>target variables.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU_+3A_deff_var">deff_var</code></td>
<td>
<p>stratification variable to be used when calculating deff.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU_+3A_domain_var">domain_var</code></td>
<td>
<p>the variable used to identify the domain of interest.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU_+3A_delta">delta</code></td>
<td>
<p>average number of analysis units per sampling unit.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU_+3A_deff_sugg">deff_sugg</code></td>
<td>
<p>suggestion for deff value.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU_+3A_min">min</code></td>
<td>
<p>minimum value of the parameter.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU_+3A_max">max</code></td>
<td>
<p>maximum value of the parameter.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU_+3A_plot">plot</code></td>
<td>
<p>plot (TRUE/FALSE) the final result.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list containing the (i) vector of allocated PSUs in the iterations and (ii) the vector of allocated SSUs in the iterations
</p>


<h3>Author(s)</h3>

<p>Giulio Barcaroli</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(readr)
pop &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/pop.RDS?raw=true")
library(R2BEAT)
cv &lt;- as.data.frame(list(DOM=c("DOM1","DOM2"),
                         CV1=c(0.03,0.04),
                         CV2=c(0.06,0.08),
                         CV3=c(0.06,0.08),
                         CV4=c(0.06,0.08)))
cv
# parameters
samp_frame &lt;- pop
errors &lt;- cv
id_PSU &lt;- "municipality"  
id_SSU &lt;- "id_ind"        
strata_var &lt;- "stratum"  
target_vars &lt;- c("income_hh","active","inactive","unemployed")   # more than one
deff_var &lt;- "stratum"        
domain_var &lt;- "region"        
# average dimension of the SSU in terms of elementary survey units
#delta =  nrow(pop) /length(unique(pop$id_hh))     
delta =  1  # average dimension of the SSU in terms of elementary survey units
deff_sugg &lt;- 1.5  # deff (suggested)
sensitivity_min_SSU(
            samp_frame,
            errors,
            id_PSU,
            id_SSU,
            strata_var,
            target_vars,
            deff_var,
            domain_var,
            delta,
            deff_sugg,
            min=1,
            max=2)

## End(Not run)
</code></pre>

<hr>
<h2 id='sensitivity_min_SSU2'>
Sensitivity analysis for choosing minimum number of SSUs per PSU (no sampling frame available)
</h2><span id='topic+sensitivity_min_SSU2'></span>

<h3>Description</h3>

<p>This function is similar to the function sensitivity_min_SSU, as it allows to analyse the different results in terms 
of first stage size (number of PSUs) and second stage size (number of SSUs),
when varying the values of the minimum number of SSU per single PSU)
The name of the parameter has to be given, together with the minimum and
maximum value. Differently from sensitivity_min_SSU, it requires in input all the outputs already prepared by prepareInputToAllocation1 or prepareInputToAllocation2.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>sensitivity_min_SSU2 (strata, 
                      des_file,
                      psu_file,
                      rho,
                      effst,
                      errors, 
                      min, 
                      max, 
                      plot) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="sensitivity_min_SSU2_+3A_strata">strata</code></td>
<td>
<p>Data frame of survey strata, for more details see, e.g.,<a href="#topic+strata">strata</a>.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU2_+3A_des_file">des_file</code></td>
<td>
<p>Data frame containing information on sampling design variables, for more details see, e.g.,<a href="#topic+design">design</a>.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU2_+3A_psu_file">psu_file</code></td>
<td>
<p>Data frame containing information on primary stage units stratification, for more details see, e.g.,<a href="#topic+PSU_strat">PSU_strat</a>.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU2_+3A_rho">rho</code></td>
<td>
<p>Data frame of survey strata, for more details see, e.g.,<a href="#topic+rho">rho</a>.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU2_+3A_effst">effst</code></td>
<td>
<p>Data frame of survey strata, for taking into account the estimator effect on each variable, for more details see, e.g.,<a href="#topic+effst">effst</a>.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU2_+3A_errors">errors</code></td>
<td>
<p>Data frame of coefficients of variation for each domain, for more details see, e.g.,<a href="#topic+errors">errors</a>.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU2_+3A_min">min</code></td>
<td>
<p>starting value for the minimum value of SSUs per PSU.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU2_+3A_max">max</code></td>
<td>
<p>ending value for the minimum value of SSUs per PSU.</p>
</td></tr>
<tr><td><code id="sensitivity_min_SSU2_+3A_plot">plot</code></td>
<td>
<p>plot (TRUE/FALSE) the final result.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list containing the (i) vector of allocated PSUs in the iterations and (ii) the vector of allocated SSUs in the iterations
</p>


<h3>Author(s)</h3>

<p>Giulio Barcaroli</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(readr)
samp &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/sample.rds?raw=true")
pop &lt;- read_rds("https://github.com/barcaroli/R2BEAT_workflows/blob/master/pop.RDS?raw=true")
library(R2BEAT)
str(samp)
## Sample design description
library(ReGenesees)
samp$stratum_2 &lt;- as.factor(samp$stratum_2)
sample.des &lt;- e.svydesign(samp, 
                          ids= ~ municipality + id_hh, 
                          strata = ~ stratum_2, 
                          weights = ~ weight,
                          self.rep.str = ~ SR,
                          check.data = TRUE)
## Find and collapse lonely strata
ls &lt;- find.lon.strata(sample.des)
if (!is.null(ls)) sample.des &lt;- collapse.strata(sample.des)
## Calibration with known totals
totals &lt;- pop.template(sample.des,
             calmodel = ~ sex : cl_age, 
             partition = ~ region)
totals &lt;- fill.template(pop, totals, mem.frac = 10)
sample.cal &lt;- e.calibrate(sample.des, 
                          totals,
                          calmodel = ~ sex : cl_age, 
                          partition = ~ region,
                          calfun = "logit",
                          bounds = c(0.3, 2.6), 
                          aggregate.stage = 2,
                          force = FALSE)
samp_frame &lt;- pop
RGdes &lt;- sample.des
RGcal &lt;- sample.cal
strata_var &lt;- c("stratum")      
target_vars &lt;- c("income_hh",
                 "active",
                 "inactive",
                 "unemployed")   
weight_var &lt;- "weight"
deff_var &lt;- "stratum"            
id_PSU &lt;- c("municipality")      
id_SSU &lt;- c("id_hh")             
domain_var &lt;- c("region") 
delta &lt;- 1                   
minimum &lt;- 50     
inp &lt;- prepareInputToAllocation2 ( 
  samp_frame,
  RGdes, 
  RGcal, 
  id_PSU, 
  id_SSU, 
  strata_var, 
  target_vars, 
  deff_var, 
  domain_var,
  delta,
  minimum) 
cv &lt;- as.data.frame(list(DOM=c("DOM1","DOM2"),
                         CV1=c(0.02,0.03),
                         CV2=c(0.03,0.06),
                         CV3=c(0.03,0.06),
                         CV4=c(0.05,0.08)))
sens &lt;- sensitivity_min_SSU2 (strata = inp$strata, 
                         des_file = inp$des_file,
                         psu_file = inp$psu_file,
                         rho = inp$rho,
                         effst = inp$effst,
                         errors = cv, 
                         min = 15, 
                         max = 25, 
                         plot = TRUE) 

## End(Not run)
</code></pre>

<hr>
<h2 id='strata'>
Strata characteristics
</h2><span id='topic+strata'></span>

<h3>Description</h3>

<p>Example data frame containing information on strata characteristics.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(beat.example)
</code></pre>


<h3>Format</h3>

<p>The Strata data frame contains a row per each stratum with the following variables: 
</p>

<dl>
<dt>STRATUM</dt><dd>
<p>Identifier of the stratum (numeric).
</p>
</dd> 
<dt>N</dt><dd>
<p>Stratum population size (numeric).
</p>
</dd> 
<dt>M1</dt><dd>
<p>Mean in the stratum of the first variable (numeric).
</p>
</dd>
<dt>Mj</dt><dd>
<p>Mean in the stratum of the j-th variable (numeric).
</p>
</dd>
<dt>Mn</dt><dd>
<p>Mean in the stratum of the last variable (numeric).
</p>
</dd>
<dt>S1</dt><dd>
<p>Standard deviation in the stratum of the first variable (numeric).
</p>
</dd>
<dt>Sj</dt><dd>
<p>Standard deviation in the stratum of the j-th variable (numeric).
</p>
</dd>
<dt>Sn</dt><dd>
<p>Standard deviation in the stratum of the last variable (numeric).
</p>
</dd>
<dt>CENS</dt><dd><p>flag (1 indicates a take all stratum, 0 a sampling stratum, usually 0 ) (numeric).
</p>
</dd>
<dt>COST</dt><dd><p>Cost per interview in each stratum, usually 0  (numeric).
</p>
</dd>
<dt>DOM1</dt><dd>
<p>Domain value to which the stratum belongs for the first type of domain (factor or numeric).
</p>
</dd>
<dt>DOMa</dt><dd>
<p>Domain value to which the stratum belongs for the a-th type of domain  (factor or numeric).
</p>
</dd>
<dt>DOMk</dt><dd>
<p>Domain value to which the stratum belongs for the k-th type of domain  (factor or numeric).
</p>
</dd>
</dl>



<h3>Details</h3>

<p>Note: the names of the variables must be the ones indicated above.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
# Load example data
data(beat.example)
strata
str(strata)

## End(Not run)
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
