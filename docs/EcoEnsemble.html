<!DOCTYPE html><html lang="en"><head><title>Help for package EcoEnsemble</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {EcoEnsemble}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#EcoEnsemble-package'><p>A general framework for combining ecosystem models</p></a></li>
<li><a href='#EnsembleData'><p>Constructor for the <code>EnsembleData</code> class</p></a></li>
<li><a href='#EnsembleData-class'><p>A class to hold the Ensemble data</p></a></li>
<li><a href='#EnsembleFit'><p>The constructor for the <code>EnsembleFit</code> object</p></a></li>
<li><a href='#EnsembleFit-class'><p>A class to hold the samples or point estimates from the ensemble model.</p></a></li>
<li><a href='#EnsemblePrior-class'><p>A class to hold the priors for the ensemble model.</p></a></li>
<li><a href='#EnsembleSample'><p>A constructor for the <code>EnsembleSample</code> object</p></a></li>
<li><a href='#EnsembleSample-class'><p>A class to hold  samples of the ensemble model</p></a></li>
<li><a href='#fit_ensemble_model'><p>Fits the ensemble model</p></a></li>
<li><a href='#generate_sample'><p>Generate samples from a fitted ensemble model.</p></a></li>
<li><a href='#get_mcmc_ensemble_model'><p>Return the compiled ensemble model Stan object.</p></a></li>
<li><a href='#IndLTPrior'><p>Constructor for the <code>EnsemblePrior</code> class</p></a></li>
<li><a href='#IndLTPrior-class'><p>A class to hold the priors for the ensemble model.</p></a></li>
<li><a href='#IndSTPrior-class'><p>A class to hold the priors for the ensemble model.</p></a></li>
<li><a href='#KalmanFilter_back'><p>Backwards Kalman filter</p></a></li>
<li><a href='#plot.EnsembleSample'><p>Plot the ensemble output</p></a></li>
<li><a href='#prior_ensemble_model'><p>Generate samples of parameters from prior distribution</p></a></li>
<li><a href='#sample_prior'><p>Generate samples of latent variables from prior predictive distribution</p></a></li>
<li><a href='#ShaSTPrior-class'><p>A class to hold the priors for the ensemble model.</p></a></li>
<li><a href='#Sigma_ewe'><p>Ecopath with EcoSim Sigma</p></a></li>
<li><a href='#Sigma_fs'><p>FishSUMS Sigma</p></a></li>
<li><a href='#Sigma_lm'><p>LeMans Sigma</p></a></li>
<li><a href='#Sigma_miz'><p>mizer Sigma</p></a></li>
<li><a href='#Sigma_obs'><p>Stock assessment Sigma</p></a></li>
<li><a href='#SSB_ewe'><p>Ecopath with EcoSim SSB</p></a></li>
<li><a href='#SSB_fs'><p>FishSUMS SSB</p></a></li>
<li><a href='#SSB_lm'><p>LeMans SSB</p></a></li>
<li><a href='#SSB_miz'><p>mizer SSB</p></a></li>
<li><a href='#SSB_obs'><p>Stock assessment SSB</p></a></li>
<li><a href='#TruthPrior-class'><p>A class to hold the priors for the truth model in the ensemble framework</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Title:</td>
<td>A General Framework for Combining Ecosystem Models</td>
</tr>
<tr>
<td>Version:</td>
<td>1.1.2</td>
</tr>
<tr>
<td>Description:</td>
<td>Fit and sample from the ensemble model described in Spence et al (2018): "A general framework for combining ecosystem models"&lt;<a href="https://doi.org/10.1111%2Ffaf.12310">doi:10.1111/faf.12310</a>&gt;.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-3">GPL (&ge; 3)</a></td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>LazyData:</td>
<td>true</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.3.1</td>
</tr>
<tr>
<td>Biarch:</td>
<td>true</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://github.com/CefasRepRes/EcoEnsemble">https://github.com/CefasRepRes/EcoEnsemble</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/CefasRepRes/EcoEnsemble/issues">https://github.com/CefasRepRes/EcoEnsemble/issues</a></td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 3.5.0)</td>
</tr>
<tr>
<td>Imports:</td>
<td>methods, Rcpp, matrixcalc, RcppParallel (&ge; 5.0.1), rstan (&ge;
2.26.0), rstantools (&ge; 2.1.1), dplyr, ggplot2, reshape2,
tibble, cowplot</td>
</tr>
<tr>
<td>LinkingTo:</td>
<td>BH (&ge; 1.66.0), Rcpp, RcppEigen (&ge; 0.3.3.3.0), RcppParallel
(&ge; 5.0.1), rstan (&ge; 2.26.0), StanHeaders (&ge; 2.26.0)</td>
</tr>
<tr>
<td>SystemRequirements:</td>
<td>GNU make</td>
</tr>
<tr>
<td>Suggests:</td>
<td>rmarkdown, knitr, testthat (&ge; 3.0.0), mgcv</td>
</tr>
<tr>
<td>Config/testthat/edition:</td>
<td>3</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>Collate:</td>
<td>'DiscrepancyPrior-IndLTPrior-class.R'
'DiscrepancyPrior-IndSTPrior-class.R'
'DiscrepancyPrior-ShaSTPrior-class.R'
'DiscrepancyPrior-TruthPrior-class.R' 'EcoEnsemble-package.R'
'EnsemblePrior-class.R' 'EnsembleData-class.R'
'EnsembleFit-class.R' 'EnsembleSample-class.R'
'Prior_sampling.R' 'RcppExports.R' 'data.R' 'fit_ensemble.R'
'fit_ensemble_withdrivers.R' 'generate_simulator_stan_data.R'
'generate_simulator_stan_data_withdrivers.R'
'get_stan_outputs.R' 'get_stan_outputs_withdrivers.R'
'plot_functions.R' 'plot_functions_withdrivers.R'
'prior_functions.R' 'stanmodels.R' 'validation_functions.R'
'validation_functions_withdrivers.R'
'validation_prior_functions.R'</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>yes</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2025-03-18 16:48:05 UTC; MS23</td>
</tr>
<tr>
<td>Author:</td>
<td>Michael A. Spence <a href="https://orcid.org/0000-0002-3445-7979"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre],
  James A. Martindale
    <a href="https://orcid.org/0000-0002-1913-5592"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [aut],
  Michael J. Thomson
    <a href="https://orcid.org/0000-0003-0284-0129"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [aut],
  Thomas I. J. Bartos [aut]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Michael A. Spence &lt;michael.spence@cefas.gov.uk&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2025-03-18 18:20:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='EcoEnsemble-package'>A general framework for combining ecosystem models</h2><span id='topic+EcoEnsemble-package'></span><span id='topic+EcoEnsemble'></span>

<h3>Description</h3>

<p>The <code>EcoEnsemble</code> package implements the framework for combining ecosystem models laid out in Spence et al (2018).
</p>


<h3>Details</h3>

<p>The ensemble model can be implemented in three main stages:
</p>

<ol>
<li><p> Eliciting priors on discrepancy terms: This is done by using the <code>EnsemblePrior</code> constructor.
</p>
</li>
<li><p> Fitting the ensemble model: Using <code>fit_ensemble_model</code> with simulator outputs, observations and prior information. The ensemble model can be fit, obtaining either the point estimate, which maximises the posterior density, or running Markov chain Monte Carlo to generate a sample from the posterior denisty of the ensemble model.
</p>
</li>
<li><p> Sampling the latent variables from the fitted model: Using <code>generate_sample</code> with the fitted ensemble object, the discrepancy terms and the ensemble's best guess of the truth can be generated. Similarly to <code>fit_ensemble_model</code>, this can either be a point estimate or a full sample.
</p>
</li></ol>



<h3>Author(s)</h3>

<p><strong>Maintainer</strong>: Michael A. Spence <a href="mailto:michael.spence@cefas.gov.uk">michael.spence@cefas.gov.uk</a> (<a href="https://orcid.org/0000-0002-3445-7979">ORCID</a>)
</p>
<p>Authors:
</p>

<ul>
<li><p> James A. Martindale (<a href="https://orcid.org/0000-0002-1913-5592">ORCID</a>)
</p>
</li>
<li><p> Michael J. Thomson (<a href="https://orcid.org/0000-0003-0284-0129">ORCID</a>)
</p>
</li></ul>



<h3>References</h3>

<p>Stan Development Team (2020). RStan: the R interface to Stan. R package version 2.21.2. <a href="https://mc-stan.org">https://mc-stan.org</a>
</p>
<p>Spence, M. A., J. L. Blanchard, A. G. Rossberg, M. R. Heath, J. J. Heymans, S. Mackinson, N. Serpetti, D. C. Speirs, R. B. Thorpe, and P. G. Blackwell. 2018. &quot;A General Framework for Combining Ecosystem Models.&quot; Fish and Fisheries 19: 1013-42. <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/faf.12310">https://onlinelibrary.wiley.com/doi/abs/10.1111/faf.12310</a>
</p>


<h3>See Also</h3>

<p>Useful links:
</p>

<ul>
<li> <p><a href="https://github.com/CefasRepRes/EcoEnsemble">https://github.com/CefasRepRes/EcoEnsemble</a>
</p>
</li>
<li><p> Report bugs at <a href="https://github.com/CefasRepRes/EcoEnsemble/issues">https://github.com/CefasRepRes/EcoEnsemble/issues</a>
</p>
</li></ul>


<hr>
<h2 id='EnsembleData'>Constructor for the <code>EnsembleData</code> class</h2><span id='topic+EnsembleData'></span>

<h3>Description</h3>

<p>A constructor for the <code>EnsembleData</code> class. This is used to convert input data into the required form for <code>fit_ensemble_model</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>EnsembleData(observations, simulators, priors, drivers = FALSE, MMod)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="EnsembleData_+3A_observations">observations</code></td>
<td>
<p>A <code>list</code> of length 2 containing observations and a covariance matrix. The first element is a <code>data.frame</code> or <code>matrix</code> with each column giving observations of each output of interest and each row a time. Rows should be named with the times and columns should be named the variables. The second element is is a <code class="reqn">d \times d</code> <code>matrix</code> where <code class="reqn">d</code> is the number of columns of the observations data frame / matrix. This matrix is the covariance matrix of the observations.</p>
</td></tr>
<tr><td><code id="EnsembleData_+3A_simulators">simulators</code></td>
<td>
<p>A <code>list</code> with length equal to the number of simulators. For each simulator, there is a <code>list</code> of 2 objects containing the simulator output and covariance matrix. The first element is a <code>data.frame</code> or <code>matrix</code> with each column giving a simulator outputs of interest and each row a time. Rows should be named with the times and columns should be named the variables. The second element is a <code class="reqn">n_k \times n_k</code> <code>matrix</code> where <code class="reqn">n_k</code> is the number of columns of the simulators output data frame / matrix. This matrix is the covariance matrix of the simulator outputs.</p>
</td></tr>
<tr><td><code id="EnsembleData_+3A_priors">priors</code></td>
<td>
<p>An <code>EnsemblePrior</code> object specifying the prior distributions for the ensemble.</p>
</td></tr>
<tr><td><code id="EnsembleData_+3A_drivers">drivers</code></td>
<td>
<p>A <code>logical</code> indicating whether drivers have been used in combination with simulators. Default value is FALSE.</p>
</td></tr>
<tr><td><code id="EnsembleData_+3A_mmod">MMod</code></td>
<td>
<p>Not currently implemented.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An object of class <code>EnsembleData</code>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+EnsembleData-class">EnsembleData</a></code>, <code><a href="#topic+EnsemblePrior">EnsemblePrior</a></code>, <code><a href="#topic+fit_ensemble_model">fit_ensemble_model</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ensemble_data &lt;- EnsembleData(observations = list(SSB_obs, Sigma_obs),
                             simulators = list(list(SSB_ewe, Sigma_ewe, "EwE"),
                                           list(SSB_fs,  Sigma_fs, "FishSUMS"),
                                           list(SSB_lm,  Sigma_lm, "LeMans"),
                                           list(SSB_miz, Sigma_miz, "mizer")),
                              priors = EnsemblePrior(4))
</code></pre>

<hr>
<h2 id='EnsembleData-class'>A class to hold the Ensemble data</h2><span id='topic+EnsembleData-class'></span>

<h3>Description</h3>

<p>A class that holds the observation data, simulator outputs, and prior information to convert into the required form for <code>fit_ensemble_model</code>.
</p>


<h3>Slots</h3>


<dl>
<dt><code>stan_input</code></dt><dd><p>A <code>list</code> of parameters in the correct form to fit the ensemble model in Stan.</p>
</dd>
<dt><code>observations</code></dt><dd><p>A <code>list</code> of length 2 containing observations and a covariance matrix. The first element is a <code>data.frame</code> or <code>matrix</code> with each column giving observations of each output of interest and each row a time. Rows should be named with the times and columns should be named the variables. The second element is the covariance matrix of the observations.</p>
</dd>
<dt><code>simulators</code></dt><dd><p>A <code>list</code> with length equal to the number of simulators. For each simulator, there is a <code>list</code> of 2 objects containing the simulator output and covariance matrix. The first element is a <code>data.frame</code> or <code>matrix</code> with each column giving a simulator outputs of interest and each row a time. Rows should be named with the times and columns should be named the variables. The second element is the covariance matrix of the simulator outputs.</p>
</dd>
<dt><code>priors</code></dt><dd><p>An <code>EnsemblePrior</code> object specifying the prior distributions for the ensemble.</p>
</dd>
</dl>


<h3>See Also</h3>

<p><code><a href="#topic+EnsembleData">EnsembleData</a></code>, <code><a href="#topic+EnsemblePrior">EnsemblePrior</a></code>, <code><a href="#topic+fit_ensemble_model">fit_ensemble_model</a></code>
</p>

<hr>
<h2 id='EnsembleFit'>The constructor for the <code>EnsembleFit</code> object</h2><span id='topic+EnsembleFit'></span>

<h3>Description</h3>

<p>The constructor for an <code>EnsembleFit</code> object. This function need not be called as an <code>EnsembleFit</code> object is constructed automatically by the <code>fit_ensemble_model</code> function.
The <code>samples</code> slot contains the samples from the MCMC if a full sampling was completed, otherwise the <code>point_estimate</code> slot contains information about a point estimate.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>EnsembleFit(ensemble_data, samples = NULL, point_estimate = NULL)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="EnsembleFit_+3A_ensemble_data">ensemble_data</code></td>
<td>
<p>An <code>EnsembleData</code> object encapsulating the data used to fit the ensemble model.</p>
</td></tr>
<tr><td><code id="EnsembleFit_+3A_samples">samples</code></td>
<td>
<p>A <code>stanfit</code> object containing the samples drawn from the fitted model. The default value is <code>NULL</code>.</p>
</td></tr>
<tr><td><code id="EnsembleFit_+3A_point_estimate">point_estimate</code></td>
<td>
<p>A <code>list</code> output of the optimised model. The default value is <code>NULL</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An object of class <code>EnsembleFit</code>
</p>


<h3>References</h3>

<p>Stan Development Team (2020). RStan: the R interface to Stan. R package version 2.21.2. https://mc-stan.org
</p>


<h3>See Also</h3>

<p><code><a href="#topic+EnsembleFit-class">EnsembleFit</a></code>, <code><a href="#topic+fit_ensemble_model">fit_ensemble_model</a></code>,
</p>

<hr>
<h2 id='EnsembleFit-class'>A class to hold the samples or point estimates from the ensemble model.</h2><span id='topic+EnsembleFit-class'></span>

<h3>Description</h3>

<p>An <code>EnsembleFit</code> object is returned by the <code>fit_ensemble_model</code> function.
The object contains a slot for the <code>EnsembleData</code> object originally used to
fit the ensemble model. The <code>samples</code> slot contains the samples from the MCMC
if a full sampling was completed, otherwise the <code>point_estimate</code> slot contains
information about a point estimate.
</p>


<h3>Slots</h3>


<dl>
<dt><code>ensemble_data</code></dt><dd><p>An <code>EnsembleData</code> object encapsulating the data used to fit the ensemble model.</p>
</dd>
<dt><code>samples</code></dt><dd><p>A <code>stanfit</code> object containing the samples drawn from the fitted model. The default value is <code>NULL</code>.</p>
</dd>
<dt><code>point_estimate</code></dt><dd><p>A <code>list</code> output of the optimised model. The default value is <code>NULL</code>.</p>
</dd>
</dl>


<h3>References</h3>

<p>Stan Development Team (2020). RStan: the R interface to Stan. R package version 2.21.2. https://mc-stan.org
</p>


<h3>See Also</h3>

<p><code><a href="#topic+EnsembleFit">EnsembleFit</a></code>, <code><a href="#topic+fit_ensemble_model">fit_ensemble_model</a></code>, <code><a href="#topic+generate_sample">generate_sample</a></code>
</p>

<hr>
<h2 id='EnsemblePrior-class'>A class to hold the priors for the ensemble model.</h2><span id='topic+EnsemblePrior-class'></span>

<h3>Description</h3>

<p>An <code>EnsemblePrior</code> object encapsulates the prior information for the ensemble model.
</p>


<h3>Slots</h3>


<dl>
<dt><code>d</code></dt><dd><p>A <code>numeric</code> specifying the number of variables of interest in the ensemble.</p>
</dd>
<dt><code>ind_st_params</code></dt><dd><p>A <code>list</code> containing a prior specification for the individual short-term discrepancies <code class="reqn">z_k^{(t)}</code>. See details of the <code>EnsemblePrior()</code> constructor.</p>
</dd>
<dt><code>ind_lt_params</code></dt><dd><p>A <code>list</code> containing a prior specification for the individual long-term discrepancies <code class="reqn">\gamma_k</code>. See details of the <code>EnsemblePrior()</code> constructor.</p>
</dd>
<dt><code>sha_st_params</code></dt><dd><p>A <code>list</code> containing a prior specification for the shared short-term discrepancies <code class="reqn">\eta^{(t)}</code>. See details of the <code>EnsemblePrior()</code> constructor.</p>
</dd>
<dt><code>sha_lt_params</code></dt><dd><p>A <code>numeric</code> containing the standard deviations for the normal prior used on the shared short-term discrepancy <code class="reqn">\mu</code>. If a single value is supplied,  this is repeated for each variable</p>
</dd>
<dt><code>truth_params</code></dt><dd><p>A <code>list</code> containing a prior specification for the processes on the truth <code class="reqn">y^{(t)}</code>. See details of the <code>EnsemblePrior()</code> constructor. The default value is <code>TruthPrior(d)</code>.</p>
</dd>
<dt><code>priors_stan_input</code></dt><dd><p>A <code>list</code> containing the prior data in the correct form to fit the model in Stan. This information is automatically generated by the constructor.</p>
</dd>
</dl>


<h3>References</h3>

<p>Stan Development Team (2020). RStan: the R interface to Stan. R package version 2.21.2. https://mc-stan.org
</p>
<p>Lewandowski, Daniel, Dorota Kurowicka, and Harry Joe. 2009. “Generating Random Correlation Matrices Based on Vines and Extended Onion Method.” Journal of Multivariate Analysis 100: 1989–2001.
</p>

<hr>
<h2 id='EnsembleSample'>A constructor for the <code>EnsembleSample</code> object</h2><span id='topic+EnsembleSample'></span>

<h3>Description</h3>

<p>A constructor for the <code>EnsembleSample</code> class. These objects are generated automatically using the <code>generate_sample</code> function.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>EnsembleSample(ensemble_fit, mle, samples)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="EnsembleSample_+3A_ensemble_fit">ensemble_fit</code></td>
<td>
<p>An <code>EnsembleFit</code> object containing the fitted ensemble model.</p>
</td></tr>
<tr><td><code id="EnsembleSample_+3A_mle">mle</code></td>
<td>
<p>An <code>array</code> of dimension <code class="reqn">T \times (M + 2)\times N_{sample}</code> containing MLE point estimates from the <code>ensemble_fit</code> object, where <code class="reqn">T</code> is the total time, <code class="reqn">M</code> is the number of simulators and <code class="reqn">N_{sample}</code> is the number of samples. For each time step, the <code>t</code>th element of the array is a <code>matrix</code> where each column is a sample and the rows are the variables:
</p>
<p style="text-align: center;"><code class="reqn">\left( y^{(t)}, \eta^{(t)}, z_1^{(t)}, z_2^{(t)}, \ldots, z_M^{(t)}\right)'</code>
</p>

<p>where <code class="reqn">y^{(t)}</code> is the ensemble model's prediction of the latent truth value at time <code class="reqn">t</code>,
<code class="reqn">\eta^{(t)}</code> is the shared short-term discrepancy at time <code class="reqn">t</code>,
<code class="reqn">z_i^{(t)}</code> is the individual short-term discrepancy of simulator <code class="reqn">i</code> at time <code class="reqn">t</code>.</p>
</td></tr>
<tr><td><code id="EnsembleSample_+3A_samples">samples</code></td>
<td>
<p>An <code>array</code> of dimension <code class="reqn">T \times (M + 2)\times N_{sample}</code> containing samples from the <code>ensemble_fit</code> object, where <code class="reqn">T</code> is the total time, <code class="reqn">M</code> is the number of simulators and <code class="reqn">N_{sample}</code> is the number of samples. For each time step, the <code>t</code>th element of the array is a <code>matrix</code> where each column is a sample and the rows are the variables:
</p>
<p style="text-align: center;"><code class="reqn">\left( y^{(t)}, \eta^{(t)}, z_1^{(t)}, z_2^{(t)}, \ldots, z_M^{(t)}\right)'</code>
</p>

<p>where <code class="reqn">y^{(t)}</code> is the ensemble model's prediction of the latent truth value at time <code class="reqn">t</code>,
<code class="reqn">\eta^{(t)}</code> is the shared short-term discrepancy at time <code class="reqn">t</code>,
<code class="reqn">z_i^{(t)}</code> is the individual short-term discrepancy of simulator <code class="reqn">i</code> at time <code class="reqn">t</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An object of class <code>EnsembleSample</code>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+EnsembleSample">EnsembleSample</a></code>, <code><a href="#topic+generate_sample">generate_sample</a></code>
</p>

<hr>
<h2 id='EnsembleSample-class'>A class to hold  samples of the ensemble model</h2><span id='topic+EnsembleSample-class'></span>

<h3>Description</h3>

<p><code>EnsembleSample</code> objects are generated using the <code>generate_sample</code> function.
</p>


<h3>Slots</h3>


<dl>
<dt><code>ensemble_fit</code></dt><dd><p>An <code>EnsembleFit</code> object containing the fitted ensemble model.</p>
</dd>
<dt><code>mle</code></dt><dd><p>An <code>array</code> of dimension <code class="reqn">T \times (M + 2)\times N_{sample}</code> containing MLE point estimates from the <code>ensemble_fit</code> object, where <code class="reqn">T</code> is the total time, <code class="reqn">M</code> is the number of simulators and <code class="reqn">N_{sample}</code> is the number of samples. For each time step, the <code>t</code>th element of the array is a <code>matrix</code> where each column is a sample and the rows are the variables:
</p>
<p style="text-align: center;"><code class="reqn">\left( y^{(t)}, \eta^{(t)}, z_1^{(t)}, z_2^{(t)}, \ldots, z_M^{(t)}\right)'</code>
</p>

<p>where <code class="reqn">y^{(t)}</code> is the ensemble model's prediction of the latent truth value at time <code class="reqn">t</code>,
<code class="reqn">\eta^{(t)}</code> is the shared short-term discrepancy at time <code class="reqn">t</code>,
<code class="reqn">z_i^{(t)}</code> is the individual short-term discrepancy of simulator <code class="reqn">i</code> at time <code class="reqn">t</code>.</p>
</dd>
<dt><code>samples</code></dt><dd><p>An <code>array</code> of dimension <code class="reqn">T \times (M + 2)\times N_{sample}</code> containing samples from the <code>ensemble_fit</code> object, where <code class="reqn">T</code> is the total time, <code class="reqn">M</code> is the number of simulators and <code class="reqn">N_{sample}</code> is the number of samples. For each time step, the <code>t</code>th element of the array is a <code>matrix</code> where each column is a sample and the rows are the variables:
</p>
<p style="text-align: center;"><code class="reqn">\left( y^{(t)}, \eta^{(t)}, z_1^{(t)}, z_2^{(t)}, \ldots, z_M^{(t)}\right)'</code>
</p>

<p>where <code class="reqn">y^{(t)}</code> is the ensemble model's prediction of the latent truth value at time <code class="reqn">t</code>,
<code class="reqn">\eta^{(t)}</code> is the shared short-term discrepancy at time <code class="reqn">t</code>,
<code class="reqn">z_i^{(t)}</code> is the individual short-term discrepancy of simulator <code class="reqn">i</code> at time <code class="reqn">t</code>.</p>
</dd>
</dl>


<h3>See Also</h3>

<p><code><a href="#topic+EnsembleSample">EnsembleSample</a></code>, <code><a href="#topic+generate_sample">generate_sample</a></code>
</p>

<hr>
<h2 id='fit_ensemble_model'>Fits the ensemble model</h2><span id='topic+fit_ensemble_model'></span>

<h3>Description</h3>

<p><code>fit_ensemble_model</code> runs an MCMC of the ensemble model. This process can take a long time depending on the size of the datasets.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>fit_ensemble_model(
  observations,
  simulators,
  priors,
  full_sample = TRUE,
  control = list(adapt_delta = 0.95),
  drivers = FALSE,
  MMod,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="fit_ensemble_model_+3A_observations">observations</code></td>
<td>
<p>A <code>list</code> of length 2 containing observations and a covariance matrix. The first element is a <code>data.frame</code> or <code>matrix</code> with each column giving observations of each output of interest and each row a time. Rows should be named with the times and columns should be named the variables. The second element is is a <code class="reqn">d \times d</code> <code>matrix</code> where <code class="reqn">d</code> is the number of columns of the observations data frame / matrix. This matrix is the covariance matrix of the observations.</p>
</td></tr>
<tr><td><code id="fit_ensemble_model_+3A_simulators">simulators</code></td>
<td>
<p>A <code>list</code> with length equal to the number of simulators. For each simulator, there is a <code>list</code> of 2 objects containing the simulator output and covariance matrix. The first element is a <code>data.frame</code> or <code>matrix</code> with each column giving a simulator outputs of interest and each row a time. Rows should be named with the times and columns should be named the variables. The second element is a <code class="reqn">n_k \times n_k</code> <code>matrix</code> where <code class="reqn">n_k</code> is the number of columns of the simulators output data frame / matrix. This matrix is the covariance matrix of the simulator outputs.</p>
</td></tr>
<tr><td><code id="fit_ensemble_model_+3A_priors">priors</code></td>
<td>
<p>An <code>EnsemblePrior</code> object specifying the prior distributions for the ensemble.</p>
</td></tr>
<tr><td><code id="fit_ensemble_model_+3A_full_sample">full_sample</code></td>
<td>
<p>A <code>logical</code> that runs a full sampling of the posterior density of the ensemble model if <code>TRUE</code>. If <code>FALSE</code>, returns the point estimate which maximises the posterior density of the ensemble model.</p>
</td></tr>
<tr><td><code id="fit_ensemble_model_+3A_control">control</code></td>
<td>
<p>If creating a full sample, this is a named <code>list</code> of paramaters to control Stan's sampling behaviour. See the documentation of the <code>stan()</code> function in the <code>rstan</code> package for details. The default value is <code>list(adapt_delta = 0.95)</code>. If optimizing, this value is ignored.</p>
</td></tr>
<tr><td><code id="fit_ensemble_model_+3A_drivers">drivers</code></td>
<td>
<p>A <code>logical</code> indicating whether drivers have been used in combination with simulators. Default value is FALSE.</p>
</td></tr>
<tr><td><code id="fit_ensemble_model_+3A_mmod">MMod</code></td>
<td>
<p>Not currently implemented.</p>
</td></tr>
<tr><td><code id="fit_ensemble_model_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to the function <code>rstan::sampling</code> or  <code>rstan::optimizing</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An <code>EnsembleFit</code> object.
</p>


<h3>References</h3>

<p>Stan Development Team (2020). RStan: the R interface to Stan. R package version 2.21.2. https://mc-stan.org
</p>


<h3>See Also</h3>

<p><code><a href="#topic+EnsembleFit-class">EnsembleFit</a></code>, <code><a href="#topic+EnsembleSample">EnsembleSample</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

fit &lt;- fit_ensemble_model(observations = list(SSB_obs, Sigma_obs),
               simulators = list(list(SSB_ewe, Sigma_ewe, "EwE"),
                                 list(SSB_fs,  Sigma_fs, "FishSUMS"),
                                 list(SSB_lm,  Sigma_lm, "LeMans"),
                                 list(SSB_miz, Sigma_miz, "Mizer")),
               priors = EnsemblePrior(4,
               ind_st_params = IndSTPrior(parametrisation_form = "lkj",
               var_params= list(1,1), cor_params = 10, AR_params = c(2, 2))),
               full_sample = FALSE) #Only optimise in this case

</code></pre>

<hr>
<h2 id='generate_sample'>Generate samples from a fitted ensemble model.</h2><span id='topic+generate_sample'></span><span id='topic+get_transformed_data'></span><span id='topic+get_parameters'></span><span id='topic+get_mle'></span><span id='topic+gen_sample'></span><span id='topic+get_transformed_data_dri'></span>

<h3>Description</h3>

<p>Methods to generates samples of the latent variables from a fitted ensemble model.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>generate_sample(fit, num_samples = 1)

get_transformed_data(fit)

get_parameters(ex.fit, x = 1)

get_mle(x = 1, ex.fit, transformed_data, time)

gen_sample(x = 1, ex.fit, transformed_data, time)

get_transformed_data_dri(fit)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="generate_sample_+3A_fit">fit</code></td>
<td>
<p>An <code>EnsembleFit</code> object.</p>
</td></tr>
<tr><td><code id="generate_sample_+3A_num_samples">num_samples</code></td>
<td>
<p>A <code>numeric</code> specifying the number of samples to be generated. The default is 1.</p>
</td></tr>
<tr><td><code id="generate_sample_+3A_ex.fit">ex.fit</code></td>
<td>
<p>A <code>list</code> containing the samples / point estimate from the <code>EnsembleFit</code> object.</p>
</td></tr>
<tr><td><code id="generate_sample_+3A_x">x</code></td>
<td>
<p>A <code>numeric</code> specifying which sample from the posterior to use. The default is 1.</p>
</td></tr>
<tr><td><code id="generate_sample_+3A_transformed_data">transformed_data</code></td>
<td>
<p>A <code>list</code> of transformed input data.</p>
</td></tr>
<tr><td><code id="generate_sample_+3A_time">time</code></td>
<td>
<p>A <code>numeric</code> specifying the time for which the ensemble model was run.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The samples are created using the methods described in Strickland et. al. (2009) and Durbin and Koopman (2002).
</p>


<h3>Value</h3>

<p><code>generate_sample</code> gives a <code>list</code> of length 2, the first element being the MLE of latent variables and the second element being a set of samples of the latent variables.
</p>

<ul>
<li><p> If <code>fit</code> is a sampling of the ensemble model parameters, then:
</p>

<ul>
<li> <p><code>mle</code> is a <code>time</code><code class="reqn">\times (3M + 2) \times</code> <code>num_samples</code> <code>array</code>, where <code class="reqn">M</code> is the number of simulators and <code>num_samples</code> is the number of samples from the ensemble model, giving the MLE of the latent variables for each available sample from the ensemble model.
</p>
</li>
<li> <p><code>sample</code> is a <code>time</code><code class="reqn">\times (3M + 2) \times</code> <code>num_samples</code> <code>array</code>, giving a sample of the latent variables for each available sample of the ensemble model.
</p>
</li></ul>

</li>
<li><p> If <code>fit</code> is a point estimate of the ensemble model parameters, then:
</p>

<ul>
<li> <p><code>mle</code> is a <code>time</code><code class="reqn">\times (3M + 2) \times</code> 1 <code>array</code> giving the MLE of the latent variables for the point estimate of the ensemble model.
</p>
</li>
<li> <p><code>sample</code> is a <code>time</code><code class="reqn">\times (3M + 2) \times</code> <code>num_samples</code> <code>array</code>, giving <code>num_samples</code> samples of the latent variables for the single point estimate of the ensemble model.
</p>
</li></ul>

</li></ul>

<p><code>get_transformed_data</code> gives a <code>list</code> of transformed input data.
</p>
<p><code>get_parameters</code> gives a <code>list</code> of ensemble parameters from the requested sample.
</p>
<p><code>get_mle</code> If <code>fit</code> is a sampling of the ensemble model parameters, then this is a <code>time</code><code class="reqn">\times (3M + 2) \times</code> <code>num_samples</code> <code>array</code>. If <code>fit</code> is a point estimate of the ensemble model parameters, then this is a <code>time</code><code class="reqn">\times (3M + 2) \times</code> 1 <code>array</code> giving the MLE of the latent variables for the point estimate of the ensemble model.
</p>
<p><code>gen_sample</code> If <code>fit</code> is a sampling of the ensemble model parameters, then this is a <code>time</code><code class="reqn">\times (3M + 2) \times</code> <code>num_samples</code> <code>array</code>, giving a sample of the latent variables for each available sample of the ensemble model. If <code>fit</code> is a point estimate of the ensemble model parameters, then this is a <code>time</code><code class="reqn">\times (3M + 2) \times</code> <code>num_samples</code> <code>array</code>.
</p>


<h3>References</h3>

<p>J. Durbin, S. J. Koopman (2002) A simple and efficient simulation smoother for state space time series analysis Biometrika, Volume 89, Issue 3, August 2002, Pages 603–616,
</p>
<p>Chris M.Strickland, Ian. W.Turner, Robert Denhamb, Kerrie L.Mengersena. Efficient Bayesian estimation of multivariate state space models Computational Statistics &amp; Data Analysis Volume 53, Issue 12, 1 October 2009, Pages 4116-4125
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
fit &lt;- fit_ensemble_model(observations = list(SSB_obs, Sigma_obs),
               simulators = list(list(SSB_ewe, Sigma_ewe, "EwE"),
                                 list(SSB_fs,  Sigma_fs, "FishSUMS"),
                                 list(SSB_lm,  Sigma_lm, "LeMans"),
                                 list(SSB_miz, Sigma_miz, "Mizer")),
               priors = EnsemblePrior(4,
               ind_st_params = IndSTPrior(parametrisation_form = "lkj",
               var_params= list(1,1), cor_params = 10, AR_params = c(2, 2))),
               full_sample = FALSE) #Only optimise in this case
samples &lt;- generate_sample(fit, num_samples = 2000)

</code></pre>

<hr>
<h2 id='get_mcmc_ensemble_model'>Return the compiled ensemble model Stan object.</h2><span id='topic+get_mcmc_ensemble_model'></span>

<h3>Description</h3>

<p>Gets the unfit, compiled <code>stanmodel</code> object encoding the ensemble model. This allows for
manual fitting of the ensemble model directly using <code>rstan::sampling</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_mcmc_ensemble_model(priors, likelihood = TRUE, drivers = FALSE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="get_mcmc_ensemble_model_+3A_priors">priors</code></td>
<td>
<p>An <code>EnsemblePrior</code> object specifying the prior distributions for the ensemble for which the compiled <code>stanmodel</code> object will be obtained.</p>
</td></tr>
<tr><td><code id="get_mcmc_ensemble_model_+3A_likelihood">likelihood</code></td>
<td>
<p>A <code>logical</code> that returns the compiled <code>stanmodel</code> object including the likelihood (the Kalman filter) for given priors if <code>TRUE</code>. If <code>FALSE</code> returns the compiled <code>stanmodel</code> object without the likelihood for sampling from the prior.</p>
</td></tr>
<tr><td><code id="get_mcmc_ensemble_model_+3A_drivers">drivers</code></td>
<td>
<p>A <code>logical</code> indicating whether drivers have been used in combination with simulators. Default value is FALSE.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>The <code>stanmodel</code> object encoding the ensemble model.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>priors &lt;- EnsemblePrior(4)
mod &lt;- get_mcmc_ensemble_model(priors)

ensemble_data &lt;- EnsembleData(observations = list(SSB_obs, Sigma_obs),
                             simulators = list(list(SSB_ewe, Sigma_ewe, "EwE"),
                                           list(SSB_fs,  Sigma_fs, "FishSUMS"),
                                           list(SSB_lm,  Sigma_lm, "LeMans"),
                                           list(SSB_miz, Sigma_miz, "mizer")),
                              priors = priors)

out &lt;- rstan::sampling(mod, ensemble_data@stan_input, chains = 1)

</code></pre>

<hr>
<h2 id='IndLTPrior'>Constructor for the <code>EnsemblePrior</code> class</h2><span id='topic+IndLTPrior'></span><span id='topic+IndSTPrior'></span><span id='topic+ShaSTPrior'></span><span id='topic+TruthPrior'></span><span id='topic+EnsemblePrior'></span>

<h3>Description</h3>

<p>Constructors for the <code>EnsemblePrior</code> class and related classes. These functions are used to encode prior information for the ensemble model. The <code>IndSTPrior</code>, <code>IndLTPrior</code>, <code>ShaSTPrior</code>, and <code>TruthPrior</code> constructors encapsulate prior information.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>IndLTPrior(
  parametrisation_form = "lkj",
  var_params = list(1, 1),
  cor_params = 1
)

IndSTPrior(
  parametrisation_form = "hierarchical",
  var_params = list(-3, 1, 8, 4),
  cor_params = list(0.1, 0.1, 0.1, 0.1),
  AR_params = c(2, 2)
)

ShaSTPrior(
  parametrisation_form = "lkj",
  var_params = list(1, 10),
  cor_params = 1,
  AR_params = c(2, 2)
)

TruthPrior(
  d,
  initial_mean = 0,
  initial_var = 100,
  rw_covariance = list(2 * d, diag(d))
)

EnsemblePrior(
  d,
  ind_st_params = IndSTPrior(),
  ind_lt_params = IndLTPrior(),
  sha_st_params = ShaSTPrior(),
  sha_lt_params = 5,
  truth_params = TruthPrior(d)
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="IndLTPrior_+3A_parametrisation_form">parametrisation_form</code></td>
<td>
<p>The parametrisation by which the covariance matrix of the noise of the AR process (in the case of <code>IndSTPrior</code> and <code>ShaSTPrior</code> objects or the covariance of the distribution of long-term discrepancies for <code>IndLTPrior</code> objects) is decomposed. The default is <code>hierarchical</code> for <code>IndSTPrior</code> objects, and <code>lkj</code> otherwise. See details.</p>
</td></tr>
<tr><td><code id="IndLTPrior_+3A_var_params">var_params</code></td>
<td>
<p>The parameters characterising the variance of the AR process (in the case of <code>IndSTPrior</code> and <code>ShaSTPrior</code> objects or the variance of the distribution of long-term discrepancies for <code>IndLTPrior</code> objects) on the discrepancy. The default value is <code>list(-3, 1, 8, 4)</code> for <code>IndSTPrior</code> objects, <code>list(1, 1)</code> for <code>IndLTPrior</code> objects, and <code>list(1, 10)</code> for <code>ShaSTPrior</code> objects. See details.</p>
</td></tr>
<tr><td><code id="IndLTPrior_+3A_cor_params">cor_params</code></td>
<td>
<p>The parameters characterising the correlations of the AR process (or the distribution of long-term discrepancies) on the short-term discrepancies. The default value in this case is to use <code>list(0.1,0.1,0.1,0.1)</code> for <code>IndSTPrior</code> objects, and <code>1</code> for <code>IndLTPrior</code> and <code>ShaSTPrior</code> objects. See details.</p>
</td></tr>
<tr><td><code id="IndLTPrior_+3A_ar_params">AR_params</code></td>
<td>
<p>The parameters giving the beta parameters for the prior distribution on the autoregressive parameter of the AR(1) process. The default is <code>c(2,2)</code>. See details.</p>
</td></tr>
<tr><td><code id="IndLTPrior_+3A_d">d</code></td>
<td>
<p>A <code>numeric</code> specifying the number of variables of interest in the ensemble.</p>
</td></tr>
<tr><td><code id="IndLTPrior_+3A_initial_mean">initial_mean</code></td>
<td>
<p>A <code>numeric</code> giving the mean of the normal distribution giving the prior on the initial value of the random walk. This is the same value for each variable Default value is <code>0</code>.</p>
</td></tr>
<tr><td><code id="IndLTPrior_+3A_initial_var">initial_var</code></td>
<td>
<p>A <code>numeric</code> giving the variance of the normal distribution giving the prior on the initial value of the random walk. This is the same value for each variable Default value is <code>100</code>.</p>
</td></tr>
<tr><td><code id="IndLTPrior_+3A_rw_covariance">rw_covariance</code></td>
<td>
<p>A <code>list</code> of length <code>2</code> containing the inverse-Wishart parameters for the covariance of the random walk of the truth. The default value is <code>list(2*d, diag(d))</code>.</p>
</td></tr>
<tr><td><code id="IndLTPrior_+3A_ind_st_params">ind_st_params</code></td>
<td>
<p>An <code>IndSTPrior</code> object specifying priors for the individual short-term discrepancies <code class="reqn">z_k^{(t)}</code>. The default value is <code>IndSTPrior("hierarchical", list(-3, 1, 8, 4), list(0.1, 0.1, 0.1, 0.1), c(2, 2))</code>.</p>
</td></tr>
<tr><td><code id="IndLTPrior_+3A_ind_lt_params">ind_lt_params</code></td>
<td>
<p>An <code>IndLTPrior</code> object specifying priors for the individual long-term discrepancies <code class="reqn">\gamma_k</code>. The default value is <code>IndLTPrior("lkj",list(1, 1), 1)</code>.</p>
</td></tr>
<tr><td><code id="IndLTPrior_+3A_sha_st_params">sha_st_params</code></td>
<td>
<p>A <code>ShaSTPrior</code> object specifying priors for the shared short-term discrepancies <code class="reqn">\eta^{(t)}</code>. The default value is <code>ShaSTPrior("lkj",list(1, 10), 1, c(2,2))</code>.</p>
</td></tr>
<tr><td><code id="IndLTPrior_+3A_sha_lt_params">sha_lt_params</code></td>
<td>
<p>A <code>numeric</code> of length <code>d</code> or <code>1</code> containing the standard deviations for the normal prior used on the shared short-term discrepancy <code class="reqn">\mu</code>. If a single value is supplied,  this is repeated for each variable of interest. The default value is <code>5</code>.</p>
</td></tr>
<tr><td><code id="IndLTPrior_+3A_truth_params">truth_params</code></td>
<td>
<p>A <code>TruthPrior</code> object specifying priors for the processes on the truth <code class="reqn">y^{(t)}</code>. The default value is <code>TruthPrior(d)</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p><code>IndSTPrior</code> and <code>ShaSTPrior</code> discrepancy prior parameter objects contain 4 slots corresponding to:
</p>

<ol>
<li> <p><code>parametrisation_form</code> - A <code>character</code> specifying how the priors are parametrised. Currently supported priors are <code>'lkj'</code>, <code>'inv_wishart'</code>, <code>'beta'</code>, <code>'hierarchical'</code>, or <code>'hierarchical_beta_conjugate'</code> (<code>'hierarchical'</code> and <code>'hierarchical_beta_conjugate'</code> are only supported for <code>IndSTPrior</code> objects).
</p>
</li>
<li> <p><code>var_params</code> - The prior parameters for the discrepancy variances, either a <code>list</code> of length <code>2</code> or a <code>numeric</code> of length <code>4</code>. See below.
</p>
</li>
<li> <p><code>cor_params</code> - The correlation matrix parameters, either a <code>list</code> of length <code>2</code>, a <code>numeric</code> of length <code>3</code> or a <code>numeric</code> of length <code>4</code>. See below.
</p>
</li>
<li> <p><code>AR_params</code> - Parameters for the autoregressive parameter as a <code>numeric</code> of length <code>2</code>.
</p>
</li></ol>

<p><code>IndLTPrior</code> discrepancy prior parameter objects contain the slots <code>parametrisation_form</code>, <code>var_params</code>, and <code>cor_params</code>.
</p>
<p>There are currently five supported prior distributions on covariance matrices. As in Spence et. al. (2018), the individual and shared short-term discrepancy covariances, <code class="reqn">\Lambda_k</code> and <code class="reqn">\Lambda_\eta</code>, as well as the individual long-term discrepancy covariance, <code class="reqn">\Lambda_\gamma</code>,  are decomposed into a vector of variances and a correlation matrix </p>
<p style="text-align: center;"><code class="reqn">\Lambda = \sqrt{\mathrm{diag}(\pi)}  P \sqrt{\mathrm{diag}(\pi)},</code>
</p>
<p> where <code class="reqn">\pi</code> is the vector of variances for each variable of interest (VoI), and <code class="reqn">P</code> is the correlation matrix.
</p>
<p>Selecting <code>'lkj'</code>, <code>'inv_wishart'</code>, <code>'beta'</code>, <code>'hierarchical'</code> or <code>'hierarchical_beta_conjugate'</code> refers to setting LKJ, inverse Wishart, beta or hierarchical (with gamma-distributed hyperparameters or beta-conjugate-distributed hyperparameters) prior distributions on the covariance matrix respectively. The variance parameters should be passed through as the <code>var_params</code> slot of the object and the correlation parameters should be passed through as the <code>cor_params</code>. For <code>'lkj'</code>, <code>'inv_wishart'</code>, and <code>'beta'</code> selections, variances are parameterised by gamma distributions, so the <code>var_params</code> slot should be a <code>list</code> of length two, where each element gives the shape and rate parameters for each VoI (either as a single value which is the same for each VoI or a <code>numeric</code> with the same length as the number of VoI). For example, setting <code>var_params  = list(c(5,6,7,8), c(4,3,2,1))</code> would correspond to a <code>Gamma(5, 4)</code> prior on the variance of the first VoI, a <code>Gamma(6, 3)</code> prior on the variance of the second VoI, etc...
The correlations should be in the following form:
</p>

<ul>
<li><p> If <code>'lkj'</code> is selected, then <code>cor_params</code> should be a <code>numeric</code> <code class="reqn">\eta</code> giving the LKJ shape parameter, such  that the probability density is given by  (Lewandowski et. al. 2009) </p>
<p style="text-align: center;"><code class="reqn">f(\Sigma | \eta)\propto \mathrm{det} (\Sigma)^{\eta - 1}.</code>
</p>
<p> Variances are parameterised by gamma distributions.
</p>
</li>
<li><p> If <code>'inv_wishart'</code> is selected, then  <code>cor_params</code> should be a <code>list</code> containing a scalar value <code class="reqn">\eta</code> (giving the degrees of freedom) and a symmetric, positive definite matrix <code class="reqn">S</code> (giving the scale matrix). The dimensions of <code class="reqn">S</code> should be the same as the correlation matrix it produces (i.e <code class="reqn">d \times d</code> where <code class="reqn">d</code> is the number of VoI). The density of an inverse Wishart is given by  </p>
<p style="text-align: center;"><code class="reqn">f(W|\eta, S) = \frac{1}{2^{\eta d/2} \Gamma_N \left( \frac{\eta}{2} \right)} |S|^{\eta/2} |W|^{-(\eta + d + 1)/2}  \exp \left(- \frac{1}{2} \mathrm{tr}\left(SW^{-1} \right) \right),</code>
</p>
<p> where <code class="reqn">\Gamma_N</code> is the multivariate gamma function and <code class="reqn">\mathrm{tr \left(X \right)}</code> is the trace of <code class="reqn">X</code>.  Note that inverse Wishart distributions act over the space of all covariance matrices. When used for a correlation  matrix, only the subset of valid covariance matrices that are also valid correlation matrices are considered. Variances are parameterised by gamma distributions.
</p>
</li>
<li><p> If <code>'beta'</code> is selected, then  <code>cor_params</code> should be a  <code>list</code> containing two symmetric <code>d</code><code class="reqn">\times</code><code>d</code> matrices <code class="reqn">A</code> and <code class="reqn">B</code> giving the prior success parameters and prior failure parameters respectively. The correlation between the <code>i</code>th and <code>j</code>th VoI is <code class="reqn">\rho_{i, j}</code> with </p>
<p style="text-align: center;"><code class="reqn">\frac{1}{\pi} \tan^{-1} \frac{\rho_{i, j}}{\sqrt{1-\rho_{i, j}^2}} + \frac{1}{2} \sim \mathrm{beta}(A_{i, j}, B_{i, j}).</code>
</p>
<p> Variances are parameterised by gamma distributions.
</p>
</li>
<li><p> If <code>'hierarchical'</code> or <code>'hierarchical_beta_conjugate'</code> is selected, then variances are parameterised by log-normal distributions:
</p>
<p style="text-align: center;"><code class="reqn">\log \pi_{k, i} \sim \mathrm{N}(\mu_i, \sigma^2_i)</code>
</p>
<p> with priors
</p>
<p style="text-align: center;"><code class="reqn">\mu_i \sim \mathrm{N}(\alpha_\pi, \beta_\pi),</code>
</p>

<p style="text-align: center;"><code class="reqn">\sigma^2_i \sim \mathrm{InvGamma}(\gamma_\pi, \delta_\pi).</code>
</p>

<p>The <code>var_params</code> slot should then be a <code>numeric</code> of length 4, giving the <code class="reqn">\alpha_\pi, \beta_\pi, \gamma_\pi, \delta_\pi</code> hyperparameters respectively. Correlations (<code class="reqn">\rho_{k, i, j}</code> where <code class="reqn">\rho_{k, i, j}</code> is the correlation between VoI <code class="reqn">i</code> and <code class="reqn">j</code> for the <code class="reqn">k</code>th simulator) are parameterised by hierarchical beta distributions.
</p>
<p style="text-align: center;"><code class="reqn">\frac{\rho_{k, i, j} + 1}{2} \sim \mathrm{beta}(c_{k, i, j}, d_{k, i, j})</code>
</p>
<p> with priors
</p>
<p style="text-align: center;"><code class="reqn">c_{k, i, j} \sim \mathrm{gamma}(\alpha_\rho, \beta_\rho),</code>
</p>

<p style="text-align: center;"><code class="reqn">d_{k, i, j} \sim \mathrm{gamma}(\gamma_\rho, \delta_\rho).</code>
</p>

<p>NOTE: These options is only supported for the individual short-term discrepancy terms.
</p>
</li>
<li><p> If <code>'hierarchical'</code> is selected, then the <code>cor_params</code> slot should be a <code>numeric</code> of length 4 giving the <code class="reqn">\alpha_\rho, \beta_\rho, \gamma_\rho, \delta_\rho</code> hyperparameters. respectively. NOTE: This option is only supported for the individual short-term discrepancy terms.
</p>
</li>
<li><p> If <code>'hierarchical_beta_conjugate'</code> is selected, then the <code>cor_params</code> slot should be a <code>numeric</code> of length 3. Denoting the values by <code class="reqn">r,s,k</code>, they map to the hyperparameters <code class="reqn">p, q, k</code> of the beta conjugate distribution via <code class="reqn">k = k</code>, <code class="reqn">p^{-1/k} = (1+e^{-s})(1+e^{-r})</code> and <code class="reqn">q^{1/k} = e^{-r}(1+e^{-s})^{-1}(1+e^{-r})^{-1}</code>. The density of the beta conjugate distribution is defined up to a constant of proportionality by
</p>
<p style="text-align: center;"><code class="reqn">p(\alpha_\rho, \beta_\rho\,|\,p, q, k) \propto \frac{\Gamma(\alpha_\rho + \beta_\rho)^{k}p^{\alpha_\rho}q^{\beta_\rho}}{\Gamma(\alpha_\rho)^{k}\Gamma(\beta_\rho)^{k}}\,.</code>
</p>

<p>NOTE: This option is only supported for the individual short-term discrepancy terms.
Priors may also be specified for the autoregressive parameters for discrepancies modelled using autoregressive processes (i.e. for <code>IndSTPrior</code> and <code>ShaSTPrior</code> objects). These are parametrised via beta distributions such that the autoregressive parameter <code class="reqn">R \in (-1,1)</code> satisfies </p>
<p style="text-align: center;"><code class="reqn">\frac{R+1}{2} \sim \mathrm{Beta}(\alpha, \beta)</code>
</p>
<p>.
</p>
</li></ul>

<p>In addition to priors on the discrepancy terms, it is also possible to add prior information on the truth. We require priors on the truth at <code class="reqn">t=0</code>. By default, a <code class="reqn">N(0, 10)</code> prior is used on the initial values., however this can be configured by the <code>truth_params</code> argument. The covariance matrix of the random walk of the truth <code class="reqn">\Lambda_y</code> can be configured using an inverse-Wishart prior. The <code>truth_params</code> argument should be a <code>TruthPrior</code> object.
</p>


<h3>Value</h3>

<p><code>EnsemblePrior</code> returns an object of class <code>EnsemblePrior</code>.
<code>IndSTPrior</code> returns an object of class <code>IndSTPrior</code>.
<code>IndLTPrior</code> returns an object of class <code>IndLTPrior</code>.
<code>ShaSTPrior</code> returns an object of class <code>ShaSTPrior</code>.
<code>TruthPrior</code> returns an object of class <code>TruthPrior</code>.
</p>


<h3>References</h3>

<p>Spence et. al. (2018). A general framework for combining ecosystem models. <em>Fish and Fisheries</em>, 19(6):1031-1042.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>##### Different forms of the individual long term discrepancy priors
#LKJ(10) priors on correlation matrices and gamma(5, 3) priors on the variances
ist_lkj &lt;- IndSTPrior("lkj", list(5, 3), 10)#

#Same as above but with an additional beta(2, 4) prior on
#the autoregressive parameter of the AR process.
ist_lkj &lt;- IndSTPrior("lkj", list(5, 3), 10, AR_params = c(2, 4))

#Same as above but with different variance priors for 5 different variables of interest.
#This encodes that there is a gamma(1, 1) prior on the variance of the first variable,
#a gamma(23, 1) on the second variable etc...
ist_lkj &lt;- IndSTPrior("lkj", list(c(1,23,24,6,87), c(1,1,1,1,5)), 10, AR_params = c(2, 4))

#Hierarchical priors with gamma(1,2) and gamma(10, 1) on the variance hyperparameters and
#gamma(3,4), gamma(5,6) on the correlation hyperparameters
ist_hie &lt;- IndSTPrior("hierarchical", list(1,2,10,1), list(3,4,5,6))

#Hierarchical priors with gamma(1,2) and gamma(10, 1) on the variance hyperparameters and
#the beta conjugate prior with parameters (p = 0.75, q = 0.75, k = 0.2) on the
#correlation hyperparameters
ist_hie_beta_conj &lt;- IndSTPrior("hierarchical_beta_conjugate",
list(1,2,10,1), list(0.75,0.75,0.2))

#Inverse Wishart correlation priors. Gamma(2, 1/3) priors are on the variances and
#inv-Wishart(5, diag(5)) on the correlation matrices.
ist_inW &lt;- IndSTPrior("inv_wishart", list(2, 1/3),list(5, diag(5)))

##### TruthPrior
#Simple default truth prior with 7 variables of interest
truth_def &lt;- TruthPrior(7)
# A more fine-tuned truth prior for an ensemble with 7 species.
truth_cus &lt;- TruthPrior(7, initial_mean = 2, initial_var = 10, rw_covariance = list(10, diag(7)))

#The default priors for an ensemble with 8 variables of interest
priors &lt;- EnsemblePrior(8)

#With 4 variables of interest.
priors &lt;- EnsemblePrior(4)

#Defining custom priors for a model with 4 species.
num_species &lt;- 5
priors &lt;- EnsemblePrior(
  d = num_species,
  ind_st_params = IndSTPrior("lkj",  list(3, 2), 3, AR_params = c(2,4)),
  ind_lt_params = IndLTPrior(
    "beta",
    list(c(10,4,8, 7,6),c(2,3,1, 4,4)),
    list(matrix(5, num_species, num_species),
         matrix(0.5, num_species, num_species))
  ),
  sha_st_params = ShaSTPrior("inv_wishart",list(2, 1/3),list(5, diag(num_species))),
  sha_lt_params = 5,
  truth_params = TruthPrior(d = num_species, initial_mean = 5, initial_var = 10,
                            rw_covariance = list(10, diag(10)))
)

</code></pre>

<hr>
<h2 id='IndLTPrior-class'>A class to hold the priors for the ensemble model.</h2><span id='topic+IndLTPrior-class'></span>

<h3>Description</h3>

<p>An <code>IndLTPrior</code> object encapsulates the prior information for the long-term discrepancies of the individual simulators within the ensemble model.
</p>


<h3>Details</h3>

<p>Individual long-term discrepancies <code class="reqn">\gamma_k</code> are drawn from a distribtion </p>
<p style="text-align: center;"><code class="reqn">\gamma_k \sim N(0, C_\gamma).</code>
</p>
<p> Accepted parametrisation forms for this discrepancy are <code>lkj</code>, <code>beta</code>, or <code>inv_wishart</code>. See details of the <code>EnsemblePrior()</code> constructor for more details.
</p>


<h3>Slots</h3>


<dl>
<dt><code>parametrisation_form</code></dt><dd><p>The parametrisation by which the covariance matrix of the noise of the AR process is decomposed.</p>
</dd>
<dt><code>var_params</code></dt><dd><p>The parameters characterising the variance of the distribution of the individual long-term discrepancy.</p>
</dd>
<dt><code>cor_params</code></dt><dd><p>The parameters characterising the correlations of the distribution of the individual long-term discrepancy.</p>
</dd>
</dl>


<h3>See Also</h3>

<p><code><a href="#topic+IndSTPrior-class">IndSTPrior</a></code>, <code><a href="#topic+ShaSTPrior-class">ShaSTPrior</a></code>, <code><a href="#topic+TruthPrior-class">TruthPrior</a></code>,
</p>

<hr>
<h2 id='IndSTPrior-class'>A class to hold the priors for the ensemble model.</h2><span id='topic+IndSTPrior-class'></span>

<h3>Description</h3>

<p>An <code>IndSTPrior</code> object encapsulates the prior information for the short-term discrepancies of the individual simulators within the ensemble model.
</p>


<h3>Details</h3>

<p>Individual short-term discrepancies <code class="reqn">z_k^{(t)}</code> are modelled as an AR(1) process so that </p>
<p style="text-align: center;"><code class="reqn">z_k^{(t+1)} \sim N(R_k z_k^{(t)}, \Lambda_k).</code>
</p>
<p> Accepted parametrisation forms for this discrepancy are <code>lkj</code>, <code>beta</code>, <code>inv_wishart</code>, <code>hierarchical</code> or <code>hierarchical_beta_conjugate</code>. See details of the <code>EnsemblePrior()</code> constructor for more details.
</p>


<h3>Slots</h3>


<dl>
<dt><code>AR_param</code></dt><dd><p>The parameters giving the beta parameters for the autoregressive parameter of the AR(1) process.</p>
</dd>
<dt><code>parametrisation_form</code></dt><dd><p>The parametrisation by which the covariance matrix of the noise of the AR process is decomposed.</p>
</dd>
<dt><code>var_params</code></dt><dd><p>The parameters characterising the variance of the AR process on the individual short-term discrepancy.</p>
</dd>
<dt><code>cor_params</code></dt><dd><p>The parameters characterising the correlations of the AR process on the individual short-term discrepancy. .</p>
</dd>
</dl>


<h3>See Also</h3>

<p><code><a href="#topic+IndLTPrior-class">IndLTPrior</a></code>, <code><a href="#topic+ShaSTPrior-class">ShaSTPrior</a></code>, <code><a href="#topic+TruthPrior-class">TruthPrior</a></code>,
</p>

<hr>
<h2 id='KalmanFilter_back'>Backwards Kalman filter</h2><span id='topic+KalmanFilter_back'></span>

<h3>Description</h3>

<p>Finds the most likely path through a dynamical linear model.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>KalmanFilter_back(rhos, dee, R, Q, C, P, xhat, Time, y, obs)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="KalmanFilter_back_+3A_rhos">rhos</code></td>
<td>
<p>A <code>numeric</code> containing the diagonal elements of the transition matrix of the evolution equation.</p>
</td></tr>
<tr><td><code id="KalmanFilter_back_+3A_dee">dee</code></td>
<td>
<p>A <code>numeric</code> of the same length as <code>rho</code> containing the discrepancies or biases in the observation process.</p>
</td></tr>
<tr><td><code id="KalmanFilter_back_+3A_r">R</code></td>
<td>
<p>A <code>numeric</code> representing the variances of the observation process.</p>
</td></tr>
<tr><td><code id="KalmanFilter_back_+3A_q">Q</code></td>
<td>
<p>A <code>matrix</code> of dimensions <code>length(rho)</code> and <code>length(rho)</code> representing the covariance of the evolution process.</p>
</td></tr>
<tr><td><code id="KalmanFilter_back_+3A_c">C</code></td>
<td>
<p>A a <code>matrix</code> of dimensions <code>length(rho)</code> and <code>length(R)</code> representing the observation operator of the observation process.</p>
</td></tr>
<tr><td><code id="KalmanFilter_back_+3A_p">P</code></td>
<td>
<p>A <code>matrix</code> of dimensions <code>length(rho)</code> and <code>length(rho)</code> representing the covariance matrix of the first state of the evolution process.</p>
</td></tr>
<tr><td><code id="KalmanFilter_back_+3A_xhat">xhat</code></td>
<td>
<p>A <code>numeric</code> of the same length as <code>rho</code> representing the expectation of the first state of the evolution process.</p>
</td></tr>
<tr><td><code id="KalmanFilter_back_+3A_time">Time</code></td>
<td>
<p>A numeric The length of time of the dynamical linear model.</p>
</td></tr>
<tr><td><code id="KalmanFilter_back_+3A_y">y</code></td>
<td>
<p>A <code>matrix</code> of dimensions <code>Time</code> and <code>length(R)</code> of observations of the observation process.</p>
</td></tr>
<tr><td><code id="KalmanFilter_back_+3A_obs">obs</code></td>
<td>
<p>A <code>matrix</code> of dimensions <code>Time</code> and <code>length(R)</code>. <code>1</code> means in the <code>i</code>,<code>j</code>th element means that the <code>j</code>th output is observed at tim <code>i</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>For the model with the evolution process </p>
<p style="text-align: center;"><code class="reqn">x_{t+1}\sim{}N(\rho{}\cdot{}x_{t},Q)</code>
</p>
<p> and observation process </p>
<p style="text-align: center;"><code class="reqn">y_{t}\sim{}N(\rho{}(x_{t} + \delta),diag(R))</code>
</p>
<p>.
</p>
<p>Using the sequential Kalman filter, the function gives the mostly path of <code class="reqn">x_{t}</code> for all <code class="reqn">t</code>.
</p>


<h3>Value</h3>

<p>A <code>matrix</code> with dimensions <code>nrow(time)</code> and <code>length(xhat)</code> representing the most likely values of the latent variables.
</p>


<h3>References</h3>

<p>Chui, C.K. &amp; Chen, G. (2009) Kalman Filtering with Real-Time Applications. Springer, Berlin, Heidelberg, Fourth Edtion.
</p>
<p>Kalman, R. E. (1960) A new approach to linear filtering and prediction problems. Trans. ASME, J. Basic Eng., 82, pp. 35-45.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
fit &lt;- fit_ensemble_model(observations = list(SSB_obs, Sigma_obs),
               simulators = list(list(SSB_ewe, Sigma_ewe, "EwE"),
                                 list(SSB_fs,  Sigma_fs, "FishSUMS"),
                                 list(SSB_lm,  Sigma_lm, "LeMans"),
                                 list(SSB_miz, Sigma_miz, "Mizer")),
               priors = EnsemblePrior(4,
               ind_st_params = IndSTPrior(parametrisation_form = "lkj",
               var_params= list(1,1), cor_params = 10, AR_params = c(2, 2))),
               full_sample = FALSE) #Only optimise in this case
transformed_data &lt;- get_transformed_data(fit)
ex.fit &lt;- fit@point_estimate$par
params &lt;- get_parameters(ex.fit)
ret &lt;- KalmanFilter_back(params$AR_params, params$lt_discrepancies,
                          transformed_data$all_eigenvalues_cov,params$SIGMA,
                          transformed_data$bigM, params$SIGMA_init, params$x_hat,
                          fit@ensemble_data@stan_input$time,transformed_data$new_data,
                          transformed_data$observation_available)

</code></pre>

<hr>
<h2 id='plot.EnsembleSample'>Plot the ensemble output</h2><span id='topic+plot.EnsembleSample'></span>

<h3>Description</h3>

<p>Plots the latent variables predicted by the ensemble model, along with simulator outputs and observations.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'EnsembleSample'
plot(x, variable = NULL, quantiles = c(0.05, 0.95), ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="plot.EnsembleSample_+3A_x">x</code></td>
<td>
<p>An <code>EnsembleSample</code> object.</p>
</td></tr>
<tr><td><code id="plot.EnsembleSample_+3A_variable">variable</code></td>
<td>
<p>The name of the variable to plot. This can either be a <code>character</code> string in the same form as the observation variable, or an index for the column in the observations data frame.</p>
</td></tr>
<tr><td><code id="plot.EnsembleSample_+3A_quantiles">quantiles</code></td>
<td>
<p>A <code>numeric</code> vector of length 2 giving the quantiles for which to plot ribbons if doing a full sampling of the ensemble model. The default is <code>c(0.05,0.95)</code>.</p>
</td></tr>
<tr><td><code id="plot.EnsembleSample_+3A_...">...</code></td>
<td>
<p>Other arguments passed on to methods. Not currently used.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>The <code>ggplot</code> object.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
priors &lt;- EnsemblePrior(4)
prior_density &lt;- prior_ensemble_model(priors, M = 4)
samples &lt;- sample_prior(observations = list(SSB_obs, Sigma_obs),
             simulators = list(list(SSB_miz, Sigma_miz),
                               list(SSB_ewe, Sigma_ewe),
                               list(SSB_fs, Sigma_fs),
                               list(SSB_lm, Sigma_lm)),
             priors = priors,
             sam_priors = prior_density)
plot(samples) #Plot the prior predictive density.
plot(samples, variable="Herring")

</code></pre>

<hr>
<h2 id='prior_ensemble_model'>Generate samples of parameters from prior distribution</h2><span id='topic+prior_ensemble_model'></span>

<h3>Description</h3>

<p>Methods to generates samples of the parameters from the prior distribution of the ensemble model.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>prior_ensemble_model(
  priors,
  M = 1,
  MM = NULL,
  full_sample = TRUE,
  control = list(adapt_delta = 0.95),
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="prior_ensemble_model_+3A_priors">priors</code></td>
<td>
<p>An <code>EnsemblePrior</code> object specifying the prior distributions for the ensemble.</p>
</td></tr>
<tr><td><code id="prior_ensemble_model_+3A_m">M</code></td>
<td>
<p>A <code>numeric</code> that represents the number of simulators. The default is 1.</p>
</td></tr>
<tr><td><code id="prior_ensemble_model_+3A_mm">MM</code></td>
<td>
<p>A <code>numeric</code> that represents the number of drivers. The default is <code>NULL</code>.</p>
</td></tr>
<tr><td><code id="prior_ensemble_model_+3A_full_sample">full_sample</code></td>
<td>
<p>A <code>logical</code> that runs a full sampling of the prior density of the ensemble model if <code>TRUE</code>. If <code>FALSE</code>, returns the point estimate which maximises the prior density of the ensemble model.</p>
</td></tr>
<tr><td><code id="prior_ensemble_model_+3A_control">control</code></td>
<td>
<p>If creating a full sample, this is a named <code>list</code> of parameters to control Stan's sampling behaviour. See the documentation of the <code>stan()</code> function in the <code>rstan</code> package for details. The default value is <code>list(adapt_delta = 0.95)</code>. If optimizing, this value is ignored.</p>
</td></tr>
<tr><td><code id="prior_ensemble_model_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to the function <code>rstan::sampling</code> or  <code>rstan::optimizing</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>list</code> containing two items named <code>samples</code> and <code>point_estimate</code>. If <code>full_sample==TRUE</code>, <code>samples</code> is a <code>stanfit</code> and <code>point_estimate</code> is a <code>NULL</code> object, else <code>samples</code> is a <code>NULL</code> and <code>point_estimate</code> is a <code>list</code> object. It is possible to generate a point estimate for the prior if the individual short-term discrepancy prior follows a hierarchical parameterisation.
</p>


<h3>References</h3>

<p>Stan Development Team (2020). RStan: the R interface to Stan. R package version 2.21.2. https://mc-stan.org
</p>


<h3>See Also</h3>

<p><code><a href="#topic+EnsembleFit-class">EnsembleFit</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
priors &lt;- EnsemblePrior(4)
prior_density &lt;- prior_ensemble_model(priors, M = 4)

</code></pre>

<hr>
<h2 id='sample_prior'>Generate samples of latent variables from prior predictive distribution</h2><span id='topic+sample_prior'></span>

<h3>Description</h3>

<p>Methods to generates samples of the latent variables from the prior predictive distribution of the ensemble model.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>sample_prior(
  observations,
  simulators,
  priors,
  sam_priors,
  num_samples = 1,
  full_sample = TRUE,
  drivers = FALSE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="sample_prior_+3A_observations">observations</code></td>
<td>
<p>A <code>list</code> of length 2 containing observations and a covariance matrix. The first element is a <code>data.frame</code> or <code>matrix</code> with each column giving observations of each output of interest and each row a time. Rows should be named with the times and columns should be named the variables. The second element is is a <code class="reqn">d \times d</code> <code>matrix</code> where <code class="reqn">d</code> is the number of columns of the observations data frame / matrix. This matrix is the covariance matrix of the observations.</p>
</td></tr>
<tr><td><code id="sample_prior_+3A_simulators">simulators</code></td>
<td>
<p>A <code>list</code> with length equal to the number of simulators. For each simulator, there is a <code>list</code> of 2 objects containing the simulator output and covariance matrix. The first element is a <code>data.frame</code> or <code>matrix</code> with each column giving a simulator outputs of interest and each row a time. Rows should be named with the times and columns should be named the variables. The second element is a <code class="reqn">n_k \times n_k</code> <code>matrix</code> where <code class="reqn">n_k</code> is the number of columns of the simulators output data frame / matrix. This matrix is the covariance matrix of the simulator outputs.</p>
</td></tr>
<tr><td><code id="sample_prior_+3A_priors">priors</code></td>
<td>
<p>An <code>EnsemblePrior</code> object specifying the prior distributions for the ensemble.</p>
</td></tr>
<tr><td><code id="sample_prior_+3A_sam_priors">sam_priors</code></td>
<td>
<p>A <code>list</code> containing two items named <code>samples</code> and <code>point_estimate</code>. <code>samples</code> is either a <code>NULL</code> or a <code>stanfit</code> object containing the samples drawn from the prior distribution of the ensemble model and <code>point_estimate</code> is either a <code>NULL</code> or a <code>list</code> object containing the optimised prior distribution of the ensemble model. If this object is <code>missing</code> then <code>sample_prior</code> generates it.</p>
</td></tr>
<tr><td><code id="sample_prior_+3A_num_samples">num_samples</code></td>
<td>
<p>A <code>numeric</code> specifying the number of samples to be generated. The default is 1.</p>
</td></tr>
<tr><td><code id="sample_prior_+3A_full_sample">full_sample</code></td>
<td>
<p>A <code>logical</code> that runs a full sampling of the prior density of the ensemble model if <code>TRUE</code>. If <code>FALSE</code>, returns the point estimate which maximises the prior density of the ensemble model.</p>
</td></tr>
<tr><td><code id="sample_prior_+3A_drivers">drivers</code></td>
<td>
<p>A <code>logical</code> indicating whether drivers have been used in combination with simulators. Default value is FALSE.</p>
</td></tr>
<tr><td><code id="sample_prior_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to the function <code>rstan::sampling</code> or  <code>rstan::optimizing</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The samples are created using the methods described in Strickland et. al. (2009) and Durbin and Koopman (2002).
</p>


<h3>Value</h3>

<p>An <code>EnsembleSample</code> object.
</p>


<h3>References</h3>

<p>J. Durbin, S. J. Koopman (2002) A simple and efficient simulation smoother for state space time series analysis Biometrika, Volume 89, Issue 3, August 2002, Pages 603-616,
</p>
<p>Chris M.Strickland, Ian. W.Turner, RobertDenhamb, Kerrie L.Mengersena. Efficient Bayesian estimation of multivariate state space models Computational Statistics &amp; Data Analysis Volume 53, Issue 12, 1 October 2009, Pages 4116-4125
</p>


<h3>See Also</h3>

<p><code><a href="#topic+EnsembleFit-class">EnsembleFit</a></code>, <code><a href="#topic+EnsembleSample">EnsembleSample</a></code>, <code><a href="#topic+generate_sample">generate_sample</a></code>, <code><a href="#topic+prior_ensemble_model">prior_ensemble_model</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
priors &lt;- EnsemblePrior(4)
prior_density &lt;- prior_ensemble_model(priors, M = 4)
samples &lt;- sample_prior(observations = list(SSB_obs, Sigma_obs),
             simulators = list(list(SSB_miz, Sigma_miz),
                               list(SSB_ewe, Sigma_ewe),
                               list(SSB_fs, Sigma_fs),
                               list(SSB_lm, Sigma_lm)),
             priors = priors,
             sam_priors = prior_density)
plot(samples) #Plot the prior predictive density.

</code></pre>

<hr>
<h2 id='ShaSTPrior-class'>A class to hold the priors for the ensemble model.</h2><span id='topic+ShaSTPrior-class'></span>

<h3>Description</h3>

<p>An <code>ShaSTPrior</code> object encapsulates the prior information for the short-term discrepancies of the shared discrepancy of the ensemble model.
</p>


<h3>Details</h3>

<p>Shared short-term discrepancies <code class="reqn">\mathbf{\eta}^{(t)}</code> are modelled as an AR(1) process so that </p>
<p style="text-align: center;"><code class="reqn">\mathbf{\eta}^{(t+1)} \sim N(R_\eta \mathbf{\eta}, \Lambda_\eta).</code>
</p>
<p> Accepted parametrisation forms for this discrepancy are <code>lkj</code>, <code>beta</code>, or <code>inv_wishart</code>. See details of the <code>EnsemblePrior()</code> constructor for more details.
</p>


<h3>Slots</h3>


<dl>
<dt><code>AR_param</code></dt><dd><p>The parameters giving the beta parameters for the main parameter of the AR(1) process.</p>
</dd>
<dt><code>parametrisation_form</code></dt><dd><p>The parametrisation by which the covariance matrix of the noise of the AR process is decomposed.</p>
</dd>
<dt><code>var_params</code></dt><dd><p>The parameters characterising the variance of the AR process on the shared short-term discrepancy.</p>
</dd>
<dt><code>cor_params</code></dt><dd><p>The parameters characterising the correlations of the AR process on the shared short-term discrepancy.</p>
</dd>
</dl>

<hr>
<h2 id='Sigma_ewe'>Ecopath with EcoSim Sigma</h2><span id='topic+Sigma_ewe'></span>

<h3>Description</h3>

<p>A 4x4 covariance matrix quantifying the parameter uncertainty of Ecopath with EcoSim
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Sigma_ewe
</code></pre>


<h3>Format</h3>

<p>A 4x4 <code>matrix</code>.
</p>


<h3>References</h3>

<p>Mackinson, S., Platts, M., Garcia, C., and Lynam, C. (2018). Evaluating the fishery and ecological consequences of the proposed North Sea multi-annual plan. PLOS ONE, 13(1), 1–23.
</p>

<hr>
<h2 id='Sigma_fs'>FishSUMS Sigma</h2><span id='topic+Sigma_fs'></span>

<h3>Description</h3>

<p>A 3x3 covariance matrix quantifying the parameter uncertainty of FishSUMS
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Sigma_fs
</code></pre>


<h3>Format</h3>

<p>A 3x3 <code>matrix</code>.
</p>


<h3>References</h3>

<p>Spence, M. A., Blanchard, J. L., Rossberg, A. G., Heath, M. R., Heymans, J. J., Mackinson, S., Serpetti, N., Speirs, D. C., Thorpe, R. B., and Blackwell, P. G. (2018). A general framework for combining ecosystem models. Fish and Fisheries, 19(6), 1031–1042.
</p>

<hr>
<h2 id='Sigma_lm'>LeMans Sigma</h2><span id='topic+Sigma_lm'></span>

<h3>Description</h3>

<p>LeMans Sigma
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Sigma_lm
</code></pre>


<h3>Format</h3>

<p>A 4x4 <code>matrix</code>.
A 4x4 covariance matrix quantifying the parameter uncertainty of LeMans
</p>


<h3>References</h3>

<p>Thorpe, R. B., Le Quesne, W. J. F., Luxford, F., Collie, J. S., and Jennings, S. (2015). Evaluation and management implications of uncertainty in a multispecies size-structured model of population and community responses to fishing. Methods in Ecology and Evolution, 6(1), 49–58.
</p>

<hr>
<h2 id='Sigma_miz'>mizer Sigma</h2><span id='topic+Sigma_miz'></span>

<h3>Description</h3>

<p>mizer Sigma
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Sigma_miz
</code></pre>


<h3>Format</h3>

<p>A 4x4 <code>matrix</code>.
A 4x4 covariance matrix quantifying the parameter uncertainty of mizer
</p>


<h3>References</h3>

<p>Spence, M. A., Blackwell, P. G., and Blanchard, J. L. (2016). Parameter uncertainty of a dynamic multispecies size spectrum model. Canadian Journal of Fisheries and Aquatic Sciences, 73(4), 589–59
</p>

<hr>
<h2 id='Sigma_obs'>Stock assessment Sigma</h2><span id='topic+Sigma_obs'></span>

<h3>Description</h3>

<p>A 4x4 covariance matrix quantifying the covariances of the stock assessment estimates of biomass.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Sigma_obs
</code></pre>


<h3>Format</h3>

<p>A 4x4 <code>matrix</code>.
</p>


<h3>References</h3>

<p>Herring Assessment Working Group for the Area South of 62 N (HAWG).Technical report,
ICES Scientific Reports. ACOM:07. 960 pp, ICES, Copenhagen.
</p>
<p>Report of the Working Group on the Assessment of Demersal Stocks inthe North Sea and
Skagerrak. Technical report, ICES Scientific Reports. ACOM:22.pp, ICES, Copenhagen.
</p>

<hr>
<h2 id='SSB_ewe'>Ecopath with EcoSim SSB</h2><span id='topic+SSB_ewe'></span>

<h3>Description</h3>

<p>A dataset containing the predictions for spawning stock biomass of Norway Pout, Herring, Cod, and Sole in the North Sea between 1991-2050 under an MSY fishing scenario from EcoPath with EcoSim.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>SSB_ewe
</code></pre>


<h3>Format</h3>

<p>A <code>data.frame</code> with 60 rows and 4 variables:
</p>

<dl>
<dt><code>N.pout</code></dt><dd><p>Spawning stock biomass of Norway Pout, in log tonnes.</p>
</dd>
<dt><code>Herring</code></dt><dd><p>Spawning stock biomass of Herring, in log tonnes.</p>
</dd>
<dt><code>Cod</code></dt><dd><p>Spawning stock biomass of Cod, in log tonnes.</p>
</dd>
<dt><code>Sole</code></dt><dd><p>Spawning stock biomass of Sole, in log tonnes.</p>
</dd>
</dl>



<h3>References</h3>

<p>ICES (2016). Working Group on Multispecies Assessment Methods (WGSAM). Technical report, International Council for Exploration of the Seas.
</p>

<hr>
<h2 id='SSB_fs'>FishSUMS SSB</h2><span id='topic+SSB_fs'></span>

<h3>Description</h3>

<p>A <code style="white-space: pre;">&#8288;data frame&#8288;</code> containing the predictions for spawning stock biomass of Norway Pout, Herring, and Cod
in the North Sea between 1984-2050 under an MSY fishing scenario from FishSUMS. Note that FishSUMS does not
produce outputs for Sole.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>SSB_fs
</code></pre>


<h3>Format</h3>

<p>A <code>data.frame</code> with 67 rows and 3 variables:
</p>

<dl>
<dt><code>N.pout</code></dt><dd><p>Spawning stock biomass of Norway Pout, in log tonnes.</p>
</dd>
<dt><code>Herring</code></dt><dd><p>Spawning stock biomass of Herring, in log tonnes.</p>
</dd>
<dt><code>Cod</code></dt><dd><p>Spawning stock biomass of Cod, in log tonnes.</p>
</dd>
</dl>



<h3>References</h3>

<p>Speirs, D., Greenstreet, S., and Heath, M. (2016). Modelling the effects of fishing on the North Sea fish community size composition. Ecological Modelling, 321, 35–45
</p>

<hr>
<h2 id='SSB_lm'>LeMans SSB</h2><span id='topic+SSB_lm'></span>

<h3>Description</h3>

<p>A <code>data.frame</code> containing the predictions for spawning stock biomass of Norway Pout, Herring, Cod, and Sole
in the North Sea between 1986-2050 under an MSY fishing scenario from the LeMaRns package.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>SSB_lm
</code></pre>


<h3>Format</h3>

<p>A <code>data.frame</code> with 65 rows and 4 variables:
</p>

<dl>
<dt><code>N.pout</code></dt><dd><p>Spawning stock biomass of Norway Pout, in log tonnes.</p>
</dd>
<dt><code>Herring</code></dt><dd><p>Spawning stock biomass of Herring, in log tonnes.</p>
</dd>
<dt><code>Cod</code></dt><dd><p>Spawning stock biomass of Cod, in log tonnes.</p>
</dd>
<dt><code>Sole</code></dt><dd><p>Spawning stock biomass of Sole, in log tonnes.</p>
</dd>
</dl>



<h3>References</h3>

<p>Thorpe, R. B., Le Quesne, W. J. F., Luxford, F., Collie, J. S., and Jennings, S. (2015). Evaluation and management implications of uncertainty in a multispecies size-structured model of population and community responses to fishing. Methods in Ecology and Evolution, 6(1), 49–58.
</p>

<hr>
<h2 id='SSB_miz'>mizer SSB</h2><span id='topic+SSB_miz'></span>

<h3>Description</h3>

<p>A <code>data.frame</code> containing the predictions for spawning stock biomass of Norway Pout, Herring, Cod, and Sole
in the North Sea between 1984-2050 under an MSY fishing scenario from mizer.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>SSB_miz
</code></pre>


<h3>Format</h3>

<p>A data frame with 67 rows and 4 variables:
</p>

<dl>
<dt><code>N.pout</code></dt><dd><p>Spawning stock biomass of Norway Pout, in log tonnes.</p>
</dd>
<dt><code>Herring</code></dt><dd><p>Spawning stock biomass of Herring, in log tonnes.</p>
</dd>
<dt><code>Cod</code></dt><dd><p>Spawning stock biomass of Cod, in log tonnes.</p>
</dd>
<dt><code>Sole</code></dt><dd><p>Spawning stock biomass of Sole, in log tonnes.</p>
</dd>
</dl>



<h3>References</h3>

<p>Blanchard, J. L., Andersen, K. H., Scott, F., Hintzen, N. T., Piet, G., and Jennings, S. (2014). Evaluating targets and trade-offs among fisheries and conservation objectives using a multispecies size spectrum model. Journal of Applied Ecology, 51(3), 612–622
</p>

<hr>
<h2 id='SSB_obs'>Stock assessment SSB</h2><span id='topic+SSB_obs'></span>

<h3>Description</h3>

<p>A <code>data.frame</code> containing the single species stock assessment estimates of spawning stock
biomass of Norway Pout, Herring, Cod, and Sole in the North Sea between 1984-2017.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>SSB_obs
</code></pre>


<h3>Format</h3>

<p>A data frame with 34 rows and 4 variables:
</p>

<dl>
<dt><code>N.pout</code></dt><dd><p>Spawning stock biomass of Norway Pout, in log tonnes.</p>
</dd>
<dt><code>Herring</code></dt><dd><p>Spawning stock biomass of Herring, in log tonnes.</p>
</dd>
<dt><code>Cod</code></dt><dd><p>Spawning stock biomass of Cod, in log tonnes.</p>
</dd>
<dt><code>Sole</code></dt><dd><p>Spawning stock biomass of Sole, in log tonnes.</p>
</dd>
</dl>



<h3>References</h3>

<p>Herring Assessment Working Group for the Area South of 62 N (HAWG)(2020).Technical report,
ICES Scientific Reports. ACOM:07. 960 pp, ICES, Copenhagen.
</p>
<p>Report of the Working Group on the Assessment of Demersal Stocks in the North Sea and
Skagerrak (2020). Technical report, ICES Scientific Reports. ACOM:22.pp, ICES, Copenhagen.
</p>

<hr>
<h2 id='TruthPrior-class'>A class to hold the priors for the truth model in the ensemble framework</h2><span id='topic+TruthPrior-class'></span>

<h3>Description</h3>

<p>An <code>TruthPrior</code> object encapsulates the prior information for the short-term discrepancies of the shared discrepancy of the ensemble model.
</p>


<h3>Details</h3>

<p>The truth <code class="reqn">\mathbf{y}^{(t)}</code> is modelled as a random walk such that </p>
<p style="text-align: center;"><code class="reqn">\mathbf{y}^{(t+1)} \sim N(\mathbf{y}^{(t)}, \Lambda_y).</code>
</p>
<p> The covariance matrix <code class="reqn">\Lambda_y</code> is parameterised by an inverse Wishart distribution (contained in the <code>rw_covariance</code> slot) and the initial value is modelled as drawn from a normal distribution.
</p>


<h3>Slots</h3>


<dl>
<dt><code>d</code></dt><dd><p>A <code>numeric</code> giving the number of variables of interest in the ensemble model.</p>
</dd>
<dt><code>initial_mean</code></dt><dd><p>A <code>numeric</code> giving the standard deviation of the normal prior on the initial mean value of the random walk. This is the same standard deviation for each variable of interest.</p>
</dd>
<dt><code>initial_var</code></dt><dd><p>A <code>list</code> of length <code>2</code> containing the shape and scale parameters (respectively) for the gamma priors on the variance of the initial value of the truth.</p>
</dd>
<dt><code>rw_covariance</code></dt><dd><p>A <code>list</code> of length <code>2</code> containing the inverse-Wishart parameters for the covariance of the random walk of the truth.</p>
</dd>
</dl>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
