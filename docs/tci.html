<!DOCTYPE html><html><head><title>Help for package tci</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {tci}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#apply_tci'><p>Apply a TCI algorithm to a 'pkmod' object</p></a></li>
<li><a href='#assign_pars'><p>Set default PK parameter values</p>
Set default PK parameter values for a pkmod object.</a></li>
<li><a href='#bayes_update'><p>Update PK-PD model parameters using observed data values</p></a></li>
<li><a href='#clc'><p>Simulate closed-loop control</p></a></li>
<li><a href='#eleveld_pd'><p>Eleveld et al. pharmacodynamic data</p></a></li>
<li><a href='#eleveld_pk'><p>Eleveld et al. pharmacokinetic data</p></a></li>
<li><a href='#elvdlpars'><p>Get logged parameters updated in Eleveld model</p></a></li>
<li><a href='#emax'><p>Emax function</p></a></li>
<li><a href='#emax_eleveld'><p>Emax function for Eleveld (2018) model.</p></a></li>
<li><a href='#emax_inv'><p>Inverse Emax function</p></a></li>
<li><a href='#emax_inv_eleveld'><p>Inverse Emax function</p></a></li>
<li><a href='#emax_inv_remi'><p>Inverse Emax function implemented by Eleveld remifentanil model</p></a></li>
<li><a href='#emax_remi'><p>Emax function implemented by Eleveld remifentanil model</p></a></li>
<li><a href='#format_pars'><p>Format parameters for use in Rcpp functions</p>
</p>
<p>Order parameters for 1-4 compartment models to be used in Rcpp functions in</p>
predict_pkmod method.</a></li>
<li><a href='#inf_manual'><p>infusion schedule</p></a></li>
<li><a href='#inf_tci'><p>Target-controlled infusion</p></a></li>
<li><a href='#infer_pkfn'><p>Identify pkfn from parameter names</p></a></li>
<li><a href='#init_pkmod'><p>Create an object with class &quot;pkmod&quot;</p></a></li>
<li><a href='#init_poppkmod'><p>Initialize a 'poppkmod' object.</p></a></li>
<li><a href='#list_parnms'><p>Identify pkfn from parameter names</p></a></li>
<li><a href='#list_pkmods'><p>Print population PK models available in 'tci'</p></a></li>
<li><a href='#log_likelihood'><p>Evaluate the log likelihood of a vector of parameter values</p></a></li>
<li><a href='#log_posterior_neg'><p>Evaluate the negative log posterior value of a parameter vector</p></a></li>
<li><a href='#log_prior'><p>Calculate logged-prior probability for a set of parameters</p></a></li>
<li><a href='#olc'><p>Simulate open-loop control</p></a></li>
<li><a href='#pkmod'><p>Create a pkmod object</p></a></li>
<li><a href='#pkmod_eleveld_ppf'><p>Eleveld population PK model for propofol</p></a></li>
<li><a href='#pkmod_eleveld_remi'><p>Eleveld population PK model for remifentanil</p></a></li>
<li><a href='#pkmod_kim'><p>Kim population PK model for remifentanil</p></a></li>
<li><a href='#pkmod_marsh'><p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</p>
Population PK and PK-PD functions &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-
&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;
Marsh population PK model for propofol</a></li>
<li><a href='#pkmod_minto'><p>Minto population PK model for remifentanil</p></a></li>
<li><a href='#pkmod_schnider'><p>Schnider population PK model for propofol</p></a></li>
<li><a href='#pkmod1cpt'><p>One compartment IV infusion with first-order elimination.</p></a></li>
<li><a href='#pkmod2cpt'><p>Two compartment IV infusion with first-order elimination.</p></a></li>
<li><a href='#pkmod3cpt'><p>Three compartment IV infusion with first-order elimination.</p></a></li>
<li><a href='#pkmod3cptm'><p>Solution to three-compartment IV model with effect-site</p></a></li>
<li><a href='#plot.sim_tci'><p>Plot method for sim_tci class</p></a></li>
<li><a href='#poppkmod'><p>Implement a population pharmacokinetic/pharmacodynamic model.</p></a></li>
<li><a href='#predict.pkmod'><p>Predict method for pkmod objects</p></a></li>
<li><a href='#predict.poppkmod'><p>Predict method for pkmod objects</p></a></li>
<li><a href='#print.pkmod'><p>Print pkmod</p></a></li>
<li><a href='#print.poppkmod'><p>Print poppkmod</p></a></li>
<li><a href='#print.sim_tci'><p>Print method for sim_tci class</p></a></li>
<li><a href='#sample_iiv'><p>Sample PK or PK-PD parameters from the distribution of inter- or intra-individual variability</p></a></li>
<li><a href='#sample_pkmod'><p>Sample parameters from a 'pkmod' object</p></a></li>
<li><a href='#simulate_clc'><p>Simulate closed-loop control using Bayesian updates</p></a></li>
<li><a href='#simulate_olc'><p>Simulate open-loop control using TCI</p></a></li>
<li><a href='#simulate_tci'><p>Simulate open- or closed-loop control</p></a></li>
<li><a href='#simulate.pkmod'><p>Simulate method for pkmod objects</p></a></li>
<li><a href='#simulate.poppkmod'><p>Summary method for 'poppkmod' objects</p></a></li>
<li><a href='#tci_documentation'><p>tci_documentation</p></a></li>
<li><a href='#tci_effect'><p>Effect-site TCI algorithm with plasma targeting within small range of target</p></a></li>
<li><a href='#tci_effect_only'><p>TCI algorithm for effect-site targeting</p></a></li>
<li><a href='#tci_plasma'><p>TCI algorithm for plasma targeting</p></a></li>
<li><a href='#update.pkmod'><p>Update method for pkmod</p></a></li>
<li><a href='#validate_pkmod'><p>pkmod validation checks</p></a></li>
<li><a href='#validate_poppkmod'><p>Perform validation checks on a 'poppkmod' object</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Title:</td>
<td>Target Controlled Infusion (TCI)</td>
</tr>
<tr>
<td>Version:</td>
<td>0.2.0</td>
</tr>
<tr>
<td>Description:</td>
<td>Implementation of target-controlled infusion algorithms for compartmental pharmacokinetic and pharmacokinetic-pharmacodynamic models. Jacobs (1990) &lt;<a href="https://doi.org/10.1109%2F10.43622">doi:10.1109/10.43622</a>&gt;; Marsh et al. (1991) &lt;<a href="https://doi.org/10.1093%2Fbja%2F67.1.41">doi:10.1093/bja/67.1.41</a>&gt;; Shafer and Gregg (1993) &lt;<a href="https://doi.org/10.1007%2FBF01070999">doi:10.1007/BF01070999</a>&gt;; Schnider et al. (1998) &lt;<a href="https://doi.org/10.1097%2F00000542-199805000-00006">doi:10.1097/00000542-199805000-00006</a>&gt;; Abuhelwa, Foster, and Upton (2015) &lt;<a href="https://doi.org/10.1016%2Fj.vascn.2015.03.004">doi:10.1016/j.vascn.2015.03.004</a>&gt;; Eleveld et al. (2018) &lt;<a href="https://doi.org/10.1016%2Fj.bja.2018.01.018">doi:10.1016/j.bja.2018.01.018</a>&gt;.</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 3.6.0)</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a></td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>LazyData:</td>
<td>true</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://github.com/jarretrt/tci">https://github.com/jarretrt/tci</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/jarretrt/tci/issues">https://github.com/jarretrt/tci/issues</a></td>
</tr>
<tr>
<td>Imports:</td>
<td>ggplot2, stats, utils, truncnorm, mvtnorm, gridExtra, reshape,
reshape2, xtable, Rcpp, knitr</td>
</tr>
<tr>
<td>LinkingTo:</td>
<td>Rcpp, RcppArmadillo</td>
</tr>
<tr>
<td>Suggests:</td>
<td>testthat (&ge; 2.1.0), rmarkdown, mrgsolve</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.1.1</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>yes</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2022-08-14 22:55:48 UTC; ryanjarrett</td>
</tr>
<tr>
<td>Author:</td>
<td>Ryan Jarrett [aut, cre]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Ryan Jarrett &lt;ryantjarrett@gmail.com&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2022-08-15 08:50:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='apply_tci'>Apply a TCI algorithm to a 'pkmod' object</h2><span id='topic+apply_tci'></span>

<h3>Description</h3>

<p>Apply a TCI algorithm to a set of targets and a 'pkmod' object to calculate infusion
rates.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>apply_tci(
  pkmod,
  target_vals,
  target_tms,
  type = c("plasma", "effect"),
  dtm = NULL,
  custom_alg = NULL,
  inittm = 0,
  ignore_pd = FALSE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="apply_tci_+3A_pkmod">pkmod</code></td>
<td>
<p>'pkmod' object created by 'pkmod()'.</p>
</td></tr>
<tr><td><code id="apply_tci_+3A_target_vals">target_vals</code></td>
<td>
<p>A vector of numeric values indicating PK or PD targets for TCI algorithm.</p>
</td></tr>
<tr><td><code id="apply_tci_+3A_target_tms">target_tms</code></td>
<td>
<p>A vector of numeric values indicating times at which the TCI algorithm should
begin targeting each value.</p>
</td></tr>
<tr><td><code id="apply_tci_+3A_type">type</code></td>
<td>
<p>Type of TCI algorithm to be used. Options are plasma- or effect-site
targeting.</p>
</td></tr>
<tr><td><code id="apply_tci_+3A_dtm">dtm</code></td>
<td>
<p>TCI update frequency. Defaults to 1/6, corresponding to 10-second
intervals if model parameters are in terms of minutes.</p>
</td></tr>
<tr><td><code id="apply_tci_+3A_custom_alg">custom_alg</code></td>
<td>
<p>Custom TCI algorithm to be used instead of default plasma-
or effect-site targeting algorithms. The algorithm should be a function that
takes minimum arguments 'Ct', 'pkmod', and 'dtm' and returns a single infusion
rate. See 'tci_plasma' or 'tci_effect' for examples and vignette on custom
models/algorithms for more details.</p>
</td></tr>
<tr><td><code id="apply_tci_+3A_inittm">inittm</code></td>
<td>
<p>Initial time to start TCI algorithm. Cannot be greater than
the minimum value of 'target_tms'.</p>
</td></tr>
<tr><td><code id="apply_tci_+3A_ignore_pd">ignore_pd</code></td>
<td>
<p>Logical. Should the PD component of the pkmod object (if present)
be ignored. By default, predict.tciinf will assume that 'value' refers to PD
targets if a PD model is specified.</p>
</td></tr>
<tr><td><code id="apply_tci_+3A_...">...</code></td>
<td>
<p>Arguments passed to TCI algorithm</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'># 3-compartment model with effect-site
my_mod &lt;- pkmod(pars_pk = c(v1 = 8.995, v2 = 17.297, v3 = 120.963, cl = 1.382,
q2 = 0.919, q3 = 0.609, ke0 = 1.289))
# plasma targeting
apply_tci(my_mod, target_vals = c(2,3,4,4), target_tms = c(0,2,3,10), "plasma")
# effect-site targeting
apply_tci(my_mod, target_vals = c(2,3,4,4), target_tms = c(0,2,3,10), "effect")
# incorporate  PD model
my_mod_pd &lt;- update(my_mod, pars_pd = c(c50 = 2.8, gamma = 1.47, e0 = 93, emx = 93),
pdfn = emax, pdinv = emax_inv)
apply_tci(my_mod_pd, target_vals = c(70,60,50,50), target_tms = c(0,2,3,10), "effect")
</code></pre>

<hr>
<h2 id='assign_pars'>Set default PK parameter values
Set default PK parameter values for a pkmod object.</h2><span id='topic+assign_pars'></span>

<h3>Description</h3>

<p>Set default PK parameter values
Set default PK parameter values for a pkmod object.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>assign_pars(pkmod, pars)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="assign_pars_+3A_pkmod">pkmod</code></td>
<td>
<p>pkmod object</p>
</td></tr>
<tr><td><code id="assign_pars_+3A_pars">pars</code></td>
<td>
<p>PK parameters to assign as default values of pkmod</p>
</td></tr>
</table>


<h3>Value</h3>

<p>pkmod object
</p>

<hr>
<h2 id='bayes_update'>Update PK-PD model parameters using observed data values</h2><span id='topic+bayes_update'></span>

<h3>Description</h3>

<p>Function will update parameters of 'pkmod' object based on available data using
a Laplace approximation to the posterior. Parameters and &quot;Omega&quot; values from
'pkmod' are used as prior point estimates and variance terms, respectively.
Parameters fixed within the Omega matrix are assumed to be fixed and are not updated.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>bayes_update(lpars, pkmod, inf, tms, obs, update_init = FALSE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="bayes_update_+3A_lpars">lpars</code></td>
<td>
<p>Logged parameter values. Can be a subset of the full set of PK or PK-PD parameter values.</p>
</td></tr>
<tr><td><code id="bayes_update_+3A_pkmod">pkmod</code></td>
<td>
<p>'pkmod' object. Mean values are a subset of log(pars_pk), log(pars_pd),
log(sigma_add), log(sigma_mult). PK-PD parameter values not specified in 'lpars' will be inferred from 'pkmod'.</p>
</td></tr>
<tr><td><code id="bayes_update_+3A_inf">inf</code></td>
<td>
<p>Infusion schedule</p>
</td></tr>
<tr><td><code id="bayes_update_+3A_tms">tms</code></td>
<td>
<p>Times associated with observations</p>
</td></tr>
<tr><td><code id="bayes_update_+3A_obs">obs</code></td>
<td>
<p>Observed values (concentrations or PD response values)</p>
</td></tr>
<tr><td><code id="bayes_update_+3A_update_init">update_init</code></td>
<td>
<p>Logical. Should initial values be updated in addition to parameter values?</p>
</td></tr>
<tr><td><code id="bayes_update_+3A_...">...</code></td>
<td>
<p>Arguments passed to update.pkmod</p>
</td></tr>
</table>


<h3>Value</h3>

<p>'pkmod' object with PK/PK-PD/sigma parameters updated based on minimizing negative logged posterior.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># evaluate negative log posterior at a new set of parameters
lpars = log(c(cl=11,q2=3,q3=25,v=20,v2=40,v3=80,ke0=1.15,sigma_add=0.3))
prior_vcov &lt;- matrix(diag(c(0.265,0.346,0.209,0.610,0.565,0.597,0.702,0.463)),
8,8, dimnames = list(NULL,names(lpars)))
my_mod &lt;- pkmod(pars_pk = c(cl = 10, q2 = 2, q3 =20, v = 15, v2 = 30, v3 = 50, ke0 = 1.2),
sigma_add = 0.2, log_response = TRUE, Omega = prior_vcov)
inf &lt;- inf_manual(inf_tms = 0, inf_rate = 80, duration = 2)
tms &lt;- c(1,2,4,8,12)
obs &lt;- simulate(my_mod, inf = inf, tms = tms)
bayes_update(lpars, my_mod, inf, tms, obs)

# evaluate log-prior for subset of parameters (remove volume parameters)
lpars_sub = log(c(cl=11,q2=3,q3=25,ke0=1.15,sigma_add=0.15))
my_mod &lt;- update(my_mod, Omega = matrix(diag(c(0.265,0.346,0.209,0.702,0.463)),5,5,
 dimnames = list(NULL,names(lpars_sub))))
bayes_update(lpars_sub, my_mod, inf, tms, obs)

# add a pd response and replace multiplicative error with additive error
my_mod_pd &lt;- update(my_mod, pars_pd = c(c50 = 2.8, gamma = 1.47, e0 = 93, emx = 93),
pdfn = emax, pdinv = emax_inv, ecmpt = 4, sigma_mult = 0, sigma_add = 4)
# simulate observations
obs_pd &lt;- simulate(my_mod_pd, inf = inf, tms = seq(0,12,0.5))
# evaluate likelihood at new parameters
lpars_pd_eval = log(c(cl=11,q3=25,v=15,ke0=1.15,sigma_add=4,c50=5,gamma=1))
prior_vcov_pd &lt;- matrix(diag(c(0.265,0.209,0.610,0.702,0.230,0.242,0.1)),7,7,
dimnames = list(NULL,names(lpars_pd_eval)))
my_mod_pd &lt;- update(my_mod_pd, Omega = prior_vcov_pd)
bayes_update(lpars_pd_eval, my_mod_pd, inf, tms, obs_pd)
</code></pre>

<hr>
<h2 id='clc'>Simulate closed-loop control</h2><span id='topic+clc'></span>

<h3>Description</h3>

<p>Simulate closed-loop control using Bayesian updates.
Infusion rates are calculated using 'pkmod_prior' to reach 'target_vals' at
'target_tms'. Data values are simulated using 'pkmod_true' at 'obs_tms'.
'pkmod_prior' and 'pkmod_true' do not need to have the same structure. Model
parameters are updated at each update time using all available simulated observations.
Processing delays can be added through the 'delay' argument, such that observations
aren't made available to the update mechanism until 'update_tms &gt;= obs_tms + delay'.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>clc(
  pkmod_prior,
  pkmod_true,
  target_vals,
  target_tms,
  obs_tms,
  update_tms,
  type = c("effect", "plasma"),
  custom_alg = NULL,
  resp_bounds = NULL,
  delay = 0,
  seed = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="clc_+3A_pkmod_prior">pkmod_prior</code></td>
<td>
<p>'pkmod' object describing a PK/PK-PD model that is used to calculate
TCI infusion rates and is updated as data are simulated and incorporated. Must have an
associated Omega matrix.</p>
</td></tr>
<tr><td><code id="clc_+3A_pkmod_true">pkmod_true</code></td>
<td>
<p>&lsquo;pkmod' object describing the patient&rsquo;s &quot;true&quot; response. This model
will be used to simulate observations.</p>
</td></tr>
<tr><td><code id="clc_+3A_target_vals">target_vals</code></td>
<td>
<p>A vector of numeric values indicating PK or PD targets for TCI algorithm.</p>
</td></tr>
<tr><td><code id="clc_+3A_target_tms">target_tms</code></td>
<td>
<p>A vector of numeric values indicating times at which the TCI algorithm should
begin targeting each value.</p>
</td></tr>
<tr><td><code id="clc_+3A_obs_tms">obs_tms</code></td>
<td>
<p>Times at which data values should be simulated from 'pkmod_true'.</p>
</td></tr>
<tr><td><code id="clc_+3A_update_tms">update_tms</code></td>
<td>
<p>Times at which 'pkmod_prior' should be updated using all available
simulated observations.</p>
</td></tr>
<tr><td><code id="clc_+3A_type">type</code></td>
<td>
<p>Type of TCI algorithm to be used. Options are &quot;plasma&quot; and &quot;effect&quot;.
Defaults to &quot;effect&quot;. Will be overwritten if 'custom_alg' is non-null.</p>
</td></tr>
<tr><td><code id="clc_+3A_custom_alg">custom_alg</code></td>
<td>
<p>Custom TCI algorithm to overwrite default plasma- or effect-site targeting.</p>
</td></tr>
<tr><td><code id="clc_+3A_resp_bounds">resp_bounds</code></td>
<td>
<p>Optional vector of two values indicating minimum and maximum values possible for the response.</p>
</td></tr>
<tr><td><code id="clc_+3A_delay">delay</code></td>
<td>
<p>Optional numeric value indicating a temporal delay between when observations
are simulated and when they should be made available for updating 'pkmod_prior'. For example,
a delay should be set to account for a processing time delay in Bispectral Index measurements
or the time required to measure drug concentrations from collected samples.</p>
</td></tr>
<tr><td><code id="clc_+3A_seed">seed</code></td>
<td>
<p>An integer used to initialize the random number generator.</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>prior_vcov &lt;- matrix(diag(c(0.265,0.346,0.209,0.610,0.565,0.597,0.702,0.463)),
8,8, dimnames = list(NULL,c('cl','q2','q3','v','v2','v3','ke0','sigma_add')))
pkmod_prior &lt;- pkmod(pars_pk = c(cl = 10, q2 = 2, q3 =20, v = 15, v2 = 30, v3 = 50, ke0 = 1.2),
sigma_add = 0.2, log_response = TRUE, Omega = prior_vcov)
pkmod_true  &lt;- pkmod(pars_pk = c(cl = 16, q2 = 4, q3 =10, v = 20, v2 = 20, v3 = 80, ke0 = 0.8),
sigma_add = 0.1, log_response = TRUE)
target_vals &lt;- c(2,3,4,3,3)
target_tms &lt;- c(0,5,10,36,60)
obs_tms &lt;- c(1,2,4,8,12,16,24,36,48)
update_tms &lt;- c(5,15,25,40,50)
sim &lt;- clc(pkmod_prior, pkmod_true, target_vals, target_tms, obs_tms, update_tms, seed = 200)
len &lt;- 500
tms &lt;- seq(0,60,length.out = len)
# true, prior, posterior plasma concentrations
df &lt;- data.frame(time = rep(tms,3),
                 value = c(predict(pkmod_true, sim$inf,tms)[,1],
                 predict(pkmod_prior, sim$inf,tms)[,1],
                 predict(sim$pkmod_post, sim$inf, tms)[,1]),
                 type = c(rep("true",len),rep("prior",len),rep("posterior",len)))
library(ggplot2)
ggplot(df, aes(x = time, y = value, color = type)) +
  geom_line() +
  geom_point(data = sim$obs, aes(x = time, y = obs), inherit.aes = FALSE) +
  geom_step(data = data.frame(time = target_tms, value = target_vals),
  aes(x = time, y = value), inherit.aes = FALSE)


# PK-PD example with observation delay (30 sec)
prior_vcov &lt;- matrix(diag(c(0.265,0.346,0.209,0.702,0.242,0.230)),6,6,
dimnames = list(NULL,c('cl','q2','q3','ke0','c50','sigma_add')))
pkpdmod_prior &lt;- update(pkmod_prior, pars_pd = c(c50 = 2.8, gamma = 1.47, e0 = 93, emx = 93),
pdfn = emax, pdinv = emax_inv, sigma_add = 4, log_response = FALSE, Omega = prior_vcov)
pkpdmod_true &lt;- update(pkmod_true, pars_pd = c(c50 = 3.4, gamma = 1.47, e0 = 93, emx = 93),
pdfn = emax, pdinv = emax_inv, sigma_add = 3, log_response = FALSE)
target_vals &lt;- c(75,60,50,50)
target_tms &lt;- c(0,3,6,10)
obs_tms &lt;- seq(1/6,10,1/6)
update_tms &lt;- seq(1,10,0.5)
## Not run: 
sim_pkpd &lt;- clc(pkpdmod_prior, pkpdmod_true, target_vals, target_tms, obs_tms,
update_tms, seed = 201, delay = 0.5)
# plot results
tms &lt;- seq(0,10,length.out = len)
df &lt;- data.frame(time = rep(tms,3),
                 value = c(predict(pkpdmod_true, sim_pkpd$inf,tms)[,"pdresp"],
                 predict(pkpdmod_prior, sim_pkpd$inf,tms)[,"pdresp"],
                 predict(sim_pkpd$pkmod_post, sim_pkpd$inf, tms)[,"pdresp"]),
                 type = c(rep("true",len),rep("prior",len),rep("posterior",len)))
library(ggplot2)
ggplot(df, aes(x = time, y = value, color = type)) +
  geom_line() +
  geom_point(data = sim_pkpd$obs, aes(x = time, y = obs), inherit.aes = FALSE) +
  labs(x = "Hours", y = "Bispectral Index") + theme_bw() +
  geom_vline(xintercept = update_tms, linetype = "dotted", alpha = 0.6) +
  geom_step(data = data.frame(time = target_tms, value = target_vals),
  aes(x = time, y = value), inherit.aes = FALSE)

## End(Not run)
</code></pre>

<hr>
<h2 id='eleveld_pd'>Eleveld et al. pharmacodynamic data</h2><span id='topic+eleveld_pd'></span>

<h3>Description</h3>

<p>Empirical Bayes (EB) estimates of PD parameters made by the Eleveld et al (2018) PK-PD model. EB estimates were calculated
using the PK-PD datasets and NONMEM files provided by Eleveled et al. (2018). The original datasets were obtained through
the Open TCI Initiative website (opentci.org) and based on contributions from a number of researchers who made their
datasets publically available.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(eleveld_pd)
</code></pre>


<h3>Format</h3>

<p>A data frame with 122 rows and 15 variables:
</p>

<dl>
<dt>ID</dt><dd><p>Patient ID</p>
</dd>
<dt>E50</dt><dd><p>EB estimate of effect-site concentration required to achieve 50 percent response</p>
</dd>
<dt>KE0</dt><dd><p>EB estimate of elimination rate from effect-site compartment</p>
</dd>
<dt>EMAX</dt><dd><p>EB estimate of baseline bispectral index (BIS) with no drug administered</p>
</dd>
<dt>GAM</dt><dd><p>EB estimate of Hill parameter when the effect-site concentration is less than E50</p>
</dd>
<dt>GAM1</dt><dd><p>EB estimate of Hill parameter when the effect-site concentration is greater than than E50</p>
</dd>
<dt>RESD</dt><dd><p>EB estimate of residual error term</p>
</dd>
<dt>ALAG1</dt><dd><p>Estimated time lag in BIS measurements due to patient age (fixed-effects only)</p>
</dd>
<dt>AGE</dt><dd><p>Patient's age (years)</p>
</dd>
<dt>WGT</dt><dd><p>Patient's weight (kg)</p>
</dd>
<dt>HGT</dt><dd><p>Patient's height (cm)</p>
</dd>
<dt>M1F2</dt><dd><p>Patient's sex: male = 1, female = 2</p>
</dd>
<dt>A1V2</dt><dd><p>Sampling site: arterial sampling = 1, venous sampling = 2</p>
</dd>
<dt>PMA</dt><dd><p>Patient's post-menstrual age. Assumed to be age + 40 weeks if not provided</p>
</dd>
<dt>TECH</dt><dd><p>Presence of concomitant anaesthetic techniques (Local anesthetic = 1, Opioids = 2)</p>
</dd>
</dl>



<h3>References</h3>

<p>Eleveld et al. (2018) British Journal of Anesthesia Vol. 120, 5:942-959
(<a href="https://bjanaesthesia.org/article/S0007-0912(18)30051-5/abstract">BJA</a>)
</p>

<hr>
<h2 id='eleveld_pk'>Eleveld et al. pharmacokinetic data</h2><span id='topic+eleveld_pk'></span>

<h3>Description</h3>

<p>Empirical Bayes (EB) estimates of PK parameters for the Eleveld et al. (2018) PK-PD model. EB estimates were calculated
using the PK-PD datasets and NONMEM files provided by Eleveled et al. (2018). The original datasets were obtained through
the Open TCI Initiative website (opentci.org) and based on contributions from a number of researchers who made their
datasets publically available.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(eleveld_pk)
</code></pre>


<h3>Format</h3>

<p>A data frame with 1033 rows and 16 variables:
</p>

<dl>
<dt>ID</dt><dd><p>Patient ID</p>
</dd>
<dt>V1</dt><dd><p>EB estimate of first compartment volume</p>
</dd>
<dt>V2</dt><dd><p>EB estimate of second compartment volume</p>
</dd>
<dt>V3</dt><dd><p>EB estimate of third compartment volume</p>
</dd>
<dt>CL</dt><dd><p>EB estimate of clearance for the first compartment</p>
</dd>
<dt>Q2</dt><dd><p>EB estimate of inter-compartmental clearance for second compartment</p>
</dd>
<dt>Q3</dt><dd><p>EB estimate of inter-compartmental clearance for third compartment</p>
</dd>
<dt>AGE</dt><dd><p>Patient's age (years)</p>
</dd>
<dt>WGT</dt><dd><p>Patient's weight (kg)</p>
</dd>
<dt>HGT</dt><dd><p>Patient's height (cm)</p>
</dd>
<dt>M1F2</dt><dd><p>Patient's sex: male = 1, female = 2</p>
</dd>
<dt>PMA</dt><dd><p>Patient's post-menstrual age. Assumed to be age + 40 weeks if not provided</p>
</dd>
<dt>TECH</dt><dd><p>Presence of concomitant anaesthetic techniques (Local anesthetic = 1, Opioids = 2)</p>
</dd>
<dt>BMI</dt><dd><p>Patient's BMI</p>
</dd>
<dt>FFM</dt><dd><p>Patient's fat-free mass (FFM)</p>
</dd>
<dt>A1V2</dt><dd><p>Sampling site: arterial sampling = 1, venous sampling = 2</p>
</dd>
</dl>



<h3>References</h3>

<p>Eleveld et al. (2018) British Journal of Anesthesia Vol. 120, 5:942-959
(<a href="https://bjanaesthesia.org/article/S0007-0912(18)30051-5/abstract">BJA</a>)
</p>

<hr>
<h2 id='elvdlpars'>Get logged parameters updated in Eleveld model</h2><span id='topic+elvdlpars'></span>

<h3>Description</h3>

<p>Extract the logged parameter values to be updated within the Eleveld model
from a data frame of patient PK-PD values.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>elvdlpars(x, pd = TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="elvdlpars_+3A_x">x</code></td>
<td>
<p>Vector or data frame with Eleveld PK-PD model parameters</p>
</td></tr>
<tr><td><code id="elvdlpars_+3A_pd">pd</code></td>
<td>
<p>Logical. Should PD parameters be returned in addition to PK parameters.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>List of parameters used by Eleveld PK-PD model.
</p>

<hr>
<h2 id='emax'>Emax function</h2><span id='topic+emax'></span>

<h3>Description</h3>

<p>Emax function. c50 is the concentration eliciting a 50
identifying the slope of the Emax curve at c50, E0 is the response value with no drug present,
Emx is the maximum effect size.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>emax(ce, pars)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="emax_+3A_ce">ce</code></td>
<td>
<p>Vector of effect-site concentrations.</p>
</td></tr>
<tr><td><code id="emax_+3A_pars">pars</code></td>
<td>
<p>Named vector of parameter values with names (c50,gamma,e0,emx).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric vector of same length as ce.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pars_emax &lt;- c(c50 = 1.5, gamma = 1.47, e0 = 100, emx = 100)
ce_seq &lt;- seq(0,4,0.1)
plot(ce_seq, emax(ce_seq, pars_emax), type = "l",
xlab = "Effect-site concentrtion (ug/mL)", ylab = "BIS")
</code></pre>

<hr>
<h2 id='emax_eleveld'>Emax function for Eleveld (2018) model.</h2><span id='topic+emax_eleveld'></span>

<h3>Description</h3>

<p>The parameter gamma takes one of two values depending on whether ce &lt;= c50.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>emax_eleveld(ce, pars)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="emax_eleveld_+3A_ce">ce</code></td>
<td>
<p>Vector of effect-site concentrations.</p>
</td></tr>
<tr><td><code id="emax_eleveld_+3A_pars">pars</code></td>
<td>
<p>Vector of parameter values in order (c50,gamma,gamma2,e0,emx).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric vector of same length as ce.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pars_emax_eleveld &lt;- c(c50 = 1.5, e0 = 100, gamma = 1.47, gamma2 = 1.89)
ce_seq &lt;- seq(0,4,0.1)
plot(ce_seq, emax_eleveld(ce_seq, pars_emax_eleveld), type = "l",
xlab = "Effect-site concentrtion (ug/mL)", ylab = "BIS")
</code></pre>

<hr>
<h2 id='emax_inv'>Inverse Emax function</h2><span id='topic+emax_inv'></span>

<h3>Description</h3>

<p>Inverse Emax function to return effect-site concentrations required to reach target effect.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>emax_inv(pdresp, pars)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="emax_inv_+3A_pdresp">pdresp</code></td>
<td>
<p>PD response values</p>
</td></tr>
<tr><td><code id="emax_inv_+3A_pars">pars</code></td>
<td>
<p>Named vector of parameter values with names (c50,gamma,E0,Emx).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric vector of same length as pdresp.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pars_emax &lt;- c(c50 = 1.5, gamma = 4, e0 = 100, emx = 100)
ce_seq &lt;- seq(0,4,0.1)
all.equal(emax_inv(emax(ce_seq, pars_emax), pars_emax), ce_seq)
</code></pre>

<hr>
<h2 id='emax_inv_eleveld'>Inverse Emax function</h2><span id='topic+emax_inv_eleveld'></span>

<h3>Description</h3>

<p>Inverse of Emax function used by Eleveld population PK model.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>emax_inv_eleveld(pdresp, pars)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="emax_inv_eleveld_+3A_pdresp">pdresp</code></td>
<td>
<p>PD response values</p>
</td></tr>
<tr><td><code id="emax_inv_eleveld_+3A_pars">pars</code></td>
<td>
<p>Named vector of parameter values with names (c50,gamma,E0,Emx).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric vector of same length as pdresp.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pars_emax_eleveld &lt;- c(c50 = 1.5, e0 = 100, gamma = 1.47, gamma2 = 1.89)
ce_seq &lt;- seq(0,4,0.1)
all.equal(emax_inv_eleveld(emax_eleveld(ce_seq, pars_emax_eleveld), pars_emax_eleveld), ce_seq)
</code></pre>

<hr>
<h2 id='emax_inv_remi'>Inverse Emax function implemented by Eleveld remifentanil model</h2><span id='topic+emax_inv_remi'></span>

<h3>Description</h3>

<p>Inverse Emax function to return effect-site concentrations required to reach target effect.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>emax_inv_remi(pdresp, pars)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="emax_inv_remi_+3A_pdresp">pdresp</code></td>
<td>
<p>PD response values</p>
</td></tr>
<tr><td><code id="emax_inv_remi_+3A_pars">pars</code></td>
<td>
<p>Named vector of parameter values with names (c50,gamma,E0,Emx).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric vector of same length as pdresp.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pars_emax &lt;- c(e0 = 19, emx = 5.6, c50 = 12.7, gamma = 2.87)
emax_inv_remi(emax_remi(10, pars_emax), pars_emax)
</code></pre>

<hr>
<h2 id='emax_remi'>Emax function implemented by Eleveld remifentanil model</h2><span id='topic+emax_remi'></span>

<h3>Description</h3>

<p>Emax function. c50 is the concentration eliciting a 50
identifying the slope of the Emax curve at c50, E0 is the response value with no drug present,
Emx is the maximum effect size.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>emax_remi(ce, pars)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="emax_remi_+3A_ce">ce</code></td>
<td>
<p>Vector of effect-site concentrations.</p>
</td></tr>
<tr><td><code id="emax_remi_+3A_pars">pars</code></td>
<td>
<p>Named vector of parameter values with names (c50,gamma,e0,emx).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric vector of same length as ce.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pars_emax &lt;- c(e0 = 19, emx = 5.6, c50 = 12.7, gamma = 2.87)
ce_seq &lt;- seq(0,60,0.1)
plot(ce_seq, emax_remi(ce_seq, pars_emax), type = "l",
xlab = "Effect-site concentrtion (ug/mL)", ylab = "Spectral Edge Frequency (HZ)")
</code></pre>

<hr>
<h2 id='format_pars'>Format parameters for use in Rcpp functions
Order parameters for 1-4 compartment models to be used in Rcpp functions in
predict_pkmod method.</h2><span id='topic+format_pars'></span>

<h3>Description</h3>

<p>Format parameters for use in Rcpp functions
</p>
<p>Order parameters for 1-4 compartment models to be used in Rcpp functions in
predict_pkmod method.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>format_pars(pars, ncmpt = 3)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="format_pars_+3A_pars">pars</code></td>
<td>
<p>Vector of named parameters. Names can be capitalized or lowercase
and can include variations of &quot;V1&quot; as &quot;V&quot; or clearance terms rather than
elimination rate constants.</p>
</td></tr>
<tr><td><code id="format_pars_+3A_ncmpt">ncmpt</code></td>
<td>
<p>Number of compartments in the model. This should be a value
between 1 and 4. If ncmpt = 4, it assumes that the fourth compartment is an
effect-site without a corresponding volume parameter.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric vector of transformed parameter values.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>format_pars(c(V1 = 8.9, CL = 1.4, q2 = 0.9, v2 = 18), ncmpt = 2)
format_pars(c(V1 = 8.9, CL = 1.4, q2 = 0.9, v2 = 18, cl2 = 3), ncmpt = 2)
</code></pre>

<hr>
<h2 id='inf_manual'>infusion schedule</h2><span id='topic+inf_manual'></span>

<h3>Description</h3>

<p>Returns a data frame describing a set of infusions to be administered. Output
can be used as argument &quot;inf&quot; in predict_pkmod.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>inf_manual(inf_tms, inf_rate, duration = NULL)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="inf_manual_+3A_inf_tms">inf_tms</code></td>
<td>
<p>Vector of time to begin infusions. If duration is NULL, times
expected to include both infusion start and infusion end times.</p>
</td></tr>
<tr><td><code id="inf_manual_+3A_inf_rate">inf_rate</code></td>
<td>
<p>Vector of infusion rates. Must lave length equal to either
length(inf_tms) or 1. If length(inf_rate)=1, the same infusion rate will be
administered at each time. Either inf_rate or target must be specified, but not both.</p>
</td></tr>
<tr><td><code id="inf_manual_+3A_duration">duration</code></td>
<td>
<p>Optional duration of infusions.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Matrix of infusion rates, start and end times.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># specify start and end times, as well as infusion rates (including 0).
inf_manual(inf_tms = c(0,0.5,4,4.5,10), inf_rate = c(100,0,80,0,0))
# specify start times, single infusion rate and single duration
inf_manual(inf_tms = c(0,4), inf_rate = 100, duration = 0.5)
# multiple infusion rates, single duration
inf_manual(inf_tms = c(0,4), inf_rate = c(100,80), duration = 0.5)
# multiple sequential infusion rates
inf_manual(inf_tms = seq(0,1,1/6), inf_rate = 100, duration = 1/6)
# single infusion rate, multiple durations
inf_manual(inf_tms = c(0,4), inf_rate = 100, duration = c(0.5,1))
# multiple infusion rates, multiple durations
inf_manual(inf_tms = c(0,4), inf_rate = c(100,80), duration = c(0.5,1))
</code></pre>

<hr>
<h2 id='inf_tci'>Target-controlled infusion</h2><span id='topic+inf_tci'></span>

<h3>Description</h3>

<p>Apply a TCI algorithm to a set of targets and a 'pkmod' or 'poppkmod' object to calculate infusion
rates.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>inf_tci(
  pkmod,
  target_vals,
  target_tms,
  type = c("plasma", "effect"),
  dtm = NULL,
  custom_alg = NULL,
  inittm = 0,
  ignore_pd = FALSE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="inf_tci_+3A_pkmod">pkmod</code></td>
<td>
<p>'pkmod' object created by 'pkmod()' or a 'poppkmod' object created by 'poppkmod()'.</p>
</td></tr>
<tr><td><code id="inf_tci_+3A_target_vals">target_vals</code></td>
<td>
<p>A vector of numeric values indicating PK or PD targets for TCI algorithm.</p>
</td></tr>
<tr><td><code id="inf_tci_+3A_target_tms">target_tms</code></td>
<td>
<p>A vector of numeric values indicating times at which the TCI algorithm should
begin targeting each value.</p>
</td></tr>
<tr><td><code id="inf_tci_+3A_type">type</code></td>
<td>
<p>Type of TCI algorithm to be used. Options are plasma- or effect-site
targeting.</p>
</td></tr>
<tr><td><code id="inf_tci_+3A_dtm">dtm</code></td>
<td>
<p>TCI update frequency. Defaults to 1/6, corresponding to 10-second
intervals if model parameters are in terms of minutes.</p>
</td></tr>
<tr><td><code id="inf_tci_+3A_custom_alg">custom_alg</code></td>
<td>
<p>Custom TCI algorithm to be used instead of default plasma-
or effect-site targeting algorithms. The algorithm should be a function that
takes minimum arguments 'Ct', 'pkmod', and 'dtm' and returns a single infusion
rate. See 'tci_plasma' or 'tci_effect' for examples and vignette on custom
models/algorithms for more details.</p>
</td></tr>
<tr><td><code id="inf_tci_+3A_inittm">inittm</code></td>
<td>
<p>Initial time to start TCI algorithm. Cannot be greater than
the minimum value of 'target_tms'.</p>
</td></tr>
<tr><td><code id="inf_tci_+3A_ignore_pd">ignore_pd</code></td>
<td>
<p>Logical. Should the PD component of the pkmod object (if present)
be ignored. By default, predict.tciinf will assume that 'value' refers to PD
targets if a PD model is specified.</p>
</td></tr>
<tr><td><code id="inf_tci_+3A_...">...</code></td>
<td>
<p>Arguments passed to TCI algorithm</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'># 3-compartment model with effect-site
my_mod &lt;- pkmod(pars_pk = c(v1 = 8.995, v2 = 17.297, v3 = 120.963, cl = 1.382,
q2 = 0.919, q3 = 0.609, ke0 = 1.289))
# plasma targeting
inf_tci(my_mod, target_vals = c(2,3,4,4), target_tms = c(0,2,3,10), "plasma")
# effect-site targeting
inf_tci(my_mod, target_vals = c(2,3,4,4), target_tms = c(0,2,3,10), "effect")
# poppkmod object
data &lt;- data.frame(ID = 1:5, AGE = seq(20,60,by=10), TBW = seq(60,80,by=5),
HGT = seq(150,190,by=10), MALE = c(TRUE,TRUE,FALSE,FALSE,FALSE))
elvd_mod &lt;- poppkmod(data, drug = "ppf", model = "eleveld")
inf_tci(elvd_mod, target_vals = c(2,3,4,4), target_tms = c(0,2,3,10), "effect")
</code></pre>

<hr>
<h2 id='infer_pkfn'>Identify pkfn from parameter names</h2><span id='topic+infer_pkfn'></span>

<h3>Description</h3>

<p>Identify structural PK model function (i.e., 'pkfn') from parameter names.
Models available are 1-, 2-, and 3-compartment mammillary models, or 3-compartment with
an effect site, corresponding to functions 'pkmod1cpt', 'pkmod2cpt', 'pkmod3cpt', and
'pkmod3cptm', respectively.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>infer_pkfn(parnms)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="infer_pkfn_+3A_parnms">parnms</code></td>
<td>
<p>Vector of parameter names.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns one of the following functions: 'pkmod1cpt', 'pkmod2cpt', 'pkmod3cpt',
or 'pkmod3cptm' based on the parameter names entered.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># 1-compartment
infer_pkfn(c("CL","V"))
infer_pkfn(c("Cl","v1"))
# 2-compartment
infer_pkfn(c("CL","v","v2","q"))
# 3-compartment
infer_pkfn(c("CL","v","v2","q","Q2","V3"))
# 3-compartment with effect-site
infer_pkfn(c("CL","v","v2","q","Q2","V3","ke0"))
</code></pre>

<hr>
<h2 id='init_pkmod'>Create an object with class &quot;pkmod&quot;</h2><span id='topic+init_pkmod'></span>

<h3>Description</h3>

<p>Create an object with class &quot;pkmod&quot;
</p>


<h3>Usage</h3>

<pre><code class='language-R'>init_pkmod(
  pars_pk = NULL,
  init = NULL,
  pkfn = NULL,
  pars_pd = NULL,
  pdfn = NULL,
  pdinv = NULL,
  pcmpt = NULL,
  ecmpt = NULL,
  sigma_add = NULL,
  sigma_mult = NULL,
  log_response = NULL,
  Omega = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="init_pkmod_+3A_pars_pk">pars_pk</code></td>
<td>
<p>Vector or matrix of named PK parameters. If not specified, the pkmod function will be
inferred from the parameter names. Print 'list_parnms()' for acceptable parameter names.</p>
</td></tr>
<tr><td><code id="init_pkmod_+3A_init">init</code></td>
<td>
<p>Vector of initial concentrations. Will default to values of zero in all compartments if not specified.</p>
</td></tr>
<tr><td><code id="init_pkmod_+3A_pkfn">pkfn</code></td>
<td>
<p>PK model function. Functions provided in 'tci' include 'pkmod1cpt', 'pkmod2cpt', 'pkmod3cpt', and 'pkmod3cptm'.
User-defined functions should be specified here.</p>
</td></tr>
<tr><td><code id="init_pkmod_+3A_pars_pd">pars_pd</code></td>
<td>
<p>PD model parameters if a PD model is specified</p>
</td></tr>
<tr><td><code id="init_pkmod_+3A_pdfn">pdfn</code></td>
<td>
<p>PD model function</p>
</td></tr>
<tr><td><code id="init_pkmod_+3A_pdinv">pdinv</code></td>
<td>
<p>Inverse PD model function for use in TCI algorithms</p>
</td></tr>
<tr><td><code id="init_pkmod_+3A_pcmpt">pcmpt</code></td>
<td>
<p>Index of plasma compartment. Defaults to first compartment if not specified.</p>
</td></tr>
<tr><td><code id="init_pkmod_+3A_ecmpt">ecmpt</code></td>
<td>
<p>Index of effect-site compartment if a PD model is specified. Will default to last compartment if unspecified.</p>
</td></tr>
<tr><td><code id="init_pkmod_+3A_sigma_add">sigma_add</code></td>
<td>
<p>Standard deviation of additive residual error</p>
</td></tr>
<tr><td><code id="init_pkmod_+3A_sigma_mult">sigma_mult</code></td>
<td>
<p>Standard deviation of multiplicative residual error</p>
</td></tr>
<tr><td><code id="init_pkmod_+3A_log_response">log_response</code></td>
<td>
<p>Logical value indicating if the response should be logged prior to adding error.</p>
</td></tr>
<tr><td><code id="init_pkmod_+3A_omega">Omega</code></td>
<td>
<p>Optional matrix of random effect parameters. Column names should correspond to names of
pars_pk, pars_pd, and sigma_add or sigma_mult.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list with class pkmod for which print, plot, predict, and simulate methods exist.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># create a pkmod object for a one compartment model with plasma targeting
init_pkmod()
</code></pre>

<hr>
<h2 id='init_poppkmod'>Initialize a 'poppkmod' object.</h2><span id='topic+init_poppkmod'></span>

<h3>Description</h3>

<p>Generate a 'poppkmod' object from an existing population PK model
for propofol or remifentanil using patient covariates. Available models for
propofol are the Marsh, Schnider, and Eleveld models. Available models for
remifentanil are the Minto, Kim, and Eleveld models. Input is
a data frame with rows corresponding to individuals and columns
recording patient covariates.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>init_poppkmod(data = NULL, drug = NULL, model = NULL, sample = NULL, PD = NULL)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="init_poppkmod_+3A_data">data</code></td>
<td>
<p>Data frame of patient covariates. ID values, if used, should be in a column labeled &quot;id&quot; or &quot;ID&quot;</p>
</td></tr>
<tr><td><code id="init_poppkmod_+3A_drug">drug</code></td>
<td>
<p>&quot;ppf&quot; for propofol or &quot;remi&quot; for remifentanil. Defaults to &quot;ppf&quot;.</p>
</td></tr>
<tr><td><code id="init_poppkmod_+3A_model">model</code></td>
<td>
<p>Model name. Options are &quot;marsh&quot;, &quot;schnider&quot;, or &quot;eleveld&quot; if
drug = &quot;ppf&quot;, or &quot;minto&quot;, &quot;kim&quot;, or &quot;eleveld&quot; if drug = &quot;remi&quot;.</p>
</td></tr>
<tr><td><code id="init_poppkmod_+3A_sample">sample</code></td>
<td>
<p>Logical. Should parameter values be sampled from interindividual distribution (TRUE)
or evaluated at point estimates for covariates (FALSE)? Defaults to FALSE.</p>
</td></tr>
<tr><td><code id="init_poppkmod_+3A_pd">PD</code></td>
<td>
<p>Should the PD component be evaluated for PK-PD models. Defaults to TRUE.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>'poppkmod' object
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data &lt;- data.frame(ID = 1:5, AGE = seq(20,60,by=10), TBW = seq(60,80,by=5),
HGT = seq(150,190,by=10), MALE = c(TRUE,TRUE,FALSE,FALSE,FALSE))
init_poppkmod(data, drug = "ppf", model = "eleveld")
init_poppkmod(data, drug = "remi", model = "kim")
</code></pre>

<hr>
<h2 id='list_parnms'>Identify pkfn from parameter names</h2><span id='topic+list_parnms'></span>

<h3>Description</h3>

<p>Identify structural PK model function (i.e., 'pkfn') from parameter names.
Models available are 1-, 2-, and 3-compartment mammillary models, or 3-compartment with
an effect site, corresponding to functions 'pkmod1cpt', 'pkmod2cpt', 'pkmod3cpt', and
'pkmod3cptm', respectively.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>list_parnms()
</code></pre>


<h3>Value</h3>

<p>Returns one of the following functions: 'pkmod1cpt', 'pkmod2cpt', 'pkmod3cpt',
or 'pkmod3cptm' based on the parameter names entered.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>list_parnms()
</code></pre>

<hr>
<h2 id='list_pkmods'>Print population PK models available in 'tci'</h2><span id='topic+list_pkmods'></span>

<h3>Description</h3>

<p>Print population PK models available in 'tci' for propofol (Marsh,
Schnider, Eleveld) and remifentanil (Minto, Kim, Eleveld).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>list_pkmods()
</code></pre>


<h3>Value</h3>

<p>Prints function names, model types, and required covariates for each
model.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>list_pkmods()
</code></pre>

<hr>
<h2 id='log_likelihood'>Evaluate the log likelihood of a vector of parameter values</h2><span id='topic+log_likelihood'></span>

<h3>Description</h3>

<p>Evaluate the log liklihood of parameters given observed data. Can be applied to PK or PK-PD models.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>log_likelihood(lpars, pkmod, inf, tms, obs)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="log_likelihood_+3A_lpars">lpars</code></td>
<td>
<p>Named vector of logged parameter values to be evaluated. This should include any PK or PD parameters,
as well as residual error standard deviations (sigma_add or sigma_mult) that are to be evaluated.</p>
</td></tr>
<tr><td><code id="log_likelihood_+3A_pkmod">pkmod</code></td>
<td>
<p>'pkmod' object. Mean values are a subset of log(pars_pk), log(pars_pd),
log(sigma_add), log(sigma_mult). PK-PD parameter values not specified in 'lpars' will be inferred from 'pkmod'.</p>
</td></tr>
<tr><td><code id="log_likelihood_+3A_inf">inf</code></td>
<td>
<p>Infusion schedule</p>
</td></tr>
<tr><td><code id="log_likelihood_+3A_tms">tms</code></td>
<td>
<p>Times associated with observations</p>
</td></tr>
<tr><td><code id="log_likelihood_+3A_obs">obs</code></td>
<td>
<p>Observed values (concentrations or PD response values)</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric value of length 1
</p>


<h3>Examples</h3>

<pre><code class='language-R'>my_mod &lt;- pkmod(pars_pk = c(cl = 10, q2 = 2, q3 =20, v = 15, v2 = 30, v3 = 50,
 ke0 = 1.2), sigma_mult = 0.2)
inf &lt;- inf_manual(inf_tms = 0, inf_rate = 80, duration = 2)
tms &lt;- c(1,2,4,8,12)
obs &lt;- simulate(my_mod, inf = inf, tms = tms)
# evaluate log-likelihood at a new set of parameters
lpars = log(c(cl=11,q2=3,q3=25,v=15,v2=30,v3=50,ke0=1.15,sigma_mult=0.3))
log_likelihood(lpars, my_mod, inf, tms, obs)

# estimate for a subset of parameters (exclude q2, v2, v3)
lpars_sub = log(c(cl=11,q3=25,v=15,ke0=1.15,sigma_mult=0.3))
log_likelihood(lpars_sub, my_mod, inf, tms, obs)

# add a pd response and replace multiplicative error with additive error
my_mod_pd &lt;- update(my_mod, pars_pd = c(c50 = 2.8, gamma = 1.47, e0 = 93,
emx = 93), pdfn = emax, pdinv = emax_inv, ecmpt = 4, sigma_mult = 0, sigma_add = 4)
# simulate observations
obs_pd &lt;- simulate(my_mod_pd, inf = inf, tms = seq(0,12,0.5))
# evaluate likelihood at new parameters
lpars_pd &lt;- log(c(cl=11,q3=25,v=15,ke0=1.15,sigma_add=4,c50=5,gamma=1))
log_likelihood(lpars_pd, my_mod_pd, inf, tms = seq(0,12,0.5), obs_pd)
</code></pre>

<hr>
<h2 id='log_posterior_neg'>Evaluate the negative log posterior value of a parameter vector</h2><span id='topic+log_posterior_neg'></span>

<h3>Description</h3>

<p>Evaluate the negative log posterior value of a parameter vector given a set of
observations and prior distribution for log-normally distributed PK or PK-PD parameters.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>log_posterior_neg(lpars, pkmod, inf, tms, obs)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="log_posterior_neg_+3A_lpars">lpars</code></td>
<td>
<p>Logged parameter values. Can be a subset of the full set of PK or PK-PD parameter values.</p>
</td></tr>
<tr><td><code id="log_posterior_neg_+3A_pkmod">pkmod</code></td>
<td>
<p>'pkmod' object. Mean values are a subset of log(pars_pk), log(pars_pd),
log(sigma_add), log(sigma_mult). PK-PD parameter values not specified in 'lpars' will be inferred from 'pkmod'.</p>
</td></tr>
<tr><td><code id="log_posterior_neg_+3A_inf">inf</code></td>
<td>
<p>Infusion schedule</p>
</td></tr>
<tr><td><code id="log_posterior_neg_+3A_tms">tms</code></td>
<td>
<p>Times associated with observations</p>
</td></tr>
<tr><td><code id="log_posterior_neg_+3A_obs">obs</code></td>
<td>
<p>Observed values (concentrations or PD response values)</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric value of length 1
</p>


<h3>Examples</h3>

<pre><code class='language-R'># evaluate negative log posterior at a new set of parameters
lpars = log(c(cl=11,q2=3,q3=25,v=20,v2=40,v3=80,ke0=1.15,sigma_add=0.3))
prior_vcov &lt;- matrix(diag(c(0.265,0.346,0.209,0.610,0.565,0.597,0.702,0.463)),
8,8, dimnames = list(NULL,names(lpars)))
my_mod &lt;- pkmod(pars_pk = c(cl = 10, q2 = 2, q3 =20, v = 15, v2 = 30, v3 = 50,
ke0 = 1.2), sigma_add = 0.2, log_response = TRUE, Omega = prior_vcov)
inf &lt;- inf_manual(inf_tms = 0, inf_rate = 80, duration = 2)
tms &lt;- c(1,2,4,8,12)
obs &lt;- simulate(my_mod, inf = inf, tms = tms)
log_posterior_neg(lpars, my_mod, inf, tms, obs)

# evaluate log-prior for subset of parameters (remove volume parameters)
lpars_sub = log(c(cl=11,q2=3,q3=25,ke0=1.15,sigma_add=0.15))
my_mod &lt;- update(my_mod, Omega = matrix(diag(c(0.265,0.346,0.209,0.702,0.463)),
5,5, dimnames = list(NULL,names(lpars_sub))))
log_posterior_neg(lpars_sub, my_mod, inf, tms, obs)

# add a pd response and replace multiplicative error with additive error
# evaluate likelihood at new parameters
lpars_pd_eval = log(c(cl=11,q3=25,v=15,ke0=1.15,sigma_add=4,c50=5,gamma=1))
prior_vcov_pd &lt;- matrix(diag(c(0.265,0.209,0.610,0.702,0.230,0.242,0.1)),7,7,
dimnames = list(NULL,names(lpars_pd_eval)))
my_mod_pd &lt;- update(my_mod, pars_pd = c(c50 = 2.8, gamma = 1.47, e0 = 93, emx = 93),
pdfn = emax, pdinv = emax_inv, ecmpt = 4, sigma_mult = 0, sigma_add = 4,
Omega = prior_vcov_pd)
# simulate observations
obs_pd &lt;- simulate(my_mod_pd, inf = inf, tms = seq(0,12,0.5))
log_posterior_neg(lpars_pd_eval, my_mod_pd, inf, tms, obs_pd)
</code></pre>

<hr>
<h2 id='log_prior'>Calculate logged-prior probability for a set of parameters</h2><span id='topic+log_prior'></span>

<h3>Description</h3>

<p>Calculate logged-prior probability for a set of parameters, assuming that parameter values
are log-normally distributed. Mean values are set as the logged parameter values in
the 'pkmod' object. Variances are given by the diagonal elements of 'prior_vcov'.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>log_prior(lpars, pkmod)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="log_prior_+3A_lpars">lpars</code></td>
<td>
<p>Logged parameter values. Can be a subset of the full set of PK or PK-PD parameter values.</p>
</td></tr>
<tr><td><code id="log_prior_+3A_pkmod">pkmod</code></td>
<td>
<p>'pkmod' object. Mean values are a subset of log(pars_pk), log(pars_pd),
log(sigma_add), log(sigma_mult). PK-PD parameter values not specified in 'lpars' will be inferred from 'pkmod'.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric value of length 1
</p>


<h3>Examples</h3>

<pre><code class='language-R'># evaluate log-prior for pk parameters + residual
lpars = log(c(cl=11,q2=3,q3=25,v=15,v2=30,v3=50,ke0=1.15,sigma_add=0.15))
prior_vcov &lt;- matrix(diag(c(0.265,0.346,0.209,0.610,0.565,0.597,0.702,0.463)), 8,8,
dimnames = list(NULL,names(lpars)))
my_mod &lt;- pkmod(pars_pk = c(cl = 10, q2 = 2, q3 =20, v = 15, v2 = 30, v3 = 50, ke0 = 1.2),
sigma_add = 0.2, log_response = TRUE, Omega = prior_vcov)
log_prior(lpars, my_mod)

# evaluate log-prior for subset of parameters (remove volume parameters)
lpars_sub = log(c(cl=11,q2=3,q3=25,ke0=1.15,sigma_add=0.15))
prior_vcov_sub &lt;- matrix(diag(c(0.265,0.346,0.209,0.702,0.463)), 5,5,
dimnames = list(NULL,names(lpars_sub)))
my_mod &lt;- update(my_mod, Omega = prior_vcov_sub)
log_prior(lpars_sub, my_mod)
</code></pre>

<hr>
<h2 id='olc'>Simulate open-loop control</h2><span id='topic+olc'></span>

<h3>Description</h3>

<p>Simulate open-loop control with target-controlled infusion for a 'pkmod' object.
Infusion rates are calculated using 'pkmod_prior' to reach 'target_vals' at
'target_tms'. Data values are simulated using 'pkmod_true' at 'obs_tms'.
'pkmod_prior' and 'pkmod_true' do not need to have the same structure.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>olc(
  pkmod_prior,
  pkmod_true,
  target_vals,
  target_tms,
  obs_tms,
  type = c("effect", "plasma"),
  custom_alg = NULL,
  resp_bounds = NULL,
  seed = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="olc_+3A_pkmod_prior">pkmod_prior</code></td>
<td>
<p>'pkmod' object describing a PK/PK-PD model that is used to calculate
TCI infusion rates and is updated as data are simulated and incorporated. Must have an
associated Omega matrix.</p>
</td></tr>
<tr><td><code id="olc_+3A_pkmod_true">pkmod_true</code></td>
<td>
<p>&lsquo;pkmod' object describing the patient&rsquo;s &quot;true&quot; response. This model
will be used to simulate observations.</p>
</td></tr>
<tr><td><code id="olc_+3A_target_vals">target_vals</code></td>
<td>
<p>A vector of numeric values indicating PK or PD targets for TCI algorithm.</p>
</td></tr>
<tr><td><code id="olc_+3A_target_tms">target_tms</code></td>
<td>
<p>A vector of numeric values indicating times at which the TCI algorithm should
begin targeting each value.</p>
</td></tr>
<tr><td><code id="olc_+3A_obs_tms">obs_tms</code></td>
<td>
<p>Times at which data values should be simulated from 'pkmod_true'.</p>
</td></tr>
<tr><td><code id="olc_+3A_type">type</code></td>
<td>
<p>Type of TCI algorithm to be used. Options are &quot;plasma&quot; and &quot;effect&quot;.
Defaults to &quot;effect&quot;. Will be overwritten if 'custom_alg' is non-null.</p>
</td></tr>
<tr><td><code id="olc_+3A_custom_alg">custom_alg</code></td>
<td>
<p>Custom TCI algorithm to overwrite default plasma- or effect-site targeting.</p>
</td></tr>
<tr><td><code id="olc_+3A_resp_bounds">resp_bounds</code></td>
<td>
<p>Optional vector of two values indicating minimum and maximum values possible for the response.</p>
</td></tr>
<tr><td><code id="olc_+3A_seed">seed</code></td>
<td>
<p>An integer used to initialize the random number generator.</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>pkmod_prior &lt;- pkmod(pars_pk = c(cl = 10, q2 = 2, q3 =20, v = 15, v2 = 30, v3 = 50, ke0 = 1.2))
pkmod_true  &lt;- pkmod(pars_pk = c(cl = 16, q2 = 4, q3 =10, v = 20, v2 = 20, v3 = 80, ke0 = 0.8),
sigma_add = 0.1, log_response = TRUE)
target_vals &lt;- c(2,3,4,3,3)
target_tms &lt;- c(0,5,10,36,60)
obs_tms &lt;- c(1,2,4,8,12,16,24,36,48)
sim &lt;- olc(pkmod_prior, pkmod_true, target_vals, target_tms, obs_tms)
len &lt;- 500
tms &lt;- seq(0,60,length.out = len)
df &lt;- data.frame(time = rep(tms,2),
                 value = c(predict(pkmod_true, sim$inf,tms)[,1],
                 predict(pkmod_prior, sim$inf,tms)[,1]),
                 type = c(rep("true",len),rep("prior",len)))
library(ggplot2)
ggplot(df, aes(x = time, y = value, color = type)) +
  geom_step(data = data.frame(time = target_tms, value = target_vals),
  aes(x = time, y = value), inherit.aes = FALSE) +
  geom_line() +
  geom_point(data = sim$obs, aes(x = time, y = obs), inherit.aes = FALSE)
</code></pre>

<hr>
<h2 id='pkmod'>Create a pkmod object</h2><span id='topic+pkmod'></span>

<h3>Description</h3>

<p>User function to create pkmod objects with validation checks. Multiple rows are permitted for
arguments 'pars_pk', 'pars_pd', 'init'
</p>


<h3>Usage</h3>

<pre><code class='language-R'>pkmod(
  pars_pk = NULL,
  init = NULL,
  pkfn = NULL,
  pars_pd = NULL,
  pdfn = NULL,
  pdinv = NULL,
  pcmpt = NULL,
  ecmpt = NULL,
  sigma_add = 0,
  sigma_mult = 0,
  log_response = FALSE,
  Omega = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="pkmod_+3A_pars_pk">pars_pk</code></td>
<td>
<p>Vector or matrix of named PK parameters. If not specified, the pkmod function will be
inferred from the parameter names. Print 'list_parnms()' for acceptable parameter names.</p>
</td></tr>
<tr><td><code id="pkmod_+3A_init">init</code></td>
<td>
<p>Vector of initial concentrations. Will default to values of zero in all compartments if not specified.</p>
</td></tr>
<tr><td><code id="pkmod_+3A_pkfn">pkfn</code></td>
<td>
<p>PK model function. Functions provided in 'tci' include 'pkmod1cpt', 'pkmod2cpt', 'pkmod3cpt', and 'pkmod3cptm'.
User-defined functions should be specified here.</p>
</td></tr>
<tr><td><code id="pkmod_+3A_pars_pd">pars_pd</code></td>
<td>
<p>PD model parameters if a PD model is specified</p>
</td></tr>
<tr><td><code id="pkmod_+3A_pdfn">pdfn</code></td>
<td>
<p>PD model function</p>
</td></tr>
<tr><td><code id="pkmod_+3A_pdinv">pdinv</code></td>
<td>
<p>Inverse PD model function for use in TCI algorithms</p>
</td></tr>
<tr><td><code id="pkmod_+3A_pcmpt">pcmpt</code></td>
<td>
<p>Index of plasma compartment. Defaults to first compartment if not specified.</p>
</td></tr>
<tr><td><code id="pkmod_+3A_ecmpt">ecmpt</code></td>
<td>
<p>Index of effect-site compartment if a PD model is specified. Will default to last compartment if unspecified.</p>
</td></tr>
<tr><td><code id="pkmod_+3A_sigma_add">sigma_add</code></td>
<td>
<p>Standard deviation of additive residual error</p>
</td></tr>
<tr><td><code id="pkmod_+3A_sigma_mult">sigma_mult</code></td>
<td>
<p>Standard deviation of multiplicative residual error</p>
</td></tr>
<tr><td><code id="pkmod_+3A_log_response">log_response</code></td>
<td>
<p>Logical value indicating if the response should be logged prior to adding error.</p>
</td></tr>
<tr><td><code id="pkmod_+3A_omega">Omega</code></td>
<td>
<p>Optional matrix of random effect parameters. Column names should correspond to names of
pars_pk, pars_pd, and sigma_add or sigma_mult.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns a list with class &quot;pkmod&quot; if validation checks are passed. Returns an error if not.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># 1-compartment model
pkmod(pars_pk = c(CL = 10, V1 = 10))
# 2-compartment model
pkmod(pars_pk = c(CL = 10, V1 = 10, Q = 3, v2 = 20))
# 2-compartment model with random effects matrix
Omega &lt;- matrix(diag(c(0.3,0.2,0,0.4)), 4,4, dimnames = list(NULL,c("CL","V1","Q","v2")))
pkmod(pars_pk = c(CL = 10, V1 = 10, Q = 3, v2 = 20), Omega = Omega)
</code></pre>

<hr>
<h2 id='pkmod_eleveld_ppf'>Eleveld population PK model for propofol</h2><span id='topic+pkmod_eleveld_ppf'></span>

<h3>Description</h3>

<p>Function takes patient covariate values required for the Eleveld
PK or PK-PD model for propofol and returns a 'pkmod' object with the appropriate model
parameters.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>pkmod_eleveld_ppf(
  AGE,
  TBW,
  HGT,
  MALE,
  OPIATE = TRUE,
  ARTERIAL = TRUE,
  PMA = NULL,
  PD = TRUE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="pkmod_eleveld_ppf_+3A_age">AGE</code></td>
<td>
<p>Age (years)</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_ppf_+3A_tbw">TBW</code></td>
<td>
<p>Weight (kg)</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_ppf_+3A_hgt">HGT</code></td>
<td>
<p>Height (cm)</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_ppf_+3A_male">MALE</code></td>
<td>
<p>Sex, logical</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_ppf_+3A_opiate">OPIATE</code></td>
<td>
<p>Logical indicating presence of opiates. Defaults to TRUE.</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_ppf_+3A_arterial">ARTERIAL</code></td>
<td>
<p>PK based on arterial sampling rather than venous. Defaults to TRUE.</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_ppf_+3A_pma">PMA</code></td>
<td>
<p>Post-menstrual age. Calculated as AGE + 40 weeks if not provided.</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_ppf_+3A_pd">PD</code></td>
<td>
<p>Logical. Should PD parameters be returned in addition to PK parameters.</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_ppf_+3A_...">...</code></td>
<td>
<p>Arguments passed to 'pkmod'</p>
</td></tr>
</table>


<h3>Value</h3>

<p>'pkmod' object with Eleveld propofol population PK or PK-PD parameters
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pkmod_eleveld_ppf(AGE = 40,TBW = 56,HGT=150,MALE = TRUE)
</code></pre>

<hr>
<h2 id='pkmod_eleveld_remi'>Eleveld population PK model for remifentanil</h2><span id='topic+pkmod_eleveld_remi'></span>

<h3>Description</h3>

<p>Function takes patient covariate values required for the Eleveld
PK or PK-PD model for propofol and returns a 'pkmod' object with the appropriate model
parameters.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>pkmod_eleveld_remi(AGE, MALE, TBW, HGT = NULL, BMI = NULL, PD = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="pkmod_eleveld_remi_+3A_age">AGE</code></td>
<td>
<p>Age (years)</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_remi_+3A_male">MALE</code></td>
<td>
<p>Sex, logical</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_remi_+3A_tbw">TBW</code></td>
<td>
<p>Total body weight (kg).</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_remi_+3A_hgt">HGT</code></td>
<td>
<p>Height (cm). Used to calculate BMI if not provided.</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_remi_+3A_bmi">BMI</code></td>
<td>
<p>Body mass index</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_remi_+3A_pd">PD</code></td>
<td>
<p>Logical. Should PD parameters be returned in addition to PK parameters.</p>
</td></tr>
<tr><td><code id="pkmod_eleveld_remi_+3A_...">...</code></td>
<td>
<p>Arguments passed to 'pkmod'</p>
</td></tr>
</table>


<h3>Value</h3>

<p>'pkmod' object with Eleveld remifentanil population PK or PK-PD parameters
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pkmod_eleveld_remi(AGE = 40,TBW = 56,HGT=150,MALE = TRUE)
</code></pre>

<hr>
<h2 id='pkmod_kim'>Kim population PK model for remifentanil</h2><span id='topic+pkmod_kim'></span>

<h3>Description</h3>

<p>Evaluate Kim population PK model at patient covariate values.
Published in Kim et al. (2017). &quot;Disposition of Remifentanil in Obesity: A New
Pharmacokinetic Model Incorporating the Influence of Body Mass&quot;
Anesthesiology Vol. 126, 1019–1032. doi: https://doi.org/10.1097/ALN.0000000000001635
</p>


<h3>Usage</h3>

<pre><code class='language-R'>pkmod_kim(AGE, TBW, HGT = NULL, BMI = NULL, MALE = NULL, FFM = NULL, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="pkmod_kim_+3A_age">AGE</code></td>
<td>
<p>Age (years)</p>
</td></tr>
<tr><td><code id="pkmod_kim_+3A_tbw">TBW</code></td>
<td>
<p>Total body weight (kg).</p>
</td></tr>
<tr><td><code id="pkmod_kim_+3A_hgt">HGT</code></td>
<td>
<p>Height (cm). Used to calculate BMI if BMI is not provided.</p>
</td></tr>
<tr><td><code id="pkmod_kim_+3A_bmi">BMI</code></td>
<td>
<p>Body mass index. Used to calculate LBM if LBM is not provided.</p>
</td></tr>
<tr><td><code id="pkmod_kim_+3A_male">MALE</code></td>
<td>
<p>Logical. Used to calculate LBM if LBM is not provided.</p>
</td></tr>
<tr><td><code id="pkmod_kim_+3A_ffm">FFM</code></td>
<td>
<p>Fat-free mass. Can be used instead of BMI and MALE.</p>
</td></tr>
<tr><td><code id="pkmod_kim_+3A_...">...</code></td>
<td>
<p>Arguments passed to 'pkmod'</p>
</td></tr>
</table>


<h3>Value</h3>

<p>'pkmod' object with Schnider population PK parameters
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pkmod_kim(AGE = 40,TBW = 75, BMI = 30, MALE = TRUE)
pkmod_kim(AGE = 40,TBW = 75, FFM = 52.83)
</code></pre>

<hr>
<h2 id='pkmod_marsh'>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;
Population PK and PK-PD functions &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-
&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;
Marsh population PK model for propofol</h2><span id='topic+pkmod_marsh'></span>

<h3>Description</h3>

<p>Evaluates the Marsh propofol model at patient covariates (total body mass) and
returns a 'pkmod' object. KE0 parameter set to 1.2 in accordance with recommendations
from Absalom et al., 2009 &quot;Pharmacokinetic models for propofol- Defining and
illuminating the devil in the detail.&quot;
</p>


<h3>Usage</h3>

<pre><code class='language-R'>pkmod_marsh(TBW, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="pkmod_marsh_+3A_tbw">TBW</code></td>
<td>
<p>Weight (kg)</p>
</td></tr>
<tr><td><code id="pkmod_marsh_+3A_...">...</code></td>
<td>
<p>Arguments passed to 'pkmod'</p>
</td></tr>
</table>


<h3>Value</h3>

<p>'pkmod' object with Marsh population PK parameters
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pkmod_marsh(TBW = 50)
</code></pre>

<hr>
<h2 id='pkmod_minto'>Minto population PK model for remifentanil</h2><span id='topic+pkmod_minto'></span>

<h3>Description</h3>

<p>Evaluate Minto population PK model at patient covariate values.
Published in Minto et al. (1997). &quot;Influence of Age and Gender on the
Pharmacokinetics and Pharmacodynamics of Remifentanil: I. Model Development.&quot;
Anesthesiology 86:10-23 doi: https://doi.org/10.1097/00000542-199701000-00004.
Residual error standard deviations are taken from Eleveld et al. (2017).
&quot;An Allometric Model of Remifentanil Pharmacokinetics and Pharmacodynamics.&quot;
Anesthesiology Vol. 126, 1005–1018 doi: https://doi.org/10.1097/ALN.0000000000001634.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>pkmod_minto(
  AGE,
  HGT = NULL,
  TBW = NULL,
  MALE = NULL,
  LBM = NULL,
  PD = TRUE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="pkmod_minto_+3A_age">AGE</code></td>
<td>
<p>Age (years)</p>
</td></tr>
<tr><td><code id="pkmod_minto_+3A_hgt">HGT</code></td>
<td>
<p>Height (cm). Used to calculate LBM if LBM is not provided.</p>
</td></tr>
<tr><td><code id="pkmod_minto_+3A_tbw">TBW</code></td>
<td>
<p>Weight (kg). Used to calculate LBM if LBM is not provided.</p>
</td></tr>
<tr><td><code id="pkmod_minto_+3A_male">MALE</code></td>
<td>
<p>Logical. Used to calculate LBM if LBM is not provided.</p>
</td></tr>
<tr><td><code id="pkmod_minto_+3A_lbm">LBM</code></td>
<td>
<p>Lean body mass (kg). Can be provided instead of TBW, HGT, and MALE</p>
</td></tr>
<tr><td><code id="pkmod_minto_+3A_pd">PD</code></td>
<td>
<p>Logical. Should PD parameters be returned in addition to PK parameters.</p>
</td></tr>
<tr><td><code id="pkmod_minto_+3A_...">...</code></td>
<td>
<p>Arguments passed to 'pkmod'</p>
</td></tr>
</table>


<h3>Value</h3>

<p>'pkmod' object with Schnider population PK parameters
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pkmod_minto(AGE = 40,HGT=170,LBM = 43.9)
pkmod_minto(AGE = 40,HGT=170,TBW=50,MALE=TRUE)
</code></pre>

<hr>
<h2 id='pkmod_schnider'>Schnider population PK model for propofol</h2><span id='topic+pkmod_schnider'></span>

<h3>Description</h3>

<p>Evaluate Schnider population PK model at patient covariate values.
Published in Schnider et al. (1998). &quot;The influence of method of administration
and covariates on the pharmacokinetics of propofol in adult volunteers.&quot;
Anesthesiology 88 (5):1170-82.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>pkmod_schnider(AGE, HGT, LBM = NULL, TBW = NULL, MALE = NULL, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="pkmod_schnider_+3A_age">AGE</code></td>
<td>
<p>Age (years)</p>
</td></tr>
<tr><td><code id="pkmod_schnider_+3A_hgt">HGT</code></td>
<td>
<p>Height (cm)</p>
</td></tr>
<tr><td><code id="pkmod_schnider_+3A_lbm">LBM</code></td>
<td>
<p>Lean body mass (kg). Can be provided instead of TBW, and MALE</p>
</td></tr>
<tr><td><code id="pkmod_schnider_+3A_tbw">TBW</code></td>
<td>
<p>Weight (kg). Used to calculate LBM if LBM is not provided.</p>
</td></tr>
<tr><td><code id="pkmod_schnider_+3A_male">MALE</code></td>
<td>
<p>Logical. Used to calculate LBM if LBM is not provided.</p>
</td></tr>
<tr><td><code id="pkmod_schnider_+3A_...">...</code></td>
<td>
<p>Arguments passed to 'pkmod'</p>
</td></tr>
</table>


<h3>Value</h3>

<p>'pkmod' object with Schnider population PK parameters
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pkmod_schnider(AGE = 40,HGT=170,LBM = 43.9)
pkmod_schnider(AGE = 40,HGT=170,TBW=50,MALE=TRUE)
</code></pre>

<hr>
<h2 id='pkmod1cpt'>One compartment IV infusion with first-order elimination.</h2><span id='topic+pkmod1cpt'></span>

<h3>Description</h3>

<p>One compartment IV infusion with first-order elimination.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>pkmod1cpt(tm, kR, pars, init = 0)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="pkmod1cpt_+3A_tm">tm</code></td>
<td>
<p>Vector of times to evaluate the PK function at</p>
</td></tr>
<tr><td><code id="pkmod1cpt_+3A_kr">kR</code></td>
<td>
<p>Infusion rate (e.g. ml/min).</p>
</td></tr>
<tr><td><code id="pkmod1cpt_+3A_pars">pars</code></td>
<td>
<p>Named vector of parameters with names ('k10','v1') or ('cl','v1').</p>
</td></tr>
<tr><td><code id="pkmod1cpt_+3A_init">init</code></td>
<td>
<p>Initial concentration. Defaults to 0.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric vector of concentrations for a constant infusion rate
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pkmod1cpt(1,1,c(k10 = 0.5, v1 = 1))
pkmod1cpt(1,1,c(KE = 0.5, v1 = 1))
pkmod1cpt(1,1,c(CL = 0.5, v1 = 1))
</code></pre>

<hr>
<h2 id='pkmod2cpt'>Two compartment IV infusion with first-order elimination.</h2><span id='topic+pkmod2cpt'></span>

<h3>Description</h3>

<p>Two compartment IV infusion with first-order elimination. Elimination from peripheral compartment
is assumed to be zero unless 'k20' is specified.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>pkmod2cpt(tm, kR, pars, init = c(0, 0))
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="pkmod2cpt_+3A_tm">tm</code></td>
<td>
<p>Vector of times to evaluate the PK function at</p>
</td></tr>
<tr><td><code id="pkmod2cpt_+3A_kr">kR</code></td>
<td>
<p>Infusion rate (e.g. ml/min).</p>
</td></tr>
<tr><td><code id="pkmod2cpt_+3A_pars">pars</code></td>
<td>
<p>Named vector of parameters with names ('K10','K12','K21','V1','V2') or ('CL','Q','V1','V2').</p>
</td></tr>
<tr><td><code id="pkmod2cpt_+3A_init">init</code></td>
<td>
<p>Initial concentration. Defaults to 0 in both compartments.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric matrix of concentrations for a constant infusion rate
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pkmod2cpt(1,1,c(CL = 15, V1 = 10, Q2 = 10, V2 = 20))
pkmod2cpt(1,1,c(CL = 15, v1 = 10, Q2 = 10, V2 = 20, cl2 = 4))
</code></pre>

<hr>
<h2 id='pkmod3cpt'>Three compartment IV infusion with first-order elimination.</h2><span id='topic+pkmod3cpt'></span>

<h3>Description</h3>

<p>Three compartment IV infusion with first-order elimination. Elimination is assumed to occur
only from central compartment if 'k20', 'k30' are not specified.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>pkmod3cpt(tm, kR, pars, init = c(0, 0, 0))
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="pkmod3cpt_+3A_tm">tm</code></td>
<td>
<p>Vector of times to evaluate the PK function at</p>
</td></tr>
<tr><td><code id="pkmod3cpt_+3A_kr">kR</code></td>
<td>
<p>Infusion rate (e.g. ml/min).</p>
</td></tr>
<tr><td><code id="pkmod3cpt_+3A_pars">pars</code></td>
<td>
<p>Named vector of parameters with names ('K10','K12','K21','V1','V2') or ('CL','Q','V1','V2').</p>
</td></tr>
<tr><td><code id="pkmod3cpt_+3A_init">init</code></td>
<td>
<p>Initial concentration. Defaults to 0 in all compartments.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric matrix of concentrations for a constant infusion rate
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pkmod3cpt(1,1,c(CL = 15, Q2 = 10, Q3 = 5, V1 = 10, V2 = 20, V3 = 50))
</code></pre>

<hr>
<h2 id='pkmod3cptm'>Solution to three-compartment IV model with effect-site</h2><span id='topic+pkmod3cptm'></span>

<h3>Description</h3>

<p>3 compartment IV infusion with first-order absorption between compartments and with an additional effect-site compartment.
The analytical solutions implemented in this function are provided in &quot;ADVAN-style analytical solutions for common pharmacokinetic models&quot; by
Abuhelwa et al. 2015.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>pkmod3cptm(tm, kR, pars, init = c(0, 0, 0, 0))
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="pkmod3cptm_+3A_tm">tm</code></td>
<td>
<p>Vector of times to evaluate the PK function at</p>
</td></tr>
<tr><td><code id="pkmod3cptm_+3A_kr">kR</code></td>
<td>
<p>Infusion rate (e.g. ml/min).</p>
</td></tr>
<tr><td><code id="pkmod3cptm_+3A_pars">pars</code></td>
<td>
<p>Named vector of parameters with names (k10,k12,k21,k13,k31,v1,v2,v3,ke0)</p>
</td></tr>
<tr><td><code id="pkmod3cptm_+3A_init">init</code></td>
<td>
<p>Initial concentration</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function takes in arguments for each of the absorption and elimination rate constants of a three-compartment model
as well as initial concentrations, c0. ke0 gives the rate of elimination from the effect-site compartment into the
central compartment (i.e. k41). The rate of absorption into the effect-site compartment is set at 1/10,000 the value of ke0.
The function returns a set of functions that calculate the concentration in each of the four compartments as a function of
time.
</p>


<h3>Value</h3>

<p>Numeric matrix of concentrations for a constant infusion rate
</p>


<h3>Examples</h3>

<pre><code class='language-R'>pars_3cpt &lt;- c(k10=1.5,k12=0.15,k21=0.09,k13=0.8,k31=0.8,v1=10,v2=15,v3=100,ke0=1)
pkmod3cptm(1,1,pars_3cpt)
</code></pre>

<hr>
<h2 id='plot.sim_tci'>Plot method for sim_tci class</h2><span id='topic+plot.sim_tci'></span>

<h3>Description</h3>

<p>Plot object with class &quot;sim_tci&quot; created by 'simulate_tci()'.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'sim_tci'
plot(
  x,
  ...,
  yvar = NULL,
  id = NULL,
  type = c("true", "prior", "posterior"),
  show_inf = FALSE,
  show_data = FALSE,
  show_updates = FALSE,
  wrap_id = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="plot.sim_tci_+3A_x">x</code></td>
<td>
<p>Object with class &quot;sim_tci&quot; created by 'simulate_tci()'</p>
</td></tr>
<tr><td><code id="plot.sim_tci_+3A_...">...</code></td>
<td>
<p>Other arguments. Not currently used.</p>
</td></tr>
<tr><td><code id="plot.sim_tci_+3A_yvar">yvar</code></td>
<td>
<p>Response variable. Options are concentrations (&quot;c1&quot;,&quot;c2&quot;,...) or
&quot;pdresp&quot; for a PD response. Only one variable may be plotted at a time.</p>
</td></tr>
<tr><td><code id="plot.sim_tci_+3A_id">id</code></td>
<td>
<p>Subset of IDs to plot. Will default to all if unspecified. Can be
displayed in separate plots via 'wrap_id' argument.</p>
</td></tr>
<tr><td><code id="plot.sim_tci_+3A_type">type</code></td>
<td>
<p>Type of response to plot. Options are &quot;prior&quot;, &quot;true&quot;, or &quot;posterior&quot;
if closed-loop control was used.</p>
</td></tr>
<tr><td><code id="plot.sim_tci_+3A_show_inf">show_inf</code></td>
<td>
<p>Logical. Display infusion rates alongside response values.</p>
</td></tr>
<tr><td><code id="plot.sim_tci_+3A_show_data">show_data</code></td>
<td>
<p>Logical. Display simulated data values in addition to responses.</p>
</td></tr>
<tr><td><code id="plot.sim_tci_+3A_show_updates">show_updates</code></td>
<td>
<p>Logical, for closed-loop only. Show update times along x-axis.</p>
</td></tr>
<tr><td><code id="plot.sim_tci_+3A_wrap_id">wrap_id</code></td>
<td>
<p>Logical. Separate plots by ID value.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Plots simulation results
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data &lt;- data.frame(ID = 1:2, AGE = c(30,40), TBW = c(70,80),
HGT = c(160,170), MALE = c(FALSE,TRUE))
pkmod_prior &lt;- poppkmod(data, drug = "ppf", model = "eleveld")
pkmod_true  &lt;- poppkmod(data, drug = "ppf", model = "eleveld", sample = TRUE)
obs_tms &lt;- seq(1/6,10,1/6)
target_vals = c(75,60,50,50)
target_tms = c(0,3,6,10)

# open-loop simulation (without update_tms)
sim_ol &lt;- simulate_tci(pkmod_prior, pkmod_true, target_vals, target_tms, obs_tms,
seed = 200)
plot(sim_ol, id = 1, type = "true")
plot(sim_ol, yvar = "c4", type = "true")
plot(sim_ol, yvar = "c4", type = "true", wrap_id = TRUE, show_inf = TRUE)

# closed-loop simulation (with update_tms)
## Not run: 
sim_cl &lt;- simulate_tci(pkmod_prior, pkmod_true, target_vals, target_tms, obs_tms,
update_tms = c(2,4,6), seed = 200)
plot(sim_cl, type = "posterior", id = 1, show_inf = TRUE)
plot(sim_cl, type = "posterior", wrap_id = TRUE, show_data = TRUE)
plot(sim_cl, yvar = "c4", wrap_id = TRUE)

## End(Not run)
</code></pre>

<hr>
<h2 id='poppkmod'>Implement a population pharmacokinetic/pharmacodynamic model.</h2><span id='topic+poppkmod'></span>

<h3>Description</h3>

<p>Create a 'poppkmod' object using an existing population PK model
for propofol or remifentanil using patient covariates. Available models for
propofol are the Marsh, Schnider, and Eleveld models. Available models for
remifentanil are the Minto, Kim, and Eleveld models. Input is
a data frame with rows corresponding to individuals and columns
recording patient covariates. An ID column is optional, but will be generated
as 1:nrow(data) if not supplied. Covariates required by each model are
</p>
<p><strong>Propofol</strong>
</p>

<ul>
<li><p> Marsh: TBW
</p>
</li>
<li><p> Schnider: (AGE, HGT, TBW, MALE) or (AGE, HGT, LBW)
</p>
</li>
<li><p> Eleveld: AGE, TBW, HGT, MALE
</p>
</li></ul>

<p><strong>Remifentanil</strong>
</p>

<ul>
<li><p> Minto: (AGE, HGT, TBW, MALE) or (AGE, HGT, LBW)
</p>
</li>
<li><p> Kim: (AGE, TBW, BMI, HGT) or (AGE, TBW, FFM)
</p>
</li>
<li><p> Eleveld: (AGE, MALE, TBW, HGT) or (AGE, MALE, TBW, BMI)
</p>
</li></ul>

<p><strong>Abbreviations</strong>
</p>

<ul>
<li><p> TBW = Total body weight (kg)
</p>
</li>
<li><p> LBW = Lean body weight (kg)
</p>
</li>
<li><p> FFM = Fat-free mass (kg)
</p>
</li>
<li><p> AGE = Age (years)
</p>
</li>
<li><p> HGT = Height (cm)
</p>
</li>
<li><p> MALE = Male (1/0, TRUE/FALSE)
</p>
</li>
<li><p> BMI = Body mass index (kg/<code class="reqn">m^2</code>)
</p>
</li></ul>



<h3>Usage</h3>

<pre><code class='language-R'>poppkmod(
  data,
  drug = c("ppf", "remi"),
  model = c("marsh", "schnider", "eleveld", "minto", "kim"),
  sample = FALSE,
  PD = TRUE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="poppkmod_+3A_data">data</code></td>
<td>
<p>Data frame of patient covariates. ID values, if used, should be in a column labeled &quot;id&quot; or &quot;ID&quot;</p>
</td></tr>
<tr><td><code id="poppkmod_+3A_drug">drug</code></td>
<td>
<p>&quot;ppf&quot; for propofol or &quot;remi&quot; for remifentanil. Defaults to &quot;ppf&quot;.</p>
</td></tr>
<tr><td><code id="poppkmod_+3A_model">model</code></td>
<td>
<p>Model name. Options are &quot;marsh&quot;, &quot;schnider&quot;, or &quot;eleveld&quot; if
drug = &quot;ppf&quot;, or &quot;minto&quot;, &quot;kim&quot;, or &quot;eleveld&quot; if drug = &quot;remi&quot;.</p>
</td></tr>
<tr><td><code id="poppkmod_+3A_sample">sample</code></td>
<td>
<p>Logical. Should parameter values be sampled from interindividual distribution (TRUE)
or evaluated at point estimates for covariates (FALSE)? Defaults to FALSE.</p>
</td></tr>
<tr><td><code id="poppkmod_+3A_pd">PD</code></td>
<td>
<p>Logical. If applicable, should the PD component be evaluated for PK-PD models. Defaults to TRUE.</p>
</td></tr>
<tr><td><code id="poppkmod_+3A_...">...</code></td>
<td>
<p>Arguments passed on to each pkmod object</p>
</td></tr>
</table>


<h3>Value</h3>

<p>'poppkmod' object
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data &lt;- data.frame(ID = 1:5, AGE = seq(20,60,by=10), TBW = seq(60,80,by=5),
HGT = seq(150,190,by=10), MALE = c(TRUE,TRUE,FALSE,FALSE,FALSE))
poppkmod(data, drug = "ppf", model = "eleveld")
poppkmod(data, drug = "remi", model = "kim")
</code></pre>

<hr>
<h2 id='predict.pkmod'>Predict method for pkmod objects</h2><span id='topic+predict.pkmod'></span>

<h3>Description</h3>

<p>Predict concentrations from a pkmod object - can be a user defined function
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'pkmod'
predict(object, inf, tms, return_times = FALSE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="predict.pkmod_+3A_object">object</code></td>
<td>
<p>An object with class pkmod.</p>
</td></tr>
<tr><td><code id="predict.pkmod_+3A_inf">inf</code></td>
<td>
<p>A matrix with columns &quot;begin&quot;,&quot;end&quot;,&quot;inf_rate&quot; indicating when infusions should
be administered. Can be created by 'inf_manual' or 'inf_tci'.</p>
</td></tr>
<tr><td><code id="predict.pkmod_+3A_tms">tms</code></td>
<td>
<p>Times at which to calculate predicted concentrations.</p>
</td></tr>
<tr><td><code id="predict.pkmod_+3A_return_times">return_times</code></td>
<td>
<p>Logical. Should prediction times be returned along with responses? Defaults to FALSE.</p>
</td></tr>
<tr><td><code id="predict.pkmod_+3A_...">...</code></td>
<td>
<p>List or vector of values to be passed on to update.pkmod.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Matrix of predicted concentrations associated with a pkmod object and
and infusion schedule.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># dosing schedule
dose &lt;- inf_manual(inf_tms = c(0,0.5,4,4.5,10), inf_rate = c(100,0,80,0,0))
# pkmod object
my_mod &lt;- pkmod(pars_pk = c(CL = 15, V1 = 10, Q2 = 10, V2 = 20))
# predict at specific times
predict(my_mod, inf = dose, tms = c(1.5,2.5,3))
# predict with an Emax PD function
my_mod_pd &lt;- pkmod(pars_pk = c(v1 = 8.995, v2 = 17.297, v3 = 120.963, cl = 1.382,
q2 = 0.919, q3 = 0.609, ke0 = 1.289),
pars_pd = c(c50 = 2.8, gamma = 1.47, gamma2 = 1.89, e0 = 93, emx = 93),
pdfn = emax, pdinv = emax_inv, ecmpt = 4)
predict(my_mod_pd, inf = dose, tms = c(1.5,2.5,3))
# predict with a subset of new PK-PD parameters
predict(my_mod_pd, inf = dose, tms = c(1.5,2.5,3), pars_pk = c(ke0 = 0.8),
pars_pd = c(c50 = 2, e0 = 100))
</code></pre>

<hr>
<h2 id='predict.poppkmod'>Predict method for pkmod objects</h2><span id='topic+predict.poppkmod'></span>

<h3>Description</h3>

<p>Predict concentrations from a pkmod object - can be a user defined function
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'poppkmod'
predict(object, inf, tms, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="predict.poppkmod_+3A_object">object</code></td>
<td>
<p>An object with class poppkmod.</p>
</td></tr>
<tr><td><code id="predict.poppkmod_+3A_inf">inf</code></td>
<td>
<p>A matrix with columns &quot;begin&quot;,&quot;end&quot;,&quot;inf_rate&quot; indicating when infusions should
be administered. Can be created by 'inf_manual' or 'inf_tci'.</p>
</td></tr>
<tr><td><code id="predict.poppkmod_+3A_tms">tms</code></td>
<td>
<p>Times at which to calculate predicted concentrations.</p>
</td></tr>
<tr><td><code id="predict.poppkmod_+3A_...">...</code></td>
<td>
<p>List or vector of values to be passed on to predict.pkmod.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Matrix of predicted concentrations associated with a poppkmod object and
and infusion schedule.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># dosing schedule
dose &lt;- inf_manual(inf_tms = c(0,0.5,4,4.5,10), inf_rate = c(100,0,80,0,0))
# poppkmod object
data &lt;- data.frame(ID = 1:5, AGE = seq(20,60,by=10), TBW = seq(60,80,by=5),
HGT = seq(150,190,by=10), MALE = c(TRUE,TRUE,FALSE,FALSE,FALSE))
elvd_mod &lt;- poppkmod(data, drug = "ppf", model = "eleveld")
predict(elvd_mod, inf = dose, tms = c(1.5,2.5,3))
</code></pre>

<hr>
<h2 id='print.pkmod'>Print pkmod</h2><span id='topic+print.pkmod'></span>

<h3>Description</h3>

<p>Print method for pkmod objects
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'pkmod'
print(x, ..., digits = 3)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="print.pkmod_+3A_x">x</code></td>
<td>
<p>Object with class &quot;pkmod&quot; created by 'pkmod()'</p>
</td></tr>
<tr><td><code id="print.pkmod_+3A_...">...</code></td>
<td>
<p>Arguments passed to 'update.pkmod()'</p>
</td></tr>
<tr><td><code id="print.pkmod_+3A_digits">digits</code></td>
<td>
<p>Number of significant digits to print</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Prints description of pkmod
</p>


<h3>Examples</h3>

<pre><code class='language-R'># 1-parameter model
pkmod(pars_pk = c(CL = 10, V1 = 10))
</code></pre>

<hr>
<h2 id='print.poppkmod'>Print poppkmod</h2><span id='topic+print.poppkmod'></span>

<h3>Description</h3>

<p>Print method for poppkmod objects
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'poppkmod'
print(x, ..., digits = 3)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="print.poppkmod_+3A_x">x</code></td>
<td>
<p>Object with class &quot;pkmod&quot; created by 'poppkmod()'</p>
</td></tr>
<tr><td><code id="print.poppkmod_+3A_...">...</code></td>
<td>
<p>Additional arguments. Not used</p>
</td></tr>
<tr><td><code id="print.poppkmod_+3A_digits">digits</code></td>
<td>
<p>Number of significant digits to print</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Prints description of pkmod
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data &lt;- data.frame(ID = 1:5,
AGE = seq(20,60,by=10),
TBW = seq(60,80,by=5),
HGT = seq(150,190,by=10),
MALE = c(TRUE,TRUE,FALSE,FALSE,FALSE))
poppkmod(data, drug = "ppf", model = "eleveld")
poppkmod(data, drug = "remi", model = "kim")
</code></pre>

<hr>
<h2 id='print.sim_tci'>Print method for sim_tci class</h2><span id='topic+print.sim_tci'></span>

<h3>Description</h3>

<p>Print object with class &quot;sim_tci&quot; created by 'simulate_tci()'.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'sim_tci'
print(x, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="print.sim_tci_+3A_x">x</code></td>
<td>
<p>Object with class &quot;sim_tci&quot; created by 'simulate_tci()'</p>
</td></tr>
<tr><td><code id="print.sim_tci_+3A_...">...</code></td>
<td>
<p>Other arguments. Not currently used.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Prints a description of the simulation.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data &lt;- data.frame(ID = 1:3, AGE = c(20,30,40), TBW = c(60,70,80),
HGT = c(150,160,170), MALE = c(TRUE,FALSE,TRUE))
pkmod_prior &lt;- poppkmod(data, drug = "ppf", model = "eleveld")
pkmod_true  &lt;- poppkmod(data, drug = "ppf", model = "eleveld", sample = TRUE)
obs_tms &lt;- seq(1/6,10,1/6)
target_vals = c(75,60,50,50)
target_tms = c(0,3,6,10)

# open-loop simulation (without update_tms)
sim_ol &lt;- simulate_tci(pkmod_prior, pkmod_true, target_vals, target_tms, obs_tms,
seed = 200)

# closed-loop simulation (with update_tms)
## Not run: 
sim_cl &lt;- simulate_tci(pkmod_prior, pkmod_true, target_vals, target_tms, obs_tms,
update_tms = c(2,4,6,8), seed = 200)

## End(Not run)
</code></pre>

<hr>
<h2 id='sample_iiv'>Sample PK or PK-PD parameters from the distribution of inter- or intra-individual variability</h2><span id='topic+sample_iiv'></span>

<h3>Description</h3>

<p>Sample PK or PK-PD parameters from the distribution of random effects
for a 'pkmod' or 'poppkmod' object, as described by the Omega matrix (see ?pkmod).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>sample_iiv(mod, log_normal = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="sample_iiv_+3A_mod">mod</code></td>
<td>
<p>'pkmod' or 'poppkmod' object with associated Omega matrix describing random effect variances</p>
</td></tr>
<tr><td><code id="sample_iiv_+3A_log_normal">log_normal</code></td>
<td>
<p>Logical. Assumes random effects are log-normally distributed
and multiplicative if TRUE, additive and normally distributed if FALSE.</p>
</td></tr>
<tr><td><code id="sample_iiv_+3A_...">...</code></td>
<td>
<p>Arguments passed to update.pkmod.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns model passed to &quot;mod&quot; argument with randomly sampled PK or PK-PD
parameters.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># sample from single PK model
sample_iiv(pkmod_schnider(AGE = 40,HGT=170,TBW=50,MALE=TRUE))
# sample from `poppkmod`
data &lt;- data.frame(ID = 1:5, AGE = seq(20,60,by=10), TBW = seq(60,80,by=5),
HGT = seq(150,190,by=10), MALE = c(TRUE,TRUE,FALSE,FALSE,FALSE))
sample_iiv(poppkmod(data = data, drug = "ppf", model = "eleveld"))
</code></pre>

<hr>
<h2 id='sample_pkmod'>Sample parameters from a 'pkmod' object</h2><span id='topic+sample_pkmod'></span>

<h3>Description</h3>

<p>Sample parameters from a 'pkmod' object
</p>


<h3>Usage</h3>

<pre><code class='language-R'>sample_pkmod(pkmod, log_normal = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="sample_pkmod_+3A_pkmod">pkmod</code></td>
<td>
<p>'pkmod' object with associated Omega matrix describing random effect variances</p>
</td></tr>
<tr><td><code id="sample_pkmod_+3A_log_normal">log_normal</code></td>
<td>
<p>Logical. Assumes random effects are log-normally distributed
and multiplicative if TRUE, additive and normally distributed if FALSE.</p>
</td></tr>
<tr><td><code id="sample_pkmod_+3A_...">...</code></td>
<td>
<p>Arguments passed to update.pkmod</p>
</td></tr>
</table>


<h3>Value</h3>

<p>'pkmod' object with updated parameters.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>sample_pkmod(pkmod_schnider(AGE = 40,HGT=170,TBW=50,MALE=TRUE))
sample_pkmod(pkmod_eleveld_ppf(AGE = 40,TBW = 56,HGT=150,MALE = TRUE, PD = FALSE))
</code></pre>

<hr>
<h2 id='simulate_clc'>Simulate closed-loop control using Bayesian updates</h2><span id='topic+simulate_clc'></span>

<h3>Description</h3>

<p>Simulate closed-loop control using Bayesian updates for 'pkmod' or 'poppkmod' objects.
Infusion rates are calculated using 'pkmod_prior' to reach 'target_vals' at
'target_tms'. Data values are simulated using 'pkmod_true' at 'obs_tms'.
'pkmod_prior' and 'pkmod_true' do not need to have the same structure. Model
parameters are updated at each update time using all available simulated observations.
Processing delays can be added through the 'delay' argument, such that observations
aren't made available to the update mechanism until 'update_tms &gt;= obs_tms + delay'.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>simulate_clc(
  pkmod_prior,
  pkmod_true,
  target_vals,
  target_tms,
  obs_tms,
  update_tms,
  type = c("effect", "plasma"),
  custom_alg = NULL,
  resp_bounds = NULL,
  delay = 0,
  seed = NULL,
  verbose = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="simulate_clc_+3A_pkmod_prior">pkmod_prior</code></td>
<td>
<p>'pkmod' or 'poppkmod' object describing a PK/PK-PD model that is used to calculate
TCI infusion rates and is updated as data are simulated and incorporated. Must have an
associated Omega matrix.</p>
</td></tr>
<tr><td><code id="simulate_clc_+3A_pkmod_true">pkmod_true</code></td>
<td>
<p>&lsquo;pkmod' or 'poppkmod' object describing the patient&rsquo;s &quot;true&quot; response. This model
will be used to simulate observations.</p>
</td></tr>
<tr><td><code id="simulate_clc_+3A_target_vals">target_vals</code></td>
<td>
<p>A vector of numeric values indicating PK or PD targets for TCI algorithm.</p>
</td></tr>
<tr><td><code id="simulate_clc_+3A_target_tms">target_tms</code></td>
<td>
<p>A vector of numeric values indicating times at which the TCI algorithm should
begin targeting each value.</p>
</td></tr>
<tr><td><code id="simulate_clc_+3A_obs_tms">obs_tms</code></td>
<td>
<p>Times at which data values should be simulated from 'pkmod_true'.</p>
</td></tr>
<tr><td><code id="simulate_clc_+3A_update_tms">update_tms</code></td>
<td>
<p>Times at which 'pkmod_prior' should be updated using all available
simulated observations.</p>
</td></tr>
<tr><td><code id="simulate_clc_+3A_type">type</code></td>
<td>
<p>Type of TCI algorithm to be used. Options are &quot;plasma&quot; and &quot;effect&quot;.
Defaults to &quot;effect&quot;. Will be overwritten if 'custom_alg' is non-null.</p>
</td></tr>
<tr><td><code id="simulate_clc_+3A_custom_alg">custom_alg</code></td>
<td>
<p>Custom TCI algorithm to overwrite default plasma- or effect-site targeting.</p>
</td></tr>
<tr><td><code id="simulate_clc_+3A_resp_bounds">resp_bounds</code></td>
<td>
<p>Optional vector of two values indicating minimum and maximum values possible for the response.</p>
</td></tr>
<tr><td><code id="simulate_clc_+3A_delay">delay</code></td>
<td>
<p>Optional numeric value indicating a temporal delay between when observations
are simulated and when they should be made available for updating 'pkmod_prior'. For example,
a delay should be set to account for a processing time delay in Bispectral Index measurements
or the time required to measure drug concentrations from collected samples.</p>
</td></tr>
<tr><td><code id="simulate_clc_+3A_seed">seed</code></td>
<td>
<p>An integer used to initialize the random number generator.</p>
</td></tr>
<tr><td><code id="simulate_clc_+3A_verbose">verbose</code></td>
<td>
<p>Logical. Print progress as simulation is run.</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>data &lt;- data.frame(ID = 1:3, AGE = c(20,30,40), TBW = c(60,70,80),
HGT = c(150,160,170), MALE = c(TRUE,FALSE,TRUE))
pkmod_prior &lt;- poppkmod(data, drug = "ppf", model = "eleveld")
pkmod_true  &lt;- poppkmod(data, drug = "ppf", model = "eleveld", sample = TRUE)
obs_tms &lt;- seq(1/6,10,1/6)
update_tms &lt;- c(2,4,6,8)
target_vals = c(75,60,50,50)
target_tms = c(0,3,6,10)
## Not run: 
sim &lt;- simulate_clc(pkmod_prior, pkmod_true, target_vals, target_tms, obs_tms,
update_tms, seed = 200)
len &lt;- 500
tms &lt;- seq(0,10,length.out = len)
resp &lt;- data.frame(rbind(predict(pkmod_true, sim$inf, tms),
predict(pkmod_prior, sim$inf, tms),
predict(sim$pkmod_post, sim$inf, tms)))
resp$type = c(rep("true",len*3),rep("prior",len*3),rep("posterior",len*3))
library(ggplot2)
ggplot(resp) + geom_line(aes(x = time, y = pdresp, color = factor(id))) +
facet_wrap(~type) + labs(x = "Hours", y = "Bispectral Index") +
  geom_step(data = data.frame(time = target_tms, value = target_vals),
  aes(x = time, y = value), inherit.aes = FALSE)

## End(Not run)
</code></pre>

<hr>
<h2 id='simulate_olc'>Simulate open-loop control using TCI</h2><span id='topic+simulate_olc'></span>

<h3>Description</h3>

<p>Simulate open-loop control using TCI for 'pkmod' or 'poppkmod' objects.
Infusion rates are calculated using 'pkmod_prior' to reach 'target_vals' at
'target_tms'. Data values are simulated using 'pkmod_true' at 'obs_tms'.
'pkmod_prior' and 'pkmod_true' do not need to have the same structure, but
are required to have the same number of IDs (i.e., N) if 'poppkmod' objects
are used.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>simulate_olc(
  pkmod_prior,
  pkmod_true,
  target_vals,
  target_tms,
  obs_tms,
  type = c("effect", "plasma"),
  custom_alg = NULL,
  resp_bounds = NULL,
  seed = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="simulate_olc_+3A_pkmod_prior">pkmod_prior</code></td>
<td>
<p>'pkmod' object describing a PK/PK-PD model that is used to calculate
TCI infusion rates and is updated as data are simulated and incorporated. Must have an
associated Omega matrix.</p>
</td></tr>
<tr><td><code id="simulate_olc_+3A_pkmod_true">pkmod_true</code></td>
<td>
<p>&lsquo;pkmod' object describing the patient&rsquo;s &quot;true&quot; response. This model
will be used to simulate observations.</p>
</td></tr>
<tr><td><code id="simulate_olc_+3A_target_vals">target_vals</code></td>
<td>
<p>A vector of numeric values indicating PK or PD targets for TCI algorithm.</p>
</td></tr>
<tr><td><code id="simulate_olc_+3A_target_tms">target_tms</code></td>
<td>
<p>A vector of numeric values indicating times at which the TCI algorithm should
begin targeting each value.</p>
</td></tr>
<tr><td><code id="simulate_olc_+3A_obs_tms">obs_tms</code></td>
<td>
<p>Times at which data values should be simulated from 'pkmod_true'.</p>
</td></tr>
<tr><td><code id="simulate_olc_+3A_type">type</code></td>
<td>
<p>Type of TCI algorithm to be used. Options are &quot;plasma&quot; and &quot;effect&quot;.
Defaults to &quot;effect&quot;. Will be overwritten if 'custom_alg' is non-null.</p>
</td></tr>
<tr><td><code id="simulate_olc_+3A_custom_alg">custom_alg</code></td>
<td>
<p>Custom TCI algorithm to overwrite default plasma- or effect-site targeting.</p>
</td></tr>
<tr><td><code id="simulate_olc_+3A_resp_bounds">resp_bounds</code></td>
<td>
<p>Optional vector of two values indicating minimum and maximum values possible for the response.</p>
</td></tr>
<tr><td><code id="simulate_olc_+3A_seed">seed</code></td>
<td>
<p>An integer used to initialize the random number generator.</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>data &lt;- data.frame(ID = 1:5, AGE = seq(20,60,by=10), TBW = seq(60,80,by=5),
HGT = seq(150,190,by=10), MALE = c(TRUE,TRUE,FALSE,FALSE,FALSE))
pkmod_prior &lt;- poppkmod(data, drug = "ppf", model = "eleveld")
pkmod_true  &lt;- poppkmod(data, drug = "ppf", model = "eleveld", sample = TRUE)
obs_tms &lt;- seq(1/6,10,1/6)
target_vals = c(75,60,50,50)
target_tms = c(0,3,6,10)
sim &lt;- simulate_olc(pkmod_prior, pkmod_true, target_vals, target_tms, obs_tms)
len &lt;- 500
tms &lt;- seq(0,10,length.out = len)
resp &lt;- data.frame(rbind(predict(pkmod_true, sim$inf, tms),
predict(pkmod_prior, sim$inf, tms)))
resp$type = c(rep("true",len*5),rep("prior",len*5))
library(ggplot2)
ggplot(resp) + geom_line(aes(x = time, y = pdresp, color = factor(id))) + facet_wrap(~type) +
  labs(x = "Hours", y = "Bispectral Index") + theme_bw() +
  geom_step(data = data.frame(time = target_tms, value = target_vals),
  aes(x = time, y = value), inherit.aes = FALSE)
</code></pre>

<hr>
<h2 id='simulate_tci'>Simulate open- or closed-loop control</h2><span id='topic+simulate_tci'></span>

<h3>Description</h3>

<p>Simulate responses from a 'pkmod' or 'poppkmod' object using TCI control.
Infusion rates are calculated to reach targets using 'pkmod_prior'. Data values
are simulated using 'pkmod_true'. 'pkmod_prior' and 'pkmod_true' do not need to
have the same parameters or structure and should be different when simulating
responses under model misspecification.
If update times (argument 'update_tms') are provided then the function 'simulate_clc'
is called for &quot;closed-loop&quot; control and model parameters will be updated via
Bayes' rule using available data. Only parameters with values in the Omega matrix
will be updated. A data processing delay can be added through the argument 'delay'.
See ?bayes_update? for more details. If update times are not specified, then
the function 'simulate_olc' will be called to implement &quot;open-loop&quot; control
and model parameters will not be updated. Simulation results have class 'tci_sim'
and can be plotted using 'plot.tci_sim()'.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>simulate_tci(
  pkmod_prior,
  pkmod_true,
  target_vals,
  target_tms,
  obs_tms,
  update_tms = NULL,
  type = c("effect", "plasma"),
  custom_alg = NULL,
  resp_bounds = NULL,
  delay = 0,
  seed = NULL,
  verbose = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="simulate_tci_+3A_pkmod_prior">pkmod_prior</code></td>
<td>
<p>'pkmod' or 'poppkmod' object describing a PK/PK-PD model that is used to calculate
TCI infusion rates and is updated as data are simulated and incorporated. Must have an
associated Omega matrix.</p>
</td></tr>
<tr><td><code id="simulate_tci_+3A_pkmod_true">pkmod_true</code></td>
<td>
<p>&lsquo;pkmod' or 'poppkmod' object describing the patient&rsquo;s &quot;true&quot; response. This model
will be used to simulate observations.</p>
</td></tr>
<tr><td><code id="simulate_tci_+3A_target_vals">target_vals</code></td>
<td>
<p>A vector of numeric values indicating PK or PD targets for TCI algorithm.</p>
</td></tr>
<tr><td><code id="simulate_tci_+3A_target_tms">target_tms</code></td>
<td>
<p>A vector of numeric values indicating times at which the TCI algorithm should
begin targeting each value.</p>
</td></tr>
<tr><td><code id="simulate_tci_+3A_obs_tms">obs_tms</code></td>
<td>
<p>Times at which data values should be simulated from 'pkmod_true'.</p>
</td></tr>
<tr><td><code id="simulate_tci_+3A_update_tms">update_tms</code></td>
<td>
<p>Times at which 'pkmod_prior' should be updated using all available
simulated observations.</p>
</td></tr>
<tr><td><code id="simulate_tci_+3A_type">type</code></td>
<td>
<p>Type of TCI algorithm to be used. Options are &quot;plasma&quot; and &quot;effect&quot;.
Defaults to &quot;effect&quot;. Will be overwritten if 'custom_alg' is non-null.</p>
</td></tr>
<tr><td><code id="simulate_tci_+3A_custom_alg">custom_alg</code></td>
<td>
<p>Custom TCI algorithm to overwrite default plasma- or effect-site targeting.</p>
</td></tr>
<tr><td><code id="simulate_tci_+3A_resp_bounds">resp_bounds</code></td>
<td>
<p>Optional vector of two values indicating minimum and maximum values possible for the response.</p>
</td></tr>
<tr><td><code id="simulate_tci_+3A_delay">delay</code></td>
<td>
<p>Optional numeric value indicating a temporal delay between when observations
are simulated and when they should be made available for updating 'pkmod_prior'. For example,
a delay should be set to account for a processing time delay in Bispectral Index measurements
or the time required to measure drug concentrations from collected samples.</p>
</td></tr>
<tr><td><code id="simulate_tci_+3A_seed">seed</code></td>
<td>
<p>An integer used to initialize the random number generator.</p>
</td></tr>
<tr><td><code id="simulate_tci_+3A_verbose">verbose</code></td>
<td>
<p>Logical. Print progress as simulation is run.</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>data &lt;- data.frame(ID = 1:3, AGE = c(20,30,40), TBW = c(60,70,80),
HGT = c(150,160,170), MALE = c(TRUE,FALSE,TRUE))
pkmod_prior &lt;- poppkmod(data, drug = "ppf", model = "eleveld")
pkmod_true  &lt;- poppkmod(data, drug = "ppf", model = "eleveld", sample = TRUE)
obs_tms &lt;- seq(1/6,10,1/6)
target_vals = c(75,60,50,50)
target_tms = c(0,3,6,10)

# open-loop simulation (without updates)
sim_ol &lt;- simulate_tci(pkmod_prior, pkmod_true, target_vals, target_tms, obs_tms,
seed = 200)
plot(sim_ol)

# closed-loop simulation (with updates)
## Not run: 
sim_cl &lt;- simulate_tci(pkmod_prior, pkmod_true, target_vals, target_tms, obs_tms,
update_tms = c(2,4,6,8), seed = 200)
plot(sim_cl, wrap_id = TRUE, show_inf = TRUE, show_data = TRUE)

## End(Not run)
</code></pre>

<hr>
<h2 id='simulate.pkmod'>Simulate method for pkmod objects</h2><span id='topic+simulate.pkmod'></span>

<h3>Description</h3>

<p>Simulate observations from a pkmod object
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'pkmod'
simulate(
  object,
  nsim = 1,
  seed = NULL,
  ...,
  inf,
  tms,
  obs_cmpt = 1,
  resp_bounds = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="simulate.pkmod_+3A_object">object</code></td>
<td>
<p>An object with class &quot;pkmod&quot; generated by 'pkmod'</p>
</td></tr>
<tr><td><code id="simulate.pkmod_+3A_nsim">nsim</code></td>
<td>
<p>Number of observations to simulate at each time point. Defaults to 1.</p>
</td></tr>
<tr><td><code id="simulate.pkmod_+3A_seed">seed</code></td>
<td>
<p>An integer used to initialize the random number generator.</p>
</td></tr>
<tr><td><code id="simulate.pkmod_+3A_...">...</code></td>
<td>
<p>Arguments passed to 'update.pkmod'.</p>
</td></tr>
<tr><td><code id="simulate.pkmod_+3A_inf">inf</code></td>
<td>
<p>A matrix of infusion rates with columns 'begin', 'end', and 'inf_rate'. This
can be created manually, by 'inf_manual', or by 'inf_tci'.</p>
</td></tr>
<tr><td><code id="simulate.pkmod_+3A_tms">tms</code></td>
<td>
<p>Times at which to simulate observations.</p>
</td></tr>
<tr><td><code id="simulate.pkmod_+3A_obs_cmpt">obs_cmpt</code></td>
<td>
<p>Integer value indicating compartment in which observations are taken.
Overridden if a PD model is included.</p>
</td></tr>
<tr><td><code id="simulate.pkmod_+3A_resp_bounds">resp_bounds</code></td>
<td>
<p>Optional vector of two values indicating minimum and maximum values possible for the response.</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'># simulate data from a 2 compartment model with multiplicative error
dose &lt;- inf_manual(inf_tms = c(0,0.5,4,4.5,10), inf_rate = c(100,0,80,0,0))
my_mod &lt;- pkmod(pars_pk = c(CL = 10, V1 = 10, Q2 = 4, V2 = 30))
inf &lt;- inf_tci(my_mod, target_vals = c(2,3,4,4), target_tms = c(0,2,3,10), "plasma")
simulate(my_mod, nsim = 3, inf = inf, tms = c(1,2,4,6,10), sigma_mult = 0.2)
# simulate with PD model
my_mod_pd &lt;- pkmod(pars_pk = c(v1 = 8.995, v2 = 17.297, v3 = 120.963, cl = 1.382,
q2 = 0.919, q3 = 0.609, ke0 = 1.289),
pars_pd = c(c50 = 2.8, gamma = 1.47, gamma2 = 1.89, e0 = 93, emx = 93),
pdfn = emax, pdinv = emax_inv, ecmpt = 4)
simulate(my_mod_pd, inf = dose, tms = c(1.5,2.5,3))
</code></pre>

<hr>
<h2 id='simulate.poppkmod'>Summary method for 'poppkmod' objects</h2><span id='topic+simulate.poppkmod'></span>

<h3>Description</h3>

<p>Summarize parameter distribution
Simulate method for poppkmod objects
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'poppkmod'
simulate(
  object,
  nsim = 1,
  seed = NULL,
  ...,
  inf,
  tms,
  obs_cmpt = 1,
  resp_bounds = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="simulate.poppkmod_+3A_object">object</code></td>
<td>
<p>An object with class &quot;poppkmod&quot; generated by 'poppkmod'</p>
</td></tr>
<tr><td><code id="simulate.poppkmod_+3A_nsim">nsim</code></td>
<td>
<p>Number of observations to simulate at each time point. Defaults to 1.</p>
</td></tr>
<tr><td><code id="simulate.poppkmod_+3A_seed">seed</code></td>
<td>
<p>An integer used to initialize the random number generator.</p>
</td></tr>
<tr><td><code id="simulate.poppkmod_+3A_...">...</code></td>
<td>
<p>Arguments passed to 'update.pkmod'.</p>
</td></tr>
<tr><td><code id="simulate.poppkmod_+3A_inf">inf</code></td>
<td>
<p>A matrix of infusion rates with columns 'begin', 'end', and 'inf_rate'. This
can be created manually, by 'inf_manual', or by 'inf_tci'.</p>
</td></tr>
<tr><td><code id="simulate.poppkmod_+3A_tms">tms</code></td>
<td>
<p>Times at which to simulate observations.</p>
</td></tr>
<tr><td><code id="simulate.poppkmod_+3A_obs_cmpt">obs_cmpt</code></td>
<td>
<p>Integer value indicating compartment in which observations are taken.
Overridden if a PD model is included.</p>
</td></tr>
<tr><td><code id="simulate.poppkmod_+3A_resp_bounds">resp_bounds</code></td>
<td>
<p>Optional vector of two values indicating minimum and maximum values possible for the response.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Simulate observations from a poppkmod object
</p>


<h3>Examples</h3>

<pre><code class='language-R'># simulate data from a 2 compartment model with multiplicative error
dose &lt;- inf_manual(inf_tms = c(0,0.5,4,4.5,10), inf_rate = c(100,0,80,0,0))
# poppkmod object
data &lt;- data.frame(ID = 1:5, AGE = seq(20,60,by=10), TBW = seq(60,80,by=5),
 HGT = seq(150,190,by=10), MALE = c(TRUE,TRUE,FALSE,FALSE,FALSE))
elvd_mod &lt;- poppkmod(data, drug = "ppf", model = "eleveld")
inf &lt;- inf_tci(elvd_mod, target_vals = c(2,3,4,4), target_tms = c(0,2,3,10), "plasma")
simulate(elvd_mod, nsim = 3, inf = inf, tms = c(1,2,4,6,10))
</code></pre>

<hr>
<h2 id='tci_documentation'>tci_documentation</h2><span id='topic+tci_documentation'></span>

<h3>Description</h3>

<p>Functions to implement target-controlled infusion algorithms
</p>


<h3>Details</h3>

<p>tci package documentation
</p>
<p>This package contains functions to implement target-controlled
infusion (TCI) algorithms for compartmental PK models under intravenous administration.
TCI algorithms for plasma or effect-site targeting are included and can be
extended to pharmacodynamic responses. Custom PK-PD models and custom TCI
algorithms can be specified. Functions are provided to simulate responses from
PK/PK-PD models under open- or closed-loop control.
</p>

<hr>
<h2 id='tci_effect'>Effect-site TCI algorithm with plasma targeting within small range of target</h2><span id='topic+tci_effect'></span>

<h3>Description</h3>

<p>Modified effect-site TCI algorithm that switches to plasma-targeting when the
plasma concentration is within 20%
of the target and the effect-site concentration is within 0.5% of the target.
The modification decreases computation time and prevents oscillatory behavior
in the effect-site concentrations.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>tci_effect(Ct, pkmod, dtm = 1/6, cptol = 0.2, cetol = 0.05, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="tci_effect_+3A_ct">Ct</code></td>
<td>
<p>Numeric vector of target effect-site concentrations.</p>
</td></tr>
<tr><td><code id="tci_effect_+3A_pkmod">pkmod</code></td>
<td>
<p>PK model</p>
</td></tr>
<tr><td><code id="tci_effect_+3A_dtm">dtm</code></td>
<td>
<p>TCI update frequency. Defaults to 1/6, corresponding to 10-second
intervals if model parameters are in terms of minutes.</p>
</td></tr>
<tr><td><code id="tci_effect_+3A_cptol">cptol</code></td>
<td>
<p>Percentage of plasma concentration required to be within to switch
to plasma targeting.</p>
</td></tr>
<tr><td><code id="tci_effect_+3A_cetol">cetol</code></td>
<td>
<p>Percentage of effect-site concentration required to be within to switch
to plasma targeting.</p>
</td></tr>
<tr><td><code id="tci_effect_+3A_...">...</code></td>
<td>
<p>Arguments passed on to 'tci_plasma' and 'tci_effect_only' functions, including
to update.pkmod.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric value
</p>


<h3>Examples</h3>

<pre><code class='language-R'>my_mod &lt;- pkmod(pars_pk = c(v1 = 8.995, v2 = 17.297, v3 = 120.963, cl = 1.382,
q2 = 0.919, q3 = 0.609, ke0 = 1.289))
tci_effect(Ct = 2, pkmod = my_mod)
# update parameters
tci_effect(Ct = 2, pkmod = my_mod, pars_pk = c(v1 = 12, cl = 2))
</code></pre>

<hr>
<h2 id='tci_effect_only'>TCI algorithm for effect-site targeting</h2><span id='topic+tci_effect_only'></span>

<h3>Description</h3>

<p>Function for calculating a TCI infusion schedule corresponding to a set of target concentrations.
This function makes use of formulas described by Shafer and Gregg (1992) in &quot;Algorithms to rapidly achieve
and maintain stable drug concentrations at the site of drug effect with a computer-controlled infusion pump&quot;
</p>


<h3>Usage</h3>

<pre><code class='language-R'>tci_effect_only(
  Ct,
  pkmod,
  dtm = 1/6,
  tmax_search = 10,
  maxrt = 1200,
  grid_len = 1200,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="tci_effect_only_+3A_ct">Ct</code></td>
<td>
<p>Numeric vector of target effect-site concentrations.</p>
</td></tr>
<tr><td><code id="tci_effect_only_+3A_pkmod">pkmod</code></td>
<td>
<p>PK model</p>
</td></tr>
<tr><td><code id="tci_effect_only_+3A_dtm">dtm</code></td>
<td>
<p>Frequency of TCI updates. Default is 1/6 minutes = 10 seconds.</p>
</td></tr>
<tr><td><code id="tci_effect_only_+3A_tmax_search">tmax_search</code></td>
<td>
<p>Outer bound on times searched to find a maximum concentration
following an infusion of duration dtm. Defaults to 20 minutes. May need to be increased
if a drug has a slow elimination rate.</p>
</td></tr>
<tr><td><code id="tci_effect_only_+3A_maxrt">maxrt</code></td>
<td>
<p>Maximum infusion rate of TCI pump. Defaults to 1200.</p>
</td></tr>
<tr><td><code id="tci_effect_only_+3A_grid_len">grid_len</code></td>
<td>
<p>Number of time points used to identify time of maximum concentration.
Can be increased for more precision.</p>
</td></tr>
<tr><td><code id="tci_effect_only_+3A_...">...</code></td>
<td>
<p>List or vector of named values to be passed on to update.pkmod.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric value
</p>


<h3>Examples</h3>

<pre><code class='language-R'># three compartment model with effect site
my_mod &lt;- pkmod(pars_pk = c(v1 = 8.995, v2 = 17.297, v3 = 120.963,
cl = 1.382, q2 = 0.919, q3 = 0.609, ke0 = 1.289))
tci_effect_only(Ct = 2, pkmod = my_mod)
# update parameters
tci_effect_only(Ct = 2, pkmod = my_mod, pars_pk = c(v1 = 12, cl = 2))
</code></pre>

<hr>
<h2 id='tci_plasma'>TCI algorithm for plasma targeting</h2><span id='topic+tci_plasma'></span>

<h3>Description</h3>

<p>TCI algorithm based on the algorithm described by Jacobs (1990).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>tci_plasma(Ct, pkmod, dtm = 1/6, maxrt = 1200, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="tci_plasma_+3A_ct">Ct</code></td>
<td>
<p>Target plasma concentration</p>
</td></tr>
<tr><td><code id="tci_plasma_+3A_pkmod">pkmod</code></td>
<td>
<p>PK model</p>
</td></tr>
<tr><td><code id="tci_plasma_+3A_dtm">dtm</code></td>
<td>
<p>Duration of the infusion</p>
</td></tr>
<tr><td><code id="tci_plasma_+3A_maxrt">maxrt</code></td>
<td>
<p>Maximum infusion rate. Defaults to 200 ml/min in reference to the
maximum infusion rate of 1200 ml/h permitted by
existing TCI pumps (e.g. Anestfusor TCI program).</p>
</td></tr>
<tr><td><code id="tci_plasma_+3A_...">...</code></td>
<td>
<p>Arguments passed on to update.pkmod.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Numeric value
</p>


<h3>Examples</h3>

<pre><code class='language-R'># plasma targeting
my_mod &lt;- pkmod(pars_pk = c(CL = 10, V1 = 10))
tci_plasma(Ct = 2, my_mod)
# update CL parameter
tci_plasma(Ct = 2, my_mod, pars_pk = c(CL = 15))
</code></pre>

<hr>
<h2 id='update.pkmod'>Update method for pkmod</h2><span id='topic+update.pkmod'></span>

<h3>Description</h3>

<p>Update parameters or initial values of a pkmod object
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'pkmod'
update(object, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="update.pkmod_+3A_object">object</code></td>
<td>
<p>Object with class pkmod</p>
</td></tr>
<tr><td><code id="update.pkmod_+3A_...">...</code></td>
<td>
<p>Updated values passed to object.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns the pkmod object with elements replaced
</p>


<h3>Examples</h3>

<pre><code class='language-R'># initial pkmod object
(my_mod &lt;- pkmod(pars_pk = c(CL = 10, V1 = 10)))
# update a subset of parameters and initial values
update(my_mod, pars_pk = c(CL = 20, V1 = 2), init = 3, sigma_add = 1, log_response = TRUE)
</code></pre>

<hr>
<h2 id='validate_pkmod'>pkmod validation checks</h2><span id='topic+validate_pkmod'></span>

<h3>Description</h3>

<p>Function to provide validation checks for a pkmod object
</p>


<h3>Usage</h3>

<pre><code class='language-R'>validate_pkmod(x)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="validate_pkmod_+3A_x">x</code></td>
<td>
<p>Object of class &quot;pkmod&quot;</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns a list with class &quot;pkmod&quot; if validation checks are passed. Returns an error if not.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>validate_pkmod(init_pkmod(pars_pk = c(CL = 10, V1 = 10,Q2 = 4,V2=20)))
</code></pre>

<hr>
<h2 id='validate_poppkmod'>Perform validation checks on a 'poppkmod' object</h2><span id='topic+validate_poppkmod'></span>

<h3>Description</h3>

<p>Perform validation checks on a 'poppkmod' object created by 'init_poppkmod'.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>validate_poppkmod(x)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="validate_poppkmod_+3A_x">x</code></td>
<td>
<p>Object with class &quot;poppkmod&quot; created by init_poppkmod</p>
</td></tr>
</table>


<h3>Value</h3>

<p>'poppkmod' object or error
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data &lt;- data.frame(ID = 1:5, AGE = seq(20,60,by=10), TBW = seq(60,80,by=5),
HGT = seq(150,190,by=10), MALE = c(TRUE,TRUE,FALSE,FALSE,FALSE))
validate_poppkmod(init_poppkmod(data, drug = "ppf", model = "eleveld"))
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
