<!DOCTYPE html><html lang="en"><head><title>Help for package ukbnmr</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {ukbnmr}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#ukbnmr'><p>Tools for processing the UK Biobank NMR metabolomics biomarker data</p></a></li>
<li><a href='#compute_extended_ratio_qc_flags'><p>Aggregate QC Flags when computing the extended set of biomarker ratios</p></a></li>
<li><a href='#compute_extended_ratios'><p>Compute extended set of biomarker ratios</p></a></li>
<li><a href='#extract_biomarker_qc_flags'><p>Extract NMR biomarker QC flags from a data.frame of UK Biobank fields</p></a></li>
<li><a href='#extract_biomarkers'><p>Extract NMR metabolomic biomarkers from a data.frame of UK Biobank fields</p></a></li>
<li><a href='#extract_sample_qc_flags'><p>Extract NMR sample QC flags from a data.frame of UK Biobank fields</p></a></li>
<li><a href='#nmr_info'><p>Nightingale biomarker information</p></a></li>
<li><a href='#recompute_derived_biomarker_qc_flags'><p>Aggregate QC Flags when recomputing all composite and derived biomarkers</p></a></li>
<li><a href='#recompute_derived_biomarkers'><p>Recompute composite biomarkers and ratios from the 107 non-derived biomarkers</p></a></li>
<li><a href='#remove_technical_variation'><p>Remove technical variation from NMR biomarker data in UK Biobank.</p></a></li>
<li><a href='#sample_qc_info'><p>Nightingale biomarker sample processing information</p></a></li>
<li><a href='#test_data'><p>Data for testing package functions</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Removal of Unwanted Technical Variation from UK Biobank NMR
Metabolomics Biomarker Data</td>
</tr>
<tr>
<td>Version:</td>
<td>3.2.0</td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/sritchie73/ukbnmr/issues">https://github.com/sritchie73/ukbnmr/issues</a></td>
</tr>
<tr>
<td>Description:</td>
<td>A suite of utilities for working with the UK Biobank 
    <a href="https://www.ukbiobank.ac.uk/">https://www.ukbiobank.ac.uk/</a> Nuclear Magnetic Resonance spectroscopy (NMR) 
    metabolomics data <a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=220">https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=220</a>. 
    Includes functions for extracting biomarkers from decoded UK Biobank field 
    data, removing unwanted technical variation from biomarker concentrations,
    computing an extended set of lipid, fatty acid, and cholesterol fractions, 
    and for re-deriving composite biomarkers and ratios after adjusting data 
    for unwanted biological variation. For further details on methods see
    Ritchie SC et al. Sci Data (2023) &lt;<a href="https://doi.org/10.1038%2Fs41597-023-01949-y">doi:10.1038/s41597-023-01949-y</a>&gt;.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file LICENSE</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>LazyData:</td>
<td>true</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 2.10)</td>
</tr>
<tr>
<td>Imports:</td>
<td>data.table, bit64, lubridate, MASS</td>
</tr>
<tr>
<td>Suggests:</td>
<td>knitr, rmarkdown, roxygen2</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.3.2</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2024-11-14 18:34:49 UTC; scritchie</td>
</tr>
<tr>
<td>Author:</td>
<td>Scott C Ritchie [aut, cre] (0000-0002-8454-9548)</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Scott C Ritchie &lt;sritchie73@gmail.com&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2024-11-14 19:00:03 UTC</td>
</tr>
</table>
<hr>
<h2 id='ukbnmr'>Tools for processing the UK Biobank NMR metabolomics biomarker data</h2><span id='topic+ukbnmr-package'></span><span id='topic+ukbnmr'></span>

<h3>Description</h3>

<p>@description
This package provides utilities for working with the
<a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=220">UK Biobank MR metabolomics data</a>.
Details are provided below, and in the package vignette (type <code>vignette("ukbnmr")</code> to view).
</p>


<h3>Details</h3>

<p>There are three groups of functions in this package: (1) data extraction,
(2) removal of technical variation, and (3) recomputing derived biomarkers
and biomarker ratios.
</p>
<p>All functions can be applied directly to raw data extracted from UK Biobank.
</p>
<p>This package also provides a <code>data.frame</code> of biomarker information, loaded
as <code><a href="#topic+nmr_info">nmr_info</a></code>, and <code>data.frame</code> of sample processing information,
loaded as <code><a href="#topic+sample_qc_info">sample_qc_info</a></code>.
</p>


<h3>Data Extraction Functions</h3>

<p>The <code><a href="#topic+extract_biomarkers">extract_biomarkers</a>()</code> function will take a phenotype dataset extracted on
the UK Biobank Research Analysis Platform by the Table Exporter tool, extract the
<a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=220">NMR biomarker fields</a>
and give them short comprehensible column names as described in <code><a href="#topic+nmr_info">nmr_info</a></code>.
Measurements are also split into multiple rows where a participant has measurements
at both baseline and first repeat assessment.
</p>
<p>The <code><a href="#topic+extract_biomarker_qc_flags">extract_biomarker_qc_flags</a>()</code> function will take a phenotype
dataset extracted on the UK Biobank Research Analysis Platform by the Table
Exporter tool, extract the <a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=221">Nightingale quality control flags</a>
for each biomarker measurement, returning a single column per biomarker
(corresponding to respective columns output by <code><a href="#topic+extract_biomarkers">extract_biomarkers</a>()</code>).
</p>
<p>The <code><a href="#topic+extract_sample_qc_flags">extract_sample_qc_flags</a>()</code> function will take a phenotype
dataset extracted on the UK Biobank Research Analysis Platform by the Table
Exporter tool and extract the <a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=222">sample quality control tags</a>
for the Nightingale NMR metabolomics data.
</p>
<p>These functions will also work with older datasets predating the UK Biobank
Research Analysis Platform, e.g. those extracted by <a href="https://biobank.ctsu.ox.ac.uk/crystal/exinfo.cgi?src=accessing_data_guide">ukbconv</a>,
and/or by the ukbtools R package.
</p>


<h3>Removal of technical variation</h3>

<p>The <code><a href="#topic+remove_technical_variation">remove_technical_variation</a>()</code> function  will take a phenotype
dataset extracted on the UK Biobank Research Analysis Platform by the Table
Exporter tool, extract all the biomarkers and QC flags, remove the effects of
technical variation on biomarker concentrations, and return a list
containing the adjusted NMR biomarker data, biomarker QC flags, and sample quality control
and processing information.
</p>
<p>This applies a multistep process as described in Ritchie <em>et al.</em> 2023:
</p>

<ol>
<li><p>First biomarker data is filtered to the 107 biomarkers that
cannot be derived from any combination of other biomarkers.
</p>
</li>
<li><p>Absolute concentrations are log transformed, with a small offset
applied to biomarkers with concentrations of 0.
</p>
</li>
<li><p>Each biomarker is adjusted for the time between sample preparation
and sample measurement (hours) on a log scale.
</p>
</li>
<li><p>Each biomarker is adjusted for systematic differences between rows
(A-H) on the 96-well shipment plates.
</p>
</li>
<li><p>Each biomarker is adjusted for remaining systematic differences
between columns (1-12) on the 96-well shipment plates.
</p>
</li>
<li><p>Each biomarker is adjusted for drift over time within each of the six
spectrometers. To do so, samples are grouped into 10 bins, within each
spectrometer, by the date the majority of samples on their respective
96-well plates were measured.
</p>
</li>
<li><p>Regression residuals after the sequential adjustments are
transformed back to absolute concentrations.
</p>
</li>
<li><p>Samples belonging to shipment plates that are outliers of
non-biological origin are identified and set to missing.
</p>
</li>
<li><p>The 61 composite biomarkers and 81 biomarker ratios are recomputed
from their adjusted parts.
</p>
</li>
<li><p>An additional 76 biomarker ratios of potential biological
significance are computed.
</p>
</li></ol>

<p>Further details can be found in Ritchie S. C. <em>et al.</em> Quality control
and removal of technical variation of NMR metabolic biomarker data in
~120,000 UK Biobank participants, <em>Sci Data</em> <strong>10</strong>, 64 (2023). doi:
<a href="https://www.nature.com/articles/s41597-023-01949-y">10.1038/s41597-023-01949-y</a>
</p>


<h3>Methods for computing biomarker ratios</h3>

<p>The <code><a href="#topic+compute_extended_ratios">compute_extended_ratios</a>()</code> function will compute an extended
set of biomarker ratios expanding on the biomarkers available directly from
the Nightingale platform. A companion function, <code><a href="#topic+compute_extended_ratio_qc_flags">compute_extended_ratio_qc_flags</a>()</code>,
will aggregate the QC flags for the biomarkers underlying each ratio.
</p>
<p>The <code><a href="#topic+recompute_derived_biomarkers">recompute_derived_biomarkers</a>()</code> function will recompute all
composite biomarkers and ratios from 107 non-derived biomarkers, which is
useful for ensuring data consistency when adjusting for unwanted biological
variation. This includes the extended biomarker rations computed by the
<code><a href="#topic+compute_extended_ratios">compute_extended_ratios</a>()</code> function. A companion function,
<code><a href="#topic+recompute_derived_biomarker_qc_flags">recompute_derived_biomarker_qc_flags</a>()</code> will aggregate the QC
flags for the biomarkers underlying each composite biomarker and ratio.
</p>


<h3>Author(s)</h3>

<p><strong>Maintainer</strong>: Scott C Ritchie <a href="mailto:sritchie73@gmail.com">sritchie73@gmail.com</a> (0000-0002-8454-9548)
</p>


<h3>See Also</h3>

<p>Useful links:
</p>

<ul>
<li><p> Report bugs at <a href="https://github.com/sritchie73/ukbnmr/issues">https://github.com/sritchie73/ukbnmr/issues</a>
</p>
</li></ul>


<hr>
<h2 id='compute_extended_ratio_qc_flags'>Aggregate QC Flags when computing the extended set of biomarker ratios</h2><span id='topic+compute_extended_ratio_qc_flags'></span>

<h3>Description</h3>

<p>For the 76 biomarker ratios computed by <code><a href="#topic+compute_extended_ratios">compute_extended_ratios</a>()</code>,
aggregates the biomarker QC flags from the biomarkers composing each ratio
(see <code><a href="#topic+nmr_info">nmr_info</a></code>), which can be useful for determining the reason
underlying missing values in the biomarker ratios.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>compute_extended_ratio_qc_flags(x)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="compute_extended_ratio_qc_flags_+3A_x">x</code></td>
<td>
<p><code>data.frame</code> containing NMR metabolomics data from UK Biobank.
May either be raw field data output by
<a href="https://biobank.ctsu.ox.ac.uk/crystal/exinfo.cgi?src=accessing_data_guide">ukbconv</a>
or data with column names corresponding to biomarkers listed in <code><a href="#topic+nmr_info">nmr_info</a></code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>If your UK Biobank project only has access to a subset of biomarkers, then
this function will only return the subset of ratios that can be computed from
the biomarker data provided.
</p>
<p>Biomarker QC Flags in the input data are also returned alongside those
aggregated by this function for the computed biomarker ratios.
</p>


<h3>Value</h3>

<p>a <code>data.frame</code> with QC flags aggregated for all computed
biomarker ratios.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+nmr_info">nmr_info</a></code> for list of computed biomarker ratios and
<code><a href="#topic+extract_biomarkers">extract_biomarkers</a>()</code> for details on how raw data from
<a href="https://biobank.ctsu.ox.ac.uk/crystal/exinfo.cgi?src=accessing_data_guide">ukbconv</a>
is processed.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ukb_data &lt;- ukbnmr::test_data # Toy example dataset for testing package
biomarker_qc_flags &lt;- compute_extended_ratio_qc_flags(ukb_data)

</code></pre>

<hr>
<h2 id='compute_extended_ratios'>Compute extended set of biomarker ratios</h2><span id='topic+compute_extended_ratios'></span>

<h3>Description</h3>

<p>Computes 76 additional ratios not provided by the Nightingale platform. These
include lipid fractions in HDL, LDL, VLDL, and total serum, as well as
cholesterol fractions, and omega to polyunsaturated fatty acid ratios. See
<code><a href="#topic+nmr_info">nmr_info</a></code> for details.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>compute_extended_ratios(x)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="compute_extended_ratios_+3A_x">x</code></td>
<td>
<p><code>data.frame</code> containing NMR metabolomics data from UK Biobank.
May either be raw field data output by
<a href="https://biobank.ctsu.ox.ac.uk/crystal/exinfo.cgi?src=accessing_data_guide">ukbconv</a>
or data with column names corresponding to biomarkers listed in <code><a href="#topic+nmr_info">nmr_info</a></code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>If your UK Biobank project only has access to a subset of biomarkers, then
this function will only return the subset of ratios that can be computed from
the biomarker data provided.
</p>
<p>All biomarkers in the input data are also returned alongside the ratios computed
by this function.
</p>


<h3>Value</h3>

<p>a <code>data.frame</code> with the additional computed biomarker ratios.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+nmr_info">nmr_info</a></code> for list of computed biomarker ratios,
<code><a href="#topic+compute_extended_ratio_qc_flags">compute_extended_ratio_qc_flags</a>()</code> for obtaining an
aggregate of the biomarker QC flags from the biomarkers underlying each
computed ratio, and <code><a href="#topic+extract_biomarkers">extract_biomarkers</a>()</code> for details on how
raw data from
<a href="https://biobank.ctsu.ox.ac.uk/crystal/exinfo.cgi?src=accessing_data_guide">ukbconv</a>
is processed.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ukb_data &lt;- ukbnmr::test_data # Toy example dataset for testing package
nmr &lt;- compute_extended_ratios(ukb_data)

</code></pre>

<hr>
<h2 id='extract_biomarker_qc_flags'>Extract NMR biomarker QC flags from a data.frame of UK Biobank fields</h2><span id='topic+extract_biomarker_qc_flags'></span>

<h3>Description</h3>

<p>Given an input <code>data.frame</code> loaded from a dasaset of
<a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=221">NMR metabolomics QC indicator fields</a>
extracted by the Table Exporter tool on the
<a href="https://ukbiobank.dnanexus.com/landing">UK Biobank Research Analysis Platform</a>,
this function extracts the
<a href="https://biobank.ndph.ox.ac.uk/showcase/showcase/docs/nmrm_app4.pdf">quality control (QC) flags for the NMR metaolomics biomarkers</a>
giving them short variable names as listed in the <code><a href="#topic+nmr_info">nmr_info</a></code> information data sheet
available in this package. QC Flags are separated by &quot;; &quot; in each column where
there are multiple QC Flags for a single measurement.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>extract_biomarker_qc_flags(x)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="extract_biomarker_qc_flags_+3A_x">x</code></td>
<td>
<p><code>data.frame</code> with column names &quot;eid&quot; followed by extracted
fields e.g. &quot;p23774_i0_a0&quot;, ... &quot;p23774_i1_a0&quot;, ..., &quot;p23767_i1&quot;.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>#' Data sets extracted on the <a href="https://ukbiobank.dnanexus.com/landing">UK Biobank Research Analysis Platform</a>
have one row per UK Biobank participant, whose project specific sample
identifier is given in the first column named &quot;eid&quot;. Columns following this
follow a <a href="https://dnanexus.gitbook.io/uk-biobank-rap/working-on-the-research-analysis-platform/accessing-data/accessing-phenotypic-data#database-columns">naming scheme</a>
based on the unique identifier of each field, assessment visit, and (optionally if relevant)
repeated measurement of &quot;p&lt;field_id&gt;_i&lt;visit_index&gt;_a&lt;repeat_index&gt;&quot;. For example,
the QC flags for the measurement of 3-Hydroxybutyrate at baseline assessment
has the column names &quot;p23774_i0_a0&quot;, &quot;p23774_i0_a1&quot;, and &quot;p23774_i0_a2&quot;; indicating
that the 3-Hydroxybutyrate measurement can have up to three QC flags per
sample at baseline assessment. Measurements for blood samples collected at the
first repeat assessment have 1 in the visit index, e.g. for 3-Hydroxybutyrate
at the first repeat assessment there are three columns &quot;p23774_i1_a0&quot;,
&quot;p23774_i1_a1&quot;, &quot;p23774_i1_a2&quot;.
</p>
<p>The <code>data.frame</code> returned by this function gives each field a unique
recognizable name, with measurements from baseline and repeat assessment
given in separate rows. The &quot;visit_index&quot; column immediately after the &quot;eid&quot;
column indicates whether the biomarker measurement was quantified from the
blood samples taken at baseline assessment (visit_index == 0) or first repeat
assessment (visit_index == 1). Where multiple QC flags were present at the
same measurement, these are collated into a single entry with the multiple QC
flags separated by a &quot;; &quot;. Rows are uniquely identifiable by the combination
of entries in columns &quot;eid&quot; and &quot;visit_index&quot;.
</p>
<p>This function will also work with data predating the Research Analysis Platform,
including data sets extracted by the <a href="https://biobank.ctsu.ox.ac.uk/crystal/exinfo.cgi?src=accessing_data_guide">ukbconv</a>
tool and/or the <code>ukbtools</code> R package.
</p>
<p>If your UK Biobank project only has access to a subset of biomarkers, then
this function will only return the subset of ratios that can be computed from
the biomarker data provided.
</p>
<p>A <code>data.table</code> will be returned instead of a <code>data.frame</code> if the
the user has loaded the package into their R session.
</p>


<h3>Value</h3>

<p>a <code>data.frame</code> or <code>data.table</code> with column names &quot;eid&quot;,
and &quot;visit_index&quot; followed by columns for each biomarker
e.g. &quot;bOHbutyrate&quot;, ..., &quot;Valine&quot;.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ukb_data &lt;- ukbnmr::test_data # Toy example dataset for testing package
biomarker_qc_flags &lt;- extract_biomarker_qc_flags(ukb_data)

</code></pre>

<hr>
<h2 id='extract_biomarkers'>Extract NMR metabolomic biomarkers from a data.frame of UK Biobank fields</h2><span id='topic+extract_biomarkers'></span>

<h3>Description</h3>

<p>Given an input <code>data.frame</code> loaded from a dasaset of
<a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=220">NMR metabolomics fields</a>
extracted by the Table Exporter tool on the
<a href="https://ukbiobank.dnanexus.com/landing">UK Biobank Research Analysis Platform</a>,
this function extracts the NMR metabolomics biomarkers giving them short variable
names as listed in the <code><a href="#topic+nmr_info">nmr_info</a></code> information data sheet
available in this package.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>extract_biomarkers(x)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="extract_biomarkers_+3A_x">x</code></td>
<td>
<p><code>data.frame</code> with column names &quot;eid&quot; followed by extracted
fields e.g. &quot;p23474_i0&quot;, &quot;p23474_i1&quot;, ..., &quot;p23467_i1&quot;.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Data sets extracted on the <a href="https://ukbiobank.dnanexus.com/landing">UK Biobank Research Analysis Platform</a>
have one row per UK Biobank participant, whose project specific sample
identifier is given in the first column named &quot;eid&quot;. Columns following this
follow a <a href="https://dnanexus.gitbook.io/uk-biobank-rap/working-on-the-research-analysis-platform/accessing-data/accessing-phenotypic-data#database-columns">naming scheme</a>
based on the unique identifier of each field, assessment visit, and (optionally if relevant)
repeated measurement of &quot;p&lt;field_id&gt;_i&lt;visit_index&gt;_a&lt;repeat_index&gt;&quot;. For example,
the measurement of 3-Hydroxybutyrate at baseline assessment has the column name
&quot;p23474_i0&quot;. For the UKB NMR data, measurements are available at baseline assessment
and the first repeat assessment (e.g. &quot;p23474_i1&quot;). For the UKB NMR data, the
&lt;repeat_index&gt; is reserved for cases where biomarker measurements have more than
one QC Flag (see <code><a href="#topic+extract_biomarker_qc_flags">extract_biomarker_qc_flags</a>()</code>).
</p>
<p>The <code>data.frame</code> returned by this function gives each field a unique
recognizable name, with measurements from baseline and repeat assessment
given in separate rows. The &quot;visit_index&quot; column immediately after the &quot;eid&quot;
column indicates whether the biomarker measurement was quantified from the
blood samples taken at baseline assessment (visit_index == 0) or first repeat
assessment (visit_index == 1). Rows are uniquely identifiable
by the combination of entries in columns &quot;eid&quot; and &quot;visit_index&quot;.
</p>
<p>This function will also work with data predating the Research Analysis Platform,
including data sets extracted by the <a href="https://biobank.ctsu.ox.ac.uk/crystal/exinfo.cgi?src=accessing_data_guide">ukbconv</a>
tool and/or the <code>ukbtools</code> R package.
</p>
<p>If your UK Biobank project only has access to a subset of biomarkers, then
this function will only return the subset of ratios that can be computed from
the biomarker data provided.
</p>
<p>A <code>data.table</code> will be returned instead of a <code>data.frame</code> if the
the user has loaded the package into their R session.
</p>


<h3>Value</h3>

<p>a <code>data.frame</code> or <code>data.table</code> with column names &quot;eid&quot;,
and &quot;visit_index&quot;, followed by columns for each biomarker
e.g. &quot;bOHbutyrate&quot;, ..., &quot;Valine&quot;.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ukb_data &lt;- ukbnmr::test_data # Toy example dataset for testing package
nmr &lt;- extract_biomarkers(ukb_data)

</code></pre>

<hr>
<h2 id='extract_sample_qc_flags'>Extract NMR sample QC flags from a data.frame of UK Biobank fields</h2><span id='topic+extract_sample_qc_flags'></span>

<h3>Description</h3>

<p>Given an input <code>data.frame</code> loaded from a dasaset of
<a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=222">NMR metabolomics processing fields</a>
extracted by the Table Exporter tool on the
<a href="https://ukbiobank.dnanexus.com/landing">UK Biobank Research Analysis Platform</a>, this function
extracts the
<a href="https://biobank.ndph.ox.ac.uk/showcase/showcase/docs/nmrm_app4.pdf">sample quality control flags for the NMR metabolomics biomarker data</a> giving them short variable names as listed in the
<code><a href="#topic+sample_qc_info">sample_qc_info</a></code> information data sheet available in this package.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>extract_sample_qc_flags(x)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="extract_sample_qc_flags_+3A_x">x</code></td>
<td>
<p><code>data.frame</code> with column names &quot;eid&quot; followed by extracted
fields e.g. &quot;p23649_i0&quot;, &quot;p23649_i1&quot;, ..., &quot;p23655_i1&quot;.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Data sets extracted on the <a href="https://ukbiobank.dnanexus.com/landing">UK Biobank Research Analysis Platform</a>
have one row per UK Biobank participant, whose project specific sample
identifier is given in the first column named &quot;eid&quot;. Columns following this
follow a <a href="https://dnanexus.gitbook.io/uk-biobank-rap/working-on-the-research-analysis-platform/accessing-data/accessing-phenotypic-data#database-columns">naming scheme</a>
based on the unique identifier of each field, assessment visit, and (optionally if relevant)
repeated measurement of &quot;p&lt;field_id&gt;_i&lt;visit_index&gt;_a&lt;repeat_index&gt;&quot;. For example,
the Shipment Plate for each sample collected at baseline assessment has the
column name &quot;p23649_i0&quot;. For the UKB NMR data, measurements are available at
baseline assessment and the first repeat assessment (e.g. &quot;p23649_i1&quot;). For the
UKB NMR data, the &lt;repeat_index&gt; is reserved for cases where biomarker
measurements have more than one QC Flag (see <code><a href="#topic+extract_biomarker_qc_flags">extract_biomarker_qc_flags</a>()</code>).
</p>
<p>The <code>data.frame</code> returned by this function gives each field a unique
recognizable name, with measurements from baseline and repeat assessment
given in separate rows. The &quot;visit_index&quot; column immediately after the &quot;eid&quot;
column indicates whether the biomarker measurement was quantified from the
blood samples taken at baseline assessment (visit_index == 0) or first repeat
assessment (visit_index == 1). Rows are uniquely identifiable
by the combination of entries in columns &quot;eid&quot; and &quot;visit_index&quot;.
</p>
<p>This function will also work with data predating the Research Analysis Platform,
including data sets extracted by the <a href="https://biobank.ctsu.ox.ac.uk/crystal/exinfo.cgi?src=accessing_data_guide">ukbconv</a>
tool and/or the <code>ukbtools</code> R package.
</p>
<p>If your UK Biobank project only has access to a subset of biomarkers, then
this function will only return the subset of ratios that can be computed from
the biomarker data provided.
</p>
<p>A <code>data.table</code> will be returned instead of a <code>data.frame</code> if the
the user has loaded the package into their R session.
</p>


<h3>Value</h3>

<p>a <code>data.frame</code> or <code>data.table</code> with column names &quot;eid&quot;
and &quot;visit_index&quot;, followed by columns for each sample
QC tag, e.g. &quot;Shipment.Plate&quot;, ..., &quot;Low.Protein&quot;.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ukb_data &lt;- ukbnmr::test_data # Toy example dataset for testing package
sample_qc_flags &lt;- extract_sample_qc_flags(ukb_data)

</code></pre>

<hr>
<h2 id='nmr_info'>Nightingale biomarker information</h2><span id='topic+nmr_info'></span>

<h3>Description</h3>

<p>Contains details on the Nightingale biomarkers available in UK Biobank and
computed by this package.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>nmr_info
</code></pre>


<h3>Format</h3>

<p>A data table with 325 rows and 8 columns:
</p>

<dl>
<dt>Biomarker</dt><dd><p>Short column name assigned to the biomarker</p>
</dd>
<dt>Description</dt><dd><p>Biomarker description, matching the description field provided by UK Biobank and Nightingale Health</p>
</dd>
<dt>Units</dt><dd><p>Units of measurement for the biomarker (&quot;mmol/L&quot;, &quot;g/L&quot;, &quot;nm&quot;, &quot;degree&quot;, &quot;ratio&quot;, or &quot;%&quot;)</p>
</dd>
<dt>Type</dt><dd><p>Biomarker type (&quot;Non-derived&quot;, &quot;Composite&quot;, &quot;Ratio&quot;, or &quot;Percentage&quot;)</p>
</dd>
<dt>Group</dt><dd><p>Biomarker group as provided by Nightingale Health</p>
</dd>
<dt>Sub.Group</dt><dd><p>Biomarker sub-group as provided by Nightingale Health</p>
</dd>
<dt>Nightingale</dt><dd><p>Logical. Indicates biomarker is quantified by the Nightingale Health platform</p>
</dd>
<dt>UKB.Field.ID</dt><dd><p>Field ID in UK Biobank, see <a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=220">https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=220</a></p>
</dd>
<dt>QC.Flag.Field.ID</dt><dd><p>Field ID in UK Biobank for the biomarker QC Flags, see <a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=220">https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=220</a></p>
</dd>
<dt>Full.Formula</dt><dd><p>For composite biomarkers and ratios, details formula through which the biomarker can be derived from the 107 non-derived biomarkers</p>
</dd>
<dt>Simplified.Formula</dt><dd><p>Simplified form of the full formula most clearly expressing how each composite biomarker and ratio can be rederived from other biomarkers</p>
</dd>
</dl>


<hr>
<h2 id='recompute_derived_biomarker_qc_flags'>Aggregate QC Flags when recomputing all composite and derived biomarkers</h2><span id='topic+recompute_derived_biomarker_qc_flags'></span>

<h3>Description</h3>

<p>For the 61 composite biomarkers, 81 Nightingale biomarker ratios, and 76
extended biomarker ratios computed by <code><a href="#topic+recompute_derived_biomarkers">recompute_derived_biomarkers</a>()</code>,
aggregates the biomarker QC flags from the underlying biomarkers
(see <code><a href="#topic+nmr_info">nmr_info</a></code>).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>recompute_derived_biomarker_qc_flags(x)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="recompute_derived_biomarker_qc_flags_+3A_x">x</code></td>
<td>
<p><code>data.frame</code> containing NMR metabolomics data from UK Biobank.
May either be raw field data output by
<a href="https://biobank.ctsu.ox.ac.uk/crystal/exinfo.cgi?src=accessing_data_guide">ukbconv</a>
or data with column names corresponding to biomarkers listed in <code><a href="#topic+nmr_info">nmr_info</a></code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>If your UK Biobank project only has access to a subset of biomarkers, then
this function will only return the subset of ratios that can be computed from
the biomarker data provided.
</p>
<p>Biomarker QC Flags in the input data are also returned alongside those
aggregated by this function for the computed biomarker ratios.
</p>


<h3>Value</h3>

<p>a <code>data.frame</code> with QC flags aggregated for all computed
biomarkers and ratios.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+nmr_info">nmr_info</a></code> for list of computed biomarker ratios and
<code><a href="#topic+extract_biomarkers">extract_biomarkers</a>()</code> for details on how raw data from
<a href="https://biobank.ctsu.ox.ac.uk/crystal/exinfo.cgi?src=accessing_data_guide">ukbconv</a>
is processed.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ukb_data &lt;- ukbnmr::test_data # Toy example dataset for testing package
biomarker_qc_flags &lt;- recompute_derived_biomarker_qc_flags(ukb_data)

</code></pre>

<hr>
<h2 id='recompute_derived_biomarkers'>Recompute composite biomarkers and ratios from the 107 non-derived biomarkers</h2><span id='topic+recompute_derived_biomarkers'></span>

<h3>Description</h3>

<p>When adjusting biomarkers for unwanted biological covariates, it is desirable
to recompute composite biomarkers and ratios to ensure consistency in the
adjusted dataset. This function will compute all composite biomarkers and
ratios from their parts (see <code><a href="#topic+nmr_info">nmr_info</a></code> for biomarker details).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>recompute_derived_biomarkers(x)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="recompute_derived_biomarkers_+3A_x">x</code></td>
<td>
<p><code>data.frame</code> containing NMR metabolomics data from UK Biobank.
May either be raw field data output by
<a href="https://biobank.ctsu.ox.ac.uk/crystal/exinfo.cgi?src=accessing_data_guide">ukbconv</a>
or data with column names corresponding to biomarkers listed in <code><a href="#topic+nmr_info">nmr_info</a></code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>If your UK Biobank project only has access to a subset of biomarkers, then
this function will only return the subset of ratios that can be computed from
the biomarker data provided.
</p>
<p>All biomarkers in the input data are also returned alongside those computed
by this function.
</p>


<h3>Value</h3>

<p>a <code>data.frame</code> with all composite biomarkers and ratios
(re)computed from the 107 non-derived biomarkers (see <code><a href="#topic+nmr_info">nmr_info</a></code>
for details).
</p>


<h3>See Also</h3>

<p><code><a href="#topic+nmr_info">nmr_info</a></code> for list of computed biomarker ratios,
<code><a href="#topic+recompute_derived_biomarker_qc_flags">recompute_derived_biomarker_qc_flags</a>()</code> for obtaining an
aggregate of the biomarker QC flags from the biomarkers underlying each
computed biomarker, and <code><a href="#topic+extract_biomarkers">extract_biomarkers</a>()</code> for details on
how the raw field data extracted by the Table Exporter tool is processed.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ukb_data &lt;- ukbnmr::test_data # Toy example dataset for testing package
bio_qc &lt;- recompute_derived_biomarkers(ukb_data)

</code></pre>

<hr>
<h2 id='remove_technical_variation'>Remove technical variation from NMR biomarker data in UK Biobank.</h2><span id='topic+remove_technical_variation'></span>

<h3>Description</h3>

<p>Remove technical variation from NMR biomarker data in UK Biobank.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>remove_technical_variation(
  x,
  remove.outlier.plates = TRUE,
  skip.biomarker.qc.flags = FALSE,
  version = 3L
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="remove_technical_variation_+3A_x">x</code></td>
<td>
<p><code>data.frame</code> containing a tabular phenotype dataset extracted by the
<a href="https://dnanexus.gitbook.io/uk-biobank-rap/working-on-the-research-analysis-platform/accessing-data/accessing-phenotypic-data#create-a-tsv-or-csv-file-using-table-exporter">Table Exporter</a> tool on the
<a href="https://ukbiobank.dnanexus.com/landing">UK Biobank Research Analysis Platform</a>
containing the project specific sample id (eid) and all fields (and instances)
relating to the NMR metabolomics data (i.e. fields listed in showcase categories
<a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=220">220</a>,
<a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=221">221</a>, and
<a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=222">222</a>.</p>
</td></tr>
<tr><td><code id="remove_technical_variation_+3A_remove.outlier.plates">remove.outlier.plates</code></td>
<td>
<p>logical, when set to <code>FALSE</code> biomarker
concentrations on outlier shipment plates (see details) are not set to
missing but simply flagged in the <code>biomarker_qc_flags</code> <code>data.frame</code>
in the returned <code>list</code>.</p>
</td></tr>
<tr><td><code id="remove_technical_variation_+3A_skip.biomarker.qc.flags">skip.biomarker.qc.flags</code></td>
<td>
<p>logical, when set to <code>TRUE</code> biomarker QC
flags are not processed or returned.</p>
</td></tr>
<tr><td><code id="remove_technical_variation_+3A_version">version</code></td>
<td>
<p>version of the QC algorithm to apply. Defaults to 3, the latest
version of the algorithm (see details).</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Three versions of the QC algorithm have been developed. Version 1 was designed
based on the first phase of data released to the public covering ~120,000
UK Biobank participants. Version 2 made several improvements to the algorithm
based on the subsequent second public release of data covering an additional
~150,000 participants. Version 3, the default, makes some further minor tweaks
primarily so that the algorithm is compatible with the full public data
release covering all ~500,000 participants.
</p>
<p>Details on the impact of these algorithms on technical variation in the latest
UK Biobank data are provided in the package vignette and on the github readme.
</p>
<p>## Version 1
Setting version to 1 applies the algorithm as exactly described in Ritchie S.
C. *et al.* _Sci Data_ 2023. In brief, this multi-step procedure applies the
following steps in sequence:
</p>
<p>1. First biomarker data is filtered to the 107 biomarkers that cannot be
derived from any combination of other biomarkers.
2. Absolute concentrations are log transformed, with a small offset
applied to biomarkers with concentrations of 0.
3. Each biomarker is adjusted for the time between sample preparation
and sample measurement (hours).
4. Each biomarker is adjusted for systematic differences between rows
(A-H) on the 96-well shipment plates.
5. Each biomarker is adjusted for remaining systematic differences
between columns (1-12) on the 96-well shipment plates.
6. Each biomarker is adjusted for drift over time within each of the six
spectrometers. To do so, samples are grouped into 10 bins, within each
spectrometer, by the date the majority of samples on their respective
96-well plates were measured.
7. Regression residuals after the sequential adjustments are
transformed back to absolute concentrations.
8. Samples belonging to shipment plates that are outliers of
non-biological origin are identified and set to missing.
9. The 61 composite biomarkers and 81 biomarker ratios are recomputed
from their adjusted parts.
10. An additional 76 biomarker ratios of potential biological
significance are computed.
</p>
<p>At each step, adjustment for technical covariates is performed using
<a href="MASS.html#topic+rlm">robust linear regression</a>. Plate row, plate column, and
sample measurement date bin are treated as factors, using the group with the
largest sample size as reference in the regression.
</p>
<p>## Version 2
Version 2 of the algorithm modifies the above procedure to (1)
adjust for well and column within each processing batch separately in steps 4
and 5, and (2) in step 6 instead of splitting samples into 10 bins per
spectrometer uses a fixed bin size of approximately 2,000 samples per bin,
ensuring samples measured on the same plate and plates measured on the same
day are grouped into the same bin.
</p>
<p>The first modification was made as applying version 1 of the algorithm to the
combined data from the first and second tranche of measurements revealed
introduced stratification by well position when examining the corrected
concentrations in each data release separately.
</p>
<p>The second modification was made to ensure consistent bin sizes across data
releases when correcting for drift over time. Otherwise, spectrometers used
in multiple data releases would have different bin sizes when adjusting
different releases. A bin split is also hard coded on spectrometer 5 between
plates 0490000006726 and 0490000006714 which correspond to a large change in
concentrations akin to a spectrometer recalibration event most strongly
observed for alanine concentrations.
</p>
<p>## Version 3
Version 3 of the algorithm makes two further minor changes:
</p>
<p>1. Imputation of missing sample preparation times has been improved. Previously,
any samples missing time of measurement (N=3 in the phase 2 public release)
had their time of measurement set to 00:00. In version 3, the time of measurement
is set to the median time of measurement for that spectrometer on that day,
which is between 12:00-13:00, instead of 00:00.
2. Underlying code for adjusting drift over time has been modified to accommodate
the phase 3 public release, which includes one spectrometer with ~2,500 samples.
Version 2 of the algorithm would split this into two bins, whereas version 3
keeps this as a single bin to better match the bin sizes of the rest of the
spectrometers.
</p>


<h3>Value</h3>

<p>a <code>list</code> containing three <code>data.frames</code>: </p>

<dl>
<dt>biomarkers</dt><dd><p>A <code>data.frame</code> with column names &quot;eid&quot;,
and &quot;visit_index&quot;, containing project-specific sample identifier and
UK Biobank visit index (0 for baseline assessment, 1 for first repeat
assessment), followed by columns for each biomarker containing their
absolute concentrations (or ratios thereof) adjusted for technical
variation. See <code><a href="#topic+nmr_info">nmr_info</a></code> for information on each biomarker.</p>
</dd>
<dt>biomarker_qc_flags</dt><dd><p>A <code>data.frame</code> with the same format as
<code>biomarkers</code> with entries corresponding to the
<a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=221">quality
control indicators</a> for each sample. &quot;High plate outlier&quot; and &quot;Low
plate outlier&quot; indicate the value was set to missing due to systematic
abnormalities in the biomarker's concentration on the sample's shipment
plate compared to all other shipment plates (see Details). For
composite and derived biomarkers, quality control flags are aggregates
of any quality control flags for the underlying biomarkers from which
the composite biomarker or ratio is derived.</p>
</dd>
<dt>sample_processing</dt><dd><p>A <code>data.frame</code> containing the
<a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=222">processing
information and quality control indicators</a> for each sample, including
those derived for removal of unwanted technical variation by this
function. See <code><a href="#topic+sample_qc_info">sample_qc_info</a></code> for details.</p>
</dd>
<dt>log_offset</dt><dd><p>A <code>data.frame</code> containing diagnostic information on
the offset applied so that biomarkers with concentrations of 0 could
be log transformed, and any right shift applied to prevent negative
concentrations after rescaling adjusted residuals back to absolute
concentrations. Should contain only biomarkers with minimum
concentrations of 0 (in the &quot;Minimum&quot; column). &quot;Minimum.Non.Zero&quot;
gives the smallest non-zero concentration for the biomarker.
&quot;Log.Offset&quot; the small offset added to all samples prior to
log transformation: half the mininum non-zero concentration.
&quot;Right.Shift&quot; gives the small offset added to prevent negative
concentrations that arise after rescaling residuals to log
concentrations: this should be at least one order of magnitude
smaller than the smallest non-zero value (i.e. the offset added
should amount to noise in numeric precision for all samples). See
publication for more details.</p>
</dd>
<dt>outlier_plate_detection</dt><dd><p>A <code>data.frame</code> containing diagnostic
information and details of outlier plate detection. For each of the
107 non-derived biomarkers, the median concentration on each of the
1,352 plates was calculated, then plates were flagged as outliers if
their median value deviated more than expected from the mean of plate
medians. &quot;Mean.Plate.Medians&quot; gives the mean of the plate medians for
each biomarker. &quot;Lower.Limit&quot; and &quot;Upper.Limit&quot; give the values below
and above which plates are flagged as outliers based on their plate
median. See publication for more details.</p>
</dd>
<dt>algorithm_version</dt><dd><p>Version of the algorithm run, either 1, 2, or 3
(default).</p>
</dd>
</dl>



<h3>Examples</h3>

<pre><code class='language-R'>ukb_data &lt;- ukbnmr::test_data # Toy example dataset for testing package
processed &lt;- remove_technical_variation(ukb_data)

</code></pre>

<hr>
<h2 id='sample_qc_info'>Nightingale biomarker sample processing information</h2><span id='topic+sample_qc_info'></span>

<h3>Description</h3>

<p>Contains details on the sample processing and quality control information for
the NMR biomarker data in UK Biobank.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>sample_qc_info
</code></pre>


<h3>Format</h3>

<p>A data table with 18 rows and 3 columns:
</p>

<dl>
<dt>Name</dt><dd><p>Column name assigned to the sample information field</p>
</dd>
<dt>Description</dt><dd><p>Brief description of the field contents. Further details
on the Nightingale sample QC columns can be found in the <a href="https://biobank.ndph.ox.ac.uk/showcase/refer.cgi?id=3004">accompanying resource on the UK Biobank showcase</a>.</p>
</dd>
<dt>UKB.Field.ID</dt><dd><p>Field ID in UK Biobank, see <a href="https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=222">https://biobank.ndph.ox.ac.uk/showcase/label.cgi?id=222</a>.
Rows missing <code>UKB.Field.ID</code> entries correspond to additional sample
processing information derived from these fields and returned by <code><a href="#topic+remove_technical_variation">remove_technical_variation</a></code>.</p>
</dd>
</dl>


<hr>
<h2 id='test_data'>Data for testing package functions</h2><span id='topic+test_data'></span>

<h3>Description</h3>

<p>Dataset mimicking structure of decoded UK Biobank dataset of NMR metabolomics
biomarker concentrations and associated processing variables for testing
package functions.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>test_data
</code></pre>


<h3>Format</h3>

<p>A data table with 50 rows and 735 columns with column names &quot;eid&quot;
followed by extracted UK Biobank field data of the format &quot;p23649_i0&quot;,
&quot;p23649_i1&quot;, ..., &quot;p23655_i1&quot;.
</p>


<h3>Source</h3>

<p>Data in each column has been randomly drawn from the distribution
present in the UK Biobank dataset. Importantly, random sampling was performed
for each column separately, thus no rows represent real observations or
participants in UK Biobank.
</p>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
