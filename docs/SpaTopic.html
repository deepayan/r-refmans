<!DOCTYPE html><html><head><title>Help for package SpaTopic</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {SpaTopic}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#gibbs.res-class'><p>A class of the output from 'SpaTopic'</p></a></li>
<li><a href='#lung5'><p>Example input data for 'SpaTopic'</p></a></li>
<li><a href='#Seurat5obj_to_SpaTopic'><p>Convert a Seurat v5 object as the input of 'SpaTopic'</p></a></li>
<li><a href='#SpaTopic_inference'><p>'SpaTopic': fast topic inference to identify tissue architecture in multiplexed images</p></a></li>
<li><a href='#SpaTopic-Package'><p>'SpaTopic' R package</p></a></li>
<li><a href='#stratified_sampling_sf'><p>Spatially stratified random sample points from an image.</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Topic Inference to Identify Tissue Architecture in Multiplexed
Images</td>
</tr>
<tr>
<td>Version:</td>
<td>1.0.1</td>
</tr>
<tr>
<td>Date:</td>
<td>2023-12-20</td>
</tr>
<tr>
<td>Description:</td>
<td>A novel spatial topic model to integrate both cell type and spatial information to identify the complex spatial tissue architecture on multiplexed tissue images without human intervention. The Package implements a Collapsed Gibbs sampling algorithm for inference. 'SpaTopic' is scalable to large-scale image datasets without extracting neighborhood information for every single cell. For more details on the methodology, see <a href="https://xiyupeng.github.io/SpaTopic/">https://xiyupeng.github.io/SpaTopic/</a>.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-3">GPL (&ge; 3)</a></td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 3.5.0),</td>
</tr>
<tr>
<td>Imports:</td>
<td>Rcpp (&ge; 0.12.0), RANN (&ge; 2.6.0), sf (&ge; 1.0-12), methods (&ge;
3.4), foreach (&ge; 1.5.0), iterators (&ge; 1.0),</td>
</tr>
<tr>
<td>LinkingTo:</td>
<td>Rcpp, RcppArmadillo, RcppProgress,</td>
</tr>
<tr>
<td>Suggests:</td>
<td>knitr, rmarkdown, SeuratObject (&ge; 4.9.9.9086), doParallel
(&ge; 1.0),</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.2.3</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>LazyData:</td>
<td>true</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://github.com/xiyupeng/SpaTopic">https://github.com/xiyupeng/SpaTopic</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/xiyupeng/SpaTopic/issues">https://github.com/xiyupeng/SpaTopic/issues</a></td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>yes</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2024-01-16 23:04:47 UTC; pengx1</td>
</tr>
<tr>
<td>Author:</td>
<td>Xiyu Peng <a href="https://orcid.org/0000-0003-4232-0910"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [aut,
    cre]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Xiyu Peng &lt;pansypeng124@gmail.com&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2024-01-17 18:42:11 UTC</td>
</tr>
</table>
<hr>
<h2 id='gibbs.res-class'>A class of the output from 'SpaTopic'</h2><span id='topic+gibbs.res-class'></span>

<h3>Description</h3>

<p>Outputs from function <code><a href="#topic+SpaTopic_inference">SpaTopic_inference</a></code>. 
A <code><a href="base.html#topic+list">list</a></code> contains the following members:
</p>

<ul>
<li> <p><code>$Perplexity</code>. The perplexity is for the training data. 
Let N be the total number of cells across all images.
<code class="reqn">Perplexity = exp(-loglikelihood/N)</code>
</p>
</li>
<li> <p><code>$Deviance</code>. <code class="reqn">Deviance = -2loglikelihood</code>.
</p>
</li>
<li> <p><code>$loglikelihood</code>. The model log-likelihood. 
</p>
</li>
<li> <p><code>$loglike.trace</code>. The log-likelihood for every collected posterior sample. 
NULL if <code>trace</code> = FALSE.
</p>
</li>
<li> <p><code>$Beta</code>. Topic content matrix with rows as celltypes and columns as topics
</p>
</li>
<li> <p><code>$Theta</code>. Topic prevalent matrix with rows as regions and columns as topics
</p>
</li>
<li> <p><code>$Ndk</code>. Number of cells per topic (col) per region (row).
</p>
</li>
<li> <p><code>$Nwk</code>. Number of cells per topic (col) per celltype (row).
</p>
</li>
<li> <p><code>$Z.trace</code>. Number of times cell being assigned to each topic across all posterior samples.
We can further compute the posterior distributions of <code>Z</code> (topic assignment) for 
individual cells.
</p>
</li>
<li> <p><code>$doc.trace</code>. <code>Ndk</code> for every collected posterior sample.
NULL if <code>trace</code> = FALSE.
</p>
</li>
<li> <p><code>$word.trace</code>. <code>Nwk</code> for every collected posterior sample.
NULL if <code>trace</code> = FALSE.
</p>
</li></ul>



<h3>See Also</h3>

<p><code><a href="#topic+SpaTopic_inference">SpaTopic_inference</a></code>
</p>

<hr>
<h2 id='lung5'>Example input data for 'SpaTopic'</h2><span id='topic+lung5'></span>

<h3>Description</h3>

<p>multiplexed image data on tumor tissue sample from non small cell lung cancer patient
</p>


<h3>Usage</h3>

<pre><code class='language-R'>lung5
</code></pre>


<h3>Format</h3>

<p>## 'lung5'
A data frame with 100149 rows and 4 columns: 
</p>
 
<dl>
<dt>image</dt><dd><p>Image ID</p>
</dd>
<dt>X</dt><dd><p>X coordinate of the cell</p>
</dd>
<dt>Y</dt><dd><p>Y coordinate of the cell</p>
</dd>
<dt>type</dt><dd><p>cell type</p>
</dd>
</dl>



<h3>Source</h3>

<p>&lt;https://nanostring.com/products/cosmx-spatial-molecular-imager/ffpe-dataset/nsclc-ffpe-dataset/&gt;
</p>


<h3>See Also</h3>

<p><code><a href="#topic+SpaTopic_inference">SpaTopic_inference</a></code>,<code><a href="#topic+Seurat5obj_to_SpaTopic">Seurat5obj_to_SpaTopic</a></code>
</p>

<hr>
<h2 id='Seurat5obj_to_SpaTopic'>Convert a Seurat v5 object as the input of 'SpaTopic'</h2><span id='topic+Seurat5obj_to_SpaTopic'></span>

<h3>Description</h3>

<p>Prepare 'SpaTopic' input from one Seurat v5 object
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Seurat5obj_to_SpaTopic(object, group.by, image = "image1")
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="Seurat5obj_to_SpaTopic_+3A_object">object</code></td>
<td>
<p>Seurat v5 object</p>
</td></tr>
<tr><td><code id="Seurat5obj_to_SpaTopic_+3A_group.by">group.by</code></td>
<td>
<p><code>character</code>. The name of the column that contains celltype information in the Seurat object.</p>
</td></tr>
<tr><td><code id="Seurat5obj_to_SpaTopic_+3A_image">image</code></td>
<td>
<p><code>character</code>. The name of the image. Default is &quot;image1&quot;.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Return a data frame as the input of 'SpaTopic'
</p>


<h3>See Also</h3>

<p><code><a href="#topic+lung5">lung5</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
## nano.obj is a Seurat v5 object
#dataset&lt;-Seurat5obj_to_SpaTopic(object = nano.obj, 
#                 group.by = "predicted.annotation.l1",image = "image1")
## Expect output
data("lung5")

</code></pre>

<hr>
<h2 id='SpaTopic_inference'>'SpaTopic': fast topic inference to identify tissue architecture in multiplexed images</h2><span id='topic+SpaTopic_inference'></span>

<h3>Description</h3>

<p>This is the main function of 'SpaTopic', implementing a Collapsed Gibbs
Sampling algorithm to learn topics, which referred to different tissue microenvironments, 
across multiple multiplexed tissue images. 
The function takes cell labels and coordinates on tissue images as input,
and returns the inferred topic labels for every cell, as well as topic contents, a distribution
over celltypes.
The function recovers spatial tissue architectures across images, 
as well as indicating cell-cell interactions in each domain.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>SpaTopic_inference(
  tissue,
  ntopics,
  sigma = 50,
  region_radius = 400,
  kneigh = 5,
  npoints_selected = 1,
  ini_LDA = TRUE,
  ninit = 10,
  niter_init = 100,
  beta = 0.05,
  alpha = 0.01,
  trace = FALSE,
  seed = 123,
  thin = 20,
  burnin = 1000,
  niter = 200,
  display_progress = TRUE,
  do.parallel = FALSE,
  n.cores = 1,
  axis = "2D"
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="SpaTopic_inference_+3A_tissue">tissue</code></td>
<td>
<p>(Required). A data frame or a list of data frames. One for each image. 
Each row represent a cell with its image ID, X, Y coordinates on the image, celltype,
with column names (image, X, Y, type), respectively. You may add another column 
Y2 for 3D tissue image.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_ntopics">ntopics</code></td>
<td>
<p>(Required). Number of topics. Topics will be obtained as distributions 
of cell types.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_sigma">sigma</code></td>
<td>
<p>Default is 50. The lengthscale of the Nearest-neighbor Exponential Kernel.
Sigma controls the strength of decay of correlation with distance in the kernel function.
Please check the paper for more information. 
Need to be adjusted based on the image resolution</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_region_radius">region_radius</code></td>
<td>
<p>Default is 400. The radius for each grid square when
sampling region centers for each image. 
Need to be adjusted based on the image resolution and pattern complexity.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_kneigh">kneigh</code></td>
<td>
<p>Default is 5. Only consider the top 5 closest region centers for each cell.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_npoints_selected">npoints_selected</code></td>
<td>
<p>Default is 1. Number of points sampled for each grid square 
when sampling region centers for each image. Used with <code>region_radius</code>.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_ini_lda">ini_LDA</code></td>
<td>
<p>Default is TRUE. Use warm start strategy for initialization and choose the best one
to continue. If 0, it simply uses the first initialization.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_ninit">ninit</code></td>
<td>
<p>Default is 10. Number of initialization. 
Only retain the initialization with the highest log likelihood (perplexity).</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_niter_init">niter_init</code></td>
<td>
<p>Default is 100. Warm start with 100 iterations in the Gibbs sampling 
during initialization.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_beta">beta</code></td>
<td>
<p>Default is 0.05. A hyperparameter to control the sparsity of topic content
(topic-celltype) matrix <code>Beta</code>. A smaller value introduces more sparse in <code>Beta</code>.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_alpha">alpha</code></td>
<td>
<p>Default is 0.01. A hyperparameter to control the sparsity of document (region) content
(region-topic) matrix <code>Theta</code>. For our application, we keep it 
very small for the sparsity in <code>Theta</code>.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_trace">trace</code></td>
<td>
<p>Default is FALSE. Compute and save log likelihood, <code>Ndk</code>, <code>Nwk</code> 
for every posterior samples. Useful when you want to use DIC to select number of 
topics, but it is time consuming to compute the likelihood for every posterior samples.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_seed">seed</code></td>
<td>
<p>Default is 123. Random seed.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_thin">thin</code></td>
<td>
<p>Default is 20. Key parameter in Gibbs sampling. 
Collect a posterior sample for every thin=20 iterations.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_burnin">burnin</code></td>
<td>
<p>Default is 1000. Key parameter in Gibbs sampling.
Start to collect posterior samples after 1000 iterations. You may increase
the number of iterations for burn-in for highly complex tissue images.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_niter">niter</code></td>
<td>
<p>Default is 200. Key parameter in Gibbs sampling. 
Number of posterior samples collected for model inference.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_display_progress">display_progress</code></td>
<td>
<p>Default is TRUE. Display the progress bar.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_do.parallel">do.parallel</code></td>
<td>
<p>Default is FALSE. Use parallel computing through R package <code>foreach</code>.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_n.cores">n.cores</code></td>
<td>
<p>Default is 1. Number of cores used in parallel computing.</p>
</td></tr>
<tr><td><code id="SpaTopic_inference_+3A_axis">axis</code></td>
<td>
<p>Default is &quot;2D&quot;. You may switch to &quot;3D&quot; for 3D tissue images. 
However, the model inference for 3D tissue is still under test.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Return a <code><a href="#topic+gibbs.res-class">gibbs.res-class</a></code> object. A list of outputs from Gibbs sampling.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+gibbs.res-class">gibbs.res-class</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
## tissue is a data frame containing cellular information from one image or
## multiple data frames from multiple images.

data("lung5")
## NOT RUN, it takes about 90s
library(sf)
#gibbs.res&lt;-SpaTopic_inference(lung5, ntopics = 7,
#                               sigma = 50, region_radius = 400)
                             
                              
## generate a fake image 2 and make an example for multiple images
## NOT RUN
#lung6&lt;-lung5
#lung6$image&lt;-"image2"  ## The image ID of two images should be different
#gibbs.res&lt;-SpaTopic_inference(list(A = lung5, B = lung6), 
#                 ntopics = 7, sigma = 50, region_radius = 400) 

</code></pre>

<hr>
<h2 id='SpaTopic-Package'>'SpaTopic' R package</h2><span id='topic+SpaTopic-Package'></span>

<h3>Description</h3>

<p>The 'SpaTopic' R package is centered around the 'SpaTopic' algorithm to infer the spatial
tissue architectures from multiplexed images.
</p>


<h3>Details</h3>

<p>The package implements a Collapsed 
Gibbs sampling algorithm to infer topics, corresponding to distinct tissue 
microenvironments across multiple tissue images. 
Without obtaining the cell neighborhood info of every single cell, 
'SpaTopic' runs much faster than other KNN-based methods on large-scale images.
</p>
<p>The main functions in the 'SpaTopic' package
</p>

<ul>
<li><p> Prepare input   <code><a href="#topic+Seurat5obj_to_SpaTopic">Seurat5obj_to_SpaTopic</a></code>
</p>
</li>
<li><p> Model Inference <code><a href="#topic+SpaTopic_inference">SpaTopic_inference</a></code>
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Xiyu Peng <a href="mailto:pansypeng124@gmail.com">pansypeng124@gmail.com</a>
</p>

<hr>
<h2 id='stratified_sampling_sf'>Spatially stratified random sample points from an image.</h2><span id='topic+stratified_sampling_sf'></span>

<h3>Description</h3>

<p>Spatially stratified random sample points from an image by R package <code>sf</code>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>stratified_sampling_sf(
  points,
  cellsize = c(600, 600),
  num_samples_per_stratum = 1
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="stratified_sampling_sf_+3A_points">points</code></td>
<td>
<p>a data frame contains all points in a image with X, Y coordinates.</p>
</td></tr>
<tr><td><code id="stratified_sampling_sf_+3A_cellsize">cellsize</code></td>
<td>
<p>a vector of length 2 contains the size of each grid square. 
Default c(600,600).</p>
</td></tr>
<tr><td><code id="stratified_sampling_sf_+3A_num_samples_per_stratum">num_samples_per_stratum</code></td>
<td>
<p>number of point selected from each grid square.
Default 1.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Return a vector contains index of sampled points.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data("lung5")
pt_idx&lt;-stratified_sampling_sf(lung5, cellsize = c(600,600))

</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
