<!DOCTYPE html><html lang="en"><head><title>Help for package spanishoddata</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {spanishoddata}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#global_quiet_param'><p>Global Quiet Parameter</p></a></li>
<li><a href='#spod_available_data'><p>Get available data list</p></a></li>
<li><a href='#spod_available_data_v1'><p>Get the available v1 data list</p></a></li>
<li><a href='#spod_available_data_v2'><p>Get the data dictionary</p></a></li>
<li><a href='#spod_available_ram'><p>Get available RAM</p></a></li>
<li><a href='#spod_clean_zones_v1'><p>Fixes common issues in the zones data and cleans up variable names</p></a></li>
<li><a href='#spod_clean_zones_v2'><p>Fixes common issues in the zones data and cleans up variable names</p></a></li>
<li><a href='#spod_codebook'><p>View codebooks for v1 and v2 open mobility data</p></a></li>
<li><a href='#spod_connect'><p>Connect to data converted to <code>DuckDB</code> or hive-style <code>parquet</code> files</p></a></li>
<li><a href='#spod_convert'><p>Convert data from plain text to duckdb or parquet format</p></a></li>
<li><a href='#spod_convert_dates_to_ranges'><p>Convert dates to ranges</p></a></li>
<li><a href='#spod_dates_argument_to_dates_seq'><p>Convert multiple formates of date arguments to a sequence of dates</p></a></li>
<li><a href='#spod_disconnect'><p>Safely disconnect from data and free memory</p></a></li>
<li><a href='#spod_download'><p>Download the data files of specified type, zones, and dates</p></a></li>
<li><a href='#spod_download_zones_v1'><p>Downloads and extracts the raw v1 zones data</p></a></li>
<li><a href='#spod_duckdb_create_province_enum'><p>Create province names ENUM in a duckdb connection</p></a></li>
<li><a href='#spod_duckdb_filter_by_dates'><p>Filter a duckdb conenction by dates</p></a></li>
<li><a href='#spod_duckdb_limit_resources'><p>Set maximum memory and number of threads for a <code>DuckDB</code> connection</p></a></li>
<li><a href='#spod_duckdb_number_of_trips'><p>Create a duckdb number of trips table</p></a></li>
<li><a href='#spod_duckdb_od'><p>Creates a duckdb connection to origin-destination data</p></a></li>
<li><a href='#spod_duckdb_overnight_stays'><p>Create a duckdb overnight stays table</p></a></li>
<li><a href='#spod_duckdb_set_temp'><p>Set temp file for DuckDB connection</p></a></li>
<li><a href='#spod_expand_dates_from_regex'><p>Function to expand dates from a regex</p></a></li>
<li><a href='#spod_files_sizes'><p>Get files sizes for remote files of v1 and v2 data and save them into a csv.gz file in the inst/extdata folder.</p></a></li>
<li><a href='#spod_get'><p>Get tabular mobility data</p></a></li>
<li><a href='#spod_get_data_dir'><p>Get the data directory</p></a></li>
<li><a href='#spod_get_file_size_from_url'><p>Get file size from URL</p></a></li>
<li><a href='#spod_get_latest_v1_file_list'><p>Get latest file list from the XML for MITMA open mobility data v1 (2020-2021)</p></a></li>
<li><a href='#spod_get_latest_v2_file_list'><p>Get latest file list from the XML for MITMA open mobility data v2 (2022 onwards)</p></a></li>
<li><a href='#spod_get_temp_dir'><p>Get temporary directory for DuckDB intermediate spilling</p></a></li>
<li><a href='#spod_get_valid_dates'><p>Get valid dates for the specified data version</p></a></li>
<li><a href='#spod_get_zones'><p>Get zones</p></a></li>
<li><a href='#spod_get_zones_v1'><p>Retrieves the zones for v1 data</p></a></li>
<li><a href='#spod_get_zones_v2'><p>Retrieves the zones v2 data</p></a></li>
<li><a href='#spod_infer_data_v_from_dates'><p>Infer data version from dates</p></a></li>
<li><a href='#spod_is_data_version_overlaps'><p>Check if specified dates span both data versions</p></a></li>
<li><a href='#spod_match_data_type'><p>Match data types for normalisation</p></a></li>
<li><a href='#spod_match_data_type_for_local_folders'><p>Match data types to folders</p></a></li>
<li><a href='#spod_quick_get_od'><p>Get daily trip counts per origin-destionation municipality from 2022 onward</p></a></li>
<li><a href='#spod_read_sql'><p>Load an SQL query, glue it, dplyr::sql it</p></a></li>
<li><a href='#spod_set_data_dir'><p>Set the data directory</p></a></li>
<li><a href='#spod_sql_where_dates'><p>Generate a WHERE part of an SQL query from a sequence of dates</p></a></li>
<li><a href='#spod_subfolder_clean_data_cache'><p>Get clean data subfolder name</p></a></li>
<li><a href='#spod_subfolder_metadata_cache'><p>Get metadata cache subfolder name</p></a></li>
<li><a href='#spod_subfolder_raw_data_cache'><p>Get raw data cache subfolder name</p></a></li>
<li><a href='#spod_unique_separated_ids'><p>Remove duplicate values in a semicolon-separated string</p></a></li>
<li><a href='#spod_zone_names_en2es'><p>Translate zone names from English to Spanish</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Title:</td>
<td>Get Spanish Origin-Destination Data</td>
</tr>
<tr>
<td>Version:</td>
<td>0.1.0</td>
</tr>
<tr>
<td>Description:</td>
<td>Gain seamless access to origin-destination (OD) data from the
    Spanish Ministry of Transport, hosted at
    <a href="https://www.transportes.gob.es/ministerio/proyectos-singulares/estudios-de-movilidad-con-big-data/opendata-movilidad">https://www.transportes.gob.es/ministerio/proyectos-singulares/estudios-de-movilidad-con-big-data/opendata-movilidad</a>.
    This package simplifies the management of these large datasets by
    providing tools to download zone boundaries, handle associated
    origin-destination data, and process it efficiently with the 'duckdb'
    database interface.  Local caching minimizes repeated downloads,
    streamlining workflows for researchers and analysts. Extensive
    documentation is available at
    <a href="https://ropenspain.github.io/spanishoddata/index.html">https://ropenspain.github.io/spanishoddata/index.html</a>, offering
    guides on creating static and dynamic mobility flow visualizations and
    transforming large datasets into analysis-ready formats.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file LICENSE</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://rOpenSpain.github.io/spanishoddata/">https://rOpenSpain.github.io/spanishoddata/</a>,
<a href="https://github.com/rOpenSpain/spanishoddata">https://github.com/rOpenSpain/spanishoddata</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/rOpenSpain/spanishoddata/issues">https://github.com/rOpenSpain/spanishoddata/issues</a></td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 3.5.0)</td>
</tr>
<tr>
<td>Imports:</td>
<td>checkmate, curl (&ge; 5.0.0), DBI, dplyr, duckdb (&ge; 0.5.0), fs,
glue, here, httr2, lubridate, memuse, parallelly, purrr, readr,
rlang, sf, stats, stringr, tibble, xml2</td>
</tr>
<tr>
<td>Suggests:</td>
<td>flowmapblue, flowmapper (&ge; 0.1.2), furrr, future,
hexSticker, mapSpain, quarto, remotes, scales, testthat (&ge;
3.0.0), tidyverse</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>quarto</td>
</tr>
<tr>
<td>Config/Needs/website:</td>
<td>rmarkdown</td>
</tr>
<tr>
<td>Config/testthat/edition:</td>
<td>3</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.3.2</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2024-12-17 11:48:19 UTC; ek</td>
</tr>
<tr>
<td>Author:</td>
<td>Egor Kotov <a href="https://orcid.org/0000-0001-6690-5345"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [aut,
    cre],
  Robin Lovelace <a href="https://orcid.org/0000-0001-5679-6536"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut],
  Eugeni Vidal-Tortosa
    <a href="https://orcid.org/0000-0001-5199-4103"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [ctb]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Egor Kotov &lt;kotov.egor@gmail.com&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2024-12-18 15:40:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='global_quiet_param'>Global Quiet Parameter</h2><span id='topic+global_quiet_param'></span>

<h3>Description</h3>

<p>Documentation for the <code>quiet</code> parameter, used globally.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>global_quiet_param(quiet = FALSE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="global_quiet_param_+3A_quiet">quiet</code></td>
<td>
<p>A <code>logical</code> value indicating whether to suppress messages. Default is <code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Nothing. This function is just a placeholder for global quiet parameter.
</p>

<hr>
<h2 id='spod_available_data'>Get available data list</h2><span id='topic+spod_available_data'></span>

<h3>Description</h3>

<p>Get a table with links to available data files for the specified data version. Optionally check (see arguments) if certain files have already been downloaded into the cache directory specified with SPANISH_OD_DATA_DIR environment variable (set by <a href="#topic+spod_set_data_dir">spod_set_data_dir</a>) or a custom path specified with <code>data_dir</code> argument.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_available_data(
  ver = 2,
  check_local_files = FALSE,
  quiet = FALSE,
  data_dir = spod_get_data_dir()
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_available_data_+3A_ver">ver</code></td>
<td>
<p>Integer. Can be 1 or 2. The version of the data to use. v1 spans 2020-2021, v2 covers 2022 and onwards.</p>
</td></tr>
<tr><td><code id="spod_available_data_+3A_check_local_files">check_local_files</code></td>
<td>
<p>Whether to check if the local files exist. Defaults to <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="spod_available_data_+3A_quiet">quiet</code></td>
<td>
<p>A <code>logical</code> value indicating whether to suppress messages. Default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="spod_available_data_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored. Defaults to the value returned by <code>spod_get_data_dir()</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A tibble with links, release dates of files in the data, dates of data coverage, local paths to files, and the download status.
</p>

<dl>
<dt>target_url</dt><dd><p><code>character</code>. The URL link to the data file.</p>
</dd>
<dt>pub_ts</dt><dd><p><code>POSIXct</code>. The timestamp of when the file was published.</p>
</dd>
<dt>file_extension</dt><dd><p><code>character</code>. The file extension of the data file (e.g., 'tar', 'gz').</p>
</dd>
<dt>data_ym</dt><dd><p><code>Date</code>. The year and month of the data coverage, if available.</p>
</dd>
<dt>data_ymd</dt><dd><p><code>Date</code>. The specific date of the data coverage, if available.</p>
</dd>
<dt>local_path</dt><dd><p><code>character</code>. The local file path where the data is stored.</p>
</dd>
<dt>downloaded</dt><dd><p><code>logical</code>. Indicator of whether the data file has been downloaded locally. This is only available if <code>check_local_files</code> is <code>TRUE</code>.</p>
</dd>
</dl>



<h3>Examples</h3>

<pre><code class='language-R'>


# Set data dir for file downloads
spod_set_data_dir(tempdir())

# Get available data list for v1 (2020-2021) data
spod_available_data(ver = 1)

# Get available data list for v2 (2022 onwards) data
spod_available_data(ver = 2)

# Get available data list for v2 (2022 onwards) data
# while also checking for local files that are already downloaded
spod_available_data(ver = 2, check_local_files = TRUE)


</code></pre>

<hr>
<h2 id='spod_available_data_v1'>Get the available v1 data list</h2><span id='topic+spod_available_data_v1'></span>

<h3>Description</h3>

<p>This function provides a table of the available data list of MITMA v1 (2020-2021), both remote and local.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_available_data_v1(
  data_dir = spod_get_data_dir(),
  check_local_files = FALSE,
  quiet = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_available_data_v1_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored. Defaults to the value returned by <code>spod_get_data_dir()</code>.</p>
</td></tr>
<tr><td><code id="spod_available_data_v1_+3A_check_local_files">check_local_files</code></td>
<td>
<p>Whether to check if the local files exist. Defaults to <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="spod_available_data_v1_+3A_quiet">quiet</code></td>
<td>
<p>A <code>logical</code> value indicating whether to suppress messages. Default is <code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A tibble with links, release dates of files in the data, dates of data coverage, local paths to files, and the download status.
</p>

<dl>
<dt>target_url</dt><dd><p><code>character</code>. The URL link to the data file.</p>
</dd>
<dt>pub_ts</dt><dd><p><code>POSIXct</code>. The timestamp of when the file was published.</p>
</dd>
<dt>file_extension</dt><dd><p><code>character</code>. The file extension of the data file (e.g., 'tar', 'gz').</p>
</dd>
<dt>data_ym</dt><dd><p><code>Date</code>. The year and month of the data coverage, if available.</p>
</dd>
<dt>data_ymd</dt><dd><p><code>Date</code>. The specific date of the data coverage, if available.</p>
</dd>
<dt>local_path</dt><dd><p><code>character</code>. The local file path where the data is stored.</p>
</dd>
<dt>downloaded</dt><dd><p><code>logical</code>. Indicator of whether the data file has been downloaded locally. This is only available if <code>check_local_files</code> is <code>TRUE</code>.</p>
</dd>
</dl>


<hr>
<h2 id='spod_available_data_v2'>Get the data dictionary</h2><span id='topic+spod_available_data_v2'></span>

<h3>Description</h3>

<p>This function retrieves the data dictionary for the specified data directory.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_available_data_v2(
  data_dir = spod_get_data_dir(),
  check_local_files = FALSE,
  quiet = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_available_data_v2_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored. Defaults to the value returned by <code>spod_get_data_dir()</code>.</p>
</td></tr>
<tr><td><code id="spod_available_data_v2_+3A_check_local_files">check_local_files</code></td>
<td>
<p>Whether to check if the local files exist. Defaults to <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="spod_available_data_v2_+3A_quiet">quiet</code></td>
<td>
<p>A <code>logical</code> value indicating whether to suppress messages. Default is <code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A tibble with links, release dates of files in the data, dates of data coverage, local paths to files, and the download status.
</p>

<dl>
<dt>target_url</dt><dd><p><code>character</code>. The URL link to the data file.</p>
</dd>
<dt>pub_ts</dt><dd><p><code>POSIXct</code>. The timestamp of when the file was published.</p>
</dd>
<dt>file_extension</dt><dd><p><code>character</code>. The file extension of the data file (e.g., 'tar', 'gz').</p>
</dd>
<dt>data_ym</dt><dd><p><code>Date</code>. The year and month of the data coverage, if available.</p>
</dd>
<dt>data_ymd</dt><dd><p><code>Date</code>. The specific date of the data coverage, if available.</p>
</dd>
<dt>local_path</dt><dd><p><code>character</code>. The local file path where the data is stored.</p>
</dd>
<dt>downloaded</dt><dd><p><code>logical</code>. Indicator of whether the data file has been downloaded locally. This is only available if <code>check_local_files</code> is <code>TRUE</code>.</p>
</dd>
</dl>


<hr>
<h2 id='spod_available_ram'>Get available RAM</h2><span id='topic+spod_available_ram'></span>

<h3>Description</h3>

<p>Get available RAM
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_available_ram()
</code></pre>


<h3>Value</h3>

<p>A <code>numeric</code> amount of available RAM in GB.
</p>

<hr>
<h2 id='spod_clean_zones_v1'>Fixes common issues in the zones data and cleans up variable names</h2><span id='topic+spod_clean_zones_v1'></span>

<h3>Description</h3>

<p>This function fixes any invalid geometries in the zones data and renames the &quot;ID&quot; column to &quot;id&quot;.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_clean_zones_v1(zones_path, zones)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_clean_zones_v1_+3A_zones_path">zones_path</code></td>
<td>
<p>The path to the zones spatial data file.</p>
</td></tr>
<tr><td><code id="spod_clean_zones_v1_+3A_zones">zones</code></td>
<td>
<p>The zones for which to download the data. Can be <code>"districts"</code> (or <code>"dist"</code>, <code>"distr"</code>, or the original Spanish <code>"distritos"</code>) or <code>"municipalities"</code> (or <code>"muni"</code>, <code>"municip"</code>, or the original Spanish <code>"municipios"</code>) for both data versions. Additionaly, these can be <code>"large_urban_areas"</code> (or <code>"lua"</code>, or the original Spanish <code>"grandes_areas_urbanas"</code>, or <code>"gau"</code>) for v2 data (2022 onwards).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A spatial object containing the cleaned zones data.
</p>

<hr>
<h2 id='spod_clean_zones_v2'>Fixes common issues in the zones data and cleans up variable names</h2><span id='topic+spod_clean_zones_v2'></span>

<h3>Description</h3>

<p>This function fixes any invalid geometries in the zones data and renames the &quot;ID&quot; column to &quot;id&quot;. It also attacches the population counts and zone names provided in the csv files supplied by the original data provider.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_clean_zones_v2(zones_path)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_clean_zones_v2_+3A_zones_path">zones_path</code></td>
<td>
<p>The path to the zones spatial data file.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A spatial 'sf&ldquo; object containing the cleaned zones data.
</p>

<hr>
<h2 id='spod_codebook'>View codebooks for v1 and v2 open mobility data</h2><span id='topic+spod_codebook'></span>

<h3>Description</h3>

<p>Opens relevant vignette with a codebook for v1 (2020-2021) and v2 (2022 onwards) data or provide a webpage if vignette is missing.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_codebook(ver = 1)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_codebook_+3A_ver">ver</code></td>
<td>
<p>An <code>integer</code> or <code>numeric</code> value. The version of the data. Defaults to 1. Can be <code>1</code> for v1 (2020-2021) data and 2 for v2 (2022 onwards) data.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Nothing, opens vignette if it is installed. If vignette is missing, prints a message with a link to a webpage with the codebook.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# View codebook for v1 (2020-2021) data
spod_codebook(ver = 1)

# View codebook for v2 (2022 onwards) data
spod_codebook(ver = 2)

</code></pre>

<hr>
<h2 id='spod_connect'>Connect to data converted to <code>DuckDB</code> or hive-style <code>parquet</code> files</h2><span id='topic+spod_connect'></span>

<h3>Description</h3>

<p>This function allows the user to quickly connect to the data converted to DuckDB with the <a href="#topic+spod_convert">spod_convert</a> function. This function simplifies the connection process. The user is free to use the <code>DBI</code> and <code>DuckDB</code> packages to connect to the data manually, or to use the <code>arrow</code> package to connect to the <code>parquet</code> files folder.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_connect(
  data_path,
  target_table_name = NULL,
  quiet = FALSE,
  max_mem_gb = max(4, spod_available_ram() - 4),
  max_n_cpu = parallelly::availableCores() - 1,
  temp_path = spod_get_temp_dir()
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_connect_+3A_data_path">data_path</code></td>
<td>
<p>a path to the <code>DuckDB</code> database file with '.duckdb' extension, or a path to the folder with <code>parquet</code> files. Eigher one should have been created with the <a href="#topic+spod_convert">spod_convert</a> function.</p>
</td></tr>
<tr><td><code id="spod_connect_+3A_target_table_name">target_table_name</code></td>
<td>
<p>Default is <code>NULL</code>. When connecting to a folder of <code>parquet</code> files, this argument is ignored. When connecting to a <code>DuckDB</code> database, a <code>character</code> vector of length 1 with the table name to open from the database file. If not specified, it will be guessed from the <code>data_path</code> argument and from table names that are available in the database. If you have not manually interfered with the database, this should be guessed automatically and you do not need to specify it.</p>
</td></tr>
<tr><td><code id="spod_connect_+3A_quiet">quiet</code></td>
<td>
<p>A <code>logical</code> value indicating whether to suppress messages. Default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="spod_connect_+3A_max_mem_gb">max_mem_gb</code></td>
<td>
<p>The maximum memory to use in GB. A conservative default is 3 GB, which should be enough for resaving the data to <code>DuckDB</code> form a folder of CSV.gz files while being small enough to fit in memory of most even old computers. For data analysis using the already converted data (in <code>DuckDB</code> or Parquet format) or with the raw CSV.gz data, it is recommended to increase it according to available resources.</p>
</td></tr>
<tr><td><code id="spod_connect_+3A_max_n_cpu">max_n_cpu</code></td>
<td>
<p>The maximum number of threads to use. Defaults to the number of available cores minus 1.</p>
</td></tr>
<tr><td><code id="spod_connect_+3A_temp_path">temp_path</code></td>
<td>
<p>The path to the temp folder for DuckDB for <a href="https://duckdb.org/2024/07/09/memory-management.html#intermediate-spilling">intermediate spilling</a> in case the set memory limit and/or physical memory of the computer is too low to perform the query. By default this is set to the <code>temp</code> directory in the data folder defined by SPANISH_OD_DATA_DIR environment variable. Otherwise, for queries on folders of CSV files or parquet files, the temporary path would be set to the current R working directory, which probably is undesirable, as the current working directory can be on a slow storage, or storage that may have limited space, compared to the data folder.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>a <code>DuckDB</code> table connection object.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

# Set data dir for file downloads
spod_set_data_dir(tempdir())

# download and convert data
dates_1 &lt;- c(start = "2020-02-17", end = "2020-02-18")
db_2 &lt;- spod_convert(
 type = "number_of_trips",
 zones = "distr",
 dates = dates_1,
 overwrite = TRUE
)

# now connect to the converted data
my_od_data_2 &lt;- spod_connect(db_2)

# disconnect from the database
spod_disconnect(my_od_data_2)


</code></pre>

<hr>
<h2 id='spod_convert'>Convert data from plain text to duckdb or parquet format</h2><span id='topic+spod_convert'></span>

<h3>Description</h3>

<p>Converts data for faster analysis into either <code>DuckDB</code> file or into <code>parquet</code> files in a hive-style directory structure. Running analysis on these files is sometimes 100x times faster than working with raw CSV files, espetially when these are in gzip archives. To connect to converted data, please use 'mydata &lt;- <a href="#topic+spod_connect">spod_connect</a>(data_path = path_returned_by_spod_convert)' passing the path to where the data was saved. The connected <code>mydata</code> can be analysed using <code>dplyr</code> functions such as <a href="dplyr.html#topic+select">select</a>, <a href="dplyr.html#topic+filter">filter</a>, <a href="dplyr.html#topic+mutate">mutate</a>, <a href="dplyr.html#topic+group_by">group_by</a>, <a href="dplyr.html#topic+summarise">summarise</a>, etc. In the end of any sequence of commands you will need to add <a href="dplyr.html#topic+collect">collect</a> to execute the whole chain of data manipulations and load the results into memory in an R <code>data.frame</code>/<code>tibble</code>. For more in-depth usage of such data, please refer to DuckDB documentation and examples at <a href="https://duckdb.org/docs/api/r#dbplyr">https://duckdb.org/docs/api/r#dbplyr</a> . Some more useful examples can be found here <a href="https://arrow-user2022.netlify.app/data-wrangling#combining-arrow-with-duckdb">https://arrow-user2022.netlify.app/data-wrangling#combining-arrow-with-duckdb</a> . You may also use <code>arrow</code> package to work with parquet files <a href="https://arrow.apache.org/docs/r/">https://arrow.apache.org/docs/r/</a>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_convert(
  type = c("od", "origin-destination", "os", "overnight_stays", "nt", "number_of_trips"),
  zones = c("districts", "dist", "distr", "distritos", "municipalities", "muni",
    "municip", "municipios"),
  dates = NULL,
  save_format = "duckdb",
  save_path = NULL,
  overwrite = FALSE,
  data_dir = spod_get_data_dir(),
  quiet = FALSE,
  max_mem_gb = max(4, spod_available_ram() - 4),
  max_n_cpu = max(1, parallelly::availableCores() - 1),
  max_download_size_gb = 1,
  ignore_missing_dates = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_convert_+3A_type">type</code></td>
<td>
<p>The type of data to download. Can be <code>"origin-destination"</code> (or ust <code>"od"</code>), or <code>"number_of_trips"</code> (or just <code>"nt"</code>) for v1 data. For v2 data <code>"overnight_stays"</code> (or just <code>"os"</code>) is also available. More data types to be supported in the future. See codebooks for v1 and v2 data in vignettes with <code>spod_codebook(1)</code> and <code>spod_codebook(2)</code> (<a href="#topic+spod_codebook">spod_codebook</a>).</p>
</td></tr>
<tr><td><code id="spod_convert_+3A_zones">zones</code></td>
<td>
<p>The zones for which to download the data. Can be <code>"districts"</code> (or <code>"dist"</code>, <code>"distr"</code>, or the original Spanish <code>"distritos"</code>) or <code>"municipalities"</code> (or <code>"muni"</code>, <code>"municip"</code>, or the original Spanish <code>"municipios"</code>) for both data versions. Additionaly, these can be <code>"large_urban_areas"</code> (or <code>"lua"</code>, or the original Spanish <code>"grandes_areas_urbanas"</code>, or <code>"gau"</code>) for v2 data (2022 onwards).</p>
</td></tr>
<tr><td><code id="spod_convert_+3A_dates">dates</code></td>
<td>
<p>A <code>character</code> or <code>Date</code> vector of dates to process. Kindly keep in mind that v1 and v2 data follow different data collection methodologies and may not be directly comparable. Therefore, do not try to request data from both versions for the same date range. If you need to compare data from both versions, please refer to the respective codebooks and methodology documents. The v1 data covers the period from 2020-02-14 to 2021-05-09, and the v2 data covers the period from 2022-01-01 to the present until further notice. The true dates range is checked against the available data for each version on every function run.
</p>
<p>The possible values can be any of the following:
</p>

<ul>
<li><p> For the <code>spod_get()</code> and <code>spod_convert()</code> functions, the <code>dates</code> can be set to &quot;cached_v1&quot; or &quot;cached_v2&quot; to request data from cached (already previously downloaded) v1 (2020-2021) or v2 (2022 onwards) data. In this case, the function will identify and use all data files that have been downloaded and cached locally, (e.g. using an explicit run of <code>spod_download()</code>, or any data requests made using the <code>spod_get()</code> or <code>spod_convert()</code> functions).
</p>
</li>
<li><p> A single date in ISO (YYYY-MM-DD) or YYYYMMDD format. <code>character</code> or <code>Date</code> object.
</p>
</li>
<li><p> A vector of dates in ISO (YYYY-MM-DD) or YYYYMMDD format. <code>character</code> or <code>Date</code> object. Can be any non-consecutive sequence of dates.
</p>
</li>
<li><p> A date range
</p>

<ul>
<li><p> eigher a <code>character</code> or <code>Date</code> object of length 2 with clearly named elements <code>start</code> and <code>end</code> in ISO (YYYY-MM-DD) or YYYYMMDD format. E.g. <code>c(start = "2020-02-15", end = "2020-02-17")</code>;
</p>
</li>
<li><p> or a <code>character</code> object of the form <code>YYYY-MM-DD_YYYY-MM-DD</code> or <code>YYYYMMDD_YYYYMMDD</code>. For example, <code style="white-space: pre;">&#8288;2020-02-15_2020-02-17&#8288;</code> or <code style="white-space: pre;">&#8288;20200215_20200217&#8288;</code>.
</p>
</li></ul>

</li>
<li><p> A regular expression to match dates in the format <code>YYYYMMDD</code>. <code>character</code> object. For example, <code style="white-space: pre;">&#8288;^202002&#8288;</code> will match all dates in February 2020.
</p>
</li></ul>
</td></tr>
<tr><td><code id="spod_convert_+3A_save_format">save_format</code></td>
<td>
<p>A <code>character</code> vector of length 1 with values &quot;duckdb&quot; or &quot;parquet&quot;. Defaults to &quot;duckdb&quot;. If <code>NULL</code> automatically inferred from the <code>save_path</code> argument. If only <code>save_format</code> is provided, <code>save_path</code> will be set to the default location set in <code>SPANISH_OD_DATA_DIR</code> environment variable using <code>Sys.setenv(SPANISH_OD_DATA_DIR = 'path/to/your/cache/dir')</code> or <a href="#topic+spod_set_data_dir">spod_set_data_dir</a><code>(path = 'path/to/your/cache/dir')</code>. So for v1 data that path would be <code style="white-space: pre;">&#8288;&lt;data_dir&gt;/clean_data/v1/tabular/duckdb/&#8288;</code> or <code style="white-space: pre;">&#8288;&lt;data_dir&gt;/clean_data/v1/tabular/parquet/&#8288;</code>.
</p>
<p>You can also set <code>save_path</code>. If it ends with &quot;.duckdb&quot;, will save to <code>DuckDB</code> database format, if <code>save_path</code> does not end with &quot;.duckdb&quot;, will save to <code>parquet</code> format and will treat the <code>save_path</code> as a path to a folder, not a file, will create necessary hive-style subdirectories in that folder. Hive style looks like <code>year=2020/month=2/day=14</code> and inside each such directory there will be a <code>data_0.parquet</code> file that contains the data for that day.</p>
</td></tr>
<tr><td><code id="spod_convert_+3A_save_path">save_path</code></td>
<td>
<p>A <code>character</code> vector of length 1. The full (not relative) path to a <code>DuckDB</code> database file or <code>parquet</code> folder.
</p>

<ul>
<li><p> If <code>save_path</code> ends with <code>.duckdb</code>, it will be saved as a DuckDB database file. The format argument will be automatically set to <code>save_format='duckdb'</code>.
</p>
</li>
<li><p> If <code>save_path</code> ends with a folder name (e.g. <code style="white-space: pre;">&#8288;/data_dir/clean_data/v1/tabular/parquet/od_distr&#8288;</code> for origin-destination data for district level), the data will be saved as a collection of <code>parquet</code> files in a hive-style directory structure. So the subfolders of <code>od_distr</code> will be <code>year=2020/month=2/day=14</code> and inside each of these folders a single <code>parquet</code> file will be placed containing the data for that day.
</p>
</li>
<li><p> If <code>NULL</code>, uses the default location in <code>data_dir</code> (set by the <code>SPANISH_OD_DATA_DIR</code> environment variable using <code>Sys.setenv(SPANISH_OD_DATA_DIR = 'path/to/your/cache/dir')</code> or or <a href="#topic+spod_set_data_dir">spod_set_data_dir</a><code>(path = 'path/to/your/cache/dir')</code>. Therefore, the default relative path for <code>DuckDB</code> is <code style="white-space: pre;">&#8288;&lt;data_dir&gt;/clean_data/v1/tabular/duckdb/&lt;type&gt;_&lt;zones&gt;.duckdb&#8288;</code> and for <code>parquet</code> files is <code style="white-space: pre;">&#8288;&lt;data_dir&gt;/clean_data/v1/tabular/parquet/&lt;type&gt;_&lt;zones&gt;/&#8288;</code>, where <code>type</code> is the type of data (e.g. 'od', 'os', 'nt', that correspoind to 'origin-destination', 'overnight-stays', 'number-of-trips', etc.) and <code>zones</code> is the name of the geographic zones (e.g. 'distr', 'muni', etc.). See the details below in the function arguments description.
</p>
</li></ul>
</td></tr>
<tr><td><code id="spod_convert_+3A_overwrite">overwrite</code></td>
<td>
<p>A <code>logical</code> or a <code>character</code> vector of length 1. If <code>TRUE</code>, overwrites existing <code>DuckDB</code> or <code>parquet</code> files. Defaults to <code>FALSE</code>. For parquet files can also be set to 'update', so that only parquet files are only created for the dates that have not yet been converted.</p>
</td></tr>
<tr><td><code id="spod_convert_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored. Defaults to the value returned by <code>spod_get_data_dir()</code> which returns the value of the environment variable <code>SPANISH_OD_DATA_DIR</code> or a temporary directory if the variable is not set. To set the data directory, use <a href="#topic+spod_set_data_dir">spod_set_data_dir</a>.</p>
</td></tr>
<tr><td><code id="spod_convert_+3A_quiet">quiet</code></td>
<td>
<p>A <code>logical</code> value indicating whether to suppress messages. Default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="spod_convert_+3A_max_mem_gb">max_mem_gb</code></td>
<td>
<p>The maximum memory to use in GB. A conservative default is 3 GB, which should be enough for resaving the data to <code>DuckDB</code> form a folder of CSV.gz files while being small enough to fit in memory of most even old computers. For data analysis using the already converted data (in <code>DuckDB</code> or Parquet format) or with the raw CSV.gz data, it is recommended to increase it according to available resources.</p>
</td></tr>
<tr><td><code id="spod_convert_+3A_max_n_cpu">max_n_cpu</code></td>
<td>
<p>The maximum number of threads to use. Defaults to the number of available cores minus 1.</p>
</td></tr>
<tr><td><code id="spod_convert_+3A_max_download_size_gb">max_download_size_gb</code></td>
<td>
<p>The maximum download size in gigabytes. Defaults to 1.</p>
</td></tr>
<tr><td><code id="spod_convert_+3A_ignore_missing_dates">ignore_missing_dates</code></td>
<td>
<p>Logical. If <code>TRUE</code>, the function will not raise an error if the some of the specified dates are missing. Any dates that are missing will be skipped, however the data for any valid dates will be acquired. Defaults to <code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Path to saved <code>DuckDB</code> database file or to a folder with <code>parquet</code> files in hive-style directory structure.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

# Set data dir for file downloads
spod_set_data_dir(tempdir())

# download and convert data
dates_1 &lt;- c(start = "2020-02-17", end = "2020-02-18")
db_2 &lt;- spod_convert(
 type = "number_of_trips",
 zones = "distr",
 dates = dates_1,
 overwrite = TRUE
)

# now connect to the converted data
my_od_data_2 &lt;- spod_connect(db_2)

# disconnect from the database
spod_disconnect(my_od_data_2)


</code></pre>

<hr>
<h2 id='spod_convert_dates_to_ranges'>Convert dates to ranges</h2><span id='topic+spod_convert_dates_to_ranges'></span>

<h3>Description</h3>

<p>This internal helper function reduces a vector of dates to a vector of date ranges to shorten the warning and error messages that mention the valid date ranges.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_convert_dates_to_ranges(dates)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_convert_dates_to_ranges_+3A_dates">dates</code></td>
<td>
<p>A <code>character</code> vector of dates.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>character</code> vector of date ranges.
</p>

<hr>
<h2 id='spod_dates_argument_to_dates_seq'>Convert multiple formates of date arguments to a sequence of dates</h2><span id='topic+spod_dates_argument_to_dates_seq'></span>

<h3>Description</h3>

<p>This function processes the date arguments provided to various functions in the package. It can handle single dates and arbitratry sequences (vectors) of dates in ISO (YYYY-MM-DD) and YYYYMMDD format. It can also handle date ranges in the format 'YYYY-MM-DD_YYYY-MM-DD' (or 'YYYYMMDD_YYYYMMDD'), date ranges in named vec and regular expressions to match dates in the format <code>YYYYMMDD</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_dates_argument_to_dates_seq(dates)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_dates_argument_to_dates_seq_+3A_dates">dates</code></td>
<td>
<p>A <code>character</code> or <code>Date</code> vector of dates to process. Kindly keep in mind that v1 and v2 data follow different data collection methodologies and may not be directly comparable. Therefore, do not try to request data from both versions for the same date range. If you need to compare data from both versions, please refer to the respective codebooks and methodology documents. The v1 data covers the period from 2020-02-14 to 2021-05-09, and the v2 data covers the period from 2022-01-01 to the present until further notice. The true dates range is checked against the available data for each version on every function run.
</p>
<p>The possible values can be any of the following:
</p>

<ul>
<li><p> For the <code>spod_get()</code> and <code>spod_convert()</code> functions, the <code>dates</code> can be set to &quot;cached_v1&quot; or &quot;cached_v2&quot; to request data from cached (already previously downloaded) v1 (2020-2021) or v2 (2022 onwards) data. In this case, the function will identify and use all data files that have been downloaded and cached locally, (e.g. using an explicit run of <code>spod_download()</code>, or any data requests made using the <code>spod_get()</code> or <code>spod_convert()</code> functions).
</p>
</li>
<li><p> A single date in ISO (YYYY-MM-DD) or YYYYMMDD format. <code>character</code> or <code>Date</code> object.
</p>
</li>
<li><p> A vector of dates in ISO (YYYY-MM-DD) or YYYYMMDD format. <code>character</code> or <code>Date</code> object. Can be any non-consecutive sequence of dates.
</p>
</li>
<li><p> A date range
</p>

<ul>
<li><p> eigher a <code>character</code> or <code>Date</code> object of length 2 with clearly named elements <code>start</code> and <code>end</code> in ISO (YYYY-MM-DD) or YYYYMMDD format. E.g. <code>c(start = "2020-02-15", end = "2020-02-17")</code>;
</p>
</li>
<li><p> or a <code>character</code> object of the form <code>YYYY-MM-DD_YYYY-MM-DD</code> or <code>YYYYMMDD_YYYYMMDD</code>. For example, <code style="white-space: pre;">&#8288;2020-02-15_2020-02-17&#8288;</code> or <code style="white-space: pre;">&#8288;20200215_20200217&#8288;</code>.
</p>
</li></ul>

</li>
<li><p> A regular expression to match dates in the format <code>YYYYMMDD</code>. <code>character</code> object. For example, <code style="white-space: pre;">&#8288;^202002&#8288;</code> will match all dates in February 2020.
</p>
</li></ul>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>character</code> vector of dates in ISO format (YYYY-MM-DD).
</p>

<hr>
<h2 id='spod_disconnect'>Safely disconnect from data and free memory</h2><span id='topic+spod_disconnect'></span>

<h3>Description</h3>

<p>This function is to ensure that <code>DuckDB</code> connections to CSV.gz files (created via <code>spod_get()</code>), as well as to <code>DuckDB</code> files or folders of <code>parquet</code> files (created via <code>spod_convert()</code>) are closed properly to prevent conflicting connections. Essentially this is just a wrapper around <code>DBI::dbDisconnect()</code> that reaches out into the <code>.$src$con</code> object of the <code>tbl_duckdb_connection</code> connection object that is returned to the user via <code>spod_get()</code> and <code>spod_connect()</code>. After disonnecting the database, it also frees up memory by running <code>gc()</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_disconnect(tbl_con, free_mem = TRUE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_disconnect_+3A_tbl_con">tbl_con</code></td>
<td>
<p>A <code>tbl_duckdb_connection</code> connection object that you get from either <code>spod_get()</code> or <code>spod_connect()</code>.</p>
</td></tr>
<tr><td><code id="spod_disconnect_+3A_free_mem">free_mem</code></td>
<td>
<p>A <code>logical</code>. Whether to free up memory by running <code>gc()</code>. Defaults to <code>TRUE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>No return value, called for side effect of disconnecting from the database and freeing up memory.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

# Set data dir for file downloads
spod_set_data_dir(tempdir())

# basic example
# create a connection to the v1 data without converting
# this creates a duckdb database connection to CSV files
od_distr &lt;- spod_get(
 "od",
 zones = "distr",
 dates = c("2020-03-01", "2020-03-02")
)
# disconnect from the database connection
spod_disconnect(od_distr)

# Advanced example
# download and convert data
dates_1 &lt;- c(start = "2020-02-17", end = "2020-02-19")
db_2 &lt;- spod_convert(
 type = "od",
 zones = "distr",
 dates = dates_1,
 overwrite = TRUE
)

# now connect to the converted data
my_od_data_2 &lt;- spod_connect(db_2)

# disconnect from the database
spod_disconnect(my_od_data_2)


</code></pre>

<hr>
<h2 id='spod_download'>Download the data files of specified type, zones, and dates</h2><span id='topic+spod_download'></span>

<h3>Description</h3>

<p>This function downloads the data files of the specified type, zones, dates and data version.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_download(
  type = c("od", "origin-destination", "os", "overnight_stays", "nt", "number_of_trips"),
  zones = c("districts", "dist", "distr", "distritos", "municipalities", "muni",
    "municip", "municipios", "lua", "large_urban_areas", "gau", "grandes_areas_urbanas"),
  dates = NULL,
  max_download_size_gb = 1,
  data_dir = spod_get_data_dir(),
  quiet = FALSE,
  return_local_file_paths = FALSE,
  ignore_missing_dates = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_download_+3A_type">type</code></td>
<td>
<p>The type of data to download. Can be <code>"origin-destination"</code> (or ust <code>"od"</code>), or <code>"number_of_trips"</code> (or just <code>"nt"</code>) for v1 data. For v2 data <code>"overnight_stays"</code> (or just <code>"os"</code>) is also available. More data types to be supported in the future. See codebooks for v1 and v2 data in vignettes with <code>spod_codebook(1)</code> and <code>spod_codebook(2)</code> (<a href="#topic+spod_codebook">spod_codebook</a>).</p>
</td></tr>
<tr><td><code id="spod_download_+3A_zones">zones</code></td>
<td>
<p>The zones for which to download the data. Can be <code>"districts"</code> (or <code>"dist"</code>, <code>"distr"</code>, or the original Spanish <code>"distritos"</code>) or <code>"municipalities"</code> (or <code>"muni"</code>, <code>"municip"</code>, or the original Spanish <code>"municipios"</code>) for both data versions. Additionaly, these can be <code>"large_urban_areas"</code> (or <code>"lua"</code>, or the original Spanish <code>"grandes_areas_urbanas"</code>, or <code>"gau"</code>) for v2 data (2022 onwards).</p>
</td></tr>
<tr><td><code id="spod_download_+3A_dates">dates</code></td>
<td>
<p>A <code>character</code> or <code>Date</code> vector of dates to process. Kindly keep in mind that v1 and v2 data follow different data collection methodologies and may not be directly comparable. Therefore, do not try to request data from both versions for the same date range. If you need to compare data from both versions, please refer to the respective codebooks and methodology documents. The v1 data covers the period from 2020-02-14 to 2021-05-09, and the v2 data covers the period from 2022-01-01 to the present until further notice. The true dates range is checked against the available data for each version on every function run.
</p>
<p>The possible values can be any of the following:
</p>

<ul>
<li><p> For the <code>spod_get()</code> and <code>spod_convert()</code> functions, the <code>dates</code> can be set to &quot;cached_v1&quot; or &quot;cached_v2&quot; to request data from cached (already previously downloaded) v1 (2020-2021) or v2 (2022 onwards) data. In this case, the function will identify and use all data files that have been downloaded and cached locally, (e.g. using an explicit run of <code>spod_download()</code>, or any data requests made using the <code>spod_get()</code> or <code>spod_convert()</code> functions).
</p>
</li>
<li><p> A single date in ISO (YYYY-MM-DD) or YYYYMMDD format. <code>character</code> or <code>Date</code> object.
</p>
</li>
<li><p> A vector of dates in ISO (YYYY-MM-DD) or YYYYMMDD format. <code>character</code> or <code>Date</code> object. Can be any non-consecutive sequence of dates.
</p>
</li>
<li><p> A date range
</p>

<ul>
<li><p> eigher a <code>character</code> or <code>Date</code> object of length 2 with clearly named elements <code>start</code> and <code>end</code> in ISO (YYYY-MM-DD) or YYYYMMDD format. E.g. <code>c(start = "2020-02-15", end = "2020-02-17")</code>;
</p>
</li>
<li><p> or a <code>character</code> object of the form <code>YYYY-MM-DD_YYYY-MM-DD</code> or <code>YYYYMMDD_YYYYMMDD</code>. For example, <code style="white-space: pre;">&#8288;2020-02-15_2020-02-17&#8288;</code> or <code style="white-space: pre;">&#8288;20200215_20200217&#8288;</code>.
</p>
</li></ul>

</li>
<li><p> A regular expression to match dates in the format <code>YYYYMMDD</code>. <code>character</code> object. For example, <code style="white-space: pre;">&#8288;^202002&#8288;</code> will match all dates in February 2020.
</p>
</li></ul>
</td></tr>
<tr><td><code id="spod_download_+3A_max_download_size_gb">max_download_size_gb</code></td>
<td>
<p>The maximum download size in gigabytes. Defaults to 1.</p>
</td></tr>
<tr><td><code id="spod_download_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored. Defaults to the value returned by <code>spod_get_data_dir()</code> which returns the value of the environment variable <code>SPANISH_OD_DATA_DIR</code> or a temporary directory if the variable is not set. To set the data directory, use <a href="#topic+spod_set_data_dir">spod_set_data_dir</a>.</p>
</td></tr>
<tr><td><code id="spod_download_+3A_quiet">quiet</code></td>
<td>
<p>A <code>logical</code> value indicating whether to suppress messages. Default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="spod_download_+3A_return_local_file_paths">return_local_file_paths</code></td>
<td>
<p>Logical. If <code>TRUE</code>, the function returns a character vector of the paths to the downloaded files. If <code>FALSE</code>, the function returns <code>NULL</code>.</p>
</td></tr>
<tr><td><code id="spod_download_+3A_ignore_missing_dates">ignore_missing_dates</code></td>
<td>
<p>Logical. If <code>TRUE</code>, the function will not raise an error if the some of the specified dates are missing. Any dates that are missing will be skipped, however the data for any valid dates will be acquired. Defaults to <code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Nothing. If <code>return_local_file_paths = TRUE</code>, a <code>character</code> vector of the paths to the downloaded files.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>


# Set data dir for file downloads
spod_set_data_dir(tempdir())

# Download the number of trips on district level for the a date range in March 2020
spod_download(
  type = "number_of_trips", zones = "districts",
  dates = c(start = "2020-03-20", end = "2020-03-21")
)

# Download the number of trips on district level for select dates in 2020 and 2021
spod_download(
  type = "number_of_trips", zones = "dist",
  dates = c("2020-03-20", "2020-03-24", "2021-03-20", "2021-03-24")
)

# Download the number of trips on municipality level using regex for a date range in March 2020
# (the regex will capture the dates 2020-03-20 to 2020-03-24)
spod_download(
  type = "number_of_trips", zones = "municip",
  dates = "2020032[0-4]"
)


</code></pre>

<hr>
<h2 id='spod_download_zones_v1'>Downloads and extracts the raw v1 zones data</h2><span id='topic+spod_download_zones_v1'></span>

<h3>Description</h3>

<p>This function ensures that the necessary v1 raw data for zones files are downloaded and extracted from the specified data directory.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_download_zones_v1(
  zones = c("districts", "dist", "distr", "distritos", "municipalities", "muni",
    "municip", "municipios"),
  data_dir = spod_get_data_dir(),
  quiet = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_download_zones_v1_+3A_zones">zones</code></td>
<td>
<p>The zones for which to download the data. Can be <code>"districts"</code> (or <code>"dist"</code>, <code>"distr"</code>, or the original Spanish <code>"distritos"</code>) or <code>"municipalities"</code> (or <code>"muni"</code>, <code>"municip"</code>, or the original Spanish <code>"municipios"</code>).</p>
</td></tr>
<tr><td><code id="spod_download_zones_v1_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored.</p>
</td></tr>
<tr><td><code id="spod_download_zones_v1_+3A_quiet">quiet</code></td>
<td>
<p>Boolean flag to control the display of messages.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>character</code> string containing the path to the downloaded and extracted file.
</p>

<hr>
<h2 id='spod_duckdb_create_province_enum'>Create province names ENUM in a duckdb connection</h2><span id='topic+spod_duckdb_create_province_enum'></span>

<h3>Description</h3>

<p>Create province names ENUM in a duckdb connection
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_duckdb_create_province_enum(con)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_duckdb_create_province_enum_+3A_con">con</code></td>
<td>
<p>A <code>duckdb</code> connection.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>duckdb</code> connection with <code>INE_PROV_NAME_ENUM</code> and <code>INE_PROV_CODE_ENUM</code> created.
</p>

<hr>
<h2 id='spod_duckdb_filter_by_dates'>Filter a duckdb conenction by dates</h2><span id='topic+spod_duckdb_filter_by_dates'></span>

<h3>Description</h3>

<p>IMPORTANT: This function assumes that the table or view that is being filtered has separate <code>year</code>, <code>month</code> and <code>day</code> columns with integer values. This is done so that the filtering is faster on CSV files that are stored in a folder structure with hive-style <code style="white-space: pre;">&#8288;/year=2020/month=2/day=14/&#8288;</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_duckdb_filter_by_dates(con, source_view_name, new_view_name, dates)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_duckdb_filter_by_dates_+3A_con">con</code></td>
<td>
<p>A duckdb connection</p>
</td></tr>
<tr><td><code id="spod_duckdb_filter_by_dates_+3A_source_view_name">source_view_name</code></td>
<td>
<p>The name of the source duckdb &quot;view&quot; (the virtual table, in the context of current package likely connected to a folder of CSV files)</p>
</td></tr>
<tr><td><code id="spod_duckdb_filter_by_dates_+3A_new_view_name">new_view_name</code></td>
<td>
<p>The name of the new duckdb &quot;view&quot; (the virtual table, in the context of current package likely connected to a folder of CSV files).</p>
</td></tr>
<tr><td><code id="spod_duckdb_filter_by_dates_+3A_dates">dates</code></td>
<td>
<p>A <code>character</code> or <code>Date</code> vector of dates to process. Kindly keep in mind that v1 and v2 data follow different data collection methodologies and may not be directly comparable. Therefore, do not try to request data from both versions for the same date range. If you need to compare data from both versions, please refer to the respective codebooks and methodology documents. The v1 data covers the period from 2020-02-14 to 2021-05-09, and the v2 data covers the period from 2022-01-01 to the present until further notice. The true dates range is checked against the available data for each version on every function run.
</p>
<p>The possible values can be any of the following:
</p>

<ul>
<li><p> For the <code>spod_get()</code> and <code>spod_convert()</code> functions, the <code>dates</code> can be set to &quot;cached_v1&quot; or &quot;cached_v2&quot; to request data from cached (already previously downloaded) v1 (2020-2021) or v2 (2022 onwards) data. In this case, the function will identify and use all data files that have been downloaded and cached locally, (e.g. using an explicit run of <code>spod_download()</code>, or any data requests made using the <code>spod_get()</code> or <code>spod_convert()</code> functions).
</p>
</li>
<li><p> A single date in ISO (YYYY-MM-DD) or YYYYMMDD format. <code>character</code> or <code>Date</code> object.
</p>
</li>
<li><p> A vector of dates in ISO (YYYY-MM-DD) or YYYYMMDD format. <code>character</code> or <code>Date</code> object. Can be any non-consecutive sequence of dates.
</p>
</li>
<li><p> A date range
</p>

<ul>
<li><p> eigher a <code>character</code> or <code>Date</code> object of length 2 with clearly named elements <code>start</code> and <code>end</code> in ISO (YYYY-MM-DD) or YYYYMMDD format. E.g. <code>c(start = "2020-02-15", end = "2020-02-17")</code>;
</p>
</li>
<li><p> or a <code>character</code> object of the form <code>YYYY-MM-DD_YYYY-MM-DD</code> or <code>YYYYMMDD_YYYYMMDD</code>. For example, <code style="white-space: pre;">&#8288;2020-02-15_2020-02-17&#8288;</code> or <code style="white-space: pre;">&#8288;20200215_20200217&#8288;</code>.
</p>
</li></ul>

</li>
<li><p> A regular expression to match dates in the format <code>YYYYMMDD</code>. <code>character</code> object. For example, <code style="white-space: pre;">&#8288;^202002&#8288;</code> will match all dates in February 2020.
</p>
</li></ul>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>duckdb</code> connection with original views and a new filtered view.
</p>

<hr>
<h2 id='spod_duckdb_limit_resources'>Set maximum memory and number of threads for a <code>DuckDB</code> connection</h2><span id='topic+spod_duckdb_limit_resources'></span>

<h3>Description</h3>

<p>Set maximum memory and number of threads for a <code>DuckDB</code> connection
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_duckdb_limit_resources(
  con,
  max_mem_gb = max(4, spod_available_ram() - 4),
  max_n_cpu = parallelly::availableCores() - 1
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_duckdb_limit_resources_+3A_con">con</code></td>
<td>
<p>A <code>duckdb</code> connection</p>
</td></tr>
<tr><td><code id="spod_duckdb_limit_resources_+3A_max_mem_gb">max_mem_gb</code></td>
<td>
<p>The maximum memory to use in GB. A conservative default is 3 GB, which should be enough for resaving the data to <code>DuckDB</code> form a folder of CSV.gz files while being small enough to fit in memory of most even old computers. For data analysis using the already converted data (in <code>DuckDB</code> or Parquet format) or with the raw CSV.gz data, it is recommended to increase it according to available resources.</p>
</td></tr>
<tr><td><code id="spod_duckdb_limit_resources_+3A_max_n_cpu">max_n_cpu</code></td>
<td>
<p>The maximum number of threads to use. Defaults to the number of available cores minus 1.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>duckdb</code> connection.
</p>

<hr>
<h2 id='spod_duckdb_number_of_trips'>Create a duckdb number of trips table</h2><span id='topic+spod_duckdb_number_of_trips'></span>

<h3>Description</h3>

<p>This function creates a duckdb connection to the number of trips data stored in a folder of CSV.gz files.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_duckdb_number_of_trips(
  con = DBI::dbConnect(duckdb::duckdb(), dbdir = ":memory:", read_only = FALSE),
  zones = c("districts", "dist", "distr", "distritos", "municipalities", "muni",
    "municip", "municipios", "lua", "large_urban_areas", "gau", "grandes_areas_urbanas"),
  ver = NULL,
  data_dir = spod_get_data_dir()
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_duckdb_number_of_trips_+3A_con">con</code></td>
<td>
<p>A duckdb connection object. If not specified, a new in-memory connection will be created.</p>
</td></tr>
<tr><td><code id="spod_duckdb_number_of_trips_+3A_zones">zones</code></td>
<td>
<p>The zones for which to download the data. Can be <code>"districts"</code> (or <code>"dist"</code>, <code>"distr"</code>, or the original Spanish <code>"distritos"</code>) or <code>"municipalities"</code> (or <code>"muni"</code>, <code>"municip"</code>, or the original Spanish <code>"municipios"</code>) for both data versions. Additionaly, these can be <code>"large_urban_areas"</code> (or <code>"lua"</code>, or the original Spanish <code>"grandes_areas_urbanas"</code>, or <code>"gau"</code>) for v2 data (2022 onwards).</p>
</td></tr>
<tr><td><code id="spod_duckdb_number_of_trips_+3A_ver">ver</code></td>
<td>
<p>Integer. Can be 1 or 2. The version of the data to use. v1 spans 2020-2021, v2 covers 2022 and onwards.</p>
</td></tr>
<tr><td><code id="spod_duckdb_number_of_trips_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored. Defaults to the value returned by <code>spod_get_data_dir()</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>duckdb</code> connection object with 2 views:
</p>

<ul>
<li> <p><code>od_csv_raw</code> - a raw table view of all cached CSV files with the origin-destination data that has been previously cached in $SPANISH_OD_DATA_DIR
</p>
</li>
<li> <p><code>od_csv_clean</code> - a cleaned-up table view of <code>od_csv_raw</code> with column names and values translated and mapped to English. This still includes all cached data.
</p>
</li></ul>


<hr>
<h2 id='spod_duckdb_od'>Creates a duckdb connection to origin-destination data</h2><span id='topic+spod_duckdb_od'></span>

<h3>Description</h3>

<p>This function creates a duckdb connection to the origin-destination data stored in CSV.gz files.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_duckdb_od(
  con = DBI::dbConnect(duckdb::duckdb(), dbdir = ":memory:", read_only = FALSE),
  zones = c("districts", "dist", "distr", "distritos", "municipalities", "muni",
    "municip", "municipios", "lua", "large_urban_areas", "gau", "grandes_areas_urbanas"),
  ver = NULL,
  data_dir = spod_get_data_dir()
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_duckdb_od_+3A_con">con</code></td>
<td>
<p>A duckdb connection object. If not specified, a new in-memory connection will be created.</p>
</td></tr>
<tr><td><code id="spod_duckdb_od_+3A_zones">zones</code></td>
<td>
<p>The zones for which to download the data. Can be <code>"districts"</code> (or <code>"dist"</code>, <code>"distr"</code>, or the original Spanish <code>"distritos"</code>) or <code>"municipalities"</code> (or <code>"muni"</code>, <code>"municip"</code>, or the original Spanish <code>"municipios"</code>) for both data versions. Additionaly, these can be <code>"large_urban_areas"</code> (or <code>"lua"</code>, or the original Spanish <code>"grandes_areas_urbanas"</code>, or <code>"gau"</code>) for v2 data (2022 onwards).</p>
</td></tr>
<tr><td><code id="spod_duckdb_od_+3A_ver">ver</code></td>
<td>
<p>Integer. Can be 1 or 2. The version of the data to use. v1 spans 2020-2021, v2 covers 2022 and onwards.</p>
</td></tr>
<tr><td><code id="spod_duckdb_od_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored. Defaults to the value returned by <code>spod_get_data_dir()</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>duckdb</code> connection object with 2 views:
</p>

<ul>
<li> <p><code>od_csv_raw</code> - a raw table view of all cached CSV files with the origin-destination data that has been previously cached in $SPANISH_OD_DATA_DIR
</p>
</li>
<li> <p><code>od_csv_clean</code> - a cleaned-up table view of <code>od_csv_raw</code> with column names and values translated and mapped to English. This still includes all cached data.
</p>
</li></ul>

<p>The structure of the cleaned-up views <code>od_csv_clean</code> is as follows:
</p>

<dl>
<dt>date</dt><dd><p><code>Date</code>. The full date of the trip, including year, month, and day.</p>
</dd>
<dt>id_origin</dt><dd><p><code>factor</code>. The identifier for the origin location of the trip, formatted as a code (e.g., '01001_AM').</p>
</dd>
<dt>id_destination</dt><dd><p><code>factor</code>. The identifier for the destination location of the trip, formatted as a code (e.g., '01001_AM').</p>
</dd>
<dt>activity_origin</dt><dd><p><code>factor</code>. The type of activity at the origin location (e.g., 'home', 'work'). <strong>Note:</strong> Only available for district level data.</p>
</dd>
<dt>activity_destination</dt><dd><p><code>factor</code>. The type of activity at the destination location (e.g., 'home', 'other'). <strong>Note:</strong> Only available for district level data.</p>
</dd>
<dt>residence_province_ine_code</dt><dd><p><code>factor</code>. The province of residence for the group of individual making the trip, encoded according to the INE classification. <strong>Note:</strong> Only available for district level data.</p>
</dd>
<dt>residence_province_name</dt><dd><p><code>factor</code>. The province of residence for the group of individuals making the trip (e.g., 'Cuenca', 'Girona'). <strong>Note:</strong> Only available for district level data.</p>
</dd>
<dt>time_slot</dt><dd><p><code>integer</code>. The time slot (the hour of the day) during which the trip started, represented as an integer (e.g., 0, 1, 2).</p>
</dd>
<dt>distance</dt><dd><p><code>factor</code>. The distance category of the trip, represented as a code (e.g., '002-005' for 2-5 km).</p>
</dd>
<dt>n_trips</dt><dd><p><code>double</code>. The number of trips taken within the specified time slot and distance.</p>
</dd>
<dt>trips_total_length_km</dt><dd><p><code>double</code>. The total length of all trips in kilometers for the specified time slot and distance.</p>
</dd>
<dt>year</dt><dd><p><code>double</code>. The year of the trip.</p>
</dd>
<dt>month</dt><dd><p><code>double</code>. The month of the trip.</p>
</dd>
<dt>day</dt><dd><p><code>double</code>. The day of the trip.</p>
</dd>
</dl>

<p>The structure of the original data in <code>od_csv_raw</code> is as follows:
</p>

<dl>
<dt>fecha</dt><dd><p><code>Date</code>. The date of the trip, including year, month, and day.</p>
</dd>
<dt>origen</dt><dd><p><code>character</code>. The identifier for the origin location of the trip, formatted as a character string (e.g., '01001_AM').</p>
</dd>
<dt>destino</dt><dd><p><code>character</code>. The identifier for the destination location of the trip, formatted as a character string (e.g., '01001_AM').</p>
</dd>
<dt>actividad_origen</dt><dd><p><code>character</code>. The type of activity at the origin location (e.g., 'casa', 'trabajo').</p>
</dd>
<dt>actividad_destino</dt><dd><p><code>character</code>. The type of activity at the destination location (e.g., 'otros', 'trabajo').</p>
</dd>
<dt>residencia</dt><dd><p><code>character</code>. The code representing the residence of the individual making the trip (e.g., '01') according to the official INE classification.</p>
</dd>
<dt>edad</dt><dd><p><code>character</code>. The age of the individual making the trip. This data is actaully filled with 'NA' values, which is why this column is removed in the cleaned-up and translated view described above.</p>
</dd>
<dt>periodo</dt><dd><p><code>integer</code>. The time period during which the trip started, represented as an integer (e.g., 0, 1, 2).</p>
</dd>
<dt>distancia</dt><dd><p><code>character</code>. The distance category of the trip, represented as a character string (e.g., '002-005' for 2-5 km).</p>
</dd>
<dt>viajes</dt><dd><p><code>double</code>. The number of trips taken within the specified time period and distance.</p>
</dd>
<dt>viajes_km</dt><dd><p><code>double</code>. The total length of all trips in kilometers for the specified time period and distance.</p>
</dd>
<dt>day</dt><dd><p><code>double</code>. The day of the trip.</p>
</dd>
<dt>month</dt><dd><p><code>double</code>. The month of the trip.</p>
</dd>
<dt>year</dt><dd><p><code>double</code>. The year of the trip.</p>
</dd>
</dl>


<hr>
<h2 id='spod_duckdb_overnight_stays'>Create a duckdb overnight stays table</h2><span id='topic+spod_duckdb_overnight_stays'></span>

<h3>Description</h3>

<p>This function creates a duckdb connection to the overnight stays data stored in a folder of CSV.gz files.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_duckdb_overnight_stays(
  con = DBI::dbConnect(duckdb::duckdb(), dbdir = ":memory:", read_only = FALSE),
  zones = c("districts", "dist", "distr", "distritos", "municipalities", "muni",
    "municip", "municipios", "lua", "large_urban_areas", "gau", "grandes_areas_urbanas"),
  ver = NULL,
  data_dir = spod_get_data_dir()
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_duckdb_overnight_stays_+3A_con">con</code></td>
<td>
<p>A duckdb connection object. If not specified, a new in-memory connection will be created.</p>
</td></tr>
<tr><td><code id="spod_duckdb_overnight_stays_+3A_zones">zones</code></td>
<td>
<p>The zones for which to download the data. Can be <code>"districts"</code> (or <code>"dist"</code>, <code>"distr"</code>, or the original Spanish <code>"distritos"</code>) or <code>"municipalities"</code> (or <code>"muni"</code>, <code>"municip"</code>, or the original Spanish <code>"municipios"</code>) for both data versions. Additionaly, these can be <code>"large_urban_areas"</code> (or <code>"lua"</code>, or the original Spanish <code>"grandes_areas_urbanas"</code>, or <code>"gau"</code>) for v2 data (2022 onwards).</p>
</td></tr>
<tr><td><code id="spod_duckdb_overnight_stays_+3A_ver">ver</code></td>
<td>
<p>Integer. Can be 1 or 2. The version of the data to use. v1 spans 2020-2021, v2 covers 2022 and onwards.</p>
</td></tr>
<tr><td><code id="spod_duckdb_overnight_stays_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored. Defaults to the value returned by <code>spod_get_data_dir()</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>duckdb</code> connection object with 2 views:
</p>

<ul>
<li> <p><code>od_csv_raw</code> - a raw table view of all cached CSV files with the origin-destination data that has been previously cached in $SPANISH_OD_DATA_DIR
</p>
</li>
<li> <p><code>od_csv_clean</code> - a cleaned-up table view of <code>od_csv_raw</code> with column names and values translated and mapped to English. This still includes all cached data.
</p>
</li></ul>


<hr>
<h2 id='spod_duckdb_set_temp'>Set temp file for DuckDB connection</h2><span id='topic+spod_duckdb_set_temp'></span>

<h3>Description</h3>

<p>Set temp file for DuckDB connection
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_duckdb_set_temp(con, temp_path = spod_get_temp_dir())
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_duckdb_set_temp_+3A_con">con</code></td>
<td>
<p>A duckdb connection</p>
</td></tr>
<tr><td><code id="spod_duckdb_set_temp_+3A_temp_path">temp_path</code></td>
<td>
<p>The path to the temp folder for DuckDB for <a href="https://duckdb.org/2024/07/09/memory-management.html#intermediate-spilling">intermediate spilling</a> in case the set memory limit and/or physical memory of the computer is too low to perform the query. By default this is set to the <code>temp</code> directory in the data folder defined by SPANISH_OD_DATA_DIR environment variable. Otherwise, for queries on folders of CSV files or parquet files, the temporary path would be set to the current R working directory, which probably is undesirable, as the current working directory can be on a slow storage, or storage that may have limited space, compared to the data folder.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>duckdb</code> connection.
</p>

<hr>
<h2 id='spod_expand_dates_from_regex'>Function to expand dates from a regex</h2><span id='topic+spod_expand_dates_from_regex'></span>

<h3>Description</h3>

<p>This function generates a sequence of dates from a regular expression pattern based on the provided regular expression.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_expand_dates_from_regex(date_regex)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_expand_dates_from_regex_+3A_date_regex">date_regex</code></td>
<td>
<p>A regular expression to match dates in the format 'yyyymmdd'.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>character</code> vector of dates matching the regex.
</p>

<hr>
<h2 id='spod_files_sizes'>Get files sizes for remote files of v1 and v2 data and save them into a csv.gz file in the inst/extdata folder.</h2><span id='topic+spod_files_sizes'></span>

<h3>Description</h3>

<p>Get files sizes for remote files of v1 and v2 data and save them into a csv.gz file in the inst/extdata folder.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_files_sizes(ver = 2)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_files_sizes_+3A_ver">ver</code></td>
<td>
<p>The version of the data (1 or 2). Can be both. Defaults to 2, as v1 data is not being updated since 2021.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Nothing. Only saves a csv.gz file with up to date file sizes in the inst/extdata folder.
</p>

<hr>
<h2 id='spod_get'>Get tabular mobility data</h2><span id='topic+spod_get'></span>

<h3>Description</h3>

<p>This function creates a DuckDB lazy table connection object from the specified type and zones. It checks for missing data and downloads it if necessary. The connnection is made to the raw CSV files in gzip archives, so analysing the data through this connection may be slow if you select more than a few days. You can manipulate this object using <code>dplyr</code> functions such as <a href="dplyr.html#topic+select">select</a>, <a href="dplyr.html#topic+filter">filter</a>, <a href="dplyr.html#topic+mutate">mutate</a>, <a href="dplyr.html#topic+group_by">group_by</a>, <a href="dplyr.html#topic+summarise">summarise</a>, etc. In the end of any sequence of commands you will need to add <a href="dplyr.html#topic+collect">collect</a> to execute the whole chain of data manipulations and load the results into memory in an R <code>data.frame</code>/<code>tibble</code>. See codebooks for v1 and v2 data in vignettes with <a href="#topic+spod_codebook">spod_codebook</a>(1) and <a href="#topic+spod_codebook">spod_codebook</a>(2).
</p>
<p>If you want to analyse longer periods of time (especiially several months or even the whole data over several years), consider using the <a href="#topic+spod_convert">spod_convert</a> and then <a href="#topic+spod_connect">spod_connect</a>.
</p>
<p>If you want to quickly get the origin-destination data with flows aggregated for a single day at municipal level and without any extra socio-economic variables, consider using the <a href="#topic+spod_quick_get_od">spod_quick_get_od</a> function.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_get(
  type = c("od", "origin-destination", "os", "overnight_stays", "nt", "number_of_trips"),
  zones = c("districts", "dist", "distr", "distritos", "municipalities", "muni",
    "municip", "municipios", "lua", "large_urban_areas", "gau", "grandes_areas_urbanas"),
  dates = NULL,
  data_dir = spod_get_data_dir(),
  quiet = FALSE,
  max_mem_gb = max(4, spod_available_ram() - 4),
  max_n_cpu = parallelly::availableCores() - 1,
  max_download_size_gb = 1,
  duckdb_target = ":memory:",
  temp_path = spod_get_temp_dir(),
  ignore_missing_dates = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_get_+3A_type">type</code></td>
<td>
<p>The type of data to download. Can be <code>"origin-destination"</code> (or ust <code>"od"</code>), or <code>"number_of_trips"</code> (or just <code>"nt"</code>) for v1 data. For v2 data <code>"overnight_stays"</code> (or just <code>"os"</code>) is also available. More data types to be supported in the future. See codebooks for v1 and v2 data in vignettes with <code>spod_codebook(1)</code> and <code>spod_codebook(2)</code> (<a href="#topic+spod_codebook">spod_codebook</a>).</p>
</td></tr>
<tr><td><code id="spod_get_+3A_zones">zones</code></td>
<td>
<p>The zones for which to download the data. Can be <code>"districts"</code> (or <code>"dist"</code>, <code>"distr"</code>, or the original Spanish <code>"distritos"</code>) or <code>"municipalities"</code> (or <code>"muni"</code>, <code>"municip"</code>, or the original Spanish <code>"municipios"</code>) for both data versions. Additionaly, these can be <code>"large_urban_areas"</code> (or <code>"lua"</code>, or the original Spanish <code>"grandes_areas_urbanas"</code>, or <code>"gau"</code>) for v2 data (2022 onwards).</p>
</td></tr>
<tr><td><code id="spod_get_+3A_dates">dates</code></td>
<td>
<p>A <code>character</code> or <code>Date</code> vector of dates to process. Kindly keep in mind that v1 and v2 data follow different data collection methodologies and may not be directly comparable. Therefore, do not try to request data from both versions for the same date range. If you need to compare data from both versions, please refer to the respective codebooks and methodology documents. The v1 data covers the period from 2020-02-14 to 2021-05-09, and the v2 data covers the period from 2022-01-01 to the present until further notice. The true dates range is checked against the available data for each version on every function run.
</p>
<p>The possible values can be any of the following:
</p>

<ul>
<li><p> For the <code>spod_get()</code> and <code>spod_convert()</code> functions, the <code>dates</code> can be set to &quot;cached_v1&quot; or &quot;cached_v2&quot; to request data from cached (already previously downloaded) v1 (2020-2021) or v2 (2022 onwards) data. In this case, the function will identify and use all data files that have been downloaded and cached locally, (e.g. using an explicit run of <code>spod_download()</code>, or any data requests made using the <code>spod_get()</code> or <code>spod_convert()</code> functions).
</p>
</li>
<li><p> A single date in ISO (YYYY-MM-DD) or YYYYMMDD format. <code>character</code> or <code>Date</code> object.
</p>
</li>
<li><p> A vector of dates in ISO (YYYY-MM-DD) or YYYYMMDD format. <code>character</code> or <code>Date</code> object. Can be any non-consecutive sequence of dates.
</p>
</li>
<li><p> A date range
</p>

<ul>
<li><p> eigher a <code>character</code> or <code>Date</code> object of length 2 with clearly named elements <code>start</code> and <code>end</code> in ISO (YYYY-MM-DD) or YYYYMMDD format. E.g. <code>c(start = "2020-02-15", end = "2020-02-17")</code>;
</p>
</li>
<li><p> or a <code>character</code> object of the form <code>YYYY-MM-DD_YYYY-MM-DD</code> or <code>YYYYMMDD_YYYYMMDD</code>. For example, <code style="white-space: pre;">&#8288;2020-02-15_2020-02-17&#8288;</code> or <code style="white-space: pre;">&#8288;20200215_20200217&#8288;</code>.
</p>
</li></ul>

</li>
<li><p> A regular expression to match dates in the format <code>YYYYMMDD</code>. <code>character</code> object. For example, <code style="white-space: pre;">&#8288;^202002&#8288;</code> will match all dates in February 2020.
</p>
</li></ul>
</td></tr>
<tr><td><code id="spod_get_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored. Defaults to the value returned by <code>spod_get_data_dir()</code> which returns the value of the environment variable <code>SPANISH_OD_DATA_DIR</code> or a temporary directory if the variable is not set. To set the data directory, use <a href="#topic+spod_set_data_dir">spod_set_data_dir</a>.</p>
</td></tr>
<tr><td><code id="spod_get_+3A_quiet">quiet</code></td>
<td>
<p>A <code>logical</code> value indicating whether to suppress messages. Default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="spod_get_+3A_max_mem_gb">max_mem_gb</code></td>
<td>
<p>The maximum memory to use in GB. A conservative default is 3 GB, which should be enough for resaving the data to <code>DuckDB</code> form a folder of CSV.gz files while being small enough to fit in memory of most even old computers. For data analysis using the already converted data (in <code>DuckDB</code> or Parquet format) or with the raw CSV.gz data, it is recommended to increase it according to available resources.</p>
</td></tr>
<tr><td><code id="spod_get_+3A_max_n_cpu">max_n_cpu</code></td>
<td>
<p>The maximum number of threads to use. Defaults to the number of available cores minus 1.</p>
</td></tr>
<tr><td><code id="spod_get_+3A_max_download_size_gb">max_download_size_gb</code></td>
<td>
<p>The maximum download size in gigabytes. Defaults to 1.</p>
</td></tr>
<tr><td><code id="spod_get_+3A_duckdb_target">duckdb_target</code></td>
<td>
<p>(Optional) The path to the duckdb file to save the data to, if a convertation from CSV is reuqested by the <code>spod_convert</code> function. If not specified, it will be set to &quot;:memory:&quot; and the data will be stored in memory.</p>
</td></tr>
<tr><td><code id="spod_get_+3A_temp_path">temp_path</code></td>
<td>
<p>The path to the temp folder for DuckDB for <a href="https://duckdb.org/2024/07/09/memory-management.html#intermediate-spilling">intermediate spilling</a> in case the set memory limit and/or physical memory of the computer is too low to perform the query. By default this is set to the <code>temp</code> directory in the data folder defined by SPANISH_OD_DATA_DIR environment variable. Otherwise, for queries on folders of CSV files or parquet files, the temporary path would be set to the current R working directory, which probably is undesirable, as the current working directory can be on a slow storage, or storage that may have limited space, compared to the data folder.</p>
</td></tr>
<tr><td><code id="spod_get_+3A_ignore_missing_dates">ignore_missing_dates</code></td>
<td>
<p>Logical. If <code>TRUE</code>, the function will not raise an error if the some of the specified dates are missing. Any dates that are missing will be skipped, however the data for any valid dates will be acquired. Defaults to <code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A DuckDB lazy table connection object of class <code>tbl_duckdb_connection</code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>


# create a connection to the v1 data
spod_set_data_dir(tempdir())
dates &lt;- c("2020-02-14", "2020-03-14", "2021-02-14", "2021-02-14", "2021-02-15")
nt_dist &lt;- spod_get(type = "number_of_trips", zones = "distr", dates = dates)

# nt_dist is a table view filtered to the specified dates

# for advanced users only
# access the source connection with all dates
# list tables
DBI::dbListTables(nt_dist$src$con)

# disconnect
spod_disconnect(nt_dist)


</code></pre>

<hr>
<h2 id='spod_get_data_dir'>Get the data directory</h2><span id='topic+spod_get_data_dir'></span>

<h3>Description</h3>

<p>This function retrieves the data directory from the environment variable SPANISH_OD_DATA_DIR.
If the environment variable is not set, it returns the temporary directory.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_get_data_dir(quiet = FALSE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_get_data_dir_+3A_quiet">quiet</code></td>
<td>
<p>A <code>logical</code> value indicating whether to suppress messages. Default is <code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>character</code> vector of length 1 containing the path to the data directory where the package will download and convert the data.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>spod_set_data_dir(tempdir())
spod_get_data_dir()

</code></pre>

<hr>
<h2 id='spod_get_file_size_from_url'>Get file size from URL</h2><span id='topic+spod_get_file_size_from_url'></span>

<h3>Description</h3>

<p>Get file size from URL
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_get_file_size_from_url(x_url)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_get_file_size_from_url_+3A_x_url">x_url</code></td>
<td>
<p>URL</p>
</td></tr>
</table>


<h3>Value</h3>

<p>File size in MB
</p>

<hr>
<h2 id='spod_get_latest_v1_file_list'>Get latest file list from the XML for MITMA open mobility data v1 (2020-2021)</h2><span id='topic+spod_get_latest_v1_file_list'></span>

<h3>Description</h3>

<p>Get latest file list from the XML for MITMA open mobility data v1 (2020-2021)
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_get_latest_v1_file_list(
  data_dir = spod_get_data_dir(),
  xml_url = "https://opendata-movilidad.mitma.es/RSS.xml"
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_get_latest_v1_file_list_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored. Defaults to the value returned by <code>spod_get_data_dir()</code>.</p>
</td></tr>
<tr><td><code id="spod_get_latest_v1_file_list_+3A_xml_url">xml_url</code></td>
<td>
<p>The URL of the XML file to download. Defaults to &quot;https://opendata-movilidad.mitma.es/RSS.xml&quot;.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>The path to the downloaded XML file.
</p>

<hr>
<h2 id='spod_get_latest_v2_file_list'>Get latest file list from the XML for MITMA open mobility data v2 (2022 onwards)</h2><span id='topic+spod_get_latest_v2_file_list'></span>

<h3>Description</h3>

<p>Get latest file list from the XML for MITMA open mobility data v2 (2022 onwards)
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_get_latest_v2_file_list(
  data_dir = spod_get_data_dir(),
  xml_url = "https://movilidad-opendata.mitma.es/RSS.xml"
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_get_latest_v2_file_list_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored. Defaults to the value returned by <code>spod_get_data_dir()</code>.</p>
</td></tr>
<tr><td><code id="spod_get_latest_v2_file_list_+3A_xml_url">xml_url</code></td>
<td>
<p>The URL of the XML file to download. Defaults to &quot;https://movilidad-opendata.mitma.es/RSS.xml&quot;.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>The path to the downloaded XML file.
</p>

<hr>
<h2 id='spod_get_temp_dir'>Get temporary directory for DuckDB intermediate spilling</h2><span id='topic+spod_get_temp_dir'></span>

<h3>Description</h3>

<p>Get the The path to the temp folder for DuckDB for <a href="https://duckdb.org/2024/07/09/memory-management.html#intermediate-spilling">intermediate spilling</a> in case the set memory limit and/or physical memory of the computer is too low to perform the query.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_get_temp_dir(data_dir = spod_get_data_dir())
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_get_temp_dir_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored. Defaults to the value returned by <code>spod_get_data_dir()</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>character</code> string with the path to the temp folder for <code>DuckDB</code> for <a href="https://duckdb.org/2024/07/09/memory-management.html#intermediate-spilling">intermediate spilling</a>.
</p>

<hr>
<h2 id='spod_get_valid_dates'>Get valid dates for the specified data version</h2><span id='topic+spod_get_valid_dates'></span>

<h3>Description</h3>

<p>Get valid dates for the specified data version
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_get_valid_dates(ver = NULL)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_get_valid_dates_+3A_ver">ver</code></td>
<td>
<p>Integer. Can be 1 or 2. The version of the data to use. v1 spans 2020-2021, v2 covers 2022 and onwards.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A vector of type <code>Date</code> with all possible valid dates for the specified data version (v1 for 2020-2021 and v2 for 2020 onwards).
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

# Get all valid dates for v1 (2020-2021) data
spod_get_valid_dates(ver = 1)

# Get all valid dates for v2 (2020 onwards) data
spod_get_valid_dates(ver = 2)


</code></pre>

<hr>
<h2 id='spod_get_zones'>Get zones</h2><span id='topic+spod_get_zones'></span>

<h3>Description</h3>

<p>Get spatial zones for the specified data version. Supports both v1 (2020-2021) and v2 (2022 onwards) data.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_get_zones(
  zones = c("districts", "dist", "distr", "distritos", "municipalities", "muni",
    "municip", "municipios", "lua", "large_urban_areas", "gau", "grandes_areas_urbanas"),
  ver = NULL,
  data_dir = spod_get_data_dir(),
  quiet = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_get_zones_+3A_zones">zones</code></td>
<td>
<p>The zones for which to download the data. Can be <code>"districts"</code> (or <code>"dist"</code>, <code>"distr"</code>, or the original Spanish <code>"distritos"</code>) or <code>"municipalities"</code> (or <code>"muni"</code>, <code>"municip"</code>, or the original Spanish <code>"municipios"</code>) for both data versions. Additionaly, these can be <code>"large_urban_areas"</code> (or <code>"lua"</code>, or the original Spanish <code>"grandes_areas_urbanas"</code>, or <code>"gau"</code>) for v2 data (2022 onwards).</p>
</td></tr>
<tr><td><code id="spod_get_zones_+3A_ver">ver</code></td>
<td>
<p>Integer. Can be 1 or 2. The version of the data to use. v1 spans 2020-2021, v2 covers 2022 and onwards.</p>
</td></tr>
<tr><td><code id="spod_get_zones_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored. Defaults to the value returned by <code>spod_get_data_dir()</code> which returns the value of the environment variable <code>SPANISH_OD_DATA_DIR</code> or a temporary directory if the variable is not set. To set the data directory, use <a href="#topic+spod_set_data_dir">spod_set_data_dir</a>.</p>
</td></tr>
<tr><td><code id="spod_get_zones_+3A_quiet">quiet</code></td>
<td>
<p>A <code>logical</code> value indicating whether to suppress messages. Default is <code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An <code>sf</code> object (Simple Feature collection).
</p>
<p>The columns for v1 (2020-2021) data include:
</p>

<dl>
<dt>id</dt><dd><p>A character vector containing the unique identifier for each district, assigned by the data provider. This <code>id</code> matches the <code>id_origin</code>, <code>id_destination</code>, and <code>id</code> in district-level origin-destination and number of trips data.</p>
</dd>
<dt>census_districts</dt><dd><p>A string with semicolon-separated identifiers of census districts classified by the Spanish Statistical Office (INE) that are spatially bound within the polygons for each <code>id</code>.</p>
</dd>
<dt>municipalities_mitma</dt><dd><p>A string with semicolon-separated municipality identifiers (as assigned by the data provider) corresponding to each district <code>id</code>.</p>
</dd>
<dt>municipalities</dt><dd><p>A string with semicolon-separated municipality identifiers classified by the Spanish Statistical Office (INE) corresponding to each <code>id</code>.</p>
</dd>
<dt>district_names_in_v2/municipality_names_in_v2</dt><dd><p>A string with semicolon-separated district names (from the v2 version of this data) corresponding to each district <code>id</code> in v1.</p>
</dd>
<dt>district_ids_in_v2/municipality_ids_in_v2</dt><dd><p>A string with semicolon-separated district identifiers (from the v2 version of this data) corresponding to each district <code>id</code> in v1.</p>
</dd>
<dt>geometry</dt><dd><p>A <code>MULTIPOLYGON</code> column containing the spatial geometry of each district, stored as an sf object. The geometry is projected in the ETRS89 / UTM zone 30N coordinate reference system (CRS), with XY dimensions.</p>
</dd>
</dl>

<p>The columns for v2 (2022 onwards) data include:
</p>

<dl>
<dt>id</dt><dd><p>A character vector containing the unique identifier for each zone, assigned by the data provider.</p>
</dd>
<dt>name</dt><dd><p>A character vector with the name of each district.</p>
</dd>
<dt>population</dt><dd><p>A numeric vector representing the population of each district (as of 2022).</p>
</dd>
<dt>census_sections</dt><dd><p>A string with semicolon-separated identifiers of census sections corresponding to each district.</p>
</dd>
<dt>census_districts</dt><dd><p>A string with semicolon-separated identifiers of census districts as classified by the Spanish Statistical Office (INE) corresponding to each district.</p>
</dd>
<dt>municipalities</dt><dd><p>A string with semicolon-separated identifiers of municipalities classified by the Spanish Statistical Office (INE) corresponding to each district.</p>
</dd>
<dt>municipalities_mitma</dt><dd><p>A string with semicolon-separated identifiers of municipalities, as assigned by the data provider, that correspond to each district.</p>
</dd>
<dt>luas_mitma</dt><dd><p>A string with semicolon-separated identifiers of LUAs (Local Urban Areas) from the provider, associated with each district.</p>
</dd>
<dt>district_ids_in_v1/municipality_ids_in_v1</dt><dd><p>A string with semicolon-separated district identifiers from v1 data corresponding to each district in v2. If no match exists, it is marked as <code>NA</code>.</p>
</dd>
<dt>geometry</dt><dd><p>A <code>MULTIPOLYGON</code> column containing the spatial geometry of each district, stored as an sf object. The geometry is projected in the ETRS89 / UTM zone 30N coordinate reference system (CRS), with XY dimensions.</p>
</dd>
</dl>



<h3>Examples</h3>

<pre><code class='language-R'>

# get polygons for municipalities for the v2 data
municip_v2 &lt;- spod_get_zones(zones = "municipalities", ver = 2)

# get polygons for the districts for the v1 data
distr_v1 &lt;- spod_get_zones(zones = "districts", ver = 1)


</code></pre>

<hr>
<h2 id='spod_get_zones_v1'>Retrieves the zones for v1 data</h2><span id='topic+spod_get_zones_v1'></span>

<h3>Description</h3>

<p>This function retrieves the zones data from the specified data directory.
It can retrieve either &quot;distritos&quot; or &quot;municipios&quot; zones data.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_get_zones_v1(
  zones = c("districts", "dist", "distr", "distritos", "municipalities", "muni",
    "municip", "municipios"),
  data_dir = spod_get_data_dir(),
  quiet = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_get_zones_v1_+3A_zones">zones</code></td>
<td>
<p>The zones for which to download the data. Can be <code>"districts"</code> (or <code>"dist"</code>, <code>"distr"</code>, or the original Spanish <code>"distritos"</code>) or <code>"municipalities"</code> (or <code>"muni"</code>, <code>"municip"</code>, or the original Spanish <code>"municipios"</code>).</p>
</td></tr>
<tr><td><code id="spod_get_zones_v1_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored.</p>
</td></tr>
<tr><td><code id="spod_get_zones_v1_+3A_quiet">quiet</code></td>
<td>
<p>A <code>logical</code> value indicating whether to suppress messages. Default is <code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An <code>sf</code> object (Simple Feature collection) with 2 fields:
</p>

<dl>
<dt>id</dt><dd><p>A character vector containing the unique identifier for each zone, to be matched with identifiers in the tabular data.</p>
</dd>
<dt>geometry</dt><dd><p>A <code>MULTIPOLYGON</code> column containing the spatial geometry of each zone, stored as an sf object.
The geometry is projected in the ETRS89 / UTM zone 30N coordinate reference system (CRS), with XY dimensions.</p>
</dd>
</dl>


<hr>
<h2 id='spod_get_zones_v2'>Retrieves the zones v2 data</h2><span id='topic+spod_get_zones_v2'></span>

<h3>Description</h3>

<p>This function retrieves the zones data from the specified data directory.
It can retrieve either &quot;distritos&quot; or &quot;municipios&quot; zones data.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_get_zones_v2(
  zones = c("districts", "dist", "distr", "distritos", "municipalities", "muni",
    "municip", "municipios", "lua", "large_urban_areas", "gau", "grandes_areas_urbanas"),
  data_dir = spod_get_data_dir(),
  quiet = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_get_zones_v2_+3A_zones">zones</code></td>
<td>
<p>The zones for which to download the data. Can be <code>"districts"</code> (or <code>"dist"</code>, <code>"distr"</code>, or the original Spanish <code>"distritos"</code>) or <code>"municipalities"</code> (or <code>"muni"</code>, <code>"municip"</code>, or the original Spanish <code>"municipios"</code>).</p>
</td></tr>
<tr><td><code id="spod_get_zones_v2_+3A_data_dir">data_dir</code></td>
<td>
<p>The directory where the data is stored.</p>
</td></tr>
<tr><td><code id="spod_get_zones_v2_+3A_quiet">quiet</code></td>
<td>
<p>A <code>logical</code> value indicating whether to suppress messages. Default is <code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An <code>sf</code> object (Simple Feature collection) with 4 fields:
</p>

<dl>
<dt>id</dt><dd><p>A character vector containing the unique identifier for each zone, to be matched with identifiers in the tabular data.</p>
</dd>
<dt>name</dt><dd><p>A character vector with the name of the zone.</p>
</dd>
<dt>population</dt><dd><p>A numeric vector representing the population of each zone (as of 2022).</p>
</dd>
<dt>geometry</dt><dd><p>A <code>MULTIPOLYGON</code> column containing the spatial geometry of each zone, stored as an sf object.
The geometry is projected in the ETRS89 / UTM zone 30N coordinate reference system (CRS), with XY dimensions.</p>
</dd>
</dl>


<hr>
<h2 id='spod_infer_data_v_from_dates'>Infer data version from dates</h2><span id='topic+spod_infer_data_v_from_dates'></span>

<h3>Description</h3>

<p>Infer data version from dates
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_infer_data_v_from_dates(dates, ignore_missing_dates = FALSE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_infer_data_v_from_dates_+3A_dates">dates</code></td>
<td>
<p>A <code>character</code> or <code>Date</code> vector of dates to process. Kindly keep in mind that v1 and v2 data follow different data collection methodologies and may not be directly comparable. Therefore, do not try to request data from both versions for the same date range. If you need to compare data from both versions, please refer to the respective codebooks and methodology documents. The v1 data covers the period from 2020-02-14 to 2021-05-09, and the v2 data covers the period from 2022-01-01 to the present until further notice. The true dates range is checked against the available data for each version on every function run.
</p>
<p>The possible values can be any of the following:
</p>

<ul>
<li><p> For the <code>spod_get()</code> and <code>spod_convert()</code> functions, the <code>dates</code> can be set to &quot;cached_v1&quot; or &quot;cached_v2&quot; to request data from cached (already previously downloaded) v1 (2020-2021) or v2 (2022 onwards) data. In this case, the function will identify and use all data files that have been downloaded and cached locally, (e.g. using an explicit run of <code>spod_download()</code>, or any data requests made using the <code>spod_get()</code> or <code>spod_convert()</code> functions).
</p>
</li>
<li><p> A single date in ISO (YYYY-MM-DD) or YYYYMMDD format. <code>character</code> or <code>Date</code> object.
</p>
</li>
<li><p> A vector of dates in ISO (YYYY-MM-DD) or YYYYMMDD format. <code>character</code> or <code>Date</code> object. Can be any non-consecutive sequence of dates.
</p>
</li>
<li><p> A date range
</p>

<ul>
<li><p> eigher a <code>character</code> or <code>Date</code> object of length 2 with clearly named elements <code>start</code> and <code>end</code> in ISO (YYYY-MM-DD) or YYYYMMDD format. E.g. <code>c(start = "2020-02-15", end = "2020-02-17")</code>;
</p>
</li>
<li><p> or a <code>character</code> object of the form <code>YYYY-MM-DD_YYYY-MM-DD</code> or <code>YYYYMMDD_YYYYMMDD</code>. For example, <code style="white-space: pre;">&#8288;2020-02-15_2020-02-17&#8288;</code> or <code style="white-space: pre;">&#8288;20200215_20200217&#8288;</code>.
</p>
</li></ul>

</li>
<li><p> A regular expression to match dates in the format <code>YYYYMMDD</code>. <code>character</code> object. For example, <code style="white-space: pre;">&#8288;^202002&#8288;</code> will match all dates in February 2020.
</p>
</li></ul>
</td></tr>
<tr><td><code id="spod_infer_data_v_from_dates_+3A_ignore_missing_dates">ignore_missing_dates</code></td>
<td>
<p>Logical. If <code>TRUE</code>, the function will not raise an error if the some of the specified dates are missing. Any dates that are missing will be skipped, however the data for any valid dates will be acquired. Defaults to <code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An <code>integer</code> indicating the inferred data version.
</p>

<hr>
<h2 id='spod_is_data_version_overlaps'>Check if specified dates span both data versions</h2><span id='topic+spod_is_data_version_overlaps'></span>

<h3>Description</h3>

<p>This function checks if the specified dates or date ranges span both v1 and v2 data versions.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_is_data_version_overlaps(dates)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_is_data_version_overlaps_+3A_dates">dates</code></td>
<td>
<p>A <code>Dates</code> vector of dates to check.</p>
</td></tr>
</table>


<h3>Value</h3>

<p><code>TRUE</code> if the dates span both data versions, <code>FALSE</code> otherwise.
</p>

<hr>
<h2 id='spod_match_data_type'>Match data types for normalisation</h2><span id='topic+spod_match_data_type'></span>

<h3>Description</h3>

<p>Match data types for normalisation
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_match_data_type(
  type = c("od", "origin-destination", "viajes", "os", "overnight_stays",
    "pernoctaciones", "nt", "number_of_trips", "personas")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_match_data_type_+3A_type">type</code></td>
<td>
<p>The type of data to match. Can be &quot;od&quot;, &quot;origin-destination&quot;, &quot;os&quot;, &quot;overnight_stays&quot;, or &quot;nt&quot;, &quot;number_of_trips&quot;.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>character</code> string with the folder name for the specified data type. Or <code>NULL</code> if the type is not recognized.
</p>

<hr>
<h2 id='spod_match_data_type_for_local_folders'>Match data types to folders</h2><span id='topic+spod_match_data_type_for_local_folders'></span>

<h3>Description</h3>

<p>Match data types to folders
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_match_data_type_for_local_folders(
  type = c("od", "origin-destination", "os", "overnight_stays", "nt", "number_of_trips"),
  ver = c(1, 2)
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_match_data_type_for_local_folders_+3A_ver">ver</code></td>
<td>
<p>Integer. Can be 1 or 2. The version of the data to use. v1 spans 2020-2021, v2 covers 2022 and onwards.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>character</code> string with the folder name for the specified data type. Or <code>NULL</code> if the data type is not recognized.
</p>

<hr>
<h2 id='spod_quick_get_od'>Get daily trip counts per origin-destionation municipality from 2022 onward</h2><span id='topic+spod_quick_get_od'></span>

<h3>Description</h3>

<p>This function provides a quick way to get daily aggregated (no hourly data) trip counts per origin-destination municipality from v2 data (2022 onward). Compared to <a href="#topic+spod_get">spod_get</a>, which downloads large CSV files, this function downloads the data directly from the GraphQL API. No data aggregation is performed on your computer (unlike in <a href="#topic+spod_get">spod_get</a>), so you do not need to worry about memory usage and do not have to use a powerful computer with multiple CPU cores just to get this simple data. Only about 1 MB of data is downloaded for a single day. The limitation of this function is that it can only retrieve data for a single day at a time and only with total number of trips and total km travelled. So it is not possible to get any of the extra variables available in the full dataset via <a href="#topic+spod_get">spod_get</a>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_quick_get_od(
  date = NA,
  min_trips = 100,
  distances = c("500m-2km", "2-10km", "10-50km", "50+km"),
  id_origin = NA,
  id_destination = NA
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_quick_get_od_+3A_date">date</code></td>
<td>
<p>A character or Date object specifying the date for which to retrieve the data. If date is a character, the date must be in &quot;YYYY-MM-DD&quot; or &quot;YYYYMMDD&quot; format.</p>
</td></tr>
<tr><td><code id="spod_quick_get_od_+3A_min_trips">min_trips</code></td>
<td>
<p>A numeric value specifying the minimum number of journeys per origin-destination pair to retrieve. Defaults to 100 to reduce the amount of data returned. Can be set to 0 to retrieve all data.</p>
</td></tr>
<tr><td><code id="spod_quick_get_od_+3A_distances">distances</code></td>
<td>
<p>A character vector specifying the distances to retrieve. Valid values are &quot;500m-2km&quot;, &quot;2-10km&quot;, &quot;10-50km&quot;, and &quot;50+km&quot;. Defaults to <code>c("500m-2km", "2-10km", "10-50km", "50+km")</code>. The resulting data will not have number of trips per category of distance. Therefore, if you want to retrieve the number of trips per distance category, you need to make 4 separate calls to this function or use <code>spod_get()</code> instead to get the full data from source CSV files.</p>
</td></tr>
<tr><td><code id="spod_quick_get_od_+3A_id_origin">id_origin</code></td>
<td>
<p>A character vector specifying the origin municipalities to retrieve. If not provided, all origin municipalities will be included. Valid municipality IDs can be found in the dataset returned by <code>spod_get_zones(zones = "muni", ver = 2)</code>.</p>
</td></tr>
<tr><td><code id="spod_quick_get_od_+3A_id_destination">id_destination</code></td>
<td>
<p>A character vector specifying the target municipalities to retrieve. If not provided, all target municipalities will be included. Valid municipality IDs can be found in the dataset returned by <code>spod_get_zones(zones = "muni", ver = 2)</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>tibble</code> containing the flows for the specified date, minimum number of journeys, distances and origin-destination pairs if specified. The columns are:
</p>

<dl>
<dt>date</dt><dd><p>The date of the trips.</p>
</dd>
<dt>id_origin</dt><dd><p>The origin municipality ID.</p>
</dd>
<dt>id_destination</dt><dd><p>The target municipality ID.</p>
</dd>
<dt>n_trips</dt><dd><p>The number of trips between the origin and target municipality.</p>
</dd>
<dt>trips_total_length_km</dt><dd><p>The total length of trips in kilometers.</p>
</dd>
</dl>



<h3>Examples</h3>

<pre><code class='language-R'>

od_1000 &lt;- spod_quick_get_od(
  date = "2022-01-01",
  min_trips = 1000
)



</code></pre>

<hr>
<h2 id='spod_read_sql'>Load an SQL query, glue it, dplyr::sql it</h2><span id='topic+spod_read_sql'></span>

<h3>Description</h3>

<p>Load an SQL query from a specified file in package installation directory, glue::collapse it, glue::glue it in case of any variables that need to be replaced, and dplyr::sql it for additional safety.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_read_sql(sql_file_name)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_read_sql_+3A_sql_file_name">sql_file_name</code></td>
<td>
<p>The name of the SQL file to load from the package installation directory.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Text of the SQL query of class <code>sql</code>/<code>character</code>.
</p>

<hr>
<h2 id='spod_set_data_dir'>Set the data directory</h2><span id='topic+spod_set_data_dir'></span>

<h3>Description</h3>

<p>This function sets the data directory in the environment variable SPANISH_OD_DATA_DIR, so that all other functions in the package can access the data. It also creates the directory if it doesn't exist.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_set_data_dir(data_dir, quiet = FALSE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_set_data_dir_+3A_data_dir">data_dir</code></td>
<td>
<p>The data directory to set.</p>
</td></tr>
<tr><td><code id="spod_set_data_dir_+3A_quiet">quiet</code></td>
<td>
<p>A <code>logical</code> value indicating whether to suppress messages. Default is <code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Nothing. If quiet is <code>FALSE</code>, prints a message with the path and confirmation that the path exists.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>spod_set_data_dir(tempdir())

</code></pre>

<hr>
<h2 id='spod_sql_where_dates'>Generate a WHERE part of an SQL query from a sequence of dates</h2><span id='topic+spod_sql_where_dates'></span>

<h3>Description</h3>

<p>Generate a WHERE part of an SQL query from a sequence of dates
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_sql_where_dates(dates)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_sql_where_dates_+3A_dates">dates</code></td>
<td>
<p>A Dates vector of dates to process.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A character vector of the SQL query.
</p>

<hr>
<h2 id='spod_subfolder_clean_data_cache'>Get clean data subfolder name</h2><span id='topic+spod_subfolder_clean_data_cache'></span>

<h3>Description</h3>

<p>Change subfolder name in the code of this function for clean data cache here to apply globally, as all functions in the package should use this function to get the clean data cache path.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_subfolder_clean_data_cache(ver = 1)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_subfolder_clean_data_cache_+3A_ver">ver</code></td>
<td>
<p>Integer. Can be 1 or 2. The version of the data to use. v1 spans 2020-2021, v2 covers 2022 and onwards.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>character</code> string with the subfolder name for the clean data cache.
</p>

<hr>
<h2 id='spod_subfolder_metadata_cache'>Get metadata cache subfolder name</h2><span id='topic+spod_subfolder_metadata_cache'></span>

<h3>Description</h3>

<p>Change subfolder name in the code of this function for metadata cache here to apply globally, as all functions in the package should use this function to get the metadata cache path.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_subfolder_metadata_cache()
</code></pre>


<h3>Value</h3>

<p>A <code>character</code> string with the subfolder name for the raw data cache.
</p>

<hr>
<h2 id='spod_subfolder_raw_data_cache'>Get raw data cache subfolder name</h2><span id='topic+spod_subfolder_raw_data_cache'></span>

<h3>Description</h3>

<p>Change subfolder name in the code of this function for raw data cache here to apply globally, as all functions in the package should use this function to get the raw data cache path.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_subfolder_raw_data_cache(ver = 1)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_subfolder_raw_data_cache_+3A_ver">ver</code></td>
<td>
<p>Integer. Can be 1 or 2. The version of the data to use. v1 spans 2020-2021, v2 covers 2022 and onwards.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>character</code> string with the subfolder name for the raw data cache.
</p>

<hr>
<h2 id='spod_unique_separated_ids'>Remove duplicate values in a semicolon-separated string</h2><span id='topic+spod_unique_separated_ids'></span>

<h3>Description</h3>

<p>Remove duplicate IDs in a semicolon-separated string in a selected column in a data frame
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_unique_separated_ids(column)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_unique_separated_ids_+3A_column">column</code></td>
<td>
<p>A <code>character</code> vector column in a data frame to remove duplicates from.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>character</code> vector with semicolon-separated unique IDs.
</p>

<hr>
<h2 id='spod_zone_names_en2es'>Translate zone names from English to Spanish</h2><span id='topic+spod_zone_names_en2es'></span>

<h3>Description</h3>

<p>Translate zone names from English to Spanish
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spod_zone_names_en2es(
  zones = c("districts", "dist", "distr", "distritos", "municipalities", "muni",
    "municip", "municipios", "lua", "large_urban_areas", "gau", "grandes_areas_urbanas")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="spod_zone_names_en2es_+3A_zones">zones</code></td>
<td>
<p>The zones for which to download the data. Can be <code>"districts"</code> (or <code>"dist"</code>, <code>"distr"</code>, or the original Spanish <code>"distritos"</code>) or <code>"municipalities"</code> (or <code>"muni"</code>, <code>"municip"</code>, or the original Spanish <code>"municipios"</code>) for both data versions. Additionaly, these can be <code>"large_urban_areas"</code> (or <code>"lua"</code>, or the original Spanish <code>"grandes_areas_urbanas"</code>, or <code>"gau"</code>) for v2 data (2022 onwards).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>character</code> string with the translated zone name. Or <code>NULL</code> if the zone name is not recognized.
</p>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
