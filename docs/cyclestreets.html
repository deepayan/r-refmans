<!DOCTYPE html><html><head><title>Help for package cyclestreets</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {cyclestreets}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#+25+26gt+3B+25'><p>Pipe operator</p></a></li>
<li><a href='#batch'><p>Interface to CycleStreets Batch Routing API</p></a></li>
<li><a href='#batch_multi'><p>Batch routing for multiple plans and large datasets</p></a></li>
<li><a href='#cyclestreets_column_names'><p>Prices of 50,000 round cut diamonds.</p></a></li>
<li><a href='#journey'><p>Plan a journey with CycleStreets.net</p></a></li>
<li><a href='#journey2'><p>Plan a journey with CycleStreets.net</p></a></li>
<li><a href='#json2sf_cs'><p>Quickly convert output from CycleStreets.net into sf object</p></a></li>
<li><a href='#ltns'><p>Download data on 'Low Traffic Neighbourhoods' or 'rat runs' from CycleStreets</p></a></li>
<li><a href='#smooth_with_cutoffs'><p>Identify and smooth-out anomalous gradient values</p></a></li>
<li><a href='#ways'><p>Download data on 'Ways' with cyclability (quietness) ratings</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Cycle Routing and Data for Cycling Advocacy</td>
</tr>
<tr>
<td>Version:</td>
<td>1.0.1</td>
</tr>
<tr>
<td>Description:</td>
<td>An interface to the cycle routing/data services provided by
    'CycleStreets', a not-for-profit social enterprise and advocacy
    organisation.  The application programming interfaces (APIs) provided
    by 'CycleStreets' are documented at
    (<a href="https://www.cyclestreets.net/api/">https://www.cyclestreets.net/api/</a>).  The focus of this package is
    the journey planning API, which aims to emulate the routes taken by a
    knowledgeable cyclist.  An innovative feature of the routing service
    of its provision of fastest, quietest and balanced profiles.  These
    represent routes taken to minimise time, avoid traffic and compromise
    between the two, respectively.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a></td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://rpackage.cyclestreets.net/">https://rpackage.cyclestreets.net/</a>,
<a href="https://github.com/cyclestreets/cyclestreets-r">https://github.com/cyclestreets/cyclestreets-r</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/cyclestreets/cyclestreets-r/issues">https://github.com/cyclestreets/cyclestreets-r/issues</a></td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 3.6.0)</td>
</tr>
<tr>
<td>Imports:</td>
<td>checkmate, curl, dplyr, data.table, geojsonsf, httr, jsonlite,
magrittr, progressr, RcppSimdJson, readr, sf, stringr, stringi</td>
</tr>
<tr>
<td>Suggests:</td>
<td>covr, od, stplanr</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>LazyData:</td>
<td>true</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.2.3</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2023-08-14 15:49:07 UTC; robin</td>
</tr>
<tr>
<td>Author:</td>
<td>Robin Lovelace <a href="https://orcid.org/0000-0001-5679-6536"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre],
  Martin Lucas-Smith [aut],
  Eric Krueger [ctb],
  Joey Talbot <a href="https://orcid.org/0000-0002-6520-4560"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [aut],
  Malcolm Morgan <a href="https://orcid.org/0000-0002-9488-9183"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [ctb]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Robin Lovelace &lt;rob00x@gmail.com&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2023-08-15 07:20:14 UTC</td>
</tr>
</table>
<hr>
<h2 id='+25+26gt+3B+25'>Pipe operator</h2><span id='topic++25+3E+25'></span>

<h3>Description</h3>

<p>See <code>magrittr::<a href="magrittr.html#topic++25+3E+25">%&gt;%</a></code> for details.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>lhs %&gt;% rhs
</code></pre>

<hr>
<h2 id='batch'>Interface to CycleStreets Batch Routing API</h2><span id='topic+batch'></span>

<h3>Description</h3>

<p>Note: set <code>CYCLESTREETS_BATCH</code>, <code>CYCLESTREETS_PW</code> and <code>CYCLESTREETS_PW</code>
environment variables, e.g. with <code>usethis::edit_r_environ()</code>
before trying this.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>batch(
  desire_lines = NULL,
  id = NULL,
  directory = tempdir(),
  wait = FALSE,
  wait_time = NULL,
  name = "Batch job",
  serverId = 21,
  strategies = "quietest",
  bothDirections = 0,
  minDistance = 50,
  maxDistance = 5000,
  filename = "test",
  includeJsonOutput = 1,
  emailOnCompletion = "you@example.com",
  username = Sys.getenv("CYCLESTREETS_UN"),
  password = Sys.getenv("CYCLESTREETS_PW"),
  base_url = "https://api.cyclestreets.net/v2/batchroutes.createjob",
  pat = Sys.getenv("CYCLESTREETS_BATCH"),
  silent = TRUE,
  delete_job = TRUE,
  cols_to_keep = c("id", "name", "provisionName", "distances", "time", "quietness",
    "gradient_smooth"),
  segments = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="batch_+3A_desire_lines">desire_lines</code></td>
<td>
<p>Geographic desire lines representing origin-destination data</p>
</td></tr>
<tr><td><code id="batch_+3A_id">id</code></td>
<td>
<p>int
Batch job ID, as returned from batchroutes.createjob.
action string (start|pause|continue|terminate)
Action to take. Available actions are:
start: Start (open) job
pause: Pause job
continue: Continue (re-open) job
terminate: Terminate job and delete data</p>
</td></tr>
<tr><td><code id="batch_+3A_directory">directory</code></td>
<td>
<p>Where to save the data? <code>tempdir()</code> by default</p>
</td></tr>
<tr><td><code id="batch_+3A_wait">wait</code></td>
<td>
<p>Should the process block your R session but return a route?
FALSE by default.</p>
</td></tr>
<tr><td><code id="batch_+3A_wait_time">wait_time</code></td>
<td>
<p>How long to wait before getting the data in seconds?
NULL by default, meaning it will be calculated by the private function
<code>wait_s()</code>.</p>
</td></tr>
<tr><td><code id="batch_+3A_name">name</code></td>
<td>
<p>The name of the batch routing job for CycleStreets</p>
</td></tr>
<tr><td><code id="batch_+3A_serverid">serverId</code></td>
<td>
<p>The server ID to use (21 by default)</p>
</td></tr>
<tr><td><code id="batch_+3A_strategies">strategies</code></td>
<td>
<p>Route plan types, e.g. <code>"fastest"</code></p>
</td></tr>
<tr><td><code id="batch_+3A_bothdirections">bothDirections</code></td>
<td>
<p>int (1|0)
Whether to plan in both directions, i.e. A-B as well as B-A.
0, meaning only one way routes, is the default in the R default.</p>
</td></tr>
<tr><td><code id="batch_+3A_mindistance">minDistance</code></td>
<td>
<p>Min Euclidean distance of routes to be calculated</p>
</td></tr>
<tr><td><code id="batch_+3A_maxdistance">maxDistance</code></td>
<td>
<p>Maximum Euclidean distance of routes to be calculated</p>
</td></tr>
<tr><td><code id="batch_+3A_filename">filename</code></td>
<td>
<p>Character string</p>
</td></tr>
<tr><td><code id="batch_+3A_includejsonoutput">includeJsonOutput</code></td>
<td>
<p>int (1|0)
Whether to include a column in the resulting CSV data giving the full JSON output from the API, rather than just summary
information like distance and time.</p>
</td></tr>
<tr><td><code id="batch_+3A_emailoncompletion">emailOnCompletion</code></td>
<td>
<p>Email on completion?</p>
</td></tr>
<tr><td><code id="batch_+3A_username">username</code></td>
<td>
<p>string
Your CycleStreets account username. In due course this will be replaced with an OAuth token.</p>
</td></tr>
<tr><td><code id="batch_+3A_password">password</code></td>
<td>
<p>string
Your CycleStreets account password. You can set it with
Sys.setenv(CYCLESTREETS_PW=&quot;xxxxxx&quot;)</p>
</td></tr>
<tr><td><code id="batch_+3A_base_url">base_url</code></td>
<td>
<p>The base url from which to construct API requests
(with default set to main server)</p>
</td></tr>
<tr><td><code id="batch_+3A_pat">pat</code></td>
<td>
<p>The API key used. By default this uses <code>Sys.getenv("CYCLESTREETS")</code>.</p>
</td></tr>
<tr><td><code id="batch_+3A_silent">silent</code></td>
<td>
<p>Logical (default is FALSE). TRUE hides request sent.</p>
</td></tr>
<tr><td><code id="batch_+3A_delete_job">delete_job</code></td>
<td>
<p>Delete the job? TRUE by default to avoid clogged servers</p>
</td></tr>
<tr><td><code id="batch_+3A_cols_to_keep">cols_to_keep</code></td>
<td>
<p>Columns to return in output sf object</p>
</td></tr>
<tr><td><code id="batch_+3A_segments">segments</code></td>
<td>
<p>logical, return segments TRUE/FALSE/&quot;both&quot;</p>
</td></tr>
</table>


<h3>Details</h3>

<p>See https://www.cyclestreets.net/journey/batch/ for web UI.
</p>
<p>Recommneded max batch size: 300k routes
</p>


<h3>Examples</h3>

<pre><code class='language-R'>if(FALSE) {
library(sf)
desire_lines = od::od_to_sf(od::od_data_df, od::od_data_zones)[4:5, 1:3]
u = paste0("https://github.com/cyclestreets/cyclestreets-r/",
  "releases/download/v0.5.3/od-longford-10-test.Rds")
desire_lines = readRDS(url(u))
routes_id = batch(desire_lines, username = "robinlovelace", wait = FALSE)
# Wait for some time, around a minute or 2
routes_wait = batch(id = routes_id, username = "robinlovelace", wait = TRUE, delete_job = FALSE)
names(routes_wait)
plot(routes_wait)
plot(desire_lines$geometry[4])
plot(routes_wait$geometry[routes_wait$route_number == "4"], add = TRUE)
head(routes_wait$route_number)
unique(routes_wait$route_number)
# Job is deleted after this command:
routes_attrib = batch(desire_lines, id = routes_id, username = "robinlovelace", wait = TRUE)
names(routes_attrib)
unique(routes_attrib$route_number)
desire_lines_huge = desire_lines[sample(nrow(desire_lines), 250000, replace = TRUE), ]
routes_id = batch(desire_lines_huge, username = "robinlovelace", wait = FALSE)
names(routes)
plot(routes$geometry)
plot(desire_lines$geometry, add = TRUE, col = "red")
routes = batch(desire_lines, username = "robinlovelace", wait_time = 5)
# profvis::profvis(batch_read("test-data.csv.gz"))
}
</code></pre>

<hr>
<h2 id='batch_multi'>Batch routing for multiple plans and large datasets</h2><span id='topic+batch_multi'></span>

<h3>Description</h3>

<p>Batch routing for multiple plans and large datasets
</p>


<h3>Usage</h3>

<pre><code class='language-R'>batch_multi(
  desire_lines,
  plans = c("fastest", "balanced"),
  nrow_batch = 10000,
  temp_folder = tempdir(),
  batch_ids = NULL,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="batch_multi_+3A_desire_lines">desire_lines</code></td>
<td>
<p>Input desire lines</p>
</td></tr>
<tr><td><code id="batch_multi_+3A_plans">plans</code></td>
<td>
<p>Plans, e.g. fastest</p>
</td></tr>
<tr><td><code id="batch_multi_+3A_nrow_batch">nrow_batch</code></td>
<td>
<p>How many rows per batch?</p>
</td></tr>
<tr><td><code id="batch_multi_+3A_temp_folder">temp_folder</code></td>
<td>
<p>path to folder</p>
</td></tr>
<tr><td><code id="batch_multi_+3A_batch_ids">batch_ids</code></td>
<td>
<p>NULL?</p>
</td></tr>
<tr><td><code id="batch_multi_+3A_...">...</code></td>
<td>
<p>Arguments passed to batch</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list of routes.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>if(FALSE) {
od_df = readr::read_csv("https://github.com/nptscot/npt/raw/main/data-raw/od_subset.csv")
zones = sf::read_sf("https://github.com/nptscot/npt/raw/main/data-raw/zones_edinburgh.geojson")
desire_lines = od::od_to_sf(od_df, zones)
desire_lines = desire_lines[1:100, ]
p = c("fastest", "quietest")
routes_multi = batch_multi(desire_lines, plans = p, nrow_batch = 26, delete_job = FALSE)
names(routes_multi)
plot(routes_multi$fastest$geometry)
plot(routes_multi$quietest$geometry)
ids = list(
  fastest = 4059:(4059+3),
  quietest = 4063:(4063+3)
)
r_ids = batch_multi(desire_lines, plans = p, nrow_batch = 26, delete_job = FALSE, batch_ids = ids)
}
</code></pre>

<hr>
<h2 id='cyclestreets_column_names'>Prices of 50,000 round cut diamonds.</h2><span id='topic+cyclestreets_column_names'></span>

<h3>Description</h3>

<p>Variables provided by CycleStreets in their journey data
</p>


<h3>Usage</h3>

<pre><code class='language-R'>cyclestreets_column_names
</code></pre>


<h3>Format</h3>

<p>An object of class <code>character</code> of length 44.
</p>


<h3>Source</h3>

<p><a href="https://www.cyclestreets.net/">https://www.cyclestreets.net/</a>
</p>

<hr>
<h2 id='journey'>Plan a journey with CycleStreets.net</h2><span id='topic+journey'></span>

<h3>Description</h3>

<p>R interface to the CycleStreets.net journey planning API,
a route planner made by cyclists for cyclists.
See <a href="https://www.cyclestreets.net/api/">cyclestreets.net/api</a> for details.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>journey(
  from,
  to,
  plan = "fastest",
  silent = TRUE,
  pat = NULL,
  base_url = "https://www.cyclestreets.net",
  reporterrors = TRUE,
  save_raw = "FALSE",
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="journey_+3A_from">from</code></td>
<td>
<p>Longitude/Latitude pair, e.g. <code>c(-1.55, 53.80)</code></p>
</td></tr>
<tr><td><code id="journey_+3A_to">to</code></td>
<td>
<p>Longitude/Latitude pair, e.g. <code>c(-1.55, 53.80)</code></p>
</td></tr>
<tr><td><code id="journey_+3A_plan">plan</code></td>
<td>
<p>Text strong of either &quot;fastest&quot; (default), &quot;quietest&quot; or &quot;balanced&quot;</p>
</td></tr>
<tr><td><code id="journey_+3A_silent">silent</code></td>
<td>
<p>Logical (default is FALSE). TRUE hides request sent.</p>
</td></tr>
<tr><td><code id="journey_+3A_pat">pat</code></td>
<td>
<p>The API key used. By default this uses <code>Sys.getenv("CYCLESTREETS")</code>.</p>
</td></tr>
<tr><td><code id="journey_+3A_base_url">base_url</code></td>
<td>
<p>The base url from which to construct API requests
(with default set to main server)</p>
</td></tr>
<tr><td><code id="journey_+3A_reporterrors">reporterrors</code></td>
<td>
<p>Boolean value (TRUE/FALSE) indicating if cyclestreets (TRUE by default).
should report errors (FALSE by default).</p>
</td></tr>
<tr><td><code id="journey_+3A_save_raw">save_raw</code></td>
<td>
<p>Boolean value which returns raw list from the json if TRUE (FALSE by default).</p>
</td></tr>
<tr><td><code id="journey_+3A_...">...</code></td>
<td>
<p>Arguments passed to json2sf_cs</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Requires the internet and a CycleStreets.net API key.
CycleStreets.net does not yet work worldwide.
</p>
<p>You need to have an api key for this code to run.
By default it uses the CYCLESTREETS environment variable.
A quick way to set this is to install the <code>usethis</code> package and then
executing the following command:
</p>
<p><code>usethis::edit_r_environ()</code>
</p>
<p>That should open up a new file in your text editor where you
can add the environment variable as follows
(replace 1a... with your key for this to work):
</p>
<p>CYCLESTREETS=1a43ed677e5e6fe9
</p>
<p>After setting the environment variable, as outlined above,
you need to restart your R session before the journey function will work.
</p>
<p>See <a href="https://www.cyclestreets.net/help/journey/howitworks/">www.cyclestreets.net/help/journey/howitworks/</a>
for details on how these are calculated.
</p>
<p>CycleStreets can give you lots of info at route and segment level.
Commonly useful columns include:
</p>
<div class="sourceCode"><pre>cols = c("name", "provisionName", "time", "quietness", "edition", "gradient_smooth")
</pre></div>
<p>See <code><a href="#topic+json2sf_cs">json2sf_cs()</a></code> for details.
</p>


<h3>See Also</h3>

<p>json2sf_cs
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
from = c(-1.55, 53.80) # geo_code("leeds")
to = c(-1.76, 53.80) # geo_code("bradford uk")
r1 = journey(from, to)
names(r1)
cols = c("name", "provisionName", "distances", "time", "quietness", "edition", "gradient_smooth")
r2 = journey(from, to, cols_to_keep = cols)
names(r2)
r2
r1[1:2, ]
r1$grammesCO2saved
r1$calories
plot(r1[1:4])
plot(r1[10:ncol(r1)])
to = c(-2, 53.5) # towards Manchester
r1 = journey(from, to)
names(r1)
r2 = journey(from, to, plan = "balanced")
plot(r1["quietness"], reset = FALSE)
plot(r2["quietness"], add = TRUE)
r3 = journey(from, to, silent = FALSE)
r4 = journey(from, to, save_raw = TRUE)
r5 = journey(c(-1.524, 53.819), c(-1.556, 53.806))
plot(r5["gradient_segment"])
plot(r5["gradient_smooth"])

u = paste0("https://github.com/cyclestreets/cyclestreets-r/",
  "releases/download/v0.4.0/line_with_single_segment.geojson")
desire_line = sf::read_sf(u)
r = stplanr::route(l = desire_line, route_fun = journey)
r

## End(Not run)
</code></pre>

<hr>
<h2 id='journey2'>Plan a journey with CycleStreets.net</h2><span id='topic+journey2'></span>

<h3>Description</h3>

<p>R interface to the CycleStreets.net journey planning API,
a route planner made by cyclists for cyclists.
See <a href="https://www.cyclestreets.net/api/">cyclestreets.net/api</a> for details.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>journey2(
  fromPlace = NA,
  toPlace = NA,
  id = NULL,
  plan = "fastest",
  pat = NULL,
  base_url = "https://www.cyclestreets.net",
  host_con = 1,
  reporterrors = TRUE,
  segments = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="journey2_+3A_fromplace">fromPlace</code></td>
<td>
<p>sf points, matrix, or vector of lng/lat coordinates</p>
</td></tr>
<tr><td><code id="journey2_+3A_toplace">toPlace</code></td>
<td>
<p>sf points, matrix, or vector of lng/lat coordinates</p>
</td></tr>
<tr><td><code id="journey2_+3A_id">id</code></td>
<td>
<p>a character ID value to be attached to the results</p>
</td></tr>
<tr><td><code id="journey2_+3A_plan">plan</code></td>
<td>
<p>Text strong of either &quot;fastest&quot; (default), &quot;quietest&quot; or &quot;balanced&quot;</p>
</td></tr>
<tr><td><code id="journey2_+3A_pat">pat</code></td>
<td>
<p>The API key used. By default this uses <code>Sys.getenv("CYCLESTREETS")</code>.</p>
</td></tr>
<tr><td><code id="journey2_+3A_base_url">base_url</code></td>
<td>
<p>The base url from which to construct API requests
(with default set to main server)</p>
</td></tr>
<tr><td><code id="journey2_+3A_host_con">host_con</code></td>
<td>
<p>number of threads to use passed to curl::new_pool</p>
</td></tr>
<tr><td><code id="journey2_+3A_reporterrors">reporterrors</code></td>
<td>
<p>Boolean value (TRUE/FALSE) indicating if cyclestreets (TRUE by default).
should report errors (FALSE by default).</p>
</td></tr>
<tr><td><code id="journey2_+3A_segments">segments</code></td>
<td>
<p>Logical, if true route segments returned otherwise whole routes</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Requires the internet and a CycleStreets.net API key.
CycleStreets.net does not yet work worldwide.
</p>
<p>You need to have an api key for this code to run.
By default it uses the CYCLESTREETS environment variable.
A quick way to set this is to install the <code>usethis</code> package and then
executing the following command:
</p>
<p><code>usethis::edit_r_environ()</code>
</p>
<p>That should open up a new file in your text editor where you
can add the environment variable as follows
(replace 1a... with your key for this to work):
</p>
<p>CYCLESTREETS=1a43ed677e5e6fe9
</p>
<p>After setting the environment variable, as outlined above,
you need to restart your R session before the journey function will work.
</p>
<p>See <a href="https://www.cyclestreets.net/help/journey/howitworks/">www.cyclestreets.net/help/journey/howitworks/</a>
for details on how these are calculated.
</p>


<h3>See Also</h3>

<p>json2sf_cs
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
from = c(-1.55, 53.80) # geo_code("leeds")
to = c(-1.76, 53.80) # geo_code("bradford uk")
r1 = journey(from, to)
r2 = journey2(from, to, segments = TRUE)
# waldo::compare(r1, r2) # see differences
sum(sf::st_length(r1))
sum(sf::st_length(r2))
# waldo::compare(sum(sf::st_length(r1)), sum(sf::st_length(r2)))
# waldo::compare(names(r1), names(r2))
# waldo::compare(r1[1, ], r2[1, ])
r1[1:2, ]
r2[1:2, ]
r1$grammesCO2saved
r1$calories

## End(Not run)
</code></pre>

<hr>
<h2 id='json2sf_cs'>Quickly convert output from CycleStreets.net into sf object</h2><span id='topic+json2sf_cs'></span>

<h3>Description</h3>

<p>Available fields from CycleStreets include:
</p>


<h3>Usage</h3>

<pre><code class='language-R'>json2sf_cs(
  results_raw,
  id = 1,
  segments = TRUE,
  route_variables = c("start", "finish", "start_longitude", "start_latitude",
    "finish_longitude", "finish_latitude", "crow_fly_distance", "event", "whence",
    "speed", "itinerary", "plan", "note", "length", "west", "south", "east", "north",
    "leaving", "arriving", "grammesCO2saved", "calories", "edition"),
  cols_to_keep = c("id", "time", "busynance", "quietness", "signalledJunctions",
    "signalledCrossings", "name", "walk", "elevations", "distances", "type", "legNumber",
    "distance", "turn", "startBearing", "color", "provisionName", "start", "finish",
    "start_longitude", "start_latitude", "finish_longitude", "finish_latitude",
    "crow_fly_distance", "event", "whence", "speed", "itinerary", "plan", "note",
    "length", "west", "south", "east", "north", "leaving", "arriving", "grammesCO2saved",
    "calories", "edition", "gradient_segment", 
     "elevation_change",
    "gradient_smooth")
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="json2sf_cs_+3A_results_raw">results_raw</code></td>
<td>
<p>Raw result from CycleStreets.net read-in with readLines or similar</p>
</td></tr>
<tr><td><code id="json2sf_cs_+3A_id">id</code></td>
<td>
<p>id of the result</p>
</td></tr>
<tr><td><code id="json2sf_cs_+3A_segments">segments</code></td>
<td>
<p>Return segment level data? TRUE by default.</p>
</td></tr>
<tr><td><code id="json2sf_cs_+3A_route_variables">route_variables</code></td>
<td>
<p>Route level variables</p>
</td></tr>
<tr><td><code id="json2sf_cs_+3A_cols_to_keep">cols_to_keep</code></td>
<td>
<p>Columns to return in output sf object</p>
</td></tr>
</table>


<h3>Details</h3>

<div class="sourceCode"><pre>c("id", "time", "busynance", "quietness", "signalledJunctions",
  "signalledCrossings", "name", "walk", "elevations", "distances",
  "type", "legNumber", "distance", "turn", "startBearing", "color",
  "provisionName", "start", "finish", "start_longitude", "start_latitude",
  "finish_longitude", "finish_latitude", "crow_fly_distance", "event",
  "whence", "speed", "itinerary", "plan", "note", "length", "west",
  "south", "east", "north", "leaving", "arriving", "grammesCO2saved",
  "calories", "edition", "gradient_segment", "elevation_change",
  "gradient_smooth", "geometry")
</pre></div>


<h3>Examples</h3>

<pre><code class='language-R'>from = "Leeds Rail Station"
to = "University of Leeds"
# from_point = tmaptools::geocode_OSM(from)
# to_point = tmaptools::geocode_OSM(to)
from_point = c(-1.54408, 53.79360)
to_point =   c(-1.54802, 53.79618)
# save result from the API call to journey.json
# res_json = journey(from_point, to_point, silent = FALSE, save_raw = TRUE)
# jsonlite::write_json(res_json, "inst/extdata/journey.json")
# f = "inst/extdata/journey.json"
f = system.file(package = "cyclestreets", "extdata/journey.json")
rsf = json2sf_cs(readLines(f), id = 1, segments = TRUE)
names(rsf)
json2sf_cs(readLines(f), id = 1, segments = TRUE, cols_to_keep = "quietness")
# save result from the API call to journey.json
# res_json = journey(from_point, to_point, silent = FALSE, save_raw = TRUE)
# jsonlite::write_json(res_json, "inst/extdata/journey_short.json")
# f = "inst/extdata/journey_short.json"
f = system.file(package = "cyclestreets", "extdata/journey_short.json")
obj = jsonlite::read_json(f, simplifyVector = TRUE)
# Inclusion of "start_longitude" leads to the additional ProvisionName1 colum:
cols = c("name", "distances", "provisionName")
json2sf_cs(readLines(f), id = 1, segments = TRUE, cols_to_keep = cols)
</code></pre>

<hr>
<h2 id='ltns'>Download data on 'Low Traffic Neighbourhoods' or 'rat runs' from CycleStreets</h2><span id='topic+ltns'></span>

<h3>Description</h3>

<p>R interface to the CycleStreets.net LTN.
See <a href="https://www.cyclestreets.net/api/v2/advocacydata.ltns/">ltn API docs</a>
and an article on the methods for further details:
https://www.cyclestreets.org/news/2021/07/25/mapping-ltns/
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ltns(bb, pat = Sys.getenv("CYCLESTREETS"))
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="ltns_+3A_bb">bb</code></td>
<td>
<p>An sf or 'bounding box' like object</p>
</td></tr>
<tr><td><code id="ltns_+3A_pat">pat</code></td>
<td>
<p>The API key used. By default this uses <code>Sys.getenv("CYCLESTREETS")</code>.</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
bb = "0.101131,52.195807,0.170288,52.209719"
ltn_data = ltns(bb)
plot(ltn_data)
bb = stplanr::routes_fast_sf
ltn_data = ltns(bb)
plot(ltn_data)

## End(Not run)
</code></pre>

<hr>
<h2 id='smooth_with_cutoffs'>Identify and smooth-out anomalous gradient values</h2><span id='topic+smooth_with_cutoffs'></span>

<h3>Description</h3>

<p>When <code>distance_cutoff</code> and <code>gradient_cutoff</code> thresholds are both broken
for route segments, this function treats them as anomalous and
sets the offending gradient values to the mean of the <code>n</code>
segments closest to (in front of and behind) the offending segment.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>smooth_with_cutoffs(
  gradient_segment,
  elevation_change,
  distances,
  distance_cutoff = 50,
  gradient_cutoff = 0.1,
  n = 3,
  warnNA = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="smooth_with_cutoffs_+3A_gradient_segment">gradient_segment</code></td>
<td>
<p>The gradient for each segment from CycleStreets.net</p>
</td></tr>
<tr><td><code id="smooth_with_cutoffs_+3A_elevation_change">elevation_change</code></td>
<td>
<p>The difference between the maximum and minimum elevations within each segment</p>
</td></tr>
<tr><td><code id="smooth_with_cutoffs_+3A_distances">distances</code></td>
<td>
<p>The distance of each segment</p>
</td></tr>
<tr><td><code id="smooth_with_cutoffs_+3A_distance_cutoff">distance_cutoff</code></td>
<td>
<p>Distance (m) used to identify anomalous gradients</p>
</td></tr>
<tr><td><code id="smooth_with_cutoffs_+3A_gradient_cutoff">gradient_cutoff</code></td>
<td>
<p>Gradient (%, e.g. 0.1 being 10%) used to identify anomalous gradients</p>
</td></tr>
<tr><td><code id="smooth_with_cutoffs_+3A_n">n</code></td>
<td>
<p>The number of segments to use to smooth anomalous gradents.</p>
</td></tr>
<tr><td><code id="smooth_with_cutoffs_+3A_warnna">warnNA</code></td>
<td>
<p>Logical should NA warning be given?
The default is 3, meaning segments directly before, after and including the offending segment.</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>f = system.file(package = "cyclestreets", "extdata/journey.json")
rsf = json2sf_cs(readLines(f))
rsf$gradient_segment
rsf$elevation_change
rsf$distances
smooth_with_cutoffs(rsf$gradient_segment, rsf$elevation_change, rsf$distances)
smooth_with_cutoffs(rsf$gradient_segment, rsf$elevation_change, rsf$distances, 20, 0.05)
smooth_with_cutoffs(rsf$gradient_segment, rsf$elevation_change, rsf$distances, 200, 0.02)
smooth_with_cutoffs(rsf$gradient_segment, rsf$elevation_change, rsf$distances, 200, 0.02, n = 5)
</code></pre>

<hr>
<h2 id='ways'>Download data on 'Ways' with cyclability (quietness) ratings</h2><span id='topic+ways'></span>

<h3>Description</h3>

<p>R interface to the CycleStreets.net LTN.
See <a href="https://www.cyclestreets.net/api/v2/">API docs</a>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ways(
  bb,
  pat = Sys.getenv("CYCLESTREETS"),
  base_url = "https://api.cyclestreets.net/v2/mapdata?",
  limit = 400,
  types = "way",
  wayFields =
    "name,ridingSurface,id,cyclableText,quietness,speedMph,speedKmph,pause,color",
  zoom = 16
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="ways_+3A_bb">bb</code></td>
<td>
<p>An sf or 'bounding box' like object</p>
</td></tr>
<tr><td><code id="ways_+3A_pat">pat</code></td>
<td>
<p>The API key used. By default this uses <code>Sys.getenv("CYCLESTREETS")</code>.</p>
</td></tr>
<tr><td><code id="ways_+3A_base_url">base_url</code></td>
<td>
<p>The base url from which to construct API requests
(with default set to main server)</p>
</td></tr>
<tr><td><code id="ways_+3A_limit">limit</code></td>
<td>
<p>Maximum number of features to return</p>
</td></tr>
<tr><td><code id="ways_+3A_types">types</code></td>
<td>
<p>The type of way to get. Default: &quot;way&quot;.</p>
</td></tr>
<tr><td><code id="ways_+3A_wayfields">wayFields</code></td>
<td>
<p>Which attributes of the ways to return?</p>
</td></tr>
<tr><td><code id="ways_+3A_zoom">zoom</code></td>
<td>
<p>Zoom level</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 

u_test = paste0("https://api.cyclestreets.net/v2/mapdata?key=c047ed46f7b50b1x",
  "&amp;limit=400&amp;types=way&amp;wayFields=name,ridingSurface,id,cyclableText,",
  "quietness,speedMph,speedKmph,pause,color&amp;zoom=16&amp;",
  "bbox=-9.160863,38.754642,-9.150128,38.75764")
# ways_test = sf::read_sf(u_test)
bb = "0.101131,52.195807,0.170288,52.209719"
bb = "-9.160863,38.754642,-9.150128,38.75764"
way_data = ways(bb)
plot(way_data)
bb = stplanr::routes_fast_sf
way_data = ways(bb)
plot(way_data)

## End(Not run)
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
