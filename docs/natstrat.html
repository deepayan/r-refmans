<!DOCTYPE html><html lang="en"><head><title>Help for package natstrat</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {natstrat}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#natstrat-package'><p>natstrat: Obtain Unweighted Natural Strata that Balance Many Covariates</p></a></li>
<li><a href='#balance_LP'><p>Linear program that selects which controls to use in order to optimize balance</p></a></li>
<li><a href='#check_balance'><p>Check covariate balance of the control and treated groups</p></a></li>
<li><a href='#create_balance_matrices'><p>Create matrix of balance constraints for linear program</p></a></li>
<li><a href='#create_dist_matrix'><p>Create matrix of distances between strata</p></a></li>
<li><a href='#generate_constraints'><p>Generate constraints to encourage covariate balance</p></a></li>
<li><a href='#generate_qs'><p>Calculate desired number of controls per stratum</p></a></li>
<li><a href='#get_stand_diffs'><p>Calculate standardized differences</p></a></li>
<li><a href='#nh0506'><p>Homocysteine and smoking example data</p></a></li>
<li><a href='#nh0506_3groups'><p>Homocysteine and smoking example data with multiple control groups</p></a></li>
<li><a href='#optimize_controls'><p>Select control units that optimize covariate balance</p></a></li>
<li><a href='#parse_formula'><p>Parse the nonstandard balance formulas</p></a></li>
<li><a href='#plot_stand_diffs'><p>Plot standardized differences in means</p></a></li>
<li><a href='#presolve_EMD'><p>Solve the earthmover's distance problem</p></a></li>
<li><a href='#process_qs'><p>Process the desired sample sizes for <code>optimize_controls()</code></p></a></li>
<li><a href='#randomized_rounding'><p>Sample integer solution from linear programming solution with correct sample sizes</p></a></li>
<li><a href='#randomized_rounding_expectation'><p>Sample integer solution from linear programming solution with sample sizes correct in expectation</p></a></li>
<li><a href='#stand'><p>Standardize covariate vector for balance constraint</p></a></li>
<li><a href='#verify_inputs'><p>Verify the inputs to <code>optimize_controls()</code></p></a></li>
<li><a href='#verify_inputs_EMD'><p>Verify the inputs to the earthmover's distance problem</p></a></li>
<li><a href='#verify_multi_comp_inputs'><p>Verify the inputs for supplemental comparisons to <code>optimize_controls()</code></p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Obtain Unweighted Natural Strata that Balance Many Covariates</td>
</tr>
<tr>
<td>Version:</td>
<td>2.0.0</td>
</tr>
<tr>
<td>Description:</td>
<td>Natural strata can be used in observational studies to balance
    the distributions of many covariates across any number of treatment
    groups and any number of comparisons. These strata have proportional 
    amounts of units within each stratum across the treatments, allowing 
    for simple interpretation and aggregation across strata. Within each 
    stratum, the units are chosen using randomized rounding of a linear 
    program that balances many covariates.
    To solve the linear program, the 'Gurobi' commercial optimization software 
    is recommended, but not required. The 'gurobi' R package can be installed following the instructions 
    at <a href="https://www.gurobi.com/documentation/9.1/refman/ins_the_r_package.html">https://www.gurobi.com/documentation/9.1/refman/ins_the_r_package.html</a>.</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://github.com/kkbrum/natstrat">https://github.com/kkbrum/natstrat</a>,
<a href="https://kkbrum.github.io/natstrat/">https://kkbrum.github.io/natstrat/</a>,
<a href="https://www.gurobi.com/documentation/9.1/refman/ins_the_r_package.html">https://www.gurobi.com/documentation/9.1/refman/ins_the_r_package.html</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/kkbrum/natstrat/issues">https://github.com/kkbrum/natstrat/issues</a></td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a></td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>LazyData:</td>
<td>true</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.1.1</td>
</tr>
<tr>
<td>Imports:</td>
<td>Rglpk, stats, plyr, pps, sampling, ggplot2, rlang, ramify,
slam</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 2.10), caret</td>
</tr>
<tr>
<td>Suggests:</td>
<td>knitr, rmarkdown, markdown, testthat (&ge; 3.0.0), DT, stringr,
covr, gurobi</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>Config/testthat/edition:</td>
<td>3</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2021-10-14 22:02:23 UTC; kathe</td>
</tr>
<tr>
<td>Author:</td>
<td>Katherine Brumberg [aut, cre]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Katherine Brumberg &lt;kbrum@wharton.upenn.edu&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2021-10-15 09:10:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='natstrat-package'>natstrat: Obtain Unweighted Natural Strata that Balance Many Covariates</h2><span id='topic+natstrat'></span><span id='topic+natstrat-package'></span>

<h3>Description</h3>

<p>Natural strata fix a constant ratio of controls to treated units within
each stratum. This ratio need not be an integer. The control units are
chosen using randomized rounding of a linear program that balances many
covariates.
To solve the linear program, the 'Gurobi' commercial optimization software
is recommended, but not required. The 'gurobi' R package can be installed following
the instructions <a href="https://www.gurobi.com/documentation/9.1/refman/ins_the_r_package.html">here</a>.
</p>


<h3>Details</h3>

<p>To achieve the desired ratio of control to treated units,
a subset of control units are
chosen using by optimizing the balance of many covariates using
either randomized rounding of a linear program or
an integer program. The main function in this package is <code><a href="#topic+optimize_controls">optimize_controls</a>()</code>.
To create the input constraints for this function, you should use
<code><a href="#topic+generate_constraints">generate_constraints</a>()</code>.
</p>


<h3>Author(s)</h3>

<p><strong>Maintainer</strong>: Katherine Brumberg <a href="mailto:kbrum@wharton.upenn.edu">kbrum@wharton.upenn.edu</a>
</p>


<h3>See Also</h3>

<p>Useful links:
</p>

<ul>
<li> <p><a href="https://github.com/kkbrum/natstrat">https://github.com/kkbrum/natstrat</a>
</p>
</li>
<li> <p><a href="https://kkbrum.github.io/natstrat/">https://kkbrum.github.io/natstrat/</a>
</p>
</li>
<li> <p><a href="https://www.gurobi.com/documentation/9.1/refman/ins_the_r_package.html">https://www.gurobi.com/documentation/9.1/refman/ins_the_r_package.html</a>
</p>
</li>
<li><p> Report bugs at <a href="https://github.com/kkbrum/natstrat/issues">https://github.com/kkbrum/natstrat/issues</a>
</p>
</li></ul>


<hr>
<h2 id='balance_LP'>Linear program that selects which controls to use in order to optimize balance</h2><span id='topic+balance_LP'></span>

<h3>Description</h3>

<p>This linear program is used by <code><a href="#topic+optimize_controls">optimize_controls</a>()</code> to choose which controls
to select.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>balance_LP(
  z,
  X,
  importances,
  st,
  st_vals,
  S,
  q_s,
  N,
  solver,
  integer,
  time_limit,
  threads = 1,
  weight_comp = 1
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="balance_LP_+3A_z">z</code></td>
<td>
<p>a factor with the <code>i</code>th entry equal to the treatment of unit <code>i</code>.</p>
</td></tr>
<tr><td><code id="balance_LP_+3A_x">X</code></td>
<td>
<p>a matrix or data frame containing constraints in the columns. The number
of rows should equal the length of <code>z</code>. Balance is achieved when a constraint
sums to 0, such that numbers closer to 0 are better. When a constraint
does not apply to a particular unit, the entry should be <code>NA</code>.
This should typically be generated using <code><a href="#topic+generate_constraints">generate_constraints</a>()</code>.</p>
</td></tr>
<tr><td><code id="balance_LP_+3A_importances">importances</code></td>
<td>
<p>a vector with length equal to the number of constraints or columns
in <code>X</code>. This can be generated using <code><a href="#topic+generate_constraints">generate_constraints</a>()</code> and each nonnegative value
denotes how much to prioritize each constraint, with the default being 1
for all constraints.</p>
</td></tr>
<tr><td><code id="balance_LP_+3A_st">st</code></td>
<td>
<p>a stratum vector with the <code>i</code>th entry equal to the
stratum of unit <code>i</code>. This should have the same order of units and length
as <code>z</code>.</p>
</td></tr>
<tr><td><code id="balance_LP_+3A_st_vals">st_vals</code></td>
<td>
<p>the unique stratum levels contained in <code>st</code>.</p>
</td></tr>
<tr><td><code id="balance_LP_+3A_s">S</code></td>
<td>
<p>the number of unique stratum levels contained in <code>st</code>.</p>
</td></tr>
<tr><td><code id="balance_LP_+3A_q_s">q_s</code></td>
<td>
<p>a named vector or matrix indicating how many control units are to be selected from each stratum.
If there is one control group and all treated units are desired, this can be a vector; otherwise,
this should have one row per treatment group, where the order of the rows matches the order of
the levels of <code>z</code>, including the treated level.</p>
</td></tr>
<tr><td><code id="balance_LP_+3A_n">N</code></td>
<td>
<p>the total number of available controls in the data.</p>
</td></tr>
<tr><td><code id="balance_LP_+3A_solver">solver</code></td>
<td>
<p>a character stating which solver to use to run the linear program.
Options are &quot;Rglpk&quot; (default) or &quot;gurobi&quot;. You must have the 'gurobi' package
installed to use the &quot;gurobi&quot; option. If available, this is the recommended solver.</p>
</td></tr>
<tr><td><code id="balance_LP_+3A_integer">integer</code></td>
<td>
<p>a logical stating whether to use a mixed integer programming solver
instead of randomized rounding. Default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="balance_LP_+3A_time_limit">time_limit</code></td>
<td>
<p>numeric stating maximum amount of seconds for which the
program is allowed to run before aborting. Default is <code>Inf</code> for no time limit.</p>
</td></tr>
<tr><td><code id="balance_LP_+3A_threads">threads</code></td>
<td>
<p>The maximum number of threads that should be used. This is only
applicable if <code>solver = 'gurobi'</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list containing two elements:
</p>

<dl>
<dt><code>lpdetails</code></dt><dd><p>The output of either <code>gurobi()</code> or <code><a href="Rglpk.html#topic+Rglpk_solve_LP">Rglpk_solve_LP</a>()</code>,
except that if <code>gurobi()</code> is used, the elements <code>objval</code> and <code>x</code>
are renamed <code>optimum</code> and <code>solution</code>
to be consistent with the output of <code><a href="Rglpk.html#topic+Rglpk_solve_LP">Rglpk_solve_LP</a>()</code>.</p>
</dd>
<dt><code>o</code></dt><dd><p>The original output of either <code>gurobi()</code> or <code><a href="Rglpk.html#topic+Rglpk_solve_LP">Rglpk_solve_LP</a>()</code>.</p>
</dd>
</dl>


<hr>
<h2 id='check_balance'>Check covariate balance of the control and treated groups</h2><span id='topic+check_balance'></span>

<h3>Description</h3>

<p>Reports standardized differences in means between the treated and
control group before and after choosing a subset of controls.
These differences are reported both across strata and within strata.
This function can also generate love plots of the same quantities.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>check_balance(
  z,
  X,
  st,
  selected,
  treated = 1,
  control = 0,
  denom_variance = "treated",
  plot = FALSE,
  message = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="check_balance_+3A_z">z</code></td>
<td>
<p>a factor with the <code>i</code>th entry equal to the treatment of unit <code>i</code>.</p>
</td></tr>
<tr><td><code id="check_balance_+3A_x">X</code></td>
<td>
<p>a data frame containing the covariates in the columns over which balance is desired. The number
of rows should equal the length of <code>z</code>.</p>
</td></tr>
<tr><td><code id="check_balance_+3A_st">st</code></td>
<td>
<p>a stratum vector with the <code>i</code>th entry equal to the
stratum of unit <code>i</code>. This should have the same order of units and length
as <code>z</code>.</p>
</td></tr>
<tr><td><code id="check_balance_+3A_selected">selected</code></td>
<td>
<p>a boolean vector including whether each unit was selected as part of the treated and control
groups for analysis. Should be the same length as <code>z</code> and typically comes from the results of
<code><a href="#topic+optimize_controls">optimize_controls</a>()</code>.</p>
</td></tr>
<tr><td><code id="check_balance_+3A_treated">treated</code></td>
<td>
<p>which treatment value should be considered the treated units. This
must be one of the values of <code>z</code>.</p>
</td></tr>
<tr><td><code id="check_balance_+3A_control">control</code></td>
<td>
<p>which treatment value should be considered the control units. This
must be one of the values of <code>z</code>.</p>
</td></tr>
<tr><td><code id="check_balance_+3A_denom_variance">denom_variance</code></td>
<td>
<p>character stating what variance to use in the standardization:
either the default &quot;treated&quot;, meaning the standardization will use the
treated variance (across all strata), where the treated group is declared in
the <code>treated</code> argument, or &quot;pooled&quot;, meaning
the standardization will use the average of the variances of each treatment group.</p>
</td></tr>
<tr><td><code id="check_balance_+3A_plot">plot</code></td>
<td>
<p>a boolean denoting whether to generate love plots for the standardized differences.</p>
</td></tr>
<tr><td><code id="check_balance_+3A_message">message</code></td>
<td>
<p>a boolean denoting whether to print a message about the level of balance achieved</p>
</td></tr>
</table>


<h3>Value</h3>

<p>List containing:
</p>

<dl>
<dt>sd_across</dt><dd><p>matrix with one row per covariate and two columns: one for the
standardized difference before a subset of controls were selected and one for after.</p>
</dd>
<dt>sd_strata</dt><dd><p>matrix similar to <code>sd_across</code>, but with separate
standardized differences for each stratum for each covariate.</p>
</dd>
<dt>sd_strata_avg</dt><dd><p>matrix similar to <code>sd_across</code>, but taking the
average of the standardized differences within the strata, weighted by stratum size.</p>
</dd>
<dt>plot_across</dt><dd><p>ggplot object plotting <code>sd_across</code>, only exists if <code>plot = TRUE</code>.</p>
</dd>
<dt>plot_strata</dt><dd><p>a named list of ggplot objects plotting <code>sd_strata</code>,
one for each stratum, only exists if <code>plot = TRUE</code>.</p>
</dd>
<dt>plot_strata_avg</dt><dd><p>ggplot object plotting <code>sd_strata_avg</code>, only exists if <code>plot = TRUE</code>.</p>
</dd>
<dt>plot_pair</dt><dd><p>ggplot object with two facets displaying <code>sd_across</code> and
<code>sd_strata_avg</code> with one y-axis, only exists if <code>plot = TRUE</code>.</p>
</dd>
</dl>



<h3>Examples</h3>

<pre><code class='language-R'>
data('nh0506')

# Create strata
age_cat &lt;- cut(nh0506$age,
               breaks = c(19, 39, 50, 85),
               labels = c('&lt; 40 years', '40 - 50 years', '&gt; 50 years'))
strata &lt;- age_cat : nh0506$sex

# Balance age, race, education, poverty ratio, and bmi both across and within the levels of strata
constraints &lt;- generate_constraints(
                 balance_formulas = list(age + race + education + povertyr + bmi ~ 1 + strata),
                 z = nh0506$z,
                 data = nh0506)

# Choose one control for every treated unit in each stratum,
# balancing the covariates as described by the constraints
results &lt;- optimize_controls(z = nh0506$z,
                             X = constraints$X,
                             st = strata,
                             importances = constraints$importances,
                             ratio = 1)

cov_data &lt;- nh0506[, c('sex', 'age', 'race', 'education', 'povertyr', 'bmi')]

# Check balance
stand_diffs &lt;- check_balance(z = nh0506$z,
                             X = cov_data,
                             st = strata,
                             selected = results$selected,
                             plot = TRUE)
</code></pre>

<hr>
<h2 id='create_balance_matrices'>Create matrix of balance constraints for linear program</h2><span id='topic+create_balance_matrices'></span>

<h3>Description</h3>

<p>This creates the matrix of constraints that seek covariate balance for use in <code><a href="#topic+balance_LP">balance_LP</a>()</code>
which creates the linear program used by <code><a href="#topic+optimize_controls">optimize_controls</a>()</code> to choose which controls
to select.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>create_balance_matrices(X, z, N, nvars, kc2, q_s, return = "all")
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="create_balance_matrices_+3A_x">X</code></td>
<td>
<p>a matrix or data frame containing constraints in the columns. The number
of rows should equal the length of <code>z</code>. Balance is achieved when a constraint
sums to 0, such that numbers closer to 0 are better. When a constraint
does not apply to a particular unit, the entry should be <code>NA</code>.
This should typically be generated using <code><a href="#topic+generate_constraints">generate_constraints</a>()</code>.</p>
</td></tr>
<tr><td><code id="create_balance_matrices_+3A_z">z</code></td>
<td>
<p>a factor with the <code>i</code>th entry equal to the treatment of unit <code>i</code>.</p>
</td></tr>
<tr><td><code id="create_balance_matrices_+3A_n">N</code></td>
<td>
<p>the total number of available controls in the data.</p>
</td></tr>
<tr><td><code id="create_balance_matrices_+3A_q_s">q_s</code></td>
<td>
<p>a named vector or matrix indicating how many units are to be selected from each stratum.
If there is one control group and all treated units are desired, this can be a vector; otherwise,
this should have one row per treatment group, where the order of the rows matches the order of
the levels of <code>z</code>, including the treated level.
If <code>NULL</code>, <code>ratio</code> should be specified. If both are specified, <code>q_s</code> will take priority.
Typically, if the desired ratio is not feasible for every stratum, <code>q_s</code> should be generated
using <code><a href="#topic+generate_qs">generate_qs</a>()</code>.</p>
</td></tr>
<tr><td><code id="create_balance_matrices_+3A_return">return</code></td>
<td>
<p>one of &quot;all&quot;, &quot;A&quot;, or &quot;X&quot;, denoting whether all matrices should be
returned, or just A or just the X matrix blocks.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list containing up to three elements:
</p>

<dl>
<dt><code>A</code></dt><dd><p>The matrix of covariate values and +/- 1s that are used as coefficients
for the unit indicators and the epsilons in order to set the epsilons equal to
the covariate imbalances.</p>
</dd>
<dt><code>x_blk</code></dt><dd><p>The covariate values used as coefficients for the unit
indicators in the objective function.</p>
</dd>
</dl>


<hr>
<h2 id='create_dist_matrix'>Create matrix of distances between strata</h2><span id='topic+create_dist_matrix'></span>

<h3>Description</h3>

<p>Create a distance matrix between strata levels created from the interactions
of factors. Used as input to <code><a href="#topic+generate_qs">generate_qs</a>()</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>create_dist_matrix(...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="create_dist_matrix_+3A_...">...</code></td>
<td>
<p>any number of matrices that contain the distances between levels of
a single stratifying factor. These should have both column and row names
which correspond to the levels of the stratifying factor.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Matrix containing the distances between all levels of the factor of all
interactions between the inputted factors. The row and column names correspond
to the levels of the strata, formed by combining the level name of each stratifying
factor separated with ':'.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data('nh0506')

age_cat &lt;- cut(nh0506$age,
               breaks = c(19, 39, 50, 85),
               labels = c('&lt; 40 years', '40 - 50 years', '&gt; 50 years'))

age_dist &lt;- matrix(data = c(0, 1, 2, 1, 0, 1, 2, 1, 0),
                   nrow = 3,
                   byrow = TRUE,
                   dimnames = list(levels(age_cat), levels(age_cat)))

sex_dist &lt;- matrix(data = c(0, 1, 1, 0),
                   nrow = 2,
                   dimnames = list(levels(nh0506$sex), levels(nh0506$sex)))

strata_dist &lt;- create_dist_matrix(age_dist, sex_dist)
</code></pre>

<hr>
<h2 id='generate_constraints'>Generate constraints to encourage covariate balance</h2><span id='topic+generate_constraints'></span>

<h3>Description</h3>

<p>This function generates constraints that encourage covariate balance as specified.
The main inputs are formula like objects, where the left hand side indicates
the covariate to be balanced and the right hand side indicates the
groups within which to balance. The constraints are
weighted and standardized by <code><a href="#topic+stand">stand</a>()</code> to be used in <code><a href="#topic+optimize_controls">optimize_controls</a>()</code>. Missingness
indicators can also be added and weighted for any covariate that has <code>NA</code> values.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>generate_constraints(
  balance_formulas,
  z,
  data,
  default_rhs = NULL,
  weight_by_size = 0,
  denom_variance = "treated",
  treated = 1,
  autogen_missing = 50
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="generate_constraints_+3A_balance_formulas">balance_formulas</code></td>
<td>
<p>a list of formulas where the left hand side represents
the covariate to be balanced, and the terms on the right hand side represent
the populations within which the covariate should be balanced. More information can
be found in the details below.</p>
</td></tr>
<tr><td><code id="generate_constraints_+3A_z">z</code></td>
<td>
<p>a factor with the <code>i</code>th entry equal to the treatment of unit <code>i</code>.</p>
</td></tr>
<tr><td><code id="generate_constraints_+3A_data">data</code></td>
<td>
<p>a data frame containing the relevant covariates in the columns. The number
of rows should equal the length of <code>treated</code>.</p>
</td></tr>
<tr><td><code id="generate_constraints_+3A_default_rhs">default_rhs</code></td>
<td>
<p>the list of <code>balance_formulas</code> can also contain entries
that are just the character corresponding to a covariate to balance. If so,
the covariate will be balanced according to <code>default_rhs</code>.</p>
</td></tr>
<tr><td><code id="generate_constraints_+3A_weight_by_size">weight_by_size</code></td>
<td>
<p>numeric between 0 and 1 stating how to adjust constraints
for the size of the population they represent. Default is 0, meaning imbalance
within populations is viewed in absolute terms, not relative to the population size.
The program may thus prioritize
balancing the covariate in larger populations compared to smaller populations. A value
of 1 means that imbalance will be measured relative to the population's size, not
in absolute terms, implying that it is equally important to balance in every population.</p>
</td></tr>
<tr><td><code id="generate_constraints_+3A_denom_variance">denom_variance</code></td>
<td>
<p>character stating what variance to use in the standardization:
either the default &quot;treated&quot;, meaning the standardization will use the
treated variance (across all strata), where the treated group is declared in
the <code>treated</code> argument, or &quot;pooled&quot;, meaning
the standardization will use the average of the variances of each treatment group.</p>
</td></tr>
<tr><td><code id="generate_constraints_+3A_treated">treated</code></td>
<td>
<p>which treatment value should be considered the treated group. This
must be one of the values of <code>z</code>. This
is used if <code>denom_variance = "treated"</code> for calculating the variance
to use in the standardization or if <code>weight_by_size &gt; 0</code> to determine which
treatment group to use to calculate population sizes.</p>
</td></tr>
<tr><td><code id="generate_constraints_+3A_autogen_missing">autogen_missing</code></td>
<td>
<p>whether to automatically generate missingness constraints
and how heavily to prioritize them. Should be a numeric
or <code>NULL</code>. <code>NULL</code> indicates that
constraints to balance the rate of missingness (denoted by <code>NA</code>s
in <code>data</code>) should not be automatically generated. Note that this is not
recommended unless the user has already accounted for missing values.
If not <code>NULL</code>, <code>autogen_missing</code> should be a numeric stating how heavily
to prioritize generated missingness constraints over covariate constraints.
The default is 50.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list with two named components:
</p>

<dl>
<dt><code>X</code></dt><dd><p>a matrix with constraints as columns and the same number of rows as the inputs.
The column names provide information about the constraints, including the covariate
names and the factor and level to which it pertains.</p>
</dd>
<dt><code>importances</code></dt><dd><p>a named vector with names corresponding to the constraint names
and values corresponding to how heavily that constraint should be prioritized,
based on the information provided through <code>balance_formulas</code>, <code>weight_by_size</code>,
and <code>autogen_missing</code>.</p>
</dd>
</dl>



<h3>Details</h3>

<p>The <code>balance_formulas</code> argument can include formulas beyond those interpreted
by <code>R</code> to be <code>formulas</code>. Their interpretation is also different, as
explained below:
</p>

<dl>
<dt>Left hand side</dt><dd><p>The left hand side of the formula contains the covariate
to be balanced. It can also be the sum of multiple covariates, in which case
each term will be balanced individually according to the right hand side. Additionally,
'.' on the left hand side will designate that all covariates in <code>data</code>
should be balanced according to the designated or default right hand side
(as usual, terms may be subtracted to remove them).</p>
</dd>
<dt>Right hand side</dt><dd><p>The right hand side should be the sum of factor, character,
or boolean variables. The covariate of the left hand side will be balanced within
each level of each term on the right hand side. The right hand side can also
contain '.', meaning the covariate will be balanced across all levels of all
categorical, character, or boolean variables found in <code>data</code> (as usual,
terms may be subtracted to remove them). In the most common case, the user
will have one term on the right hand side consisting of the strata within
which balance in desired.</p>
</dd>
<dt>Coefficients</dt><dd><p>The formulas can contain coefficients specifying how much
to weight a certain set of constraints. Coefficients of the left hand side terms will
weight all constraints generated for that covariate, and coefficients of the
right hand side will weight the constraints generated for each level of that
term.</p>
</dd>
<dt>Intercept</dt><dd><p>The intercept term, 1, is automatically included on the right
hand side of the formula, and designates that the covariate of the left hand side
will be balanced across all control units. You may enter a different numeric &gt; 0
that will signify how much to weight the constraint, or you may enter &quot;- 1&quot; or &quot;+ 0&quot;
to remove the intercept and its associated constraint, as per usual.</p>
</dd></dl>



<h3>Examples</h3>

<pre><code class='language-R'>data('nh0506')

# Create strata
age_cat &lt;- cut(nh0506$age,
               breaks = c(19, 39, 50, 85),
               labels = c('&lt; 40 years', '40 - 50 years', '&gt; 50 years'))
strata &lt;- age_cat : nh0506$sex

# Balance age, race, education, poverty ratio, and bmi both across and within the levels of strata
constraints &lt;- generate_constraints(
                 balance_formulas = list(age + race + education + povertyr + bmi ~ 1 + strata),
                 z = nh0506$z,
                 data = nh0506)

# Balance age and race both across and within the levels of strata,
# with balance for race being prioritized twice as much as for age,
# and balance across strata prioritized twice as much as within.
# Balance education across and within strata,
# with balance within strata prioritized twice as much as across.
# Balance poverty ratio and bmi only within the levels of strata,
# as specified in the default_rhs argument
constraints &lt;- generate_constraints(
                 balance_formulas = list(age + 2 * race ~ 2 + strata,
                                         education ~ 1 + 2 * strata,
                                         'povertyr',
                                         'bmi'),
                 z = nh0506$z,
                 data = nh0506,
                 default_rhs = '0 + strata')

</code></pre>

<hr>
<h2 id='generate_qs'>Calculate desired number of controls per stratum</h2><span id='topic+generate_qs'></span>

<h3>Description</h3>

<p>Figure out how many units to take from each stratum when some strata are deficient.
The result should be used as an input to <code><a href="#topic+optimize_controls">optimize_controls</a>()</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>generate_qs(
  z,
  st,
  ratio,
  treated = 1,
  max_ratio = NULL,
  max_extra_s = 5,
  strata_dist = NULL
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="generate_qs_+3A_z">z</code></td>
<td>
<p>a factor with the <code>i</code>th entry equal to the treatment of unit <code>i</code>.</p>
</td></tr>
<tr><td><code id="generate_qs_+3A_st">st</code></td>
<td>
<p>a stratum vector with the <code>i</code>th entry equal to the
stratum of unit <code>i</code>. This should have the same order of units and length
as <code>z</code>.</p>
</td></tr>
<tr><td><code id="generate_qs_+3A_ratio">ratio</code></td>
<td>
<p>a numeric or vector specifying the desired ratio of controls to 'treated' in
each stratum. If there is one control group and all treated units should be included,
this can be a numeric. Otherwise, this should be
a vector with one entry per treatment group, in the same order as the levels of
<code>z</code>, including the treated level. If <code>NULL</code>, <code>q_s</code> should be specified.</p>
</td></tr>
<tr><td><code id="generate_qs_+3A_treated">treated</code></td>
<td>
<p>which treatment value should be considered the treated units. This
must be one of the values of <code>z</code>.</p>
</td></tr>
<tr><td><code id="generate_qs_+3A_max_ratio">max_ratio</code></td>
<td>
<p>a numeric or vector specifying the maximum ratio to allow in a stratum to achieve
the overall <code>ratio</code> specified. If <code>NULL</code>, it is set by default to 1.1 times the desired <code>ratio</code>.
To have no maximum ratio, set this to <code>Inf</code>.</p>
</td></tr>
<tr><td><code id="generate_qs_+3A_max_extra_s">max_extra_s</code></td>
<td>
<p>single numeric or named vector or matrix with values corresponding to the maximum desired number
of extra controls to be chosen from each stratum to achieve the overall
<code>ratio</code> specified. If this is a vector, the names should correspond to the stratum
values from <code>st</code>. If there are more than two treatment levels,
this should be a matrix with one row per treatment level, in the same
order as the levels of <code>z</code>. The default is 5 for each stratum in each treatment group.
To have no maximum, set this to <code>Inf</code>.
If both <code>max_ratio</code> and <code>max_s</code> are specified, the
maximum of the two will be used for each stratum.</p>
</td></tr>
<tr><td><code id="generate_qs_+3A_strata_dist">strata_dist</code></td>
<td>
<p>matrix with both row and column names with names corresponding
to the stratum values from <code>st</code> and entries corresponding to the distance
associated with taking a control from the stratum associated with the row when
the desired stratum is the one associated with the column. Lower distance values
are more desirable replacements. Typically the diagonal should be 0, meaning
there is no penalty for choosing a unit from the correct stratum.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A named vector stating how many controls to take from each stratum.
</p>

<hr>
<h2 id='get_stand_diffs'>Calculate standardized differences</h2><span id='topic+get_stand_diffs'></span>

<h3>Description</h3>

<p>Calculate standardized differences in means between treated and control groups,
before and after refining the control group. Used within the <code><a href="#topic+check_balance">check_balance</a></code> function.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_stand_diffs(
  data,
  z,
  selected,
  st = NULL,
  ist = NULL,
  treated = 1,
  control = 0,
  denom_variance = "treated"
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="get_stand_diffs_+3A_data">data</code></td>
<td>
<p>A data frame with columns for which the standardized differences should be calculated.</p>
</td></tr>
<tr><td><code id="get_stand_diffs_+3A_z">z</code></td>
<td>
<p>a factor with the <code>i</code>th entry equal to the treatment of unit <code>i</code>.</p>
</td></tr>
<tr><td><code id="get_stand_diffs_+3A_selected">selected</code></td>
<td>
<p>a boolean vector including whether each unit was selected as part of the treated and control
groups for analysis. Should be the same length as <code>z</code> and typically comes from the results of
<code><a href="#topic+optimize_controls">optimize_controls</a>()</code>.</p>
</td></tr>
<tr><td><code id="get_stand_diffs_+3A_st">st</code></td>
<td>
<p>a stratum vector with the <code>i</code>th entry equal to the
stratum of unit <code>i</code>. This should have the same order of units and length
as <code>z</code>.</p>
</td></tr>
<tr><td><code id="get_stand_diffs_+3A_ist">ist</code></td>
<td>
<p>The specific stratum for which the standardized differences should be calculated.</p>
</td></tr>
<tr><td><code id="get_stand_diffs_+3A_treated">treated</code></td>
<td>
<p>which treatment value should be considered the treated units. This
must be one of the values of <code>z</code>.</p>
</td></tr>
<tr><td><code id="get_stand_diffs_+3A_control">control</code></td>
<td>
<p>which treatment value should be considered the control units. This
must be one of the values of <code>z</code>.</p>
</td></tr>
<tr><td><code id="get_stand_diffs_+3A_denom_variance">denom_variance</code></td>
<td>
<p>character stating what variance to use in the standardization:
either the default &quot;treated&quot;, meaning the standardization will use the
treated variance (across all strata), where the treated group is declared in
the <code>treated</code> argument, or &quot;pooled&quot;, meaning
the standardization will use the average of the variances of each treatment group.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>data frame containing two columns, one for standardized differences before
choosing a subset of controls, and one for after. The rows pertain to covariates.
</p>

<hr>
<h2 id='nh0506'>Homocysteine and smoking example data</h2><span id='topic+nh0506'></span>

<h3>Description</h3>

<p>NHANES 2005-2006 data on smoking and homocysteine levels in adults.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>nh0506
</code></pre>


<h3>Format</h3>

<p>A data frame with 2928 rows and 11 variables:
</p>

<dl>
<dt>SEQN</dt><dd><p>NHANES identification number.</p>
</dd>
<dt>z</dt><dd><p>smoking status treatment indicator: 1 = daily smoker, 0 = never smoker.</p>
</dd>
<dt>sex</dt><dd><p>factor with levels &quot;Male&quot; and &quot;Female&quot;.</p>
</dd>
<dt>age</dt><dd><p>age in years, 20-85, with 85 recorded for everyone &gt;= 85 years.</p>
</dd>
<dt>race</dt><dd><p>factor with levels &quot;Mexican American&quot;,
&quot;Other Hispanic&quot;, &quot;Non-Hispanic White&quot;, &quot;Non-Hispanic Black&quot;, and
&quot;Other Race - Including Multi-Racial&quot;.</p>
</dd>
<dt>education</dt><dd><p>factor with levels &quot;&lt; Grade 9&quot;,
&quot;9-11th grade&quot;, &quot;High school grad/GED&quot;, &quot;Some college or AA degree&quot;,
&quot;College graduate or above&quot;.</p>
</dd>
<dt>povertyr</dt><dd><p>ratio of family income to the poverty level,
capped at 5 times poverty, has missing entries.</p>
</dd>
<dt>bmi</dt><dd><p>BMI (body mass index), has missing entries.</p>
</dd>
<dt>cigsperday30</dt><dd><p>cigarettes smoked per day, 0 for never smokers.</p>
</dd>
<dt>cotinine</dt><dd><p>blood cotinine level, a biomarker of recent exposure to tobacco.</p>
</dd>
<dt>homocysteine</dt><dd><p>homocysteine level.</p>
</dd>
</dl>



<h3>Details</h3>

<p>The code used to generate this data is documented
in the source version of this package under 'data-raw/'.
This data is composed of adults aged at least 20 years.
Individuals who have smoked at least 100 cigarettes
but do not now smoke at least 10 cigarettes daily are
excluded. Individuals with missing homocysteine
values, cotinine values, or smoking information are excluded.
After filtering for all these criteria,
one individual with unknown education remains and is also excluded.
Missing values remain in the poverty ratio and bmi covariates.
</p>


<h3>Source</h3>

<p><a href="https://wwwn.cdc.gov/nchs/nhanes/ContinuousNhanes/Default.aspx?BeginYear=2005">https://wwwn.cdc.gov/nchs/nhanes/ContinuousNhanes/Default.aspx?BeginYear=2005</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data('nh0506')
</code></pre>

<hr>
<h2 id='nh0506_3groups'>Homocysteine and smoking example data with multiple control groups</h2><span id='topic+nh0506_3groups'></span>

<h3>Description</h3>

<p>NHANES 2005-2006 data on smoking and homocysteine levels in adults,
comparing daily smokers to never smokers and occasional smokers.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>nh0506_3groups
</code></pre>


<h3>Format</h3>

<p>A data frame with 4457 rows and 11 variables:
</p>

<dl>
<dt>SEQN</dt><dd><p>NHANES identification number.</p>
</dd>
<dt>z</dt><dd><p>smoking status treatment factor: 0 = never smoker, 1 = some smoking, 2 = daily smoker.</p>
</dd>
<dt>sex</dt><dd><p>factor with levels &quot;Male&quot; and &quot;Female&quot;.</p>
</dd>
<dt>age</dt><dd><p>age in years, 20-85, with 85 recorded for everyone &gt;= 85 years.</p>
</dd>
<dt>race</dt><dd><p>factor with levels &quot;Mexican American&quot;,
&quot;Other Hispanic&quot;, &quot;Non-Hispanic White&quot;, &quot;Non-Hispanic Black&quot;, and
&quot;Other Race - Including Multi-Racial&quot;.</p>
</dd>
<dt>education</dt><dd><p>factor with levels &quot;&lt; Grade 9&quot;,
&quot;9-11th grade&quot;, &quot;High school grad/GED&quot;, &quot;Some college or AA degree&quot;,
&quot;College graduate or above&quot;.</p>
</dd>
<dt>povertyr</dt><dd><p>ratio of family income to the poverty level,
capped at 5 times poverty, has missing entries.</p>
</dd>
<dt>bmi</dt><dd><p>BMI (body mass index), has missing entries.</p>
</dd>
<dt>cigsperday30</dt><dd><p>cigarettes smoked per day, 0 for never smokers.</p>
</dd>
<dt>cotinine</dt><dd><p>blood cotinine level, a biomarker of recent exposure to tobacco.</p>
</dd>
<dt>homocysteine</dt><dd><p>homocysteine level.</p>
</dd>
</dl>



<h3>Details</h3>

<p>The code used to generate this data is documented
in the source version of this package under 'data-raw/'.
This data is composed of adults aged at least 20 years.
Individuals who have smoked at least 100 cigarettes
but do not now smoke at least 10 cigarettes daily are
excluded. Individuals with missing homocysteine
values, cotinine values, or smoking information are excluded.
After filtering for all these criteria,
five individuals with unknown education remain and are also excluded.
Missing values remain in the poverty ratio and bmi covariates.
</p>


<h3>Source</h3>

<p><a href="https://wwwn.cdc.gov/nchs/nhanes/ContinuousNhanes/Default.aspx?BeginYear=2005">https://wwwn.cdc.gov/nchs/nhanes/ContinuousNhanes/Default.aspx?BeginYear=2005</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data('nh0506_3groups')
</code></pre>

<hr>
<h2 id='optimize_controls'>Select control units that optimize covariate balance</h2><span id='topic+optimize_controls'></span>

<h3>Description</h3>

<p>Select control units within strata that optimize covariate balance.
Uses randomized rounding of a linear program or a mixed
integer linear program.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>optimize_controls(
  z,
  X,
  st,
  importances = NULL,
  treated = 1,
  ratio = NULL,
  q_s = NULL,
  treated_star = NULL,
  q_star_s = NULL,
  weight_star = 1,
  integer = FALSE,
  solver = "Rglpk",
  seed = NULL,
  runs = 1,
  time_limit = Inf,
  threads = 1,
  correct_sizes = TRUE,
  low_memory = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="optimize_controls_+3A_z">z</code></td>
<td>
<p>a factor with the <code>i</code>th entry equal to the treatment of unit <code>i</code>.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_x">X</code></td>
<td>
<p>a matrix or data frame containing constraints in the columns. The number
of rows should equal the length of <code>z</code>. Balance is achieved when a constraint
sums to 0, such that numbers closer to 0 are better. When a constraint
does not apply to a particular unit, the entry should be <code>NA</code>.
This should typically be generated using <code><a href="#topic+generate_constraints">generate_constraints</a>()</code>.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_st">st</code></td>
<td>
<p>a stratum vector with the <code>i</code>th entry equal to the
stratum of unit <code>i</code>. This should have the same order of units and length
as <code>z</code>.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_importances">importances</code></td>
<td>
<p>a vector with length equal to the number of constraints or columns
in <code>X</code>. This can be generated using <code><a href="#topic+generate_constraints">generate_constraints</a>()</code> and each nonnegative value
denotes how much to prioritize each constraint, with the default being 1
for all constraints.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_treated">treated</code></td>
<td>
<p>which treatment value should be considered the treated units. This
must be one of the values of <code>z</code>.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_ratio">ratio</code></td>
<td>
<p>a numeric or vector specifying the desired ratio of controls to 'treated' in
each stratum. If there is one control group and all treated units should be included,
this can be a numeric. Otherwise, this should be
a vector with one entry per treatment group, in the same order as the levels of
<code>z</code>, including the treated level. If <code>NULL</code>, <code>q_s</code> should be specified.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_q_s">q_s</code></td>
<td>
<p>a named vector or matrix indicating how many units are to be selected from each stratum.
If there is one control group and all treated units are desired, this can be a vector; otherwise,
this should have one row per treatment group, where the order of the rows matches the order of
the levels of <code>z</code>, including the treated level.
If <code>NULL</code>, <code>ratio</code> should be specified. If both are specified, <code>q_s</code> will take priority.
Typically, if the desired ratio is not feasible for every stratum, <code>q_s</code> should be generated
using <code><a href="#topic+generate_qs">generate_qs</a>()</code>.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_treated_star">treated_star</code></td>
<td>
<p>which treatment value should be considered the treated units
for the supplemental comparison. This
must be one of the values of <code>z</code>.
If multiple supplemental comparisons are desired, this should be a vector with one entry per supplemental
comparison.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_q_star_s">q_star_s</code></td>
<td>
<p>a named vector or matrix,
indicating how many supplemental units are to be selected from each stratum.
The matrix should have one row per treatment group, where the order of the rows matches the order of
the levels of <code>z</code>, including the treated level.
If multiple supplemental comparisons are desired, this should be a list with one entry per supplemental
comparison.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_weight_star">weight_star</code></td>
<td>
<p>a numeric stating how much to prioritize balance between the supplemental units as
compared to balance between the main units.
If multiple supplemental comparisons are desired, this should be a vector with one entry per supplemental
comparison.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_integer">integer</code></td>
<td>
<p>a logical stating whether to use a mixed integer programming solver
instead of randomized rounding. Default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_solver">solver</code></td>
<td>
<p>a character stating which solver to use to run the linear program.
Options are &quot;Rglpk&quot; (default) or &quot;gurobi&quot;. You must have the 'gurobi' package
installed to use the &quot;gurobi&quot; option. If available, this is the recommended solver.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_seed">seed</code></td>
<td>
<p>the seed to use when doing the randomized rounding of the linear program.
This will allow results to be reproduced if desired. The default is <code>NULL</code>,
which will choose a random seed to use and return.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_runs">runs</code></td>
<td>
<p>the number of times to run randomized rounding of the linear solution.
The objective values of all runs will be reported, but the detailed results
will only be reported for the run with the lowest objective value. The default is 1.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_time_limit">time_limit</code></td>
<td>
<p>numeric stating maximum amount of seconds for which the
program is allowed to run before aborting. Default is <code>Inf</code> for no time limit.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_threads">threads</code></td>
<td>
<p>The maximum number of threads that should be used. This is only
applicable if <code>solver = 'gurobi'</code>.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_correct_sizes">correct_sizes</code></td>
<td>
<p>boolean stating whether the desired sample sizes should
be exactly correct (if <code>correct_sizes = TRUE</code>) or only need to be correct
in expectation. For multiple comparisons, sample sizes may only be
correct in expectation.</p>
</td></tr>
<tr><td><code id="optimize_controls_+3A_low_memory">low_memory</code></td>
<td>
<p>boolean stating whether some outputs should not be included
due to the scale of the problem being too large compared to memory space.
If <code>TRUE</code>, <code>eps</code> and <code>eps_star</code> will not be reported. Imbalances
can be computed post hoc using the <code><a href="#topic+check_balance">check_balance</a>()</code> instead.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>List containing:
</p>

<dl>
<dt><code>objective</code></dt><dd><p>objective value of the randomized rounding or mixed integer
linear program solution.</p>
</dd>
<dt><code>objective_wo_importances</code></dt><dd><p>objective value of the randomized rounding or mixed integer
linear program solution not weighted by the variable importances.</p>
</dd>
<dt><code>eps</code></dt><dd><p>the amount of imbalance obtained in each constraint from the linear program.
The row names specify the covariate, the population of interest, and, if there are
more than two comparison groups, which groups are being compared.</p>
</dd>
<dt><code>eps_star</code></dt><dd><p>same as <code>eps</code> but for the supplemental units instead of the units
in the main comparison. If there are multiple supplemental comparisons, this is a list.
If there are none, this is <code>NULL</code>.</p>
</dd>
<dt><code>importances</code></dt><dd><p>the importance of each on the balance constraints.</p>
</dd>
<dt><code>weight_star</code></dt><dd><p>the importance of balancing in the supplemental comparison
relative to the main comparison. If there are multiple supplemental comparisons,
this is a vector. If there are none, this is <code>NULL</code>.</p>
</dd>
<dt><code>selected</code></dt><dd><p>whether each unit was selected for the main comparison.</p>
</dd>
<dt><code>selected_star</code></dt><dd><p>whether each unit was selected for the supplement.
If there are multiple supplemental comparisons, this is a list.
If there are none, this is <code>NULL</code>.</p>
</dd>
<dt><code>pr</code></dt><dd><p>the linear program weight assigned to each unit for the main comparison.</p>
</dd>
<dt><code>pr_star</code></dt><dd><p>the linear program weight assigned to each unit for the supplement.
If there are multiple supplemental comparisons, this is a list.
If there are none, this is <code>NULL</code>.</p>
</dd>
<dt><code>rrdetails</code></dt><dd><p>A list containing:
</p>

<dl>
<dt><code>seed</code></dt><dd><p>the seed used before commencing the random sampling.</p>
</dd>
<dt><code>run_objectives</code></dt><dd><p>the objective values for each run of randomized rounding.</p>
</dd>
<dt><code>run_objectives_wo_importances</code></dt><dd><p>the objective values for each run of randomized rounding,
not scaled by constraint importances.</p>
</dd>
</dl>
</dd>
<dt><code>lpdetails</code></dt><dd><p>the full return of the function <code><a href="Rglpk.html#topic+Rglpk_solve_LP">Rglpk_solve_LP</a>()</code>
or <code>gurobi()</code> plus information about the epsilons and objective values
for the linear program solution.</p>
</dd>
</dl>



<h3>Examples</h3>

<pre><code class='language-R'>
data('nh0506')

# Create strata
age_cat &lt;- cut(nh0506$age,
               breaks = c(19, 39, 50, 85),
               labels = c('&lt; 40 years', '40 - 50 years', '&gt; 50 years'))
strata &lt;- age_cat : nh0506$sex

# Balance age, race, education, poverty ratio, and bmi both across and within the levels of strata
constraints &lt;- generate_constraints(
                 balance_formulas = list(age + race + education + povertyr + bmi ~ 1 + strata),
                 z = nh0506$z,
                 data = nh0506)

# Choose one control for every treated unit in each stratum,
# balancing the covariates as described by the constraints
results &lt;- optimize_controls(z = nh0506$z,
                             X = constraints$X,
                             st = strata,
                             importances = constraints$importances,
                             ratio = 1)

# If you want to use a ratio that's not feasible,
# you can supply a vector of the desired number of controls per stratum, q_s,
# typically generated by creating a distance matrix between strata and using
# generate_qs():

## Not run: 
age_dist &lt;- matrix(data = c(0, 1, 2, 1, 0, 1, 2, 1, 0),
                   nrow = 3,
                   byrow = TRUE,
                   dimnames = list(levels(age_cat), levels(age_cat)))

sex_dist &lt;- matrix(data = c(0, 1, 1, 0),
                   nrow = 2,
                   dimnames = list(levels(nh0506$sex), levels(nh0506$sex)))

strata_dist &lt;- create_dist_matrix(age_dist, sex_dist)

qs &lt;- generate_qs(z = nh0506$z,
                  st = strata,
                  ratio = 2.5,
                  max_ratio = 2.6,
                  max_extra_s = 0,
                  strata_dist = strata_dist)

results &lt;- optimize_controls(z = nh0506$z,
                             X = constraints$X,
                             st = strata,
                             importances = constraints$importances,
                             q_s = qs)


## End(Not run)

# We can also have multiple treatment and control groups,
# as well as multiple simultaneous comparisons:

## Not run: 
data('nh0506_3groups')
strata2 &lt;- cut(nh0506_3groups$age, breaks = c(19, 39, 50, 85),
              labels = c('&lt; 40 years', '40 - 50 years', '&gt; 50 years'))
constraints2 &lt;- generate_constraints(
  balance_formulas = list(age + race + education + povertyr + bmi + sex ~ 1 + strata2),
  z = nh0506_3groups$z,
  data = nh0506_3groups,
  treated = 'daily smoker')
q_star_s &lt;- matrix(c(rep(table(nh0506_3groups$z, strata2)['some smoking', ] -
                           table(nh0506_3groups$z, strata2)['daily smoker', ], 2),
                     rep(0, 3)), byrow = TRUE, nrow = 3,
                   dimnames = list(levels(nh0506_3groups$z), levels(strata2)))

results &lt;- optimize_controls(z = nh0506_3groups$z,
                             X = constraints2$X,
                             importances = constraints2$importances,
                             st = strata2,
                             ratio = 1,
                             treated = 'daily smoker',
                             treated_star = 'some smoking',
                             q_star_s = q_star_s,
                             correct_sizes = FALSE)


## End(Not run)
</code></pre>

<hr>
<h2 id='parse_formula'>Parse the nonstandard balance formulas</h2><span id='topic+parse_formula'></span>

<h3>Description</h3>

<p>This function takes nonstandard formulas as inputs and returns regular formulas
as well as lists of weights to be used in <code><a href="#topic+generate_constraints">generate_constraints</a>()</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>parse_formula(balance_formula, default_rhs = NULL, data = NULL)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="parse_formula_+3A_balance_formula">balance_formula</code></td>
<td>
<p>a formula that may have multiple terms on the left hand side,
&quot;.&quot; on the left hand side, and coefficients, making it not a standard formula.</p>
</td></tr>
<tr><td><code id="parse_formula_+3A_default_rhs">default_rhs</code></td>
<td>
<p>the list of <code>balance_formulas</code> can also contain entries
that are just the character corresponding to a covariate to balance. If so,
the covariate will be balanced according to <code>default_rhs</code>.</p>
</td></tr>
<tr><td><code id="parse_formula_+3A_data">data</code></td>
<td>
<p>a data frame containing the relevant covariates in the columns. The number
of rows should equal the length of <code>treated</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A named list containing <code>new_formula</code>: the standard formula to be used
in <code><a href="#topic+generate_constraints">generate_constraints</a></code>, <code>rhs_weights</code>: a named list with the
coefficients of the terms on the right hand side, and <code>lhs_weights</code>:
a named list with coefficients of the terms on the left hand side.
</p>

<hr>
<h2 id='plot_stand_diffs'>Plot standardized differences in means</h2><span id='topic+plot_stand_diffs'></span>

<h3>Description</h3>

<p>Used within the <code><a href="#topic+check_balance">check_balance</a></code> function to plot the standardized differences calculated
in the format of Love (2002).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>plot_stand_diffs(sds, type)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="plot_stand_diffs_+3A_sds">sds</code></td>
<td>
<p>Standardized differences generated with <code><a href="#topic+get_stand_diffs">get_stand_diffs</a></code>.</p>
</td></tr>
<tr><td><code id="plot_stand_diffs_+3A_type">type</code></td>
<td>
<p>One of the following, stating which standardized differences to plot:
</p>

<dl>
<dt>across</dt><dd><p>standardized differences across the population</p>
</dd>
<dt>strata_avg</dt><dd><p>weighted average of the standardized differences within the strata
(weighted by stratum size)</p>
</dd>
<dt>pair</dt><dd><p>two facets displaying both
the previous plots together</p>
</dd>
<dt>strata</dt><dd><p>list of plots for the standardized differences
within each stratum</p>
</dd></dl>
</td></tr>
</table>


<h3>Value</h3>

<p>Either a ggplot object or a list of ggplot objects (if <code>type</code> is 'strata')
</p>


<h3>References</h3>

<p>Love, T. E. (2002), &quot;Displaying covariate balance after adjustment for selection bias&quot;,
Joint Statistical Meetings, yumpu.com/en/document/read/41664623.
</p>

<hr>
<h2 id='presolve_EMD'>Solve the earthmover's distance problem</h2><span id='topic+presolve_EMD'></span>

<h3>Description</h3>

<p>Determine how many controls should be chosen from each stratum to minimize
the distance between the strata of the chosen controls and those that were desired.
Used within <code><a href="#topic+generate_qs">generate_qs</a>()</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>presolve_EMD(S, desired_qs, max_s, strata_dist_flat)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="presolve_EMD_+3A_s">S</code></td>
<td>
<p>the total number of strata.</p>
</td></tr>
<tr><td><code id="presolve_EMD_+3A_desired_qs">desired_qs</code></td>
<td>
<p>a named vector containing the number of controls desired in
each stratum with names matching the strata names.</p>
</td></tr>
<tr><td><code id="presolve_EMD_+3A_max_s">max_s</code></td>
<td>
<p>a vector containing the maximum number of controls that should
be selected in each stratum. The order of the strata should match that of <code>desired_qs</code>.</p>
</td></tr>
<tr><td><code id="presolve_EMD_+3A_strata_dist_flat">strata_dist_flat</code></td>
<td>
<p>a flattened distance matrix between the strata.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A named vector with names identical to those of <code>desired_qs</code> and
elements containing the number of controls to select from the given stratum.
</p>

<hr>
<h2 id='process_qs'>Process the desired sample sizes for <code><a href="#topic+optimize_controls">optimize_controls</a>()</code></h2><span id='topic+process_qs'></span>

<h3>Description</h3>

<p>Processes the inputs to <code><a href="#topic+optimize_controls">optimize_controls</a>()</code> to formulate sample size constraints.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>process_qs(ratio, q_s, n_s, treated, k, group, st_vals, stratios)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="process_qs_+3A_ratio">ratio</code></td>
<td>
<p>a numeric or vector specifying the desired ratio of controls to 'treated' in
each stratum. If there is one control group and all treated units should be included,
this can be a numeric. Otherwise, this should be
a vector with one entry per treatment group, in the same order as the levels of
<code>z</code>, including the treated level. If <code>NULL</code>, <code>q_s</code> should be specified.</p>
</td></tr>
<tr><td><code id="process_qs_+3A_q_s">q_s</code></td>
<td>
<p>a named vector or matrix indicating how many units are to be selected from each stratum.
If there is one control group and all treated units are desired, this can be a vector; otherwise,
this should have one row per treatment group, where the order of the rows matches the order of
the levels of <code>z</code>, including the treated level.
If <code>NULL</code>, <code>ratio</code> should be specified. If both are specified, <code>q_s</code> will take priority.
Typically, if the desired ratio is not feasible for every stratum, <code>q_s</code> should be generated
using <code><a href="#topic+generate_qs">generate_qs</a>()</code>.</p>
</td></tr>
<tr><td><code id="process_qs_+3A_treated">treated</code></td>
<td>
<p>which treatment value should be considered the treated units. This
must be one of the values of <code>z</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A matrix of sample sizes for each treatment and stratum.
</p>

<hr>
<h2 id='randomized_rounding'>Sample integer solution from linear programming solution with correct sample sizes</h2><span id='topic+randomized_rounding'></span>

<h3>Description</h3>

<p>The linear programming solution of <code><a href="#topic+balance_LP">balance_LP</a>()</code> that is used
within <code><a href="#topic+optimize_controls">optimize_controls</a>()</code> sometimes selects fractional units.
Here, we select any unit the linear programming solution chose with coefficient 1.
Then, we select the remaining required number of units from those that have
fractional solutions by sampling with probabilities equal to the linear
programming solution and fixed sample size. Used within <code><a href="#topic+optimize_controls">optimize_controls</a>()</code>
if <code>correct_sizes = TRUE</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>randomized_rounding(o, N, st, st_vals, S, z)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="randomized_rounding_+3A_o">o</code></td>
<td>
<p>linear programming results, as found in the 'o' element of the
returned list from <code><a href="#topic+balance_LP">balance_LP</a>()</code>.</p>
</td></tr>
<tr><td><code id="randomized_rounding_+3A_n">N</code></td>
<td>
<p>the total number of available controls in the data.</p>
</td></tr>
<tr><td><code id="randomized_rounding_+3A_st">st</code></td>
<td>
<p>a stratum vector with the <code>i</code>th entry equal to the
stratum of unit <code>i</code>. This should have the same order of units and length
as <code>z</code>.</p>
</td></tr>
<tr><td><code id="randomized_rounding_+3A_st_vals">st_vals</code></td>
<td>
<p>the unique stratum levels contained in <code>st</code>.</p>
</td></tr>
<tr><td><code id="randomized_rounding_+3A_s">S</code></td>
<td>
<p>the number of unique stratum levels contained in <code>st</code>.</p>
</td></tr>
<tr><td><code id="randomized_rounding_+3A_z">z</code></td>
<td>
<p>a factor with the <code>i</code>th entry equal to the treatment of unit <code>i</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Dataframe with two columns: <code>pr</code>, which contains
the coefficient determined for that unit from the linear programming
solution, and <code>select</code>, a boolean vector stating whether that
unit was selected for inclusion by randomized rounding.
</p>

<hr>
<h2 id='randomized_rounding_expectation'>Sample integer solution from linear programming solution with sample sizes correct in expectation</h2><span id='topic+randomized_rounding_expectation'></span>

<h3>Description</h3>

<p>The linear programming solution of <code><a href="#topic+balance_LP">balance_LP</a>()</code> that is used
within <code><a href="#topic+optimize_controls">optimize_controls</a>()</code> sometimes selects fractional control units.
Here, we select any unit the linear programming solution chose with coefficient 1.
Then, we select sample each unit with a fractional solution with
probability equal to the linear programming solution. The total sample
size is then correct in expectation. Used within <code><a href="#topic+optimize_controls">optimize_controls</a>()</code>
if <code>correct_sizes = FALSE</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>randomized_rounding_expectation(o, N, n_comp)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="randomized_rounding_expectation_+3A_o">o</code></td>
<td>
<p>linear programming results, as found in the 'o' element of the
returned list from <code><a href="#topic+balance_LP">balance_LP</a>()</code>.</p>
</td></tr>
<tr><td><code id="randomized_rounding_expectation_+3A_n">N</code></td>
<td>
<p>the total number of available controls in the data.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Dataframe with two columns: <code>pr</code>, which contains
the coefficient determined for that unit from the linear programming
solution, and <code>select</code>, a boolean vector stating whether that
unit was selected for inclusion by randomized rounding.
</p>

<hr>
<h2 id='stand'>Standardize covariate vector for balance constraint</h2><span id='topic+stand'></span>

<h3>Description</h3>

<p>This function is used by <code><a href="#topic+generate_constraints">generate_constraints</a>()</code> to standardize
covariate vectors to become balance constraints.
The function divides the covariate values by the treated or average group
standard deviation (across strata).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>stand(z, x, denom_variance = "treated", treated = 1, autogen_missing = 50)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="stand_+3A_z">z</code></td>
<td>
<p>a factor with the <code>i</code>th entry equal to the treatment of unit <code>i</code>.</p>
</td></tr>
<tr><td><code id="stand_+3A_x">x</code></td>
<td>
<p>a covariate vector with <code>i</code>th entry equal to the
covariate value of unit <code>i</code>. This should have the same order of units and
length as <code>z</code>.</p>
</td></tr>
<tr><td><code id="stand_+3A_denom_variance">denom_variance</code></td>
<td>
<p>character stating what variance to use in the standardization:
either the default &quot;treated&quot;, meaning the standardization will use the
treated variance (across all strata), where the treated group is declared in
the <code>treated</code> argument, or &quot;pooled&quot;, meaning
the standardization will use the average of the variances of each treatment group.</p>
</td></tr>
<tr><td><code id="stand_+3A_treated">treated</code></td>
<td>
<p>which treatment value should be considered the treated units. This
must be one of the values of <code>z</code>.</p>
</td></tr>
<tr><td><code id="stand_+3A_autogen_missing">autogen_missing</code></td>
<td>
<p>whether to automatically generate missingness constraint
and how heavily to prioritize it. Should be a numeric
or <code>NULL</code> value. <code>NULL</code> indicates that
a constraint to balance the rate of missingness (denoted by <code>NA</code>
in <code>x</code>) should not be automatically generated. Note that this is not
recommended unless the user has already accounted for missing values.
If not <code>NULL</code>, <code>autogen_missing</code> should be a numeric stating how heavily
to prioritize generated missingness constraints over covariate constraint.
The default is 50.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list with two components:
</p>

<dl>
<dt>covariate</dt><dd><p>a balance constraint for the standardized covariate values
of all unites.</p>
</dd>
<dt>missingness</dt><dd><p>a corresponding balance constraint for the rate of missingness if
<code>autogen_missing</code> not <code>NULL</code>, otherwise <code>NULL</code>.</p>
</dd>
</dl>


<hr>
<h2 id='verify_inputs'>Verify the inputs to <code><a href="#topic+optimize_controls">optimize_controls</a>()</code></h2><span id='topic+verify_inputs'></span>

<h3>Description</h3>

<p>Makes sure that the inputs to <code><a href="#topic+optimize_controls">optimize_controls</a>()</code> are in the correct
format and feasible.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>verify_inputs(X, importances, ratio, q_s, st, z, treated, integer, solver)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="verify_inputs_+3A_x">X</code></td>
<td>
<p>a matrix or data frame containing constraints in the columns. The number
of rows should equal the length of <code>z</code>. Balance is achieved when a constraint
sums to 0, such that numbers closer to 0 are better. When a constraint
does not apply to a particular unit, the entry should be <code>NA</code>.
This should typically be generated using <code><a href="#topic+generate_constraints">generate_constraints</a>()</code>.</p>
</td></tr>
<tr><td><code id="verify_inputs_+3A_importances">importances</code></td>
<td>
<p>a vector with length equal to the number of constraints or columns
in <code>X</code>. This can be generated using <code><a href="#topic+generate_constraints">generate_constraints</a>()</code> and each nonnegative value
denotes how much to prioritize each constraint, with the default being 1
for all constraints.</p>
</td></tr>
<tr><td><code id="verify_inputs_+3A_ratio">ratio</code></td>
<td>
<p>a numeric or vector specifying the desired ratio of controls to 'treated' in
each stratum. If there is one control group and all treated units should be included,
this can be a numeric. Otherwise, this should be
a vector with one entry per treatment group, in the same order as the levels of
<code>z</code>, including the treated level. If <code>NULL</code>, <code>q_s</code> should be specified.</p>
</td></tr>
<tr><td><code id="verify_inputs_+3A_q_s">q_s</code></td>
<td>
<p>a named vector or matrix indicating how many units are to be selected from each stratum.
If there is one control group and all treated units are desired, this can be a vector; otherwise,
this should have one row per treatment group, where the order of the rows matches the order of
the levels of <code>z</code>, including the treated level.
If <code>NULL</code>, <code>ratio</code> should be specified. If both are specified, <code>q_s</code> will take priority.
Typically, if the desired ratio is not feasible for every stratum, <code>q_s</code> should be generated
using <code><a href="#topic+generate_qs">generate_qs</a>()</code>.</p>
</td></tr>
<tr><td><code id="verify_inputs_+3A_st">st</code></td>
<td>
<p>a stratum vector with the <code>i</code>th entry equal to the
stratum of unit <code>i</code>. This should have the same order of units and length
as <code>z</code>.</p>
</td></tr>
<tr><td><code id="verify_inputs_+3A_z">z</code></td>
<td>
<p>a factor with the <code>i</code>th entry equal to the treatment of unit <code>i</code>.</p>
</td></tr>
<tr><td><code id="verify_inputs_+3A_treated">treated</code></td>
<td>
<p>which treatment value should be considered the treated units. This
must be one of the values of <code>z</code>.</p>
</td></tr>
<tr><td><code id="verify_inputs_+3A_integer">integer</code></td>
<td>
<p>a logical stating whether to use a mixed integer programming solver
instead of randomized rounding. Default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="verify_inputs_+3A_solver">solver</code></td>
<td>
<p>a character stating which solver to use to run the linear program.
Options are &quot;Rglpk&quot; (default) or &quot;gurobi&quot;. You must have the 'gurobi' package
installed to use the &quot;gurobi&quot; option. If available, this is the recommended solver.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>No return value. If there is a problem with the inputs to <code><a href="#topic+optimize_controls">optimize_controls</a>()</code>,
an error is raised.
</p>

<hr>
<h2 id='verify_inputs_EMD'>Verify the inputs to the earthmover's distance problem</h2><span id='topic+verify_inputs_EMD'></span>

<h3>Description</h3>

<p>Check that the ratio, strata, and treated indicator provided to <code><a href="#topic+generate_qs">generate_qs</a>()</code>
are in the correct forms and that the desired ratio is feasible
across the population.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>verify_inputs_EMD(ratio, st, z, treated = 1)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="verify_inputs_EMD_+3A_ratio">ratio</code></td>
<td>
<p>a numeric or vector specifying the desired ratio of controls to 'treated' in
each stratum. If there is one control group and all treated units should be included,
this can be a numeric. Otherwise, this should be
a vector with one entry per treatment group, in the same order as the levels of
<code>z</code>, including the treated level. If <code>NULL</code>, <code>q_s</code> should be specified.</p>
</td></tr>
<tr><td><code id="verify_inputs_EMD_+3A_st">st</code></td>
<td>
<p>a stratum vector with the <code>i</code>th entry equal to the
stratum of unit <code>i</code>. This should have the same order of units and length
as <code>z</code>.</p>
</td></tr>
<tr><td><code id="verify_inputs_EMD_+3A_z">z</code></td>
<td>
<p>a factor with the <code>i</code>th entry equal to the treatment of unit <code>i</code>.</p>
</td></tr>
<tr><td><code id="verify_inputs_EMD_+3A_treated">treated</code></td>
<td>
<p>which treatment value should be considered the treated units. This
must be one of the values of <code>z</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>No return value. If there is a problem with the inputs to <code><a href="#topic+generate_qs">generate_qs</a>()</code>,
an error is raised.
</p>

<hr>
<h2 id='verify_multi_comp_inputs'>Verify the inputs for supplemental comparisons to <code><a href="#topic+optimize_controls">optimize_controls</a>()</code></h2><span id='topic+verify_multi_comp_inputs'></span>

<h3>Description</h3>

<p>Makes sure that the inputs for supplemental comparisons to <code><a href="#topic+optimize_controls">optimize_controls</a>()</code> are in the correct
format and feasible.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>verify_multi_comp_inputs(
  q_s,
  q_star_s,
  n_s,
  treated,
  treated_star,
  weight_star,
  group,
  correct_sizes
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="verify_multi_comp_inputs_+3A_q_s">q_s</code></td>
<td>
<p>a named vector or matrix indicating how many units are to be selected from each stratum.
If there is one control group and all treated units are desired, this can be a vector; otherwise,
this should have one row per treatment group, where the order of the rows matches the order of
the levels of <code>z</code>, including the treated level.
If <code>NULL</code>, <code>ratio</code> should be specified. If both are specified, <code>q_s</code> will take priority.
Typically, if the desired ratio is not feasible for every stratum, <code>q_s</code> should be generated
using <code><a href="#topic+generate_qs">generate_qs</a>()</code>.</p>
</td></tr>
<tr><td><code id="verify_multi_comp_inputs_+3A_q_star_s">q_star_s</code></td>
<td>
<p>a named vector or matrix,
indicating how many supplemental units are to be selected from each stratum.
The matrix should have one row per treatment group, where the order of the rows matches the order of
the levels of <code>z</code>, including the treated level.
If multiple supplemental comparisons are desired, this should be a list with one entry per supplemental
comparison.</p>
</td></tr>
<tr><td><code id="verify_multi_comp_inputs_+3A_treated">treated</code></td>
<td>
<p>which treatment value should be considered the treated units. This
must be one of the values of <code>z</code>.</p>
</td></tr>
<tr><td><code id="verify_multi_comp_inputs_+3A_treated_star">treated_star</code></td>
<td>
<p>which treatment value should be considered the treated units
for the supplemental comparison. This
must be one of the values of <code>z</code>.
If multiple supplemental comparisons are desired, this should be a vector with one entry per supplemental
comparison.</p>
</td></tr>
<tr><td><code id="verify_multi_comp_inputs_+3A_weight_star">weight_star</code></td>
<td>
<p>a numeric stating how much to prioritize balance between the supplemental units as
compared to balance between the main units.
If multiple supplemental comparisons are desired, this should be a vector with one entry per supplemental
comparison.</p>
</td></tr>
<tr><td><code id="verify_multi_comp_inputs_+3A_correct_sizes">correct_sizes</code></td>
<td>
<p>boolean stating whether the desired sample sizes should
be exactly correct (if <code>correct_sizes = TRUE</code>) or only need to be correct
in expectation. For multiple comparisons, sample sizes may only be
correct in expectation.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>No return value. If there is a problem with the inputs to <code><a href="#topic+optimize_controls">optimize_controls</a>()</code>,
an error is raised.
</p>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
