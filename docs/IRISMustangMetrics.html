<!DOCTYPE html><html><head><title>Help for package IRISMustangMetrics</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {IRISMustangMetrics}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#basicStatsMetric'>
<p>Min, median, mean, rms variance, max, and number of unique values of a signal</p></a></li>
<li><a href='#convertBssErrors'><p>Generate Human Readable MUSTANG Errors</p></a></li>
<li><a href='#correlationMetric'><p>Correlation between channels</p></a></li>
<li><a href='#createBssUrl'><p>Create URL to retrieve measurements from the MUSTANG BSS</p></a></li>
<li><a href='#crossCorrelationMetric'><p>Correlation between channels</p></a></li>
<li><a href='#dailyDCOffsetMetric'><p>DC Offset Detection</p></a></li>
<li><a href='#DCOffsetTimesMetric'><p>DC Offset Detection</p></a></li>
<li><a href='#gapsMetric'>
<p>Gaps and overlaps in a signal</p></a></li>
<li><a href='#GeneralValueMetric-class'><p>Class <code>"GeneralValueMetric"</code></p></a></li>
<li><a href='#getBssMetricList'><p>Retrieve measurements XML from the MUSTANG BSS and convert them to a metricList</p></a></li>
<li><a href='#getGeneralValueMetrics'><p>Retrieve measurements from the MUSTANG BSS</p></a></li>
<li><a href='#getMetricFunctionMetadata'><p>Return JSON Metadata for Metric Functions</p></a></li>
<li><a href='#getMetricsXml'><p> Retrieve measurements XML from the MUSTANG BSS</p></a></li>
<li><a href='#getMustangMetrics'><p>Retrieve measurements from the MUSTANG BSS</p></a></li>
<li><a href='#getPsdMetrics'><p>Retrieve measurements from the MUSTANG BSS</p></a></li>
<li><a href='#getSingleValueMetrics'><p>Retrieve measurements from the MUSTANG BSS</p></a></li>
<li><a href='#IRISMustangMetrics-package'><p>Utilities for calculating seismic metrics from EarthScope (formerly IRIS DMC) data</p></a></li>
<li><a href='#maxRangeMetric'><p>Maximum daily sample range calculated over a rolling window</p></a></li>
<li><a href='#metricList2DF'><p>Convert a MetricList into a Tidy Dataframe</p></a></li>
<li><a href='#metricList2DFList'><p>Conver a metricList into a list of dataframes</p></a></li>
<li><a href='#metricList2Xml'><p>Create XML for the BSS</p></a></li>
<li><a href='#MultipleTimeValueMetric-class'><p>Class <code>"MultipleTimeValueMetric"</code></p></a></li>
<li><a href='#PSDMetric'><p>Power Spectral Density of a signal</p></a></li>
<li><a href='#sampleRateChannelMetric'><p>Sample rate consistency between miniSEED and metadata</p></a></li>
<li><a href='#sampleRateRespMetric'><p>Sample rate consistency between miniSEED and metadata</p></a></li>
<li><a href='#saveMetricList'><p>Save a MetricList as RData or XML</p></a></li>
<li><a href='#SingleValueMetric-class'><p>Class <code>"SingleValueMetric"</code></p></a></li>
<li><a href='#SNRMetric'><p>Signal to Noise Ratio</p></a></li>
<li><a href='#SpectrumMetric-class'><p> Class <code>"SpectrumMetric"</code></p></a></li>
<li><a href='#spectrumMetric2Xml'><p>Convert a SpectrumMetric into XML for the BSS</p></a></li>
<li><a href='#spikesMetric'><p>Find spikes using a rolling Hampel filter</p></a></li>
<li><a href='#STALTAMetric'><p>Maximum STA/LTA of a signal</p></a></li>
<li><a href='#stateOfHealthMetric'><p>State of Health metrics</p></a></li>
<li><a href='#timesMetric2Xml'><p>Create XML for the BSS</p></a></li>
<li><a href='#transferFunctionMetric'><p>Cross-spectral comparison</p></a></li>
<li><a href='#upDownTimesMetric'><p>Up/down times for a channel</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Version:</td>
<td>2.4.6</td>
</tr>
<tr>
<td>Title:</td>
<td>Statistics and Metrics for Seismic Data</td>
</tr>
<tr>
<td>Author:</td>
<td>Jonathan Callahan [aut],
  Rob Casey [aut],
  Mary Templeton [aut],
  Gillian Sharer [aut, cre]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Gillian Sharer &lt;gillian.sharer@earthscope.org&gt;</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 3.2.0), IRISSeismic (&ge; 1.3.0)</td>
</tr>
<tr>
<td>Imports:</td>
<td>methods, RCurl, seismicRoll (&ge; 1.1.4), signal, stringr, XML,
stats, pracma, dplyr (&ge; 0.4.3)</td>
</tr>
<tr>
<td>Collate:</td>
<td>Class-Metric.R BSSUtils.R ISPAQUtils.R basicStatsMetric.R
correlationMetric.R crossCorrelationMetric.R
dailyDCOffsetMetric.R DCOffsetTimesMetric.R gapsMetric.R
PSDMetric.R SNRMetric.R spikesMetric.R STALTAMetric.R
stateOfHealthMetric.R upDownTimesMetric.R
transferFunctionMetric.R maxRangeMetric.R
sampleRateChannelMetric.R sampleRateRespMetric.R</td>
</tr>
<tr>
<td>Description:</td>
<td>Classes and functions for metrics calculation as part of the
             'IRIS DMC MUSTANG' project. The functionality in this package 
             builds upon the base classes of the 'IRISSeismic' package.
             Metrics include basic statistics as well as higher level
             'health' metrics that can help identify problematic seismometers.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a> | <a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a> [expanded from: GPL (&ge; 2)]</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2023-08-22 02:41:01 UTC; gilliansharer</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2023-08-22 08:50:05 UTC</td>
</tr>
</table>
<hr>
<h2 id='basicStatsMetric'>
Min, median, mean, rms variance, max, and number of unique values of a signal
</h2><span id='topic+basicStatsMetric'></span>

<h3>Description</h3>

<p>The basicStatsMetric() function calculates the <code>min, median, mean, max, rmsVariance</code> and number of unique values for
the input seismic signal.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>basicStatsMetric(st)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="basicStatsMetric_+3A_st">st</code></td>
<td>
<p> a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This metric applies the <code>min, median, mean</code> and <code>max</code> methods of <code>Stream</code> objects
to the <code>st</code> parameter to calculate the following metrics:
</p>

<ul>
<li> <p><code>sample_min</code>
</p>
</li>
<li> <p><code>sample_median</code>
</p>
</li>
<li> <p><code>sample_mean</code>
</p>
</li>
<li> <p><code>sample_max</code>
</p>
</li>
<li> <p><code>sample_rms</code>
</p>
</li></ul>

<p>It also calculates <code>length(unique(stmerged@traces[[1]]@data))</code>, where stmerged is the st parameter after <code>mergeTraces</code> is applied to it, for the following metric:
</p>

<ul>
<li> <p><code>sample_unique</code>
</p>
</li></ul>
  
<p>Any error messages generated in the process will pass through untrapped.
</p>


<h3>Value</h3>

<p>A list of <code>SingleValueMetric</code> objects is returned.
</p>


<h3>Note</h3>


<p>See the <code>seismic</code> package for documentation on <code>Stream</code> objects and the <code>getDataselect</code> method.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get the waveform
starttime &lt;- as.POSIXct("2012-01-24", tz="GMT")
endtime &lt;- as.POSIXct("2012-01-25", tz="GMT")
st &lt;- getDataselect(iris,"AK","PIN","","BHZ",starttime,endtime, inclusiveEnd=FALSE)

# Calculate some metrics and show the results
metricList &lt;- basicStatsMetric(st)
dummy &lt;- lapply(metricList, show)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='convertBssErrors'>Generate Human Readable MUSTANG Errors</h2><span id='topic+convertBssErrors'></span>

<h3>Description</h3>

<p>The MUSTANG database is in charge of storing the results of metrics calculations
and is accessed through a webservice API.
The <code>convertBssErrors</code> function extracts pertinent error information from the HTML returned
by MUSTANG on error conditions.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>convertBssErrors(err_msg)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="convertBssErrors_+3A_err_msg">err_msg</code></td>
<td>
<p>error text received from the MUSTANG</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A text string with the <code>root cause</code> extracted from 
the MUSTANG HTML Java error dump.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>See Also</h3>


<p><code><a href="#topic+SingleValueMetric-class">SingleValueMetric-class</a></code>,
<code><a href="#topic+metricList2Xml">metricList2Xml</a></code>,
<code><a href="#topic+getMetricsXml">getMetricsXml</a></code>,
<code><a href="#topic+getBssMetricList">getBssMetricList</a></code>,
</p>

<hr>
<h2 id='correlationMetric'>Correlation between channels</h2><span id='topic+correlationMetric'></span>

<h3>Description</h3>

<p>The correlationMetric() function calculates the correlation between two streams of seismic data.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>correlationMetric(st1, st2)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="correlationMetric_+3A_st1">st1</code></td>
<td>
<p>a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
<tr><td><code id="correlationMetric_+3A_st2">st2</code></td>
<td>
<p>a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The correlation returned is a value in the range [0-1]. This 'pearson r' correlation
is  a measure of the strength and direction of the linear relationship between two
variables that is defined as the (sample) covariance of the variables divided by the
product of their (sample) standard deviations.
</p>
<p>Missing values are handled by casewise deletion with the following R code:
</p>
<pre>
cor(x,y,use="na.or.complete")
</pre>


<h3>Value</h3>

<p>A list with a single <code>SingleValueMetric</code> object is returned.
The metric name is <code>cross_talk</code>.
</p>


<h3>Note</h3>

<p>Seismic streams passed to <code>correlationMetric</code> must have the same network and station,
must cover the same time range and must have the same sampling rate.
</p>
<p>The metricList generated for this two-channel metric will have a SNCL code of the form:
<code>N.S.L1:L2.C1:C2.Q</code>.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get seismic traces
starttime &lt;- as.POSIXct("2013-03-01", tz="GMT")
endtime &lt;- as.POSIXct("2013-03-02",tz="GMT")
stZ &lt;- getDataselect(iris,"IU","ANMO","00","BHZ",starttime,endtime,inclusiveEnd=FALSE)
st1 &lt;- getDataselect(iris,"IU","ANMO","00","BH1",starttime,endtime,inclusiveEnd=FALSE)
st2 &lt;- getDataselect(iris,"IU","ANMO","00","BH2",starttime,endtime,inclusiveEnd=FALSE)

# Calculate correlationMetric
correlationMetric(stZ,st1)[[1]]
correlationMetric(stZ,st2)[[1]]
correlationMetric(st1,st2)[[1]]
  
## End(Not run)
</code></pre>

<hr>
<h2 id='createBssUrl'>Create URL to retrieve measurements from the MUSTANG BSS </h2><span id='topic+createBssUrl'></span><span id='topic+createBssUrl+2CIrisClient+2Ccharacter+2Ccharacter+2Ccharacter+2Ccharacter+2CPOSIXct+2CPOSIXct+2Ccharacter-method'></span>

<h3>Description</h3>

<p>The <code>createBssUrl</code> method of the <code>IrisClient</code> returns a URL that can be used to make
a request of the MUSTANG BSS (Backend Storage System).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>createBssUrl(obj, network, station, location, channel, 
             starttime, endtime, metricName, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="createBssUrl_+3A_obj">obj</code></td>
<td>
<p> an <code>IrisClient</code> object </p>
</td></tr>
<tr><td><code id="createBssUrl_+3A_network">network</code></td>
<td>
<p> a character string with the two letter seismic network code </p>
</td></tr>
<tr><td><code id="createBssUrl_+3A_station">station</code></td>
<td>
<p> a character string with the station code </p>
</td></tr>
<tr><td><code id="createBssUrl_+3A_location">location</code></td>
<td>
<p> a character string with the location code </p>
</td></tr>
<tr><td><code id="createBssUrl_+3A_channel">channel</code></td>
<td>
<p> a character string with the three letter channel code </p>
</td></tr>
<tr><td><code id="createBssUrl_+3A_starttime">starttime</code></td>
<td>
<p> a POSIXct class specifying the starttime (GMT) </p>
</td></tr>
<tr><td><code id="createBssUrl_+3A_endtime">endtime</code></td>
<td>
<p> a POSIXct class specifying the endtime (GMT) </p>
</td></tr>
<tr><td><code id="createBssUrl_+3A_metricname">metricName</code></td>
<td>
<p> a character string containing one or more comma separated metric names </p>
</td></tr>
<tr><td><code id="createBssUrl_+3A_...">...</code></td>
<td>
<p>optional arguments
<code>constraint</code> a character string containing value constraints 
<code>url</code> optional url of the BSS measurements service 
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>A blank location code should be specified as <code>location="--"</code>; Using <code>location=""</code> will return all location codes.
</p>
<p>The default MUSTANG measurement service when <code>url</code> is not specified is:
</p>
<p><code>http://service.iris.edu/mustang/measurements/1/query?</code>
</p>


<h3>Value</h3>

<p>A character string containing a BSS request URL
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+getSingleValueMetrics">getSingleValueMetrics</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Open a connection to IRIS DMC webservices (including the BSS)
iris &lt;- new("IrisClient", debug=TRUE)

starttime &lt;- as.POSIXct("2013-06-01", tz="GMT")
endtime &lt;- starttime + 30*24*3600
metricName &lt;- "sample_max,sample_min,sample_mean"

# Get the measurement dataframe
url &lt;- createBssUrl(iris,"IU","ANMO","00","BHZ",
                    starttime,endtime,metricName)

# This URL can be pasted into a web browser to see the BSS return values
</code></pre>

<hr>
<h2 id='crossCorrelationMetric'>Correlation between channels</h2><span id='topic+crossCorrelationMetric'></span>

<h3>Description</h3>

<p>The crossCorrelationMetric() function calculates the maximum absolute correlation (<code>polarity_check</code>) 
and lag at maximum correlation (<code>timing_drift</code>) associated with two streams of seismic data.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>crossCorrelationMetric(st1, st2, maxLagSecs=10, filter)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="crossCorrelationMetric_+3A_st1">st1</code></td>
<td>
<p>a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
<tr><td><code id="crossCorrelationMetric_+3A_st2">st2</code></td>
<td>
<p>a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
<tr><td><code id="crossCorrelationMetric_+3A_maxlagsecs">maxLagSecs</code></td>
<td>
<p>maximum number of seconds of lag to use</p>
</td></tr>
<tr><td><code id="crossCorrelationMetric_+3A_filter">filter</code></td>
<td>
<p>a <span class="pkg">signal</span> package filter to be applied before cross-correlating, optional</p>
</td></tr>
</table>


<h3>Details</h3>


<p>Details of the algorithm are as follows:
</p>

<ul>
<li><p>Both signals are demeaned and detrended
</p>
</li>
<li><p>If one signal has a higher sampling rate, it is decimated to the lower sampling rate using an IIR filter if it is a multiple of the lower sample rate. See (<code>signal::decimate</code>).
</p>
</li>
<li><p>Both signals are filtered, by default with a Butterworth 2-pole low pass filter with a 0.1 Hz (10 second) corner frequency. See (<code>signal::filter</code>).
</p>
</li>
<li><p>Signals are cross-correlated using the <code>stats::ccf()</code> function.
</p>
</li></ul>

<p>The maximum absolute correlation is saved as <code>polarity_check</code> while the lag at peak correlation is saved as <code>timing_drift</code>.
</p>
<p><b>Note:</b> For cross-correlation, seismic signals must not have any gaps &ndash; they must be contained in a single <code>Trace</code> object.
</p>


<h3>Value</h3>

<p>A list with one <code>GeneralValueMetric</code> object is returned.
The metric names is <code>polarity_check</code>.
</p>


<h3>Note</h3>

<p>The metricList generated for this two-channel metric will have an additional <code>sncl2</code> attribute identifying the SNCL in <code>st2</code>.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a> (R code),
Mary Templeton <a href="mailto:mary.templeton@earthscope.org">mary.templeton@earthscope.org</a> (algorithm)
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get the same signal, shifted by 3 seconds
starttime &lt;- as.POSIXct("2013-11-12 07:09:45",tz="GMT")
endtime &lt;- starttime + 600
st1 &lt;- getSNCL(iris,"NM.SLM.00.BHZ",starttime,endtime)
st2 &lt;- getSNCL(iris,"NM.SLM.00.BHZ",starttime+3,endtime+3)

# Cross-correlate
crossCorrelationMetric(st1,st2)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='dailyDCOffsetMetric'>DC Offset Detection</h2><span id='topic+dailyDCOffsetMetric'></span>

<h3>Description</h3>

<p>The dailyDCOffsetMetric() function identifies days with a jump in the signal mean.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>dailyDCOffsetMetric(df, 
                    offsetDays=5,
                    outlierWindow=7,
                    outlierThreshold=3.0,
                    outputType=1)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="dailyDCOffsetMetric_+3A_df">df</code></td>
<td>
<p>a dataframe containing <code>sample_mean</code> values obtained with getSingleValueMetrics()</p>
</td></tr>
<tr><td><code id="dailyDCOffsetMetric_+3A_offsetdays">offsetDays</code></td>
<td>
<p>number of days used in calculating weighting factors</p>
</td></tr>
<tr><td><code id="dailyDCOffsetMetric_+3A_outlierwindow">outlierWindow</code></td>
<td>
<p>window size passed to findOutliers() function in the <span class="pkg">seismicRoll</span> package</p>
</td></tr>
<tr><td><code id="dailyDCOffsetMetric_+3A_outlierthreshold">outlierThreshold</code></td>
<td>
<p>detection threshold passed to findOutliers() function in the <span class="pkg">seismicRoll</span> package</p>
</td></tr>
<tr><td><code id="dailyDCOffsetMetric_+3A_outputtype">outputType</code></td>
<td>
<p>if 1,  return last day of valid values (index= length(index)-floor(outlierWindow/2)); if 0, return all valid values (indices= max(offsetDays, floor(outlierWindow/2): length(index)-floor(outlierWindow/2)) </p>
</td></tr>
</table>


<h3>Details</h3>

<p>This algorithm calculates lagged differences of the daily mean timeseries over a window of <code>offsetDays</code> days.
Shifts in the mean that are persistent and  larger than the typical standard deviation of daily means will
generate higher metric values.
</p>

<p>Details of the algorithm are as follows
</p>
<pre>
# data0 = download requested daily means (in the 'df' dataframe), must be greater than max(offsetDays,outlierWindow)+floor(outlierWindow/2)
# data1 = remove outliers using MAD outlier detection with the 'outlier' arguments specified
# data2 = replace outliers with rolling median values using a default 7 day window, remove last floor(outlierWindow/2) number of samples.
# weights = calculate absolute lagged differences with 1-N day lags, default N=5
# metric0 = multiply the lagged differences together and take the N'th root
# stddev0 = calculate the rolling standard deviation of data2 with a N-day window
# METRIC = divide metric0 by the median value of stddev0
</pre>


<h3>Value</h3>

<p>A list is returned with a <code>SingleValueMetric</code> object for the last day-floor(outlierWindow/2) (default 3rd from last day) in the incoming dataframe if outputType=1 (one list element), otherwise the first+offsetDays to last day-floor(outlierWindow/2) (multiple list elements, one per day) if outputType=0.
</p>


<h3>Note</h3>

<p>Prefer 60+ days of sample_mean values to get a good estimate of the long term sample_mean standard deviation.
After initial testing on stations in the IU network, a metric value &gt; 10 appears to be indicative of a DC offset shift (this may vary across stations or networks and larger values may be preferred as indications of a potential station issue).
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+getSingleValueMetrics">getSingleValueMetrics</a></code>
</p>

<hr>
<h2 id='DCOffsetTimesMetric'>DC Offset Detection</h2><span id='topic+DCOffsetTimesMetric'></span>

<h3>Description</h3>

<p>The DCOffsetTimesMetric() function returns times where a shift in the signal mean is detected.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>DCOffsetTimesMetric(st, windowSecs, incrementSecs, threshold)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="DCOffsetTimesMetric_+3A_st">st</code></td>
<td>
<p>a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
<tr><td><code id="DCOffsetTimesMetric_+3A_windowsecs">windowSecs</code></td>
<td>
<p>chunk size (secs) used in DCOffset calculations (default=<code>1800</code>)</p>
</td></tr>
<tr><td><code id="DCOffsetTimesMetric_+3A_incrementsecs">incrementSecs</code></td>
<td>
<p>increment (secs) for starttime of sequential chunks (default=<code>windowSecs/2</code>)</p>
</td></tr>
<tr><td><code id="DCOffsetTimesMetric_+3A_threshold">threshold</code></td>
<td>
<p>threshold used in the detection metric (default=<code>0.9</code>)</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Conceptually, this algorithm asserts:  If the difference in means between sequential chunks of seismic signal
is greater than the typical std dev of a chunk then this marks a DC offset shift.
</p>

<p>Details of the algorithm are as follows
</p>
<pre>
# Merge all traces in the time period, filling gaps with missing values
# Break up the signal into windowSecs chunks spaced incrementSecs apart
# For each chunk calculate:
#     signal mean, signal standard deviation
# Resulting mean and std dev arrays are of length 47 for 24 hours of signal
# Metric = abs(lagged difference of chunk means) / mean(chunk std devs)
# DC offset = times when Metric &gt; threshold
</pre>


<h3>Value</h3>

<p>A list with a single <code>MultipleTimeValueMetric</code> object is returned.
</p>


<h3>Note</h3>

<p>The denominator of this metric was tested with both <code>mean(chunk std devs)</code> and with
<code>median(chunk std devs)</code> to identify a &quot;typical&quot; value for the chunk standard deviation.
It was found that using <code>median</code> resulted false offset detects whenever there was
a large seismic signal in an otherwise lo-noise signal.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get a signal with a DC offset problem
starttime &lt;- as.POSIXct("2012-10-26",tz="GMT")
endtime &lt;- starttime + 2*24*3600
st &lt;- getDataselect(iris,"IU","TARA","00","BHZ",starttime,endtime)

# Calculate the metric
metricList &lt;- DCOffsetTimesMetric(st)

# Extract values from the first element of the list
offsetTimes &lt;- metricList[[1]]@values

# Plot the signal and mark locations where a DC offset was detected
plot(st)
abline(v=offsetTimes,col='red')

## End(Not run)
</code></pre>

<hr>
<h2 id='gapsMetric'>
Gaps and overlaps in a signal
</h2><span id='topic+gapsMetric'></span>

<h3>Description</h3>

<p>The gapsMetric() function calculates metrics associated with gaps and overlaps in a seismic signal,
<em>i.e.</em> when <code>st</code> consists of more than one <code>Trace</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>gapsMetric(st)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="gapsMetric_+3A_st">st</code></td>
<td>
<p> a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function uses the output of the <code>getGaps</code> method of <code>Stream</code> objects
to calculate the following metrics:
</p>

<dl>
<dt><code>num_gaps</code>:</dt><dd><p>number of gaps found in <code>st</code></p>
</dd>
<dt><code>max_gap</code>:</dt><dd><p>legnth of maximum gap (sec) found in <code>st</code></p>
</dd>
<dt><code>num_overlaps</code>:</dt><dd><p>number of overlaps found in <code>st</code></p>
</dd>
<dt><code>max_overlap</code>:</dt><dd><p>legnth of maximum overlap (sec) found in <code>st</code></p>
</dd>
<dt><code>percent_availability</code>:</dt><dd><p>percentage of total requested time for which a signal is available</p>
</dd>
</dl>

<p>The <code>requestedStarttime</code> and <code>requestedEndtime</code> slots for the <code>Stream</code> are used to determine
gaps before the start of the first or after the end of the last <code>Trace</code> in the <code>Stream</code>.
</p>


<h3>Value</h3>

<p>A list of <code>SingleValueMetric</code> objects is returned.
</p>


<h3>Note</h3>


<p>See the <code>seismic</code> package for documentation on <code>Stream</code> objects and the <code>getDataselect</code> method.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get the waveform
starttime &lt;- as.POSIXct("2012-01-24", tz="GMT")
endtime &lt;- as.POSIXct("2012-01-25", tz="GMT")
st &lt;- getDataselect(iris,"AK","PIN","","BHZ",starttime,endtime)

# Calculate the gaps metrics and show the results
metricList &lt;- gapsMetric(st)
dummy &lt;- lapply(metricList, show)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='GeneralValueMetric-class'>Class <code>"GeneralValueMetric"</code></h2><span id='topic+GeneralValueMetric-class'></span><span id='topic+show+2CGeneralValueMetric-method'></span>

<h3>Description</h3>

<p>A container for metrics consisting of a vector of numeric values.  This information is used to create XML that is
then submitted to the MUSTANG Backend Storage System (BSS).
</p>


<h3>Objects from the Class</h3>

<p>Objects can be created by calls of the form:
</p>
<p><code>new("GeneralValueMetric", snclq, starttime, endtime, metricName, elementNames,  elementValues, valueStrings, quality_flag, quality_flagString)</code>
</p>
<p>Lists of <code>GeneralValueMetric</code> objects are returned by various metrics functions in this package.
</p>


<h3>Slots</h3>


<dl>
<dt><code>snclq</code>:</dt><dd><p>Object of class <code>"character"</code>: SNCLQ identifier.</p>
</dd>
<dt><code>starttime</code>:</dt><dd><p>Object of class <code>"POSIXct"</code>: Start time.</p>
</dd>
<dt><code>endtime</code>:</dt><dd><p>Object of class <code>"POSIXct"</code>: End time.</p>
</dd>
<dt><code>metricName</code>:</dt><dd><p>Object of class <code>"character"</code>: Name of the metric.</p>
</dd>
<dt><code>elementNames</code>:</dt><dd><p>Object of class <code>"character"</code>: Names of the elements storing the metric values (default=<code>"x"</code>).</p>
</dd>
<dt><code>elementValues</code>:</dt><dd><p>Object of class <code>"numeric"</code>: Numeric values.</p>
</dd>
<dt><code>valueStrings</code>:</dt><dd><p>Object of class <code>"character"</code>: String representations of the numeric values.</p>
</dd>
<dt><code>quality_flag</code>:</dt><dd><p>Object of class <code>"numeric"</code>: Quality flag.</p>
</dd>
<dt><code>quality_flagString</code>:</dt><dd><p>Object of class <code>"character"</code>: String representation of quality flag.</p>
</dd>
</dl>



<h3>Methods</h3>



<dl>
<dt>show</dt><dd><p><code>signature(object = "GeneralValueMetric")</code>: Prettyprints the information in the <code>GeneralValueMetric</code> </p>
</dd>
</dl>



<h3>Note</h3>

<p>The <code>starttime</code> and <code>endtime</code> slots are typically associated with the <em>user requested</em> times 
which may not match up with the
<code>starttime</code> associated with the first <code>Trace</code> and the <code>endtime</code> associated with last <code>Trace</code>
in the <code>Stream</code> object being analyzed.  This ensures that
metrics results for a single time period but covering many stations or channels will have the same date range and
improves performance of the BSS which expects XML of the following form:
</p>
<pre>
&lt;measurements&gt;
  &lt;date start='2012-02-10T00:00:00.000' end='2012-02-10T09:20:00.000'&gt;
    &lt;target snclq='N.S.L.C1.Q'&gt;
      &lt;EXAMPLE&gt;
        &lt;x value="1"/&gt;
        &lt;x value="2"/&gt;
        &lt;x value="3"/&gt;
        &lt;x value="4"/&gt;
      &lt;/EXAMPLE&gt;
    &lt;/target&gt;
  &lt;/date&gt;
&lt;/measurements&gt;
</pre>
<p>The <code>quality_flag</code> is an optional value available for storing information related to the
processing of a particular metric.  Its meaning will vary from metric to metric.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan.s.callahan@gmail.com">jonathan.s.callahan@gmail.com</a>
</p>

<hr>
<h2 id='getBssMetricList'>Retrieve measurements XML from the MUSTANG BSS and convert them to a metricList</h2><span id='topic+getBssMetricList'></span><span id='topic+getBssMetricList+2CIrisClient+2Ccharacter+2Ccharacter+2Ccharacter+2Ccharacter+2CPOSIXct+2CPOSIXct+2Ccharacter+2Ccharacter-method'></span><span id='topic+getBssMetricList+2CIrisClient+2Ccharacter+2Ccharacter+2Ccharacter+2Ccharacter+2CPOSIXct+2CPOSIXct+2Ccharacter+2Cmissing-method'></span>

<h3>Description</h3>

<p>The <code>getBssMetricList</code> method makes a request of the MUSTANG BSS (Backend Storage System)
and returns a list of <code>_Metric</code> objects.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>getBssMetricList(obj, network, station, location, channel, 
                 starttime, endtime, metricName, url)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="getBssMetricList_+3A_obj">obj</code></td>
<td>
<p> an <code>IrisClient</code> object </p>
</td></tr>
<tr><td><code id="getBssMetricList_+3A_network">network</code></td>
<td>
<p> a character string with the two letter seismic network code </p>
</td></tr>
<tr><td><code id="getBssMetricList_+3A_station">station</code></td>
<td>
<p> a character string with the station code </p>
</td></tr>
<tr><td><code id="getBssMetricList_+3A_location">location</code></td>
<td>
<p> a character string with the location code </p>
</td></tr>
<tr><td><code id="getBssMetricList_+3A_channel">channel</code></td>
<td>
<p> a character string with the three letter channel code </p>
</td></tr>
<tr><td><code id="getBssMetricList_+3A_starttime">starttime</code></td>
<td>
<p> a POSIXct class specifying the starttime (GMT) </p>
</td></tr>
<tr><td><code id="getBssMetricList_+3A_endtime">endtime</code></td>
<td>
<p> a POSIXct class specifying the endtime (GMT) </p>
</td></tr>
<tr><td><code id="getBssMetricList_+3A_metricname">metricName</code></td>
<td>
<p> a character string identifying the name of the metric stored in the BSS </p>
</td></tr>
<tr><td><code id="getBssMetricList_+3A_url">url</code></td>
<td>
<p> optional url of the BSS measurements service </p>
</td></tr>
</table>


<h3>Details</h3>

<p>This method calls on <a href="#topic+getMetricsXml">getMetricsXml</a> to communicate with the BSS and obtain an XML reponse.
This response is then processed and used to create <code>_Metric</code> objects which are returned as a metricList.
</p>
<p>Error returns from the BSS will stop evaluation and throw an error message.
</p>


<h3>Value</h3>

<p>A list of <code>_Metric</code> objects is returned.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+getMetricsXml">getMetricsXml</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices (including the BSS)
iris &lt;- new("IrisClient", debug=TRUE)

starttime &lt;- as.POSIXct("2014-01-24", tz="GMT")
endtime &lt;- as.POSIXct("2014-01-25", tz="GMT")

# Get the metricList
metricList &lt;- getBssMetricList(iris,"AK","PIN","","",starttime,endtime,
                               metricName="sample_mean")
show(metricList)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='getGeneralValueMetrics'>Retrieve measurements from the MUSTANG BSS </h2><span id='topic+getGeneralValueMetrics'></span><span id='topic+getGeneralValueMetrics+2CIrisClient+2Ccharacter+2Ccharacter+2Ccharacter+2Ccharacter+2CPOSIXct+2CPOSIXct+2Ccharacter-method'></span>

<h3>Description</h3>

<p>The <code>getGeneralValueMetrics</code> method of the <code>IrisClient</code> makes a request of the MUSTANG database
and returns a dataframe containing metrics measurments.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>getGeneralValueMetrics(obj, network, station, location, channel, 
                           starttime, endtime, metricName, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="getGeneralValueMetrics_+3A_obj">obj</code></td>
<td>
<p> an <code>IrisClient</code> object </p>
</td></tr>
<tr><td><code id="getGeneralValueMetrics_+3A_network">network</code></td>
<td>
<p> a character string with the two letter seismic network code </p>
</td></tr>
<tr><td><code id="getGeneralValueMetrics_+3A_station">station</code></td>
<td>
<p> a character string with the station code </p>
</td></tr>
<tr><td><code id="getGeneralValueMetrics_+3A_location">location</code></td>
<td>
<p> a character string with the location code, can be &quot;&quot; for wildcard all </p>
</td></tr>
<tr><td><code id="getGeneralValueMetrics_+3A_channel">channel</code></td>
<td>
<p> a character string with the three letter channel code, can be &quot;&quot; for wildcard all </p>
</td></tr>
<tr><td><code id="getGeneralValueMetrics_+3A_starttime">starttime</code></td>
<td>
<p> a POSIXct class specifying the starttime (GMT) </p>
</td></tr>
<tr><td><code id="getGeneralValueMetrics_+3A_endtime">endtime</code></td>
<td>
<p> a POSIXct class specifying the endtime (GMT) </p>
</td></tr>
<tr><td><code id="getGeneralValueMetrics_+3A_metricname">metricName</code></td>
<td>
<p> a character string containing one or more comma separated metric names </p>
</td></tr>
<tr><td><code id="getGeneralValueMetrics_+3A_...">...</code></td>
<td>
<p>optional arguments
<code>constraint</code> a character string containing value constraints 
<code>url</code> optional url of the MUSTANG measurements service 
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>A blank location code should be specified as <code>location="--"</code>; Using <code>location=""</code> will return all location codes.
</p>
<p>The default MUSTANG measurement service when <code>url</code> is not specified is:
</p>
<p><code>http://service.iris.edu/mustang/measurements/1/query?</code>
</p>
<p>Data returned from MUSTANG are converted into an <span class="rlang"><b>R</b></span> dataframe.
</p>
<p>The optional <code>constraint</code> parameter is used to add constraints to the query as defined
in the <a href="http://service.iris.edu/mustang/measurements/1">MUSTANG measurements web service documentation</a>.
Any string passed in with the <code>constraint</code> parameter will be appended to the request url following an ampersand.
</p>
<p>Error returns from the BSS will stop evaluation and generate an error message.
</p>


<h3>Value</h3>

<p>A dataframe with the following columns:
</p>
<pre>
~metricName~, value, additional values,  snclq, starttime, endtime, loadtime
</pre>
<p>The <code>loadtime</code> column contains the time at which this record was loaded into the database.
</p>
<p>The dataframe rows will be sorted by metricName and increasing starttime.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan.s.callahan@gmail.com">jonathan.s.callahan@gmail.com</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+createBssUrl">createBssUrl</a></code>,
<code><a href="#topic+getPsdMetrics">getPsdMetrics</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices (including the BSS)
iris &lt;- new("IrisClient", debug=TRUE)

starttime &lt;- as.POSIXct("2016-08-01", tz="GMT")
endtime &lt;- starttime + 30*24*3600
metricName &lt;- "sample_max"

# Get the measurement dataframe
juneStats &lt;- getGeneralValueMetrics(iris,"IU","ANMO","","BH[12Z]",
                                        starttime,endtime,metricName)

print(juneStats)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='getMetricFunctionMetadata'>Return JSON Metadata for Metric Functions</h2><span id='topic+getMetricFunctionMetadata'></span>

<h3>Description</h3>

<p>Returns a JSON formatted string with metric function metadata.
This string is needed by the python-based ISPAQ command-line utility developed
by IRIS DMC.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>getMetricFunctionMetadata()
</code></pre>


<h3>Value</h3>

<p>JSON formatted string containing metric function metadata.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>

<hr>
<h2 id='getMetricsXml'> Retrieve measurements XML from the MUSTANG BSS </h2><span id='topic+getMetricsXml'></span><span id='topic+getMetricsXml+2CIrisClient+2Ccharacter+2Ccharacter+2Ccharacter+2Ccharacter+2CPOSIXct+2CPOSIXct+2Ccharacter+2Ccharacter-method'></span><span id='topic+getMetricsXml+2CIrisClient+2Ccharacter+2Ccharacter+2Ccharacter+2Ccharacter+2CPOSIXct+2CPOSIXct+2Ccharacter+2Cmissing-method'></span>

<h3>Description</h3>

<p>The <code>getMetricsXml</code> method makes a request of the MUSTANG BSS (Backend Storage System)
and returns a character string with the response XML.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>getMetricsXml(obj, network, station, location, channel, 
                   starttime, endtime, metricName, url)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="getMetricsXml_+3A_obj">obj</code></td>
<td>
<p> an <code>IrisClient</code> object </p>
</td></tr>
<tr><td><code id="getMetricsXml_+3A_network">network</code></td>
<td>
<p> a character string with the two letter seismic network code </p>
</td></tr>
<tr><td><code id="getMetricsXml_+3A_station">station</code></td>
<td>
<p> a character string with the station code </p>
</td></tr>
<tr><td><code id="getMetricsXml_+3A_location">location</code></td>
<td>
<p> a character string with the location code </p>
</td></tr>
<tr><td><code id="getMetricsXml_+3A_channel">channel</code></td>
<td>
<p> a character string with the three letter channel code </p>
</td></tr>
<tr><td><code id="getMetricsXml_+3A_starttime">starttime</code></td>
<td>
<p> a POSIXct class specifying the starttime (GMT) </p>
</td></tr>
<tr><td><code id="getMetricsXml_+3A_endtime">endtime</code></td>
<td>
<p> a POSIXct class specifying the endtime (GMT) </p>
</td></tr>
<tr><td><code id="getMetricsXml_+3A_metricname">metricName</code></td>
<td>
<p> a character string identifying the name of the metric stored in the BSS </p>
</td></tr>
<tr><td><code id="getMetricsXml_+3A_url">url</code></td>
<td>
<p> optional url of the BSS measurements service </p>
</td></tr>
</table>


<h3>Details</h3>

<p>The default BSS measurement service when <code>url</code> is not specified is:
</p>
<p><code>http://service.iris.edu/mustang/measurements/1/query?</code>
</p>
<p>This method returns raw XML which is not that useful by itself.  Users should instead use the
<a href="#topic+getBssMetricList">getBssMetricList</a> method which calls this function and returns a list <code>_Metric</code> objects.
</p>
<p>Error returns from the BSS will stop evaluation and throw an error message.
</p>


<h3>Value</h3>

<p>A character string with the XML response from the BSS is returned.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+getBssMetricList">getBssMetricList</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Open a connection to IRIS DMC webservices (including the BSS)
iris &lt;- new("IrisClient", debug=TRUE)

starttime &lt;- as.POSIXct("2012-01-24", tz="GMT")
endtime &lt;- as.POSIXct("2012-01-25", tz="GMT")

# Get the measurement XML
xml &lt;- tryCatch(getMetricsXml(iris,"AK","PIN","","BHZ",
                          starttime,endtime,metricName="sample_mean",
                          url="http://service.iris.edu/mustang/measurements/1/query?"),
                error= function(e) {message(e)}) 
</code></pre>

<hr>
<h2 id='getMustangMetrics'>Retrieve measurements from the MUSTANG BSS </h2><span id='topic+getMustangMetrics'></span><span id='topic+getMustangMetrics+2CIrisClient+2Ccharacter+2Ccharacter+2Ccharacter+2Ccharacter+2CPOSIXct+2CPOSIXct+2Ccharacter-method'></span>

<h3>Description</h3>

<p>The <code>getMustangMetrics</code> method of the <code>IrisClient</code> makes a request of the MUSTANG database
and returns a dataframe containing metrics measurements. This function is an alias of the <code>getGeneralValueMetrics</code> function.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>getMustangMetrics(obj, network, station, location, channel, 
                           starttime, endtime, metricName, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="getMustangMetrics_+3A_obj">obj</code></td>
<td>
<p> an <code>IrisClient</code> object </p>
</td></tr>
<tr><td><code id="getMustangMetrics_+3A_network">network</code></td>
<td>
<p> a character string with the two letter seismic network code </p>
</td></tr>
<tr><td><code id="getMustangMetrics_+3A_station">station</code></td>
<td>
<p> a character string with the station code </p>
</td></tr>
<tr><td><code id="getMustangMetrics_+3A_location">location</code></td>
<td>
<p> a character string with the location code, can be &quot;&quot; for wildcard all </p>
</td></tr>
<tr><td><code id="getMustangMetrics_+3A_channel">channel</code></td>
<td>
<p> a character string with the three letter channel code, can be &quot;&quot; for wildcard all </p>
</td></tr>
<tr><td><code id="getMustangMetrics_+3A_starttime">starttime</code></td>
<td>
<p> a POSIXct class specifying the starttime (GMT) </p>
</td></tr>
<tr><td><code id="getMustangMetrics_+3A_endtime">endtime</code></td>
<td>
<p> a POSIXct class specifying the endtime (GMT) </p>
</td></tr>
<tr><td><code id="getMustangMetrics_+3A_metricname">metricName</code></td>
<td>
<p> a character string containing one or more comma separated metric names </p>
</td></tr>
<tr><td><code id="getMustangMetrics_+3A_...">...</code></td>
<td>
<p>optional arguments
<code>constraint</code> a character string containing value constraints 
<code>url</code> optional url of the MUSTANG measurements service 
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>A blank location code should be specified as <code>location="--"</code>; Using <code>location=""</code> will return all location codes.
</p>
<p>The default MUSTANG measurement service when <code>url</code> is not specified is:
</p>
<p><code>http://service.iris.edu/mustang/measurements/1/query?</code>
</p>
<p>Data returned from MUSTANG are converted into an <span class="rlang"><b>R</b></span> dataframe.
</p>
<p>The optional <code>constraint</code> parameter is used to add constraints to the query as defined
in the <a href="http://service.iris.edu/mustang/measurements/1">MUSTANG measurements web service documentation</a>.
Any string passed in with the 
<code>constraint</code> parameter will be appended to the request url following an ampersand.
</p>
<p>Error returns from the BSS will stop evaluation and generate an error message.
</p>


<h3>Value</h3>

<p>A dataframe with the following columns:
</p>
<pre>
~metricName~, value, additional values,  snclq, starttime, endtime, loadtime
</pre>
<p>The <code>loadtime</code> column contains the time at which this record was loaded into the database.
</p>
<p>The dataframe rows will be sorted by metricName and increasing starttime.
</p>


<h3>Note</h3>

<p>The database was originally populated with a version of this package
that always assigned quality to be 'B'. Later versions obtained the
quality from the miniSEED packet (typically 'M').  Because of this
it is possible to have duplicate entries that only differ in the Q
part of their snclq.  To avoid double counting, when the webservice return
contains two records whose only difference is the quality code portion of
the of the snclq, only the record with the later loaddate will be used
in the dataframe.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan.s.callahan@gmail.com">jonathan.s.callahan@gmail.com</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+createBssUrl">createBssUrl</a></code>,
<code><a href="#topic+getPsdMetrics">getPsdMetrics</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Open a connection to IRIS DMC webservices (including the BSS)
iris &lt;- new("IrisClient", debug=TRUE)

starttime &lt;- as.POSIXct("2016-08-01", tz="GMT")
endtime &lt;- starttime + 30*24*3600
metricName &lt;- "orientation_check"

# Get the measurement dataframe
juneStats &lt;- tryCatch(getMustangMetrics(iris,"IU","ANMO","","BH[12Z]",starttime,endtime,metricName),
                      error=function(e) {message(e)})
juneStats
</code></pre>

<hr>
<h2 id='getPsdMetrics'>Retrieve measurements from the MUSTANG BSS </h2><span id='topic+getPsdMetrics'></span><span id='topic+getPsdMetrics+2CIrisClient+2Ccharacter+2Ccharacter+2Ccharacter+2Ccharacter+2CPOSIXct+2CPOSIXct+2Ccharacter-method'></span><span id='topic+getPsdMetrics+2CIrisClient+2Ccharacter+2Ccharacter+2Ccharacter+2Ccharacter+2CPOSIXct+2CPOSIXct+2Cmissing-method'></span>

<h3>Description</h3>

<p>The <code>getPsdMetrics</code> method of the <code>IrisClient</code> makes a request of the MUSTANG BSS (Backend Storage System)
and returns a dataframe containing instrument corrected Power Spectral Density (PSD) measurements.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>getPsdMetrics(obj, network, station, location, channel, starttime, endtime, url) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="getPsdMetrics_+3A_obj">obj</code></td>
<td>
<p> an <code>IrisClient</code> object </p>
</td></tr>
<tr><td><code id="getPsdMetrics_+3A_network">network</code></td>
<td>
<p> a character string with the two letter seismic network code </p>
</td></tr>
<tr><td><code id="getPsdMetrics_+3A_station">station</code></td>
<td>
<p> a character string with the station code </p>
</td></tr>
<tr><td><code id="getPsdMetrics_+3A_location">location</code></td>
<td>
<p> a character string with the location code </p>
</td></tr>
<tr><td><code id="getPsdMetrics_+3A_channel">channel</code></td>
<td>
<p> a character string with the three letter channel code </p>
</td></tr>
<tr><td><code id="getPsdMetrics_+3A_starttime">starttime</code></td>
<td>
<p> a POSIXct class specifying the starttime (GMT) </p>
</td></tr>
<tr><td><code id="getPsdMetrics_+3A_endtime">endtime</code></td>
<td>
<p> a POSIXct class specifying the endtime (GMT) </p>
</td></tr>
<tr><td><code id="getPsdMetrics_+3A_url">url</code></td>
<td>
<p> optional url of the BSS measurements service </p>
</td></tr>
</table>


<h3>Details</h3>

<p>The default BSS measurement service when <code>url</code> is not specified is:
</p>
<p><code>http://service.iris.edu/mustang/noise-psd/1/query?</code>
</p>
<p>Data returned from the BSS are converted into an <span class="rlang"><b>R</b></span> dataframe.
</p>
<p>Error returns from the BSS will stop evaluation and generate an error message.
</p>


<h3>Value</h3>

<p>A dataframe with the following columns:
</p>
<pre>
target, starttime, endtime, frequency, power
</pre>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+getBssMetricList">getBssMetricList</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices (including the BSS)
iris &lt;- new("IrisClient", debug=TRUE)

starttime &lt;- as.POSIXct("2012-01-24", tz="GMT")
endtime &lt;- as.POSIXct("2012-01-25", tz="GMT")

# Get the measurement XML
psdDF &lt;- getPsdMetrics(iris,"AK","PIN","","BHZ", starttime,endtime)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='getSingleValueMetrics'>Retrieve measurements from the MUSTANG BSS </h2><span id='topic+getSingleValueMetrics'></span><span id='topic+getSingleValueMetrics+2CIrisClient+2Ccharacter+2Ccharacter+2Ccharacter+2Ccharacter+2CPOSIXct+2CPOSIXct+2Ccharacter+2Ccharacter+2Ccharacter-method'></span><span id='topic+getSingleValueMetrics+2CIrisClient+2Ccharacter+2Ccharacter+2Ccharacter+2Ccharacter+2CPOSIXct+2CPOSIXct+2Ccharacter+2Ccharacter+2Cmissing-method'></span><span id='topic+getSingleValueMetrics+2CIrisClient+2Ccharacter+2Ccharacter+2Ccharacter+2Ccharacter+2CPOSIXct+2CPOSIXct+2Ccharacter+2Cmissing+2Ccharacter-method'></span><span id='topic+getSingleValueMetrics+2CIrisClient+2Ccharacter+2Ccharacter+2Ccharacter+2Ccharacter+2CPOSIXct+2CPOSIXct+2Ccharacter+2Cmissing+2Cmissing-method'></span>

<h3>Description</h3>

<p>The <code>getSingleValueMetrics</code> method of the <code>IrisClient</code> makes a request of the MUSTANG database
and returns a dataframe containing metrics that are stored as single values, e.g. sample_max, sample_min, etc..
</p>


<h3>Usage</h3>

<pre><code class='language-R'>getSingleValueMetrics(obj, network, station, location, channel, 
                           starttime, endtime, metricName, constraint, url)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="getSingleValueMetrics_+3A_obj">obj</code></td>
<td>
<p> an <code>IrisClient</code> object </p>
</td></tr>
<tr><td><code id="getSingleValueMetrics_+3A_network">network</code></td>
<td>
<p> a character string with the two letter seismic network code </p>
</td></tr>
<tr><td><code id="getSingleValueMetrics_+3A_station">station</code></td>
<td>
<p> a character string with the station code </p>
</td></tr>
<tr><td><code id="getSingleValueMetrics_+3A_location">location</code></td>
<td>
<p> a character string with the location code </p>
</td></tr>
<tr><td><code id="getSingleValueMetrics_+3A_channel">channel</code></td>
<td>
<p> a character string with the three letter channel code </p>
</td></tr>
<tr><td><code id="getSingleValueMetrics_+3A_starttime">starttime</code></td>
<td>
<p> a POSIXct class specifying the starttime (GMT) </p>
</td></tr>
<tr><td><code id="getSingleValueMetrics_+3A_endtime">endtime</code></td>
<td>
<p> a POSIXct class specifying the endtime (GMT) </p>
</td></tr>
<tr><td><code id="getSingleValueMetrics_+3A_metricname">metricName</code></td>
<td>
<p> a character string containing one or more comma separated metric names </p>
</td></tr>
<tr><td><code id="getSingleValueMetrics_+3A_constraint">constraint</code></td>
<td>
<p> a character string containing value constraints </p>
</td></tr>
<tr><td><code id="getSingleValueMetrics_+3A_url">url</code></td>
<td>
<p> optional url of the MUSTANG measurements service </p>
</td></tr>
</table>


<h3>Details</h3>

<p>A blank location code should be specified as <code>location="--"</code>; Using <code>location=""</code> will return all location codes.
</p>
<p>The default MUSTANG measurement service when <code>url</code> is not specified is:
</p>
<p><code>http://service.iris.edu/mustang/measurements/1/query?</code>
</p>
<p>Data returned from MUSTANG are converted into an <span class="rlang"><b>R</b></span> dataframe.
</p>
<p>The optional <code>constraint</code> parameter is used to add constraints to the query as defined
in the <a href="http://service.iris.edu/mustang/measurements/1">MUSTANG measurements web service documentation</a>.
Any string passed in with the 
<code>constraint</code> parameter will be appended to the request url following an ampersand.
</p>
<p>Error returns from the BSS will stop evaluation and generate an error message.
</p>
<p>Most MUSTANG metrics are single valued and can be retrieved with <code>getSingleValueMetrics()</code>. Examples
of multi-valued metrics that cannot be returned with this function include &quot;asl_coherence&quot;, &quot;orientation_check&quot;,
and &quot;transfer_function&quot;.
</p>
<p><code>getMustangMetrics()</code> is a similar function that will return values for all metrics, not just single valued ones. It is the 
preferred method of retrieving MUSTANG metric values.
</p>


<h3>Value</h3>

<p>A dataframe with the following columns:
</p>
<pre>
~metricName~, value, snclq, starttime, endtime, loadtime
</pre>
<p>The <code>loadtime</code> column contains the time at which this record was loaded into the database.
</p>
<p>The dataframe rows will be sorted by increasing starttime.
</p>
<p>The structure of this dataframe is appropriate for use with the <span class="pkg">ggplot2</span> plotting package.
</p>


<h3>Note</h3>

<p>The database was originally populated with a version of this package
that always assigned quality to be 'B'. Later versions obtained the
quality from the miniSEED packet (typically 'M').  Because of this
it is possible to have duplicate entries that only differ in the Q
part of their snclq.  To avoid double counting, when the webservice return
contains two records whose only difference is the quality code portion of
the of the snclq, only the record with the later loaddate will be used
in the dataframe.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+createBssUrl">createBssUrl</a></code>,
<code><a href="#topic+getPsdMetrics">getPsdMetrics</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices (including the BSS)
iris &lt;- new("IrisClient", debug=TRUE)

starttime &lt;- as.POSIXct("2013-06-01", tz="GMT")
endtime &lt;- starttime + 30*24*3600
metricName &lt;- "sample_max,sample_min,sample_mean"

# Get the measurement dataframe
juneStats &lt;- getSingleValueMetrics(iris,"IU","ANMO","00","BHZ",
                                        starttime,endtime,metricName)

head(juneStats)

# Simple ggplot2 plot
#library(ggplot2)
#p &lt;- ggplot(juneStats, aes(x=starttime,y=value, color=as.factor(metricName))) +
#     geom_step()

#print(p)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='IRISMustangMetrics-package'>Utilities for calculating seismic metrics from EarthScope (formerly IRIS DMC) data</h2><span id='topic+IRISMustangMetrics-package'></span><span id='topic+IRISMustangMetrics'></span>

<h3>Description</h3>

<p>This package provides S4 classes and functions for calculating metrics from seismological 
data available from EarthScope (<a href="http://ds.iris.edu/ds/nodes/dmc/">http://ds.iris.edu/ds/nodes/dmc/</a>).
This package is part of the MUSTANG project.
</p>


<h3>Introduction</h3>

<p>The <span class="pkg">IRISMustangMetrics</span> package depends upon the <span class="pkg">IRISSeismic</span> package which  defines
new S4 classes and methods for manipulating seismic data.  Please see the &quot;seismic-intro&quot; 
vignette for introductory examples on using <span class="pkg">IRISSeismic</span>.
</p>


<h3>History</h3>

<p>version 2.4.6
</p>

<ul>
<li><p>(updated email addresses)
</p>
</li>
<li><p>(ISPQAUtils, add psd_corrected metric name to allow the ISPAQ tool to return uncorrected psds)
</p>
</li></ul>

<p>version 2.4.5
</p>

<ul>
<li><p>(typo fix for email address and updated link in documentation)
</p>
</li>
<li><p>(updated error handling code to meet CRAN requirements)
</p>
</li></ul>

<p>version 2.4.4
</p>

<ul>
<li><p>(additional error handling for sample_rate_resp)
</p>
</li></ul>

<p>version 2.4.3
</p>

<ul>
<li><p>(improved error handling for functions that call IRIS web services)
</p>
</li>
<li><p>(additional error handling for sample_rate_resp)
</p>
</li></ul>

<p>version 2.4.2
</p>

<ul>
<li><p>minor modification to ISPAQUtils.R for sample_rate_resp, sample_rate_channel
</p>
</li></ul>

<p>version 2.4.1
</p>

<ul>
<li><p>fix for max_range where trace length not evenly divided by window length
</p>
</li>
<li><p>max_range now rounds window*samplerate and increment*samplerate to integer values
</p>
</li>
<li><p>corrects typo error in ISPAQUtils.R
</p>
</li></ul>

<p>version 2.4.0
</p>

<ul>
<li><p>adds new metrics sample_rate_resp, sample_rate_channel, max_range
</p>
</li></ul>

<p>version 2.3.0
</p>

<ul>
<li><p>modifies PSD metrics for edge case involving metadata and trace start times
</p>
</li>
<li><p>adds noCorrection option to PSDMetric, if noCorrection=TRUE it only returns uncorrected 
PSDs and not corrected PSD or PSD-derived metrics; default noCorrection=FALSE
</p>
</li></ul>

<p>version 2.2.0
</p>

<ul>
<li><p>removes dead_channel_exp, metric has been retired
</p>
</li>
<li><p>renames pdf_aggregator in ISPAQUtils.R to pdf
</p>
</li></ul>

<p>version 2.1.3
</p>

<ul>
<li><p>fixed bug related to getGeneralValueMetrics,getMustangMetrics error handling
</p>
</li>
<li><p>added pdf_aggregator to ISPAQUtils.R, for multi-day pdf plotting within ISPAQ
</p>
</li></ul>

<p>version 2.1.2
</p>

<ul>
<li><p>version 2.1.1 unintentionally removed the pct_above_nhnm metric. This version restores it.
</p>
</li>
<li><p>made sample rate sanity rate check consistent between correlationMetric and crossCorrelationMetric
</p>
</li></ul>

<p>version 2.1.1
</p>

<ul>
<li><p>fixed bug in PSDMetrics that affected dead_channel_gsn results
</p>
</li></ul>

<p>version 2.1.0
</p>

<ul>
<li><p>transfer_function requires sample rates to be within a factor of 10 to avoid decimation effects on amplitude
</p>
</li>
<li><p>transfer_function uses 7 order Chebyshev filter in the decimate function, to correct 1% error occurring with default 8 order Chebyshev
</p>
</li>
<li><p>fixed bug in transfer_function trace start and end time comparisons
</p>
</li>
<li><p>transfer_function when determining if sample rate &lt; 1, round to 5 digits first
</p>
</li>
<li><p>getGeneralValueMetrics added metric_error, ts_channel_continuity, ts_channel_up_time, ts_gap_length, ts_gap_length_total, ts_max_gap, 
ts_max_gap_total, ts_num_gaps, ts_num_gaps_total, ts_percent_availability, ts_percent_availability metrics
</p>
</li>
<li><p>aliased the getGeneralValueMetrics function to getMustangMetrics
</p>
</li>
<li><p>dailyDCOffsetMetric now returns error when result is NaN or NA
</p>
</li></ul>

<p>version 2.0.9
</p>

<ul>
<li><p>removed dependency on pracma package
</p>
</li>
<li><p>removed channel restrictions for pct_above_nhnm,pct_below_nlm
</p>
</li>
<li><p>cross correlation sampling rates of &lt; 1 will round to 2 digits
</p>
</li>
<li><p>getGeneralValueMetrics better handles case of no targets found
</p>
</li>
<li><p>improved error handling in spikesMetric.R
</p>
</li></ul>

<p>version 2.0.8
</p>

<ul>
<li><p>minor bug fix to ISPAQUtils.R, spikes=numSpikes
</p>
</li></ul>

<p>version 2.0.7
</p>

<ul>
<li><p>fixed bug in getGeneralValueMetrics that didn't return measurements if there was more than one for any day
</p>
</li>
<li><p>crossCorrelationMetric filter now defaults to a butterworth 2 pole 0.1Hz (10 second) low pass filter
</p>
</li></ul>

<p>version 2.0.6
</p>

<ul>
<li><p>fixed bug related to NA -&gt; NULL replacement in Class-Metric
</p>
</li></ul>

<p>version 2.0.5
</p>

<ul>
<li><p>fixed dplyr version dependencies
</p>
</li></ul>

<p>version 2.0.4
</p>

<ul>
<li><p>adds additional sanity check to <code>getGeneralValueMetrics()</code>
</p>
</li>
<li><p>createBssUrl() adds &quot;&amp;nodata=404&quot; to url
</p>
</li></ul>

<p>version 2.0.2
</p>

<ul>
<li><p>updates to ISPAQUtils.R
</p>
</li></ul>

<p>version 2.0.1
</p>

<ul>
<li><p>removed dependency on tidyr package
</p>
</li></ul>
 
<p>version 2.0.0 &ndash; GeneralValueMetrics
</p>

<ul>
<li><p><code>GeneralValueMetric</code> class introduced, <code>SingleValueMetric</code> class deprecated. All metrics that previously returned
<code>SingleValueMetric</code> now return <code>GeneralValueMetric</code>
</p>
</li>
<li><p><code>getGeneralValueMetrics()</code> function added. Retreives metrics measurements from BSS database
</p>
</li>
<li><p><code>crossCorrelationMetric()</code> does not return timing_drift. The metric proved unreliable
</p>
</li>
<li><p>users can now supply instrument response information in the form of frequency, amplitude, phase
to the function <code>PSDMetric</code>, in place of the getEvalresp webservice call
</p>
</li></ul>

<p>version 1.3.1 &ndash; PSDs
</p>

<ul>
<li><p><code>getPsdMetrics</code> reworked
</p>
</li></ul>

<p>version 1.3.0 &ndash; latency
</p>

<ul>
<li><p><code>getLatencyValuesXML()</code> removed from package.
</p>
</li>
<li><p>documentation improvements.
</p>
</li>
<li><p>additional error checking for <code>getSingleValueMetrics()</code>.
</p>
</li></ul>

<p>version 1.2.7 &ndash; PSDs
</p>

<ul>
<li><p><code>PSDMetrics()</code> metrics <code>percent_above_nhnm</code> and <code>percent_below_nlnm</code> limited to frequencies less than nyquist/1.5.
</p>
</li></ul>

<p>version 1.2.6 &ndash; PSDs
</p>

<ul>
<li><p>Depends on <span class="pkg">IRISSeismic</span> (&gt;= 1.3.0).
</p>
</li>
<li><p><code>dead_channel_exp</code> and <code>dead_channel_lin</code> metrics will only return values for station channel codes matching &quot;BH|HH&quot;.
</p>
</li></ul>

<p>version 1.2.5 &ndash; ISPAQUtils
</p>

<ul>
<li><p>ISPAQUtils.R contains functions for use with the ISPAQ standalone metrics system.
</p>
</li></ul>

<p>version 1.2.4 &ndash; package version dependencies
</p>

<ul>
<li><p>Depends on <span class="pkg">IRISSeismic</span> (&gt;= 1.2.3). Imports <span class="pkg">seismicRoll</span> (&gt;=1.1.2).
</p>
</li></ul>

<p>version 1.2.2 &ndash; correlationMetric tweak
</p>

<ul>
<li><p><code>correlationMetric()</code> allows trace sample lengths to differ by 2 samples without stopping.
</p>
</li></ul>

<p>version 1.2.1 &ndash; PSDs
</p>

<ul>
<li><p>Better fix to very low powers issue in <code>PSDMetrics()</code> <code>dead_channel_gsn</code> metric.
</p>
</li>
<li><p><code>PSDMetrics()</code> shifts PDF bin centers by 0.5 dB.
</p>
</li></ul>

<p>version 1.2.0 &ndash; PSDs
</p>

<ul>
<li><p><code>PSDMetric()</code> returns corrected PSD and PDF dataframes in addition to uncorrected PSDs and PSD derived metrics.
</p>
</li>
<li><p>Depends on R (&gt;= 3.2.0) and <span class="pkg">IRISSeismic</span> (&gt;=1.1.7).
</p>
</li>
<li><p>Imports <span class="pkg">tidyr</span>, <span class="pkg">dplyr</span>.
</p>
</li></ul>

<p>version 1.1.3 &ndash; bug fix, import version increased
</p>

<ul>
<li><p>Fixes typo in <code>SNRMetric()</code> function <code>windowSecs</code> argument default value.
</p>
</li>
<li><p>Imports <span class="pkg">seismicRoll</span> (&gt;=1.1.1)
</p>
</li></ul>

<p>version 1.1.2 &ndash; modifications
</p>

<ul>
<li><p>Improves error handling messages.
</p>
</li>
<li><p><code>dailyDCOffsetMetric()</code> removes unused selectivity argument and adds argument controlling output type.
</p>
</li>
<li><p>Fixes bug in <code>dailyDCOffsetMetrics()</code> related to outlier removal and vector length.
</p>
</li>
<li><p>Fixes bug in <code>PSDMetrics()</code> <code>dead_channel_gsn</code> metric related to very low power values.
</p>
</li>
<li><p><code>PSDMetrics()</code> only returns metrics that generate numeric values.
</p>
</li></ul>

<p>version 1.1.1 &ndash; bug fix
</p>

<ul>
<li><p><code>crossCorrelationMetric()</code> exits if either input trace is flatlined (all values equal).
</p>
</li></ul>

<p>version 1.1.0 &ndash; updates package dependencies
</p>

<ul>
<li><p>Depends on <span class="pkg">IRISSeismic</span> (&gt;= 1.1.0).
</p>
</li></ul>

<p>version 1.0.8 &ndash; new metric and bug fix
</p>

<ul>
<li><p>Improves error handling messages.
</p>
</li>
<li><p>Adds new <code>dead_channel_gsn</code> metric to <code>PSDMetric()</code> function output.
</p>
</li>
<li><p>Fixes bug in <code>STALTAMetric()</code> involving required trace length.
</p>
</li></ul>

<p>version 1.0.7 &ndash; bug fix
</p>

<ul>
<li><p>Fixes issue with <code>spikesMetric()</code> passing argument values to <code>findOutliers</code>.
</p>
</li></ul>

<p>version 1.0.6 &ndash; function argument changes
</p>

<ul>
<li><p>Changes <code>spikesMetric()</code> default argument values <code>thresholdMin=10</code>,<code>selectivity=NA</code>,<code>fixedThreshold=TRUE</code>.
</p>
</li>
<li><p><code>transferFunctionMetric()</code> now requires input of evalresp fap spectra, new arguments <code>evalresp1</code> and <code>evalresp2</code>.
</p>
</li>
<li><p>Additional sanity checks for <code>transferFunctionMetric()</code> and <code>PSDMetric()</code>.
</p>
</li>
<li><p>Depends on <span class="pkg">IRISSeismic</span> (&gt;= 1.0.10). Imports <span class="pkg">seismicRoll</span> (&gt;=1.1.0). Imports <span class="pkg">stats</span>.
</p>
</li></ul>

<p>version 1.0.5 &ndash; new PSD metric
</p>

<ul>
<li><p>Changes URL syntax for MUSTANG web services to use &quot;format=...&quot; instead of &quot;output=...&quot;.
</p>
</li>
<li><p>Adds new <code>sample_unique</code> metric to <code>PSDMetric()</code> output.
</p>
</li></ul>

<p>version 1.0.3 &ndash; new functionality and bug fixes
</p>

<ul>
<li><p>Adds new <code>metricList2DF()</code> function.
</p>
</li>
<li><p>Adds new <code>dead_channel_lin</code> metric to <code>PSDMetric()</code> output.
</p>
</li>
<li><p>Fixes typo in <code>Class-Metric.R</code> value string format.
</p>
</li></ul>

<p>version 1.0.0 &ndash; First Public Release
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>References</h3>

<p>IRIS DMC web services: <a href="http://service.iris.edu/">http://service.iris.edu/</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient", debug=TRUE)

# Get the seismic data
starttime &lt;- as.POSIXct("2010-02-27 06:45:00",tz="GMT")
endtime &lt;- as.POSIXct("2010-02-27 07:45:00",tz="GMT")
result &lt;- try(st &lt;- getDataselect(iris,"IU","ANMO","00","BHZ",starttime,endtime))
if (class(result) == "try-error" ) {
   print(geterrmessage())
} else {
   # Apply a metric and show the results
   metricList &lt;- basicStatsMetric(st)
   dummy &lt;- lapply(metricList, show)
}
</code></pre>

<hr>
<h2 id='maxRangeMetric'>Maximum daily sample range calculated over a rolling window</h2><span id='topic+maxRangeMetric'></span>

<h3>Description</h3>

<p>This metric calculates the difference between the largest and smallest sample 
value in a 5-minute rolling window and returns the largest value encountered 
within a 24-hour timespan.  
</p>


<h3>Usage</h3>

<pre><code class='language-R'>maxRangeMetric(st,
               window=300,
               increment=150)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="maxRangeMetric_+3A_st">st</code></td>
<td>
<p>a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
<tr><td><code id="maxRangeMetric_+3A_window">window</code></td>
<td>
<p>number of seconds over which to evaluate the minimum and maximum sample values</p>
</td></tr>
<tr><td><code id="maxRangeMetric_+3A_increment">increment</code></td>
<td>
<p>number of seconds to advance the window for each max_range calculation</p>
</td></tr>
</table>


<h3>Details</h3>

<p>For a time series passed as a <code>Stream</code> object, this function calculates differences 
between largest and smallest amplitudes in a series of (default) 300-second windows, 
incrementing the window by (default) 150 seconds for each difference calculated.  It reports 
the largest difference as the <b>max_range</b>. 
</p>


<h3>Value</h3>

<p>The function returns a list:
</p>
 
<ul>
<li><p><code>m1</code> = list of <code>max_range</code> metric objects
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Gillian Sharer <a href="mailto:gillian.sharer@earthscope.org">gillian.sharer@earthscope.org</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+SingleValueMetric">SingleValueMetric</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

starttime &lt;- as.POSIXct("2019-08-01",tz="GMT")
endtime &lt;- as.POSIXct("2019-08-02",tz="GMT")

# Get the waveform
st &lt;- getDataselect(iris,"IU","ANMO","00","BHZ",starttime,endtime)

# Calculate the max_range metric
tempList &lt;- maxRangeMetric(st)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='metricList2DF'>Convert a MetricList into a Tidy Dataframe</h2><span id='topic+metricList2DF'></span>

<h3>Description</h3>

<p>The <code>metricList2DF</code> function converts a list of <code>SingleValueMetric</code>s into a
&quot;tidy&quot; dataframe with one value per row..
</p>


<h3>Usage</h3>

<pre><code class='language-R'>metricList2DF(metricList)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="metricList2DF_+3A_metriclist">metricList</code></td>
<td>
<p>a list of <code>SingleValueMetric</code> objects</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Metrics functions return lists of <code>SingleValueMetric</code> objects.  A long <code>metricList</code> may be built up
by appending the results of different metrics functions or the same metrics function operating on different seismic signals.
A metricList generated by any of the MUSTANG Rscripts can be stored as an <code>.RData</code> file and reloaded for examination.
</p>
<p>A metricList may contain values for many different metrics.  This function creates a single &quot;tidy&quot; dataframe with
the following colulmns: <code>metricName, value, snclq, starttime, endtime, qualityFlag</code>.
</p>


<h3>Value</h3>

<p>A dataframe with one row per metric measurement.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+SingleValueMetric-class">SingleValueMetric-class</a></code>, 
<code><a href="#topic+metricList2Xml">metricList2Xml</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
client &lt;- new("IrisClient")

# Get the waveforms
starttime &lt;- as.POSIXct("2012-01-24", tz="GMT")
endtime &lt;- as.POSIXct("2012-01-25", tz="GMT")
st1 &lt;- getDataselect(client,"AK","PIN","","BHE",starttime,endtime)
st2 &lt;- getDataselect(client,"AK","PIN","","BHN",starttime,endtime)
st3 &lt;- getDataselect(client,"AK","PIN","","BHZ",starttime,endtime)

# Calculate metrics and append them to the metricList
metricList &lt;- stateOfHealthMetric(st1)
metricList &lt;- append(metricList, basicStatsMetric(st1))
metricList &lt;- append(metricList, basicStatsMetric(st2))
metricList &lt;- append(metricList, basicStatsMetric(st3))

# Create dataframe
metricDF &lt;- metricList2DF(metricList)
head(metricDF)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='metricList2DFList'>Conver a metricList into a list of dataframes</h2><span id='topic+metricList2DFList'></span>

<h3>Description</h3>

<p>The <code>metricList2DFList</code> function converts a list of <code>SingleValueMetric</code>s into a
list of dataframes, one per named metric.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>metricList2DFList(metricList)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="metricList2DFList_+3A_metriclist">metricList</code></td>
<td>
<p>a list of <code>SingleValueMetric</code> objects</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Metrics functions return lists of <code>SingleValueMetric</code> objects.  A long <code>metricList</code> may be built up
by appending the results of different metrics functions or the same metrics function operating on different seismic signals.
A metricList generated by any of the MUSTANG Rscripts can be stored as an <code>.RData</code> file and reloaded for examination.
</p>
<p>A metricList may contain values for many different metrics.  This function creates a separate dataframe for
each <code>metricName</code> found in the <code>metricList</code>.  As each dataframe is created, values associated with that metric are stored in a
column named after the metric.  Individual dataframes are stored in the returned list with their own name:
<code>metricName_DF</code>.
</p>


<h3>Value</h3>

<p>A character string with BSS formatted XML is returned.
</p>


<h3>Note</h3>

<p><code>metricList2DFList</code> is deprecated. Please use <code>metricList2DF</code>.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+SingleValueMetric-class">SingleValueMetric-class</a></code>, 
<code><a href="#topic+metricList2DF">metricList2DF</a></code>,
<code><a href="#topic+metricList2Xml">metricList2Xml</a></code>
</p>

<hr>
<h2 id='metricList2Xml'>Create XML for the BSS</h2><span id='topic+metricList2Xml'></span>

<h3>Description</h3>

<p>The <code>metricList2Xml</code> function converts a list of <code>SingleValueMetric</code>s
or <code>GeneralValueMetric</code> into an
XML structure appropriate for submitting to the MUSTANG Backend Storage System (BSS).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>metricList2Xml(metricList)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="metricList2Xml_+3A_metriclist">metricList</code></td>
<td>
<p>a list of <code>SingleValueMetric</code> or <code>GeneralValueMetric</code> objects.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Metrics functions return lists of <code>SingleValueMetric</code> or <code>GeneralValueMetric</code> objects.  A long <code>metricList</code> may be built up
by appending the results of different metrics functions or the same metrics function operating on different seismic signals.
The list may only contain a single class (<code>SingleValueMetric</code> cannot be mixed with <code>GeneralValueMetric</code> objects).
These metrics can be submitted to the BSS in a standardized XML format. (see <a href="#topic+SingleValueMetric-class">SingleValueMetric-class</a>)
</p>


<h3>Value</h3>

<p>A character string with BSS formatted XML is returned.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get the waveform
starttime &lt;- as.POSIXct("2012-01-24", tz="GMT")
endtime &lt;- as.POSIXct("2012-01-25", tz="GMT")
st &lt;- getDataselect(iris,"AK","PIN","","BHZ",starttime,endtime)

# Apply a metric and show the results
metricList &lt;- stateOfHealthMetric(st)
metricList &lt;- append(metricList, basicStatsMetric(st))
bssXml &lt;- metricList2Xml(metricList)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='MultipleTimeValueMetric-class'>Class <code>"MultipleTimeValueMetric"</code></h2><span id='topic+MultipleTimeValueMetric-class'></span><span id='topic+show+2CMultipleTimeValueMetric-method'></span>

<h3>Description</h3>

<p>A container for metrics consisting of a vector of <code>POSIXct</code> datetimes.  This information is used to create XML that is
then submitted to the MUSTANG Backend Storage System (BSS).
</p>


<h3>Objects from the Class</h3>

<p>Objects can be created by calls of the form:
</p>
<p><code>new("MultipleTimeValueMetric", snclq, starttime, endtime, metricName, values)</code>
</p>
<p>Lists of <code>MultipleTimeValueMetric</code> objects are returned by various metrics functions in this package.
</p>


<h3>Slots</h3>


<dl>
<dt><code>snclq</code>:</dt><dd><p>Object of class <code>"character"</code>: SNCLQ identifier.</p>
</dd>
<dt><code>metricName</code>:</dt><dd><p>Object of class <code>"character"</code>: Name of the metric.</p>
</dd>
<dt><code>elementName</code>:</dt><dd><p>Object of class <code>"character"</code>: Name of the datetime element (default=<code>"t"</code>).</p>
</dd>
<dt><code>starttime</code>:</dt><dd><p>Object of class <code>"POSIXct"</code>: Start time.</p>
</dd>
<dt><code>endtime</code>:</dt><dd><p>Object of class <code>"POSIXct"</code>: End time.</p>
</dd>
<dt><code>values</code>:</dt><dd><p>Object of class <code>"POSIXct"</code>: Datetime values.</p>
</dd>
<dt><code>valueStrings</code>:</dt><dd><p>Object of class <code>"character"</code>: String representations of the datetime values.</p>
</dd>
<dt><code>quality_flag</code>:</dt><dd><p>Object of class <code>"numeric"</code>: Quality flag.</p>
</dd>
<dt><code>quality_flagString</code>:</dt><dd><p>Object of class <code>"character"</code>: String representation of quality flag.</p>
</dd>
</dl>



<h3>Methods</h3>



<dl>
<dt>show</dt><dd><p><code>signature(object = "MultipleTimeValueMetric")</code>: Prettyprints the information in the <code>MultipleTimeValueMetric</code> </p>
</dd>
</dl>



<h3>Note</h3>

<p>The <code>starttime</code> and <code>endtime</code> slots are typically associated with the <em>user requested</em> times 
which may not match up with the
<code>starttime</code> associated with the first <code>Trace</code> and the <code>endtime</code> associated with last <code>Trace</code>
in the <code>Stream</code> object being analyzed.  This ensures that
metrics results for a single time period but covering many stations or channels will have the same date range and
improves performance of the BSS which expects XML of the following form:
</p>
<pre>
&lt;measurements&gt;
  &lt;date start='2012-02-10T00:00:00.000' end='2012-02-10T09:20:00.000'&gt;
    &lt;target snclq='N.S.L.C1.Q'&gt;
      &lt;up_down_times&gt;
        &lt;t value="2012-02-10T00:00:00.000"/&gt;
        &lt;t value="2012-02-10T00:01:00.000"/&gt;
        &lt;t value="2012-02-10T00:02:00.000"/&gt;
        &lt;t value="2012-02-10T00:03:00.000"/&gt;
      &lt;/up_down_times&gt;
    &lt;/target&gt;
  &lt;/date&gt;
&lt;/measurements&gt;
</pre>
<p>The <code>quality_flag</code> is an optional value available for storing information related to the
processing of a particular metric.  Its meaning will vary from metric to metric.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>See Also</h3>



<p><code><a href="#topic+upDownTimesMetric">upDownTimesMetric</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get the waveform
starttime &lt;- as.POSIXct("2012-01-24", tz="GMT")
endtime &lt;- as.POSIXct("2012-01-25", tz="GMT")
st &lt;- getDataselect(iris,"AK","PIN","","BHZ",starttime,endtime)

# Make sure we're working with a single snclq
unique_ids &lt;- uniqueIds(st)
if (length(unique_ids) &gt; 1) {
  stop(paste("meanMetric: Stream has",unique_ids,"unique identifiers"))
}
snclq &lt;- unique_ids[1]

# get the upDownTimes with a minimum signal length and minimum gap (secs)
upDownTimes &lt;- getUpDownTimes(st, min_signal=30, min_gap=60)
  
# Create and return a MultipleTimeValue metric from the upDownTimes
m &lt;- new("MultipleTimeValueMetric", snclq=snclq,
         starttime=starttime, endtime=endtime,
         metricName="up_down_times", values=upDownTimes)

# Show the results
show(m)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='PSDMetric'>Power Spectral Density of a signal</h2><span id='topic+PSDMetric'></span>

<h3>Description</h3>

<p>The PSDMetric() function performs spectral analysis on a seismic signal
and returns 'PSD' metrics with discretized spectral components as well as other
metrics based on PSDs.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>PSDMetric(st,
          linLoPeriod=4/(st@traces[[1]]@stats@sampling_rate),
          linHiPeriod=100,
          evalresp=NULL,
          noCorrection=FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="PSDMetric_+3A_st">st</code></td>
<td>
<p>a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
<tr><td><code id="PSDMetric_+3A_linloperiod">linLoPeriod</code></td>
<td>
<p>low end of the period band use for calculating the linear dead channel metric</p>
</td></tr>
<tr><td><code id="PSDMetric_+3A_linhiperiod">linHiPeriod</code></td>
<td>
<p>high end of the period band use for calculating the linear dead channel metric</p>
</td></tr>
<tr><td><code id="PSDMetric_+3A_evalresp">evalresp</code></td>
<td>
<p>dataframe of freq, amp, phase information matching output of <code>getEvalresp</code>, optional</p>
</td></tr>
<tr><td><code id="PSDMetric_+3A_nocorrection">noCorrection</code></td>
<td>
<p>boolean (default=FALSE), TRUE=only generate list of PSDs uncorrected for instrument response;
FALSE=generate list of uncorrected PSDs, list of corrected PSDs, dataframe of PDF values,and PSD-derived metrics</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function calculates average power spectra for a seismic signal as described in the McNamara paper.
See the <code>McNamaraPSD</code> method of <code>Stream</code> objects in the <span class="pkg">IRISSeismic</span> package for details.
</p>
<p>If optional <code>evalresp</code> dataframe is not supplied, the code will call <code>getEvalresp</code> to obtain response
information from webservices.
</p>
<p><em>Uncorrected</em> spectral density values are returned in <code>spectrumMetricList</code> in units of dB.
</p>
<p><em>Instrument response corrected</em> spectral density values are returned in <code>correctedPsdDF</code> in units of dB.
</p>
<p>Probability Density Function (PDF) histogram values are returned in <code>pdfDF</code>. 
</p>
<p>Other metrics calculated from the PSDs are returned in <code>svMetricList</code>.  These metrics are:
</p>

<dl>
<dt><b>pct_above_nhnm</b> &ndash; &quot;percent above New High Noise Model&quot;</dt><dd><p>Percentage of PSD values that
are above the New High Noise Model for their frequency. Only frequencies less than the sample_rate/3 are
considered to avoid instrument response effects as you approach the nyquist frequency. 
This value is calculated over the entire time period.</p>
</dd>
<dt><b>pct_below_nlnm</b> &ndash; &quot;percent below New Low Noise Model&quot;</dt><dd><p>Percentage of PSD values that are below the
New Low Noise Model for their frequency. Only frequencies less than the sample_rate/3 are
considered to avoid instrument response effects as you approach the nyquist frequency.
This value is calculated over the entire time period.</p>
</dd>
<dt><b>dead_channel_lin</b> &ndash; &quot;dead channel metric - linear fit&quot;</dt><dd><p> A &quot;dead channel&quot; metric is calculated from
the mean of all the PSDs generated. (Typically 47 for a 24 hour period.) Values of the PSD mean line over the band
(linLoPeriod:linHiPeriod) are fit to a line.  The <code>dead_channel_lin</code> metric is the standard deviation of the
fit residuals.  Lower numbers indicate a better fit and a higher likelihood that the mean PSD is linear &ndash; an
indication of a &quot;dead channel&quot;.</p>
</dd>
</dl>

<p>Note: The dead_channel_exp metric has been removed.
</p>


<h3>Value</h3>

<p>A list of lists is returned containing:
</p>
 
<ul>
<li><p><code>spectrumMetricList</code> = list of <code>SpectrumMetric</code> objects
</p>
</li>
<li><p><code>correctedPsdDF</code> = dataframe of starttime, endtime, frequency (Hz), power (dB) values
</p>
</li>
<li><p><code>pdfDF</code> = dataframe of frequency (Hz), power (dB), hits (count) values
</p>
</li>
<li><p><code>svMetricList</code> = list of <code>SingleValueMetric</code> objects:
</p>

<ul>
<li><p><code>pct_above_nhnm</code>
</p>
</li>
<li><p><code>pct_below_nlnm</code>
</p>
</li>
<li><p><code>dead_channel_lin</code>
</p>
</li></ul>

</li></ul>



<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>References</h3>

<p><a href="https://pubs.usgs.gov/of/2005/1438/pdf/OFR-1438.pdf">Seismic Noise Analysis System Using Power Spectral Density Probability Density Functions</a> (McNamara and Boaz 2005)
</p>
<p><a href="https://pubs.usgs.gov/publication/ofr93322">Observations and Modeling of Seismic Background Noise</a> (Peterson 1993).
</p>


<h3>See Also</h3>

<p><code><a href="#topic+SpectrumMetric">SpectrumMetric</a></code>
<code><a href="#topic+SingleValueMetric">SingleValueMetric</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# NOTE:  The following trace has 1.728 million points.
# NOTE:  Downloading and calculating PSD may take a few seconds.
starttime &lt;- as.POSIXct("2010-02-27",tz="GMT")
endtime &lt;- as.POSIXct("2010-02-28",tz="GMT")
  
# Get the waveform
st &lt;- getDataselect(iris,"IU","ANMO","00","BHZ",starttime,endtime)

# Calculate the PSD metric and show the SingleValueMetric results
listOfLists &lt;- PSDMetric(st)
svMetricList &lt;- listOfLists[['svMetricList']]

dummy &lt;- lapply(svMetricList, show)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='sampleRateChannelMetric'>Sample rate consistency between miniSEED and metadata</h2><span id='topic+sampleRateChannelMetric'></span>

<h3>Description</h3>

<p>The sampleRateChannelMetric() function compares the miniSEED sample rate with the sample 
rate stored in the metadata channel. 
</p>


<h3>Usage</h3>

<pre><code class='language-R'>sampleRateChannelMetric(st,
                 channel_pct=1,
                 chan_rate=NULL)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="sampleRateChannelMetric_+3A_st">st</code></td>
<td>
<p>a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
<tr><td><code id="sampleRateChannelMetric_+3A_channel_pct">channel_pct</code></td>
<td>
<p>percentage by which the miniSEED and channel sample rates must agree to be considered a match</p>
</td></tr>
<tr><td><code id="sampleRateChannelMetric_+3A_chan_rate">chan_rate</code></td>
<td>
<p>metadata channel sample rate from miniSEED blockette 52, stationXML, or other metadata representation &lt;Channel:SampleRate&gt; element,
optional</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function retrieves the sample rate of the first trace from a <code>Stream</code> object and compares 
it to the metadata channel sample rate passed as <code>chan_rate</code> to see whether both sample rates agree within 
<code>channel_pct</code> percent. If chan_rate is not provided, the code will retrieve a sample rate
from IRIS web services. 
</p>
<p>The sampleRateChannelMetric function calculates and returns the following metrics:
</p>

<dl>
<dt><b>sample_rate_chan</b> &ndash; &quot;agreement between daily miniSEED and metadata channel sample rates&quot;</dt><dd><p>A 
boolean measurement that returns 0 if miniSEED and Channel sample rates agree within 1%, or 1 if they 
disagree.</p>
</dd>
</dl>



<h3>Value</h3>

<p>A list of lists is returned containing:
</p>
 
<ul>
<li><p><code>m1</code> = list of <code>sample_rate_channel</code> metric objects
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Mary Templeton <a href="mailto:mary.templeton@earthscope.org">mary.templeton@earthscope.org</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+SingleValueMetric">SingleValueMetric</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

starttime &lt;- as.POSIXct("2019-08-01",tz="GMT")
endtime &lt;- as.POSIXct("2019-08-02",tz="GMT")

# Get channel-level metadata, sample rate and normalizaton frequency
meta &lt;- IRISSeismic::getChannel(iris, "IU","ANMO","00","BHZ",starttime,endtime)
chan_rate &lt;- meta$samplerate
  
# Get the waveform
st &lt;- IRISSeismic::getDataselect(iris,"IU","ANMO","00","BHZ",starttime,endtime)

# Calculate the sample rate metrics
list1 &lt;- sampleRateChannelMetric(st,channel_pct=1,chan_rate)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='sampleRateRespMetric'>Sample rate consistency between miniSEED and metadata</h2><span id='topic+sampleRateRespMetric'></span>

<h3>Description</h3>

<p>The sampleRateRespMetric() function compares the miniSEED sample rate with  
the sample rate derived from the 
high-frequency corner of the channel's amplitude response.  
</p>


<h3>Usage</h3>

<pre><code class='language-R'>sampleRateRespMetric(st,
                 resp_pct=15,
	         norm_freq=NULL,
                 evalresp=NULL)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="sampleRateRespMetric_+3A_st">st</code></td>
<td>
<p>a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
<tr><td><code id="sampleRateRespMetric_+3A_resp_pct">resp_pct</code></td>
<td>
<p>percentage by which the miniSEED and response-derived sample rates must agree to be considered a match</p>
</td></tr>
<tr><td><code id="sampleRateRespMetric_+3A_norm_freq">norm_freq</code></td>
<td>
<p>the normalization frequency at which the stationXML InstrumentSensitivity or dataless Stage 0 Sensitivity is valid, optional</p>
</td></tr>
<tr><td><code id="sampleRateRespMetric_+3A_evalresp">evalresp</code></td>
<td>
<p>dataframe of freq, amp, phase information matching output of <code>getEvalresp</code>, optional</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Next the function retrieves the instrument response that corresponds with the start of the miniSEED time series, 
from frequencies one decade below the <code>norm_freq</code> through one decade above the miniSEED sampling frequency.  
The difference of the amplitude values,normalized for frequency spacing, are then scanned to find the first steep 
rolloff. The frequency associated with the maximum difference in the rolloff is stored as the empirical Nyquist 
frequency and multiplied by two to give the empirical response-derived sample rate.  The function then compares 
this sample rate with the miniSEED sample rate to see whether both rates agree within <code>resp_pct</code> percent.
The default percentage of 15
there is significant variations across instruments. If norm_freq or evalresp values are not provided, the code will
retrieve values from IRIS web services.
</p>
<p>The sampleRateMetric function calculates and returns the following metrics:
</p>

<dl>
<dt><b>sample_rate_resp</b> &ndash; &quot;agreement between daily miniSEED and response-derived sample rates&quot;</dt><dd><p>A 
boolean measurement that returns 0 if miniSEED and Response-derived  sample rates agree within 15%, or 
1 if they disagree. Response-derived sample rates assume that the high-frequency amplitude rolloff is ~85% 
of the Nyquist frequency.</p>
</dd>
</dl>



<h3>Value</h3>

<p>A list of lists is returned containing:
</p>
 
<ul>
<li><p><code>m1</code> = list of <code>sample_rate_resp</code> metric objects
</p>
</li></ul>



<h3>Author(s)</h3>

<p>Mary Templeton <a href="mailto:mary.templeton@earthscope.org">mary.templeton@earthscope.org</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+SingleValueMetric">SingleValueMetric</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

starttime &lt;- as.POSIXct("2019-08-01",tz="GMT")
endtime &lt;- as.POSIXct("2019-08-02",tz="GMT")

# Get channel-level metadata, sample rate and normalizaton frequency
meta &lt;- IRISSeismic::getChannel(iris, "IU","ANMO","00","BHZ",starttime,endtime)
norm_freq &lt;- meta$scalefreq
  
# Get the waveform
st &lt;- IRISSeismic::getDataselect(iris,"IU","ANMO","00","BHZ",starttime,endtime)

# Calculate the sample rate metrics
list1 &lt;- sampleRateRespMetric(st,resp_pct=15,norm_freq)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='saveMetricList'>Save a MetricList as RData or XML</h2><span id='topic+saveMetricList'></span>

<h3>Description</h3>

<p>The saveMetricList() function allows metrcis to be saved as either .RData files or as XML.
The XML format is the same as that used by the IRIS DMC MUSTANG database for metric submission.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>saveMetricList(metricList, id=Sys.getpid(), rdata=FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="saveMetricList_+3A_metriclist">metricList</code></td>
<td>
<p>list of SingleValueMetric objects</p>
</td></tr>
<tr><td><code id="saveMetricList_+3A_id">id</code></td>
<td>
<p>ID to be used when generating output files</p>
</td></tr>
<tr><td><code id="saveMetricList_+3A_rdata">rdata</code></td>
<td>
<p>optional flag to save the incoming <code>metricList</code> as a .RData file</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The <code>saveMetricList</code> function saves a list of <code>SingleValueMetrics</code> as a .RData binary file
or converts the list into the XML format expected by the MUSTANG database submission process. This XML
format is human readable and can be used to spot check results of metrics calculations.
</p>


<h3>Value</h3>

<p>The automatically generated filename is returned invisibly.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>See Also</h3>


<p><code><a href="#topic+SingleValueMetric-class">SingleValueMetric-class</a></code>,
<code><a href="#topic+metricList2Xml">metricList2Xml</a></code>,
<code><a href="#topic+getMetricsXml">getMetricsXml</a></code>,
<code><a href="#topic+getBssMetricList">getBssMetricList</a></code>,
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get the waveform
starttime &lt;- as.POSIXct("2012-01-24", tz="GMT")
endtime &lt;- as.POSIXct("2012-01-25", tz="GMT")
st &lt;- getDataselect(iris,"AK","PIN","","BHZ",starttime,endtime)

# Apply a metric and show the results
metricList &lt;- stateOfHealthMetric(st)
metricList &lt;- append(metricList, basicStatsMetric(st))
saveMetricList(metricList,id='AK.PIN..BHZ')
  
## End(Not run)
</code></pre>

<hr>
<h2 id='SingleValueMetric-class'>Class <code>"SingleValueMetric"</code></h2><span id='topic+SingleValueMetric-class'></span><span id='topic+SingleValueMetric'></span><span id='topic+show+2CSingleValueMetric-method'></span>

<h3>Description</h3>

<p>A container for metrics results and associated metadata.  This information is used to create XML that is
then submitted to the MUSTANG Backend Storage System (BSS). This has been superceded by <code>GeneralValueMetric</code> 
and is no longer in use.
</p>


<h3>Objects from the Class</h3>

<p>Objects can be created by calls of the form:
</p>
<p><code>new("SingleValueMetric", snclq, starttime, endtime, metricName, value)</code>
</p>
<p>Lists of <code>SingleValueMetric</code> objects are returned by various metrics functions in this package.
</p>


<h3>Slots</h3>


<dl>
<dt><code>snclq</code>:</dt><dd><p>Object of class <code>"character"</code>: SNCLQ identifier.</p>
</dd>
<dt><code>metricName</code>:</dt><dd><p>Object of class <code>"character"</code>: Name of the metric.</p>
</dd>
<dt><code>starttime</code>:</dt><dd><p>Object of class <code>"POSIXct"</code>: Start time.</p>
</dd>
<dt><code>endtime</code>:</dt><dd><p>Object of class <code>"POSIXct"</code>: End time.</p>
</dd>
<dt><code>valueName</code>:</dt><dd><p>Object of class <code>"character"</code>: Name of the XML value identifier (default=<code>"value"</code>).</p>
</dd>
<dt><code>value</code>:</dt><dd><p>Object of class <code>"numeric"</code>: Metric value.</p>
</dd>
<dt><code>valueString</code>:</dt><dd><p>Object of class <code>"character"</code>: String representation of the metric value.</p>
</dd>
<dt><code>quality_flag</code>:</dt><dd><p>Object of class <code>"numeric"</code>: Quality flag.</p>
</dd>
<dt><code>quality_flagString</code>:</dt><dd><p>Object of class <code>"character"</code>: String representation of quality flag.</p>
</dd>
<dt><code>attributeName</code>:</dt><dd><p>Object of class <code>"character"</code>: Name of one or more optional attributes.</p>
</dd>
<dt><code>attributeValueString</code>:</dt><dd><p>Object of class <code>"character"</code>: String representation of one or more attribute values.</p>
</dd>
</dl>



<h3>Methods</h3>



<dl>
<dt>show</dt><dd><p><code>signature(object = "SingleValueMetric")</code>: Prettyprints the information in the <code>SingleValueMetric</code> </p>
</dd>
</dl>



<h3>Note</h3>

<p>The <code>starttime</code> and <code>endtime</code> slots are typically associated with the <em>user requested</em> times 
which may not match up with the
<code>starttime</code> associated with the first <code>Trace</code> and the <code>endtime</code> associated with last <code>Trace</code>
in the <code>Stream</code> object being analyzed.  This ensures that
metrics results for a single time period but covering many stations or channels will have the same date range and
improves performance of the BSS which expects XML of the following form:
</p>
<pre>
&lt;measurements&gt;
  &lt;date start='2012-02-10T00:00:00.000' end='2012-02-10T09:20:00.000'&gt;
    &lt;target snclq='N.S.L.C1.Q'&gt;
      &lt;example value='1.0'/&gt;
    &lt;/target&gt;
    &lt;target snclq='N.S.L.C2.Q'&gt;
      &lt;example value='2.0'/&gt;
    &lt;/target&gt;
    &lt;target snclq='N.S.L.C3.Q'&gt;
      &lt;example value='3.0'/&gt;
    &lt;/target&gt;
  &lt;/date&gt;
  &lt;/date&gt;
&lt;/measurements&gt;
</pre>
<p>The <code>quality_flag</code> is an optional value available for storing information related to the
processing of a particular metric.  Its meaning will vary from metric to metric.
</p>
<p>For an IRIS/DMC specific example, the <code>station_completeness</code> metric obtains a list of available channels
for a station from the availability web service and compares this list with the list of <code>percent_availability</code> metrics for this station stored in the MUSTANG BSS.  In the case of the <code>station_completeness</code> metric, the 
<code>quality_flag</code> is set to the number of channels that should be available but for whom no <code>percent_availability</code> measure is obtained form the BSS.
</p>
<p>The <code>attributeName</code> and <code>attributeValueString</code> slots can be used to store additional attributes associated with a metric values. For example, the <code>max_stalta</code> value for a seismic trace can be calculated and a metric can be created that contains this value and another attribute with a string representation of the time at which this maximum occurred.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get the waveform
starttime &lt;- as.POSIXct("2012-01-24", tz="GMT")
endtime &lt;- as.POSIXct("2012-01-25", tz="GMT")
st &lt;- getDataselect(iris,"AK","PIN","","BHZ",starttime,endtime)

# Apply a metric and show the results
metricList &lt;- basicStatsMetric(st)
show(metricList[[1]])
  
## End(Not run)
</code></pre>

<hr>
<h2 id='SNRMetric'>Signal to Noise Ratio</h2><span id='topic+SNRMetric'></span>

<h3>Description</h3>

<p>The SNRMetric() function calculates the Signal-to-Noise Ratio of a seismic trace by one
of several named algorithms.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>SNRMetric(st, algorithm, windowSecs)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="SNRMetric_+3A_st">st</code></td>
<td>
<p> a <code>Stream</code> object containing a seismic signal </p>
</td></tr>
<tr><td><code id="SNRMetric_+3A_algorithm">algorithm</code></td>
<td>
<p> a named algorithm to use for calculating SNR (default=<code>"splitWindow"</code>) </p>
</td></tr>
<tr><td><code id="SNRMetric_+3A_windowsecs">windowSecs</code></td>
<td>
<p> width (seconds) of the full window used in SNR calculations (default=<code>60</code>) </p>
</td></tr>
</table>


<h3>Details</h3>

<p>Seismic signals in the Stream must be without gaps, <em>i.e.</em> contained within a single Trace.
</p>
<p><strong><code>algorithm="splitWindow"</code></strong>
</p>
<p>This algorithm uses the midpoint of the seismic signal as the border between noise to the left
of the midpoint and signal to the right.
The value for signal-to-noise is just the rmsVariance calculated for 
windowSecs/2 seconds of data to the right of the midpoint divided by the rmsVariance
for windowSecs/2 seconds of data to the left of the midpoint.
</p>
<p>No other algorithms have been vetted at this point.














</p>


<h3>Value</h3>

<p>A list with a single <code>SingleValueMetric</code> object is returned.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'> ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get an hour long waveform centered on a big quake
starttime &lt;- as.POSIXct("2010-02-27 06:16:15",tz="GMT")
endtime &lt;- as.POSIXct("2010-02-27 07:16:15",tz="GMT")
st &lt;- getDataselect(iris,"IU","ANMO","00","BHZ",starttime,endtime)
tr &lt;- st@traces[[1]]

# Calculate the SNR metric and show the results
metricList &lt;- SNRMetric(st)
dummy &lt;- lapply(metricList, show)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='SpectrumMetric-class'> Class <code>"SpectrumMetric"</code> </h2><span id='topic+SpectrumMetric-class'></span><span id='topic+SpectrumMetric'></span><span id='topic+show+2CSpectrumMetric-method'></span>

<h3>Description</h3>

<p>A container for metrics consisting of discrete spectra.  This information is used to create XML that is
then submitted to the MUSTANG Backend Storage System (BSS).
</p>


<h3>Objects from the Class</h3>

<p>Objects can be created by calls of the form:
</p>
<p><code>new("SpectrumMetric", snclq, starttime, endtime, metricName, freqs, amps, phases)</code>
</p>


<h3>Slots</h3>


<dl>
<dt><code>snclq</code>:</dt><dd><p>Object of class <code>"character"</code>: SNCLQ identifier.</p>
</dd>
<dt><code>metricName</code>:</dt><dd><p>Object of class <code>"character"</code>: Name of the metric.</p>
</dd>
<dt><code>elementName</code>:</dt><dd><p>Object of class <code>"character"</code>: Name of the datetime element (default=<code>"t"</code>).</p>
</dd>
<dt><code>starttime</code>:</dt><dd><p>Object of class <code>"POSIXct"</code>: Start time.</p>
</dd>
<dt><code>endtime</code>:</dt><dd><p>Object of class <code>"POSIXct"</code>: End time.</p>
</dd>
<dt><code>freqs</code>:</dt><dd><p>Object of class <code>"numeric"</code>: Frequency values.</p>
</dd>
<dt><code>freqStrings</code>:</dt><dd><p>Object of class <code>"character"</code>: String representations of the frequency values.</p>
</dd>
<dt><code>amps</code>:</dt><dd><p>Object of class <code>"numeric"</code>: Amplitude values.</p>
</dd>
<dt><code>ampStrings</code>:</dt><dd><p>Object of class <code>"character"</code>: String representations of the amplitude values.</p>
</dd>
<dt><code>phases</code>:</dt><dd><p>Object of class <code>"numeric"</code>: Phase values.</p>
</dd>
<dt><code>phaseStrings</code>:</dt><dd><p>Object of class <code>"character"</code>: String representations of the phase values.</p>
</dd>
<dt><code>quality_flag</code>:</dt><dd><p>Object of class <code>"numeric"</code>: Quality flag.</p>
</dd>
<dt><code>quality_flagString</code>:</dt><dd><p>Object of class <code>"character"</code>: String representation of quality flag.</p>
</dd>
</dl>



<h3>Methods</h3>



<dl>
<dt>show</dt><dd><p><code>signature(object = "SpectrumMetric")</code>: Prettyprints the information in the <code>SpectrumMetric</code> </p>
</dd>
</dl>



<h3>Note</h3>

<p>The <code>quality_flag</code> is an optional value available for storing information related to the
processing of a particular metric.  Its meaning will vary from metric to metric.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>

<hr>
<h2 id='spectrumMetric2Xml'>Convert a SpectrumMetric into XML for the BSS</h2><span id='topic+spectrumMetric2Xml'></span>

<h3>Description</h3>

<p>The <code>spectrumMetric2Xml</code> function converts a <code>SpectrumMetric</code> into an
XML structure appropriate for submitting to the MUSTANG Backend Storage System (BSS).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spectrumMetric2Xml(metricList)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="spectrumMetric2Xml_+3A_metriclist">metricList</code></td>
<td>
<p>a list of <code>SpectrumMetric</code> objects</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A character string with BSS formatted XML is returned.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# NOTE:  The following trace has 1.728 million points.
# NOTE:  Downloading and calculating PSD may take a while.
starttime &lt;- as.POSIXct("2010-02-27",tz="GMT")
endtime &lt;- as.POSIXct("2010-02-28",tz="GMT")
  
# Get the waveform
st &lt;- getDataselect(iris,"IU","ANMO","00","BHZ",starttime,endtime)

# Make sure we're working with a single snclq
unique_ids &lt;- uniqueIds(st)
if (length(unique_ids) &gt; 1) {
  stop(paste("PSDMetric: Stream has",unique_ids,"unique identifiers"))
}
snclq &lt;- unique_ids[1]

# Calculate and plot the Power Spectral Density
psdList &lt;- psdList(st)
  
# Create a Spectrum metric list
spectrumMetricList &lt;- list()
index &lt;- 1
for (psd in psdList) {
  spectrumMetricList[[index]] &lt;- new("SpectrumMetric", snclq=snclq,  
                                      starttime=psd$starttime, endtime=psd$endtime, 
                                      metricName="psd", freqs=psd$freq,
                                      amps=psd$spec, phases=psd$freq*0)
  index &lt;- index + 1
}

# Show the XML version of the metric
bssXml &lt;- spectrumMetric2Xml(spectrumMetricList)
cat(bssXml)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='spikesMetric'>Find spikes using a rolling Hampel filter</h2><span id='topic+spikesMetric'></span>

<h3>Description</h3>

<p>The spikesMetric() function determines the number of spikes in a seismic <code>Stream</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>spikesMetric(st, windowSize=41, thresholdMin=10, selectivity=NA, fixedThreshold=TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="spikesMetric_+3A_st">st</code></td>
<td>
<p> a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
<tr><td><code id="spikesMetric_+3A_windowsize">windowSize</code></td>
<td>
<p> The window size to roll over (default=<code>41</code>) </p>
</td></tr>
<tr><td><code id="spikesMetric_+3A_thresholdmin">thresholdMin</code></td>
<td>
<p> Initial value for outlier detection (default=<code>10.0</code>) </p>
</td></tr>
<tr><td><code id="spikesMetric_+3A_selectivity">selectivity</code></td>
<td>
<p> Numeric factor [0-1] used in determining outliers, or NA if fixedThreshold=TRUE (default=<code>NA</code>) </p>
</td></tr>
<tr><td><code id="spikesMetric_+3A_fixedthreshold">fixedThreshold</code></td>
<td>
<p>TRUE or FALSE, set the threshold=thresholdMin and ignore selectivity (default=<code>TRUE</code>)</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function uses the output of the <code>findOutliers()</code> function in the <span class="pkg">seismicRoll</span>
package to calculate the number of 'spikes' containing outliers.
</p>
<p>The <code>thresholdMin</code> level is similar to a sigma value for normally distributed data.
Hampel filter values above 6.0 indicate a data value that is extremely unlikely
to be part of a normal distribution (~ 1/500 million) and therefore very likely to be an outlier. By
choosing a relatively large value for <code>thresholdMin</code> we make it less likely that we
will generate false positives. False positives can include high frequency environmental noise.
</p>
<p>The <code>selectivity</code> is a value between 0 and 1 and is used to generate an appropriate 
threshold for outlier detection based on the statistics of the incoming data. A lower value
for <code>selectivity</code> will result in more outliers while a value closer to 1.0 will result in 
fewer. The code ignores selectivity if <code>fixedThreshold=TRUE</code>.
</p>
<p>The <code>fixedThreshold</code> is a logical <code>TRUE</code> or <code>FALSE</code>. If <code>TRUE</code>, then the threshold is set to <code>thresholdMin</code>.
If <code>FALSE</code>, then the threshold is set to maximum value of the <code>roll_hample()</code> function output multiplied by the <code>selectivity</code>.
</p>
<p>The total count of spikes reflects the number of outlier data points that are separated by at least 
one non-outlier data point. Each individual spike may contain more than one data point.
</p>


<h3>Value</h3>

<p>A list of <code>SingleValueMetric</code> objects is returned.
</p>


<h3>Note</h3>

<p>The <code>thresholdMin</code> parameter is sensitive to the data sampling rate. The default
value of 10 seems to work well with sampling rates of 10 Hz or higher ('B..' or 'H..' channels).  For
'L..' channels with a sampling rate of 1 Hz <code>thresholdMin=12.0</code> or larger may be more appropriate.
</p>
<p><strong>More testing of spiky signals at different resolutions is needed.</strong>
</p>

<p>See the <span class="pkg">seismicRoll</span> package for documentation on the findOutliers() function.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get the waveform
starttime &lt;- as.POSIXct("2013-01-03 15:00:00", tz="GMT")
endtime &lt;- starttime + 3600 * 3  
st &lt;- getDataselect(iris,"IU","RAO","10","BHZ",starttime,endtime)

# Calculate the gaps metrics and show the results
metricList &lt;- spikesMetric(st)
dummy &lt;- show(metricList)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='STALTAMetric'>Maximum STA/LTA of a signal</h2><span id='topic+STALTAMetric'></span>

<h3>Description</h3>

<p>The STALTAMetric() function calculates the maximum of STA/LTA over
the incoming seismic signal.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>STALTAMetric(st, staSecs, ltaSecs, increment, algorithm)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="STALTAMetric_+3A_st">st</code></td>
<td>
<p>a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
<tr><td><code id="STALTAMetric_+3A_stasecs">staSecs</code></td>
<td>
<p>length of the <b>s</b>hort term averaging window in seconds (default=3)</p>
</td></tr>
<tr><td><code id="STALTAMetric_+3A_ltasecs">ltaSecs</code></td>
<td>
<p>length of the <b>l</b>ong term averaging window in seconds (default=30)</p>
</td></tr>
<tr><td><code id="STALTAMetric_+3A_algorithm">algorithm</code></td>
<td>
<p>algorithm to be used (default=&quot;classic_LR&quot;)</p>
</td></tr>
<tr><td><code id="STALTAMetric_+3A_increment">increment</code></td>
<td>
<p>increment used when sliding the averaging windows to the next location (default=1)</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Currently supported algorithms include:
</p>

<ul>
<li><p><code>"classic_RR"</code>
</p>
</li>
<li><p><code>"classic_LR"</code>
</p>
</li>
<li><p><code>"EarleAndShearer_envelope"</code>
</p>
</li></ul>

<p>This metric applies the <code>STALTA</code> method of <code>Trace</code> objects
to every <code>Trace</code> in <code>st</code> with the following parameter settings:
</p>

<ul>
<li><p><code>demean=TRUE</code>
</p>
</li>
<li><p><code>detrend=TRUE</code>
</p>
</li>
<li><p><code>taper=0.0</code>
</p>
</li></ul>

<p>The final metric value is the maximum STALTA value found in any <code>Trace</code>
in this <code>Stream</code>.
</p>
<p>Further details are given in the documentation for <code>STALTA.Trace()</code>.
</p>


<h3>Value</h3>

<p>A list with a single <code>SingleValueMetric</code> object is returned. The metric
name is <code>max_stalta</code>.
</p>


<h3>Note</h3>


<p>The <code>STALTA</code> method of <code>Trace</code> objects returns a numeric vector of STA/LTA values
that has the same length as the signal data.  This is a moderately time consuming operation.
By comparison, finding the maximum value of this vector of STA/LTA values is very fast.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>References</h3>

<p><a href="https://en.wikipedia.org/wiki/First_break_picking">First break picking</a> (Wikipedia)
</p>
<p><a href="https://www.crewes.org/Documents/ResearchReports/2014/CRR201476.pdf">Automatic time-picking of first arrivals on large seismic datasets</a> (Wong 2014)
</p>
<p><a href="http://www.fcaglp.unlp.edu.ar/~velis/papers/PickingGeop10.pdf">Automatic first-breaks picking: New strategies and algorithms</a> (Sabbione and Velis 2010)
)
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get the waveform
starttime &lt;- as.POSIXct("2012-02-12",tz="GMT")
endtime &lt;- as.POSIXct("2012-02-13",tz="GMT")
st &lt;- getDataselect(iris,"AK","GHO","","BHN",starttime,endtime)

# Calculate the STA/LTA metric and show the results
metricList &lt;- STALTAMetric(st)
dummy &lt;- lapply(metricList, show)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='stateOfHealthMetric'>State of Health metrics</h2><span id='topic+stateOfHealthMetric'></span>

<h3>Description</h3>

<p>The <code>stateOfHealthMetric</code> function extracts accumulated miniSEED quality flags and a measure
of timing quality associated with the incoming seismic signal.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>stateOfHealthMetric(st)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="stateOfHealthMetric_+3A_st">st</code></td>
<td>
<p> a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The miniSEED flags and timing_qual values are described in the SEED manual
(<a href="http://www.fdsn.org/seed_manual/SEEDManual_V2.4.pdf">http://www.fdsn.org/seed_manual/SEEDManual_V2.4.pdf</a>).
</p>
<p>Each <code>Stream</code> object contains &quot;accumulators&quot; with counts of the number of times 
each bit flag was set during the parsing of a miniSEED file.  Metrics are reported
for a subset of these flags as show in the code snippet below:
</p>
<pre>
  # act_flags
  calibration_signal &lt;- st@act_flags[1]
  timing_correction &lt;- st@act_flags[2]
  event_begin &lt;- st@act_flags[3]
  event_end &lt;- st@act_flags[4]
  event_in_progress &lt;- st@act_flags[7]
  
  # io_flags
  clock_locked &lt;- st@io_flags[6]
                   
  # dq_flags
  amplifier_saturation &lt;- st@dq_flags[1]
  digitizer_clipping &lt;- st@dq_flags[2]
  spikes &lt;- st@dq_flags[3]
  glitches &lt;- st@dq_flags[4]
  missing_padded_data &lt;- st@dq_flags[5]
  telemetry_sync_error &lt;- st@dq_flags[6]
  digital_filter_charging &lt;- st@dq_flags[7]
</pre>
<p>An additional &quot;timing quality&quot; metric gives the average value for the <code>timing_qual</code>
value associated with each block of miniSEED data.
</p>


<h3>Value</h3>

<p>A list of <code>SingleValueMetric</code> objects is returned.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get the waveform
starttime &lt;- as.POSIXct("2012-01-24", tz="GMT")
endtime &lt;- as.POSIXct("2012-01-25", tz="GMT")
st &lt;- getDataselect(iris,"AK","PIN","","BHZ",starttime,endtime)

# Generate State of Health metrics and show the results
metricList &lt;- stateOfHealthMetric(st)
dummy &lt;- lapply(metricList, show)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='timesMetric2Xml'>Create XML for the BSS</h2><span id='topic+timesMetric2Xml'></span>

<h3>Description</h3>

<p>The <code>timesMetric2Xml</code> function converts a <code>MultipleTimeValueMetric</code> into an
XML structure appropriate for submitting to the MUSTANG Backend Storage System (BSS).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>timesMetric2Xml(metric)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="timesMetric2Xml_+3A_metric">metric</code></td>
<td>
<p>a <code>MultipleTimeValueMetric</code> object</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A character string with BSS formatted XML is returned.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

# Get the waveform
starttime &lt;- as.POSIXct("2012-01-24", tz="GMT")
endtime &lt;- as.POSIXct("2012-01-25", tz="GMT")
st &lt;- getDataselect(iris,"AK","PIN","","BHZ",starttime,endtime)

# Make sure we're working with a single snclq
unique_ids &lt;- uniqueIds(st)
if (length(unique_ids) &gt; 1) {
  stop(paste("meanMetric: Stream has",unique_ids,"unique identifiers"))
}
snclq &lt;- unique_ids[1]

# get the upDownTimes with a minimum signal length and minimum gap (secs)
upDownTimes &lt;- getUpDownTimes(st, min_signal=30, min_gap=60)
  
# Create and return a MultipleTimeValue metric from the upDownTimes
m &lt;- new("MultipleTimeValueMetric", snclq=snclq, starttime=starttime, 
         endtime=endtime, metricName="up_down_times", values=upDownTimes)

# Show the XML version of the metric
bssXml &lt;- timesMetric2Xml(m)
cat(bssXml)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='transferFunctionMetric'>Cross-spectral comparison</h2><span id='topic+transferFunctionMetric'></span>

<h3>Description</h3>

<p>The transferFunctionMetric() function calculates metrics that assess the relationship between
two SNCLs with the same network, station and channel but separate locations.  When seismometers are
working properly, the transfer function amplitude and phase will match similar values calculated
from the instrument responses.
</p>
<p>This function calculates the transfer function from data in the incoming streams.
Response information is then obtained from the <a href="http://service.iris.edu/irisws/evalresp/1/">evalresp web service</a>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>transferFunctionMetric(st1, st2, evalresp1, evalresp2)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="transferFunctionMetric_+3A_st1">st1</code></td>
<td>
<p>a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
<tr><td><code id="transferFunctionMetric_+3A_st2">st2</code></td>
<td>
<p>a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
<tr><td><code id="transferFunctionMetric_+3A_evalresp1">evalresp1</code></td>
<td>
<p>a <code>data frame</code> containing an amplitude and phase spectrum</p>
</td></tr>
<tr><td><code id="transferFunctionMetric_+3A_evalresp2">evalresp2</code></td>
<td>
<p>a <code>data frame</code> containing an amplitude and phase spectrum</p>
</td></tr>
</table>


<h3>Details</h3>


<p>Details of the algorithm are as follows
</p>
<pre>
# compute complex cross-spectrum of traces x and y ==&gt; Pxx, Pxy, Pyy
# calculate transfer function values:
#     Txy(f) = Pxy(f) / Pxx(f)
#     dataGain &lt;- Mod(Txy)
#     dataPhase &lt;- Arg(Txy)
#
# calculate avgDataGain and avgDataPhase values for periods of 5-7s
#
# calculate the corresponding response amplitude ratio and phase difference:
#     request responses for x and y
#     respGain = respGainy(f) / respGainx(f)
#     respPhase = respPhasey(f) - respPhasex(f)
#
# calculate avgRespGain and avgRespPhase values for periods of 5-7s
#
# calculate metrics:
#     gain_ratio = avgDataGain / avgRespGain
#     hase_diff = avgDataPhase - avgRespPhase
#     ms_coherence = |Pxy|^2 / (Pxx*Pyy)
</pre>


<h3>Value</h3>

<p>A list with a single <code>SingleValueMetric</code> object is returned.  The metric name is
<code>transfer_function</code> and it has three attributes:
</p>

<ul>
<li><p><code>gain_ratio</code> &ndash; reasonableness of cross-spectral amplitude between <code>st1</code> and <code>st2</code>
</p>
</li>
<li><p><code>phase_diff</code> &ndash; reasonableness of cross-spectral phase between <code>st1</code> and <code>st2</code>
</p>
</li>
<li><p><code>ms_coherence</code> &ndash; mean square coherence between <code>st1</code> and <code>st2</code>
</p>
</li></ul>

<p>These values can be interpreted as follows:
</p>
<p>Whenever <code>ms_coherence ~= 1.0</code>, properly functioning seismometers should have:
</p>

<ul>
<li><p><code>gain_raio ~= 1.0</code>
</p>
</li>
<li><p><code>phase_diff &lt; 10.0</code> (degrees)
</p>
</li></ul>



<h3>Note</h3>

<p>Seismic streams passed to transferFunctionMetric() must have the same network, station
and channel and must cover the same time range. The two channels should also have values of
azimuth and dip within five degrees of each other.  If sampling rates differ and one is a multiple
of the other, the stream with the higher sampling rate will be decimated to match the lower sampling rate.
</p>
<p>The metricList generated for these two-channel metrics will have a SNCL code of the form:
<code>N.S.L1:L2.C.Q</code>.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a> (R code),
Mary Templeton <a href="mailto:mary.templeton@earthscope.org">mary.templeton@earthscope.org</a> (algorithm)
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Create a new IrisClient
iris &lt;- new("IrisClient", debug=TRUE)

# Get seismic data
starttime &lt;- as.POSIXct("2011-05-01 12:00:00", tz="GMT")
endtime &lt;- starttime + 3600

st1 &lt;- getDataselect(iris,"CI","PASC","00","BHZ",starttime,endtime,inclusiveEnd=FALSE)
st2 &lt;- getDataselect(iris,"CI","PASC","10","BHZ",starttime,endtime,inclusiveEnd=FALSE)
evalresp1 &lt;- IRISSeismic::transferFunctionSpectra(st1,40)
evalresp2 &lt;- IRISSeismic::transferFunctionSpectra(st2,40)

# Calculate metrics
metricList &lt;- transferFunctionMetric(st1,st2,evalresp1,evalresp2)
print(metricList)
  
## End(Not run)
</code></pre>

<hr>
<h2 id='upDownTimesMetric'>Up/down times for a channel</h2><span id='topic+upDownTimesMetric'></span>

<h3>Description</h3>

<p>The upDownTimesMetric() function determines the times at which data collection starts and stops
within a seismic <code>Stream</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>upDownTimesMetric(st, min_signal, min_gap)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="upDownTimesMetric_+3A_st">st</code></td>
<td>
<p> a <code>Stream</code> object containing a seismic signal</p>
</td></tr>
<tr><td><code id="upDownTimesMetric_+3A_min_signal">min_signal</code></td>
<td>
<p> minimum duration of a <code>Trace</code> in seconds (default=<code>30</code>) </p>
</td></tr>
<tr><td><code id="upDownTimesMetric_+3A_min_gap">min_gap</code></td>
<td>
<p> minimum gap in seconds (default=<code>60</code>) </p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function uses the output of the <code>getUpDownTimes</code> method of <code>Stream</code> objects.
</p>


<h3>Value</h3>

<p>A list with a single <code>MultipleTimeValueMetric</code> object is returned.
</p>


<h3>Note</h3>


<p>See the <code>seismic</code> package for documentation on <code>Stream</code> objects and the <code>getDataselect</code> method.
</p>


<h3>Author(s)</h3>

<p>Jonathan Callahan <a href="mailto:jonathan@mazamascience.com">jonathan@mazamascience.com</a>
</p>


<h3>See Also</h3>


<p><code><a href="IRISSeismic.html#topic+getUpDownTimes">getUpDownTimes</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>  ## Not run: 
# Open a connection to IRIS DMC webservices
iris &lt;- new("IrisClient")

starttime &lt;- as.POSIXct("2012-01-24", tz="GMT")
endtime &lt;- as.POSIXct("2012-01-25", tz="GMT")

# Get the waveform
st &lt;- getDataselect(iris,"AK","PIN","","BHZ",starttime,endtime)

# Create the upDownTimesMetric, ignoring Traces &lt; 3 minutes and gaps of &lt; 5 minutes
metricList &lt;- upDownTimesMetric(st, min_signal=180, min_gap=300)
  
## End(Not run)
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
