<!DOCTYPE html><html lang="en-GB"><head><title>Help for package TrialEmulation</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {TrialEmulation}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#TrialEmulation-package'><p><code>TrialEmulation</code> Package</p></a></li>
<li><a href='#calculate_predictions'><p>Calculate and transform predictions</p></a></li>
<li><a href='#calculate_weights'><p>Calculate Inverse Probability of Censoring Weights</p></a></li>
<li><a href='#case_control_sampling_trials'><p>Case-control sampling of expanded data for the sequence of emulated trials</p></a></li>
<li><a href='#censor_func'><p>Censoring Function in C++</p></a></li>
<li><a href='#check_newdata'><p>Check Data used for Prediction</p></a></li>
<li><a href='#data_censored'><p>Example of longitudinal data for sequential trial emulation containing censoring</p></a></li>
<li><a href='#data_manipulation'><p>Data Manipulation Function</p></a></li>
<li><a href='#data_preparation'><p>Prepare data for the sequence of emulated target trials</p></a></li>
<li><a href='#expand'><p>Expand Function</p></a></li>
<li><a href='#expand_trials'><p>Expand trials</p></a></li>
<li><a href='#expand_until_switch'><p>Check Expand Flag After Treatment Switch</p></a></li>
<li><a href='#fit_msm'><p>Fit the marginal structural model for the sequence of emulated trials</p></a></li>
<li><a href='#fit_outcome_model'><p>Method for fitting outcome models</p></a></li>
<li><a href='#fit_weights_model'><p>Method for fitting weight models</p></a></li>
<li><a href='#initiators'><p>A wrapper function to perform data preparation and model fitting in a sequence of emulated target trials</p></a></li>
<li><a href='#internal-methods'><p>Internal Methods</p></a></li>
<li><a href='#ipw_data'><p>IPW Data Accessor and Setter</p></a></li>
<li><a href='#load_expanded_data'><p>Method to read, subset and sample expanded data</p></a></li>
<li><a href='#outcome_data'><p>Outcome Data Accessor and Setter</p></a></li>
<li><a href='#parsnip_model'><p>Fit outcome models using <code>parsnip</code> models</p></a></li>
<li><a href='#predict_marginal'><p>Predict marginal cumulative incidences with confidence intervals for a target trial population</p></a></li>
<li><a href='#print.TE_weight_summary'><p>Print a weight summary object</p></a></li>
<li><a href='#read_expanded_data'><p>Method to read expanded data</p></a></li>
<li><a href='#robust_calculation'><p>Robust Variance Calculation</p></a></li>
<li><a href='#sample_expanded_data'><p>Internal method to sample expanded data</p></a></li>
<li><a href='#save_expanded_data'><p>Method to save expanded data</p></a></li>
<li><a href='#save_to_csv'><p>Save expanded data as CSV</p></a></li>
<li><a href='#save_to_datatable'><p>Save expanded data as a <code>data.table</code></p></a></li>
<li><a href='#save_to_duckdb'><p>Save expanded data to <code>DuckDB</code></p></a></li>
<li><a href='#select_data_cols'><p>Select Data Columns</p></a></li>
<li><a href='#set_censor_weight_model'><p>Set censoring weight model</p></a></li>
<li><a href='#set_data'><p>Set the trial data</p></a></li>
<li><a href='#set_expansion_options'><p>Set expansion options</p></a></li>
<li><a href='#set_outcome_model'><p>Specify the outcome model</p></a></li>
<li><a href='#set_switch_weight_model'><p>Set switching weight model</p></a></li>
<li><a href='#show_weight_models'><p>Show Weight Model Summaries</p></a></li>
<li><a href='#stats_glm_logit'><p>Fit outcome models using <code>stats::glm</code></p></a></li>
<li><a href='#summary.TE_data_prep'><p>Summary methods</p></a></li>
<li><a href='#te_data_ex'><p>Example of a prepared data object</p></a></li>
<li><a href='#te_data-class'><p>TrialEmulation Data Class</p></a></li>
<li><a href='#te_datastore_csv-class'><p>te_datastore_csv, functions and methods</p></a></li>
<li><a href='#te_datastore_duckdb-class'><p>te_datastore_duckdb, functions and methods</p></a></li>
<li><a href='#te_datastore-class'><p>te_datastore</p></a></li>
<li><a href='#te_model_ex'><p>Example of a fitted marginal structural model object</p></a></li>
<li><a href='#te_model_fitter-class'><p>Outcome Model Fitter Class</p></a></li>
<li><a href='#te_outcome_data-class'><p>TrialEmulation Outcome Data Class</p></a></li>
<li><a href='#te_outcome_fitted-class'><p>Fitted Outcome Model Object</p></a></li>
<li><a href='#te_outcome_model-class'><p>Fitted Outcome Model Object</p></a></li>
<li><a href='#te_parsnip_model-class'><p>Fit Models using parsnip</p></a></li>
<li><a href='#te_stats_glm_logit-class'><p>Fit Models using logistic stats::glm</p></a></li>
<li><a href='#trial_example'><p>Example of longitudinal data for sequential trial emulation</p></a></li>
<li><a href='#trial_msm'><p>Fit the marginal structural model for the sequence of emulated trials</p></a></li>
<li><a href='#trial_sequence'><p>Create a sequence of emulated target trials object</p></a></li>
<li><a href='#trial_sequence-class'><p>Trial Sequence class</p></a></li>
<li><a href='#vignette_switch_data'><p>Example of expanded longitudinal data for sequential trial emulation</p></a></li>
<li><a href='#weight_model_data_indices'><p>Data used in weight model fitting</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Title:</td>
<td>Causal Analysis of Observational Time-to-Event Data</td>
</tr>
<tr>
<td>Version:</td>
<td>0.0.4.2</td>
</tr>
<tr>
<td>Description:</td>
<td>Implements target trial emulation methods to apply randomized
    clinical trial design and analysis in an observational setting. Using
    marginal structural models, it can estimate intention-to-treat and
    per-protocol effects in emulated trials using electronic health
    records. A description and application of the method can be found in
    Danaei et al (2013) &lt;<a href="https://doi.org/10.1177%2F0962280211403603">doi:10.1177/0962280211403603</a>&gt;.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License (&ge; 2)</a></td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://causal-lda.github.io/TrialEmulation/">https://causal-lda.github.io/TrialEmulation/</a>,
<a href="https://github.com/Causal-LDA/TrialEmulation">https://github.com/Causal-LDA/TrialEmulation</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/Causal-LDA/TrialEmulation/issues">https://github.com/Causal-LDA/TrialEmulation/issues</a></td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 4.0.0)</td>
</tr>
<tr>
<td>Imports:</td>
<td>broom (&ge; 0.7.10), checkmate, data.table (&ge; 1.9.8), DBI,
duckdb, formula.tools, lifecycle, lmtest, methods, mvtnorm,
parglm, Rcpp, sandwich</td>
</tr>
<tr>
<td>Suggests:</td>
<td>knitr, parsnip, rmarkdown, rpart, testthat (&ge; 3.0.0), withr</td>
</tr>
<tr>
<td>LinkingTo:</td>
<td>Rcpp</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>Config/testthat/edition:</td>
<td>3</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>Language:</td>
<td>en-GB</td>
</tr>
<tr>
<td>LazyData:</td>
<td>true</td>
</tr>
<tr>
<td>LazyDataCompression:</td>
<td>xz</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.3.2.9000</td>
</tr>
<tr>
<td>Collate:</td>
<td>'RcppExports.R' 'calculate_weights.R' 'data.R'
'data_extension.R' 'data_manipulation.R' 'data_preparation.R'
'data_simulation.R' 'data_utils.R' 'expand_trials.R'
'generics.R' 'initiators.R' 'lr_utils.R' 'te_model_fitter.R'
'te_outcome_model.R' 'te_datastore.R' 'te_weights.R'
'te_data.R' 'te_expansion.R' 'trial_sequence.R' 'modelling.R'
'package.R' 'predict.R' 'robust.R' 'sampling.R'
'te_datastore_csv.R' 'te_datastore_duckdb.R' 'te_parsnip.R'
'te_stats_glm_logit.R' 'utils.R' 'weighting.R'</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>yes</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2025-02-21 11:41:37 UTC; root</td>
</tr>
<tr>
<td>Author:</td>
<td>Isaac Gravestock <a href="https://orcid.org/0000-0003-0283-2065"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre],
  Li Su [aut],
  Roonak Rezvani <a href="https://orcid.org/0000-0001-5580-5058"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut] (Original package author),
  Julia Moesch [aut],
  Medical Research Council (MRC) [fnd],
  F. Hoffmann-La Roche AG [cph, fnd]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Isaac Gravestock &lt;isaac.gravestock@roche.com&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2025-02-21 12:30:18 UTC</td>
</tr>
</table>
<hr>
<h2 id='TrialEmulation-package'><code>TrialEmulation</code> Package</h2><span id='topic+TrialEmulation'></span><span id='topic+TrialEmulation-package'></span>

<h3>Description</h3>

<p><code>TrialEmulation</code> facilitates preprocessing and analysing observational data
an emulated a randomised trial.
</p>


<h3>Author(s)</h3>

<p><strong>Maintainer</strong>: Isaac Gravestock <a href="mailto:isaac.gravestock@roche.com">isaac.gravestock@roche.com</a> (<a href="https://orcid.org/0000-0003-0283-2065">ORCID</a>)
</p>
<p>Authors:
</p>

<ul>
<li><p> Li Su <a href="mailto:li.su@mrc-bsu.cam.ac.uk">li.su@mrc-bsu.cam.ac.uk</a>
</p>
</li>
<li><p> Roonak Rezvani <a href="mailto:roonak.r74@gmail.com">roonak.r74@gmail.com</a> (<a href="https://orcid.org/0000-0001-5580-5058">ORCID</a>) (Original package author)
</p>
</li>
<li><p> Julia Moesch <a href="mailto:julia.moesch@roche.com">julia.moesch@roche.com</a>
</p>
</li></ul>

<p>Other contributors:
</p>

<ul>
<li><p> Medical Research Council (MRC) [funder]
</p>
</li>
<li><p> F. Hoffmann-La Roche AG [copyright holder, funder]
</p>
</li></ul>



<h3>See Also</h3>

<p>Useful links:
</p>

<ul>
<li> <p><a href="https://causal-lda.github.io/TrialEmulation/">https://causal-lda.github.io/TrialEmulation/</a>
</p>
</li>
<li> <p><a href="https://github.com/Causal-LDA/TrialEmulation">https://github.com/Causal-LDA/TrialEmulation</a>
</p>
</li>
<li><p> Report bugs at <a href="https://github.com/Causal-LDA/TrialEmulation/issues">https://github.com/Causal-LDA/TrialEmulation/issues</a>
</p>
</li></ul>


<hr>
<h2 id='calculate_predictions'>Calculate and transform predictions</h2><span id='topic+calculate_predictions'></span>

<h3>Description</h3>

<p>Calculate and transform predictions
</p>


<h3>Usage</h3>

<pre><code class='language-R'>calculate_predictions(
  newdata,
  model,
  treatment_values,
  pred_fun,
  coefs_mat,
  matrix_n_col
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="calculate_predictions_+3A_newdata">newdata</code></td>
<td>
<p>New data to predict outcome</p>
</td></tr>
<tr><td><code id="calculate_predictions_+3A_model">model</code></td>
<td>
<p>GLM object</p>
</td></tr>
<tr><td><code id="calculate_predictions_+3A_treatment_values">treatment_values</code></td>
<td>
<p>Named vector of value to insert into <code>assigned_treatment</code> column</p>
</td></tr>
<tr><td><code id="calculate_predictions_+3A_pred_fun">pred_fun</code></td>
<td>
<p>Function to transform prediction matrix</p>
</td></tr>
<tr><td><code id="calculate_predictions_+3A_coefs_mat">coefs_mat</code></td>
<td>
<p>Matrix of coefficients corresponding to <code>model_matrix</code>.</p>
</td></tr>
<tr><td><code id="calculate_predictions_+3A_matrix_n_col">matrix_n_col</code></td>
<td>
<p>Expected number of column after prediction.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A matrix with transformed predicted values. Number of columns corresponds
to the number of rows of <code>coefs_mat</code>
</p>

<hr>
<h2 id='calculate_weights'>Calculate Inverse Probability of Censoring Weights</h2><span id='topic+calculate_weights'></span><span id='topic+calculate_weights+2Ctrial_sequence_ITT-method'></span><span id='topic+calculate_weights+2Ctrial_sequence_AT-method'></span><span id='topic+calculate_weights+2Ctrial_sequence_PP-method'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>calculate_weights(object, ...)

## S4 method for signature 'trial_sequence_ITT'
calculate_weights(object, quiet = FALSE)

## S4 method for signature 'trial_sequence_AT'
calculate_weights(object, quiet = FALSE)

## S4 method for signature 'trial_sequence_PP'
calculate_weights(object, quiet = FALSE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="calculate_weights_+3A_object">object</code></td>
<td>
<p>A <a href="#topic+trial_sequence">trial_sequence</a> object</p>
</td></tr>
<tr><td><code id="calculate_weights_+3A_...">...</code></td>
<td>
<p>Other arguments used by methods.</p>
</td></tr>
<tr><td><code id="calculate_weights_+3A_quiet">quiet</code></td>
<td>
<p>Prints model summaries is <code>TRUE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <a href="#topic+trial_sequence">trial_sequence</a> object with updated <code>censor_weights</code> and/or <code>switch_weights</code> slots
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
save_dir &lt;- file.path(tempdir(), "switch_models")
ts &lt;- trial_sequence("PP") |&gt;
  set_data(
    data = data_censored,
    id = "id",
    period = "period",
    treatment = "treatment",
    outcome = "outcome",
    eligible = "eligible"
  ) |&gt;
  set_switch_weight_model(
    numerator = ~ age + x1 + x3,
    denominator = ~age,
    model_fitter = stats_glm_logit(save_path = save_dir)
  ) |&gt;
  calculate_weights()

</code></pre>

<hr>
<h2 id='case_control_sampling_trials'>Case-control sampling of expanded data for the sequence of emulated trials</h2><span id='topic+case_control_sampling_trials'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#stable"><img src="../help/figures/lifecycle-stable.svg" alt='[Stable]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>case_control_sampling_trials(
  data_prep,
  p_control = NULL,
  subset_condition,
  sort = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="case_control_sampling_trials_+3A_data_prep">data_prep</code></td>
<td>
<p>Result from <code><a href="#topic+data_preparation">data_preparation()</a></code>.</p>
</td></tr>
<tr><td><code id="case_control_sampling_trials_+3A_p_control">p_control</code></td>
<td>
<p>Control sampling probability for selecting potential controls at each follow-up time of each trial.</p>
</td></tr>
<tr><td><code id="case_control_sampling_trials_+3A_subset_condition">subset_condition</code></td>
<td>
<p>Expression used to <code><a href="base.html#topic+subset">subset()</a></code> the trial data before case-control sampling.</p>
</td></tr>
<tr><td><code id="case_control_sampling_trials_+3A_sort">sort</code></td>
<td>
<p>Sort data before applying case-control sampling to make sure that the resulting data are identical when
sampling from the expanded data created with <code>separate_files = TRUE</code> or <code>separate_files = FALSE</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Perform case-control sampling of expanded data to create a data set of reduced size and calculate sampling weights
to be used in <code>trial_msm()</code>.
</p>


<h3>Value</h3>

<p>A <code>data.frame</code> or a <code><a href="base.html#topic+split">split()</a></code> <code>data.frame</code> if  <code>length(p_control) &gt; 1</code>. An additional column <code>sample_weight</code>
containing the sample weights will be added to the result. These can be included in the models fit with
<code><a href="#topic+trial_msm">trial_msm()</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># If necessary reduce the number of threads for data.table
data.table::setDTthreads(2)

data("te_data_ex")
samples &lt;- case_control_sampling_trials(te_data_ex, p_control = 0.01)
</code></pre>

<hr>
<h2 id='censor_func'>Censoring Function in C++</h2><span id='topic+censor_func'></span>

<h3>Description</h3>

<p>Artificial censoring C++ function
</p>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="censor_func_+3A_sw_data">sw_data</code></td>
<td>
<p>A dataframe with the columns needed in censoring process</p>
</td></tr>
</table>

<hr>
<h2 id='check_newdata'>Check Data used for Prediction</h2><span id='topic+check_newdata'></span>

<h3>Description</h3>

<p>Check Data used for Prediction
</p>


<h3>Usage</h3>

<pre><code class='language-R'>check_newdata(newdata, model, predict_times)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="check_newdata_+3A_newdata">newdata</code></td>
<td>
<p>new data to predict, or missing.</p>
</td></tr>
<tr><td><code id="check_newdata_+3A_model">model</code></td>
<td>
<p>glm model object.</p>
</td></tr>
<tr><td><code id="check_newdata_+3A_predict_times">predict_times</code></td>
<td>
<p>times to predict to add to resulting newdata.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>newdata</code> data.frame
</p>

<hr>
<h2 id='data_censored'>Example of longitudinal data for sequential trial emulation containing censoring</h2><span id='topic+data_censored'></span>

<h3>Description</h3>

<p>This data contains data from 89 patients followed for up to 19 periods.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data_censored
</code></pre>


<h3>Format</h3>

<p>A data frame with 725 rows and 12 variables:
</p>

<dl>
<dt>id</dt><dd><p>patient identifier</p>
</dd>
<dt>period</dt><dd><p>time period</p>
</dd>
<dt>treatment</dt><dd><p>indicator for receiving treatment in this period, 1=treatment, 0=non-treatment</p>
</dd>
<dt>x1</dt><dd><p>A time-varying categorical variable relating to treatment and the outcome</p>
</dd>
<dt>x2</dt><dd><p>A time-varying numeric variable relating to treatment and the outcome</p>
</dd>
<dt>x3</dt><dd><p>A fixed categorical variable relating to treatment and the outcome</p>
</dd>
<dt>x4</dt><dd><p>A fixed categorical variable relating to treatment and the outcome</p>
</dd>
<dt>age</dt><dd><p>patient age in years</p>
</dd>
<dt>age_s</dt><dd><p>patient age</p>
</dd>
<dt>outcome</dt><dd><p>indicator for outcome in this period, 1=event occurred, 0=no event</p>
</dd>
<dt>censored</dt><dd><p>indicator for patient being censored in this period, 1=censored, 0=not censored</p>
</dd>
<dt>eligible</dt><dd><p>indicator for eligibility for trial start in this period, 1=yes, 0=no</p>
</dd>
</dl>


<hr>
<h2 id='data_manipulation'>Data Manipulation Function</h2><span id='topic+data_manipulation'></span>

<h3>Description</h3>

<p>This function takes the data and all the variables and does the extension preprocessing
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data_manipulation(data, use_censor = TRUE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="data_manipulation_+3A_data">data</code></td>
<td>
<p><code>data.table</code> to pre-process for weight calculation and extension.</p>
</td></tr>
<tr><td><code id="data_manipulation_+3A_use_censor">use_censor</code></td>
<td>
<p>apply censoring due to treatment switch?</p>
</td></tr>
</table>

<hr>
<h2 id='data_preparation'>Prepare data for the sequence of emulated target trials</h2><span id='topic+data_preparation'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#stable"><img src="../help/figures/lifecycle-stable.svg" alt='[Stable]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data_preparation(
  data,
  id = "id",
  period = "period",
  treatment = "treatment",
  outcome = "outcome",
  eligible = "eligible",
  model_var = NULL,
  outcome_cov = ~1,
  estimand_type = c("ITT", "PP", "As-Treated"),
  switch_n_cov = ~1,
  switch_d_cov = ~1,
  first_period = NA,
  last_period = NA,
  use_censor_weights = FALSE,
  cense = NA,
  pool_cense = c("none", "both", "numerator"),
  cense_d_cov = ~1,
  cense_n_cov = ~1,
  eligible_wts_0 = NA,
  eligible_wts_1 = NA,
  where_var = NULL,
  data_dir,
  save_weight_models = FALSE,
  glm_function = "glm",
  chunk_size = 500,
  separate_files = FALSE,
  quiet = FALSE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="data_preparation_+3A_data">data</code></td>
<td>
<p>A <code>data.frame</code> containing all the required variables in the person-time format, i.e., the  &lsquo;long&rsquo; format.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_id">id</code></td>
<td>
<p>Name of the variable for identifiers of the individuals.  Default is &lsquo;id&rsquo;.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_period">period</code></td>
<td>
<p>Name of the variable for the visit/period.   Default is &lsquo;period&rsquo;.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_treatment">treatment</code></td>
<td>
<p>Name of the variable  for the treatment indicator at that visit/period. Default is &lsquo;treatment&rsquo;.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_outcome">outcome</code></td>
<td>
<p>Name of the variable for the indicator of the outcome event at that visit/period.  Default is
&lsquo;outcome&rsquo;.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_eligible">eligible</code></td>
<td>
<p>Name of the variable for the indicator of eligibility for the target trial at that visit/period.
Default is &lsquo;eligible&rsquo;.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_model_var">model_var</code></td>
<td>
<p>Treatment variables to be included in the marginal structural model for the emulated trials.
<code>model_var = "assigned_treatment"</code> will create a variable <code>assigned_treatment</code> that is the assigned treatment at
the trial baseline, typically used for ITT and per-protocol analyses. <code>model_var = "dose"</code> will create a variable
<code>dose</code> that is the cumulative number of  treatments received since the trial baseline, typically used in as-treated
analyses.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_outcome_cov">outcome_cov</code></td>
<td>
<p>A RHS formula with baseline covariates to be adjusted for in the marginal structural model for the
emulated trials. Note that if a time-varying covariate is specified in <code>outcome_cov</code>, only its value at each of the
trial baselines will be included in the expanded data.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_estimand_type">estimand_type</code></td>
<td>
<p>Specify the estimand for the causal analyses in the sequence of emulated trials. <code>estimand_type = "ITT"</code> will perform intention-to-treat analyses, where treatment switching after trial baselines are ignored.
<code>estimand_type = "PP"</code> will perform per-protocol analyses, where individuals' follow-ups are artificially censored
and inverse probability of treatment weighting is applied. <code>estimand_type = "As-Treated"</code> will fit a standard
marginal structural model for all possible treatment sequences, where individuals' follow-ups are not artificially
censored  but treatment switching after trial baselines are accounted for by applying inverse probability of
treatment weighting.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_switch_n_cov">switch_n_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the numerator terms of the inverse
probability of treatment weights. A derived variable named <code>time_on_regime</code> containing the duration of time that
the individual has been on the current treatment/non-treatment is available for use in these models.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_switch_d_cov">switch_d_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the denominator terms of the inverse
probability of treatment weights.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_first_period">first_period</code></td>
<td>
<p>First time period to be set as trial baseline  to start expanding the data.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_last_period">last_period</code></td>
<td>
<p>Last time period to be set as trial baseline  to start expanding the data.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_use_censor_weights">use_censor_weights</code></td>
<td>
<p>Require the inverse probability of censoring weights. If <code>use_censor_weights = TRUE</code>, then
the variable name of the censoring indicator needs to be provided in the argument <code>cense</code>.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_cense">cense</code></td>
<td>
<p>Variable name for the censoring indicator. Required if <code>use_censor_weights = TRUE</code>.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_pool_cense">pool_cense</code></td>
<td>
<p>Fit pooled or separate censoring models for those treated and those untreated at the immediately
previous visit. Pooling can be specified for the models for the numerator and denominator terms of the inverse
probability of censoring weights. One of <code>"none"</code>, <code>"numerator"</code>, or <code>"both"</code> (default is <code>"none"</code> except when
<code>estimand_type = "ITT"</code> then default is <code>"numerator"</code>).</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_cense_d_cov">cense_d_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the denominator terms of the inverse
probability of censoring weights.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_cense_n_cov">cense_n_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the numerator terms of the inverse
probability of censoring weights.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_eligible_wts_0">eligible_wts_0</code></td>
<td>
<p>See definition for <code>eligible_wts_1</code></p>
</td></tr>
<tr><td><code id="data_preparation_+3A_eligible_wts_1">eligible_wts_1</code></td>
<td>
<p>Exclude some observations when fitting the models for the inverse probability of treatment
weights. For example, if it is assumed that an individual will stay on treatment for at least 2 visits, the first 2
visits  after treatment initiation by definition have a probability of staying on the treatment of 1.0 and should
thus be excluded from the weight models for those who are on treatment at the immediately previous visit. Users can
define a variable that indicates that these 2 observations are ineligible for the weight model for those who are on
treatment at the immediately previous visit and add the variable name in the argument <code>eligible_wts_1</code>. Similar
definitions are applied to <code>eligible_wts_0</code> for excluding observations when fitting the models for the inverse
probability of treatment weights for those who are not on treatment at the immediately previous visit.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_where_var">where_var</code></td>
<td>
<p>Specify the variable names that will be used to define subgroup conditions when fitting the marginal
structural model for a subgroup of individuals. Need to specify jointly with the argument <code>where_case</code>.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_data_dir">data_dir</code></td>
<td>
<p>Directory to save model objects when <code>save_weight_models=TRUE</code> and expanded data as separate CSV
files names as <code>trial_i.csv</code>s if <code>separate_files = TRUE</code>. If the specified directory does not exist it will be
created. If the directory already contains trial files, an error will occur, other files may be overwritten.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_save_weight_models">save_weight_models</code></td>
<td>
<p>Save model objects for estimating the weights in <code>data_dir</code>.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_glm_function">glm_function</code></td>
<td>
<p>Specify which glm function to use for the marginal structural model from the <code>stats</code> or <code>parglm</code>
packages. The default function is the <code>glm</code> function in the <code>stats</code> package. Users can also specify <code>glm_function = "parglm"</code> such that the <code>parglm</code> function in the <code>parglm</code> package can be used for fitting generalized linear models
in parallel. The default control setting for  <code>parglm</code> is <code>nthreads = 4</code> and <code>method = "FAST"</code>, where four cores
and Fisher information are used for faster computation. Users can change the default control setting by passing the
arguments <code>nthreads</code> and <code>method</code> in the <code>parglm.control</code> function of the <code>parglm</code> package, or alternatively, by
passing a <code>control</code> argument with a list produced by <code>parglm.control(nthreads = , method = )</code>.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_chunk_size">chunk_size</code></td>
<td>
<p>Number of individuals whose data to  be processed in one chunk when <code>separate_files = TRUE</code></p>
</td></tr>
<tr><td><code id="data_preparation_+3A_separate_files">separate_files</code></td>
<td>
<p>Save expanded data in separate CSV files for each trial.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_quiet">quiet</code></td>
<td>
<p>Suppress the printing of progress messages and summaries of the fitted models.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to <code>glm_function</code>. This may be used to specify initial values of parameters or
arguments to <code>control</code>. See <a href="stats.html#topic+glm">stats::glm</a>, <a href="parglm.html#topic+parglm">parglm::parglm</a> and <code><a href="parglm.html#topic+parglm.control">parglm::parglm.control()</a></code> for more information.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function  expands observational data in the person-time format (i.e., the  &lsquo;long&rsquo; format) to emulate a sequence
of target trials and also estimates the inverse probability of treatment and censoring weights as required.
</p>
<p>The arguments <code>chunk_size</code> and <code>separate_files</code> allow for processing of large datasets that would not fit in
memory once expanded. When <code>separate_files = TRUE</code>, the input data are processed in chunks of individuals and saved
into separate files for each emulated trial. These separate files can be sampled by case-control sampling to create
a reduced dataset for the modelling.
</p>


<h3>Value</h3>

<p>An object of class <code>TE_data_prep</code>, which can either be sampled from (<a href="#topic+case_control_sampling_trials">case_control_sampling_trials</a>) or
directly used in a model (<a href="#topic+trial_msm">trial_msm</a>). It contains the elements
</p>

<dl>
<dt>data</dt><dd><p>the expanded dataset for all emulated trials. If <code>separate_files = FALSE</code>, it is  a <code>data.table</code>; if
<code>separate_files = TRUE</code>, it is a character vector with the file path of the expanded data as CSV files.</p>
</dd>
<dt>min_period</dt><dd><p>index for the first trial in the expanded data</p>
</dd>
<dt>max_period</dt><dd><p>index for the last trial in the expanded data</p>
</dd>
<dt>N</dt><dd><p>the total number of observations in the expanded data</p>
</dd>
<dt>data_template</dt><dd><p>a zero-row <code>data.frame</code>  with the columns and attributes of the expanded data</p>
</dd>
<dt>switch_models</dt><dd><p>a list of summaries of the models fitted for inverse probability of treatment weights,
if <code>estimand_type</code> is <code>"PP"</code> or <code>"As-Treated"</code></p>
</dd>
<dt>censor_models</dt><dd><p>a list of summaries of the models fitted for inverse probability of censoring weights,
if <code>use_censor_weights=TRUE</code></p>
</dd>
<dt>args</dt><dd><p>a list contain the parameters used to prepare the data and fit the weight models</p>
</dd>
</dl>


<hr>
<h2 id='expand'>Expand Function</h2><span id='topic+expand'></span>

<h3>Description</h3>

<p>This function performs the data expansion for a given dataset
</p>


<h3>Usage</h3>

<pre><code class='language-R'>expand(
  sw_data,
  outcomeCov_var,
  where_var,
  use_censor,
  maxperiod,
  minperiod,
  keeplist
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="expand_+3A_sw_data">sw_data</code></td>
<td>
<p>datatable to expand</p>
</td></tr>
<tr><td><code id="expand_+3A_outcomecov_var">outcomeCov_var</code></td>
<td>
<p>A list of individual baseline variables used in final model</p>
</td></tr>
<tr><td><code id="expand_+3A_where_var">where_var</code></td>
<td>
<p>Variables used in where conditions used in subsetting the data used in final analysis (where_case),
the variables not included in the final model</p>
</td></tr>
<tr><td><code id="expand_+3A_use_censor">use_censor</code></td>
<td>
<p>Use censoring for per-protocol analysis - censor person-times once a person-trial stops taking the
initial treatment value</p>
</td></tr>
<tr><td><code id="expand_+3A_maxperiod">maxperiod</code></td>
<td>
<p>Maximum period</p>
</td></tr>
<tr><td><code id="expand_+3A_minperiod">minperiod</code></td>
<td>
<p>Minimum period</p>
</td></tr>
<tr><td><code id="expand_+3A_keeplist">keeplist</code></td>
<td>
<p>A list contains names of variables used in final model</p>
</td></tr>
</table>

<hr>
<h2 id='expand_trials'>Expand trials</h2><span id='topic+expand_trials'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>expand_trials(object)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="expand_trials_+3A_object">object</code></td>
<td>
<p>A <a href="#topic+trial_sequence">trial_sequence</a> object</p>
</td></tr>
</table>


<h3>Value</h3>

<p>The <a href="#topic+trial_sequence">trial_sequence</a> <code>object</code> with a data set containing the full sequence of target trials. The data is
stored according to the options set with <code><a href="#topic+set_expansion_options">set_expansion_options()</a></code> and especially the <code style="white-space: pre;">&#8288;save_to_*&#8288;</code> function.
</p>

<hr>
<h2 id='expand_until_switch'>Check Expand Flag After Treatment Switch</h2><span id='topic+expand_until_switch'></span>

<h3>Description</h3>

<p>Check if patients have switched treatment in eligible trials
and set <code>expand = 0</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>expand_until_switch(s, n)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="expand_until_switch_+3A_s">s</code></td>
<td>
<p>numeric vector where <code>1</code> indicates a treatment switch in that period</p>
</td></tr>
<tr><td><code id="expand_until_switch_+3A_n">n</code></td>
<td>
<p>length of s</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Vector of indicator values up until first switch.
</p>

<hr>
<h2 id='fit_msm'>Fit the marginal structural model for the sequence of emulated trials</h2><span id='topic+fit_msm'></span><span id='topic+fit_msm+2Ctrial_sequence-method'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>fit_msm(
  object,
  weight_cols = c("weight", "sample_weight"),
  modify_weights = NULL
)

## S4 method for signature 'trial_sequence'
fit_msm(
  object,
  weight_cols = c("weight", "sample_weight"),
  modify_weights = NULL
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="fit_msm_+3A_object">object</code></td>
<td>
<p>A <code>trial_sequence</code> object</p>
</td></tr>
<tr><td><code id="fit_msm_+3A_weight_cols">weight_cols</code></td>
<td>
<p>character vector of column names in expanded outcome dataset, ie <code>outcome_data(object)</code>. If
multiple columns are specified, the element wise product will be used. Specify <code>NULL</code> if no weight columns should be
used.</p>
</td></tr>
<tr><td><code id="fit_msm_+3A_modify_weights">modify_weights</code></td>
<td>
<p>a function to transform the weights (or <code>NULL</code> for no transformation).
Must take a numeric vector of weights and a vector of positive, finite weights of the same length.
See examples for some possible function definitions.
</p>
<p>Before the outcome marginal structural model can be fit, the outcome model must be specified with
<code><a href="#topic+set_outcome_model">set_outcome_model()</a></code> and the data must be expanded into the trial sequence with <code><a href="#topic+expand_trials">expand_trials()</a></code>.
</p>
<p>The model is fit based on the <code>model_fitter</code> specified in <a href="#topic+set_outcome_model">set_outcome_model</a> using the internal <code>fit_outcome_model</code>
method.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A modified <code>trial_sequence</code> object with updated <code>outcome_model</code> slot.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>trial_seq_object &lt;- trial_sequence("ITT") |&gt;
  set_data(data_censored) |&gt;
  set_outcome_model(
    adjustment_terms = ~age_s,
    followup_time_terms = ~ stats::poly(followup_time, degree = 2)
  ) |&gt;
  set_expansion_options(output = save_to_datatable(), chunk_size = 500) |&gt;
  expand_trials() |&gt;
  load_expanded_data()

fit_msm(trial_seq_object)

# Using modify_weights functions ----

# returns a function that truncates weights to limits
limit_weight &lt;- function(lower_limit, upper_limit) {
  function(w) {
    w[w &gt; upper_limit] &lt;- upper_limit
    w[w &lt; lower_limit] &lt;- lower_limit
    w
  }
}

# calculate 1st and 99th percentile limits and truncate
p99_weight &lt;- function(w) {
  p99 &lt;- quantile(w, prob = c(0.01, 0.99), type = 1)
  limit_weight(p99[1], p99[2])(w)
}

# set all weights to 1
all_ones &lt;- function(w) {
  rep(1, length(w))
}

fit_msm(trial_seq_object, modify_weights = limit_weight(0.01, 4))
fit_msm(trial_seq_object, modify_weights = p99_weight)
</code></pre>

<hr>
<h2 id='fit_outcome_model'>Method for fitting outcome models</h2><span id='topic+fit_outcome_model'></span>

<h3>Description</h3>

<p>Method for fitting outcome models
</p>


<h3>Usage</h3>

<pre><code class='language-R'>fit_outcome_model(object, data, formula, weights = NULL)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="fit_outcome_model_+3A_object">object</code></td>
<td>
<p>A <code>te_outcome_fitter</code> object</p>
</td></tr>
<tr><td><code id="fit_outcome_model_+3A_data">data</code></td>
<td>
<p><code>data.frame</code> containing outcomes and covariates as defined in <code>formula</code>.</p>
</td></tr>
<tr><td><code id="fit_outcome_model_+3A_formula">formula</code></td>
<td>
<p><code>formula</code> describing the model.</p>
</td></tr>
<tr><td><code id="fit_outcome_model_+3A_weights">weights</code></td>
<td>
<p><code>numeric</code> vector of weights.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An object of class <code>te_outcome_fitted</code>
</p>

<hr>
<h2 id='fit_weights_model'>Method for fitting weight models</h2><span id='topic+fit_weights_model'></span>

<h3>Description</h3>

<p>Method for fitting weight models
</p>


<h3>Usage</h3>

<pre><code class='language-R'>fit_weights_model(object, data, formula, label)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="fit_weights_model_+3A_object">object</code></td>
<td>
<p>The object determining which method should be used, containing any slots containing user defined
parameters.</p>
</td></tr>
<tr><td><code id="fit_weights_model_+3A_data">data</code></td>
<td>
<p><code>data.frame</code> containing outcomes and covariates as defined in <code>formula</code>.</p>
</td></tr>
<tr><td><code id="fit_weights_model_+3A_formula">formula</code></td>
<td>
<p><code>formula</code> describing the model.</p>
</td></tr>
<tr><td><code id="fit_weights_model_+3A_label">label</code></td>
<td>
<p>A short string describing the model.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An object of class <code>te_weights_fitted</code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>fitter &lt;- stats_glm_logit(tempdir())
data(data_censored)
# Not usually called directly by a user
fitted &lt;- fit_weights_model(
  object = fitter,
  data = data_censored,
  formula = 1 - censored ~ x1 + age_s + treatment,
  label = "Example model for censoring"
)
fitted
unlink(fitted@summary$save_path$path)
</code></pre>

<hr>
<h2 id='initiators'>A wrapper function to perform data preparation and model fitting in a sequence of emulated target trials</h2><span id='topic+initiators'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#stable"><img src="../help/figures/lifecycle-stable.svg" alt='[Stable]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>initiators(
  data,
  id = "id",
  period = "period",
  treatment = "treatment",
  outcome = "outcome",
  eligible = "eligible",
  outcome_cov = ~1,
  estimand_type = c("ITT", "PP", "As-Treated"),
  model_var = NULL,
  switch_n_cov = ~1,
  switch_d_cov = ~1,
  first_period = NA,
  last_period = NA,
  first_followup = NA,
  last_followup = NA,
  use_censor_weights = FALSE,
  save_weight_models = FALSE,
  analysis_weights = c("asis", "unweighted", "p99", "weight_limits"),
  weight_limits = c(0, Inf),
  cense = NA,
  pool_cense = c("none", "both", "numerator"),
  cense_d_cov = ~1,
  cense_n_cov = ~1,
  include_followup_time = ~followup_time + I(followup_time^2),
  include_trial_period = ~trial_period + I(trial_period^2),
  eligible_wts_0 = NA,
  eligible_wts_1 = NA,
  where_var = NULL,
  where_case = NA,
  data_dir,
  glm_function = "glm",
  quiet = FALSE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="initiators_+3A_data">data</code></td>
<td>
<p>A <code>data.frame</code> containing all the required variables in the person-time format, i.e., the  &lsquo;long&rsquo; format.</p>
</td></tr>
<tr><td><code id="initiators_+3A_id">id</code></td>
<td>
<p>Name of the variable for identifiers of the individuals.  Default is &lsquo;id&rsquo;.</p>
</td></tr>
<tr><td><code id="initiators_+3A_period">period</code></td>
<td>
<p>Name of the variable for the visit/period.   Default is &lsquo;period&rsquo;.</p>
</td></tr>
<tr><td><code id="initiators_+3A_treatment">treatment</code></td>
<td>
<p>Name of the variable  for the treatment indicator at that visit/period. Default is &lsquo;treatment&rsquo;.</p>
</td></tr>
<tr><td><code id="initiators_+3A_outcome">outcome</code></td>
<td>
<p>Name of the variable for the indicator of the outcome event at that visit/period.  Default is
&lsquo;outcome&rsquo;.</p>
</td></tr>
<tr><td><code id="initiators_+3A_eligible">eligible</code></td>
<td>
<p>Name of the variable for the indicator of eligibility for the target trial at that visit/period.
Default is &lsquo;eligible&rsquo;.</p>
</td></tr>
<tr><td><code id="initiators_+3A_outcome_cov">outcome_cov</code></td>
<td>
<p>A RHS formula with baseline covariates to be adjusted for in the marginal structural model for the
emulated trials. Note that if a time-varying covariate is specified in <code>outcome_cov</code>, only its value at each of the
trial baselines will be included in the expanded data.</p>
</td></tr>
<tr><td><code id="initiators_+3A_estimand_type">estimand_type</code></td>
<td>
<p>Specify the estimand for the causal analyses in the sequence of emulated trials. <code>estimand_type = "ITT"</code> will perform intention-to-treat analyses, where treatment switching after trial baselines are ignored.
<code>estimand_type = "PP"</code> will perform per-protocol analyses, where individuals' follow-ups are artificially censored
and inverse probability of treatment weighting is applied. <code>estimand_type = "As-Treated"</code> will fit a standard
marginal structural model for all possible treatment sequences, where individuals' follow-ups are not artificially
censored  but treatment switching after trial baselines are accounted for by applying inverse probability of
treatment weighting.</p>
</td></tr>
<tr><td><code id="initiators_+3A_model_var">model_var</code></td>
<td>
<p>Treatment variables to be included in the marginal structural model for the emulated trials.
<code>model_var = "assigned_treatment"</code> will create a variable <code>assigned_treatment</code> that is the assigned treatment at
the trial baseline, typically used for ITT and per-protocol analyses. <code>model_var = "dose"</code> will create a variable
<code>dose</code> that is the cumulative number of  treatments received since the trial baseline, typically used in as-treated
analyses.</p>
</td></tr>
<tr><td><code id="initiators_+3A_switch_n_cov">switch_n_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the numerator terms of the inverse
probability of treatment weights. A derived variable named <code>time_on_regime</code> containing the duration of time that
the individual has been on the current treatment/non-treatment is available for use in these models.</p>
</td></tr>
<tr><td><code id="initiators_+3A_switch_d_cov">switch_d_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the denominator terms of the inverse
probability of treatment weights.</p>
</td></tr>
<tr><td><code id="initiators_+3A_first_period">first_period</code></td>
<td>
<p>First time period to be set as trial baseline  to start expanding the data.</p>
</td></tr>
<tr><td><code id="initiators_+3A_last_period">last_period</code></td>
<td>
<p>Last time period to be set as trial baseline  to start expanding the data.</p>
</td></tr>
<tr><td><code id="initiators_+3A_first_followup">first_followup</code></td>
<td>
<p>First follow-up time/visit in the trials to be included in the marginal structural model for
the outcome event.</p>
</td></tr>
<tr><td><code id="initiators_+3A_last_followup">last_followup</code></td>
<td>
<p>Last follow-up time/visit in the trials to be included in the marginal structural model for the
outcome event.</p>
</td></tr>
<tr><td><code id="initiators_+3A_use_censor_weights">use_censor_weights</code></td>
<td>
<p>Require the inverse probability of censoring weights. If <code>use_censor_weights = TRUE</code>, then
the variable name of the censoring indicator needs to be provided in the argument <code>cense</code>.</p>
</td></tr>
<tr><td><code id="initiators_+3A_save_weight_models">save_weight_models</code></td>
<td>
<p>Save model objects for estimating the weights in <code>data_dir</code>.</p>
</td></tr>
<tr><td><code id="initiators_+3A_analysis_weights">analysis_weights</code></td>
<td>
<p>Choose which type of weights to be used for fitting the marginal structural model for the
outcome event.
</p>

<ul>
<li> <p><code>"asis"</code>: use the weights as calculated.
</p>
</li>
<li> <p><code>"p99"</code>: use weights truncated at the 1st and 99th percentiles (based on the distribution of weights
in the entire sample).
</p>
</li>
<li> <p><code>"weight_limits"</code>: use weights truncated at the values specified in <code>weight_limits</code>.
</p>
</li>
<li> <p><code>"unweighted"</code>: set all analysis weights to 1, even if treatment weights or censoring weights were calculated.
</p>
</li></ul>
</td></tr>
<tr><td><code id="initiators_+3A_weight_limits">weight_limits</code></td>
<td>
<p>Lower and upper limits to truncate weights, given as <code>c(lower, upper)</code></p>
</td></tr>
<tr><td><code id="initiators_+3A_cense">cense</code></td>
<td>
<p>Variable name for the censoring indicator. Required if <code>use_censor_weights = TRUE</code>.</p>
</td></tr>
<tr><td><code id="initiators_+3A_pool_cense">pool_cense</code></td>
<td>
<p>Fit pooled or separate censoring models for those treated and those untreated at the immediately
previous visit. Pooling can be specified for the models for the numerator and denominator terms of the inverse
probability of censoring weights. One of <code>"none"</code>, <code>"numerator"</code>, or <code>"both"</code> (default is <code>"none"</code> except when
<code>estimand_type = "ITT"</code> then default is <code>"numerator"</code>).</p>
</td></tr>
<tr><td><code id="initiators_+3A_cense_d_cov">cense_d_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the denominator terms of the inverse
probability of censoring weights.</p>
</td></tr>
<tr><td><code id="initiators_+3A_cense_n_cov">cense_n_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the numerator terms of the inverse
probability of censoring weights.</p>
</td></tr>
<tr><td><code id="initiators_+3A_include_followup_time">include_followup_time</code></td>
<td>
<p>The model to include the follow up time/visit of the trial (<code>followup_time</code>) in the
marginal structural model, specified as a RHS formula.</p>
</td></tr>
<tr><td><code id="initiators_+3A_include_trial_period">include_trial_period</code></td>
<td>
<p>The model to include the trial period (<code>trial_period</code>) in the marginal structural model,
specified as a RHS formula.</p>
</td></tr>
<tr><td><code id="initiators_+3A_eligible_wts_0">eligible_wts_0</code></td>
<td>
<p>See definition for <code>eligible_wts_1</code></p>
</td></tr>
<tr><td><code id="initiators_+3A_eligible_wts_1">eligible_wts_1</code></td>
<td>
<p>Exclude some observations when fitting the models for the inverse probability of treatment
weights. For example, if it is assumed that an individual will stay on treatment for at least 2 visits, the first 2
visits  after treatment initiation by definition have a probability of staying on the treatment of 1.0 and should
thus be excluded from the weight models for those who are on treatment at the immediately previous visit. Users can
define a variable that indicates that these 2 observations are ineligible for the weight model for those who are on
treatment at the immediately previous visit and add the variable name in the argument <code>eligible_wts_1</code>. Similar
definitions are applied to <code>eligible_wts_0</code> for excluding observations when fitting the models for the inverse
probability of treatment weights for those who are not on treatment at the immediately previous visit.</p>
</td></tr>
<tr><td><code id="initiators_+3A_where_var">where_var</code></td>
<td>
<p>Specify the variable names that will be used to define subgroup conditions when fitting the marginal
structural model for a subgroup of individuals. Need to specify jointly with the argument <code>where_case</code>.</p>
</td></tr>
<tr><td><code id="initiators_+3A_where_case">where_case</code></td>
<td>
<p>Define conditions using variables specified in <code>where_var</code> when fitting a marginal structural model
for a subgroup of the individuals. For example, if <code>where_var= "age"</code>, <code>where_case = "age &gt;= 30"</code> will only fit the
marginal structural model to the subgroup of individuals. who are 30 years old or above.</p>
</td></tr>
<tr><td><code id="initiators_+3A_data_dir">data_dir</code></td>
<td>
<p>Directory to save model objects in.</p>
</td></tr>
<tr><td><code id="initiators_+3A_glm_function">glm_function</code></td>
<td>
<p>Specify which glm function to use for the marginal structural model from the <code>stats</code> or <code>parglm</code>
packages. The default function is the <code>glm</code> function in the <code>stats</code> package. Users can also specify <code>glm_function = "parglm"</code> such that the <code>parglm</code> function in the <code>parglm</code> package can be used for fitting generalized linear models
in parallel. The default control setting for  <code>parglm</code> is <code>nthreads = 4</code> and <code>method = "FAST"</code>, where four cores
and Fisher information are used for faster computation. Users can change the default control setting by passing the
arguments <code>nthreads</code> and <code>method</code> in the <code>parglm.control</code> function of the <code>parglm</code> package, or alternatively, by
passing a <code>control</code> argument with a list produced by <code>parglm.control(nthreads = , method = )</code>.</p>
</td></tr>
<tr><td><code id="initiators_+3A_quiet">quiet</code></td>
<td>
<p>Suppress the printing of progress messages and summaries of the fitted models.</p>
</td></tr>
<tr><td><code id="initiators_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to <code>glm_function</code>. This may be used to specify initial values of parameters or
arguments to <code>control</code>. See <a href="stats.html#topic+glm">stats::glm</a>, <a href="parglm.html#topic+parglm">parglm::parglm</a> and <code><a href="parglm.html#topic+parglm.control">parglm::parglm.control()</a></code> for more information.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>An all-in-one analysis using a sequence of emulated target trials. This provides a simplified interface to the main
functions <code><a href="#topic+data_preparation">data_preparation()</a></code> and <code><a href="#topic+trial_msm">trial_msm()</a></code>.
</p>


<h3>Value</h3>

<p>Returns the result of <code><a href="#topic+trial_msm">trial_msm()</a></code> from the expanded data. An object of class <code>TE_msm</code> containing
</p>

<dl>
<dt>model</dt><dd><p>a <code>glm</code> object</p>
</dd>
<dt>robust</dt><dd><p>a list containing a summary table of estimated regression coefficients and the robust covariance
matrix</p>
</dd>
</dl>


<hr>
<h2 id='internal-methods'>Internal Methods</h2><span id='topic+internal-methods'></span><span id='topic+set_data+2Ctrial_sequence+2Cdata.frame-method'></span><span id='topic+set_expansion_options+2Ctrial_sequence-method'></span><span id='topic+expand_trials+2Ctrial_sequence-method'></span>

<h3>Description</h3>

<p>Various S4 methods which are not directly for use by users.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S4 method for signature 'trial_sequence,data.frame'
set_data(
  object,
  data,
  censor_at_switch,
  id = "id",
  period = "period",
  treatment = "treatment",
  outcome = "outcome",
  eligible = "eligible"
)

## S4 method for signature 'trial_sequence'
set_expansion_options(
  object,
  output,
  chunk_size = 0,
  first_period = 0,
  last_period = Inf,
  censor_at_switch
)

## S4 method for signature 'trial_sequence'
expand_trials(object)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="internal-methods_+3A_object">object</code></td>
<td>
<p>A <a href="#topic+trial_sequence-class">trial_sequence</a> object</p>
</td></tr>
<tr><td><code id="internal-methods_+3A_data">data</code></td>
<td>
<p>A <code>data.frame</code> containing all the required variables in the person-time format, i.e., the
&lt;U+2018&gt;long&lt;U+2019&gt; format.</p>
</td></tr>
<tr><td><code id="internal-methods_+3A_id">id</code></td>
<td>
<p>Name of the variable for identifiers of the individuals. Default is &lt;U+2018&gt;id&lt;U+2019&gt;.</p>
</td></tr>
<tr><td><code id="internal-methods_+3A_period">period</code></td>
<td>
<p>Name of the variable for the visit/period. Default is &lt;U+2018&gt;period&lt;U+2019&gt;.</p>
</td></tr>
<tr><td><code id="internal-methods_+3A_treatment">treatment</code></td>
<td>
<p>Name of the variable for the treatment indicator at that visit/period. Default is
&lt;U+2018&gt;treatment&lt;U+2019&gt;.</p>
</td></tr>
<tr><td><code id="internal-methods_+3A_outcome">outcome</code></td>
<td>
<p>Name of the variable for the indicator of the outcome event at that visit/period. Default is
&lt;U+2018&gt;outcome&lt;U+2019&gt;.</p>
</td></tr>
<tr><td><code id="internal-methods_+3A_eligible">eligible</code></td>
<td>
<p>Name of the variable for the indicator of eligibility for the target trial at that visit/period.
Default is &lt;U+2018&gt;eligible&lt;U+2019&gt;.</p>
</td></tr>
</table>

<hr>
<h2 id='ipw_data'>IPW Data Accessor and Setter</h2><span id='topic+ipw_data'></span><span id='topic+ipw_data+3C-'></span><span id='topic+ipw_data+2Ctrial_sequence-method'></span><span id='topic+ipw_data+3C-+2Ctrial_sequence-method'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ipw_data(object)

ipw_data(object) &lt;- value

## S4 method for signature 'trial_sequence'
ipw_data(object)

## S4 replacement method for signature 'trial_sequence'
ipw_data(object) &lt;- value
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ipw_data_+3A_object">object</code></td>
<td>
<p><code>trial_sequence</code> object</p>
</td></tr>
<tr><td><code id="ipw_data_+3A_value">value</code></td>
<td>
<p><code>data.table</code> to replace and update in <code style="white-space: pre;">&#8288;@data&#8288;</code></p>
</td></tr>
</table>


<h3>Details</h3>

<p>Generic function to access and update the data used for inverse probability weighting.
</p>
<p>The setter method <code>ipw_data(object) &lt;- value</code> does not perform the same checks and manipulations
as <code><a href="#topic+set_data">set_data()</a></code>. To completely replace the data please use <code><a href="#topic+set_data">set_data()</a></code>. This <code style="white-space: pre;">&#8288;ipw_data&lt;-&#8288;</code> method allows
small changes such as adding a new column.
</p>


<h3>Value</h3>

<p>The data from the <code style="white-space: pre;">&#8288;@data&#8288;</code> slot of <code>object</code> used for inverse probability weighting.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ts &lt;- trial_sequence("ITT")
ts &lt;- set_data(ts, data_censored)
ipw_data(ts)
data.table::set(ipw_data(ts), j = "dummy", value = TRUE)

# or with the setter method:
new_data &lt;- ipw_data(ts)
new_data$x2sq &lt;- new_data$x2^2
ipw_data(ts) &lt;- new_data
</code></pre>

<hr>
<h2 id='load_expanded_data'>Method to read, subset and sample expanded data</h2><span id='topic+load_expanded_data'></span><span id='topic+load_expanded_data+2Ctrial_sequence-method'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>load_expanded_data(
  object,
  p_control = NULL,
  period = NULL,
  subset_condition = NULL,
  seed = NULL
)

## S4 method for signature 'trial_sequence'
load_expanded_data(
  object,
  p_control = NULL,
  period = NULL,
  subset_condition = NULL,
  seed = NULL
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="load_expanded_data_+3A_object">object</code></td>
<td>
<p>An object of class <a href="#topic+trial_sequence-class">trial_sequence</a>.</p>
</td></tr>
<tr><td><code id="load_expanded_data_+3A_p_control">p_control</code></td>
<td>
<p>Probability of selecting a control, <code>NULL</code> for no sampling (default).</p>
</td></tr>
<tr><td><code id="load_expanded_data_+3A_period">period</code></td>
<td>
<p>An integerish vector of non-zero length to select trial period(s) or <code>NULL</code> (default) to
select all trial periods.</p>
</td></tr>
<tr><td><code id="load_expanded_data_+3A_subset_condition">subset_condition</code></td>
<td>
<p>A string or <code>NULL</code> (default). <code>subset_condition</code> will be translated to a call
(in case the expanded data is saved as a data.table or in the csv format) or to a SQL-query
(in case the expanded data is saved as a duckdb file).
</p>
<p>The operators <code style="white-space: pre;">&#8288;"==", "!=", "&gt;", "&gt;=", "&lt;", "&lt;=", %in%", "&amp;", "|"&#8288;</code> are supported.
Numeric vectors can be written as <code>c(1, 2, 3)</code> or <code>1:3</code>. Variables are not supported.
</p>
<p><em>Note</em>: Make sure numeric vectors written as <code>1:3</code> are surrounded by spaces, e.g. <code>a %in% c( 1:4 , 6:9 )</code>,
otherwise the code will fail.</p>
</td></tr>
<tr><td><code id="load_expanded_data_+3A_seed">seed</code></td>
<td>
<p>An integer seed or <code>NULL</code> (default).
</p>
<p><em>Note</em>: The same seed will return a different result depending on the class of the <a href="#topic+te_datastore-class">te_datastore</a>
object contained in the <a href="#topic+trial_sequence-class">trial_sequence</a> object.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This method is used on <a href="#topic+trial_sequence-class">trial_sequence</a> objects to read, subset and sample expanded data.
</p>


<h3>Value</h3>

<p>An updated <a href="#topic+trial_sequence-class">trial_sequence</a> object, the data is stored in slot <code style="white-space: pre;">&#8288;@outcome_data&#8288;</code>
as a <a href="#topic+te_outcome_data-class">te_outcome_data</a> object.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># create a trial_sequence-class object
trial_itt_dir &lt;- file.path(tempdir(), "trial_itt")
dir.create(trial_itt_dir)
trial_itt &lt;- trial_sequence(estimand = "ITT") |&gt;
  set_data(data = data_censored) |&gt;
  set_outcome_model(adjustment_terms = ~ x1 + x2)

trial_itt_csv &lt;- set_expansion_options(
  trial_itt,
  output = save_to_csv(file.path(trial_itt_dir, "trial_csvs")),
  chunk_size = 500
) |&gt;
  expand_trials()

# load_expanded_data default behaviour returns all trial_periods and doesn't sample
load_expanded_data(trial_itt_csv)

# load_expanded_data can subset the data before sampling
load_expanded_data(
  trial_itt_csv,
  p_control = 0.2,
  period = 1:20,
  subset_condition = "followup_time %in% 1:20 &amp; x2 &lt; 1",
)

# delete after use
unlink(trial_itt_dir, recursive = TRUE)
</code></pre>

<hr>
<h2 id='outcome_data'>Outcome Data Accessor and Setter</h2><span id='topic+outcome_data'></span><span id='topic+outcome_data+3C-'></span><span id='topic+outcome_data+2Ctrial_sequence-method'></span><span id='topic+outcome_data+3C-+2Ctrial_sequence-method'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>outcome_data(object)

outcome_data(object) &lt;- value

## S4 method for signature 'trial_sequence'
outcome_data(object)

## S4 replacement method for signature 'trial_sequence'
outcome_data(object) &lt;- value
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="outcome_data_+3A_object">object</code></td>
<td>
<p><code>trial_sequence</code> object</p>
</td></tr>
<tr><td><code id="outcome_data_+3A_value">value</code></td>
<td>
<p><code>data.table</code> to replace and update in <code style="white-space: pre;">&#8288;@outcome_data&#8288;</code></p>
</td></tr>
</table>


<h3>Details</h3>

<p>Generic function to outcome data
</p>


<h3>Value</h3>

<p>The <code>object</code> with updated outcome data
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ts &lt;- trial_sequence("ITT")
new_data &lt;- data.table::data.table(vignette_switch_data[1:200, ])
new_data$weight &lt;- 1
outcome_data(ts) &lt;- new_data
</code></pre>

<hr>
<h2 id='parsnip_model'>Fit outcome models using <code>parsnip</code> models</h2><span id='topic+parsnip_model'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>parsnip_model(model_spec, save_path)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="parsnip_model_+3A_model_spec">model_spec</code></td>
<td>
<p>A <code>parsnip</code> model definition with <code>mode = "classification"</code>.</p>
</td></tr>
<tr><td><code id="parsnip_model_+3A_save_path">save_path</code></td>
<td>
<p>Directory to save models. Set to <code>NA</code> if models should not be saved.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Specify that the models should be fit using a classification model specified with the <code>parsnip</code> package.
</p>
<p>Warning: This functionality is experimental and not recommended for use in analyses.
<code class="reqn">sqrt{n}</code>-consistency estimation and valid inference of the parameters in marginal structural models for
emulated trials generally require that the weights for treatment switching and censoring be estimated at parametric
rates, which is generally not possible when using data-adaptive estimation of high-dimensional regressions.
Therefore, we only recommend using <code><a href="#topic+stats_glm_logit">stats_glm_logit()</a></code>.
</p>


<h3>Value</h3>

<p>An object of class <code>te_parsnip_model</code> inheriting from <a href="#topic+te_model_fitter-class">te_model_fitter</a> which is used for
dispatching methods for the fitting models.
</p>


<h3>See Also</h3>

<p>Other model_fitter: 
<code><a href="#topic+stats_glm_logit">stats_glm_logit</a>()</code>,
<code><a href="#topic+te_model_fitter-class">te_model_fitter-class</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
if (
  requireNamespace("parsnip", quietly = TRUE) &amp;&amp;
    requireNamespace("rpart", quietly = TRUE)
) {
  # Use a decision tree model fitted with the rpart package
  parsnip_model(
    model_spec = parsnip::decision_tree(tree_depth = 30) |&gt;
      set_mode("classification") |&gt;
      set_engine("rpart"),
    save_path = tempdir()
  )
}

## End(Not run)

</code></pre>

<hr>
<h2 id='predict_marginal'>Predict marginal cumulative incidences with confidence intervals for a target trial population</h2><span id='topic+predict_marginal'></span><span id='topic+predict'></span><span id='topic+predict+2Ctrial_sequence_ITT-method'></span><span id='topic+predict+2Ctrial_sequence_PP-method'></span><span id='topic+predict.TE_msm'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#stable"><img src="../help/figures/lifecycle-stable.svg" alt='[Stable]' /></a>
This function predicts the marginal cumulative incidences when a target trial population receives either the
treatment or non-treatment at baseline (for an intention-to-treat analysis) or either sustained treatment or
sustained non-treatment (for a per-protocol analysis). The difference between these cumulative incidences is the
estimated causal effect of treatment. Currently, the <code>predict</code> function only provides marginal intention-to-treat and
per-protocol effects, therefore it is only valid when <code>estimand_type = "ITT"</code> or <code>estimand_type = "PP"</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>predict(object, ...)

## S4 method for signature 'trial_sequence_ITT'
predict(
  object,
  newdata,
  predict_times,
  conf_int = TRUE,
  samples = 100,
  type = c("cum_inc", "survival")
)

## S4 method for signature 'trial_sequence_PP'
predict(
  object,
  newdata,
  predict_times,
  conf_int = TRUE,
  samples = 100,
  type = c("cum_inc", "survival")
)

## S3 method for class 'TE_msm'
predict(
  object,
  newdata,
  predict_times,
  conf_int = TRUE,
  samples = 100,
  type = c("cum_inc", "survival"),
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="predict_marginal_+3A_object">object</code></td>
<td>
<p>Object from <code><a href="#topic+trial_msm">trial_msm()</a></code> or <code><a href="#topic+initiators">initiators()</a></code> or <a href="#topic+trial_sequence">trial_sequence</a>.</p>
</td></tr>
<tr><td><code id="predict_marginal_+3A_...">...</code></td>
<td>
<p>Further arguments passed to or from other methods.</p>
</td></tr>
<tr><td><code id="predict_marginal_+3A_newdata">newdata</code></td>
<td>
<p>Baseline trial data that characterise the target trial population that marginal cumulative incidences
or survival probabilities are predicted for.  <code>newdata</code> must have the same columns and formats of variables as in
the fitted marginal structural model specified in <code><a href="#topic+trial_msm">trial_msm()</a></code> or <code><a href="#topic+initiators">initiators()</a></code>. If <code>newdata</code> contains rows with
<code>followup_time &gt; 0</code> these will be removed.</p>
</td></tr>
<tr><td><code id="predict_marginal_+3A_predict_times">predict_times</code></td>
<td>
<p>Specify the follow-up visits/times where the marginal cumulative incidences or survival
probabilities are predicted.</p>
</td></tr>
<tr><td><code id="predict_marginal_+3A_conf_int">conf_int</code></td>
<td>
<p>Construct the point-wise 95-percent confidence intervals of cumulative incidences for the target
trial population under treatment and non-treatment and their differences by simulating the parameters in the
marginal structural model from a multivariate normal distribution with the mean equal to the marginal structural
model parameter estimates and the variance equal to the estimated robust covariance matrix.</p>
</td></tr>
<tr><td><code id="predict_marginal_+3A_samples">samples</code></td>
<td>
<p>Number of samples used to construct the simulation-based confidence intervals.</p>
</td></tr>
<tr><td><code id="predict_marginal_+3A_type">type</code></td>
<td>
<p>Specify cumulative incidences or survival probabilities to be predicted. Either cumulative incidence
(<code>"cum_inc"</code>) or survival probability (<code>"survival"</code>).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list of three data frames containing the cumulative incidences for each of the assigned treatment options
(treatment and non-treatment) and the difference between them.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Prediction for initiators() or trial_msm() objects -----

# If necessary set the number of `data.table` threads
data.table::setDTthreads(2)

data("te_model_ex")
predicted_ci &lt;- predict(te_model_ex, predict_times = 0:30, samples = 10)

# Plot the cumulative incidence curves under treatment and non-treatment
plot(predicted_ci[[1]]$followup_time, predicted_ci[[1]]$cum_inc,
  type = "l",
  xlab = "Follow-up Time", ylab = "Cumulative Incidence",
  ylim = c(0, 0.7)
)
lines(predicted_ci[[1]]$followup_time, predicted_ci[[1]]$`2.5%`, lty = 2)
lines(predicted_ci[[1]]$followup_time, predicted_ci[[1]]$`97.5%`, lty = 2)

lines(predicted_ci[[2]]$followup_time, predicted_ci[[2]]$cum_inc, type = "l", col = 2)
lines(predicted_ci[[2]]$followup_time, predicted_ci[[2]]$`2.5%`, lty = 2, col = 2)
lines(predicted_ci[[2]]$followup_time, predicted_ci[[2]]$`97.5%`, lty = 2, col = 2)
legend("topleft", title = "Assigned Treatment", legend = c("0", "1"), col = 1:2, lty = 1)

# Plot the difference in cumulative incidence over follow up
plot(predicted_ci[[3]]$followup_time, predicted_ci[[3]]$cum_inc_diff,
  type = "l",
  xlab = "Follow-up Time", ylab = "Difference in Cumulative Incidence",
  ylim = c(0.0, 0.5)
)
lines(predicted_ci[[3]]$followup_time, predicted_ci[[3]]$`2.5%`, lty = 2)
lines(predicted_ci[[3]]$followup_time, predicted_ci[[3]]$`97.5%`, lty = 2)

</code></pre>

<hr>
<h2 id='print.TE_weight_summary'>Print a weight summary object</h2><span id='topic+print.TE_weight_summary'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#stable"><img src="../help/figures/lifecycle-stable.svg" alt='[Stable]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'TE_weight_summary'
print(x, full = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="print.TE_weight_summary_+3A_x">x</code></td>
<td>
<p>print TE_weight_summary object.</p>
</td></tr>
<tr><td><code id="print.TE_weight_summary_+3A_full">full</code></td>
<td>
<p>Print full or short summary.</p>
</td></tr>
<tr><td><code id="print.TE_weight_summary_+3A_...">...</code></td>
<td>
<p>Arguments passed to <a href="base.html#topic+print.data.frame">print.data.frame</a>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>No return value, only for printing.
</p>

<hr>
<h2 id='read_expanded_data'>Method to read expanded data</h2><span id='topic+read_expanded_data'></span><span id='topic+read_expanded_data+2Cte_datastore_datatable-method'></span>

<h3>Description</h3>

<p>This method is used on <a href="#topic+te_datastore-class">te_datastore</a> objects to read selected data and return one <code>data.table</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>read_expanded_data(object, period = NULL, subset_condition = NULL)

## S4 method for signature 'te_datastore_datatable'
read_expanded_data(object, period = NULL, subset_condition = NULL)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="read_expanded_data_+3A_object">object</code></td>
<td>
<p>An object of class <a href="#topic+te_datastore-class">te_datastore</a>.</p>
</td></tr>
<tr><td><code id="read_expanded_data_+3A_period">period</code></td>
<td>
<p>An integerish vector of non-zero length to select trial period(s) or <code>NULL</code> (default) to
select all files.</p>
</td></tr>
<tr><td><code id="read_expanded_data_+3A_subset_condition">subset_condition</code></td>
<td>
<p>A string of length 1 or <code>NULL</code> (default).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>data.frame</code> of class <code>data.table</code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># create a te_datastore_csv object and save some data
temp_dir &lt;- tempfile("csv_dir_")
dir.create(temp_dir)
datastore &lt;- save_to_csv(temp_dir)
data(vignette_switch_data)
expanded_csv_data &lt;- save_expanded_data(datastore, vignette_switch_data[1:200, ])

# read expanded data
read_expanded_data(expanded_csv_data)

# delete after use
unlink(temp_dir, recursive = TRUE)
</code></pre>

<hr>
<h2 id='robust_calculation'>Robust Variance Calculation</h2><span id='topic+robust_calculation'></span>

<h3>Description</h3>

<p>This function performs the calculation of robust standard errors based on
variances estimated using <code><a href="sandwich.html#topic+vcovCL">sandwich::vcovCL</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>robust_calculation(model, data_id)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="robust_calculation_+3A_model">model</code></td>
<td>
<p>The logistic regression model object.</p>
</td></tr>
<tr><td><code id="robust_calculation_+3A_data_id">data_id</code></td>
<td>
<p>Values of id column of the data (ie <code>data[, id]</code>) to identify clusters.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list with elements <code>summary</code>, a table with the model summary using the
robust variance estimates, and <code>matrix</code>, the <code>sandwich</code> covariance matrix.
</p>

<hr>
<h2 id='sample_expanded_data'>Internal method to sample expanded data</h2><span id='topic+sample_expanded_data'></span><span id='topic+sample_expanded_data+2Cte_datastore-method'></span>

<h3>Description</h3>

<p>Internal method to sample expanded data
</p>


<h3>Usage</h3>

<pre><code class='language-R'>sample_expanded_data(
  object,
  p_control,
  period = NULL,
  subset_condition = NULL,
  seed
)

## S4 method for signature 'te_datastore'
sample_expanded_data(
  object,
  p_control,
  period = NULL,
  subset_condition = NULL,
  seed
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="sample_expanded_data_+3A_object">object</code></td>
<td>
<p>An object of class <a href="#topic+te_datastore-class">te_datastore</a>.</p>
</td></tr>
<tr><td><code id="sample_expanded_data_+3A_p_control">p_control</code></td>
<td>
<p>Probability of selecting a control.</p>
</td></tr>
<tr><td><code id="sample_expanded_data_+3A_period">period</code></td>
<td>
<p>An integerish vector of non-zero length to select trial period(s) or <code>NULL</code> (default) to
select all trial periods.</p>
</td></tr>
<tr><td><code id="sample_expanded_data_+3A_subset_condition">subset_condition</code></td>
<td>
<p>A string or <code>NULL</code>.</p>
</td></tr>
<tr><td><code id="sample_expanded_data_+3A_seed">seed</code></td>
<td>
<p>An integer seed or <code>NULL</code> (default).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>data.frame</code> of class <code>data.table</code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Data object normally created by [expand_trials]
datastore &lt;- new("te_datastore_datatable", data = te_data_ex$data, N = 50139L)

sample_expanded_data(datastore, period = 260:275, p_control = 0.2, seed = 123)
</code></pre>

<hr>
<h2 id='save_expanded_data'>Method to save expanded data</h2><span id='topic+save_expanded_data'></span><span id='topic+save_expanded_data+2Cte_datastore_datatable-method'></span>

<h3>Description</h3>

<p>This method is used internally by <a href="#topic+expand_trials">expand_trials</a> to save the data to the &quot;datastore&quot; defined in
<a href="#topic+set_expansion_options">set_expansion_options</a>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>save_expanded_data(object, data)

## S4 method for signature 'te_datastore_datatable'
save_expanded_data(object, data)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="save_expanded_data_+3A_object">object</code></td>
<td>
<p>An object of class <a href="#topic+te_datastore-class">te_datastore</a> or a child class.</p>
</td></tr>
<tr><td><code id="save_expanded_data_+3A_data">data</code></td>
<td>
<p>A data frame containing the expanded trial data. The columns <code>trial_period</code> and <code>id</code> are present, which
may be used in methods to save the data in an optimal way, such as with indexes, keys or separate files.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An updated <code>object</code> with the data stored. Notably <code>object@N</code> should be increased
</p>


<h3>Examples</h3>

<pre><code class='language-R'>temp_dir &lt;- tempfile("csv_dir_")
dir.create(temp_dir)
datastore &lt;- save_to_csv(temp_dir)
data(vignette_switch_data)
save_expanded_data(datastore, vignette_switch_data[1:200, ])

# delete after use
unlink(temp_dir, recursive = TRUE)
</code></pre>

<hr>
<h2 id='save_to_csv'>Save expanded data as CSV</h2><span id='topic+save_to_csv'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>save_to_csv(path)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="save_to_csv_+3A_path">path</code></td>
<td>
<p>Directory to save CSV files in. Must be empty.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <a href="#topic+te_datastore_csv-class">te_datastore_csv</a> object.
</p>


<h3>See Also</h3>

<p>Other save_to: 
<code><a href="#topic+save_to_datatable">save_to_datatable</a>()</code>,
<code><a href="#topic+save_to_duckdb">save_to_duckdb</a>()</code>,
<code><a href="#topic+set_expansion_options">set_expansion_options</a>()</code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>csv_dir &lt;- file.path(tempdir(), "expanded_trials_csv")
dir.create(csv_dir)
csv_datastore &lt;- save_to_csv(path = csv_dir)

trial_to_expand &lt;- trial_sequence("ITT") |&gt;
  set_data(data = data_censored) |&gt;
  set_expansion_options(output = csv_datastore, chunk_size = 500)

# Delete directory after use
unlink(csv_dir)

</code></pre>

<hr>
<h2 id='save_to_datatable'>Save expanded data as a <code>data.table</code></h2><span id='topic+save_to_datatable'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>save_to_datatable()
</code></pre>


<h3>See Also</h3>

<p>Other save_to: 
<code><a href="#topic+save_to_csv">save_to_csv</a>()</code>,
<code><a href="#topic+save_to_duckdb">save_to_duckdb</a>()</code>,
<code><a href="#topic+set_expansion_options">set_expansion_options</a>()</code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>trial_to_expand &lt;- trial_sequence("ITT") |&gt;
  set_data(data = data_censored) |&gt;
  set_expansion_options(output = save_to_datatable(), chunk_size = 500)
</code></pre>

<hr>
<h2 id='save_to_duckdb'>Save expanded data to <code>DuckDB</code></h2><span id='topic+save_to_duckdb'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>save_to_duckdb(path)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="save_to_duckdb_+3A_path">path</code></td>
<td>
<p>Directory to save <code>DuckDB</code> database file in.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <a href="#topic+te_datastore_duckdb-class">te_datastore_duckdb</a> object.
</p>


<h3>See Also</h3>

<p>Other save_to: 
<code><a href="#topic+save_to_csv">save_to_csv</a>()</code>,
<code><a href="#topic+save_to_datatable">save_to_datatable</a>()</code>,
<code><a href="#topic+set_expansion_options">set_expansion_options</a>()</code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>if (require(duckdb)) {
  duckdb_dir &lt;- file.path(tempdir(), "expanded_trials_duckdb")

  trial_to_expand &lt;- trial_sequence("ITT") |&gt;
    set_data(data = data_censored) |&gt;
    set_expansion_options(output = save_to_duckdb(path = duckdb_dir), chunk_size = 500)

  # Delete directory after use
  unlink(duckdb_dir)
}

</code></pre>

<hr>
<h2 id='select_data_cols'>Select Data Columns</h2><span id='topic+select_data_cols'></span>

<h3>Description</h3>

<p>Select the required columns from the data and rename
</p>


<h3>Usage</h3>

<pre><code class='language-R'>select_data_cols(data, args)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="select_data_cols_+3A_data">data</code></td>
<td>
<p>A <code>data.frame</code> containing all the required columns</p>
</td></tr>
<tr><td><code id="select_data_cols_+3A_args">args</code></td>
<td>
<p>List of arguments from <code>data_preparation</code></p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data.table with the required columns
</p>

<hr>
<h2 id='set_censor_weight_model'>Set censoring weight model</h2><span id='topic+set_censor_weight_model'></span><span id='topic+set_censor_weight_model+2Ctrial_sequence-method'></span><span id='topic+set_censor_weight_model+2Ctrial_sequence_PP-method'></span><span id='topic+set_censor_weight_model+2Ctrial_sequence_ITT-method'></span><span id='topic+set_censor_weight_model+2Ctrial_sequence_AT-method'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>set_censor_weight_model(
  object,
  censor_event,
  numerator,
  denominator,
  pool_models = NULL,
  model_fitter
)

## S4 method for signature 'trial_sequence'
set_censor_weight_model(
  object,
  censor_event,
  numerator,
  denominator,
  pool_models = c("none", "both", "numerator"),
  model_fitter = stats_glm_logit()
)

## S4 method for signature 'trial_sequence_PP'
set_censor_weight_model(
  object,
  censor_event,
  numerator,
  denominator,
  pool_models = "none",
  model_fitter = stats_glm_logit()
)

## S4 method for signature 'trial_sequence_ITT'
set_censor_weight_model(
  object,
  censor_event,
  numerator,
  denominator,
  pool_models = "numerator",
  model_fitter = stats_glm_logit()
)

## S4 method for signature 'trial_sequence_AT'
set_censor_weight_model(
  object,
  censor_event,
  numerator,
  denominator,
  pool_models = "none",
  model_fitter = stats_glm_logit()
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="set_censor_weight_model_+3A_object">object</code></td>
<td>
<p>trial_sequence.</p>
</td></tr>
<tr><td><code id="set_censor_weight_model_+3A_censor_event">censor_event</code></td>
<td>
<p>string. Name of column containing censoring indicator.</p>
</td></tr>
<tr><td><code id="set_censor_weight_model_+3A_numerator">numerator</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the numerator terms of the inverse
probability of censoring weights.</p>
</td></tr>
<tr><td><code id="set_censor_weight_model_+3A_denominator">denominator</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the denominator terms of the inverse
probability of censoring weights.</p>
</td></tr>
<tr><td><code id="set_censor_weight_model_+3A_pool_models">pool_models</code></td>
<td>
<p>Fit pooled or separate censoring models for those treated and those untreated at the immediately
previous visit. Pooling can be specified for the models for the numerator and denominator terms of the inverse
probability of censoring weights. One of &quot;none&quot;, &quot;numerator&quot;, or &quot;both&quot; (default is &quot;none&quot; except when estimand =
&quot;ITT&quot; then default is &quot;numerator&quot;).</p>
</td></tr>
<tr><td><code id="set_censor_weight_model_+3A_model_fitter">model_fitter</code></td>
<td>
<p>An object of class  <code>te_model_fitter</code> which determines the method used for fitting the weight
models. For logistic regression use <code><a href="#topic+stats_glm_logit">stats_glm_logit()</a></code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p><code>object</code> is returned with <code style="white-space: pre;">&#8288;@censor_weights&#8288;</code> set
</p>


<h3>Examples</h3>

<pre><code class='language-R'>trial_sequence("ITT") |&gt;
  set_data(data = data_censored) |&gt;
  set_censor_weight_model(
    censor_event = "censored",
    numerator = ~ age_s + x1 + x3,
    denominator = ~ x3 + x4,
    pool_models = "both",
    model_fitter = stats_glm_logit(save_path = tempdir())
  )
</code></pre>

<hr>
<h2 id='set_data'>Set the trial data</h2><span id='topic+set_data'></span><span id='topic+set_data+2Ctrial_sequence_ITT+2Cdata.frame-method'></span><span id='topic+set_data+2Ctrial_sequence_AT+2Cdata.frame-method'></span><span id='topic+set_data+2Ctrial_sequence_PP+2Cdata.frame-method'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>set_data(object, data, ...)

## S4 method for signature 'trial_sequence_ITT,data.frame'
set_data(
  object,
  data,
  id = "id",
  period = "period",
  treatment = "treatment",
  outcome = "outcome",
  eligible = "eligible"
)

## S4 method for signature 'trial_sequence_AT,data.frame'
set_data(
  object,
  data,
  id = "id",
  period = "period",
  treatment = "treatment",
  outcome = "outcome",
  eligible = "eligible"
)

## S4 method for signature 'trial_sequence_PP,data.frame'
set_data(
  object,
  data,
  id = "id",
  period = "period",
  treatment = "treatment",
  outcome = "outcome",
  eligible = "eligible"
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="set_data_+3A_object">object</code></td>
<td>
<p>A <a href="#topic+trial_sequence-class">trial_sequence</a> object</p>
</td></tr>
<tr><td><code id="set_data_+3A_data">data</code></td>
<td>
<p>A <code>data.frame</code> containing all the required variables in the person-time format, i.e., the
&lt;U+2018&gt;long&lt;U+2019&gt; format.</p>
</td></tr>
<tr><td><code id="set_data_+3A_...">...</code></td>
<td>
<p>Other arguments used by methods internally.</p>
</td></tr>
<tr><td><code id="set_data_+3A_id">id</code></td>
<td>
<p>Name of the variable for identifiers of the individuals. Default is &lt;U+2018&gt;id&lt;U+2019&gt;.</p>
</td></tr>
<tr><td><code id="set_data_+3A_period">period</code></td>
<td>
<p>Name of the variable for the visit/period. Default is &lt;U+2018&gt;period&lt;U+2019&gt;.</p>
</td></tr>
<tr><td><code id="set_data_+3A_treatment">treatment</code></td>
<td>
<p>Name of the variable for the treatment indicator at that visit/period. Default is
&lt;U+2018&gt;treatment&lt;U+2019&gt;.</p>
</td></tr>
<tr><td><code id="set_data_+3A_outcome">outcome</code></td>
<td>
<p>Name of the variable for the indicator of the outcome event at that visit/period. Default is
&lt;U+2018&gt;outcome&lt;U+2019&gt;.</p>
</td></tr>
<tr><td><code id="set_data_+3A_eligible">eligible</code></td>
<td>
<p>Name of the variable for the indicator of eligibility for the target trial at that visit/period.
Default is &lt;U+2018&gt;eligible&lt;U+2019&gt;.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An updated <a href="#topic+trial_sequence-class">trial_sequence</a> object with data
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(trial_example)
trial_sequence("ITT") |&gt;
  set_data(
    data = trial_example,
    id = "id",
    period = "period",
    eligible = "eligible",
    treatment = "treatment"
  )

</code></pre>

<hr>
<h2 id='set_expansion_options'>Set expansion options</h2><span id='topic+set_expansion_options'></span><span id='topic+set_expansion_options+2Ctrial_sequence_ITT-method'></span><span id='topic+set_expansion_options+2Ctrial_sequence_PP-method'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>set_expansion_options(object, ...)

## S4 method for signature 'trial_sequence_ITT'
set_expansion_options(
  object,
  output,
  chunk_size,
  first_period = 0,
  last_period = Inf
)

## S4 method for signature 'trial_sequence_PP'
set_expansion_options(
  object,
  output,
  chunk_size,
  first_period = 0,
  last_period = Inf
)

## S4 method for signature 'trial_sequence_ITT'
set_expansion_options(
  object,
  output,
  chunk_size,
  first_period = 0,
  last_period = Inf
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="set_expansion_options_+3A_object">object</code></td>
<td>
<p>A <a href="#topic+trial_sequence">trial_sequence</a> object</p>
</td></tr>
<tr><td><code id="set_expansion_options_+3A_...">...</code></td>
<td>
<p>Arguments used in methods</p>
</td></tr>
<tr><td><code id="set_expansion_options_+3A_output">output</code></td>
<td>
<p>A <a href="#topic+te_datastore-class">te_datastore</a> object as created by a <code style="white-space: pre;">&#8288;save_to_*&#8288;</code> function.</p>
</td></tr>
<tr><td><code id="set_expansion_options_+3A_chunk_size">chunk_size</code></td>
<td>
<p>An integer specifying the number of patients to include in each expansion iteration</p>
</td></tr>
<tr><td><code id="set_expansion_options_+3A_first_period">first_period</code></td>
<td>
<p>An integer specifying the first period to include in the expansion</p>
</td></tr>
<tr><td><code id="set_expansion_options_+3A_last_period">last_period</code></td>
<td>
<p>An integer specifying the last period to include in the expansion</p>
</td></tr>
</table>


<h3>Value</h3>

<p><code>object</code> is returned with <code style="white-space: pre;">&#8288;@expansion&#8288;</code> set
</p>


<h3>See Also</h3>

<p>Other save_to: 
<code><a href="#topic+save_to_csv">save_to_csv</a>()</code>,
<code><a href="#topic+save_to_datatable">save_to_datatable</a>()</code>,
<code><a href="#topic+save_to_duckdb">save_to_duckdb</a>()</code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>output_dir &lt;- file.path(tempdir(check = TRUE), "expanded_data")
ITT_trial &lt;- trial_sequence("ITT") |&gt;
  set_data(data = data_censored) |&gt;
  set_expansion_options(output = save_to_csv(output_dir), chunk_size = 500)

# Delete directory
unlink(output_dir, recursive = TRUE)
</code></pre>

<hr>
<h2 id='set_outcome_model'>Specify the outcome model</h2><span id='topic+set_outcome_model'></span><span id='topic+set_outcome_model+2Ctrial_sequence-method'></span><span id='topic+set_outcome_model+2Ctrial_sequence_ITT-method'></span><span id='topic+set_outcome_model+2Ctrial_sequence_PP-method'></span><span id='topic+set_outcome_model+2Ctrial_sequence_AT-method'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>
<p>The time-to-event model for <code>outcome</code> is specified with this method. Any adjustment terms can be specified.
For ITT and PP estimands the <code>treatment_var</code> is not specified as it is automatically defined as
<code>assigned_treatment</code>. Importantly, the modelling of &quot;time&quot; is specified in this model with arguments for
trial start time and follow up time within the trial.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>set_outcome_model(object, ...)

## S4 method for signature 'trial_sequence'
set_outcome_model(
  object,
  treatment_var = ~0,
  adjustment_terms = ~1,
  followup_time_terms = ~followup_time + I(followup_time^2),
  trial_period_terms = ~trial_period + I(trial_period^2),
  model_fitter = stats_glm_logit(save_path = NA)
)

## S4 method for signature 'trial_sequence_ITT'
set_outcome_model(
  object,
  adjustment_terms = ~1,
  followup_time_terms = ~followup_time + I(followup_time^2),
  trial_period_terms = ~trial_period + I(trial_period^2),
  model_fitter = stats_glm_logit(save_path = NA)
)

## S4 method for signature 'trial_sequence_PP'
set_outcome_model(
  object,
  adjustment_terms = ~1,
  followup_time_terms = ~followup_time + I(followup_time^2),
  trial_period_terms = ~trial_period + I(trial_period^2),
  model_fitter = stats_glm_logit(save_path = NA)
)

## S4 method for signature 'trial_sequence_AT'
set_outcome_model(
  object,
  treatment_var = "dose",
  adjustment_terms = ~1,
  followup_time_terms = ~followup_time + I(followup_time^2),
  trial_period_terms = ~trial_period + I(trial_period^2),
  model_fitter = stats_glm_logit(save_path = NA)
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="set_outcome_model_+3A_object">object</code></td>
<td>
<p>A trial_sequence object</p>
</td></tr>
<tr><td><code id="set_outcome_model_+3A_...">...</code></td>
<td>
<p>Parameters used by methods</p>
</td></tr>
<tr><td><code id="set_outcome_model_+3A_treatment_var">treatment_var</code></td>
<td>
<p>The treatment term, only used for &quot;as treated&quot; estimands. PP and ITT are fixed to use
&quot;assigned_treatment&quot;.</p>
</td></tr>
<tr><td><code id="set_outcome_model_+3A_adjustment_terms">adjustment_terms</code></td>
<td>
<p>Formula terms for any covariates to adjust the outcome model.</p>
</td></tr>
<tr><td><code id="set_outcome_model_+3A_followup_time_terms">followup_time_terms</code></td>
<td>
<p>Formula terms for <code>followup_time</code>, the time period relative to the start of the trial.</p>
</td></tr>
<tr><td><code id="set_outcome_model_+3A_trial_period_terms">trial_period_terms</code></td>
<td>
<p>Formula terms for <code>trial_period</code>, the time period of the start of the trial.</p>
</td></tr>
<tr><td><code id="set_outcome_model_+3A_model_fitter">model_fitter</code></td>
<td>
<p>A <code>te_model_fitter</code> object, e.g. from <code>stats_glm_logit()</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A modified <code>object</code> with the <code>outcome_model</code> slot set
</p>


<h3>Examples</h3>

<pre><code class='language-R'>trial_sequence("ITT") |&gt;
  set_data(data_censored) |&gt;
  set_outcome_model(
    adjustment_terms = ~age_s,
    followup_time_terms = ~ stats::poly(followup_time, degree = 2)
  )

</code></pre>

<hr>
<h2 id='set_switch_weight_model'>Set switching weight model</h2><span id='topic+set_switch_weight_model'></span><span id='topic+set_switch_weight_model+2Ctrial_sequence-method'></span><span id='topic+set_switch_weight_model+2Ctrial_sequence_ITT-method'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>set_switch_weight_model(object, numerator, denominator, model_fitter, ...)

## S4 method for signature 'trial_sequence'
set_switch_weight_model(
  object,
  numerator,
  denominator,
  model_fitter,
  eligible_wts_0 = NULL,
  eligible_wts_1 = NULL
)

## S4 method for signature 'trial_sequence_ITT'
set_switch_weight_model(object, numerator, denominator, model_fitter)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="set_switch_weight_model_+3A_object">object</code></td>
<td>
<p>A <a href="#topic+trial_sequence">trial_sequence</a> object.</p>
</td></tr>
<tr><td><code id="set_switch_weight_model_+3A_numerator">numerator</code></td>
<td>
<p>Right hand side formula for the numerator model</p>
</td></tr>
<tr><td><code id="set_switch_weight_model_+3A_denominator">denominator</code></td>
<td>
<p>Right hand side formula for the denominator model</p>
</td></tr>
<tr><td><code id="set_switch_weight_model_+3A_model_fitter">model_fitter</code></td>
<td>
<p>A <a href="#topic+te_model_fitter-class">te_model_fitter</a> object, such as <a href="#topic+stats_glm_logit">stats_glm_logit</a></p>
</td></tr>
<tr><td><code id="set_switch_weight_model_+3A_...">...</code></td>
<td>
<p>Other arguments used by methods.</p>
</td></tr>
<tr><td><code id="set_switch_weight_model_+3A_eligible_wts_0">eligible_wts_0</code></td>
<td>
<p>Name of column containing indicator (0/1) for observation to be excluded/included in weight
model.</p>
</td></tr>
<tr><td><code id="set_switch_weight_model_+3A_eligible_wts_1">eligible_wts_1</code></td>
<td>
<p>Exclude some observations when fitting the models for the inverse probability of treatment
weights. For example, if it is assumed that an individual will stay on treatment for at least 2 visits, the first 2
visits after treatment initiation by definition have a probability of staying on the treatment of 1.0 and should
thus be excluded from the weight models for those who are on treatment at the immediately previous visit. Users can
define a variable that indicates that these 2 observations are ineligible for the weight model for those who are on
treatment at the immediately previous visit and add the variable name in the argument <code>eligible_wts_1</code>. Similar
definitions are applied to <code>eligible_wts_0</code> for excluding observations when fitting the models for the inverse
probability of treatment weights for those who are not on treatment at the immediately previous visit.</p>
</td></tr>
</table>


<h3>Value</h3>

<p><code>object</code> is returned with <code style="white-space: pre;">&#8288;@switch_weights&#8288;</code> set
</p>


<h3>Examples</h3>

<pre><code class='language-R'>trial_sequence("PP") |&gt;
  set_data(data = data_censored) |&gt;
  set_switch_weight_model(
    numerator = ~ age_s + x1 + x3,
    denominator = ~ x3 + x4,
    model_fitter = stats_glm_logit(tempdir())
  )
</code></pre>

<hr>
<h2 id='show_weight_models'>Show Weight Model Summaries</h2><span id='topic+show_weight_models'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>show_weight_models(object)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="show_weight_models_+3A_object">object</code></td>
<td>
<p>A <a href="#topic+trial_sequence">trial_sequence</a> object after fitting weight models with <code><a href="#topic+calculate_weights">calculate_weights()</a></code></p>
</td></tr>
</table>


<h3>Value</h3>

<p>Prints summaries of the censoring models
</p>

<hr>
<h2 id='stats_glm_logit'>Fit outcome models using <code>stats::glm</code></h2><span id='topic+stats_glm_logit'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>stats_glm_logit(save_path)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="stats_glm_logit_+3A_save_path">save_path</code></td>
<td>
<p>Directory to save models. Set to <code>NA</code> if models should not be saved.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Specify that the pooled logistic regression outcome models should be fit using <a href="stats.html#topic+glm">stats::glm</a> with <code>family = binomial(link = "logit")</code>.
</p>
<p>Outcome models additional calculate robust variance estimates using <code>sandwich::vcovCL</code>.
</p>


<h3>Value</h3>

<p>An object of class <code>te_stats_glm_logit</code> inheriting from <a href="#topic+te_model_fitter-class">te_model_fitter</a> which is used for
dispatching methods for the fitting models.
</p>


<h3>See Also</h3>

<p>Other model_fitter: 
<code><a href="#topic+parsnip_model">parsnip_model</a>()</code>,
<code><a href="#topic+te_model_fitter-class">te_model_fitter-class</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>stats_glm_logit(save_path = tempdir())
</code></pre>

<hr>
<h2 id='summary.TE_data_prep'>Summary methods</h2><span id='topic+summary.TE_data_prep'></span><span id='topic+summary.TE_data_prep_sep'></span><span id='topic+summary.TE_data_prep_dt'></span><span id='topic+summary.TE_msm'></span><span id='topic+summary.TE_robust'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#stable"><img src="../help/figures/lifecycle-stable.svg" alt='[Stable]' /></a>
Print summaries of data and model objects produced by <code>TrialEmulation</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'TE_data_prep'
summary(object, ...)

## S3 method for class 'TE_data_prep_sep'
summary(object, ...)

## S3 method for class 'TE_data_prep_dt'
summary(object, ...)

## S3 method for class 'TE_msm'
summary(object, ...)

## S3 method for class 'TE_robust'
summary(object, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="summary.TE_data_prep_+3A_object">object</code></td>
<td>
<p>Object to print summary</p>
</td></tr>
<tr><td><code id="summary.TE_data_prep_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to print methods.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>No value, displays summaries of object.
</p>

<hr>
<h2 id='te_data_ex'>Example of a prepared data object</h2><span id='topic+te_data_ex'></span>

<h3>Description</h3>

<p>A small example object from <a href="#topic+data_preparation">data_preparation</a> used in examples.
It is created with the following code:
</p>


<h3>Usage</h3>

<pre><code class='language-R'>te_data_ex
</code></pre>


<h3>Format</h3>

<p>An object of class <code>TE_data_prep_dt</code> (inherits from <code>TE_data_prep</code>) of length 6.
</p>


<h3>Details</h3>

<div class="sourceCode r"><pre>dat &lt;- trial_example[trial_example$id &lt; 200, ]

te_data_ex &lt;- data_preparation(
data = dat,
 outcome_cov = c("nvarA", "catvarA"),
 first_period = 260,
 last_period = 280
)
</pre></div>


<h3>See Also</h3>

<p><a href="#topic+te_model_ex">te_model_ex</a>
</p>

<hr>
<h2 id='te_data-class'>TrialEmulation Data Class</h2><span id='topic+te_data-class'></span>

<h3>Description</h3>

<p>TrialEmulation Data Class
</p>


<h3>Slots</h3>


<dl>
<dt><code>data</code></dt><dd><p>A <code>data.table</code> object with columns &quot;id&quot;, &quot;period&quot;,
&quot;treatment&quot;, &quot;outcome&quot;, &quot;eligible&quot;</p>
</dd>
</dl>

<hr>
<h2 id='te_datastore_csv-class'>te_datastore_csv, functions and methods</h2><span id='topic+te_datastore_csv-class'></span><span id='topic+save_expanded_data+2Cte_datastore_csv-method'></span><span id='topic+read_expanded_data+2Cte_datastore_csv-method'></span><span id='topic+sample_expanded_data+2Cte_datastore_csv-method'></span>

<h3>Description</h3>

<p>This method is used internally by <a href="#topic+expand_trials">expand_trials</a> to save the data to the &quot;datastore&quot; defined in
<a href="#topic+set_expansion_options">set_expansion_options</a>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S4 method for signature 'te_datastore_csv'
save_expanded_data(object, data)

## S4 method for signature 'te_datastore_csv'
read_expanded_data(object, period = NULL, subset_condition = NULL)

## S4 method for signature 'te_datastore_csv'
sample_expanded_data(
  object,
  p_control,
  period = NULL,
  subset_condition = NULL,
  seed
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="te_datastore_csv-class_+3A_object">object</code></td>
<td>
<p>An object of class <a href="#topic+te_datastore-class">te_datastore</a> or a child class.</p>
</td></tr>
<tr><td><code id="te_datastore_csv-class_+3A_data">data</code></td>
<td>
<p>A data frame containing the expanded trial data. The columns <code>trial_period</code> and <code>id</code> are present, which
may be used in methods to save the data in an optimal way, such as with indexes, keys or separate files.</p>
</td></tr>
<tr><td><code id="te_datastore_csv-class_+3A_period">period</code></td>
<td>
<p>An integerish vector of non-zero length to select trial period(s) or <code>NULL</code> (default) to
select all files.</p>
</td></tr>
<tr><td><code id="te_datastore_csv-class_+3A_subset_condition">subset_condition</code></td>
<td>
<p>A string of length 1 or <code>NULL</code> (default).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A 'te_datastore_csv' object.
</p>


<h3>Slots</h3>


<dl>
<dt><code>path</code></dt><dd><p>path to csv files.</p>
</dd>
<dt><code>files</code></dt><dd><p>names of csv files.</p>
</dd>
<dt><code>template</code></dt><dd><p>data.frame template.</p>
</dd>
</dl>


<h3>Examples</h3>

<pre><code class='language-R'>temp_dir &lt;- tempfile("csv_dir_")
dir.create(temp_dir)
datastore &lt;- save_to_csv(temp_dir)
data(vignette_switch_data)
save_expanded_data(datastore, vignette_switch_data[1:200, ])

# delete after use
unlink(temp_dir, recursive = TRUE)
</code></pre>

<hr>
<h2 id='te_datastore_duckdb-class'>te_datastore_duckdb, functions and methods</h2><span id='topic+te_datastore_duckdb-class'></span><span id='topic+save_expanded_data+2Cte_datastore_duckdb-method'></span><span id='topic+read_expanded_data+2Cte_datastore_duckdb-method'></span><span id='topic+sample_expanded_data+2Cte_datastore_duckdb-method'></span>

<h3>Description</h3>

<p>This method is used internally by <a href="#topic+expand_trials">expand_trials</a> to save the data to the &quot;datastore&quot; defined in
<a href="#topic+set_expansion_options">set_expansion_options</a>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S4 method for signature 'te_datastore_duckdb'
save_expanded_data(object, data)

## S4 method for signature 'te_datastore_duckdb'
read_expanded_data(object, period = NULL, subset_condition = NULL)

## S4 method for signature 'te_datastore_duckdb'
sample_expanded_data(
  object,
  p_control,
  period = NULL,
  subset_condition = NULL,
  seed
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="te_datastore_duckdb-class_+3A_object">object</code></td>
<td>
<p>An object of class <a href="#topic+te_datastore-class">te_datastore</a> or a child class.</p>
</td></tr>
<tr><td><code id="te_datastore_duckdb-class_+3A_data">data</code></td>
<td>
<p>A data frame containing the expanded trial data. The columns <code>trial_period</code> and <code>id</code> are present, which
may be used in methods to save the data in an optimal way, such as with indexes, keys or separate files.</p>
</td></tr>
<tr><td><code id="te_datastore_duckdb-class_+3A_period">period</code></td>
<td>
<p>An integerish vector of non-zero length to select trial period(s) or <code>NULL</code> (default) to
select all files.</p>
</td></tr>
<tr><td><code id="te_datastore_duckdb-class_+3A_subset_condition">subset_condition</code></td>
<td>
<p>A string of length 1 or <code>NULL</code> (default).</p>
</td></tr>
<tr><td><code id="te_datastore_duckdb-class_+3A_p_control">p_control</code></td>
<td>
<p>Probability of selecting a control.</p>
</td></tr>
<tr><td><code id="te_datastore_duckdb-class_+3A_seed">seed</code></td>
<td>
<p>An integer seed or <code>NULL</code> (default).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A 'te_datastore_duckdb' object.
</p>


<h3>Slots</h3>


<dl>
<dt><code>path</code></dt><dd><p>Path to the duckdb file containing the data.</p>
</dd>
<dt><code>table</code></dt><dd><p>.</p>
</dd>
<dt><code>con</code></dt><dd><p>S4 object of class duckdb_connection.</p>
</dd>
</dl>


<h3>Examples</h3>

<pre><code class='language-R'>temp_dir &lt;- tempfile("csv_dir_")
dir.create(temp_dir)
datastore &lt;- save_to_csv(temp_dir)
data(vignette_switch_data)
save_expanded_data(datastore, vignette_switch_data[1:200, ])

# delete after use
unlink(temp_dir, recursive = TRUE)
</code></pre>

<hr>
<h2 id='te_datastore-class'>te_datastore</h2><span id='topic+te_datastore-class'></span>

<h3>Description</h3>

<p>This is the parent class for classes which define how the expanded trial data should be stored.
To define a new storage type, a new class should be defined which inherits from <code>te_datastore</code>. In addition, methods
<a href="#topic+save_expanded_data">save_expanded_data</a> and <code>read_expanded_data</code> need to be defined for the new class.
</p>


<h3>Value</h3>

<p>A 'te_datastore' object
</p>


<h3>Slots</h3>


<dl>
<dt><code>N</code></dt><dd><p>The number of observations in this data. Initially 0.</p>
</dd>
</dl>

<hr>
<h2 id='te_model_ex'>Example of a fitted marginal structural model object</h2><span id='topic+te_model_ex'></span>

<h3>Description</h3>

<p>A small example object from <a href="#topic+trial_msm">trial_msm</a> used in examples. It is created with the
following code:
</p>


<h3>Usage</h3>

<pre><code class='language-R'>te_model_ex
</code></pre>


<h3>Format</h3>

<p>An object of class <code>TE_msm</code> of length 3.
</p>


<h3>Details</h3>

<div class="sourceCode r"><pre>te_model_ex &lt;- trial_msm(
 data = data_subset,
 outcome_cov = c("catvarA", "nvarA"),
 last_followup = 40,
 model_var = "assigned_treatment",
 include_followup_time = ~followup_time,
 include_trial_period = ~trial_period,
 use_sample_weights = FALSE,
 quiet = TRUE,
 glm_function = "glm"
 )
</pre></div>


<h3>See Also</h3>

<p><a href="#topic+te_data_ex">te_data_ex</a>
</p>

<hr>
<h2 id='te_model_fitter-class'>Outcome Model Fitter Class</h2><span id='topic+te_model_fitter-class'></span>

<h3>Description</h3>

<p>This is a virtual class which other outcome model fitter classes should inherit from. Objects of these class exist to
define how the outcome models are fit. They are used for the dispatch of the internal methods <a href="#topic+fit_outcome_model">fit_outcome_model</a>,
<a href="#topic+fit_weights_model">fit_weights_model</a> and <a href="#topic+predict">predict</a>.
</p>


<h3>See Also</h3>

<p>Other model_fitter: 
<code><a href="#topic+parsnip_model">parsnip_model</a>()</code>,
<code><a href="#topic+stats_glm_logit">stats_glm_logit</a>()</code>
</p>

<hr>
<h2 id='te_outcome_data-class'>TrialEmulation Outcome Data Class</h2><span id='topic+te_outcome_data-class'></span>

<h3>Description</h3>

<p>TrialEmulation Outcome Data Class
</p>


<h3>Slots</h3>


<dl>
<dt><code>data</code></dt><dd><p>A <code>data.table</code> object with columns &quot;id&quot;, &quot;period&quot;,</p>
</dd>
<dt><code>n_rows</code></dt><dd><p>Number of rows</p>
</dd>
<dt><code>n_ids</code></dt><dd><p>Number of IDs</p>
</dd>
<dt><code>periods</code></dt><dd><p>Vector of periods
&quot;treatment&quot;, &quot;outcome&quot;, &quot;eligible&quot;</p>
</dd>
</dl>

<hr>
<h2 id='te_outcome_fitted-class'>Fitted Outcome Model Object</h2><span id='topic+te_outcome_fitted-class'></span>

<h3>Description</h3>

<p>Fitted Outcome Model Object
</p>


<h3>Slots</h3>


<dl>
<dt><code>model</code></dt><dd><p>list containing fitted model objects.</p>
</dd>
<dt><code>summary</code></dt><dd><p>list of data.frames. Tidy model summaries a la <code>broom()</code> and <code>glance()</code></p>
</dd>
</dl>

<hr>
<h2 id='te_outcome_model-class'>Fitted Outcome Model Object</h2><span id='topic+te_outcome_model-class'></span>

<h3>Description</h3>

<p>Fitted Outcome Model Object
</p>


<h3>Slots</h3>


<dl>
<dt><code>formula</code></dt><dd><p><code>formula</code> object for the model fitting</p>
</dd>
<dt><code>adjustment_vars</code></dt><dd><p>character. Adjustment variables</p>
</dd>
<dt><code>treatment_var</code></dt><dd><p>Variable used for treatment</p>
</dd>
<dt><code>stabilised_weights_terms</code></dt><dd><p>formula. Adjustment terms from numerator models of stabilised weights. These must be
included in the outcome model.</p>
</dd>
<dt><code>adjustment_terms</code></dt><dd><p>formula. User specified terms to include in the outcome model</p>
</dd>
<dt><code>treatment_terms</code></dt><dd><p>formula. Estimand defined treatment term</p>
</dd>
<dt><code>followup_time_terms</code></dt><dd><p>formula. Terms to model follow up time within an emulated trial</p>
</dd>
<dt><code>trial_period_terms</code></dt><dd><p>formula. Terms to model start time (&quot;trial_period&quot;) of an emulated trial</p>
</dd>
<dt><code>model_fitter</code></dt><dd><p>Model fitter object</p>
</dd>
<dt><code>fitted</code></dt><dd><p>list. Saves the model objects</p>
</dd>
</dl>

<hr>
<h2 id='te_parsnip_model-class'>Fit Models using parsnip</h2><span id='topic+te_parsnip_model-class'></span><span id='topic+fit_weights_model+2Cte_parsnip_model-method'></span>

<h3>Description</h3>

<p>The classes and (internal) methods defined for using parsnip to fit the weight models.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S4 method for signature 'te_parsnip_model'
fit_weights_model(object, data, formula, label)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="te_parsnip_model-class_+3A_object">object</code></td>
<td>
<p>The object determining which method should be used, containing any slots containing user defined
parameters.</p>
</td></tr>
<tr><td><code id="te_parsnip_model-class_+3A_data">data</code></td>
<td>
<p><code>data.frame</code> containing outcomes and covariates as defined in <code>formula</code>.</p>
</td></tr>
<tr><td><code id="te_parsnip_model-class_+3A_formula">formula</code></td>
<td>
<p><code>formula</code> describing the model.</p>
</td></tr>
<tr><td><code id="te_parsnip_model-class_+3A_label">label</code></td>
<td>
<p>A short string describing the model.</p>
</td></tr>
</table>


<h3>Functions</h3>


<ul>
<li> <p><code>fit_weights_model(te_parsnip_model)</code>: Fit the weight models object via <a href="#topic+calculate_weights">calculate_weights</a> on <code>trial_sequence</code>
</p>
</li></ul>


<h3>Slots</h3>


<dl>
<dt><code>model_spec</code></dt><dd><p>A model specification defined with the <code>parsnip</code> package.</p>
</dd>
</dl>


<h3>See Also</h3>

<p>Other model_fitter_classes: 
<code><a href="#topic+te_stats_glm_logit-class">te_stats_glm_logit-class</a></code>
</p>

<hr>
<h2 id='te_stats_glm_logit-class'>Fit Models using logistic stats::glm</h2><span id='topic+te_stats_glm_logit-class'></span><span id='topic+te_stats_glm_logit_outcome_fitted-class'></span><span id='topic+fit_weights_model+2Cte_stats_glm_logit-method'></span><span id='topic+fit_outcome_model+2Cte_stats_glm_logit-method'></span><span id='topic+predict+2Cte_stats_glm_logit_outcome_fitted-method'></span>

<h3>Description</h3>

<p>The classes and (internal) methods defined for using <a href="stats.html#topic+glm">stats::glm</a> to fit the logistic regression models.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S4 method for signature 'te_stats_glm_logit'
fit_weights_model(object, data, formula, label)

## S4 method for signature 'te_stats_glm_logit'
fit_outcome_model(object, data, formula, weights = NULL)

## S4 method for signature 'te_stats_glm_logit_outcome_fitted'
predict(
  object,
  newdata,
  predict_times,
  conf_int = TRUE,
  samples = 100,
  type = c("cum_inc", "survival")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="te_stats_glm_logit-class_+3A_object">object</code></td>
<td>
<p>Object to dispatch method on</p>
</td></tr>
<tr><td><code id="te_stats_glm_logit-class_+3A_data">data</code></td>
<td>
<p><code>data.frame</code> containing outcomes and covariates as defined in <code>formula</code>.</p>
</td></tr>
<tr><td><code id="te_stats_glm_logit-class_+3A_formula">formula</code></td>
<td>
<p><code>formula</code> describing the model.</p>
</td></tr>
<tr><td><code id="te_stats_glm_logit-class_+3A_label">label</code></td>
<td>
<p>A short string describing the model.</p>
</td></tr>
<tr><td><code id="te_stats_glm_logit-class_+3A_weights">weights</code></td>
<td>
<p><code>numeric</code> vector of weights.</p>
</td></tr>
<tr><td><code id="te_stats_glm_logit-class_+3A_newdata">newdata</code></td>
<td>
<p>Baseline trial data that characterise the target trial population that marginal cumulative incidences
or survival probabilities are predicted for.  <code>newdata</code> must have the same columns and formats of variables as in
the fitted marginal structural model specified in <code><a href="#topic+trial_msm">trial_msm()</a></code> or <code><a href="#topic+initiators">initiators()</a></code>. If <code>newdata</code> contains rows with
<code>followup_time &gt; 0</code> these will be removed.</p>
</td></tr>
<tr><td><code id="te_stats_glm_logit-class_+3A_predict_times">predict_times</code></td>
<td>
<p>Specify the follow-up visits/times where the marginal cumulative incidences or survival
probabilities are predicted.</p>
</td></tr>
<tr><td><code id="te_stats_glm_logit-class_+3A_conf_int">conf_int</code></td>
<td>
<p>Construct the point-wise 95-percent confidence intervals of cumulative incidences for the target
trial population under treatment and non-treatment and their differences by simulating the parameters in the
marginal structural model from a multivariate normal distribution with the mean equal to the marginal structural
model parameter estimates and the variance equal to the estimated robust covariance matrix.</p>
</td></tr>
<tr><td><code id="te_stats_glm_logit-class_+3A_samples">samples</code></td>
<td>
<p>Number of samples used to construct the simulation-based confidence intervals.</p>
</td></tr>
<tr><td><code id="te_stats_glm_logit-class_+3A_type">type</code></td>
<td>
<p>Specify cumulative incidences or survival probabilities to be predicted. Either cumulative incidence
(<code>"cum_inc"</code>) or survival probability (<code>"survival"</code>).</p>
</td></tr>
</table>


<h3>Functions</h3>


<ul>
<li> <p><code>fit_weights_model(te_stats_glm_logit)</code>: Fit the weight models object via <a href="#topic+calculate_weights">calculate_weights</a> on <code>trial_sequence</code>
</p>
</li>
<li> <p><code>fit_outcome_model(te_stats_glm_logit)</code>: Fit the outcome model object via <a href="#topic+fit_msm">fit_msm</a> on <code>trial_sequence</code>
</p>
</li>
<li> <p><code>predict(te_stats_glm_logit_outcome_fitted)</code>: Predict from the fitted model object via <a href="#topic+predict">predict</a> on <code>trial_sequence</code>
</p>
</li></ul>


<h3>See Also</h3>

<p>Other model_fitter_classes: 
<code><a href="#topic+te_parsnip_model-class">te_parsnip_model-class</a></code>
</p>

<hr>
<h2 id='trial_example'>Example of longitudinal data for sequential trial emulation</h2><span id='topic+trial_example'></span>

<h3>Description</h3>

<p>A dataset containing the treatment, outcomes and other attributes of 503 patients for sequential trial emulation.
See <code>vignette("Getting-Started")</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>trial_example
</code></pre>


<h3>Format</h3>

<p>A data frame with 48400 rows and 11 variables:
</p>

<dl>
<dt>id</dt><dd><p>patient identifier</p>
</dd>
<dt>eligible</dt><dd><p>eligible for trial start in this period, 1=yes, 0=no</p>
</dd>
<dt>period</dt><dd><p>time period</p>
</dd>
<dt>outcome</dt><dd><p>indicator for outcome in this period, 1=event occurred, 0=no event</p>
</dd>
<dt>treatment</dt><dd><p>indicator for receiving treatment in this period, 1=treatment, 0=no treatment</p>
</dd>
<dt>catvarA</dt><dd><p>A categorical variable relating to treatment and the outcome</p>
</dd>
<dt>catvarB</dt><dd><p>A categorical variable relating to treatment and the outcome</p>
</dd>
<dt>catvarC</dt><dd><p>A categorical variable relating to treatment and the outcome</p>
</dd>
<dt>nvarA</dt><dd><p>A numerical variable relating to treatment and the outcome</p>
</dd>
<dt>nvarB</dt><dd><p>A numerical variable relating to treatment and the outcome</p>
</dd>
<dt>nvarC</dt><dd><p>A numerical variable relating to treatment and the outcome</p>
</dd>
</dl>


<hr>
<h2 id='trial_msm'>Fit the marginal structural model for the sequence of emulated trials</h2><span id='topic+trial_msm'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#stable"><img src="../help/figures/lifecycle-stable.svg" alt='[Stable]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>trial_msm(
  data,
  outcome_cov = ~1,
  estimand_type = c("ITT", "PP", "As-Treated"),
  model_var = NULL,
  first_followup = NA,
  last_followup = NA,
  analysis_weights = c("asis", "unweighted", "p99", "weight_limits"),
  weight_limits = c(0, Inf),
  include_followup_time = ~followup_time + I(followup_time^2),
  include_trial_period = ~trial_period + I(trial_period^2),
  where_case = NA,
  glm_function = c("glm", "parglm"),
  use_sample_weights = TRUE,
  quiet = FALSE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="trial_msm_+3A_data">data</code></td>
<td>
<p>A <code>data.frame</code> containing all the required variables in the person-time format, i.e., the  &lsquo;long&rsquo; format.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_outcome_cov">outcome_cov</code></td>
<td>
<p>A RHS formula with baseline covariates to be adjusted for in the marginal structural model for the
emulated trials. Note that if a time-varying covariate is specified in <code>outcome_cov</code>, only its value at each of the
trial baselines will be included in the expanded data.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_estimand_type">estimand_type</code></td>
<td>
<p>Specify the estimand for the causal analyses in the sequence of emulated trials. <code>estimand_type = "ITT"</code> will perform intention-to-treat analyses, where treatment switching after trial baselines are ignored.
<code>estimand_type = "PP"</code> will perform per-protocol analyses, where individuals' follow-ups are artificially censored
and inverse probability of treatment weighting is applied. <code>estimand_type = "As-Treated"</code> will fit a standard
marginal structural model for all possible treatment sequences, where individuals' follow-ups are not artificially
censored  but treatment switching after trial baselines are accounted for by applying inverse probability of
treatment weighting.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_model_var">model_var</code></td>
<td>
<p>Treatment variables to be included in the marginal structural model for the emulated trials.
<code>model_var = "assigned_treatment"</code> will create a variable <code>assigned_treatment</code> that is the assigned treatment at
the trial baseline, typically used for ITT and per-protocol analyses. <code>model_var = "dose"</code> will create a variable
<code>dose</code> that is the cumulative number of  treatments received since the trial baseline, typically used in as-treated
analyses.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_first_followup">first_followup</code></td>
<td>
<p>First follow-up time/visit in the trials to be included in the marginal structural model for
the outcome event.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_last_followup">last_followup</code></td>
<td>
<p>Last follow-up time/visit in the trials to be included in the marginal structural model for the
outcome event.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_analysis_weights">analysis_weights</code></td>
<td>
<p>Choose which type of weights to be used for fitting the marginal structural model for the
outcome event.
</p>

<ul>
<li> <p><code>"asis"</code>: use the weights as calculated.
</p>
</li>
<li> <p><code>"p99"</code>: use weights truncated at the 1st and 99th percentiles (based on the distribution of weights
in the entire sample).
</p>
</li>
<li> <p><code>"weight_limits"</code>: use weights truncated at the values specified in <code>weight_limits</code>.
</p>
</li>
<li> <p><code>"unweighted"</code>: set all analysis weights to 1, even if treatment weights or censoring weights were calculated.
</p>
</li></ul>
</td></tr>
<tr><td><code id="trial_msm_+3A_weight_limits">weight_limits</code></td>
<td>
<p>Lower and upper limits to truncate weights, given as <code>c(lower, upper)</code></p>
</td></tr>
<tr><td><code id="trial_msm_+3A_include_followup_time">include_followup_time</code></td>
<td>
<p>The model to include the follow up time/visit of the trial (<code>followup_time</code>) in the
marginal structural model, specified as a RHS formula.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_include_trial_period">include_trial_period</code></td>
<td>
<p>The model to include the trial period (<code>trial_period</code>) in the marginal structural model,
specified as a RHS formula.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_where_case">where_case</code></td>
<td>
<p>Define conditions using variables specified in <code>where_var</code> when fitting a marginal structural model
for a subgroup of the individuals. For example, if <code>where_var= "age"</code>, <code>where_case = "age &gt;= 30"</code> will only fit the
marginal structural model to the subgroup of individuals. who are 30 years old or above.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_glm_function">glm_function</code></td>
<td>
<p>Specify which glm function to use for the marginal structural model from the <code>stats</code> or <code>parglm</code>
packages. The default function is the <code>glm</code> function in the <code>stats</code> package. Users can also specify <code>glm_function = "parglm"</code> such that the <code>parglm</code> function in the <code>parglm</code> package can be used for fitting generalized linear models
in parallel. The default control setting for  <code>parglm</code> is <code>nthreads = 4</code> and <code>method = "FAST"</code>, where four cores
and Fisher information are used for faster computation. Users can change the default control setting by passing the
arguments <code>nthreads</code> and <code>method</code> in the <code>parglm.control</code> function of the <code>parglm</code> package, or alternatively, by
passing a <code>control</code> argument with a list produced by <code>parglm.control(nthreads = , method = )</code>.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_use_sample_weights">use_sample_weights</code></td>
<td>
<p>Use case-control sampling weights in addition to inverse probability weights for treatment
and censoring. <code>data</code> must contain a column <code>sample_weight</code>. The final weights used in the pooled logistic
regression are calculated as <code>weight = weight * sample_weight</code>.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_quiet">quiet</code></td>
<td>
<p>Suppress the printing of progress messages and summaries of the fitted models.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to <code>glm_function</code>. This may be used to specify initial values of parameters or
arguments to <code>control</code>. See <a href="stats.html#topic+glm">stats::glm</a>, <a href="parglm.html#topic+parglm">parglm::parglm</a> and <code><a href="parglm.html#topic+parglm.control">parglm::parglm.control()</a></code> for more information.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Apply a weighted pooled logistic regression to fit the marginal structural model for the sequence of emulated trials
and calculates the robust covariance matrix  of parameter using the sandwich estimator.
</p>
<p>The model formula is constructed by combining the arguments <code>outcome_cov</code>, <code>model_var</code>,
<code>include_followup_time</code>, and <code>include_trial_period</code>.
</p>


<h3>Value</h3>

<p>Object of class <code>TE_msm</code> containing
</p>

<dl>
<dt>model</dt><dd><p>a <code>glm</code> object</p>
</dd>
<dt>robust</dt><dd><p>a list containing a summary table of estimated regression coefficients and the robust covariance
matrix</p>
</dd>
<dt>args</dt><dd><p>a list contain the parameters used to prepare and fit the model</p>
</dd>
</dl>


<hr>
<h2 id='trial_sequence'>Create a sequence of emulated target trials object</h2><span id='topic+trial_sequence'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>trial_sequence(estimand, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="trial_sequence_+3A_estimand">estimand</code></td>
<td>
<p>The name of the estimand for this analysis, either one of <code>"ITT"</code>, <code>"PP"</code>, <code>"AT"</code> for
intention-to-treat, per-protocol, as-treated estimands respectively, or the name of a class extending
<a href="#topic+trial_sequence-class">trial_sequence</a></p>
</td></tr>
<tr><td><code id="trial_sequence_+3A_...">...</code></td>
<td>
<p>Other parameters used when creating object</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An estimand specific trial sequence object
</p>


<h3>Examples</h3>

<pre><code class='language-R'>trial_sequence("ITT")

</code></pre>

<hr>
<h2 id='trial_sequence-class'>Trial Sequence class</h2><span id='topic+trial_sequence-class'></span><span id='topic+trial_sequence_PP-class'></span><span id='topic+trial_sequence_ITT-class'></span><span id='topic+trial_sequence_AT-class'></span>

<h3>Description</h3>

<p>Trial Sequence class
</p>


<h3>Slots</h3>


<dl>
<dt><code>data</code></dt><dd><p>te_data.</p>
</dd>
<dt><code>estimand</code></dt><dd><p>character. Descriptive name of estimand.</p>
</dd>
<dt><code>expansion</code></dt><dd><p>te_expansion</p>
</dd>
<dt><code>outcome_model</code></dt><dd><p>te_outcome_model.</p>
</dd>
<dt><code>outcome_data</code></dt><dd><p>te_outcome_data.</p>
</dd>
<dt><code>censor_weight</code></dt><dd><p>te_weight. Object to define weighting to account for
informative censoring</p>
</dd>
<dt><code>censor_weight</code></dt><dd><p>te_weight. Object to define weighting to account for
informative censoring due to treatment switching</p>
</dd>
</dl>

<hr>
<h2 id='vignette_switch_data'>Example of expanded longitudinal data for sequential trial emulation</h2><span id='topic+vignette_switch_data'></span>

<h3>Description</h3>

<p>This is the expanded dataset created in the <code>vignette("Getting-Started")</code> known as <code>switch_data</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>vignette_switch_data
</code></pre>


<h3>Format</h3>

<p>A data frame with 1939053 rows and 7 variables:
</p>

<dl>
<dt>id</dt><dd><p>patient identifier</p>
</dd>
<dt>trial_period</dt><dd><p>trial start time period</p>
</dd>
<dt>followup_time</dt><dd><p>follow up time within trial</p>
</dd>
<dt>outcome</dt><dd><p>indicator for outcome in this period, 1=event occurred, 0=no event</p>
</dd>
<dt>treatment</dt><dd><p>indicator for receiving treatment in this period, 1=treatment, 0=non-treatment</p>
</dd>
<dt>assigned_treatment</dt><dd><p>indicator for assigned treatment at baseline of the trial, 1=treatment, 0=non-treatment</p>
</dd>
<dt>weight</dt><dd><p>weights for use with model fitting</p>
</dd>
<dt>catvarA</dt><dd><p>A categorical variable relating to treatment and the outcome</p>
</dd>
<dt>catvarB</dt><dd><p>A categorical variable relating to treatment and the outcome</p>
</dd>
<dt>catvarC</dt><dd><p>A categorical variable relating to treatment and the outcome</p>
</dd>
<dt>nvarA</dt><dd><p>A numerical variable relating to treatment and the outcome</p>
</dd>
<dt>nvarB</dt><dd><p>A numerical variable relating to treatment and the outcome</p>
</dd>
<dt>nvarC</dt><dd><p>A numerical variable relating to treatment and the outcome</p>
</dd>
</dl>


<hr>
<h2 id='weight_model_data_indices'>Data used in weight model fitting</h2><span id='topic+weight_model_data_indices'></span>

<h3>Description</h3>

<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="../help/figures/lifecycle-experimental.svg" alt='[Experimental]' /></a>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>weight_model_data_indices(
  object,
  type = c("switch", "censor"),
  model,
  set_col = NULL
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="weight_model_data_indices_+3A_object">object</code></td>
<td>
<p>A <a href="#topic+trial_sequence">trial_sequence</a> object</p>
</td></tr>
<tr><td><code id="weight_model_data_indices_+3A_type">type</code></td>
<td>
<p>Select a censoring or switching model</p>
</td></tr>
<tr><td><code id="weight_model_data_indices_+3A_model">model</code></td>
<td>
<p>The model name</p>
</td></tr>
<tr><td><code id="weight_model_data_indices_+3A_set_col">set_col</code></td>
<td>
<p>A character string to specifying a new column to contain indicators for observations used in
fitting this model.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>If <code>set_col</code> is not specified a logical <code>data.table</code> column is returned. Otherwise
</p>


<h3>Examples</h3>

<pre><code class='language-R'>trial_pp &lt;- trial_sequence("PP") |&gt;
  set_data(data_censored) |&gt;
  set_switch_weight_model(
    numerator = ~age,
    denominator = ~ age + x1 + x3,
    model_fitter = stats_glm_logit(tempdir())
  ) |&gt;
  calculate_weights()
ipw_data(trial_pp)
show_weight_models(trial_pp)

# get logical column for own processing
i &lt;- weight_model_data_indices(trial_pp, "switch", "d0")

# set column in data
weight_model_data_indices(trial_pp, "switch", "d0", set_col = "sw_d0")
weight_model_data_indices(trial_pp, "switch", "d1", set_col = "sw_d1")
ipw_data(trial_pp)
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
