<!DOCTYPE html><html><head><title>Help for package TrialEmulation</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {TrialEmulation}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#TrialEmulation-package'><p><code>TrialEmulation</code> Package</p></a></li>
<li><a href='#calculate_predictions'><p>Calculate and transform predictions</p></a></li>
<li><a href='#case_control_sampling_trials'><p>Case-control sampling of expanded data for the sequence of emulated trials</p></a></li>
<li><a href='#censor_func'><p>Censoring Function in C++</p></a></li>
<li><a href='#check_newdata'><p>Check Data used for Prediction</p></a></li>
<li><a href='#data_manipulation'><p>Data Manipulation Function</p></a></li>
<li><a href='#data_preparation'><p>Prepare data for the sequence of emulated target trials</p></a></li>
<li><a href='#expand'><p>Expand Function</p></a></li>
<li><a href='#expand_until_switch'><p>Check Expand Flag After Treatment Switch</p></a></li>
<li><a href='#initiators'><p>A wrapper function to perform data preparation and model fitting in a sequence of emulated target trials</p></a></li>
<li><a href='#predict.TE_msm'><p>Predict marginal cumulative incidences with confidence intervals for a target trial population</p></a></li>
<li><a href='#print.TE_weight_summary'><p>Print a weight summary object</p></a></li>
<li><a href='#robust_calculation'><p>Robust Variance Calculation</p></a></li>
<li><a href='#select_data_cols'><p>Select Data Columns</p></a></li>
<li><a href='#summary.TE_data_prep'><p>Summary methods</p></a></li>
<li><a href='#te_data_ex'><p>Example of a prepared data object</p></a></li>
<li><a href='#te_model_ex'><p>Example of a fitted marginal structural model object</p></a></li>
<li><a href='#trial_example'><p>Example of longitudinal data for sequential trial emulation</p></a></li>
<li><a href='#trial_msm'><p>Fit the marginal structural model for the sequence of emulated trials</p></a></li>
<li><a href='#vignette_switch_data'><p>Example of expanded longitudinal data for sequential trial emulation</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Title:</td>
<td>Causal Analysis of Observational Time-to-Event Data</td>
</tr>
<tr>
<td>Version:</td>
<td>0.0.3.8</td>
</tr>
<tr>
<td>Description:</td>
<td>Implements target trial emulation methods to apply randomized
    clinical trial design and analysis in an observational setting. Using
    marginal structural models, it can estimate intention-to-treat and
    per-protocol effects in emulated trials using electronic health
    records. A description and application of the method can be found in
    Danaei et al (2013) &lt;<a href="https://doi.org/10.1177%2F0962280211403603">doi:10.1177/0962280211403603</a>&gt;.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License (&ge; 2)</a></td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://causal-lda.github.io/TrialEmulation/">https://causal-lda.github.io/TrialEmulation/</a>,
<a href="https://github.com/Causal-LDA/TrialEmulation">https://github.com/Causal-LDA/TrialEmulation</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/Causal-LDA/TrialEmulation/issues">https://github.com/Causal-LDA/TrialEmulation/issues</a></td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 3.5.0)</td>
</tr>
<tr>
<td>Imports:</td>
<td>broom (&ge; 0.7.10), checkmate, data.table (&ge; 1.9.8),
formula.tools, mvtnorm, parglm, Rcpp, sandwich</td>
</tr>
<tr>
<td>Suggests:</td>
<td>knitr, rmarkdown, testthat (&ge; 3.0.0), withr</td>
</tr>
<tr>
<td>LinkingTo:</td>
<td>Rcpp</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>Config/testthat/edition:</td>
<td>3</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>Language:</td>
<td>en-GB</td>
</tr>
<tr>
<td>LazyData:</td>
<td>true</td>
</tr>
<tr>
<td>LazyDataCompression:</td>
<td>xz</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.3.0</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>yes</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2024-01-24 11:47:27 UTC; gravesti</td>
</tr>
<tr>
<td>Author:</td>
<td>Roonak Rezvani <a href="https://orcid.org/0000-0001-5580-5058"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut] (Original package author),
  Isaac Gravestock <a href="https://orcid.org/0000-0003-0283-2065"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre],
  Li Su [aut],
  Medical Research Council (MRC) [fnd],
  F. Hoffmann-La Roche AG [cph, fnd]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Isaac Gravestock &lt;isaac.gravestock@roche.com&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2024-01-24 13:53:00 UTC</td>
</tr>
</table>
<hr>
<h2 id='TrialEmulation-package'><code>TrialEmulation</code> Package</h2><span id='topic+TrialEmulation'></span><span id='topic+TrialEmulation-package'></span>

<h3>Description</h3>

<p><code>TrialEmulation</code> facilitates preprocessing and analysing observational data
an emulated a randomised trial.
</p>


<h3>Author(s)</h3>

<p><strong>Maintainer</strong>: Isaac Gravestock <a href="mailto:isaac.gravestock@roche.com">isaac.gravestock@roche.com</a> (<a href="https://orcid.org/0000-0003-0283-2065">ORCID</a>)
</p>
<p>Authors:
</p>

<ul>
<li><p> Roonak Rezvani <a href="mailto:roonak.r74@gmail.com">roonak.r74@gmail.com</a> (<a href="https://orcid.org/0000-0001-5580-5058">ORCID</a>) (Original package author)
</p>
</li>
<li><p> Li Su <a href="mailto:li.su@mrc-bsu.cam.ac.uk">li.su@mrc-bsu.cam.ac.uk</a>
</p>
</li></ul>

<p>Other contributors:
</p>

<ul>
<li><p> Medical Research Council (MRC) [funder]
</p>
</li>
<li><p> F. Hoffmann-La Roche AG [copyright holder, funder]
</p>
</li></ul>



<h3>See Also</h3>

<p>Useful links:
</p>

<ul>
<li> <p><a href="https://causal-lda.github.io/TrialEmulation/">https://causal-lda.github.io/TrialEmulation/</a>
</p>
</li>
<li> <p><a href="https://github.com/Causal-LDA/TrialEmulation">https://github.com/Causal-LDA/TrialEmulation</a>
</p>
</li>
<li><p> Report bugs at <a href="https://github.com/Causal-LDA/TrialEmulation/issues">https://github.com/Causal-LDA/TrialEmulation/issues</a>
</p>
</li></ul>


<hr>
<h2 id='calculate_predictions'>Calculate and transform predictions</h2><span id='topic+calculate_predictions'></span>

<h3>Description</h3>

<p>Calculate and transform predictions
</p>


<h3>Usage</h3>

<pre><code class='language-R'>calculate_predictions(
  newdata,
  model,
  treatment_values,
  pred_fun,
  coefs_mat,
  matrix_n_col
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="calculate_predictions_+3A_newdata">newdata</code></td>
<td>
<p>New data to predict outcome</p>
</td></tr>
<tr><td><code id="calculate_predictions_+3A_model">model</code></td>
<td>
<p>GLM object</p>
</td></tr>
<tr><td><code id="calculate_predictions_+3A_treatment_values">treatment_values</code></td>
<td>
<p>Named vector of value to insert into <code>assigned_treatment</code> column</p>
</td></tr>
<tr><td><code id="calculate_predictions_+3A_pred_fun">pred_fun</code></td>
<td>
<p>Function to transform prediction matrix</p>
</td></tr>
<tr><td><code id="calculate_predictions_+3A_coefs_mat">coefs_mat</code></td>
<td>
<p>Matrix of coefficients corresponding to <code>model_matrix</code>.</p>
</td></tr>
<tr><td><code id="calculate_predictions_+3A_matrix_n_col">matrix_n_col</code></td>
<td>
<p>Expected number of column after prediction.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A matrix with transformed predicted values. Number of columns corresponds
to the number of rows of <code>coefs_mat</code>
</p>

<hr>
<h2 id='case_control_sampling_trials'>Case-control sampling of expanded data for the sequence of emulated trials</h2><span id='topic+case_control_sampling_trials'></span>

<h3>Description</h3>

<p>Perform case-control sampling of expanded data to create a data set of reduced size and calculate sampling weights
to be used in <code>trial_msm()</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>case_control_sampling_trials(
  data_prep,
  p_control = NULL,
  subset_condition,
  sort = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="case_control_sampling_trials_+3A_data_prep">data_prep</code></td>
<td>
<p>Result from <code><a href="#topic+data_preparation">data_preparation()</a></code>.</p>
</td></tr>
<tr><td><code id="case_control_sampling_trials_+3A_p_control">p_control</code></td>
<td>
<p>Control sampling probability for selecting potential controls at each follow-up time of each trial.</p>
</td></tr>
<tr><td><code id="case_control_sampling_trials_+3A_subset_condition">subset_condition</code></td>
<td>
<p>Expression used to <code><a href="base.html#topic+subset">subset()</a></code> the trial data before case-control sampling.</p>
</td></tr>
<tr><td><code id="case_control_sampling_trials_+3A_sort">sort</code></td>
<td>
<p>Sort data before applying case-control sampling to make sure that the resulting data are identical when
sampling from the expanded data created with <code>separate_files = TRUE</code> or <code>separate_files = FALSE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>data.frame</code> or a <code><a href="base.html#topic+split">split()</a></code> <code>data.frame</code> if  <code>length(p_control) &gt; 1</code>. An additional column <code>sample_weight</code>
containing the sample weights will be added to the result. These can be included in the models fit with
<code><a href="#topic+trial_msm">trial_msm()</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># If necessary reduce the number of threads for data.table
data.table::setDTthreads(2)

data("te_data_ex")
samples &lt;- case_control_sampling_trials(te_data_ex, p_control = 0.01)
</code></pre>

<hr>
<h2 id='censor_func'>Censoring Function in C++</h2><span id='topic+censor_func'></span>

<h3>Description</h3>

<p>Artificial censoring C++ function
</p>


<h3>Arguments</h3>

<table>
<tr><td><code id="censor_func_+3A_sw_data">sw_data</code></td>
<td>
<p>A dataframe with the columns needed in censoring process</p>
</td></tr>
</table>

<hr>
<h2 id='check_newdata'>Check Data used for Prediction</h2><span id='topic+check_newdata'></span>

<h3>Description</h3>

<p>Check Data used for Prediction
</p>


<h3>Usage</h3>

<pre><code class='language-R'>check_newdata(newdata, model, predict_times)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="check_newdata_+3A_newdata">newdata</code></td>
<td>
<p>new data to predict, or missing.</p>
</td></tr>
<tr><td><code id="check_newdata_+3A_model">model</code></td>
<td>
<p>glm model object.</p>
</td></tr>
<tr><td><code id="check_newdata_+3A_predict_times">predict_times</code></td>
<td>
<p>times to predict to add to resulting newdata.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A <code>newdata</code> data.frame
</p>

<hr>
<h2 id='data_manipulation'>Data Manipulation Function</h2><span id='topic+data_manipulation'></span>

<h3>Description</h3>

<p>This function takes the data and all the variables and does the extension preprocessing
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data_manipulation(data, use_censor = TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="data_manipulation_+3A_data">data</code></td>
<td>
<p><code>data.table</code> to pre-process for weight calculation and extension.</p>
</td></tr>
<tr><td><code id="data_manipulation_+3A_use_censor">use_censor</code></td>
<td>
<p>apply censoring due to treatment switch?</p>
</td></tr>
</table>

<hr>
<h2 id='data_preparation'>Prepare data for the sequence of emulated target trials</h2><span id='topic+data_preparation'></span>

<h3>Description</h3>

<p>This function  expands observational data in the person-time format (i.e., the  &lsquo;long&rsquo; format) to emulate a sequence
of target trials and also estimates the inverse probability of treatment and censoring weights as required.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data_preparation(
  data,
  id = "id",
  period = "period",
  treatment = "treatment",
  outcome = "outcome",
  eligible = "eligible",
  model_var = NULL,
  outcome_cov = ~1,
  estimand_type = c("ITT", "PP", "As-Treated"),
  switch_n_cov = ~1,
  switch_d_cov = ~1,
  first_period = NA,
  last_period = NA,
  use_censor_weights = FALSE,
  cense = NA,
  pool_cense = c("none", "both", "numerator"),
  cense_d_cov = ~1,
  cense_n_cov = ~1,
  eligible_wts_0 = NA,
  eligible_wts_1 = NA,
  where_var = NULL,
  data_dir,
  save_weight_models = FALSE,
  glm_function = "glm",
  chunk_size = 500,
  separate_files = FALSE,
  quiet = FALSE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="data_preparation_+3A_data">data</code></td>
<td>
<p>A <code>data.frame</code> containing all the required variables in the person-time format, i.e., the  &lsquo;long&rsquo; format.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_id">id</code></td>
<td>
<p>Name of the variable for identifiers of the individuals.  Default is &lsquo;id&rsquo;.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_period">period</code></td>
<td>
<p>Name of the variable for the visit/period.   Default is &lsquo;period&rsquo;.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_treatment">treatment</code></td>
<td>
<p>Name of the variable  for the treatment indicator at that visit/period. Default is &lsquo;treatment&rsquo;.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_outcome">outcome</code></td>
<td>
<p>Name of the variable for the indicator of the outcome event at that visit/period.  Default is
&lsquo;outcome&rsquo;.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_eligible">eligible</code></td>
<td>
<p>Name of the variable for the indicator of eligibility for the target trial at that visit/period.
Default is &lsquo;eligible&rsquo;.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_model_var">model_var</code></td>
<td>
<p>Treatment variables to be included in the marginal structural model for the emulated trials.
<code>model_var = "assigned_treatment"</code> will create a variable <code>assigned_treatment</code> that is the assigned treatment at
the trial baseline, typically used for ITT and per-protocol analyses. <code>model_var = "dose"</code> will create a variable
<code>dose</code> that is the cumulative number of  treatments received since the trial baseline, typically used in as-treated
analyses.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_outcome_cov">outcome_cov</code></td>
<td>
<p>A RHS formula with baseline covariates to be adjusted for in the marginal structural model for the
emulated trials. Note that if a time-varying covariate is specified in <code>outcome_cov</code>, only its value at each of the
trial baselines will be included in the expanded data.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_estimand_type">estimand_type</code></td>
<td>
<p>Specify the estimand for the causal analyses in the sequence of emulated trials. <code>estimand_type = "ITT"</code> will perform intention-to-treat analyses, where treatment switching after trial baselines are ignored.
<code>estimand_type = "PP"</code> will perform per-protocol analyses, where individuals' follow-ups are artificially censored
and inverse probability of treatment weighting is applied. <code>estimand_type = "As-Treated"</code> will fit a standard
marginal structural model for all possible treatment sequences, where individuals' follow-ups are not artificially
censored  but treatment switching after trial baselines are accounted for by applying inverse probability of
treatment weighting.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_switch_n_cov">switch_n_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the numerator terms of the inverse
probability of treatment weights. A derived variable named <code>time_on_regime</code> containing the duration of time that
the individual has been on the current treatment/non-treatment is available for use in these models.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_switch_d_cov">switch_d_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the denominator terms of the inverse
probability of treatment weights.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_first_period">first_period</code></td>
<td>
<p>First time period to be set as trial baseline  to start expanding the data.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_last_period">last_period</code></td>
<td>
<p>Last time period to be set as trial baseline  to start expanding the data.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_use_censor_weights">use_censor_weights</code></td>
<td>
<p>Require the inverse probability of censoring weights. If <code>use_censor_weights = TRUE</code>, then
the variable name of the censoring indicator needs to be provided in the argument <code>cense</code>.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_cense">cense</code></td>
<td>
<p>Variable name for the censoring indicator. Required if <code>use_censor_weights = TRUE</code>.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_pool_cense">pool_cense</code></td>
<td>
<p>Fit pooled or separate censoring models for those treated and those untreated at the immediately
previous visit. Pooling can be specified for the models for the numerator and denominator terms of the inverse
probability of censoring weights. One of <code>"none"</code>, <code>"numerator"</code>, or <code>"both"</code> (default is <code>"none"</code> except when
<code>estimand_type = "ITT"</code> then default is <code>"numerator"</code>).</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_cense_d_cov">cense_d_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the denominator terms of the inverse
probability of censoring weights.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_cense_n_cov">cense_n_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the numerator terms of the inverse
probability of censoring weights.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_eligible_wts_0">eligible_wts_0</code></td>
<td>
<p>See definition for <code>eligible_wts_1</code></p>
</td></tr>
<tr><td><code id="data_preparation_+3A_eligible_wts_1">eligible_wts_1</code></td>
<td>
<p>Exclude some observations when fitting the models for the inverse probability of treatment
weights. For example, if it is assumed that an individual will stay on treatment for at least 2 visits, the first 2
visits  after treatment initiation by definition have a probability of staying on the treatment of 1.0 and should
thus be excluded from the weight models for those who are on treatment at the immediately previous visit. Users can
define a variable that indicates that these 2 observations are ineligible for the weight model for those who are on
treatment at the immediately previous visit and add the variable name in the argument <code>eligible_wts_1</code>. Similar
definitions are applied to <code>eligible_wts_0</code> for excluding observations when fitting the models for the inverse
probability of treatment weights for those who are not on treatment at the immediately previous visit.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_where_var">where_var</code></td>
<td>
<p>Specify the variable names that will be used to define subgroup conditions when fitting the marginal
structural model for a subgroup of individuals. Need to specify jointly with the argument <code>where_case</code>.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_data_dir">data_dir</code></td>
<td>
<p>Directory to save model objects when <code>save_weight_models=TRUE</code> and expanded data as separate CSV
files names as <code>trial_i.csv</code>s if <code>separate_files = TRUE</code>. If the specified directory does not exist it will be
created. If the directory already contains trial files, an error will occur, other files may be overwritten.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_save_weight_models">save_weight_models</code></td>
<td>
<p>Save model objects for estimating the weights in <code>data_dir</code>.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_glm_function">glm_function</code></td>
<td>
<p>Specify which glm function to use for the marginal structural model from the <code>stats</code> or <code>parglm</code>
packages. The default function is the <code>glm</code> function in the <code>stats</code> package. Users can also specify <code>glm_function = "parglm"</code> such that the <code>parglm</code> function in the <code>parglm</code> package can be used for fitting generalized linear models
in parallel. The default control setting for  <code>parglm</code> is <code>nthreads = 4</code> and <code>method = "FAST"</code>, where four cores
and Fisher information are used for faster computation. Users can change the default control setting by passing the
arguments <code>nthreads</code> and <code>method</code> in the <code>parglm.control</code> function of the <code>parglm</code> package, or alternatively, by
passing a <code>control</code> argument with a list produced by <code>parglm.control(nthreads = , method = )</code>.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_chunk_size">chunk_size</code></td>
<td>
<p>Number of individuals whose data to  be processed in one chunk when <code>separate_files = TRUE</code></p>
</td></tr>
<tr><td><code id="data_preparation_+3A_separate_files">separate_files</code></td>
<td>
<p>Save expanded data in separate CSV files for each trial.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_quiet">quiet</code></td>
<td>
<p>Suppress the printing of progress messages and summaries of the fitted models.</p>
</td></tr>
<tr><td><code id="data_preparation_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to <code>glm_function</code>. This may be used to specify initial values of parameters or
arguments to <code>control</code>. See <a href="stats.html#topic+glm">stats::glm</a>, <a href="parglm.html#topic+parglm">parglm::parglm</a> and <code><a href="parglm.html#topic+parglm.control">parglm::parglm.control()</a></code> for more information.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The arguments <code>chunk_size</code> and <code>separate_files</code> allow for processing of large datasets that would not fit in
memory once expanded. When <code>separate_files = TRUE</code>, the input data are processed in chunks of individuals and saved
into separate files for each emulated trial. These separate files can be sampled by case-control sampling to create
a reduced dataset for the modelling.
</p>


<h3>Value</h3>

<p>An object of class <code>TE_data_prep</code>, which can either be sampled from (<a href="#topic+case_control_sampling_trials">case_control_sampling_trials</a>) or
directly used in a model (<a href="#topic+trial_msm">trial_msm</a>). It contains the elements
</p>

<dl>
<dt>data</dt><dd><p>the expanded dataset for all emulated trials. If <code>separate_files = FALSE</code>, it is  a <code>data.table</code>; if
<code>separate_files = TRUE</code>, it is a character vector with the file path of the expanded data as CSV files.</p>
</dd>
<dt>min_period</dt><dd><p>index for the first trial in the expanded data</p>
</dd>
<dt>max_period</dt><dd><p>index for the last trial in the expanded data</p>
</dd>
<dt>N</dt><dd><p>the total number of observations in the expanded data</p>
</dd>
<dt>data_template</dt><dd><p>a zero-row <code>data.frame</code>  with the columns and attributes of the expanded data</p>
</dd>
<dt>switch_models</dt><dd><p>a list of summaries of the models fitted for inverse probability of treatment weights,
if <code>estimand_type</code> is <code>"PP"</code> or <code>"As-Treated"</code></p>
</dd>
<dt>censor_models</dt><dd><p>a list of summaries of the models fitted for inverse probability of censoring weights,
if <code>use_censor_weights=TRUE</code></p>
</dd>
<dt>args</dt><dd><p>a list contain the parameters used to prepare the data and fit the weight models</p>
</dd>
</dl>


<hr>
<h2 id='expand'>Expand Function</h2><span id='topic+expand'></span>

<h3>Description</h3>

<p>This function performs the data expansion for a given dataset
</p>


<h3>Usage</h3>

<pre><code class='language-R'>expand(
  sw_data,
  outcomeCov_var,
  where_var,
  use_censor,
  maxperiod,
  minperiod,
  keeplist
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="expand_+3A_sw_data">sw_data</code></td>
<td>
<p>datatable to expand</p>
</td></tr>
<tr><td><code id="expand_+3A_outcomecov_var">outcomeCov_var</code></td>
<td>
<p>A list of individual baseline variables used in final model</p>
</td></tr>
<tr><td><code id="expand_+3A_where_var">where_var</code></td>
<td>
<p>Variables used in where conditions used in subsetting the data used in final analysis (where_case),
the variables not included in the final model</p>
</td></tr>
<tr><td><code id="expand_+3A_use_censor">use_censor</code></td>
<td>
<p>Use censoring for per-protocol analysis - censor person-times once a person-trial stops taking the
initial treatment value</p>
</td></tr>
<tr><td><code id="expand_+3A_maxperiod">maxperiod</code></td>
<td>
<p>Maximum period</p>
</td></tr>
<tr><td><code id="expand_+3A_minperiod">minperiod</code></td>
<td>
<p>Minimum period</p>
</td></tr>
<tr><td><code id="expand_+3A_keeplist">keeplist</code></td>
<td>
<p>A list contains names of variables used in final model</p>
</td></tr>
</table>

<hr>
<h2 id='expand_until_switch'>Check Expand Flag After Treatment Switch</h2><span id='topic+expand_until_switch'></span>

<h3>Description</h3>

<p>Check if patients have switched treatment in eligible trials
and set <code>expand = 0</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>expand_until_switch(s, n)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="expand_until_switch_+3A_s">s</code></td>
<td>
<p>numeric vector where <code>1</code> indicates a treatment switch in that period</p>
</td></tr>
<tr><td><code id="expand_until_switch_+3A_n">n</code></td>
<td>
<p>length of s</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Vector of indicator values up until first switch.
</p>

<hr>
<h2 id='initiators'>A wrapper function to perform data preparation and model fitting in a sequence of emulated target trials</h2><span id='topic+initiators'></span>

<h3>Description</h3>

<p>An all-in-one analysis using a sequence of emulated target trials. This provides a simplified interface to the main
functions <code><a href="#topic+data_preparation">data_preparation()</a></code> and <code><a href="#topic+trial_msm">trial_msm()</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>initiators(
  data,
  id = "id",
  period = "period",
  treatment = "treatment",
  outcome = "outcome",
  eligible = "eligible",
  outcome_cov = ~1,
  estimand_type = c("ITT", "PP", "As-Treated"),
  model_var = NULL,
  switch_n_cov = ~1,
  switch_d_cov = ~1,
  first_period = NA,
  last_period = NA,
  first_followup = NA,
  last_followup = NA,
  use_censor_weights = FALSE,
  save_weight_models = FALSE,
  analysis_weights = c("asis", "unweighted", "p99", "weight_limits"),
  weight_limits = c(0, Inf),
  cense = NA,
  pool_cense = c("none", "both", "numerator"),
  cense_d_cov = ~1,
  cense_n_cov = ~1,
  include_followup_time = ~followup_time + I(followup_time^2),
  include_trial_period = ~trial_period + I(trial_period^2),
  eligible_wts_0 = NA,
  eligible_wts_1 = NA,
  where_var = NULL,
  where_case = NA,
  data_dir,
  glm_function = "glm",
  quiet = FALSE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="initiators_+3A_data">data</code></td>
<td>
<p>A <code>data.frame</code> containing all the required variables in the person-time format, i.e., the  &lsquo;long&rsquo; format.</p>
</td></tr>
<tr><td><code id="initiators_+3A_id">id</code></td>
<td>
<p>Name of the variable for identifiers of the individuals.  Default is &lsquo;id&rsquo;.</p>
</td></tr>
<tr><td><code id="initiators_+3A_period">period</code></td>
<td>
<p>Name of the variable for the visit/period.   Default is &lsquo;period&rsquo;.</p>
</td></tr>
<tr><td><code id="initiators_+3A_treatment">treatment</code></td>
<td>
<p>Name of the variable  for the treatment indicator at that visit/period. Default is &lsquo;treatment&rsquo;.</p>
</td></tr>
<tr><td><code id="initiators_+3A_outcome">outcome</code></td>
<td>
<p>Name of the variable for the indicator of the outcome event at that visit/period.  Default is
&lsquo;outcome&rsquo;.</p>
</td></tr>
<tr><td><code id="initiators_+3A_eligible">eligible</code></td>
<td>
<p>Name of the variable for the indicator of eligibility for the target trial at that visit/period.
Default is &lsquo;eligible&rsquo;.</p>
</td></tr>
<tr><td><code id="initiators_+3A_outcome_cov">outcome_cov</code></td>
<td>
<p>A RHS formula with baseline covariates to be adjusted for in the marginal structural model for the
emulated trials. Note that if a time-varying covariate is specified in <code>outcome_cov</code>, only its value at each of the
trial baselines will be included in the expanded data.</p>
</td></tr>
<tr><td><code id="initiators_+3A_estimand_type">estimand_type</code></td>
<td>
<p>Specify the estimand for the causal analyses in the sequence of emulated trials. <code>estimand_type = "ITT"</code> will perform intention-to-treat analyses, where treatment switching after trial baselines are ignored.
<code>estimand_type = "PP"</code> will perform per-protocol analyses, where individuals' follow-ups are artificially censored
and inverse probability of treatment weighting is applied. <code>estimand_type = "As-Treated"</code> will fit a standard
marginal structural model for all possible treatment sequences, where individuals' follow-ups are not artificially
censored  but treatment switching after trial baselines are accounted for by applying inverse probability of
treatment weighting.</p>
</td></tr>
<tr><td><code id="initiators_+3A_model_var">model_var</code></td>
<td>
<p>Treatment variables to be included in the marginal structural model for the emulated trials.
<code>model_var = "assigned_treatment"</code> will create a variable <code>assigned_treatment</code> that is the assigned treatment at
the trial baseline, typically used for ITT and per-protocol analyses. <code>model_var = "dose"</code> will create a variable
<code>dose</code> that is the cumulative number of  treatments received since the trial baseline, typically used in as-treated
analyses.</p>
</td></tr>
<tr><td><code id="initiators_+3A_switch_n_cov">switch_n_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the numerator terms of the inverse
probability of treatment weights. A derived variable named <code>time_on_regime</code> containing the duration of time that
the individual has been on the current treatment/non-treatment is available for use in these models.</p>
</td></tr>
<tr><td><code id="initiators_+3A_switch_d_cov">switch_d_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the denominator terms of the inverse
probability of treatment weights.</p>
</td></tr>
<tr><td><code id="initiators_+3A_first_period">first_period</code></td>
<td>
<p>First time period to be set as trial baseline  to start expanding the data.</p>
</td></tr>
<tr><td><code id="initiators_+3A_last_period">last_period</code></td>
<td>
<p>Last time period to be set as trial baseline  to start expanding the data.</p>
</td></tr>
<tr><td><code id="initiators_+3A_first_followup">first_followup</code></td>
<td>
<p>First follow-up time/visit in the trials to be included in the marginal structural model for
the outcome event.</p>
</td></tr>
<tr><td><code id="initiators_+3A_last_followup">last_followup</code></td>
<td>
<p>Last follow-up time/visit in the trials to be included in the marginal structural model for the
outcome event.</p>
</td></tr>
<tr><td><code id="initiators_+3A_use_censor_weights">use_censor_weights</code></td>
<td>
<p>Require the inverse probability of censoring weights. If <code>use_censor_weights = TRUE</code>, then
the variable name of the censoring indicator needs to be provided in the argument <code>cense</code>.</p>
</td></tr>
<tr><td><code id="initiators_+3A_save_weight_models">save_weight_models</code></td>
<td>
<p>Save model objects for estimating the weights in <code>data_dir</code>.</p>
</td></tr>
<tr><td><code id="initiators_+3A_analysis_weights">analysis_weights</code></td>
<td>
<p>Choose which type of weights to be used for fitting the marginal structural model for the
outcome event.
</p>

<ul>
<li> <p><code>"asis"</code>: use the weights as calculated.
</p>
</li>
<li> <p><code>"p99"</code>: use weights truncated at the 1st and 99th percentiles (based on the distribution of weights
in the entire sample).
</p>
</li>
<li> <p><code>"weight_limits"</code>: use weights truncated at the values specified in <code>weight_limits</code>.
</p>
</li>
<li> <p><code>"unweighted"</code>: set all analysis weights to 1, even if treatment weights or censoring weights were calculated.
</p>
</li></ul>
</td></tr>
<tr><td><code id="initiators_+3A_weight_limits">weight_limits</code></td>
<td>
<p>Lower and upper limits to truncate weights, given as <code>c(lower, upper)</code></p>
</td></tr>
<tr><td><code id="initiators_+3A_cense">cense</code></td>
<td>
<p>Variable name for the censoring indicator. Required if <code>use_censor_weights = TRUE</code>.</p>
</td></tr>
<tr><td><code id="initiators_+3A_pool_cense">pool_cense</code></td>
<td>
<p>Fit pooled or separate censoring models for those treated and those untreated at the immediately
previous visit. Pooling can be specified for the models for the numerator and denominator terms of the inverse
probability of censoring weights. One of <code>"none"</code>, <code>"numerator"</code>, or <code>"both"</code> (default is <code>"none"</code> except when
<code>estimand_type = "ITT"</code> then default is <code>"numerator"</code>).</p>
</td></tr>
<tr><td><code id="initiators_+3A_cense_d_cov">cense_d_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the denominator terms of the inverse
probability of censoring weights.</p>
</td></tr>
<tr><td><code id="initiators_+3A_cense_n_cov">cense_n_cov</code></td>
<td>
<p>A RHS formula to specify the logistic models for estimating the numerator terms of the inverse
probability of censoring weights.</p>
</td></tr>
<tr><td><code id="initiators_+3A_include_followup_time">include_followup_time</code></td>
<td>
<p>The model to include the follow up time/visit of the trial (<code>followup_time</code>) in the
marginal structural model, specified as a RHS formula.</p>
</td></tr>
<tr><td><code id="initiators_+3A_include_trial_period">include_trial_period</code></td>
<td>
<p>The model to include the trial period (<code>trial_period</code>) in the marginal structural model,
specified as a RHS formula.</p>
</td></tr>
<tr><td><code id="initiators_+3A_eligible_wts_0">eligible_wts_0</code></td>
<td>
<p>See definition for <code>eligible_wts_1</code></p>
</td></tr>
<tr><td><code id="initiators_+3A_eligible_wts_1">eligible_wts_1</code></td>
<td>
<p>Exclude some observations when fitting the models for the inverse probability of treatment
weights. For example, if it is assumed that an individual will stay on treatment for at least 2 visits, the first 2
visits  after treatment initiation by definition have a probability of staying on the treatment of 1.0 and should
thus be excluded from the weight models for those who are on treatment at the immediately previous visit. Users can
define a variable that indicates that these 2 observations are ineligible for the weight model for those who are on
treatment at the immediately previous visit and add the variable name in the argument <code>eligible_wts_1</code>. Similar
definitions are applied to <code>eligible_wts_0</code> for excluding observations when fitting the models for the inverse
probability of treatment weights for those who are not on treatment at the immediately previous visit.</p>
</td></tr>
<tr><td><code id="initiators_+3A_where_var">where_var</code></td>
<td>
<p>Specify the variable names that will be used to define subgroup conditions when fitting the marginal
structural model for a subgroup of individuals. Need to specify jointly with the argument <code>where_case</code>.</p>
</td></tr>
<tr><td><code id="initiators_+3A_where_case">where_case</code></td>
<td>
<p>Define conditions using variables specified in <code>where_var</code> when fitting a marginal structural model
for a subgroup of the individuals. For example, if <code>where_var= "age"</code>, <code>where_case = "age &gt;= 30"</code> will only fit the
marginal structural model to the subgroup of individuals. who are 30 years old or above.</p>
</td></tr>
<tr><td><code id="initiators_+3A_data_dir">data_dir</code></td>
<td>
<p>Directory to save model objects in.</p>
</td></tr>
<tr><td><code id="initiators_+3A_glm_function">glm_function</code></td>
<td>
<p>Specify which glm function to use for the marginal structural model from the <code>stats</code> or <code>parglm</code>
packages. The default function is the <code>glm</code> function in the <code>stats</code> package. Users can also specify <code>glm_function = "parglm"</code> such that the <code>parglm</code> function in the <code>parglm</code> package can be used for fitting generalized linear models
in parallel. The default control setting for  <code>parglm</code> is <code>nthreads = 4</code> and <code>method = "FAST"</code>, where four cores
and Fisher information are used for faster computation. Users can change the default control setting by passing the
arguments <code>nthreads</code> and <code>method</code> in the <code>parglm.control</code> function of the <code>parglm</code> package, or alternatively, by
passing a <code>control</code> argument with a list produced by <code>parglm.control(nthreads = , method = )</code>.</p>
</td></tr>
<tr><td><code id="initiators_+3A_quiet">quiet</code></td>
<td>
<p>Suppress the printing of progress messages and summaries of the fitted models.</p>
</td></tr>
<tr><td><code id="initiators_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to <code>glm_function</code>. This may be used to specify initial values of parameters or
arguments to <code>control</code>. See <a href="stats.html#topic+glm">stats::glm</a>, <a href="parglm.html#topic+parglm">parglm::parglm</a> and <code><a href="parglm.html#topic+parglm.control">parglm::parglm.control()</a></code> for more information.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns the result of <code><a href="#topic+trial_msm">trial_msm()</a></code> from the expanded data. An object of class <code>TE_msm</code> containing
</p>

<dl>
<dt>model</dt><dd><p>a <code>glm</code> object</p>
</dd>
<dt>robust</dt><dd><p>a list containing a summary table of estimated regression coefficients and the robust covariance
matrix</p>
</dd>
</dl>


<hr>
<h2 id='predict.TE_msm'>Predict marginal cumulative incidences with confidence intervals for a target trial population</h2><span id='topic+predict.TE_msm'></span>

<h3>Description</h3>

<p>This function predicts the marginal cumulative incidences when a target trial population receives either the
treatment or non-treatment at baseline (for an intention-to-treat analysis) or either sustained treatment or
sustained non-treatment (for a per-protocol analysis). The difference between these cumulative incidences is the
estimated causal effect of treatment. Currently, the <code>predict</code> function only provides marginal intention-to-treat and
per-protocol effects, therefore it is only valid when <code>estimand_type = "ITT"</code> or <code>estimand_type = "PP"</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'TE_msm'
predict(
  object,
  newdata,
  predict_times,
  conf_int = TRUE,
  samples = 100,
  type = c("cum_inc", "survival"),
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="predict.TE_msm_+3A_object">object</code></td>
<td>
<p>Object from <code><a href="#topic+trial_msm">trial_msm()</a></code> or <code><a href="#topic+initiators">initiators()</a></code>.</p>
</td></tr>
<tr><td><code id="predict.TE_msm_+3A_newdata">newdata</code></td>
<td>
<p>Baseline trial data that characterise the target trial population that marginal cumulative incidences
or survival probabilities are predicted for.  <code>newdata</code> must have the same columns and formats of variables as in
the fitted marginal structural model specified in <code><a href="#topic+trial_msm">trial_msm()</a></code> or <code><a href="#topic+initiators">initiators()</a></code>. If <code>newdata</code> contains rows with
<code>followup_time &gt; 0</code> these will be removed.</p>
</td></tr>
<tr><td><code id="predict.TE_msm_+3A_predict_times">predict_times</code></td>
<td>
<p>Specify the follow-up visits/times where the marginal cumulative incidences or survival
probabilities are predicted.</p>
</td></tr>
<tr><td><code id="predict.TE_msm_+3A_conf_int">conf_int</code></td>
<td>
<p>Construct the point-wise 95-percent confidence intervals of cumulative incidences for the target
trial population under treatment and non-treatment and their differences by simulating the parameters in the
marginal structural model from a multivariate normal distribution with the mean equal to the marginal structural
model parameter estimates and the variance equal to the estimated robust covariance matrix.</p>
</td></tr>
<tr><td><code id="predict.TE_msm_+3A_samples">samples</code></td>
<td>
<p>Number of samples used to construct the simulation-based confidence intervals.</p>
</td></tr>
<tr><td><code id="predict.TE_msm_+3A_type">type</code></td>
<td>
<p>Specify cumulative incidences or survival probabilities to be predicted. Either cumulative incidence
(<code>"cum_inc"</code>) or survival probability (<code>"survival"</code>).</p>
</td></tr>
<tr><td><code id="predict.TE_msm_+3A_...">...</code></td>
<td>
<p>Further arguments passed to or from other methods.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list of three data frames containing the cumulative incidences for each of the assigned treatment options
(treatment and non-treatment) and the difference between them.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># If necessary set the number of `data.table` threads
data.table::setDTthreads(2)

data("te_model_ex")
predicted_ci &lt;- predict(te_model_ex, predict_times = 0:30, samples = 10)

# Plot the cumulative incidence curves under treatment and non-treatment
plot(predicted_ci[[1]]$followup_time, predicted_ci[[1]]$cum_inc,
  type = "l",
  xlab = "Follow-up Time", ylab = "Cumulative Incidence",
  ylim = c(0, 0.7)
)
lines(predicted_ci[[1]]$followup_time, predicted_ci[[1]]$`2.5%`, lty = 2)
lines(predicted_ci[[1]]$followup_time, predicted_ci[[1]]$`97.5%`, lty = 2)

lines(predicted_ci[[2]]$followup_time, predicted_ci[[2]]$cum_inc, type = "l", col = 2)
lines(predicted_ci[[2]]$followup_time, predicted_ci[[2]]$`2.5%`, lty = 2, col = 2)
lines(predicted_ci[[2]]$followup_time, predicted_ci[[2]]$`97.5%`, lty = 2, col = 2)
legend("topleft", title = "Assigned Treatment", legend = c("0", "1"), col = 1:2, lty = 1)

# Plot the difference in cumulative incidence over follow up
plot(predicted_ci[[3]]$followup_time, predicted_ci[[3]]$cum_inc_diff,
  type = "l",
  xlab = "Follow-up Time", ylab = "Difference in Cumulative Incidence",
  ylim = c(0.0, 0.5)
)
lines(predicted_ci[[3]]$followup_time, predicted_ci[[3]]$`2.5%`, lty = 2)
lines(predicted_ci[[3]]$followup_time, predicted_ci[[3]]$`97.5%`, lty = 2)

</code></pre>

<hr>
<h2 id='print.TE_weight_summary'>Print a weight summary object</h2><span id='topic+print.TE_weight_summary'></span>

<h3>Description</h3>

<p>Print a weight summary object
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'TE_weight_summary'
print(x, full = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="print.TE_weight_summary_+3A_x">x</code></td>
<td>
<p>print TE_weight_summary object.</p>
</td></tr>
<tr><td><code id="print.TE_weight_summary_+3A_full">full</code></td>
<td>
<p>Print full or short summary.</p>
</td></tr>
<tr><td><code id="print.TE_weight_summary_+3A_...">...</code></td>
<td>
<p>Arguments passed to <a href="base.html#topic+print.data.frame">print.data.frame</a>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>No return value, only for printing.
</p>

<hr>
<h2 id='robust_calculation'>Robust Variance Calculation</h2><span id='topic+robust_calculation'></span>

<h3>Description</h3>

<p>This function performs the calculation of robust standard errors based on
variances estimated using <code><a href="sandwich.html#topic+vcovCL">sandwich::vcovCL</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>robust_calculation(model, data_id)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="robust_calculation_+3A_model">model</code></td>
<td>
<p>The logistic regression model object.</p>
</td></tr>
<tr><td><code id="robust_calculation_+3A_data_id">data_id</code></td>
<td>
<p>Values of id column of the data (ie <code>data[, id]</code>) to identify clusters.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list with elements <code>summary</code>, a table with the model summary using the
robust variance estimates, and <code>matrix</code>, the <code>sandwich</code> covariance matrix.
</p>

<hr>
<h2 id='select_data_cols'>Select Data Columns</h2><span id='topic+select_data_cols'></span>

<h3>Description</h3>

<p>Select the required columns from the data and rename
</p>


<h3>Usage</h3>

<pre><code class='language-R'>select_data_cols(data, args)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="select_data_cols_+3A_data">data</code></td>
<td>
<p>A <code>data.frame</code> containing all the required columns</p>
</td></tr>
<tr><td><code id="select_data_cols_+3A_args">args</code></td>
<td>
<p>List of arguments from <code>data_preparation</code></p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data.table with the required columns
</p>

<hr>
<h2 id='summary.TE_data_prep'>Summary methods</h2><span id='topic+summary.TE_data_prep'></span><span id='topic+summary.TE_data_prep_sep'></span><span id='topic+summary.TE_data_prep_dt'></span><span id='topic+summary.TE_msm'></span><span id='topic+summary.TE_robust'></span>

<h3>Description</h3>

<p>Print summaries of data and model objects produced by <code>TrialEmulation</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'TE_data_prep'
summary(object, ...)

## S3 method for class 'TE_data_prep_sep'
summary(object, ...)

## S3 method for class 'TE_data_prep_dt'
summary(object, ...)

## S3 method for class 'TE_msm'
summary(object, ...)

## S3 method for class 'TE_robust'
summary(object, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="summary.TE_data_prep_+3A_object">object</code></td>
<td>
<p>Object to print summary</p>
</td></tr>
<tr><td><code id="summary.TE_data_prep_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to print methods.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>No value, displays summaries of object.
</p>

<hr>
<h2 id='te_data_ex'>Example of a prepared data object</h2><span id='topic+te_data_ex'></span>

<h3>Description</h3>

<p>A small example object from <a href="#topic+data_preparation">data_preparation</a> used in examples.
It is created with the following code:
</p>


<h3>Usage</h3>

<pre><code class='language-R'>te_data_ex
</code></pre>


<h3>Format</h3>

<p>An object of class <code>TE_data_prep_dt</code> (inherits from <code>TE_data_prep</code>) of length 6.
</p>


<h3>Details</h3>

<div class="sourceCode r"><pre>dat &lt;- trial_example[trial_example$id &lt; 200, ]

te_data_ex &lt;- data_preparation(
data = dat,
 outcome_cov = c("nvarA", "catvarA"),
 first_period = 260,
 last_period = 280
)
</pre></div>


<h3>See Also</h3>

<p><a href="#topic+te_model_ex">te_model_ex</a>
</p>

<hr>
<h2 id='te_model_ex'>Example of a fitted marginal structural model object</h2><span id='topic+te_model_ex'></span>

<h3>Description</h3>

<p>A small example object from <a href="#topic+trial_msm">trial_msm</a> used in examples. It is created with the
following code:
</p>


<h3>Usage</h3>

<pre><code class='language-R'>te_model_ex
</code></pre>


<h3>Format</h3>

<p>An object of class <code>TE_msm</code> of length 3.
</p>


<h3>Details</h3>

<div class="sourceCode r"><pre>te_model_ex &lt;- trial_msm(
 data = data_subset,
 outcome_cov = c("catvarA", "nvarA"),
 last_followup = 40,
 model_var = "assigned_treatment",
 include_followup_time = ~followup_time,
 include_trial_period = ~trial_period,
 use_sample_weights = FALSE,
 quiet = TRUE,
 glm_function = "glm"
 )
</pre></div>


<h3>See Also</h3>

<p><a href="#topic+te_data_ex">te_data_ex</a>
</p>

<hr>
<h2 id='trial_example'>Example of longitudinal data for sequential trial emulation</h2><span id='topic+trial_example'></span>

<h3>Description</h3>

<p>A dataset containing the treatment, outcomes and other attributes of 503 patients for sequential trial emulation.
See <code>vignette("Getting-Started")</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>trial_example
</code></pre>


<h3>Format</h3>

<p>A data frame with 48400 rows and 11 variables:
</p>

<dl>
<dt>id</dt><dd><p>patient identifier</p>
</dd>
<dt>eligible</dt><dd><p>eligible for trial start in this period, 1=yes, 0=no</p>
</dd>
<dt>period</dt><dd><p>time period</p>
</dd>
<dt>outcome</dt><dd><p>indicator for outcome in this period, 1=event occurred, 0=no event</p>
</dd>
<dt>treatment</dt><dd><p>indicator for receiving treatment in this period, 1=treatment, 0=no treatment</p>
</dd>
<dt>catvarA</dt><dd><p>A categorical variable relating to treatment and the outcome</p>
</dd>
<dt>catvarB</dt><dd><p>A categorical variable relating to treatment and the outcome</p>
</dd>
<dt>catvarC</dt><dd><p>A categorical variable relating to treatment and the outcome</p>
</dd>
<dt>nvarA</dt><dd><p>A numerical variable relating to treatment and the outcome</p>
</dd>
<dt>nvarB</dt><dd><p>A numerical variable relating to treatment and the outcome</p>
</dd>
<dt>nvarC</dt><dd><p>A numerical variable relating to treatment and the outcome</p>
</dd>
</dl>


<hr>
<h2 id='trial_msm'>Fit the marginal structural model for the sequence of emulated trials</h2><span id='topic+trial_msm'></span>

<h3>Description</h3>

<p>Apply a weighted pooled logistic regression to fit the marginal structural model for the sequence of emulated trials
and calculates the robust covariance matrix  of parameter using the sandwich estimator.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>trial_msm(
  data,
  outcome_cov = ~1,
  estimand_type = c("ITT", "PP", "As-Treated"),
  model_var = NULL,
  first_followup = NA,
  last_followup = NA,
  analysis_weights = c("asis", "unweighted", "p99", "weight_limits"),
  weight_limits = c(0, Inf),
  include_followup_time = ~followup_time + I(followup_time^2),
  include_trial_period = ~trial_period + I(trial_period^2),
  where_case = NA,
  glm_function = c("glm", "parglm"),
  use_sample_weights = TRUE,
  quiet = FALSE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="trial_msm_+3A_data">data</code></td>
<td>
<p>A <code>data.frame</code> containing all the required variables in the person-time format, i.e., the  &lsquo;long&rsquo; format.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_outcome_cov">outcome_cov</code></td>
<td>
<p>A RHS formula with baseline covariates to be adjusted for in the marginal structural model for the
emulated trials. Note that if a time-varying covariate is specified in <code>outcome_cov</code>, only its value at each of the
trial baselines will be included in the expanded data.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_estimand_type">estimand_type</code></td>
<td>
<p>Specify the estimand for the causal analyses in the sequence of emulated trials. <code>estimand_type = "ITT"</code> will perform intention-to-treat analyses, where treatment switching after trial baselines are ignored.
<code>estimand_type = "PP"</code> will perform per-protocol analyses, where individuals' follow-ups are artificially censored
and inverse probability of treatment weighting is applied. <code>estimand_type = "As-Treated"</code> will fit a standard
marginal structural model for all possible treatment sequences, where individuals' follow-ups are not artificially
censored  but treatment switching after trial baselines are accounted for by applying inverse probability of
treatment weighting.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_model_var">model_var</code></td>
<td>
<p>Treatment variables to be included in the marginal structural model for the emulated trials.
<code>model_var = "assigned_treatment"</code> will create a variable <code>assigned_treatment</code> that is the assigned treatment at
the trial baseline, typically used for ITT and per-protocol analyses. <code>model_var = "dose"</code> will create a variable
<code>dose</code> that is the cumulative number of  treatments received since the trial baseline, typically used in as-treated
analyses.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_first_followup">first_followup</code></td>
<td>
<p>First follow-up time/visit in the trials to be included in the marginal structural model for
the outcome event.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_last_followup">last_followup</code></td>
<td>
<p>Last follow-up time/visit in the trials to be included in the marginal structural model for the
outcome event.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_analysis_weights">analysis_weights</code></td>
<td>
<p>Choose which type of weights to be used for fitting the marginal structural model for the
outcome event.
</p>

<ul>
<li> <p><code>"asis"</code>: use the weights as calculated.
</p>
</li>
<li> <p><code>"p99"</code>: use weights truncated at the 1st and 99th percentiles (based on the distribution of weights
in the entire sample).
</p>
</li>
<li> <p><code>"weight_limits"</code>: use weights truncated at the values specified in <code>weight_limits</code>.
</p>
</li>
<li> <p><code>"unweighted"</code>: set all analysis weights to 1, even if treatment weights or censoring weights were calculated.
</p>
</li></ul>
</td></tr>
<tr><td><code id="trial_msm_+3A_weight_limits">weight_limits</code></td>
<td>
<p>Lower and upper limits to truncate weights, given as <code>c(lower, upper)</code></p>
</td></tr>
<tr><td><code id="trial_msm_+3A_include_followup_time">include_followup_time</code></td>
<td>
<p>The model to include the follow up time/visit of the trial (<code>followup_time</code>) in the
marginal structural model, specified as a RHS formula.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_include_trial_period">include_trial_period</code></td>
<td>
<p>The model to include the trial period (<code>trial_period</code>) in the marginal structural model,
specified as a RHS formula.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_where_case">where_case</code></td>
<td>
<p>Define conditions using variables specified in <code>where_var</code> when fitting a marginal structural model
for a subgroup of the individuals. For example, if <code>where_var= "age"</code>, <code>where_case = "age &gt;= 30"</code> will only fit the
marginal structural model to the subgroup of individuals. who are 30 years old or above.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_glm_function">glm_function</code></td>
<td>
<p>Specify which glm function to use for the marginal structural model from the <code>stats</code> or <code>parglm</code>
packages. The default function is the <code>glm</code> function in the <code>stats</code> package. Users can also specify <code>glm_function = "parglm"</code> such that the <code>parglm</code> function in the <code>parglm</code> package can be used for fitting generalized linear models
in parallel. The default control setting for  <code>parglm</code> is <code>nthreads = 4</code> and <code>method = "FAST"</code>, where four cores
and Fisher information are used for faster computation. Users can change the default control setting by passing the
arguments <code>nthreads</code> and <code>method</code> in the <code>parglm.control</code> function of the <code>parglm</code> package, or alternatively, by
passing a <code>control</code> argument with a list produced by <code>parglm.control(nthreads = , method = )</code>.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_use_sample_weights">use_sample_weights</code></td>
<td>
<p>Use case-control sampling weights in addition to inverse probability weights for treatment
and censoring. <code>data</code> must contain a column <code>sample_weight</code>. The final weights used in the pooled logistic
regression are calculated as <code>weight = weight * sample_weight</code>.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_quiet">quiet</code></td>
<td>
<p>Suppress the printing of progress messages and summaries of the fitted models.</p>
</td></tr>
<tr><td><code id="trial_msm_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to <code>glm_function</code>. This may be used to specify initial values of parameters or
arguments to <code>control</code>. See <a href="stats.html#topic+glm">stats::glm</a>, <a href="parglm.html#topic+parglm">parglm::parglm</a> and <code><a href="parglm.html#topic+parglm.control">parglm::parglm.control()</a></code> for more information.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The model formula is constructed by combining the arguments <code>outcome_cov</code>, <code>model_var</code>,
<code>include_followup_time</code>, and <code>include_trial_period</code>.
</p>


<h3>Value</h3>

<p>Object of class <code>TE_msm</code> containing
</p>

<dl>
<dt>model</dt><dd><p>a <code>glm</code> object</p>
</dd>
<dt>robust</dt><dd><p>a list containing a summary table of estimated regression coefficients and the robust covariance
matrix</p>
</dd>
<dt>args</dt><dd><p>a list contain the parameters used to prepare and fit the model</p>
</dd>
</dl>


<hr>
<h2 id='vignette_switch_data'>Example of expanded longitudinal data for sequential trial emulation</h2><span id='topic+vignette_switch_data'></span>

<h3>Description</h3>

<p>This is the expanded dataset created in the <code>vignette("Getting-Started")</code> known as <code>switch_data</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>vignette_switch_data
</code></pre>


<h3>Format</h3>

<p>A data frame with 1939053 rows and 7 variables:
</p>

<dl>
<dt>id</dt><dd><p>patient identifier</p>
</dd>
<dt>trial_period</dt><dd><p>trial start time period</p>
</dd>
<dt>followup_time</dt><dd><p>follow up time within trial</p>
</dd>
<dt>outcome</dt><dd><p>indicator for outcome in this period, 1=event occurred, 0=no event</p>
</dd>
<dt>treatment</dt><dd><p>indicator for receiving treatment in this period, 1=treatment, 0=non-treatment</p>
</dd>
<dt>assigned_treatment</dt><dd><p>indicator for assigned treatment at baseline of the trial, 1=treatment, 0=non-treatment</p>
</dd>
<dt>weight</dt><dd><p>weights for use with model fitting</p>
</dd>
<dt>catvarA</dt><dd><p>A categorical variable relating to treatment and the outcome</p>
</dd>
<dt>catvarB</dt><dd><p>A categorical variable relating to treatment and the outcome</p>
</dd>
<dt>catvarC</dt><dd><p>A categorical variable relating to treatment and the outcome</p>
</dd>
<dt>nvarA</dt><dd><p>A numerical variable relating to treatment and the outcome</p>
</dd>
<dt>nvarB</dt><dd><p>A numerical variable relating to treatment and the outcome</p>
</dd>
<dt>nvarC</dt><dd><p>A numerical variable relating to treatment and the outcome</p>
</dd>
</dl>


</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
