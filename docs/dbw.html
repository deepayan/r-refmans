<!DOCTYPE html><html lang="en"><head><title>Help for package dbw</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {dbw}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#dbw'><p>Doubly robust distribution balancing weighting (DBW) estimation</p></a></li>
<li><a href='#plot.dbw'><p>Summarize and plot covariate balance</p></a></li>
<li><a href='#print.dbw'><p>Print the distribution balancing weighting estimation results</p></a></li>
<li><a href='#std_comp'><p>Generate standardized complete cases</p></a></li>
<li><a href='#summary.dbw'><p>Summarize the distribution balancing weighting estimation results</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Title:</td>
<td>Doubly Robust Distribution Balancing Weighting Estimation</td>
</tr>
<tr>
<td>Version:</td>
<td>1.1.4</td>
</tr>
<tr>
<td>Description:</td>
<td>Implements the doubly robust distribution balancing weighting proposed by Katsumata (2024) &lt;<a href="https://doi.org/10.1017%2Fpsrm.2024.23">doi:10.1017/psrm.2024.23</a>&gt;, which improves the augmented inverse probability weighting (AIPW) by estimating propensity scores with estimating equations suitable for the pre-specified parameter of interest (e.g., the average treatment effects or the average treatment effects on the treated) and estimating outcome models with the estimated inverse probability weights. It also implements the covariate balancing propensity score proposed by Imai and Ratkovic (2014) &lt;<a href="https://doi.org/10.1111%2Frssb.12027">doi:10.1111/rssb.12027</a>&gt; and the entropy balancing weighting proposed by Hainmueller (2012) &lt;<a href="https://doi.org/10.1093%2Fpan%2Fmpr025">doi:10.1093/pan/mpr025</a>&gt;, both of which use covariate balancing conditions in propensity score estimation. The point estimate of the parameter of interest and its uncertainty as well as coefficients for propensity score estimation and outcome regression are produced using the M-estimation. The same functions can be used to estimate average outcomes in missing outcome cases.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file LICENSE</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.2.3</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 2.10)</td>
</tr>
<tr>
<td>Suggests:</td>
<td>mgcv</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://github.com/hirotokatsumata/dbw">https://github.com/hirotokatsumata/dbw</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/hirotokatsumata/dbw/issues">https://github.com/hirotokatsumata/dbw/issues</a></td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2024-08-23 12:29:20 UTC; hkatsumata</td>
</tr>
<tr>
<td>Author:</td>
<td>Hiroto Katsumata <a href="https://orcid.org/0000-0001-5901-8844"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre, cph]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Hiroto Katsumata &lt;hrt.katsumata@gmail.com&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2024-08-28 08:10:16 UTC</td>
</tr>
</table>
<hr>
<h2 id='dbw'>Doubly robust distribution balancing weighting (DBW) estimation</h2><span id='topic+dbw'></span>

<h3>Description</h3>

<p><code>dbw</code> estimates a pre-specified parameter of interest (e.g.,
the average treatment effects (ATE) or the average treatment effects
on the treated (ATT)) with the augmented inverse probability weighting
(AIPW), where propensity scores are estimated using estimating
equations suitable for the parameter of interest and outcome models are
estimated using inverse probability weights. <code>dbw</code> can
also be used to estimate average outcomes (AO) in missing outcome cases.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>dbw(
  formula_y,
  formula_ps,
  estimand = "ATE",
  method = "dbw",
  method_y = "wls",
  data,
  normalize = TRUE,
  vcov = TRUE,
  lambda = 0,
  weights = NULL,
  clevel = 0.95,
  tol = 1e-10,
  init_lambda = 0.01
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="dbw_+3A_formula_y">formula_y</code></td>
<td>
<p>an object of class <code><a href="stats.html#topic+formula">formula</a></code> (or one that
can be coerced to that class): a symbolic description of the potential
outcome model to be fitted. This is a model for potential outcomes, so do not
include treatment variable in the model. When you want to use non-DR type
estimators, only include &quot;1&quot; in the right hand side of the formula for the
Hajek estimator and only include &quot;0&quot; for the Horvitz-Thompson estimator.
See example below for more details.</p>
</td></tr>
<tr><td><code id="dbw_+3A_formula_ps">formula_ps</code></td>
<td>
<p>an object of class <code><a href="stats.html#topic+formula">formula</a></code> (or one that
can be coerced to that class): a symbolic description of the propensity score
model to be fitted. For the entropy balancing weighting (<code>method = "eb"</code>),
variables in the right hand side of the formula will be mean balanced.</p>
</td></tr>
<tr><td><code id="dbw_+3A_estimand">estimand</code></td>
<td>
<p>a character string specifying a parameter of interest. Choose
&quot;ATT&quot; for the average treatment effects on the treated estimation, &quot;ATE&quot;
for the average treatment effects estimation, &quot;ATC&quot; for the average
outcomes estimation in missing outcome cases. You can choose &quot;ATEcombined&quot;
for the combined estimation for the average treatment effects estimation
when using the covariate balancing weighting (<code>method = "cb"</code>).</p>
</td></tr>
<tr><td><code id="dbw_+3A_method">method</code></td>
<td>
<p>a character string specifying a method for propensity score
estimation. Choose &quot;dbw&quot; for the distribution balancing weighting, &quot;cb&quot;
for the covariate balancing weighting, &quot;eb&quot; for the entropy balancing
weighting, and &quot;mle&quot; for the logistic regression with the maximum
likelihood estimation.</p>
</td></tr>
<tr><td><code id="dbw_+3A_method_y">method_y</code></td>
<td>
<p>a character string specifying a method for potential outcome
prediction. Choose &quot;wls&quot; for the linear model, &quot;logit&quot; for the logistic
regression, &quot;gam&quot; for the generalized additive model for the continuous
outcome, and &quot;gambinom&quot; for the generalized additive model for the binary
outcome. Note that variance-covariance matrix is calculated only when
<code>method_y = "wls"</code> or <code>method_y = "logit"</code>.</p>
</td></tr>
<tr><td><code id="dbw_+3A_data">data</code></td>
<td>
<p>a data frame (or one that can be coerced to that class)
containing the outcomes and the variables in the model.</p>
</td></tr>
<tr><td><code id="dbw_+3A_normalize">normalize</code></td>
<td>
<p>a logical parameter indicating whether to normalize the estimated
weights to sum up to one for each treatment group for <code>method = "dbw"</code>. Default is TRUE.</p>
</td></tr>
<tr><td><code id="dbw_+3A_vcov">vcov</code></td>
<td>
<p>a logical parameter indicating whether to estimate the variance.
Default is TRUE.</p>
</td></tr>
<tr><td><code id="dbw_+3A_lambda">lambda</code></td>
<td>
<p>a parameter taking 0 or larger specifying the degree of the
L2-regularization for propensity score estimation. <code>lambda = 0</code> (default)
means no regularization.</p>
</td></tr>
<tr><td><code id="dbw_+3A_weights">weights</code></td>
<td>
<p>an optional vector of ‘prior weights’ (e.g. sampling weights)
to be used in the fitting process. Should be NULL or a numeric vector.</p>
</td></tr>
<tr><td><code id="dbw_+3A_clevel">clevel</code></td>
<td>
<p>confidence levels. Default is 0.95.</p>
</td></tr>
<tr><td><code id="dbw_+3A_tol">tol</code></td>
<td>
<p>a tolerance parameter for <code>method = "dbw"</code>. Default is 1e-10.</p>
</td></tr>
<tr><td><code id="dbw_+3A_init_lambda">init_lambda</code></td>
<td>
<p>a parameter for <code>method = "dbw"</code> to set the lambda value
for the initial values estimation, where <code class="reqn">lambda_init = lambda * init_lambda</code>.
Default is 0.01.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The treatment variable (or, response variable in missing outcome cases)
must be binary and coded as 0 (for controlled or missing observations)
or 1 (for treated or non-missing observations).
</p>
<p>When the data frame has incomplete cases, which have NAs for either of
the treatment variable, the outcome variable, or explanatory variables
either for propensity score or outcome model estimation, <code>dbw</code> conducts
listwise deletion. Returned values (e.g., <code>est_weights</code>, <code>ps</code>, <code>data</code>)
do not contain values for these deleted cases.
</p>
<p>For propensity score estimation, <code>dbw</code> can utilize the distribution
balancing weighting (<code>method = "dbw"</code>), covariate balancing weighting
(<code>method = "cb"</code>), entropy balancing weighting (<code>method = "eb"</code>), or
standard maximum likelihood estimation (<code>method = "mle"</code>). For the
covariate balancing weighting and entropy balancing weighting, <code>dbw</code> runs
much faster than the original functions (<code><a href="CBPS.html#topic+CBPS">CBPS</a></code> and <code><a href="ebal.html#topic+ebalance">ebalance</a></code>)
by using loss-function-based algorithms, which also results in more
accurate covariate balance. For the ATT and ATC estimation, the distribution
balancing weighting, covariate balancing weighting, and entropy balancing
weighting are theoretically equivalent and <code>dbw</code> implements accordingly.
</p>
<p>The parameter of interest is estimated by the AIPW estimator, where inverse
probability weights are standardized within each treatment group by being
devided by the size of the group after being calculated as
<code class="reqn">t_i / \pi_i - (1 - t_i) / (1 - \pi_i)</code> for the ATE estimation,
<code class="reqn">(t_i - \pi_i) / (1 - \pi_i)</code> for the ATT estimation,
<code class="reqn">(t_i - \pi_i) / \pi_i</code> for the ATC estimation, and
<code class="reqn">t_i / \pi_i</code> for the missing outcome cases. The resulting inverse probability
weights sum to 1 for the distribution balancing weighting, covariate
balancing weighting, and entropy balancing weighting estimators without
regularization.
</p>
<p>The variance-covariance matrix for the parameter of interest and ancillary
parameters is calculated using the sandwich variance formula obtained in the
M-estimation framework.
</p>
<p>When using regularization for propensity score estimation (<code>lambda &gt; 0</code>),
you should standardize the covariates for propensity score estimation
by <code><a href="#topic+std_comp">std_comp</a></code> before using <code>dbw</code>. See example below for more details.
</p>
<p>For the ATE estimation, it is recommended to specify the <code>estimand</code> as
<code>"ATE"</code>, but you may specify it as <code>"ATEcombined"</code> when using the
covariate balancing weighting. The former utilizes the separated propensity
score estimation whereas the latter utilizes the combined estimation, and
the former should produce smaller biases and variances. Note that the
former estimates two propensity scores for each observation by estimating
two propensity score functions with different estimating equations.
</p>
<p>For the AO estimation, NA values for the outcome variable for missing cases
(the response variable taking &quot;0&quot;) are not deleted. For this processing, the
outcome variable name must not contain spaces.
</p>


<h3>Value</h3>

<p><code>dbw</code> returns an object of &quot;dbw&quot; class.
</p>
<p>The function summary (i.e., <code><a href="#topic+summary.dbw">summary.dbw</a></code>) can be used to obtain or print a
summary of the results.
</p>
<p>An object of class &quot;dbw&quot; is a list containing the following components:
</p>
<table role = "presentation">
<tr><td><code>est</code></td>
<td>
<p>the point estimate of the parameter of interest.</p>
</td></tr>
<tr><td><code>coef_ps</code></td>
<td>
<p>a named vector of coefficients for propensity score estimation.
A list of two sets of coefficients for two sets of propensity scores
(one for estimating <code class="reqn">E[Y(1)]</code> and the other for estimating <code class="reqn">E[Y(0)]</code>) is
returned when <code>estimand = "ATE"</code>.</p>
</td></tr>
<tr><td><code>coef_y</code></td>
<td>
<p>a named vector of coefficients for outcome model estimation.
A list of two sets of coefficients for two sets of outcome models
(one for estimating <code class="reqn">E[Y(1)]</code> and the other for estimating <code class="reqn">E[Y(0)]</code>) is
returned when <code>estimand = "ATE"</code> and <code>estimand = "ATEcombined"</code>.</p>
</td></tr>
<tr><td><code>varcov</code></td>
<td>
<p>the variance-covariance matrix of the coefficients and the
parameter of interest.</p>
</td></tr>
<tr><td><code>est_weights</code></td>
<td>
<p>the estimated inverse probability weights.</p>
</td></tr>
<tr><td><code>ps</code></td>
<td>
<p>the estimated propensity scores. A list of two sets of the
estimated propensity scores (one for estimating <code class="reqn">E[Y(1)]</code> and the other
for estimating <code class="reqn">E[Y(0)])</code> is returned when <code>estimand = "ATE"</code>.</p>
</td></tr>
<tr><td><code>predicted_y</code></td>
<td>
<p>the predicted outcomes. A list of two sets of the
predicted outcomes (one for estimating <code class="reqn">E[Y(1)]</code> and the other for
estimating <code class="reqn">E[Y(0)]</code>) is returned when <code>estimand = "ATE"</code> and
<code>estimand = "ATEcombined"</code>.</p>
</td></tr>
<tr><td><code>converged</code></td>
<td>
<p>logical. Were the propensity score estimation algorithms
judged to have converged?</p>
</td></tr>
<tr><td><code>effn</code></td>
<td>
<p>the effective sample size for the parameter of interest estimation.</p>
</td></tr>
<tr><td><code>effn_original</code></td>
<td>
<p>the effective sample size with the initial weights.</p>
</td></tr>
<tr><td><code>estimand</code></td>
<td>
<p>the parameter of interest specified.</p>
</td></tr>
<tr><td><code>method</code></td>
<td>
<p>the method for propensity score estimation specified.</p>
</td></tr>
<tr><td><code>method_y</code></td>
<td>
<p>the method for outcome model estimation specified.</p>
</td></tr>
<tr><td><code>response</code></td>
<td>
<p>the treatment vector. The response (non-missingness) vector
when the missing outcome cases.</p>
</td></tr>
<tr><td><code>outcome</code></td>
<td>
<p>the outcome vector.</p>
</td></tr>
<tr><td><code>original_weights</code></td>
<td>
<p>the weights initially supplied, a vector of 1s if
none were.</p>
</td></tr>
<tr><td><code>ci</code></td>
<td>
<p>a matrix of the confidence intervals for the parameter of interest.</p>
</td></tr>
<tr><td><code>formula_y</code></td>
<td>
<p>the outcome model formula specified.</p>
</td></tr>
<tr><td><code>formula_ps</code></td>
<td>
<p>the propensity score model formula specified.</p>
</td></tr>
<tr><td><code>call</code></td>
<td>
<p>the matched call.</p>
</td></tr>
<tr><td><code>data</code></td>
<td>
<p>the data argument.</p>
</td></tr>
<tr><td><code>normalize</code></td>
<td>
<p>a logical argument indicating whether to normalize the
estimated weights for each treatment group for <code>method = "dbw"</code>.</p>
</td></tr>
<tr><td><code>lambda</code></td>
<td>
<p>the parameter specifying the degree of the L2-regularization.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Hiroto Katsumata
</p>


<h3>References</h3>

<p>Katsumata, Hiroto. 2024. &quot;How Should We Estimate Inverse
Probability Weights with Possibly Misspecified Propensity Score Models?&quot;
Political Science Research and Methods.
</p>
<p>Imai, Kosuke and Marc Ratkovic. 2014. &quot;Covariate Balancing Propensity Score.&quot;
Journal of the Royal Statistical Society, Series B (Statistical Methodology)
76 (1): 243&ndash;63.
</p>
<p>Hainmueller, Jens. 2012. &quot;Entropy Balancing for Causal Effects: A
Multivariate Reweighting Method to Produce Balanced Samples in
Observational Studies.&quot; Political Analysis 20 (1): 25&ndash;46.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+summary.dbw">summary.dbw</a></code>, <code><a href="#topic+std_comp">std_comp</a></code>, <code><a href="mgcv.html#topic+gam">gam</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Simulation from Kang and Shafer (2007) and Imai and Ratkovic (2014)
# ATE estimation
# True ATE is 10
tau &lt;- 10
set.seed(12345)
n &lt;- 1000
X &lt;- matrix(stats::rnorm(n * 4, mean = 0, sd = 1), nrow = n, ncol = 4)
prop &lt;- 1 / (1 + exp(X[, 1] - 0.5 * X[, 2] +
                     0.25 * X[, 3] + 0.1 * X[, 4]))
treat &lt;- rbinom(n, 1, prop)
y &lt;- 210 +
     27.4 * X[, 1] + 13.7 * X[, 2] + 13.7 * X[, 3] + 13.7 * X[, 4] +
     tau * treat + stats::rnorm(n = n, mean = 0, sd = 1)
ybinom &lt;- (y &gt; 210) + 0
df0 &lt;- data.frame(X, treat, y, ybinom)
colnames(df0) &lt;- c("x1", "x2", "x3", "x4", "treat", "y", "ybinom")

# Variables for a misspecified model
Xmis &lt;- data.frame(x1mis = exp(X[, 1] / 2),
                   x2mis = X[, 2] * (1 + exp(X[, 1]))^(-1) + 10,
                   x3mis = (X[, 1] * X[, 3] / 25 + 0.6)^3,
                   x4mis = (X[, 2] + X[, 4] + 20)^2)

# Data frame and formulas for propensity score estimation
df &lt;- data.frame(df0, Xmis)
formula_ps_c &lt;- stats::as.formula(treat ~ x1 + x2 + x3 + x4)
formula_ps_m &lt;- stats::as.formula(treat ~ x1mis + x2mis +
                                          x3mis + x4mis)

# Formula for a misspecified outcome model
formula_y &lt;- stats::as.formula(y ~ x1mis + x2mis + x3mis + x4mis)


# Correct propensity score model

# Distribution balancing weighting with normalization and
#   without regularization
fitdbwc &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_c,
               estimand = "ATE", method = "dbw",
               method_y = "wls", data = df, normalize = TRUE,
               vcov = TRUE, lambda = 0, weights = NULL,
               clevel = 0.95)
fitdbwc
summary(fitdbwc)

# Covariate balancing weighting function without regularization
fitcbwc &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_c,
               estimand = "ATE", method = "cb",
               method_y = "wls", data = df, normalize = TRUE,
               vcov = TRUE, lambda = 0, weights = NULL,
               clevel = 0.95)
summary(fitcbwc)

# Entropy balancing weighting function without regularization
fitebwc &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_c,
               estimand = "ATE", method = "eb",
               method_y = "wls", data = df, normalize = TRUE,
               vcov = TRUE, lambda = 0, weights = NULL,
               clevel = 0.95)
summary(fitebwc)

# Standard logistic regression
fitmlec &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_c,
               estimand = "ATE", method = "mle",
               method_y = "wls", data = df, normalize = FALSE,
               vcov = TRUE, lambda = 0, weights = NULL,
               clevel = 0.95)
summary(fitmlec)

# Distribution balancing weighting without normalization and
#   without regularization
fitdbwcnn &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_c,
                 estimand = "ATE", method = "dbw",
                 method_y = "wls", data = df, normalize = FALSE,
                 vcov = TRUE, lambda = 0, weights = NULL,
                 clevel = 0.95)
summary(fitdbwcnn)


# Misspecified propensity score model

# Distribution balancing weighting with normalization and 
#   without regularization
fitdbwm &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_m,
               estimand = "ATE", method = "dbw",
               method_y = "wls", data = df, normalize = TRUE,
               vcov = TRUE, lambda = 0, weights = NULL,
               clevel = 0.95)
summary(fitdbwm)

# Covariate balancing weighting function without regularization
fitcbwm &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_m,
               estimand = "ATE", method = "cb",
               method_y = "wls", data = df, normalize = TRUE,
               vcov = TRUE, lambda = 0, weights = NULL,
               clevel = 0.95)
summary(fitcbwm)

# Entropy balancing weighting function without regularization
fitebwm &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_m,
               estimand = "ATE", method = "eb",
               method_y = "wls", data = df, normalize = TRUE,
               vcov = TRUE, lambda = 0, weights = NULL,
               clevel = 0.95)
summary(fitebwm)

# Standard logistic regression
fitmlem &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_m,
               estimand = "ATE", method = "mle",
               method_y = "wls", data = df, normalize = FALSE,
               vcov = TRUE, lambda = 0, weights = NULL,
               clevel = 0.95)
summary(fitmlem)

# Distribution balancing weighting without normalization and 
#   without regularization
fitdbwmnn &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_m,
               estimand = "ATE", method = "dbw",
               method_y = "wls", data = df, normalize = FALSE,
               vcov = TRUE, lambda = 0, weights = NULL,
               clevel = 0.95)
summary(fitdbwmnn)

# Distribution balancing weighting with normalization and 
#   with regularization
# Standardization
res_std_comp &lt;- std_comp(formula_y = formula_y,
                         formula_ps = formula_ps_m,
                         estimand = "ATE", method_y = "wls",
                         data = df, std = TRUE,
                         weights = NULL)
# Estimation
fitdbwmr &lt;- dbw(formula_y = formula_y,
                formula_ps = res_std_comp$formula_ps,
                estimand = "ATE", method = "dbw", method_y = "wls",
                data = res_std_comp$data, normalize = TRUE,
                vcov = TRUE, lambda = 0.01,
                weights = res_std_comp$weights, clevel = 0.95)
summary(fitdbwmr)

# Covariate balancing weighting function with an estimating equation
#  for the original covariate balancing propensity score method
fitcbwmcmb &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_m,
                  estimand = "ATEcombined", method = "cb",
                  method_y = "wls", data = df, normalize = TRUE,
                  vcov = TRUE, lambda = 0, weights = NULL,
                  clevel = 0.95)
summary(fitcbwmcmb)



# Formula for a misspecified outcome model for the GAM
library(mgcv)
formula_y_gam &lt;- stats::as.formula(y ~ s(x1mis) + s(x2mis) +
                                       s(x3mis)+ s(x4mis))

# Distribution balancing weighting with the GAM
fitdbwmg &lt;- dbw(formula_y = formula_y_gam, formula_ps = formula_ps_m,
                estimand = "ATE", method = "dbw",
                method_y = "gam", data = df, normalize = TRUE,
                vcov = TRUE, lambda = 0, weights = NULL,
                clevel = 0.95)
summary(fitdbwmg)


# Binary outcome case
# Empirically correct ATE
ybinom_t &lt;- (y + (1 - treat) * 10 &gt; 210) + 0
ybinom_c &lt;- (y - treat * 10 &gt; 210) + 0
ATEbinom &lt;- mean(ybinom_t - ybinom_c)
ATEbinom

# Formula for a misspecified binary outcome model
formula_y_bin &lt;- stats::as.formula(ybinom ~ x1mis + x2mis +
                                            x3mis + x4mis)

# Distribution balancing weighting for the binary outcome
fitdbwmbin &lt;- dbw(formula_y = formula_y_bin,
                  formula_ps = formula_ps_m,
                  estimand = "ATE", method = "dbw",
                  method_y = "logit", data = df, normalize = TRUE,
                  vcov = TRUE, lambda = 0, weights = NULL,
                  clevel = 0.95)
summary(fitdbwmbin)


# Standard logistic regression with the Horvitz-Thompson estimator
fitmlem_ht &lt;- dbw(formula_y = y ~ 0, formula_ps = formula_ps_m,
                  estimand = "ATE", method = "mle",
                  method_y = "wls", data = df, normalize = FALSE,
                  vcov = TRUE, lambda = 0, weights = NULL,
                  clevel = 0.95)
summary(fitmlem_ht)

# Standard logistic regression with the Hajek estimator
fitmlem_hj &lt;- dbw(formula_y = y ~ 1, formula_ps = formula_ps_m,
                  estimand = "ATE", method = "mle",
                  method_y = "wls", data = df, normalize = FALSE,
                  vcov = TRUE, lambda = 0, weights = NULL,
                  clevel = 0.95)
summary(fitmlem_hj)
</code></pre>

<hr>
<h2 id='plot.dbw'>Summarize and plot covariate balance</h2><span id='topic+plot.dbw'></span>

<h3>Description</h3>

<p>Summarizes and plots covariate balance between treatment and control groups
before and after the distribution balancing weighting.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'dbw'
plot(
  x,
  addcov = NULL,
  standardize = TRUE,
  plot = TRUE,
  absolute = TRUE,
  threshold = 0,
  sort = TRUE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="plot.dbw_+3A_x">x</code></td>
<td>
<p>an object of class “dbw”, usually, a result of a call to <code><a href="#topic+dbw">dbw</a></code>.</p>
</td></tr>
<tr><td><code id="plot.dbw_+3A_addcov">addcov</code></td>
<td>
<p>a one-sided formula specifying additional covariates whose
balance is checked. Covariates containing NAs are automatically dropped.</p>
</td></tr>
<tr><td><code id="plot.dbw_+3A_standardize">standardize</code></td>
<td>
<p>a logical value indicating whether weighted mean
differences are standardized or not.</p>
</td></tr>
<tr><td><code id="plot.dbw_+3A_plot">plot</code></td>
<td>
<p>a logical value indicating whether a covariate balance plot is
displayed.</p>
</td></tr>
<tr><td><code id="plot.dbw_+3A_absolute">absolute</code></td>
<td>
<p>a logical value indicating whether the absolute values of
differences in weighted means are used in the covariate balance plot.</p>
</td></tr>
<tr><td><code id="plot.dbw_+3A_threshold">threshold</code></td>
<td>
<p>an optional numeric vector used as threshold markers in the
covariate balance plot.</p>
</td></tr>
<tr><td><code id="plot.dbw_+3A_sort">sort</code></td>
<td>
<p>a logical value indicating whether covariates in the covariate
balance plot are sorted by the values of differences in the weighted means
before the distribution balancing weighting.</p>
</td></tr>
<tr><td><code id="plot.dbw_+3A_...">...</code></td>
<td>
<p>other graphical parameters (see <code><a href="graphics.html#topic+par">par</a></code>).</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Estimated weights are normalized to sum to one. Position of the legend is
determined internally. Set <code>absolute = TRUE</code> and <code>sort = TRUE</code> for choosing
a better location automatically.
</p>


<h3>Value</h3>

<p>A matrix whose rows are the covariates and columns are the
differences in the (un)standardized weighted mean between the treatment and
control groups before (<code>diff.un</code>) and after (<code>diff.adj</code>) the
distribution balancing weighting. The standardized weighted mean is the
weighted mean divided by the standard deviation of the covariate for the
target population (the treatment group for the average treatment effects on
the treated estimation, the control group for the average treatment effects
on the controlled estimation and the whole population for the other
quantity of interest). The differences in the categorical variables are not
standardized.
</p>


<h3>Author(s)</h3>

<p>Hiroto Katsumata
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Simulation from Kang and Shafer (2007) and Imai and Ratkovic (2014)
# ATE estimation
# True ATE is 10
tau &lt;- 10
set.seed(12345)
n &lt;- 1000
X &lt;- matrix(stats::rnorm(n * 4, mean = 0, sd = 1), nrow = n, ncol = 4)
prop &lt;- 1 / (1 + exp(X[, 1] - 0.5 * X[, 2] + 
                     0.25 * X[, 3] + 0.1 * X[, 4]))
treat &lt;- rbinom(n, 1, prop)
y &lt;- 210 + 
     27.4 * X[, 1] + 13.7 * X[, 2] + 13.7 * X[, 3] + 13.7 * X[, 4] + 
     tau * treat + stats::rnorm(n = n, mean = 0, sd = 1)
ybinom &lt;- (y &gt; 210) + 0
df0 &lt;- data.frame(X, treat, y, ybinom)
colnames(df0) &lt;- c("x1", "x2", "x3", "x4", "treat", "y", "ybinom")

# Variables for a misspecified model
Xmis &lt;- data.frame(x1mis = exp(X[, 1] / 2), 
                   x2mis = X[, 2] * (1 + exp(X[, 1]))^(-1) + 10,
                   x3mis = (X[, 1] * X[, 3] / 25 + 0.6)^3, 
                   x4mis = (X[, 2] + X[, 4] + 20)^2)

# Data frame and formulas for propensity score estimation
df &lt;- data.frame(df0, Xmis)
formula_ps_c &lt;- stats::as.formula(treat ~ x1 + x2 + x3 + x4)
formula_ps_m &lt;- stats::as.formula(treat ~ x1mis + x2mis + 
                                          x3mis + x4mis)

# Formula for a misspecified outcome model
formula_y &lt;- stats::as.formula(y ~ x1mis + x2mis + x3mis + x4mis)

# Set plot margins
oldpar &lt;- par(no.readonly = TRUE) # Just for adjusting plot margins
par(mar = c(5.1, 5.1, 4.1, 2.1)) # Just for adjusting plot margins

# Misspecified propensity score model

# Distribution balancing weighting without regularization
fitdbwm &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_m,
               estimand = "ATE", method = "dbw",
               method_y = "wls", data = df, normalize = TRUE,
               vcov = TRUE, lambda = 0, weights = NULL,
               clevel = 0.95)
plot(fitdbwm, addcov = ~ x1 + x2 + x3 + x4, threshold = c(0.1, 0.2))

# Non-absolute values
plot(fitdbwm, addcov = ~ x1 + x2 + x3 + x4, absolute = FALSE, 
     threshold = c(0.1, 0.2))

# No sorting
plot(fitdbwm, addcov = ~ x1 + x2 + x3 + x4, 
     threshold = c(0.1, 0.2), sort = FALSE)


# Covariate balancing weighting function without regularization
fitcbwm &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_m,
               estimand = "ATE", method = "cb",
               method_y = "wls", data = df, normalize = TRUE,
               vcov = TRUE, lambda = 0, weights = NULL,
               clevel = 0.95)
plot(fitcbwm, addcov = ~ x1 + x2 + x3 + x4, threshold = c(0.1, 0.2))

# Entropy balancing weighting function without regularization
fitebwm &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_m,
               estimand = "ATE", method = "eb",
               method_y = "wls", data = df, normalize = TRUE,
               vcov = TRUE, lambda = 0, weights = NULL,
               clevel = 0.95)
plot(fitebwm, addcov = ~ x1 + x2 + x3 + x4, threshold = c(0.1, 0.2))

# Standard logistic regression
fitmlem &lt;- dbw(formula_y = formula_y, formula_ps = formula_ps_m,
               estimand = "ATE", method = "mle",
               method_y = "wls", data = df, normalize = FALSE,
               vcov = TRUE, lambda = 0, weights = NULL,
               clevel = 0.95)
plot(fitmlem, addcov = ~ x1 + x2 + x3 + x4, threshold = c(0.1, 0.2))

par(oldpar)

# Display the covariate balance matrix
cb &lt;- plot(fitdbwm, addcov = ~ x1 + x2 + x3 + x4, plot = FALSE)
cb
</code></pre>

<hr>
<h2 id='print.dbw'>Print the distribution balancing weighting estimation results</h2><span id='topic+print.dbw'></span>

<h3>Description</h3>

<p>Prints a fitted <code>dbw</code> object.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'dbw'
print(x, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="print.dbw_+3A_x">x</code></td>
<td>
<p>an object of class “dbw”, usually, a result of a call to <code><a href="#topic+dbw">dbw</a></code>.</p>
</td></tr>
<tr><td><code id="print.dbw_+3A_...">...</code></td>
<td>
<p>additional arguments to be passed to print.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>No retrun value, called for side effects.
</p>


<h3>Author(s)</h3>

<p>Hiroto Katsumata
</p>


<h3>See Also</h3>

<p><code><a href="#topic+dbw">dbw</a></code>, <code><a href="base.html#topic+print">print</a></code>
</p>

<hr>
<h2 id='std_comp'>Generate standardized complete cases</h2><span id='topic+std_comp'></span>

<h3>Description</h3>

<p>Standardizes covariates for propensity score estimation before the
distribution balancing weighting <code><a href="#topic+dbw">dbw</a></code> with the regularization.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>std_comp(
  formula_y,
  formula_ps,
  estimand = "ATE",
  method_y = "wls",
  data,
  std = TRUE,
  weights = NULL
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="std_comp_+3A_formula_y">formula_y</code></td>
<td>
<p>an object of class <code><a href="stats.html#topic+formula">formula</a></code> (or one that
can be coerced to that class): a symbolic description of the potential
outcome model to be fitted. When you want to use non-DR type estimators,
only include &quot;1&quot; in the right hand side of the formula for the Hajek
estimator and only include &quot;0&quot; for the Horvitz-Thompson estimator.
See example of <code><a href="#topic+dbw">dbw</a></code> for more details.</p>
</td></tr>
<tr><td><code id="std_comp_+3A_formula_ps">formula_ps</code></td>
<td>
<p>an object of class <code><a href="stats.html#topic+formula">formula</a></code> (or one that
can be coerced to that class): a symbolic description of the propensity score
model to be fitted. For the entropy balancing weighting (<code>method = "eb"</code>),
variables in the right hand side of the formula will be mean balanced.</p>
</td></tr>
<tr><td><code id="std_comp_+3A_estimand">estimand</code></td>
<td>
<p>a character string specifying a parameter of interest. Choose
&quot;ATT&quot; for the average treatment effects on the treated estimation, &quot;ATE&quot;
for the average treatment effects estimation, &quot;ATC&quot; for the average
outcomes estimation in missing outcome cases. You can choose &quot;ATEcombined&quot;
for the combined estimation for the average treatment effects estimation
when using the covariate balancing weighting (<code>method = "cb"</code>).</p>
</td></tr>
<tr><td><code id="std_comp_+3A_method_y">method_y</code></td>
<td>
<p>a character string specifying a method for potential outcome
prediction. Choose &quot;wls&quot; for the linear model, &quot;logit&quot; for the logistic
regression, &quot;gam&quot; for the generalized additive model for the continuous
outcome, and &quot;gambinom&quot; for the generalized additive model for the binary
outcome.</p>
</td></tr>
<tr><td><code id="std_comp_+3A_data">data</code></td>
<td>
<p>a data frame (or one that can be coerced to that class)
containing the outcomes and the variables in the model.</p>
</td></tr>
<tr><td><code id="std_comp_+3A_std">std</code></td>
<td>
<p>a logical parameter indicating whether to standardize the
covariates for propensity score estimation.</p>
</td></tr>
<tr><td><code id="std_comp_+3A_weights">weights</code></td>
<td>
<p>an optional vector of ‘prior weights’ (e.g. sampling weights)
to be used in the fitting process. Should be NULL or a numeric vector.</p>
</td></tr>
</table>


<h3>Details</h3>

<p><code>std_comp</code> first extracts complete cases for both propensity score estimation
and outcome model estimation. Then it standardizes covariates for propensity
score estimation by takeing the provided weights into account. The returned
data frame is the &quot;design matrix&quot;, which contains a set of dummy variables
(depending on the contrasts) for factors and similarly expanded interaction
terms.
</p>
<p>For the AO estimation, NA values for the outcome variable for missing cases
(the response variable taking &quot;0&quot;) are not deleted. For this processing, the
outcome variable name must not contain spaces.
</p>


<h3>Value</h3>

<table role = "presentation">
<tr><td><code>data</code></td>
<td>
<p>the complete-case data frame containing the outcome variable,
the response (treatment) variable, and the standardized covariates for
propensity score estimation.</p>
</td></tr>
<tr><td><code>weights</code></td>
<td>
<p>the initially-supplied weights for the complete cases, a
vector of 1s if none were.</p>
</td></tr>
<tr><td><code>formula_ps</code></td>
<td>
<p>the automatically-created formula for propensity score
estimation, which includes expanded factors and interactions.</p>
</td></tr>
<tr><td><code>mean_x</code></td>
<td>
<p>the weighted mean of each covariates.</p>
</td></tr>
<tr><td><code>sd_x</code></td>
<td>
<p>the weighted standard deviation of each covariates.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Hiroto Katsumata
</p>


<h3>See Also</h3>

<p><code><a href="#topic+dbw">dbw</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Simulation from Kang and Shafer (2007) and Imai and Ratkovic (2014)
# ATE estimation
# True ATE is 10
tau &lt;- 10
set.seed(12345)
n &lt;- 1000
X &lt;- matrix(stats::rnorm(n * 4, mean = 0, sd = 1), nrow = n, ncol = 4)
prop &lt;- 1 / (1 + exp(X[, 1] - 0.5 * X[, 2] + 
                     0.25 * X[, 3] + 0.1 * X[, 4]))
treat &lt;- rbinom(n, 1, prop)
y &lt;- 210 + 
     27.4 * X[, 1] + 13.7 * X[, 2] + 13.7 * X[, 3] + 13.7 * X[, 4] + 
     tau * treat + stats::rnorm(n = n, mean = 0, sd = 1)
ybinom &lt;- (y &gt; 210) + 0
df0 &lt;- data.frame(X, treat, y, ybinom)
colnames(df0) &lt;- c("x1", "x2", "x3", "x4", "treat", "y", "ybinom")

# Variables for a misspecified model
Xmis &lt;- data.frame(x1mis = exp(X[, 1] / 2), 
                   x2mis = X[, 2] * (1 + exp(X[, 1]))^(-1) + 10,
                   x3mis = (X[, 1] * X[, 3] / 25 + 0.6)^3, 
                   x4mis = (X[, 2] + X[, 4] + 20)^2)

# Data frame and formulas for propensity score estimation
df &lt;- data.frame(df0, Xmis)
formula_ps_c &lt;- stats::as.formula(treat ~ x1 + x2 + x3 + x4)
formula_ps_m &lt;- stats::as.formula(treat ~ x1mis + x2mis + 
                                          x3mis + x4mis)

# Formula for a misspecified outcome model
formula_y &lt;- stats::as.formula(y ~ x1mis + x2mis + x3mis + x4mis)


# Distribution balancing weighting with regularization
# Standardization
res_std_comp &lt;- std_comp(formula_y = formula_y, 
                         formula_ps = formula_ps_m, 
                         estimand = "ATE", method_y = "wls", 
                         data = df, std = TRUE,
                         weights = NULL)
fitdbwmr &lt;- dbw(formula_y = formula_y, 
                formula_ps = res_std_comp$formula_ps, 
                estimand = "ATE", method = "dbw", method_y = "wls",
                data = res_std_comp$data, vcov = TRUE, 
                lambda = 0.01, weights = res_std_comp$weights, 
                clevel = 0.95)
summary(fitdbwmr)
</code></pre>

<hr>
<h2 id='summary.dbw'>Summarize the distribution balancing weighting estimation results</h2><span id='topic+summary.dbw'></span>

<h3>Description</h3>

<p>Prints a summary of a fitted <code>dbw</code> object.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'dbw'
summary(object, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="summary.dbw_+3A_object">object</code></td>
<td>
<p>an object of class “dbw”, usually, a result of a call to <code><a href="#topic+dbw">dbw</a></code>.</p>
</td></tr>
<tr><td><code id="summary.dbw_+3A_...">...</code></td>
<td>
<p>additional arguments to be passed to summary.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Prints a summary of a <code>dbw</code> object, in a format similar to glm.
</p>


<h3>Value</h3>

<table role = "presentation">
<tr><td><code>call</code></td>
<td>
<p>the matched call.</p>
</td></tr>
<tr><td><code>est</code></td>
<td>
<p>the point estimate of the parameter of interest.</p>
</td></tr>
<tr><td><code>coefficients</code></td>
<td>
<p>a table including coefficients, standard errors,
z-values, and two-sided p-values.</p>
</td></tr>
<tr><td><code>effn</code></td>
<td>
<p>the effective sample size for the parameter of interest
estimation.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Hiroto Katsumata
</p>


<h3>See Also</h3>

<p><code><a href="#topic+dbw">dbw</a></code>, <code><a href="base.html#topic+summary">summary</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># For examples see example(dbw)
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
