<!DOCTYPE html><html><head><title>Help for package stan4bart</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {stan4bart}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#stan4bart'><p>Semiparametric Models Using Stan and BART</p></a></li>
<li><a href='#stan4bart-generics'><p>Generic Functions for stan4bart Model Fits</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Version:</td>
<td>0.0-7</td>
</tr>
<tr>
<td>Date:</td>
<td>2023-12-04</td>
</tr>
<tr>
<td>Title:</td>
<td>Bayesian Additive Regression Trees with Stan-Sampled Parametric
Extensions</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 3.5-0), methods, dbarts (&ge; 0.9-21)</td>
</tr>
<tr>
<td>Imports:</td>
<td>stats, Matrix, parallel, RcppParallel (&ge; 5.1.1)</td>
</tr>
<tr>
<td>LinkingTo:</td>
<td>BH (&ge; 1.72.0.3), Rcpp (&ge; 1.0.5), RcppEigen (&ge; 0.3.3.7.0),
RcppParallel (&ge; 5.1.1), dbarts (&ge; 0.9-20)</td>
</tr>
<tr>
<td>Suggests:</td>
<td>testthat (&ge; 2.0-0), lme4</td>
</tr>
<tr>
<td>Description:</td>
<td>Fits semiparametric linear and multilevel models with non-parametric additive Bayesian additive regression tree (BART; Chipman, George, and McCulloch (2010) &lt;<a href="https://doi.org/10.1214%2F09-AOAS285">doi:10.1214/09-AOAS285</a>&gt;) components and Stan (Stan Development Team (2021) <a href="https://mc-stan.org/">https://mc-stan.org/</a>) sampled parametric ones. Multilevel models can be expressed using 'lme4' syntax (Bates, Maechler, Bolker, and Walker (2015) &lt;<a href="https://doi.org/10.18637%2Fjss.v067.i01">doi:10.18637/jss.v067.i01</a>&gt;).</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-3">GPL (&ge; 3)</a></td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>yes</td>
</tr>
<tr>
<td>Biarch:</td>
<td>true</td>
</tr>
<tr>
<td>UseLTO:</td>
<td>true</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://github.com/vdorie/stan4bart">https://github.com/vdorie/stan4bart</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/vdorie/stan4bart/issues">https://github.com/vdorie/stan4bart/issues</a></td>
</tr>
<tr>
<td>Packaged:</td>
<td>2023-12-08 12:43:26 UTC; vdorie</td>
</tr>
<tr>
<td>Author:</td>
<td>Vincent Dorie <a href="https://orcid.org/0000-0002-9576-3064"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre],
  Ben Goodrich [ctb] (rstanarm_functions.R, StanHeaders),
  Jonah Gabry [ctb] (rstanarm_functions.R, StanHeaders),
  Imad Ali [ctb] (rstanarm_functions.R),
  Sam Brilleman [ctb] (rstanarm_functions.R),
  Paul-Christian Burkner
    <a href="https://orcid.org/0000-0001-5765-8995"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [ctb]
    (rstanarm_functions.R),
  Joshua Pritikin <a href="https://orcid.org/0000-0002-9862-5484"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [ctb] (StanHeaders),
  Andrew Gelman <a href="https://orcid.org/0000-0002-6975-2601"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [ctb] (StanHeaders),
  Bob Carpenter [ctb] (StanHeaders),
  Matt Hoffman [ctb] (StanHeaders),
  Daniel Lee [ctb] (StanHeaders),
  Michael Betancourt
    <a href="https://orcid.org/0000-0002-2900-0931"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [ctb]
    (StanHeaders),
  Marcus Brubaker <a href="https://orcid.org/0000-0002-7892-9026"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [ctb] (StanHeaders),
  Jiqiang Guo [ctb] (StanHeaders),
  Peter Li [ctb] (StanHeaders),
  Allen Riddell [ctb] (StanHeaders),
  Marco Inacio <a href="https://orcid.org/0000-0002-6865-5404"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [ctb] (StanHeaders),
  Mitzi Morris [ctb] (StanHeaders),
  Jeffrey Arnold <a href="https://orcid.org/0000-0001-9953-3904"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [ctb] (StanHeaders),
  Rob Goedman [ctb] (StanHeaders),
  Brian Lau [ctb] (StanHeaders),
  Rob Trangucci [ctb] (StanHeaders),
  Alp Kucukelbir [ctb] (StanHeaders),
  Robert Grant [ctb] (StanHeaders),
  Dustin Tran [ctb] (StanHeaders),
  Michael Malecki [ctb] (StanHeaders),
  Yuanjun Gao [ctb] (StanHeaders),
  Trustees of Columbia University [cph] (rstanarm_functions.R,
    StanHeaders),
  Lawrence Livermore National Security [cph] (CVODES),
  The Regents of the University of California [cph] (CVODES),
  Southern Methodist University [cph] (CVODES),
  Douglas Bates <a href="https://orcid.org/0000-0001-8316-9503"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [ctb] (lme4_functions.R),
  Martin Maechler <a href="https://orcid.org/0000-0002-8685-9910"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [ctb] (lme4_functions.R),
  Ben Bolker <a href="https://orcid.org/0000-0002-2127-0443"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [ctb]
    (lme4_functions.R),
  Steve Walker <a href="https://orcid.org/0000-0002-4394-9078"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [ctb] (lme4_functions.R),
  Armon Dadgar [ctb] (adaptive radix tree),
  Bothner Per [ctb] (config.guess),
  Elliston Ben [ctb] (config.guess),
  Free Software Foundation [cph] (config.sub),
  Guido U Draheim [ctb] (ax_check_compile_flag.m4),
  Maarten Bosmans [ctb] (ax_check_compile_flag.m4),
  Christophe Tournayre [ctb] (ax_ext.m4),
  Michael Petch [ctb] (ax_ext.m4, ax_gcc_x86_avx_xgetbv.m4,
    ax_gcc_x86_cpuid.m4),
  Rafael de Lucena Valle [ctb] (ax_ext.m4),
  Steven G. Johnson <a href="https://orcid.org/0000-0001-7327-4967"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [ctb] (ax_gcc_x86_cpuid.m4),
  Matteo Frigo [ctb] (ax_gcc_x86_cpuid.m4),
  Scott Pakin <a href="https://orcid.org/0000-0002-5220-1985"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [ctb]
    (ax_func_posix_memalign.m4)</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Vincent Dorie &lt;vdorie@gmail.com&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2023-12-08 14:10:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='stan4bart'>Semiparametric Models Using Stan and BART</h2><span id='topic+stan4bart'></span>

<h3>Description</h3>

<p>This function fits semi-parametric linear and probit models that have a
non-parametric, BART component and one or more of a parametric fixed
effect (unmodeled coefficients), or a parametric random effect
(modeled coefficients). If
<code class="reqn">f(x)</code> is a BART &ldquo;sum-of-trees&rdquo; model, fits:
</p>

<ul>
<li><p> For continuous response variables:
</p>
<p style="text-align: center;"><code class="reqn">Y \mid b \sim \mathrm{N}\left(f(X^b) + X^f\beta + Zb, \sigma^2\right) \\
  b \sim \mathrm{N}(0, \Sigma_b)</code>
</p>

</li>
<li><p> For binary response variables:
</p>
<p style="text-align: center;"><code class="reqn">P(Y = 1 \mid b) = \Phi\left(f(X^b) + X^f\beta + Zb\right) \\
  b \sim \mathrm{N}(0, \Sigma_b)</code>
</p>

</li></ul>


<h3>Usage</h3>

<pre><code class='language-R'>stan4bart(formula,
          data = NULL,
          subset,
          weights,
          na.action = getOption("na.action", "na.omit"),
          offset,
          contrasts = NULL,
          test = NULL,
          treatment = NULL,
          offset_test = NULL,
          verbose = FALSE,
          iter = 2000L,
          warmup = iter %/% 2L,
          skip = 1L,
          chains = 4L,
          cores = getOption("mc.cores", 1L),
          refresh = max(iter %/% 10L, 1L),
          offset_type = c("default", "fixef", "ranef", "bart", "parametric"),
          seed = NA_integer_,
          keep_fits = TRUE,
          callback = NULL,
          stan_args = NULL,
          bart_args = NULL)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="stan4bart_+3A_formula">formula</code></td>
<td>
<p>a <code><a href="stats.html#topic+formula">formula</a></code> object, or one that can be coerced to
that type. Terms on the right-hand-side of the formula that are encased in
a symbolic call to <code>bart()</code> will be used to create the non-parametric
component. Terms that use the <code><a href="lme4.html#topic+lmer">lmer</a></code>-style grouping syntax
will be added as parametric, hierarchical varying intercepts and slopes. All
other terms will be added as fixed effects.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_data">data</code></td>
<td>
<p>an optional data frame containing the variables in the formula.
Its use is strongly encouraged.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_subset">subset</code>, <code id="stan4bart_+3A_weights">weights</code>, <code id="stan4bart_+3A_na.action">na.action</code>, <code id="stan4bart_+3A_offset">offset</code>, <code id="stan4bart_+3A_contrasts">contrasts</code></td>
<td>
<p>optional components
adjusting the constructed model matrices and otherwise changing the linear
predictor. <code>na.action</code> cannot be <code>"na.pass"</code>. See
<code><a href="stats.html#topic+lm">lm</a></code> and <code><a href="stats.html#topic+model.matrix.default">model.matrix.default</a></code>.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_test">test</code></td>
<td>
<p>an optional data frame to be used as test data. If present, the
test predictions will be stored as the sampler runs and can be extracted
later.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_treatment">treatment</code></td>
<td>
<p>an optional symbol, that when present and refers to a binary
variable, will be used to create a test data frame with the treatment variable
set to its counterfactual. Only one of <code>test</code> and <code>treatment</code> can
be supplied.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_offset_test">offset_test</code></td>
<td>
<p>optional vector which will be added to the test
predictions.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_verbose">verbose</code></td>
<td>
<p>a logical or integer. If <code>FALSE</code> or non-positive, runs
quietly. Additional levels of information may be displayed for increasingly
positive numbers, however a large number of diagnostics are suppressed when
running multi-threaded. If negative, all diagnostic information is ignored.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_iter">iter</code></td>
<td>
<p>positive integer indicating the number of posterior samples to
draw and return. Includes warmup samples.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_warmup">warmup</code></td>
<td>
<p>non-negative integer indicating number of posterior samples to
draw and throw away. Also controls the number of iterations for which
adaptation is run.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_skip">skip</code></td>
<td>
<p>one or two positive integers. Every <code>skip</code> sample will be
kept, while every other sample will be discarded. If argument is length two,
an attempt will be made to use he named element <code>"bart"</code> for BART and
<code>"stan"</code> for Stan. If not named, BART is the first skip element and Stan
is the second. This argument does not impact the number of <code>iter</code>s
returned, unlike a conventional &ldquo;thinning&rdquo; parameter.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_chains">chains</code></td>
<td>
<p>positive integer giving the number of Markov Chains to sample.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_cores">cores</code></td>
<td>
<p>positive integer giving the number of units of parallelization.
Computation for each chain will be divide among the cores available. When 
greater than one, verbose output within chains will not be available.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_refresh">refresh</code></td>
<td>
<p>positive integer giving the frequency with which diagnostic
information should be printed as the sampler runs. Only applies with
<code>cores</code> (or <code>chains</code>) equal to 1.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_offset_type">offset_type</code></td>
<td>
<p>character; an experimental/testing feature that controls
how <code>offset</code> is to be interpreted. When one of <code>"fixef"</code>,
<code>"ranef"</code>, or <code>"bart"</code>, the offset is used to replace that part of
the model. When <code>"parametric"</code>, it replaces both of the fixed and random
parametric components. Sampling is still done for these components and their
draws are stored, however whenever they were present in the fit the
supplied value is used instead.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_seed">seed</code></td>
<td>
<p>Optional integer specifying the desired pRNG <a href="base.html#topic+set.seed">seed</a>.
It should not be needed when running single-threaded - calling
<code><a href="base.html#topic+set.seed">set.seed</a></code> will suffice. The primary use of <code>seed</code> is to
obtain reproducible results when multi-threaded. See Reproducibility section
below.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_keep_fits">keep_fits</code></td>
<td>
<p>Logical that, when false, prevents the sampler from
storing each draw. Intended to be used with <code>callback</code>.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_callback">callback</code></td>
<td>
<p>A function that will be called at each iteration, accepting
three arguments: <code>yhat.train</code>, <code>yhat.test</code>, <code>stan_pars</code>.
See details for more information.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_stan_args">stan_args</code></td>
<td>
<p>optional list, specifying further arguments to Stan. See
details below.</p>
</td></tr>
<tr><td><code id="stan4bart_+3A_bart_args">bart_args</code></td>
<td>
<p>optional list, specifying further arguments to BART. See
details below.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Fits a Bayesian &ldquo;mixed effect&rdquo; model with a non-parametric Bayesian
Additive Regression Trees (BART) component. For continuous responses:
</p>

<ul>
<li> <p><code class="reqn">Y_i \mid b \sim \mathrm{N}\left(f(X^b_i) + X^f_i\beta +
    Z_ib_{g[i]}, \sigma^2\right)</code>
</p>
</li>
<li> <p><code class="reqn">b_j \sim \mathrm{N}(0, \Sigma_b)</code>
</p>
</li></ul>

<p>where <code class="reqn">b_j</code> are the &ldquo;random effects&rdquo; - random intercepts and
slopes - that correspond to group <code class="reqn">j</code>, <code class="reqn">g[i]</code> is a mapping from
individual <code class="reqn">i</code> to its group index,  <code class="reqn">f</code> - a BART sum-of-trees model,
<code class="reqn">X^b</code> are predictors used in the BART model, <code class="reqn">X^f</code> are predictors
in a parametric, linear &ldquo;fixed effect&rdquo; component, <code class="reqn">Z</code> is the 
design matrix for the random intercept and slopes, and <code class="reqn">sigma</code> and
<code class="reqn">Sigma_b</code> are variance components.
</p>
<p>Binary outcome models are obtained by assuming a latent variable that has
the above distribution, and that the observed response is 1 when that
variable is positive and 0 otherwise. The response variable marginally has
the distribution:
</p>

<ul>
<li> <p style="text-align: center;"><code class="reqn">P(Y_i = 1 \mid b) = \Phi\left(f(X^b_i) + X^f_i\beta +
    Z_ib_{g[i]}\right)</code>
</p>

</li></ul>

<p>where <code class="reqn">\Phi</code> is the cumulative distribution function of the standard
normal distribution.
</p>


<h4>Terminology</h4>

<p>As <code>stan4bart</code> fits a Bayesian model, essentially all components are
&ldquo;modeled&rdquo;. Furthermore, as it has two first-level, non-hierarchical
components, &ldquo;fixed&rdquo; effects are ambiguous. Thus we adopt:
</p>

<ul>
<li> <p>&ldquo;fixed&rdquo; - refers only to the parametric, linear, individual
level mean component, <code class="reqn">X^f\beta</code>; these are &ldquo;unmodeled
coefficients&rdquo; in other contexts
</p>
</li>
<li> <p>&ldquo;random&rdquo; - refers only to the parametric, linear,
hierarchical mean component, <code class="reqn">Zb</code>; these are &ldquo;modeled
coefficients&rdquo; in other contexts
</p>
</li>
<li> <p>&ldquo;bart&rdquo; - refers only to the nonparametric, individual level
mean component, <code class="reqn">f(X^b)</code>
</p>
</li></ul>




<h4>Model Specification</h4>

<p>Model specification occurs in the <code>formula</code> object, according to the
following rules:
</p>

<ul>
<li><p> variables or terms specified inside a pseudo-call to <code>bart</code>
are used for the &ldquo;bart&rdquo; component, e.g. <code>y ~ bart(x_1 + x_2)</code>
</p>
</li>
<li><p> variables or terms specified according to <code><a href="lme4.html#topic+lmer">lmer</a></code>
syntax are used for the &ldquo;random&rdquo; effect component, e.g.
<code>y ~ (1 | g_1) + (1 + x_3 | g_1)</code>
</p>
</li>
<li><p> remaining variables not inside a <code>bart</code> or &ldquo;bars&rdquo;
construct are used for the &ldquo;fixed&rdquo; effect component; e.g.
<code>y ~ x_4</code>
</p>
</li></ul>

<p>All three components can be present in a single model, however are
<code>bart</code> part must present. If you wish to fit a model without one, use
<code>stan_glmer</code> in the <code>rstanarm</code> package instead.
</p>



<h4>Additional Arguments</h4>

<p>The <code>stan_args</code> and <code>bart_args</code> arguments to <code>stan4bart</code> can
be used to pass further arguments to <code>stan</code> and <code>bart</code>
respectively. These are similar to the functions <code>stan</code> in the
<code>rstan</code> package and <code>bart</code>, but not identical as
<code>stan4bart</code> constructs its own model internally.
</p>
<p>Stan arguments include:
</p>

<ul>
<li> <p><code>prior_covariance</code>
</p>
</li>
<li> <p><code>prior</code>, <code>prior_intercept</code>, <code>prior_aux</code>, <code>QR</code>
</p>
</li>
<li> <p><code>init_r</code>, <code>adapt_gamma</code>, <code>adapt_delta</code>,
<code>adapt_kappa</code> - see the help page for <code>stan</code> in the <code>rstan</code>
package.
</p>
</li></ul>

<p>For reference on the first two sets of options, see the help page for
<code>stan_glmer</code> in the <code>rstanarm</code> package; for reference on
the third set, see the help page for <code>stan</code> in the <code>rstan</code>
package.
</p>
<p>BART arguments include:
</p>

<ul>
<li><p> further arguments to <code>dbartsControl</code> that are not
specified by <code>stan4bart</code>, such as <code>keepTrees</code> or
<code>n.trees</code>; keeping trees can be costly in terms of memory, but is
required to use <code><a href="#topic+stan4bart-generics">predict</a></code>
</p>
</li></ul>




<h4>Reproducibility</h4>

<p>Behavior differs when running multi- and single-threaded, as the pseudo random
number generators (pRNG) used by R are not thread safe. When single-threaded,
R's built-in generator is used; if set at the start, <code><a href="base.html#topic+.Random.seed">.Random.seed</a></code>
will be used and its value updated as samples are drawn. When multi-threaded,
the default behavior is draw new random seeds for each thread using the clock
and use thread-specific pRNGs.
</p>
<p>This behavior can be modified by setting <code>seed</code>. For the single-threaded
case, that seed will be installed and the existing seed replaced at the end,
if applicable. For multi-threaded runs, the seeds for threads are drawn
sequentially using the supplied seed, and will not change the state of 
R's built-in generator.
</p>
<p>Consequently, the <code>seed</code> argument should not be needed when running
single-threaded - <code><a href="base.html#topic+set.seed">set.seed</a></code> will suffice. When multi-threaded,
<code>seed</code> can be used to obtain reproducible results.
</p>



<h4>Callbacks</h4>

<p>Callbacks can be used to avoid expensive memory allocation, aggregating
results as the sampler proceeds instead of waiting until the end. A callback
funtion must accept the arguments:
</p>

<ul>
<li> <p><code>yhat.train</code> - BART predictions of the expected value of the
training data, conditioned on the Stan parameters
</p>
</li>
<li> <p><code>yhat.test</code> - when applicable, the same values as above but
for the test data; <code>NULL</code> otherwise
</p>
</li>
<li> <p><code>stan_pars</code> - named vector of Stan samples, including fixed
and random effects and variance parameters
</p>
</li></ul>

<p>It is expected that the callback will return a vector of the same length
each time. If not, invalid memory writes will likely result. If the
result of the callback has names, they will be added to the result.
</p>



<h4>Serialization</h4>

<p>At present, <code>stan4bart</code> models cannot be safely <code><a href="base.html#topic+save">save</a></code>d
and <code><a href="base.html#topic+load">load</a>ed</code> in a way that the sampler can be restarted. This
feature may be added in the future.
</p>



<h3>Value</h3>

<p>Returns a list assigned class <code>stan4bartFit</code>. Has components below, some
of which will be <code>NULL</code> if not applicable.
</p>
<p>Input values:
</p>
<table>
<tr><td><code>y</code></td>
<td>
<p>response vector</p>
</td></tr>
<tr><td><code>weights</code></td>
<td>
<p>weights vector or null</p>
</td></tr>
<tr><td><code>offset</code></td>
<td>
<p>offset vector or null</p>
</td></tr>
<tr><td><code>frame</code></td>
<td>
<p>joint model frame for all components</p>
</td></tr>
<tr><td><code>formula</code></td>
<td>
<p>formula used to specify the model</p>
</td></tr>
<tr><td><code>na.action</code></td>
<td>
<p>supplied na.action</p>
</td></tr>
<tr><td><code>call</code></td>
<td>
<p>original call</p>
</td></tr>
</table>
<p>Stored data:
</p>
<table>
<tr><td><code>bartData</code></td>
<td>
<p><code>data</code> object used for BART
component</p>
</td></tr>
<tr><td><code>X</code></td>
<td>
<p>fixed effect design matrix or NULL</p>
</td></tr>
<tr><td><code>X_means</code></td>
<td>
<p>column means of fixed effect design matrix when
appropriate</p>
</td></tr>
<tr><td><code>reTrms</code></td>
<td>
<p>random effect &ldquo;terms&rdquo; object when applicable, as
used by <code><a href="lme4.html#topic+lmer">lmer</a></code></p>
</td></tr>
<tr><td><code>test</code></td>
<td>
<p>named list when applicable, having components <code>X</code> and
<code>reTrms</code>; test data for BART is added to the <code>bartData</code> result</p>
</td></tr>
<tr><td><code>treatment</code></td>
<td>
<p>treatment vector, when applicable</p>
</td></tr>
</table>
<p>Results, better accessed using <code><a href="#topic+stan4bart-generics">extract</a></code>:
</p>
<table>
<tr><td><code>bart_train</code></td>
<td>
<p>samples of individual posterior predictions for BART
component</p>
</td></tr>
<tr><td><code>bart_test</code></td>
<td>
<p>predicted test values for BART component, when
applicable</p>
</td></tr>
<tr><td><code>bart_varcount</code></td>
<td>
<p>BART variable counts</p>
</td></tr>
<tr><td><code>sigma</code></td>
<td>
<p>samples of residual standard error; not present for
binary outcomes</p>
</td></tr>
<tr><td><code>k</code></td>
<td>
<p>samples of the end-node sensitivity parameter; only present when
it is modeled</p>
</td></tr>
<tr><td><code>ranef</code></td>
<td>
<p>samples of random effects, or modeled coefficients; will
be a named list, with effects for each grouping factor</p>
</td></tr>
<tr><td><code>Sigma</code></td>
<td>
<p>samples of covariance of random effects; also a named list
with one element for each grouping factor</p>
</td></tr>
<tr><td><code>fixef</code></td>
<td>
<p>samples of the fixed effects, or unmodeled coefficients</p>
</td></tr>
<tr><td><code>callback</code></td>
<td>
<p>samples returned by an optional callback function</p>
</td></tr>
</table>
<p>Other items:
</p>
<table>
<tr><td><code>warmup</code></td>
<td>
<p>a list of warmup samples, containing the same objects in
the results subsection</p>
</td></tr>
<tr><td><code>diagnostics</code></td>
<td>
<p>Stan sampler produced diagnostic information,
include tree depth and divergent transitions</p>
</td></tr>
<tr><td><code>sampler.bart</code></td>
<td>
<p>external points to BART samplers; used only for
<code><a href="#topic+stan4bart-generics">predict</a></code> when <code>keepTrees</code> is <code>TRUE</code></p>
</td></tr>
<tr><td><code>range.bart</code></td>
<td>
<p>internal scale used by BART samplers, used by 
<code><a href="#topic+stan4bart-generics">predict</a></code> when <code>keepTrees</code> is <code>TRUE</code></p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Vincent Dorie: <a href="mailto:vdorie@gmail.com">vdorie@gmail.com</a>.
</p>


<h3>See Also</h3>

<p><code>bart</code>, <code><a href="lme4.html#topic+lmer">lmer</a></code>, and <code>stan_glmer</code> in the 
<code>rstanarm</code> package
</p>


<h3>Examples</h3>

<pre><code class='language-R'># simulate data (extension of Friedman MARS paper)
# x consists of 10 variables, only first 5 matter
# x_4 is linear
f &lt;- function(x)
  10 * sin(pi * x[,1] * x[,2]) + 20 * (x[,3] - 0.5)^2 +
      10 * x[,4] + 5 * x[,5]

set.seed(99)
sigma &lt;- 1.0

n &lt;- 100
n.g.1 &lt;- 5L
n.g.2 &lt;- 8L

# sample observation level covariates and calculate marginal mean
x &lt;- matrix(runif(n * 10), n, 10)
mu.bart  &lt;- f(x) - 10 * x[,4]
mu.fixef &lt;- 10 * x[,4]

# varying intercepts and slopes for first grouping factor
g.1 &lt;- sample(n.g.1, n, replace = TRUE)
Sigma.b.1 &lt;- matrix(c(1.5^2, .2, .2, 1^2), 2)
b.1 &lt;- matrix(rnorm(2 * n.g.1), n.g.1) %*% chol(Sigma.b.1)

# varying intercepts for second grouping factor
g.2 &lt;- sample(n.g.2, n, replace = TRUE)
Sigma.b.2 &lt;- as.matrix(1.2)
b.2 &lt;- rnorm(n.g.2, 0, sqrt(Sigma.b.2))

mu.ranef &lt;- b.1[g.1,1] + x[,4] * b.1[g.1,2] + b.2[g.2]

y &lt;- mu.bart + mu.fixef + mu.ranef + rnorm(n, 0, sigma)

df &lt;- data.frame(y, x, g.1, g.2)

fit &lt;- stan4bart(
    formula = y ~
        X4 +                         # linear component ("fixef")
        (1 + X4 | g.1) + (1 | g.2) + # multilevel ("ranef")
        bart(. - g.1 - g.2 - X4),    # use bart for other variables
    verbose = -1, # suppress ALL output
    # low numbers for illustration
    data = df,
    chains = 1, iter = 10, bart_args = list(n.trees = 5))

# posterior means of individual expected values
y.hat &lt;- fitted(fit)

# posterior means of the random effects
ranef.hat &lt;- fitted(fit, type = "ranef")
</code></pre>

<hr>
<h2 id='stan4bart-generics'>Generic Functions for stan4bart Model Fits</h2><span id='topic+extract'></span><span id='topic+stan4bart-generics'></span><span id='topic+extract.stan4bartFit'></span><span id='topic+fitted.stan4bartFit'></span><span id='topic+predict.stan4bartFit'></span>

<h3>Description</h3>

<p>Commonly expected utility functions to derive useful quantities from fitted
models.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'stan4bartFit'
extract(
  object,
  type = c("ev", "ppd", "fixef", "indiv.fixef", "ranef", "indiv.ranef",
           "indiv.bart", "sigma", "Sigma", "k", "varcount", "stan",
           "trees", "callback"),
  sample = c("train", "test"),
  combine_chains = TRUE,
  sample_new_levels = TRUE,
  include_warmup = FALSE,
  ...)
  
## S3 method for class 'stan4bartFit'
fitted(
  object,
  type = c("ev", "ppd", "fixef", "indiv.fixef", "ranef", "indiv.ranef",
           "indiv.bart", "sigma", "Sigma", "k", "varcount", "stan",
           "callback"),
  sample = c("train", "test"),
  sample_new_levels = TRUE,
  ...)

## S3 method for class 'stan4bartFit'
predict(
  object, newdata, offset,
  type = c("ev", "ppd", "indiv.fixef", "indiv.ranef", "indiv.bart"),
  combine_chains = TRUE,
  sample_new_levels = TRUE,
  ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="stan4bart-generics_+3A_object">object</code></td>
<td>
<p>a fitted model resulting from a call to
<code><a href="#topic+stan4bart">stan4bart</a></code>.</p>
</td></tr>
<tr><td><code id="stan4bart-generics_+3A_type">type</code></td>
<td>
<p>a character vector; one of the options listed below.</p>
</td></tr>
<tr><td><code id="stan4bart-generics_+3A_sample">sample</code></td>
<td>
<p>one of <code>"train"</code> or <code>"test"</code>, indicating if the
training or test data frames should be used.</p>
</td></tr>
<tr><td><code id="stan4bart-generics_+3A_combine_chains">combine_chains</code></td>
<td>
<p>logical controlling if chain information should be
discarded and the result returned as a matrix instead of an array.</p>
</td></tr>
<tr><td><code id="stan4bart-generics_+3A_sample_new_levels">sample_new_levels</code></td>
<td>
<p>logical; if <code>TRUE</code>, levels out of the training
sample will have random effects drawn from their posterior predictive
distribution. If <code>FALSE</code>, their random effects will be fixed to 0.</p>
</td></tr>
<tr><td><code id="stan4bart-generics_+3A_include_warmup">include_warmup</code></td>
<td>
<p>logical or <code>"only"</code>; when <code>TRUE</code>/<code>FALSE</code>,
warmup samples will or will not be included in the result respectively. When
<code>"only"</code>, only the warmup samples will be returned.</p>
</td></tr>
<tr><td><code id="stan4bart-generics_+3A_newdata">newdata</code></td>
<td>
<p>data frame for making out of sample predictions.</p>
</td></tr>
<tr><td><code id="stan4bart-generics_+3A_offset">offset</code></td>
<td>
<p>optional vector which will be added to test predictors.</p>
</td></tr>
<tr><td><code id="stan4bart-generics_+3A_...">...</code></td>
<td>
<p>not currently in use, but provided to match signatures of
other generics.</p>
</td></tr>
</table>


<h3>Details</h3>

<p><code>extract</code> is used to obtain raw samples using the training or test data,
<code>fitted</code> averages those samples, and <code>predict</code> operates on data
not available at the time of fitting. Note: <code>predict</code> requires that the
model be fit with <code>args_bart = list(keepTrees = TRUE)</code>.
</p>


<h4>Return type</h4>

<p>The type argument accepts:
</p>

<ul>
<li> <p><code>"ev"</code> - the individual level expected value, that is draws
from <code class="reqn">E[Y \mid X^b, X^f, Z] \mid Y = f(X^b) + X^f\beta + Zb
      \mid Y</code> where the expectation is with respect to the posterior
distribution of the parameters given the data
</p>
</li>
<li> <p><code>"ppd"</code> - draws from the individual level posterior predictive
distribution, generally speaking adding noise to the result for
<code>"ev"</code> or simulating new Bernoulli trials.
</p>
</li>
<li> <p><code>"fixef"</code> - draws from the posterior of the fixed effects
(also known as the &ldquo;unmodeled&rdquo; coefficients),
<code class="reqn">\beta \mid Y</code>
</p>
</li>
<li> <p><code>"indiv.fixef"</code> - draws from the posterior distribution of the
individual level mean component deriving from the fixed effects,
<code class="reqn">X^f\beta</code>
</p>
</li>
<li> <p><code>"ranef"</code> - the random effects, varying intercepts and slopes,
or &ldquo;modeled&rdquo; coefficients, <code class="reqn">b</code>; <code class="reqn">b</code> has substantial
structure that is represented as the returned value, where coefficients
are reported within their grouping factors
</p>
</li>
<li> <p><code>"indiv.ranef"</code> - individual level mean component deriving
from the random effects, <code class="reqn">Zb</code>
</p>
</li>
<li> <p><code>"indiv.bart"</code> - individual level mean component deriving
from the BART model, <code class="reqn">f(X^b)</code>
</p>
</li>
<li> <p><code>"sigma"</code> - for continuous responses, the residual standard
error
</p>
</li>
<li> <p><code>"Sigma"</code> - when applicable, the covariance matrices of the
random effects
</p>
</li>
<li> <p><code>"stan"</code> - raw matrix or array of Stan sampled transformed
parameters.
</p>
</li>
<li> <p><code>"trees"</code> - a data frame of flatted trees; see the subsection
on extracted trees in <code>bart</code> and note that stan4bart variable
names can be found in the <code>bartData@x</code> element of a fitted stan4bart
model
</p>
</li>
<li> <p><code>"callback"</code> - if a callback function was provided while
fitting, the results of that for each sample
</p>
</li></ul>




<h3>Value</h3>

<p><code>extract</code> and <code>predict</code> return either arrays of dimensions equal to
<code>n.observations x n.samples x n.chains</code> when <code>combine_chains</code> is
<code>FALSE</code>, or matrices of dimensions equal to
<code>n.observations x (n.samples * n.chains)</code> when <code>combine_chains</code> is
<code>TRUE</code>.
</p>
<p><code>fitted</code> returns a vector of the appropriate length by averaging the
result of a call to <code>extract</code>.
</p>


<h3>Author(s)</h3>

<p>Vincent Dorie: <a href="mailto:vdorie@gmail.com">vdorie@gmail.com</a>.
</p>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
