<!DOCTYPE html><html lang="en"><head><title>Help for package phylospatial</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {phylospatial}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#phylospatial-package'><p>phylospatial: Spatial Phylogenetic Analysis</p></a></li>
<li><a href='#benefit'><p>Calculate taxon conservation benefit</p></a></li>
<li><a href='#moss'><p>Load California moss spatial phylogenetic data</p></a></li>
<li><a href='#phylospatial'><p>Create a spatial phylogenetic object</p></a></li>
<li><a href='#plot_lambda'><p>Plot alternative lambda values</p></a></li>
<li><a href='#plot.phylospatial'><p>Plot a <code>phylospatial</code> object</p></a></li>
<li><a href='#ps_add_dissim'><p>Add community dissimilarity data to a <code>phylospatial</code> object</p></a></li>
<li><a href='#ps_canape'><p>Categorical Analysis of Neo- and Paleo-Endemism (CANAPE)</p></a></li>
<li><a href='#ps_canaper'><p>Binary randomization tests including CANAPE</p></a></li>
<li><a href='#ps_dissim'><p>Quantitative phylogenetic dissimilarity</p></a></li>
<li><a href='#ps_diversity'><p>Calculate spatial phylogenetic diversity and endemism metrics</p></a></li>
<li><a href='#ps_get_comm'><p>Get <code>phylospatial</code> community data</p></a></li>
<li><a href='#ps_ordinate'><p>Community phylogenetic ordination</p></a></li>
<li><a href='#ps_prioritize'><p>Phylogenetic conservation prioritization</p></a></li>
<li><a href='#ps_rand'><p>Null model randomization analysis of alpha diversity metrics</p></a></li>
<li><a href='#ps_regions'><p>Cluster analysis to identify phylogenetic regions</p></a></li>
<li><a href='#ps_regions_eval'><p>Evaluate region numbers</p></a></li>
<li><a href='#ps_rgb'><p>Map phylospatial data onto RGB color bands</p></a></li>
<li><a href='#ps_simulate'><p>Simulate a toy spatial phylogenetic data set</p></a></li>
<li><a href='#quantize'><p>Stratified randomization of community matrix</p></a></li>
<li><a href='#to_spatial'><p>Convert a site-by-variable matrix into a SpatRaster or sf object</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Title:</td>
<td>Spatial Phylogenetic Analysis</td>
</tr>
<tr>
<td>Version:</td>
<td>1.0.0</td>
</tr>
<tr>
<td>Description:</td>
<td>Conduct various analyses on spatial phylogenetics. Use your data
    on an evolutionary tree and geographic distributions of the terminal taxa
    to compute diversity and endemism metrics, test significance with null 
    model randomization, analyze community turnover and biotic regionalization,
    and perform spatial conservation prioritizations. All functions support
    quantitative community data in addition to binary data.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file LICENSE</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.3.2</td>
</tr>
<tr>
<td>Imports:</td>
<td>ape, sf, stats, terra, vegan</td>
</tr>
<tr>
<td>Suggests:</td>
<td>canaper, furrr, future, testthat (&ge; 3.0.0), betapart, knitr,
rmarkdown, tmap, magrittr</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://matthewkling.github.io/phylospatial/">https://matthewkling.github.io/phylospatial/</a></td>
</tr>
<tr>
<td>Config/testthat/edition:</td>
<td>3</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 3.5)</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2025-01-14 14:46:08 UTC; matthewkling</td>
</tr>
<tr>
<td>Author:</td>
<td>Matthew Kling <a href="https://orcid.org/0000-0001-9073-4240"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre, cph]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Matthew Kling &lt;mattkling@berkeley.edu&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2025-01-24 10:40:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='phylospatial-package'>phylospatial: Spatial Phylogenetic Analysis</h2><span id='topic+phylospatial-package'></span>

<h3>Description</h3>

<p><img src="../help/figures/logo.png" style='float: right' alt='logo' width='120' />
</p>
<p>Conduct various analyses on spatial phylogenetics. Use your data on an evolutionary tree and geographic distributions of the terminal taxa to compute diversity and endemism metrics, test significance with null model randomization, analyze community turnover and biotic regionalization, and perform spatial conservation prioritizations. All functions support quantitative community data in addition to binary data.
</p>


<h3>Author(s)</h3>

<p><strong>Maintainer</strong>: Matthew Kling <a href="mailto:mattkling@berkeley.edu">mattkling@berkeley.edu</a> (<a href="https://orcid.org/0000-0001-9073-4240">ORCID</a>) [copyright holder]
</p>


<h3>See Also</h3>

<p>Useful links:
</p>

<ul>
<li> <p><a href="https://matthewkling.github.io/phylospatial/">https://matthewkling.github.io/phylospatial/</a>
</p>
</li></ul>


<hr>
<h2 id='benefit'>Calculate taxon conservation benefit</h2><span id='topic+benefit'></span>

<h3>Description</h3>

<p>Nonlinear function that converts proportion of range conserved into conservation &quot;benefit.&quot;
</p>


<h3>Usage</h3>

<pre><code class='language-R'>benefit(x, lambda = 1)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="benefit_+3A_x">x</code></td>
<td>
<p>Fraction of taxon range protected (value between 0 and 1).</p>
</td></tr>
<tr><td><code id="benefit_+3A_lambda">lambda</code></td>
<td>
<p>Shape parameter.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Value between 0 and 1.
</p>

<hr>
<h2 id='moss'>Load California moss spatial phylogenetic data</h2><span id='topic+moss'></span>

<h3>Description</h3>

<p>Get example <code>phylospatial</code> data set based on a phylogeny and modeled distributions of 443 moss species
across California. This data set is a coarser version of data from Kling et al. (2024). It contains
occurrence probabilities, and is available in raster or polygon spatial formats.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>moss(format = "raster")
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="moss_+3A_format">format</code></td>
<td>
<p>Either &quot;raster&quot; (default) or &quot;polygon&quot;</p>
</td></tr>
</table>


<h3>Value</h3>

<p>a <code>phylospatial</code> object
</p>


<h3>Source</h3>

<p>Kling, Gonzalez-Ramirez, Carter, Borokini, and Mishler (2024) bioRxiv, https://doi.org/10.1101/2024.12.16.628580.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>moss()

</code></pre>

<hr>
<h2 id='phylospatial'>Create a spatial phylogenetic object</h2><span id='topic+phylospatial'></span>

<h3>Description</h3>

<p>This function creates a <code>phylospatial</code> object. This is the core data type in the phylospatial library, and
is a required input to most other functions in the package. The two essential components of a spatial phylogenetic object
are a phylogenetic tree and an community data set.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>phylospatial(
  comm,
  tree = NULL,
  spatial = NULL,
  data_type = c("auto", "probability", "binary", "abundance", "other"),
  clade_fun = NULL,
  build = TRUE,
  check = TRUE,
  area_tol = 0.01
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="phylospatial_+3A_comm">comm</code></td>
<td>
<p>Community data representing the distribution of terminal taxa across sites. Can be a matrix with a column per terminal and
a row per site, a <a href="terra.html#topic+SpatRaster">SpatRaster</a> with one layer per terminal, or a <code>sf</code> data with a column per terminal. Taxa whose names do
not match between column/layer names in <code>comm</code> and tip labels in <code>tree</code> will be dropped with a warning (unless <code>build = FALSE</code>).</p>
</td></tr>
<tr><td><code id="phylospatial_+3A_tree">tree</code></td>
<td>
<p>Phylogeny of class <a href="ape.html#topic+phylo">phylo</a>. Terminals whose names do not match <code>comm</code> will be dropped with a warning (unless
<code>build = FALSE</code>). If this argument is not provided, terminals are assumed to follow a &quot;star&quot; tree with uniform branch lengths, which
will lead to non-phylogenetic versions of any analyses done with the resulting <code>phylospatial</code> object. Must be a rooted tree.</p>
</td></tr>
<tr><td><code id="phylospatial_+3A_spatial">spatial</code></td>
<td>
<p>An optional <code>SpatRaster</code> layer or <code>sf</code> object indicating site locations. The number of cells or rows must match <code>comm</code>.
Ignored if <code>comm</code> is a <code>SpatRaster</code> or <code>sf</code> object.</p>
</td></tr>
<tr><td><code id="phylospatial_+3A_data_type">data_type</code></td>
<td>
<p>Character giving the data type of <code>comm</code>. Must be &quot;binary&quot;, &quot;probability&quot;, &quot;abundance&quot;, &quot;auto&quot; (the default), or &quot;other&quot;.
This determines how community values for clades are calculated from the values for terminal taxa. If &quot;binary&quot; (presence-absence),
a clade is considered present in a site if any terminal in the clade is present. If &quot;probability,&quot; clade probabilities are calculated
as the probability that at least one terminal is present in a site. If &quot;abundance,&quot; clade abundances are calculated as the sum of
abundances for terminals in the clade in a site. If &quot;auto,&quot; an attempt is made to guess which of these three data types was provided.
This argument is ignored if <code>clade_fun</code> is provided, or if <code>build = FALSE</code>. If &quot;other&quot;, a custom <code>clade_fun</code> must be supplied.</p>
</td></tr>
<tr><td><code id="phylospatial_+3A_clade_fun">clade_fun</code></td>
<td>
<p>Function to calculate the local community weight for a clade based on community weights for tips found in a given location.
Must be either NULL (the default, in which case the default function for the selected <code>data_type</code> is used) or a summary function that
takes a numeric vector and returns a single numeric output. Ignored if <code>comm</code> already includes clade ranges.</p>
</td></tr>
<tr><td><code id="phylospatial_+3A_build">build</code></td>
<td>
<p>Logical indicating whether <code>comm</code> already includes clade ranges that should be used instead of building new ones.
Default is <code>TRUE</code>. If <code>FALSE</code>, <code>clade_fun</code> is ignored, no checks are performed to harmonize the tip labels and the community data, and
the columns of <code>comm</code> must exactly match the order of <code>tree</code> edges including tips and larger clades. If clade ranges are included in
<code>comm</code> but <code>build = TRUE</code>, they will be dropped and new clade ranges will be built.</p>
</td></tr>
<tr><td><code id="phylospatial_+3A_check">check</code></td>
<td>
<p>Logical indicating whether community data should be validated. Default is TRUE.</p>
</td></tr>
<tr><td><code id="phylospatial_+3A_area_tol">area_tol</code></td>
<td>
<p>Numeric value giving tolerance for variation in the area of sites. Default is <code>0.01</code>. If the coefficient of variation in
the area or length of spatial units (e.g. grid cells) exceeds this value, an error will result. This check is performed because various
other functions in the library assume that sites are equal area. This argument is ignored if <code>check = FALSE</code> or if no spatial data is provided.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function formats the input data as a <code>phylospatial</code> object. Beyond validating, cleaning, and restructing the data, the main operation
it performs is to compute community occurrence data for every internal clade on the tree. For a given clade and site, community data for
all the terminals in the clade are used to calculate the clade's occurrence value in the site. As described above, this calculation can
happen in various ways, depending on what type of community data you have (e.g. binary, probability, or abundance) and how you want to
summarize them. By default, the function tries to detect your <code>data_type</code> and use it to automatically select an appropriate summary
function as described above, but you can override this by providing your own function to <code>clade_fun</code>.
</p>
<p>You can also disable construction of the clade community matrix columns altogether by setting <code>build = FALSE</code>). This is atypical, but you
might want to use this option if you have your own distribution data data on all clades (e.g. from modeling occurrence probabilities for
clades in addition to terminal species), or if your community data comes from a previously-constructed <code>phylospatial</code> object.
</p>


<h3>Value</h3>

<p>A <code>phylospatial</code> object, which is a list containing the following elements:
</p>

<dl>
<dt>&quot;data_type&quot;:</dt><dd><p> Character indicating the community data type</p>
</dd>
<dt>&quot;tree&quot;:</dt><dd><p> Phylogeny of class <code>phylo</code></p>
</dd>
<dt>&quot;comm&quot;:</dt><dd><p> Community matrix, including a column for every terminal taxon and every larger clade. Column order corresponds to tree edge order.</p>
</dd>
<dt>&quot;spatial&quot;:</dt><dd><p> A <code>SpatRaster</code> or <code>sf</code> providing spatial coordinates for the rows in <code>comm</code>. May be missing if no spatial data was supplied.</p>
</dd>
<dt>&quot;dissim&quot;:</dt><dd><p> A community dissimilary matrix of class <code>dist</code> indicating pairwise phylogenetic dissimilarity between sites. Missing unless
<code>ps_dissim(..., add = TRUE)</code> is called.</p>
</dd>
</dl>



<h3>Examples</h3>

<pre><code class='language-R'>
# load species distribution data and phylogeny
comm &lt;- terra::rast(system.file("extdata", "moss_comm.tif", package = "phylospatial"))
tree &lt;- ape::read.tree(system.file("extdata", "moss_tree.nex", package = "phylospatial"))

# construct `phylospatial` object
ps &lt;- phylospatial(comm, tree)
ps

</code></pre>

<hr>
<h2 id='plot_lambda'>Plot alternative lambda values</h2><span id='topic+plot_lambda'></span>

<h3>Description</h3>

<p>Show a plot illustrating alternative values for the <code>lambda</code> parameter in <a href="#topic+ps_prioritize">ps_prioritize</a>. Lambda determines the shape of
the &quot;benefit&quot; function that determines the conservation value of protecting a given proportion of the geographic range of a
species or clade. Positive values place a higher priority on protecting additional populations of largely unprotected taxa,
whereas negative values place a higher priority on protecting additional populations of relatively well-protected taxa. The
default value used by <a href="#topic+ps_prioritize">ps_prioritize</a> is 1.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>plot_lambda(lambda = c(-1, -0.5, 0, 0.5, 2, 1))
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="plot_lambda_+3A_lambda">lambda</code></td>
<td>
<p>A vector of lambda values to plot</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Plots a figure
</p>


<h3>Examples</h3>

<pre><code class='language-R'>plot_lambda()
plot_lambda(seq(0, 3, .1))

</code></pre>

<hr>
<h2 id='plot.phylospatial'>Plot a <code>phylospatial</code> object</h2><span id='topic+plot.phylospatial'></span>

<h3>Description</h3>

<p>Plot a <code>phylospatial</code> object
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'phylospatial'
plot(x, y = c("tree", "comm"), max_taxa = 12, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="plot.phylospatial_+3A_x">x</code></td>
<td>
<p><code>phylospatial</code> object</p>
</td></tr>
<tr><td><code id="plot.phylospatial_+3A_y">y</code></td>
<td>
<p>Either <code>"tree"</code> or <code>"comm"</code>, indicating which component to plot.</p>
</td></tr>
<tr><td><code id="plot.phylospatial_+3A_max_taxa">max_taxa</code></td>
<td>
<p>Integer giving the maximum number of taxon ranges to plot if <code>y = "tree"</code>.</p>
</td></tr>
<tr><td><code id="plot.phylospatial_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to plotting methods, depending on <code>y</code> and the class
of <code>x$spatial</code>. For <code>y = "tree"</code>, see <a href="ape.html#topic+plot.phylo">plot.phylo</a>; for <code>y = "comm"</code>,
see <a href="terra.html#topic+plot">plot</a> or <a href="sf.html#topic+plot.sf">plot.sf</a>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A plot of the tree or community data.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ps &lt;- ps_simulate()
plot(ps, "tree")
plot(ps, "comm")
</code></pre>

<hr>
<h2 id='ps_add_dissim'>Add community dissimilarity data to a <code>phylospatial</code> object</h2><span id='topic+ps_add_dissim'></span>

<h3>Description</h3>

<p>This function calculates pairwise phylogenetic dissimilarity between communities and returns the <code>phylospatial</code>
object with the dissimilarity data added as an element called <code>dissim</code>. See <a href="#topic+ps_dissim">ps_dissim</a> for details.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ps_add_dissim(ps, method = "sorensen", ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ps_add_dissim_+3A_ps">ps</code></td>
<td>
<p><code>phylospatial</code> data set.</p>
</td></tr>
<tr><td><code id="ps_add_dissim_+3A_method">method</code></td>
<td>
<p>Dissimilarity metric; see <a href="#topic+ps_dissim">ps_dissim</a> for details.</p>
</td></tr>
<tr><td><code id="ps_add_dissim_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to <a href="#topic+ps_dissim">ps_dissim</a>, such as <code>fun</code>, <code>endemism</code>, or <code>normalize</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p><code>ps</code> with a new <code>dissim</code> element added.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ps &lt;- ps_simulate(data_type = "prob")
ps_add_dissim(ps)
ps_add_dissim(ps, fun = "vegdist", method = "jaccard", endemism = TRUE)

</code></pre>

<hr>
<h2 id='ps_canape'>Categorical Analysis of Neo- and Paleo-Endemism (CANAPE)</h2><span id='topic+ps_canape'></span>

<h3>Description</h3>

<p>This function classifies sites into areas of significant endemism according to the scheme of Mishler et al. (2014).
Categorization is based on randomization quantile values for PE, RPE, and CE (which Mishler et al. call &quot;PE on
the comparison tree&quot;).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ps_canape(rand, alpha = 0.05)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ps_canape_+3A_rand">rand</code></td>
<td>
<p>An object returned by running <code>ps_rand</code> with .</p>
</td></tr>
<tr><td><code id="ps_canape_+3A_alpha">alpha</code></td>
<td>
<p>Numeric value between 0 and 1 giving the one-tailed p-value threshold to use when
determining significance.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Endemism significance categories are defined as follows:
</p>

<ul>
<li><p> Endemism not significant: neither PE nor CE are significantly high at <code>alpha</code>.
</p>
</li>
<li><p> Significant neoendemism: PE or CE are significantly high at <code>alpha</code>; RPE significantly low at <code>alpha / 2</code> (two-tailed test).
</p>
</li>
<li><p> Significant paleoendemism: PE or CE are significantly high at <code>alpha</code>; RPE significantly high at <code>alpha / 2</code> (two-tailed test)..
</p>
</li>
<li><p> Significant mixed-endemism: PE or CE are significantly high at <code>alpha</code>; RPE not significant.
</p>
</li>
<li><p> Significant super-endemism: PE or CE are significantly high at <code>alpha / 5</code>; RPE not significant.
</p>
</li></ul>



<h3>Value</h3>

<p>An object of the same class as <code>rand</code> containing a variable called <code>"canape"</code>, with values 0-4
corresponding to not-significant, mixed-, super-, neo-, and paleo-endemism, respectively.
</p>


<h3>References</h3>

<p>Mishler, B. D., Knerr, N., González-Orozco, C. E., Thornhill, A. H., Laffan, S. W., &amp; Miller, J. T. (2014).
Phylogenetic measures of biodiversity and neo-and paleo-endemism in Australian Acacia. Nature Communications, 5(1), 4473.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# classic CANAPE using binary data and the curveball algorithm
# (note that a real analysis would require a much higher `n_rand`)
set.seed(123456)
ps &lt;- moss()
rand &lt;- ps_rand(ps, metric = c("PE", "RPE", "CE"),
                fun = "nullmodel", method = "curveball",
                n_rand = 25, burnin = 10000, progress = FALSE)
canape &lt;- ps_canape(rand)
terra::plot(canape)


</code></pre>

<hr>
<h2 id='ps_canaper'>Binary randomization tests including CANAPE</h2><span id='topic+ps_canaper'></span>

<h3>Description</h3>

<p>This function is a wrapper around <code>canaper::cpr_rand_test()</code>. It only works with binary community data.
It is largely redundant with <code>ps_rand()</code> and <code>ps_canape()</code>, which are more flexible in supporting data sets
with non-binary community data. However, this function runs faster, and supports custom null models via
<a href="vegan.html#topic+make.commsim">make.commsim</a>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ps_canaper(ps, null_model = "curveball", spatial = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ps_canaper_+3A_ps">ps</code></td>
<td>
<p>phylospatial object</p>
</td></tr>
<tr><td><code id="ps_canaper_+3A_null_model">null_model</code></td>
<td>
<p>see <code>?canaper::cpr_rand_test()</code></p>
</td></tr>
<tr><td><code id="ps_canaper_+3A_spatial">spatial</code></td>
<td>
<p>Logical: should the function return a spatial object (TRUE, default) or a vector (FALSE).</p>
</td></tr>
<tr><td><code id="ps_canaper_+3A_...">...</code></td>
<td>
<p>further arguments passed to <code>canaper::cpr_rand_test()</code></p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function runs <code>canaper::cpr_rand_test()</code>; see the help for that function for details.
</p>
<p>It also runs <code>canaper::cpr_classify_endem()</code> on the result, and includes the resulting classification as an
additional variable, 'endem_type', in the output. 'endem_type' values 0-4 correspond to not-significant, neo,
paleo, mixed, and super endemesim, respectively.
</p>


<h3>Value</h3>

<p>A <code>matrix </code>or <code>SpatRaster</code>, or <code>sf</code> with a column or layer for each metric.
</p>


<h3>References</h3>

<p>Mishler, B. D., Knerr, N., González-Orozco, C. E., Thornhill, A. H., Laffan, S. W., &amp; Miller, J. T. (2014).
Phylogenetic measures of biodiversity and neo-and paleo-endemism in Australian Acacia. Nature Communications, 5(1), 4473.
</p>
<p>Nitta, J. H., Laffan, S. W., Mishler, B. D., &amp; Iwasaki, W. (2023). canaper: categorical analysis
of neo‐and paleo‐endemism in R. Ecography, 2023(9), e06638.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+ps_canape">ps_canape()</a></code>, <code><a href="#topic+ps_rand">ps_rand()</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
if(requireNamespace("canaper")){
      ps &lt;- ps_simulate(data_type = "binary")
      terra::plot(ps_canaper(ps)$pd_obs_p_upper)
}

</code></pre>

<hr>
<h2 id='ps_dissim'>Quantitative phylogenetic dissimilarity</h2><span id='topic+ps_dissim'></span>

<h3>Description</h3>

<p>This function calculates pairwise phylogenetic dissimilarity between communities. It works with both binary and
quantitative community data sets. A wide range of phylogentic community dissimilarity metrics are supported,
including phylogenetic Sorensen's and Jaccard's distances, turnover and nestedness components of Sorensen's distance
(Baselga &amp; Orme, 2012), and phylogenetic versions of all community distance indices provided through the <code>vegan</code> library.
The function also includes options to scale the community matrix in order to focus the analysis on endemism and/or
on proportional differences in community composition. The results from this function can be visualized using
<a href="#topic+ps_rgb">ps_rgb</a> or <a href="#topic+ps_regions">ps_regions</a>, or used in a variety of statistical analyses.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ps_dissim(
  ps,
  method = "sorensen",
  fun = c("vegdist", "designdist", "chaodist"),
  endemism = FALSE,
  normalize = FALSE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ps_dissim_+3A_ps">ps</code></td>
<td>
<p>phylospatial object.</p>
</td></tr>
<tr><td><code id="ps_dissim_+3A_method">method</code></td>
<td>
<p>Character indicating the dissimilarity index to use:
</p>

<ul>
<li><p> &quot;sorensen&quot;: Sorensen's dissimilarity, a.k.a. Bray-Curtis distance (the default)
</p>
</li>
<li><p> &quot;sorensen_turnover&quot;: The turnover component of Sorensen's dissimilarity, a.k.a. Simpson's.
</p>
</li>
<li><p> &quot;sorensen_nestedness&quot;: The nestedness component of Sorensen's dissimilarity.
</p>
</li>
<li><p> Any other valid <code>method</code> passed to <code>fun</code>. For options, see the documentation for those functions.
</p>
</li></ul>
</td></tr>
<tr><td><code id="ps_dissim_+3A_fun">fun</code></td>
<td>
<p>Character indicating which general distance function from the <code>vegan</code> library to use: &quot;<a href="vegan.html#topic+vegdist">vegdist</a>&quot;
(the default), &quot;<a href="vegan.html#topic+designdist">designdist</a>&quot;, or &quot;<a href="vegan.html#topic+chaodist">chaodist</a>&quot;. (While these functions are not explicitly
designed to calculate phylogenetic beta diversity, their use here incorporates the phylogenetic components.)
This argument is ignored if one of the three &quot;sorensen&quot; methods is selected.</p>
</td></tr>
<tr><td><code id="ps_dissim_+3A_endemism">endemism</code></td>
<td>
<p>Logical indicating whether community values should be divided by column totals (taxon range sizes)
to derive endemism before computing distances.</p>
</td></tr>
<tr><td><code id="ps_dissim_+3A_normalize">normalize</code></td>
<td>
<p>Logical indicating whether community values should be divided by row totals (community sums) before
computing distances. If <code>TRUE</code>, dissimilarity is based on proportional community composition. Normalization is
applied after endemism.</p>
</td></tr>
<tr><td><code id="ps_dissim_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to <code>fun</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A pairwise phylogenetic dissimilarity matrix of class <code>dist</code>.
</p>


<h3>References</h3>

<p>Graham, C. H., &amp; Fine, P. V. (2008). Phylogenetic beta diversity: linking ecological and evolutionary
processes across space in time. Ecology Letters, 11(12), 1265-1277.
</p>
<p>Baselga, A., &amp; Orme, C. D. L. (2012). betapart: an R package for the study of beta diversity. Methods in
Ecology and Evolution, 3(5), 808-812.
</p>
<p>Pavoine, S. (2016). A guide through a family of phylogenetic dissimilarity measures among sites.
Oikos, 125(12), 1719-1732.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+ps_add_dissim">ps_add_dissim()</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># example data set:
ps &lt;- ps_simulate(n_tips = 50)

# The default arguments give Sorensen's quantitative dissimilarity index
# (a.k.a. Bray-Curtis distance):
d &lt;- ps_dissim(ps)

# Specifying a custom formula explicitly via `designdist`;
# (this is the Bray-Curtis formula, so it's equivalent to the prior example)
d &lt;- ps_dissim(ps, method = "(b+c)/(2*a+b+c)",
      fun = "designdist", terms = "minimum", abcd = TRUE)

# Alternative arguments can specify a wide range of dissimilarity measures;
# here's endemism-weighted Jaccard's dissimilarity:
d &lt;- ps_dissim(ps, method = "jaccard", endemism = TRUE)

</code></pre>

<hr>
<h2 id='ps_diversity'>Calculate spatial phylogenetic diversity and endemism metrics</h2><span id='topic+ps_diversity'></span>

<h3>Description</h3>

<p>This function calculates a variety of diversity and endemism metrics including Faith's phylogenetic diversity,
Shannon phylogenetic entropy, Simpson phylogentic diversity, relative phylogentic diversity, richness of clades,
richness of terminals (typically species), and versions of all these metrics weighted by endemism (i.e. rarity).
If continuous community data (probabilities or abundances) are provided, they are used in calculations, giving
quantitative versions of the classic binary metrics.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ps_diversity(ps, metric = "all", spatial = TRUE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ps_diversity_+3A_ps">ps</code></td>
<td>
<p>phylospatial object (created by <code>phylospatial()</code> or <code>ps_simulate()</code>).</p>
</td></tr>
<tr><td><code id="ps_diversity_+3A_metric">metric</code></td>
<td>
<p>Character vector containing the abbreviation for one or more diversity metrics listed in
the details below. Can also specify <code>"all"</code> (the default) to calculate all available metrics.</p>
</td></tr>
<tr><td><code id="ps_diversity_+3A_spatial">spatial</code></td>
<td>
<p>Logical: should the function return a spatial object (TRUE, default) or a matrix (FALSE)?</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function calculates the following metrics:
</p>

<ul>
<li><p> TD&mdash;Terminal Diversity, i.e. richness of terminal taxa (in many cases these are species): <code class="reqn">\sum_{t}{p_t}</code>
</p>
</li>
<li><p> TE&mdash;Terminal Endemism, i.e. total endemism-weighted diversity of terminal taxa, a.k.a. &quot;weighted endemism&quot;: <code class="reqn">\sum_{t}{p_t r_t^{-1}}</code>
</p>
</li>
<li><p> CD&mdash;Clade Diversity, i.e. richness of taxa at all levels (equivalent to PD on a cladogram): <code class="reqn">\sum_{b}{p_b}</code>
</p>
</li>
<li><p> CE&mdash;Clade Endemism, i.e. total endemism-weighted diversity of taxa at all levels (equivalent to PE on a cladrogram): <code class="reqn">\sum_{b}{p_b r_b^{-1}}</code>
</p>
</li>
<li><p> PD&mdash;Phylogenetic Diversity: <code class="reqn">\sum_{b}{L_b p_b}</code>
</p>
</li>
<li><p> PE&mdash;Phylogenetic Endemism, i.e. endemism-weighted PD: <code class="reqn">\sum_{b}{L_b p_b r_b^{-1}}</code>
</p>
</li>
<li><p> RPD&mdash;Relative Phylogenetic Diversity, i.e. branch length of mean resident (equivalent to PD / CR): <code class="reqn">\sum_{b}{L_b p_b} / \sum_{b}{p_b}</code>
</p>
</li>
<li><p> RPE&mdash;Relative Phylogenetic Endemism, i.e. mean endemism-weighted branch length (equivalent to PE / CE): <code class="reqn">\sum_{b}{L_b p_b r_b^{-1}} / \sum_{b}{p_b r_b^{-1}}</code>
</p>
</li>
<li><p> ShPD&mdash;Shannon Phylogenetic Diversity, a.k.a. &quot;phylogenetic entropy&quot;: <code class="reqn">-\sum_{b}{L_b n_b log(n_b)}</code>
</p>
</li>
<li><p> ShPE&ndash;Shannon phylogenetic Endemism, an endemism-weighted version of ShPD: <code class="reqn">-\sum_{b}{L_b n_b log(e_b) r_b^{-1}}</code>
</p>
</li>
<li><p> SiPD&mdash;Simpson Phylogenetic Diversity: <code class="reqn">1 / \sum_{b}{L_b n_b^2}</code>
</p>
</li>
<li><p> SiPE&mdash;Simpson Phylogenetic Endemism, an endemism-weighted version of SiPD: <code class="reqn">1 / \sum_{b}{L_b r_b^{-1} e_b^2}</code>
</p>
</li></ul>

<p>where <code class="reqn">b</code> indexes all taxa including terminals and larger clades; <code class="reqn">t</code> indexes terminals only; <code class="reqn">p_i</code> is the occurrence value
(binary, probability, or abundance) of clade/terminal <code class="reqn">i</code> in a given community; <code class="reqn">L_b</code> is the
length of the phylogenetic branch segment unique to clade <code class="reqn">b</code>; and <code class="reqn">r_i</code> is the sum of <code class="reqn">p_i</code> across all sites.
</p>
<p>For Shannon and Simpson indices, only nonzero elements of <code class="reqn">p_b</code> are used, <code class="reqn">n_b = p_b / \sum_{b}{p_b L_b}</code>, and
<code class="reqn">e_b = p_b / \sum_{b}{p_b L_b r_b^{-1}}</code>.
</p>


<h3>Value</h3>

<p>A matrix, <code>sf</code> data frame, or <code>SpatRaster</code> with a column or layer for each requested diversity metric.
</p>


<h3>References</h3>

<p>Faith, D. P. (1992). Conservation evaluation and phylogenetic diversity. Biological Conservation, 61(1), 1-10.
</p>
<p>Laffan, S. W., &amp; Crisp, M. D. (2003). Assessing endemism at multiple spatial scales, with an example from the Australian vascular flora.
Journal of Biogeography, 30(4), 511-520.
</p>
<p>Rosauer, D. A. N., Laffan, S. W., Crisp, M. D., Donnellan, S. C., &amp; Cook, L. G. (2009). Phylogenetic endemism:
a new approach for identifying geographical concentrations of evolutionary history. Molecular Ecology, 18(19), 4061-4072.
</p>
<p>Allen, B., Kon, M., &amp; Bar-Yam, Y. (2009). A new phylogenetic diversity measure generalizing the Shannon index and its
application to phyllostomid bats. The American Naturalist, 174(2), 236-243.
</p>
<p>Chao, A., Chiu, C. H., &amp; Jost, L. (2010). Phylogenetic diversity measures based on Hill numbers. Philosophical Transactions
of the Royal Society B: Biological Sciences, 365(1558), 3599-3609.
</p>
<p>Mishler, B. D., Knerr, N., González-Orozco, C. E., Thornhill, A. H., Laffan, S. W., &amp; Miller, J. T. (2014).
Phylogenetic measures of biodiversity and neo-and paleo-endemism in Australian Acacia. Nature Communications, 5(1), 4473.
</p>
<p>Kling, M. M., Mishler, B. D., Thornhill, A. H., Baldwin, B. G., &amp; Ackerly, D. D. (2019). Facets of phylodiversity: evolutionary
diversification, divergence and survival as conservation targets. Philosophical Transactions of the Royal Society B, 374(1763), 20170397.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ps &lt;- ps_simulate()
div &lt;- ps_diversity(ps)
terra::plot(div)

</code></pre>

<hr>
<h2 id='ps_get_comm'>Get <code>phylospatial</code> community data</h2><span id='topic+ps_get_comm'></span>

<h3>Description</h3>

<p>Get <code>phylospatial</code> community data
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ps_get_comm(ps, tips_only = TRUE, spatial = TRUE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ps_get_comm_+3A_ps">ps</code></td>
<td>
<p><code>phylospatial</code> object.</p>
</td></tr>
<tr><td><code id="ps_get_comm_+3A_tips_only">tips_only</code></td>
<td>
<p>Logical indicating whether only the terminal taxa (TRUE, the default) or all taxa (FALSE) should be returned.</p>
</td></tr>
<tr><td><code id="ps_get_comm_+3A_spatial">spatial</code></td>
<td>
<p>Logical indicating whether a spatial (<code>SpatRaster</code> or <code>sf</code>) object should be returned. Default is <code>TRUE</code>;
if <code>FALSE</code>, a matrix is returned.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Either a <code>SpatRaster</code> with a layer for every taxon, or an <code>sf</code> data frame with a variable for every taxon,
depending on which data type was used to create <code>ps</code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ps &lt;- ps_simulate()

# the defaults return a spatial object of terminal taxa distributions:
ps_get_comm(ps)

# get distributions for all taxa, as a matrix
pcomm &lt;- ps_get_comm(ps, tips_only = FALSE, spatial = FALSE)

</code></pre>

<hr>
<h2 id='ps_ordinate'>Community phylogenetic ordination</h2><span id='topic+ps_ordinate'></span>

<h3>Description</h3>

<p>Perform an ordination that reduces a spatial phylogenetic data set into <code>k</code> dimensions, using one of
several alternative ordination algorithms.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ps_ordinate(ps, method = c("nmds", "cmds", "pca"), k = 3, spatial = TRUE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ps_ordinate_+3A_ps">ps</code></td>
<td>
<p>A <code>phylospatial</code> object with a non-null <code>dissim</code> component, generated by <a href="#topic+ps_add_dissim">ps_add_dissim</a>.</p>
</td></tr>
<tr><td><code id="ps_ordinate_+3A_method">method</code></td>
<td>
<p>Ordination method, either &quot;pca&quot; (principal component analysis implemented via <code>stats::prcomp()</code>),
&quot;cmds&quot; (classical MDS, implemented via <code>stats::cmdscale()</code>), or &quot;nmds&quot; (the default, nonmetric MDS,
implemented via <code>vegan::metaMDS()</code>; this is slower but often preferred).</p>
</td></tr>
<tr><td><code id="ps_ordinate_+3A_k">k</code></td>
<td>
<p>Positive integer giving the desired number of output dimensions; default is <code>3</code>.</p>
</td></tr>
<tr><td><code id="ps_ordinate_+3A_spatial">spatial</code></td>
<td>
<p>Logical indicating whether a spatial object (inherited from <code>ps</code>) should be returned.
Default is TRUE.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A matrix or spatial object with <code>k</code> variables.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ps &lt;- ps_add_dissim(ps_simulate(50, 5, 5))
ord &lt;- ps_ordinate(ps, method = "cmds", k = 4)
terra::plot(ord)

</code></pre>

<hr>
<h2 id='ps_prioritize'>Phylogenetic conservation prioritization</h2><span id='topic+ps_prioritize'></span>

<h3>Description</h3>

<p>Create a ranking of conservation priorities using optimal or probabilistic forward stepwise selection. Prioritization accounts for
the occurrence quantities for all lineages present in the site, including terminal taxa and larger clades; the evolutionary branch
lengths of these lineages on the phylogeny, which represent their unique evolutionary heritage; the impact that protecting the site
would have on these lineages' range-wide protection levels; the compositional complementarity between the site, other high-priority
sites, and existing protected areas; the site's initial protection level; the relative cost of protecting the site; and a free
parameter &quot;lambda&quot; determining the shape of the conservation benefit function.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ps_prioritize(
  ps,
  init = NULL,
  cost = NULL,
  lambda = 1,
  protection = 1,
  max_iter = NULL,
  method = c("optimal", "probable"),
  trans = function(x) replace(x, which(rank(-x) &gt; 25), 0),
  n_reps = 100,
  n_cores = 1,
  summarize = TRUE,
  spatial = TRUE,
  progress = interactive()
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ps_prioritize_+3A_ps">ps</code></td>
<td>
<p>phylospatial object.</p>
</td></tr>
<tr><td><code id="ps_prioritize_+3A_init">init</code></td>
<td>
<p>Optional numeric vector or spatial object giving the starting protection status of each site across the study area.
Values should be between 0 and 1 and represent the existing level of conservation effectiveness in each site. If this argument
is not specified, it is assumed that no existing reserves are present.</p>
</td></tr>
<tr><td><code id="ps_prioritize_+3A_cost">cost</code></td>
<td>
<p>Optional numeric vector or spatial object giving the relative cost of protecting each site. Values should be positive,
with greater values indicating higher cost of conserving a site. If this argument is not specified, cost is assumed to be uniform
across sites.</p>
</td></tr>
<tr><td><code id="ps_prioritize_+3A_lambda">lambda</code></td>
<td>
<p>Shape parameter for taxon conservation benefit function. This can be any real number. Positive values, such as the default
value <code>1</code>, place higher priority on conserving the first part of the range of a given species or clade, while negative values
(which are not typically used) place higher priority on fully protecting the most important taxa (those with small ranges and long branches)
rather than partially protecting all taxa. See the function <a href="#topic+plot_lambda">plot_lambda</a> for an illustration of alternative <code>lambda</code> values.</p>
</td></tr>
<tr><td><code id="ps_prioritize_+3A_protection">protection</code></td>
<td>
<p>Degree of protection of proposed new reserves (number between 0 and 1, with same meaning as <code>init</code>).</p>
</td></tr>
<tr><td><code id="ps_prioritize_+3A_max_iter">max_iter</code></td>
<td>
<p>Integer giving max number of iterations to perform before stopping, i.e. max number of sites to rank.</p>
</td></tr>
<tr><td><code id="ps_prioritize_+3A_method">method</code></td>
<td>
<p>Procedure for selecting which site to add to the reserve network at each iteration:
</p>

<ul>
<li><p> &quot;optimal&quot;: The default, this selects the site with the highest marginal value at each iteration. This is a
optimal approach that gives the same result each time.
</p>
</li>
<li><p> &quot;probable&quot;: This option selects a site randomly, with selection probabilities calculated as a function of sites' marginal values. This
approach gives a different prioritization ranking each time an optimization is performed, so <code>n_reps</code> optimizations are performed,
and ranks for each site are summarized across repetitions.
</p>
</li></ul>
</td></tr>
<tr><td><code id="ps_prioritize_+3A_trans">trans</code></td>
<td>
<p>A function that transforms marginal values into relative selection probabilities; only used if <code>method = "probable"</code>.
The function should take a vector of positive numbers representing marginal values and return an equal-length vector of positive numbers
representing a site's relative likelihood of being selected. The default function returns the marginal value if a site is in the top 25
highest-value sites, and zero otherwise.</p>
</td></tr>
<tr><td><code id="ps_prioritize_+3A_n_reps">n_reps</code></td>
<td>
<p>Number of random repetitions to do; only used if <code>method = "probable"</code>. Depending on the data set, a large number of reps
(more than the default of 100) may be needed in order to achieve a stable result. This may be a computational barrier for large data
sets; multicore processing via <code>n_cores</code> can help.</p>
</td></tr>
<tr><td><code id="ps_prioritize_+3A_n_cores">n_cores</code></td>
<td>
<p>Number of compute cores to use for parallel processing; only used if <code>method = "probable"</code>.</p>
</td></tr>
<tr><td><code id="ps_prioritize_+3A_summarize">summarize</code></td>
<td>
<p>Logical: should summary statistics across reps (TRUE, default) or the reps themselves (FALSE) be returned? Only relevant
if <code>method = "probable"</code>.</p>
</td></tr>
<tr><td><code id="ps_prioritize_+3A_spatial">spatial</code></td>
<td>
<p>Logical: should the function return a spatial object (TRUE, default) or a matrix (FALSE)?</p>
</td></tr>
<tr><td><code id="ps_prioritize_+3A_progress">progress</code></td>
<td>
<p>Logical: should a progress bar be displayed?</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function uses the forward stepwise selection algorithm of Kling et al. (2019) to generate a ranked conservation prioritization.
Prioritization begins with the starting protected lands network identified in <code>init</code>, if provided. At each iteration, the marginal
conservation value of fully protecting each site is calculated, and a site is selected to be added to the reserve network. Selection can
happen either in an &quot;optimal&quot; or &quot;probable&quot; fashion as described under the <code>method</code> argument. This process is repeated until all sites
are fully protected or until <code>max_iter</code> has been reached, with sites selected early in the process considered higher conservation
priorities.
</p>
<p>The benefit of the probabilistic approach is that it relaxes the potentially unrealistic assumption that protected land will actually be
added in the optimal order. Since the algorithm avoids compositional redundancy between high-priority sites, the optimal approach will
never place high priority on a site that has high marginal value but is redundant with a slightly higher-value site, whereas the
probabilistic approach will select them at similar frequencies (though never in the same randomized run).
</p>
<p>Every time a new site is protected as the algorithm progresses, it changes the marginal conservation value of the other sites. Marginal
value is the increase in conservation benefit that would arise from fully protecting a given site, divided by the cost of protecting the
site. This is calculated as a function of the site's current protection level, the quantitative presence probability or abundance of all
terminal taxa and larger clades present in the site, their evolutionary branch lengths on the phylogeny, the impact that protecting the
site would have on their range-wide protection levels, and the free parameter <code>lambda</code>. <code>lambda</code> determines the relative importance of
protecting a small portion of every taxon's range, versus fully protecting the ranges of more valuable taxa (those with longer
evolutionary branches and smaller geographic ranges).
</p>


<h3>Value</h3>

<p>Matrix or spatial object containing a ranking of conservation priorities. Lower rank values represent higher
conservation priorities. All sites with a lower priority than <code>max_iter</code> have a rank value equal to the number
of sites in the input data set (i.e. the lowest possible priority).
</p>

<dl>
<dt>If <code>method = "optimal"</code>. </dt><dd><p>the result contains a single variable &quot;priority&quot; containing the ranking.</p>
</dd>
<dt>If <code>method = "probable"</code> and <code>summarize = TRUE</code>, </dt><dd><p>the &quot;priority&quot; variable gives the average rank across reps,
variables labeled &quot;pctX&quot; give the Xth percentile of the rank distribution for each site, variables labeled &quot;topX&quot;
give the proportion of reps in which a site was in the top X highest-priority sites, and variables labeled &quot;treX&quot; give
a ratio representing &quot;topX&quot; relative to the null expectation of how often &quot;topX&quot; should occur by chance alone.</p>
</dd>
<dt>If <code>method = "probable"</code> and <code>summarize = FALSE</code>, </dt><dd><p>the result contains the full set of <code>n_rep</code> solutions,
each representing the the ranking, with low values representing higher priorities.. </p>
</dd>
</dl>



<h3>References</h3>

<p>Kling, M. M., Mishler, B. D., Thornhill, A. H., Baldwin, B. G., &amp; Ackerly, D. D. (2019). Facets of phylodiversity: evolutionary
diversification, divergence and survival as conservation targets. Philosophical Transactions of the Royal Society B, 374(1763), 20170397.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+benefit">benefit()</a></code>, <code><a href="#topic+plot_lambda">plot_lambda()</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# simulate a toy `phylospatial` data set
set.seed(123)
ps &lt;- ps_simulate()

# basic prioritization
p &lt;- ps_prioritize(ps)

# specifying locations of initial protected areas
# (can be binary, or can be continuous values between 0 and 1)
# here we'll create an `init` raster with arbitrary values ranging from 0-1,
# using the reference raster layer that's part of our `phylospatial` object
protected &lt;- terra::setValues(ps$spatial, seq(0, 1, length.out = 400))
cost &lt;- terra::setValues(ps$spatial, rep(seq(100, 20, length.out = 20), 20))
p &lt;- ps_prioritize(ps, init = protected, cost = cost)

# using probabilistic prioritization
p &lt;- ps_prioritize(ps, init = protected, cost = cost,
      method = "prob", n_reps = 1000, max_iter = 10)
terra::plot(p$top10)

</code></pre>

<hr>
<h2 id='ps_rand'>Null model randomization analysis of alpha diversity metrics</h2><span id='topic+ps_rand'></span>

<h3>Description</h3>

<p>This function compares to diversity metrics calculated in <a href="#topic+ps_diversity">ps_diversity</a> to their null distributions
computed by randomizing the community matrix. Randomization is done using the <a href="#topic+quantize">quantize</a> method for
community matrices containing continuous quantities such as occurrence probabilities or abundances.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ps_rand(
  ps,
  metric = "all",
  fun = "quantize",
  method = "curveball",
  n_rand = 100,
  spatial = TRUE,
  n_cores = 1,
  progress = interactive(),
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ps_rand_+3A_ps">ps</code></td>
<td>
<p><code>phylospatial</code> object.</p>
</td></tr>
<tr><td><code id="ps_rand_+3A_metric">metric</code></td>
<td>
<p>Character vector giving one or more diversity metrics to calculate; see <a href="#topic+ps_diversity">ps_diversity</a>
for options. Can also specify <code>"all"</code> (the default) to calculate all available metrics.</p>
</td></tr>
<tr><td><code id="ps_rand_+3A_fun">fun</code></td>
<td>
<p>Null model function to use. Must be either &quot;quantize&quot;, &quot;nullmodel&quot;, or an actual function:
</p>

<ul>
<li><p> &quot;nullmodel&quot;: uses <a href="vegan.html#topic+nullmodel">nullmodel</a> and <a href="vegan.html#topic+simulate.nullmodel">simulate.nullmodel</a>, from the vegan
package, which offer a wide range of randomization algorithms with different properties.
</p>
</li>
<li><p> &quot;quantize&quot;: (the default) deploys the function <a href="#topic+quantize">quantize</a>, which is a routine that is itself
a wrapper around <a href="vegan.html#topic+nullmodel">nullmodel</a>, allowing the use of binary algorithms for quantitative data.
</p>
</li>
<li><p> Any other function that accepts a community matrix as its first argument and returns a
randomized version of the matrix.
</p>
</li></ul>
</td></tr>
<tr><td><code id="ps_rand_+3A_method">method</code></td>
<td>
<p>One of the method options listed under <a href="vegan.html#topic+commsim">commsim</a>. If <code style="white-space: pre;">&#8288;fun = "quantize&#8288;</code>, this must
be one of the &quot;binary&quot; methods. If <code>fun = "nullmodel"</code>, be sure to select a method that is appropriate to
your community <code>data_type</code> (binary, quantitative, abundance). This argument is ignored if a custom function
is provided to <code>fun</code>.</p>
</td></tr>
<tr><td><code id="ps_rand_+3A_n_rand">n_rand</code></td>
<td>
<p>Integer giving the number of random communities to generate.</p>
</td></tr>
<tr><td><code id="ps_rand_+3A_spatial">spatial</code></td>
<td>
<p>Logical: should the function return a spatial object (TRUE, default) or a matrix (FALSE).</p>
</td></tr>
<tr><td><code id="ps_rand_+3A_n_cores">n_cores</code></td>
<td>
<p>Integer giving the number of compute cores to use for parallel processing.</p>
</td></tr>
<tr><td><code id="ps_rand_+3A_progress">progress</code></td>
<td>
<p>Logical: should a progress bar be displayed?</p>
</td></tr>
<tr><td><code id="ps_rand_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to <a href="#topic+quantize">quantize</a>, <a href="vegan.html#topic+simulate.nullmodel">simulate.nullmodel</a>, or custom function
<code>fun</code>. Note that the <code>nsim</code> argument the former two functions should not be used here; specify <code>n_rand</code> instead.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A matrix with a row for every row of <code>x</code>, a column for every metric specified in <code>metric</code>, and
values indicating the proportion of randomizations in which the observed diversity metric was greater than
the randomized metric. Or if <code>spatial = TRUE</code>, a <code>sf</code> or <code>SpatRaster</code> object containing these data.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+ps_diversity">ps_diversity()</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# simulate a `phylospatial` data set and run randomization with default settings
ps &lt;- ps_simulate(data_type = "prob")
rand &lt;- ps_rand(ps)

# using the default `quantize` function, but with alternative arguments
rand &lt;- ps_rand(ps, transform = sqrt, n_strata = 4, priority = "rows")

# using binary data
ps2 &lt;- ps_simulate(data_type = "binary")
rand &lt;- ps_rand(ps2, fun = "nullmodel", method = "r2")

# using abundance data, and demonstrating alternative metric choices
ps3 &lt;- ps_simulate(data_type = "abund")
rand &lt;- ps_rand(ps3, metric = c("ShPD", "SiPD"), fun = "nullmodel", method = "abuswap_c")
rand

</code></pre>

<hr>
<h2 id='ps_regions'>Cluster analysis to identify phylogenetic regions</h2><span id='topic+ps_regions'></span>

<h3>Description</h3>

<p>Perform a clustering analysis that categorizes sites into biogeographic regions based on phylogenetic community
compositional similarity.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ps_regions(ps, k = 5, method = "average", endemism = FALSE, normalize = TRUE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ps_regions_+3A_ps">ps</code></td>
<td>
<p>A <code>phylospatial</code> object. If <code>method</code> is anything other than <code>"kmeans"</code>, it must contain a
<code>dissim</code> component generated by <a href="#topic+ps_add_dissim">ps_add_dissim</a>.</p>
</td></tr>
<tr><td><code id="ps_regions_+3A_k">k</code></td>
<td>
<p>Number of spatial clusters to divide the region into (positive integer). See <a href="#topic+ps_regions_eval">ps_regions_eval</a> to
help choose a value of k by comparing the variance explained by different numbers of regions.</p>
</td></tr>
<tr><td><code id="ps_regions_+3A_method">method</code></td>
<td>
<p>Clustering method. Options include all methods listed under <a href="stats.html#topic+hclust">hclust</a>, and <code>"kmeans"</code>.
If <code>"kmeans"</code> is selected, the <code>dissim</code> component of <code>ps</code> is ignored.</p>
</td></tr>
<tr><td><code id="ps_regions_+3A_endemism">endemism</code></td>
<td>
<p>Logical indicating whether community values should be divided by column totals (taxon range sizes)
to derive endemism. Only used if <code>method = "kmeans"</code>; in other cases this information should instead be
supplied to <a href="#topic+ps_add_dissim">ps_add_dissim</a>.</p>
</td></tr>
<tr><td><code id="ps_regions_+3A_normalize">normalize</code></td>
<td>
<p>Logical indicating whether community values should be divided by row totals (community sums). If <code>TRUE</code>,
dissimilarity is based on proportional community composition. This happens after endemism is derived. Only used if
<code>method = "kmeans"</code>; in other cases this information should instead be supplied to <a href="#topic+ps_add_dissim">ps_add_dissim</a>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A raster or matrix with an integer indicating which of the <code>k</code> regions each site belongs to.
</p>


<h3>References</h3>

<p>Daru, B. H., Elliott, T. L., Park, D. S., &amp; Davies, T. J. (2017). Understanding the processes underpinning
patterns of phylogenetic regionalization. Trends in Ecology &amp; Evolution, 32(11), 845-860.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ps &lt;- ps_simulate()

# using kmeans clustering algorithm
terra::plot(ps_regions(ps, method = "kmeans"))

# to use a hierarchical clustering method, first we have to `ps_add_dissim()`
terra::plot(ps_regions(ps_add_dissim(ps), k = 7, method = "average"))

</code></pre>

<hr>
<h2 id='ps_regions_eval'>Evaluate region numbers</h2><span id='topic+ps_regions_eval'></span>

<h3>Description</h3>

<p>This function compares multiple potential values for <code>k</code>, the number of clusters in to use in <code>ps_regions()</code>,
to help you decide how well different numbers of regions fit your data set. For each value of <code>k</code>, it performs
a cluster analysis and calculates the proportion of total variance explained (SSE, the sum of squared pairwise
distances explained). It also calculates second-order metrics of the relationship between k and SSE. While
many data sets have no optimal value of <code>k</code> and the choice is often highly subjective, these evaluation metrics
can help you identify potential points where the variance explained stops increasing quickly as <code>k</code> increases.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ps_regions_eval(ps, k = 1:20, plot = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ps_regions_eval_+3A_ps">ps</code></td>
<td>
<p>A <code>phylospatial</code> object. Must contain a <code>dissim</code> component generated by <a href="#topic+ps_add_dissim">ps_add_dissim</a>.</p>
</td></tr>
<tr><td><code id="ps_regions_eval_+3A_k">k</code></td>
<td>
<p>Vector of positive integers giving possible values for <code>k</code>. Values greater than the number of
sites in the data set will be ignored.</p>
</td></tr>
<tr><td><code id="ps_regions_eval_+3A_plot">plot</code></td>
<td>
<p>Logical indicating whether to print a plot of the results (<code>TRUE</code>, the default) or return a data
frame of the results (<code>FALSE</code>).</p>
</td></tr>
<tr><td><code id="ps_regions_eval_+3A_...">...</code></td>
<td>
<p>Further arguments passed to <a href="#topic+ps_regions">ps_regions</a>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>The function generates a data frame with the following columns. If <code>plot = FALSE</code> the data frame is
returned, otherwise the function prints a plot of the latter variables as a function of <code>k</code>:
</p>

<ul>
<li><p> &quot;k&quot;: The number of clusters.
</p>
</li>
<li><p> &quot;sse&quot;: The proportion of total variance explained, with variance defined as squared pairwise community
phylogenetic dissimilarity between sites.
</p>
</li>
<li><p> &quot;curvature&quot;: The local second derivative. Lower (more negative) values indicate more attractive
break-point values of k.
</p>
</li>
<li><p> &quot;dist11&quot;: The distance from the point to the 1:1 line on a plot of <code>k</code> vs <code>sse</code> in which k values over the
interval from 1 to the number of sites are rescaled to the unit interval. Higher values indicate more
attractive values for k.
</p>
</li></ul>



<h3>Examples</h3>

<pre><code class='language-R'>ps &lt;- ps_add_dissim(ps_simulate())
ps_regions_eval(ps, k = 1:15, plot = TRUE)

</code></pre>

<hr>
<h2 id='ps_rgb'>Map phylospatial data onto RGB color bands</h2><span id='topic+ps_rgb'></span>

<h3>Description</h3>

<p>Perform an ordination that reduces a spatial phylogenetic data set into three dimensions that can be
plotted as the RGB bands of color space to visualize spatial patterns of community phylogenetic composition.
This function is a wrapper around <code>ps_ordinate()</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ps_rgb(ps, method = c("nmds", "cmds", "pca"), trans = identity, spatial = TRUE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ps_rgb_+3A_ps">ps</code></td>
<td>
<p>A <code>phylospatial</code> object with a non-null <code>dissim</code> component, generated by <a href="#topic+ps_add_dissim">ps_add_dissim</a>.</p>
</td></tr>
<tr><td><code id="ps_rgb_+3A_method">method</code></td>
<td>
<p>Ordination method, either &quot;pca&quot; (principal component analysis implemented via <code>stats::prcomp()</code>),
&quot;cmds&quot; (classical MDS, implemented via <code>stats::cmdscale()</code>), or &quot;nmds&quot; (the default, nonmetric MDS,
implemented via <code>vegan::metaMDS()</code>; this is slower but often preferred).</p>
</td></tr>
<tr><td><code id="ps_rgb_+3A_trans">trans</code></td>
<td>
<p>A function giving a transformation to apply to each dimension of the ordinated data.
The default is the identity function. Specifying <code>rank</code> generates a more uniform color distribution.</p>
</td></tr>
<tr><td><code id="ps_rgb_+3A_spatial">spatial</code></td>
<td>
<p>Logical indicating whether a spatial object (inherited from <code>ps</code>) should be returned.
Default is TRUE.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A matrix or spatial object with three variables containing RGB color values in the range 0-1.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ps &lt;- ps_add_dissim(moss())
RGB &lt;- ps_rgb(ps, method = "cmds")
terra::plotRGB(RGB * 255, smooth = FALSE)

</code></pre>

<hr>
<h2 id='ps_simulate'>Simulate a toy spatial phylogenetic data set</h2><span id='topic+ps_simulate'></span>

<h3>Description</h3>

<p>This function generates a simple <code>phylospatial</code> object that can be used for testing other functions
in the package. It is not intended to be realistic.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ps_simulate(
  n_tips = 10,
  n_x = 20,
  n_y = 20,
  data_type = c("probability", "binary", "abundance"),
  spatial_type = c("raster", "none"),
  seed = NULL
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="ps_simulate_+3A_n_tips">n_tips</code></td>
<td>
<p>Number of terminals on phylogeny.</p>
</td></tr>
<tr><td><code id="ps_simulate_+3A_n_x">n_x</code></td>
<td>
<p>Number of raster cells in x dimension of landscape.</p>
</td></tr>
<tr><td><code id="ps_simulate_+3A_n_y">n_y</code></td>
<td>
<p>Number of raster cells in y dimension of landscape.</p>
</td></tr>
<tr><td><code id="ps_simulate_+3A_data_type">data_type</code></td>
<td>
<p>Community data type for simulated ranges: either &quot;probability&quot; (default), &quot;binary&quot;, or &quot;abundance&quot;.</p>
</td></tr>
<tr><td><code id="ps_simulate_+3A_spatial_type">spatial_type</code></td>
<td>
<p>Either &quot;raster&quot; or &quot;none&quot;.</p>
</td></tr>
<tr><td><code id="ps_simulate_+3A_seed">seed</code></td>
<td>
<p>Optional integer to seed random number generator.</p>
</td></tr>
</table>


<h3>Value</h3>

<p><code>phylospatial</code> object, comprising a random phylogeny and community matrix in which each terminal has a
circular geographic range with a random radius and location. The spatial reference data is a SpatRaster.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># using all the defaults
ps_simulate()

# specifying some arguments
plot(ps_simulate(n_tips = 50, n_x = 30, n_y = 40, data_type = "abundance"), "comm")
</code></pre>

<hr>
<h2 id='quantize'>Stratified randomization of community matrix</h2><span id='topic+quantize'></span>

<h3>Description</h3>

<p>This is a community null model method for quantitative community data (e.g. abundance or occurrence probability).
It is designed to adapt binary null model algorithms for use with quantitative data, which can be useful if
there is not a quantitative-specific algorithm available that has the desired properties. For example, use with
the binary &quot;curveball&quot; algorithm preserves row and column totals, and also approximately preserves the marginal
distributions of rows and columns. For each randomization, the data set is split into strata representing numerical ranges
of the input quantities, a separate binary randomization is done for each stratum, and the results are
combined to produce a randomized, quantitative community matrix. See <code>vegan::commsim()</code> for details about
other binary and quantitative null models.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>quantize(x, method = "curveball", ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="quantize_+3A_x">x</code></td>
<td>
<p>Community matrix with species in rows, sites in columns, and nonnegative quantities in cells.</p>
</td></tr>
<tr><td><code id="quantize_+3A_method">method</code></td>
<td>
<p>Null model algorithm, passed to <code>vegan::nullmodel</code>. Testing has only been done with the
&quot;curveball&quot; algorithm, so other options should be use with caution. Only binary methods should be used.</p>
</td></tr>
<tr><td><code id="quantize_+3A_...">...</code></td>
<td>
<p>Additional arguments, including:
</p>

<ul>
<li> <p><code>n_strata</code>: Integer giving the number of strata to split the data into. Must be 2 or greater. Larger values
will result in randomizations with less mixing but higher fidelity to marginal distributions. The default is <code>5</code>.
</p>
</li>
<li> <p><code>transform</code>: A function used to transform the values in <code>x</code> before assigning them to <code>n_strata</code>
equal intervals. Examples include <code>sqrt</code>, <code>log</code>, <code>rank</code>, etc.; the default is <code>identity</code>.
</p>
</li>
<li> <p><code>jitter</code>: Number between 0 and 1, indicating how much to randomly jitter the location of stratum boundaries.
</p>
</li>
<li> <p><code>priority</code>: Either <code>"rows"</code>, <code>"cols"</code>, or <code>"neither"</code>, indicating whether randomization within strata should
prioritize maintaining the marginal distributions of the rows or columns of the input matrix. The default,
<code>"neither"</code>, doesn't give precedence to either dimension. Note that this interacts with <code>method</code>, and methods
differ in which margins are fixed.
</p>
</li>
<li><p> Other arguments to be passed to <a href="vegan.html#topic+simulate.nullmodel">simulate.nullmodel</a>, such as <code>seed</code> or <code>burnin</code>. The default
for <code>burnin</code> is <code>10000</code>. Note that <code>nsim</code> and <code>thin</code> are ignored, as they're internally set to 1.
</p>
</li></ul>
</td></tr>
</table>


<h3>Value</h3>

<p>A randomized version of <code>x</code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# example quantitative community matrix
comm &lt;- ps_get_comm(moss("polygon"), tips_only = TRUE, spatial = FALSE)[1:50, 1:50]

# examples of different quantize usage
rand &lt;- quantize(comm)
rand &lt;- quantize(comm, n_strata = 4, transform = sqrt, priority = "rows")
rand &lt;- quantize(comm, method = "swap", burnin = 10)
# (note: this `burnin` value is far too small for a real analysis)


</code></pre>

<hr>
<h2 id='to_spatial'>Convert a site-by-variable matrix into a SpatRaster or sf object</h2><span id='topic+to_spatial'></span>

<h3>Description</h3>

<p>Convert a site-by-variable matrix into a SpatRaster or sf object
</p>


<h3>Usage</h3>

<pre><code class='language-R'>to_spatial(m, template)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="to_spatial_+3A_m">m</code></td>
<td>
<p>Matrix or vector.</p>
</td></tr>
<tr><td><code id="to_spatial_+3A_template">template</code></td>
<td>
<p><code>SpatRaster</code> layer with number of cells equal to the number of rows in m,
or <code>sf</code> data frame with same number of rows as m.</p>
</td></tr>
</table>


<h3>Value</h3>

<p><code>SpatRaster</code> with a layer for every column in <code>m</code>, or <code>sf</code> data frame with
a variable for every column in <code>m</code>, depending on the data type of <code>template</code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>ps &lt;- moss()
to_spatial(ps$comm[, 1:5], ps$spatial)
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
