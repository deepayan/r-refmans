<!DOCTYPE html><html><head><title>Help for package BayesMassBal</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {BayesMassBal}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#BMB'><p>Bayesian Mass Balance</p></a></li>
<li><a href='#constrainProcess'><p>Matrix Constraining Process</p></a></li>
<li><a href='#importObservations'><p>Import Observed Mass Flow Rates</p></a></li>
<li><a href='#mainEff'><p>Main Effects</p></a></li>
<li><a href='#plot.BayesMassBal'><p>Plots BayesMassBal Object</p></a></li>
<li><a href='#pointmassbal'><p>Point Estimate Mass Balance</p></a></li>
<li><a href='#ssEst'><p>Steady State Estimate</p></a></li>
<li><a href='#summary.BayesMassBal'><p>Summary of BayesMassBal Object</p></a></li>
<li><a href='#twonodeSim'><p>Two Node Process Data Simulation</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Bayesian Data Reconciliation of Separation Processes</td>
</tr>
<tr>
<td>Version:</td>
<td>1.1.0</td>
</tr>
<tr>
<td>Author:</td>
<td>Scott Koermer &lt;skoermer@vt.edu&gt;</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Scott Koermer &lt;skoermer@vt.edu&gt;</td>
</tr>
<tr>
<td>Description:</td>
<td>Bayesian tools that can be used to reconcile, or mass balance, mass flow rate data collected from chemical or particulate separation processes aided by constraints governed by the conservation of mass.
    Functions included in the package aid the user in organizing and constraining data, using Markov chain Monte Carlo methods to obtain samples from Bayesian models, and in computation of the marginal likelihood of the data, given a particular model, for model selection.  Marginal likelihood is approximated by methods in Chib S (1995) &lt;<a href="https://doi.org/10.2307%2F2291521">doi:10.2307/2291521</a>&gt;.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a></td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.2.0</td>
</tr>
<tr>
<td>Imports:</td>
<td>Rdpack, Matrix, pracma, tmvtnorm, LaplacesDemon, HDInterval,
coda</td>
</tr>
<tr>
<td>RdMacros:</td>
<td>Rdpack</td>
</tr>
<tr>
<td>Suggests:</td>
<td>knitr, rmarkdown, covr, spelling, tgp, testthat</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://github.com/skoermer/BayesMassBal">https://github.com/skoermer/BayesMassBal</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/skoermer/BayesMassBal/issues">https://github.com/skoermer/BayesMassBal/issues</a></td>
</tr>
<tr>
<td>Language:</td>
<td>en-US</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2022-06-17 21:22:22 UTC; scott</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2022-06-17 22:20:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='BMB'>Bayesian Mass Balance</h2><span id='topic+BMB'></span>

<h3>Description</h3>

<p>Allows the user to specify the covariance structure for a Bayesian mass balance, simulates draws from reconciled masses and relevant covariance matrix, and approximates the log-marginal likelihood.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>BMB(
  X,
  y,
  cov.structure = c("indep", "component", "location"),
  priors = "default",
  BTE = c(500, 20000, 1),
  lml = FALSE,
  ybal = TRUE,
  diagnostics = TRUE,
  verb = 1
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="BMB_+3A_x">X</code></td>
<td>
<p>A matrix that maps constrained masses to observed masses.  Can be built from the function <code><a href="#topic+constrainProcess">constrainProcess</a></code>, see documentation for details.</p>
</td></tr>
<tr><td><code id="BMB_+3A_y">y</code></td>
<td>
<p>A list of matrices of observed mass flow rates. Each matrix is a separate sample component.  The rows of each matrix index the sampling location, and the columns index the sample set number.  Can be specified using the <code><a href="#topic+importObservations">importObservations</a></code> function.</p>
</td></tr>
<tr><td><code id="BMB_+3A_cov.structure">cov.structure</code></td>
<td>
<p>Character string. <code>"indep"</code> allows for no correlation.  <code>"component"</code> indicates correlation within an individual sample component.  <code>"location"</code> indicates correlation within an individual sampling location.  Not specifying <code>cov.structure</code> defaults to the <code>"indep"</code> structure.</p>
</td></tr>
<tr><td><code id="BMB_+3A_priors">priors</code></td>
<td>
<p>List or character string. When the default value <code>priors = "default"</code> is used, the <code>BMB</code> uses a set of default conjugate priors.  When passing a list to the argument, the list must contain user specified hyperparameter values for each conjugate prior.  To see the required list structure run <code>BMB</code> with <code>BTE = c(1,2,1)</code> and inspect the output.  When <code>priors = "Jeffreys"</code> the Jeffreys priors for <code class="reqn">\Sigma</code> and <code class="reqn">\sigma^2</code> with known mean given in (Yang and Berger 1996).  When <code>priors = "Jeffreys"</code>, the prior used for <code class="reqn">\beta</code> is proportional to the indicator function <code class="reqn">I\lbrack \beta &gt; 0 \rbrack</code>.  See Details for more information.</p>
</td></tr>
<tr><td><code id="BMB_+3A_bte">BTE</code></td>
<td>
<p>Numeric vector giving <code>c(Burn-in, Total-iterations, and Every)</code> for MCMC approximation of target distributions. The function <code>BMB</code> produces a total number of samples of <code class="reqn">(T - B)/E</code>.  <code class="reqn">E</code> specifies that only one of every <code class="reqn">E</code> draws are saved. <code class="reqn">E &gt; 1</code> reduces autocorrelation between obtained samples at the expense of computation time.</p>
</td></tr>
<tr><td><code id="BMB_+3A_lml">lml</code></td>
<td>
<p>Logical indicating if the log-marginal likelihood should be approximated.  Default is <code>FALSE</code>, which reduces computation time.  Log-marginal likelihood is approximated using methods in (Chib 1995).</p>
</td></tr>
<tr><td><code id="BMB_+3A_ybal">ybal</code></td>
<td>
<p>Logical indicating if the mass balanced samples for each <code class="reqn">y</code> should be returned.  Default is <code>TRUE</code>. Setting <code>ybal=FALSE</code> results in a savings in RAM and computation time.</p>
</td></tr>
<tr><td><code id="BMB_+3A_diagnostics">diagnostics</code></td>
<td>
<p>Logical or list indicating if diagnostic functions <code><a href="coda.html#topic+geweke.diag">geweke.diag</a></code> and <code><a href="coda.html#topic+effectiveSize">effectiveSize</a></code> (Plummer et al. 2006) should computed for the obtained samples.  The default of <code>TRUE</code> indicates diagnostics should be run with their default parameters.  Alternatively, passing a list of the structure <code>list(frac1 = 0.1, frac2 = 0.5)</code> will run both diagnostics and allow <code><a href="coda.html#topic+geweke.diag">geweke.diag</a></code> to be run with parameters other than the default.</p>
</td></tr>
<tr><td><code id="BMB_+3A_verb">verb</code></td>
<td>
<p>Numeric indicating verbosity of progress printed to R-console.  The default of 1 prints messages and a progress bar to the console during all iterative methods. <code>verb = 0</code> indicates no messages are printed.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>See <code>vignette("Two_Node_Process", package = "BayesMassBal")</code> for further details on how to use function outputs.
</p>
<p>When the <code>priors</code> argument is left unspecified, a set of default conjugate priors are used, which are chosen to allow <code>BMB()</code> to work well in a general setting.  In the current version of the <code>BayesMassBal</code> package, only the conjugate priors stated below can be used, but hyperparameter values can be specified by the user using the <code>priors</code> argument.
</p>
<p>The prior distribution on <code>beta</code> is a normal distribution truncated at 0.  The mean of this distribution before truncation is the <a href="https://en.wikipedia.org/wiki/Ordinary_least_squares">ordinary least squares</a> (OLS) estimate of <code class="reqn">\beta</code>. OLS estimates less than 0, are changed to 0.  The prior variance, before truncation, of each element of <code class="reqn">\beta</code> is set to:
</p>
<p style="text-align: center;"><code class="reqn">10^{\mathrm{number of integer digits of an element of } \beta + 6}</code>
</p>

<p>Currently, there is only support for diagonal prior covariance matrices for <code class="reqn">\beta</code>
</p>
<p>When <code>cov.structure = "indep"</code> the error of all observations in a sample set are independent. An <a href="https://en.wikipedia.org/wiki/Inverse-gamma_distribution">inverse gamma</a> prior distribution, with <code class="reqn">\alpha_0 = 0.000001</code> and <code class="reqn">\beta_0 = 0.000001</code>, is placed on the variance of the mass flow rate for each sample component at each sample location.
</p>
<p>When <code>cov.structure = "component"</code> or <code>"location"</code>, the prior distribution on <code class="reqn">\Sigma_i</code> is <a href="https://en.wikipedia.org/wiki/Inverse-Wishart_distribution">inverse Wishart</a> <code class="reqn">(\nu_0, \nu_0 \times S_0)</code>. The degrees of freedom parameter, <code class="reqn">\nu_0</code>, is equal to the dimension of <code class="reqn">\Sigma_i</code>.  The scale matrix parameter is equal to a matrix, <code class="reqn">S_0</code>, with the sample variance of the relevant observation on the diagonal, multiplied by <code class="reqn">\nu_0</code>.
</p>
<p>The user is able to specify the prior hyperparameters of the mean and variance of <code>beta</code>, <code class="reqn">\alpha_0</code> and <code class="reqn">\beta_0</code> for each <code class="reqn">\sigma^2</code>, and the degrees of freedom and scale matrix for each <code class="reqn">\Sigma_i</code> using the <code>priors</code> argument.  It is advisable for the user to specify their own prior hyperparameters for <code class="reqn">p(\sigma^2)</code> if the variance of any element is well under 1, or <code class="reqn">p(\beta)</code> if the there is a wide range in the magnitude of observations.
</p>
<p>When <code>priors = "Jeffreys"</code> <a href="https://en.wikipedia.org/wiki/Jeffreys_prior">Jeffreys</a> priors are used for the prior distribution of the variance and covariance parameters.  Priors used are <code class="reqn">p(\sigma^2) \propto \frac{1}{\sigma^2}</code> and <code class="reqn">p(\Sigma) \propto |\Sigma|^{-(p+1)/2}</code>, as listed in (Yang and Berger 1996).  The Jeffreys prior for a <code class="reqn">\beta</code> with infinite support is <code class="reqn">p(\beta) \propto 1</code>.  To preserve the prior information that <code class="reqn">\beta &gt; 0</code>, <code class="reqn">p(\beta)\propto I\lbrack \beta &gt; 0 \rbrack</code> is chosen.  It is not possible to calculate log-marginal likelihood using the methods in (Chib 1995) with Jeffreys priors.  Therefore, if <code>priors = "Jeffreys"</code> and <code>lml = TRUE</code>, the <code>lml</code> argument will be ignored and a warning will be printed.
</p>
<p><code>lml</code> is reported in base <code class="reqn">e</code>.  See <a href="https://en.wikipedia.org/wiki/Bayes_factor#Interpretation">here</a> for some guidance on how to interpret Bayes Factors, but note log base 10 is used on Wikipedia.
</p>


<h3>Value</h3>

<p>Returns a list of outputs
</p>
<table>
<tr><td><code>beta</code></td>
<td>
<p>List of matrices of samples from the distribution of reconciled data.  Each matrix in the list is a separate sample component. Each column of a matrix in  <code>beta</code> is a draw from the target distribution.</p>
</td></tr>
<tr><td><code>Sig</code></td>
<td>
<p>List of matrices containing draws from the distribution of each covariance matrix.  If <code>S.t</code> is the <code class="reqn">t^{th}</code> draw from the distribution of covariance matrix <code>S</code> and:
</p>
<ul>
<li> <p><code>cov.structure = "indep"</code>, the <code class="reqn">t^{th}</code> column of a matrix in <code>Sig</code> is <code>diag(S.t)</code>.
</p>
</li>
<li><p><code>cov.structure = "component"</code> or <code>"location"</code>, the <code class="reqn">t^{th}</code> column of a matrix in <code>Sig</code> is equal to <code>S.t[upper.tri(S.t, diag = TRUE)]</code>.</p>
</li></ul>
</td></tr>
<tr><td><code>priors</code></td>
<td>
<p>List of prior hyperparameters used in generating conditional posterior distributions and approximating log-marginal likelihood.  The structure of the input argument <code>priors</code> is required to be the same as the structure of this returned list slice.  See Details.</p>
</td></tr>
<tr><td><code>cov.structure</code></td>
<td>
<p>Character string containing the covariance structure used.</p>
</td></tr>
<tr><td><code>y.cov</code></td>
<td>
<p>List of character matrices indicating details for the structure of each covariance matrix.  Only returned when <code>cov.structure = "location"</code></p>
</td></tr>
<tr><td><code>lml</code></td>
<td>
<p>Numeric of the log-marginal likelihood approximation. Returns <code>NA</code> when <code>lml = FALSE</code></p>
</td></tr>
<tr><td><code>diagnostics</code></td>
<td>
<p>List containing results from diagnostic functions <code><a href="coda.html#topic+geweke.diag">geweke.diag</a></code> and <code><a href="coda.html#topic+effectiveSize">effectiveSize</a></code></p>
</td></tr>
<tr><td><code>ybal</code></td>
<td>
<p>List of samples from the distribution of reconciled mass flow rates, in the same format as the function argument <code>y</code>.  Produced with argument <code>ybal = TRUE</code>.  Equivalent to <code>lapply(BMB(...)$beta,function(X,x){x %*% X} , x = X)</code> .  Viewing this output is more intuitive than viewing samples of <code>beta</code>, at the expense of RAM and some computation time.</p>
</td></tr>
<tr><td><code>X</code></td>
<td>
<p>The function argument <code>X</code> is passed to the output so that it can be used with other <code>BayesMassBal</code> functions.</p>
</td></tr>
<tr><td><code>type</code></td>
<td>
<p>Character string used by <code><a href="#topic+plot.BayesMassBal">plot.BayesMassBal</a></code>.  <code>type = "BMB"</code> for an object returned from the <code>BMB</code> function.</p>
</td></tr>
</table>


<h3>References</h3>

<p>Chib S (1995).
&ldquo;Marginal likelihood from the Gibbs output.&rdquo;
<em>Journal of the american statistical association</em>, <b>90</b>(432), 1313&ndash;1321.
Casella G, George EI (1992).
&ldquo;Explaining the Gibbs sampler.&rdquo;
<em>The American Statistician</em>, <b>46</b>(3), 167&ndash;174.
Plummer M, Best N, Cowles K, Vines K (2006).
&ldquo;CODA: Convergence Diagnosis and Output Analysis for MCMC.&rdquo;
<em>R News</em>, <b>6</b>(1), 7&ndash;11.
<a href="https://journal.r-project.org/archive/">https://journal.r-project.org/archive/</a>.
Yang R, Berger JO (1996).
<em>A catalog of noninformative priors</em>.
Institute of Statistics and Decision Sciences, Duke University.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>y &lt;- importObservations(file = system.file("extdata", "twonode_example.csv",
                                    package = "BayesMassBal"),
                   header = TRUE, csv.params = list(sep = ";"))

C &lt;- matrix(c(1,-1,0,-1,0,0,1,-1,0,-1), byrow = TRUE, ncol = 5, nrow = 2)
X &lt;- constrainProcess(C = C)

BMB_example &lt;- BMB(X = X, y = y, cov.structure = "indep",
                   BTE = c(10,300,1), lml = FALSE, verb=0)

summary(BMB_example)

</code></pre>

<hr>
<h2 id='constrainProcess'>Matrix Constraining Process</h2><span id='topic+constrainProcess'></span>

<h3>Description</h3>

<p>Generates matrix <code class="reqn">X</code> which maps constrained masses <code class="reqn">\beta</code> to observed masses <code class="reqn">y</code> for an individual sample component, when given a linear system of constraining equations.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>constrainProcess(C = NULL, file = FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="constrainProcess_+3A_c">C</code></td>
<td>
<p>Matrix of constraints for a process at steady state.    See Details below.</p>
</td></tr>
<tr><td><code id="constrainProcess_+3A_file">file</code></td>
<td>
<p>Character string indicating file path for a <code>*.csv</code> file containing linear constraints.  Only values of -1, 0, and 1 are valid.  The first row in the <code>file</code> is required to be a header naming the sampling locations.  See Details for an example.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The output of this function is meant to be used as the input parameter <code>X</code> in the <code><a href="#topic+BMB">BMB</a></code> function.  The matrix <code>C</code>, or imported matrix from <code>file</code>, indexes sampling locations via columns, and number of constraints via rows. Only values of -1, 0, and 1 are valid, and indicate mass leaving a node, a location that is not relevant to a node, and mass entering a node respectively.  Constraints should only be indicated around each node. No additional, and no less constraints should be specified.  Additional constraints are redundant.  Each sample component is subject to the same constraints, and therefore the constraints given to <code>constrainProcess</code> do not need to be repeated for each component.
</p>
<p>See <code>vignette("Two_Node_Process")</code> for an application example.
</p>
<p>The file path of a <code>*.csv</code> file, which could be used to indicate the constraints for the process in <code>vignette("Two_Node_Process")</code>, can be found by typing <code>system.file("extdata", "twonode_constraints.csv",package = "BayesMassBal")</code>, and can be used as a template for other processes.
</p>


<h3>Value</h3>

<p>Returns the matrix <code class="reqn">X</code> which maps <code class="reqn">\beta</code> to observed masses <code class="reqn">y</code>.  No changes need to be made to <code>X</code> when using with <code><a href="#topic+BMB">BMB</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
## For a single node process where
## y_1 = y_2 + y_3

C &lt;- matrix(c(1,-1,-1), nrow=  1,ncol = 3)
constrainProcess(C = C)

## For a 2 node process with 1 input and 3 outputs
## as shown in \dontrun{vignette("Two_Node_Process", package = "BayesMassBal")}

C &lt;- matrix(c(1,-1,0,-1,0,0,1,-1,0,-1), byrow = TRUE, ncol = 5, nrow = 2)
constrainProcess(C = C)

## Obtaining the constraints from a .csv file

C &lt;- constrainProcess(file =
 system.file("extdata", "twonode_constraints.csv",package = "BayesMassBal"))

</code></pre>

<hr>
<h2 id='importObservations'>Import Observed Mass Flow Rates</h2><span id='topic+importObservations'></span>

<h3>Description</h3>

<p>Imports observed mass flow rates stored in a <code>*.csv</code> file and then organizes the data for use with the <code><a href="#topic+BMB">BMB</a></code> function.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>importObservations(file, header = TRUE, csv.params = NULL)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="importObservations_+3A_file">file</code></td>
<td>
<p>Character string containing the name of <code>*.csv</code> from file which data will be read.  See Details below for valid file structures.</p>
</td></tr>
<tr><td><code id="importObservations_+3A_header">header</code></td>
<td>
<p>Logical indicating if the first row of <code>file</code> file contains header information.  Current implementation of <code>importObservations</code> discards this information.</p>
</td></tr>
<tr><td><code id="importObservations_+3A_csv.params">csv.params</code></td>
<td>
<p>List of arguments to be passed to <code><a href="utils.html#topic+read.csv">read.csv</a></code></p>
</td></tr>
</table>


<h3>Details</h3>

<p>The purpose of this function is to make it easy to import and structure loosely organized data contained in a <code>*.csv</code> into a list for use as the <code>y</code> argument passed to the <code><a href="#topic+BMB">BMB</a></code> function.
The entries in file must be organized as such:
</p>

<ul>
<li><p> The first column of <code>file</code> must contain an integer sample location. The value of this integer must correspond to the column number used to specify linear constraints in <code><a href="#topic+constrainProcess">constrainProcess</a></code>.  For example, data for a given component collected at sampling location <code class="reqn">y_2</code> should be indicated with a <code>2</code> in the first column of <code>file</code> used with <code>importObservations</code>.  In the <code>file</code> used with <code><a href="#topic+constrainProcess">constrainProcess</a></code>, the linear constraint(s) on <code class="reqn">y_2</code> are indicated in the second column.
</p>
</li>
<li><p> The second column of <code>file</code> must contain sample component names.  <strong>This field is case sensitive</strong>.  Ensure a given sample component is named consistently, including capitalization and spacing.
</p>
</li>
<li><p> Columns 3 to <code class="reqn">K+2</code> of <code>file</code> must contain observed mass flow rates for the <code class="reqn">K</code> collected sample sets.  All observations located in the same column should be collected at the same time.
</p>
</li>
<li><p> Sample components of interest must be specified for each location.  If a sample component is not detected at some locations, but is detected at others, this component should be included in <code>file</code> with a specified mass flow rate of 0, or a very small number.
</p>
</li></ul>

<p><code>importObservations</code> reads the contents of <code>file</code>, sorts the sampling locations numerically, then creates a list of data frames.  Each data frame contains the data for a single sample component.
</p>


<h3>Value</h3>

<p>Returns a list of data frames.  Each data frame is named according to the unique sample components specified in the second column of <code>file</code>.  This list object is intended to be used as the argument <code>y</code> for the <code><a href="#topic+BMB">BMB</a></code> function.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
 y &lt;- importObservations(file = system.file("extdata", "twonode_example.csv",
                                      package = "BayesMassBal"),
                   header = TRUE, csv.params = list(sep = ";"))

## The linear constraints for this example data set are:
C &lt;- matrix(c(1,-1,0,-1,0,0,1,-1,0,-1), byrow = TRUE, ncol = 5, nrow = 2)

## The X matrix for this data set can be found using:
X &lt;- constrainProcess(C = C)
</code></pre>

<hr>
<h2 id='mainEff'>Main Effects</h2><span id='topic+mainEff'></span>

<h3>Description</h3>

<p>Calculates the main effect of a variable, which is independent of process performance, on a function.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>mainEff(
  BMBobj,
  fn,
  rangex,
  xj,
  N = 50,
  res = 100,
  hdi.params = c(1, 0.95),
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="mainEff_+3A_bmbobj">BMBobj</code></td>
<td>
<p>A <code>BayesMassBal</code> object originally obtained from the <code><a href="#topic+BMB">BMB</a></code> function.  See <code><a href="#topic+BMB">BMB</a></code>.</p>
</td></tr>
<tr><td><code id="mainEff_+3A_fn">fn</code></td>
<td>
<p>A character string naming a function with arguments of <code>BMBobj$ybal</code> and independent random variables <code>X</code>.  See Details and examples for more on function requirements.</p>
</td></tr>
<tr><td><code id="mainEff_+3A_rangex">rangex</code></td>
<td>
<p>A numeric matrix.  Each column of <code>rangex</code> contains the minimum and maximum value of uniformly distributed random values making up vector <code class="reqn">x</code>.</p>
</td></tr>
<tr><td><code id="mainEff_+3A_xj">xj</code></td>
<td>
<p>Integer indexing which element in <code class="reqn">x</code> is used for conditioning for  <code class="reqn">E_x\lbrack f(x,y)|x_j\rbrack</code>. If a vector is supplied the marginal main effect of each element is calculated sequentially.  The integers supplied in <code>xj</code> are equivalent to the indices of the columns in <code>rangex</code>.</p>
</td></tr>
<tr><td><code id="mainEff_+3A_n">N</code></td>
<td>
<p>Integer specifying the length of the sequence used for <code>xj</code>.  Larger <code>N</code> trades a higher resolution of the main effect of <code>xj</code> for longer computation time and larger RAM requirements.</p>
</td></tr>
<tr><td><code id="mainEff_+3A_res">res</code></td>
<td>
<p>Integer indicating the number of points to be used for each Monte-Carlo integration step.  Larger <code>res</code> reduces Monte-Carlo variance as the expense of computation time.</p>
</td></tr>
<tr><td><code id="mainEff_+3A_hdi.params">hdi.params</code></td>
<td>
<p>Numeric vector of length two, used to calculate Highest Posterior Density Interval (HPDI) of the main effect <code>xj</code> using <code><a href="HDInterval.html#topic+hdi">hdi</a></code>. <code>hdi.params[1] = 1</code> indicates <code><a href="HDInterval.html#topic+hdi">hdi</a></code> is used, and the mean and HPDI bounds are returned instead of the every sample from the distribution of <code class="reqn">E_x\lbrack f(x,y)|x_j\rbrack</code>.  The second element of <code>hdi</code> is passed to the <code>credMass</code> argument in the <code><a href="HDInterval.html#topic+hdi">hdi</a></code> function.  The default, <code>hdi.params = c(1,0.95)</code>, returns 95% HPDI bounds.</p>
</td></tr>
<tr><td><code id="mainEff_+3A_...">...</code></td>
<td>
<p>Extra arguments passed to the named <code>fn</code></p>
</td></tr>
</table>


<h3>Details</h3>

<p>The <code>mainEff</code> function returns a distribution of <code class="reqn">E_x\lbrack f(x,y)|x_j\rbrack</code>, marginalized over the samples of <code>BMBobj$ybal</code>, giving the distribution of <code class="reqn">E_x\lbrack f(x,y)|x_j\rbrack</code> which incorporates uncertainty of a chemical or particulate process.
</p>
<p>In the current implementation of <code>mainEff</code> in the <code>BayesMassBal</code> package, only uniformly distributed values of <code class="reqn">x</code> are supported.
</p>
<p>The <code class="reqn">f(x,y)</code> is equivalent to the supplied function named in <code>mainEff(fn)</code>.  For the arguments of <code>fn</code>, <code>ybal</code> is structured in a similar manner as <code>BMBobj$ybal</code>.  The only difference being individual columns of each matrix are used at a time, and are vectorized.  Note the way <code>ybal</code> is subset in the example function <code>fn_example</code>.  The supplied <code>X</code> is a matrix, with columns corresponding to each element in <code class="reqn">x</code>.  The output to <code>fn</code> must be a vector of length <code>nrow(x)</code>.  The first argument of <code>fn</code> must be <code>X</code>, the second argument must be <code>BMBobj$ybal</code>.  Order of other arguments passed to <code>fn</code> through <code>...</code> does not matter. Look at the example closely for details!
</p>


<h3>Value</h3>

<p>A list of <code>length(xj)</code> list(s).  Each list specifies output for the main effect of a <code>xj</code>
</p>
<table>
<tr><td><code>g</code></td>
<td>
<p>The grid used for a particular <code>xj</code></p>
</td></tr>
<tr><td><code>fn.out</code></td>
<td>
<p>A matrix giving results on <code class="reqn">E_x\lbrack f(x,y)|x_j\rbrack</code>.  If <code>hdi.params[1] = 1</code>, the mean and Highest Posterior Density Interval (HPDI) bounds of <code class="reqn">E_x\lbrack f(x,y)|x_j\rbrack</code> are returned.  Otherwise, samples of <code class="reqn">E_x\lbrack f(x,y)|x_j\rbrack</code> are returned.  The index of each column of <code>fn.out</code> corresponds to the the value of <code>g</code> at the same index.</p>
</td></tr>
<tr><td><code>fn</code></td>
<td>
<p>Character string giving the name of the function used.  Same value as argument <code>fn</code>.</p>
</td></tr>
<tr><td><code>xj</code></td>
<td>
<p>Integer indicating the index of <code class="reqn">x</code> corresponding to a grouped <code>fn.out</code> and <code>g</code>.</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>
## Importing Data, generating BMB object
y &lt;- importObservations(file = system.file("extdata", "twonode_example.csv",
                                    package = "BayesMassBal"),
                   header = TRUE, csv.params = list(sep = ";"))

C &lt;- matrix(c(1,-1,0,-1,0,0,1,-1,0,-1), byrow = TRUE, ncol = 5, nrow = 2)
X &lt;- constrainProcess(C = C)

BMB_example &lt;- BMB(X = X, y = y, cov.structure = "indep",
                   BTE = c(10,200,1), lml = FALSE, verb=0)

fn_example &lt;- function(X,ybal){
    cu.frac &lt;- 63.546/183.5
    feed.mass &lt;- ybal$CuFeS2[1] + ybal$gangue[1]
    ## Concentrate mass per ton feed
    con.mass &lt;- (ybal$CuFeS2[3] + ybal$gangue[3])/feed.mass
    ## Copper mass per ton feed
    cu.mass &lt;- (ybal$CuFeS2[3]*cu.frac)/feed.mass
    gam &lt;- c(-1,-1/feed.mass,cu.mass,-con.mass,-cu.mass,-con.mass)
    f &lt;- X %*% gam
    return(f)
    }

rangex &lt;- matrix(c(4.00 ,6.25,1125,1875,3880,9080,20,60,96,208,20.0,62.5),
                  ncol = 6, nrow = 2)

mE_example &lt;- mainEff(BMB_example, fn = "fn_example",rangex =  rangex,xj = 3, N = 15, res = 4)

</code></pre>

<hr>
<h2 id='plot.BayesMassBal'>Plots BayesMassBal Object</h2><span id='topic+plot.BayesMassBal'></span>

<h3>Description</h3>

<p>Visualizes data from a <code>BayesMassBal</code> class object in a user specified way.  Options include trace plots, posterior densities, and main effects plots.  Meant to be a quick diagnostic tool, and not to produce publication quality plots.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'BayesMassBal'
plot(
  x,
  sample.params = NA,
  layout = c("trace", "dens"),
  hdi.params = c(1, 0.95),
  ssEst.ylab = "Mass",
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="plot.BayesMassBal_+3A_x">x</code></td>
<td>
<p>A <code>BayesMassBal</code> object returned from the <code><a href="#topic+BMB">BMB</a></code> function</p>
</td></tr>
<tr><td><code id="plot.BayesMassBal_+3A_sample.params">sample.params</code></td>
<td>
<p>List to be used for indicating model parameter samples used for creation of plot(s).  See details for required structure.</p>
</td></tr>
<tr><td><code id="plot.BayesMassBal_+3A_layout">layout</code></td>
<td>
<p>Character string indicating the desired data to be plotted.  <code>"trace"</code> produces trace plots of sequential parameter draws. <code>"dens"</code> produces densities of posterior draws.  Argument ignored when <code>x$type = "time-series"</code>.</p>
</td></tr>
<tr><td><code id="plot.BayesMassBal_+3A_hdi.params">hdi.params</code></td>
<td>
<p>Numeric vector of length two, used to draw Highest Posterior Density Intervals (HPDI) using <code><a href="HDInterval.html#topic+hdi">hdi</a></code>, and otherwise ignored. <code>hdi.params[1] = 1</code> indicates <code><a href="HDInterval.html#topic+hdi">hdi</a></code> bounds should be drawn.  The second element of <code>hdi</code> is passed to <code>credMass</code> in the <code><a href="HDInterval.html#topic+hdi">hdi</a></code> function.  The default, <code>hdi.params = c(1,0.95)</code>, plots the 95% HPDI bounds.</p>
</td></tr>
<tr><td><code id="plot.BayesMassBal_+3A_ssest.ylab">ssEst.ylab</code></td>
<td>
<p>Character string providing the label for the y-axis of a time series plot when object <code>type == "time-series"</code>.  Argument only useful with the output from the <code><a href="#topic+ssEst">ssEst</a></code> function.</p>
</td></tr>
<tr><td><code id="plot.BayesMassBal_+3A_...">...</code></td>
<td>
<p>Passes extra arguments to <code>plot()</code></p>
</td></tr>
</table>


<h3>Details</h3>

<p>The list of <code>sample.params</code> requires a specific structure dependent on the choice of <code>layout</code> and the desired plots.
</p>
<p>If <code>layout = "trace"</code> or <code>layout = "dens"</code>, <code>names(list)</code> must contain each model parameter desired for plotting.  The structure under the model parameter names must be the same as to the structure of the relevant subset of the <code>BayesMassBal</code> object to be used.  For example, if a <code>BayesMassBal</code> object is created using a process with sample components <code>c("CuFeS2","gangue")</code> and the users wants plots of reconciled masses <code class="reqn">y_1</code> and <code class="reqn">y_2</code> for both components to be created, <code>params = list(y.bal = list(CuFeS2 = c(1,2), gangue = c(1,2))</code> should be used.  Note, <code>str(params)</code> mimics <code>str(x)</code>, while the vectors listed simply index the desired model parameters to be plotted.
</p>
<p>See <code>vignette("Two_Node_Process", package = "BayesMassBal")</code> for an example of the required structure.
</p>


<h3>Value</h3>

<p>Plots <code>BayesMassBal</code> object based on arguments passed to <code>plot</code>.
</p>

<hr>
<h2 id='pointmassbal'>Point Estimate Mass Balance</h2><span id='topic+pointmassbal'></span>

<h3>Description</h3>

<p>Function conducting a two component, two node, point estimate mass balance from (Wills 2006) on a two node process.  This function is provided for the purpose of comparing the performance of a Bayesian mass balance to a point estimate mass balance using any output of <code><a href="#topic+twonodeSim">twonodeSim</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>pointmassbal(y)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="pointmassbal_+3A_y">y</code></td>
<td>
<p>A list of matrices of observed mass flow rates. Each matrix is a separate sample component.  The rows of each matrix index the sampling location, and the columns index the sample set number.  Necessary to format exactly the same as the output of <code>twonodeSim()$simulation</code>.  Any arguments to <code><a href="#topic+twonodeSim">twonodeSim</a></code> can be used.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns a list of vectors with mass flow rates <code>yhat</code> and grades <code>ahat</code>.  Similar format to argument <code>y</code>.  The index of a vector in the output is equivalent to the index of a row in <code>y</code>.
</p>


<h3>References</h3>

<p>Wills BA (2006).
<em>Mineral processing technology : an introduction to the practical aspects of ore treatment and mineral recovery</em>.
Butterworth-Heinemann, Oxford Boston.
ISBN 978-0-7506-4450-1.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>y &lt;- twonodeSim()$simulation

yhat &lt;- pointmassbal(y)$yhat

</code></pre>

<hr>
<h2 id='ssEst'>Steady State Estimate</h2><span id='topic+ssEst'></span>

<h3>Description</h3>

<p>Allows for the estimation of process steady state of a single stream for a process using flow rate data.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ssEst(y, BTE = c(100, 1000, 1), stationary = FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="ssEst_+3A_y">y</code></td>
<td>
<p>Vector of mass flow rate observations.  Must be specified sequentially with <code>y[1]</code> as the initial observation.</p>
</td></tr>
<tr><td><code id="ssEst_+3A_bte">BTE</code></td>
<td>
<p>Numeric vector giving <code>c(Burn-in, Total-iterations, and Every)</code> for MCMC approximation of target distributions. The function <code>BMB</code> produces a total number of samples of <code class="reqn">(T - B)/E</code>.  <code class="reqn">E</code> specifies that only one of every <code class="reqn">E</code> draws are saved. <code class="reqn">E &gt; 1</code> reduces autocorrelation between obtained samples at the expense of computation time.</p>
</td></tr>
<tr><td><code id="ssEst_+3A_stationary">stationary</code></td>
<td>
<p>Logical indicating if stationarity will be imposed when generating posterior draws.  See Details.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The model of the following form is fit to the data:
</p>
<p style="text-align: center;"><code class="reqn">y_t = \mu + \alpha y_{t-1} + \epsilon</code>
</p>

<p>Where <code class="reqn">\epsilon \sim \mathcal{N}(0,\sigma^2)</code> and <code class="reqn">t</code> indexes the time step.
</p>
<p>A time series is stationary, and predictable, when <code class="reqn">|\alpha|&lt; 1</code>.  Stationarity can be enforced, using the argument setting <code>stationary = TRUE</code>.  This setting utilizes the priors <code class="reqn">p(\alpha) \sim \mathcal{N}</code>(0, 1000) truncated at (-1,1), and <code class="reqn">p(\mu) \sim \mathcal{N}</code>(0, <code>var(y)*100</code>) for inference, producing a posterior distribution for <code class="reqn">\alpha</code> constrained to be within (-1,1).
</p>
<p>When fitting a model where stationarity is not enforced, the Jeffreys prior of <code class="reqn">p(\mu,\alpha)\propto 1</code> is used.
</p>
<p>The Jeffreys prior of <code class="reqn">p(\sigma^2)\propto 1/\sigma^2</code> is used for all inference of <code class="reqn">\sigma^2</code>
</p>
<p>A stationary time series will have an expected value of:
</p>
<p style="text-align: center;"><code class="reqn">\frac{\mu}{1-\alpha}</code>
</p>

<p>Samples of this expectation are included in the output if <code>stationary = TRUE</code> or if none of the samples of <code class="reqn">\alpha</code> lie outside of (-1,1).
</p>
<p>The output list is a <code>BMB</code> object, passing the output to <code><a href="#topic+plot.BayesMassBal">plot.BayesMassBal</a></code> allows for observation of the results.
</p>


<h3>Value</h3>

<p>Returns a list of outputs
</p>
<table>
<tr><td><code>samples</code></td>
<td>
<p>List of vectors containing posterior draws of model parameters</p>
</td></tr>
<tr><td><code>stationary</code></td>
<td>
<p>Logical indicating the setting of the <code>stationary</code> argument provided to the <code>ssEst</code> function</p>
</td></tr>
<tr><td><code>y</code></td>
<td>
<p>Vector of observations initially passed to the <code>ssEst</code> function.</p>
</td></tr>
<tr><td><code>type</code></td>
<td>
<p>Character string giving details of the model fit.  Primarily included for use with <code><a href="#topic+plot.BayesMassBal">plot.BayesMassBal</a></code></p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>
## Generating Data
y &lt;- rep(NA, times = 21)

y[1] &lt;- 0
mu &lt;- 3
alpha &lt;- 0.3
sig &lt;- 2
for(i in 2:21){
 y[i] &lt;- mu + alpha*y[i-1] + rnorm(1)*sig
}

## Generating draws of model parameters

fit &lt;- ssEst(y, BTE = c(100,500,1))

</code></pre>

<hr>
<h2 id='summary.BayesMassBal'>Summary of BayesMassBal Object</h2><span id='topic+summary.BayesMassBal'></span>

<h3>Description</h3>

<p>Prints a summary table containing mean values and 95
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'BayesMassBal'
summary(object, export = NA, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="summary.BayesMassBal_+3A_object">object</code></td>
<td>
<p>A <code>BayesMassBal</code> object returned from the <code><a href="#topic+BMB">BMB</a></code> function</p>
</td></tr>
<tr><td><code id="summary.BayesMassBal_+3A_export">export</code></td>
<td>
<p>Optional character string specifying location to save a <code>*.csv</code> file containing summary data.  Only data related to mass flow rates is printed.</p>
</td></tr>
<tr><td><code id="summary.BayesMassBal_+3A_...">...</code></td>
<td>
<p>Additional arguments affecting the summary produced.  Not used for a <code>BayesMassBal</code> object.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Current implementation only returns statistics for balanced mass flow rates, taken from <code>x$ybal</code>, and not statistics on <code class="reqn">\beta</code> or variance parameters of <code class="reqn">\sigma^2</code> and <code class="reqn">\Sigma</code>.
</p>
<p>The header entry of the table <code>95% LB</code> should be interpreted as the lower bound of the 95
</p>


<h3>Value</h3>

<p>A summary table printed to the console, and optionally a saved <code>*.csv</code> file saved within the path as specified.
</p>

<hr>
<h2 id='twonodeSim'>Two Node Process Data Simulation</h2><span id='topic+twonodeSim'></span>

<h3>Description</h3>

<p>Simulates data for a stochastic two node, two component process at steady state.  Location indices are the same as what is shown in <code>vignette("Two_Node_Process", package = "BayesMassBal")</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>twonodeSim(
  K = 7,
  feed = list(rate = 100, sd = 6, CuFeS2grade = 1.2),
  rec = list(CuFeS2 = list(mean = c(98, 95)/100, var = c(5e-05, 8e-05)), gangue =
    list(mean = c(7, 4)/100, var = c(5e-05, 2.5e-05))),
  assayNoise = list(CuFeS2 = c(0.15, 0.2, 0.05, 5e-05, 0.005), gangue = c(5, 1, 0.03,
    2, 0.5)),
  truncation = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="twonodeSim_+3A_k">K</code></td>
<td>
<p>Numeric specifying the number of sample sets to be simulated.</p>
</td></tr>
<tr><td><code id="twonodeSim_+3A_feed">feed</code></td>
<td>
<p>List specifying qualities for the process grade.  See default for required structure.  <code>rate</code> is the mean feed rate.  <code>sd</code> is the standard deviation of the feed rate.  <code>CuFeS2grade</code> is the mass percent CuFeS2 present in the feed.  Grade is not stochastic.  See Details for important information on specifying these values.</p>
</td></tr>
<tr><td><code id="twonodeSim_+3A_rec">rec</code></td>
<td>
<p>List specifying mean and variance in process performance.  See default for required structure. <code>rec$component$mean</code> is a vector giving mean fractional recovery of the given component for <code>c(node1,node2)</code>.  <code>rec$component$var</code> gives the variance in the process in a similar manner.  See Details.</p>
</td></tr>
<tr><td><code id="twonodeSim_+3A_assaynoise">assayNoise</code></td>
<td>
<p>List specifying standard deviations of random noise added to simulated process outputs.  See default for required structure.  The index of a vector within the list is equivalent to the index of the sampling location.  See Details section for important information on specifying these values.</p>
</td></tr>
<tr><td><code id="twonodeSim_+3A_truncation">truncation</code></td>
<td>
<p>Logical indicating if the simulation should be rerun, and previous results discarded, until no observed values are less than 0. Default is TRUE.  See details for more information.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Each of the <code>K</code> data sets collected from the <code>twonodeSim()</code> simulation is independent and identically distributed.
</p>
<p>The feed rate to the process is normally distributed with a mean of <code>feed$rate</code>, and a standard deviation of <code>feed$sd</code>.  If the feed rate is sufficiently small, and the standard deviation is sufficiently large, negative feed rates can be generated.
</p>
<p>Process recovery at each node is simulated from a <a href="https://en.wikipedia.org/wiki/Beta_distribution">beta distribution</a>, reparameterized as shown in <a href="https://stats.stackexchange.com/a/12239">this post</a> to make parameter specification more intuitive.  This reparameterization is only valid when <code class="reqn">\sigma^2 \leq \mu(1-\mu)</code>, and the list argument <code>rec</code> must be specified as such.
</p>
<p>The steps of the simulation for each sample set are:
</p>

<ol>
<li><p> Draw a random normally distributed feed rate.
</p>
</li>
<li><p> Draw random values for recovery of the two components at each node.
</p>
</li>
<li><p> Calculate mass flow rate at each location.  These mass flow rates are the <em>true</em> mass flow rates, given the process variability.
</p>
</li>
<li><p> Adds normally distributed noise to each observation as specified in argument <code>assayNoise</code>
</p>
</li></ol>

<p><strong>If the standard deviations supplied to <code>feed</code> and <code>assayNoise</code> are sufficiently large, the simulation can return negative mass flow rates.</strong>
</p>
<p>The argument <code>truncation = TRUE</code> discards negative mass flow rates, and reruns the simulation until all values are non-negative.  For some combinations of a large <code>K</code> and specifications in <code>feed</code> and <code>assayNoise</code>, this can happen frequently.  If if the simulation is run three or more times a warning will be printed that the returned expectations are unreliable.  If this is the case, expectations should be calculated using analytical or Monte-Carlo methods outside of the abilities of this function.  For the default parameters, truncation can occur, but is rare.  The default parameters were chosen in a way that makes a truncation warning highly unlikely.
</p>


<h3>Value</h3>

<p>Returns a list of simulated data and expected values.  List members are as follows:
</p>
<table>
<tr><td><code>simulation</code></td>
<td>
<p>List of matrices giving simulated data.  <code>twonodeSim()$simulation</code> is structured so that it can directly be passed to the <code><a href="#topic+BMB">BMB</a></code> function as the <code>y</code> argument.</p>
</td></tr>
<tr><td><code>expectations</code></td>
<td>
<p>List of matrices giving expected values of the mass flow rate for each component at every location.  See the Details section for information about instances that may create reliability issues with this output.</p>
</td></tr>
</table>


<h3>Examples</h3>

<pre><code class='language-R'>
y &lt;- twonodeSim()$simulation

## Then the BMB function can be run as
C &lt;- matrix(c(1,-1,0,-1,0,0,1,-1,0,-1), byrow = TRUE, ncol = 5, nrow = 2)
X &lt;- constrainProcess(C = C)

BMB(X = X, y = y, BTE = c(100,600,1))
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
