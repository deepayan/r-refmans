<!DOCTYPE html><html lang="en"><head><title>Help for package npiv</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {npiv}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#npiv-package'>
<p>Nonparametric Instrumental Variables Estimation and Inference</p></a></li>
<li><a href='#Engel95'><p> 1995 British Family Expenditure Survey</p></a></li>
<li><a href='#gsl.bs'>
<p>GSL (GNU Scientific Library) B-spline/B-spline Derivatives</p></a></li>
<li><a href='#npiv'>
<p>Nonparametric Instrumental Variable Estimation and Inference</p></a></li>
<li><a href='#npiv_choose_J'>
<p>Data-driven Choice of Sieve Dimension for Nonparametric Instrumental Variables Estimation and Inference</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Nonparametric Instrumental Variables Estimation and Inference</td>
</tr>
<tr>
<td>Version:</td>
<td>0.1.3</td>
</tr>
<tr>
<td>Date:</td>
<td>2024-12-10</td>
</tr>
<tr>
<td>Imports:</td>
<td>progress, MASS, Formula, withr</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Timothy Christensen &lt;timothy.christensen@yale.edu&gt;</td>
</tr>
<tr>
<td>Description:</td>
<td>Implements methods introduced in Chen, Christensen, and Kankanala (2024) &lt;<a href="https://doi.org/10.1093%2Frestud%2Frdae025">doi:10.1093/restud/rdae025</a>&gt; for estimating and constructing uniform confidence bands for nonparametric structural functions using instrumental variables, including data-driven choice of tuning parameters. All methods in this package apply to nonparametric regression as a special case. </td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-3">GPL (&ge; 3)</a></td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>yes</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2025-01-07 18:18:07 UTC; tmc49</td>
</tr>
<tr>
<td>Author:</td>
<td>Jeffrey S. Racine [aut],
  Timothy Christensen [aut, cre],
  Patrick Alken [ctb],
  Rhys Ulerich [ctb],
  Simon N. Wood [ctb]</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2025-01-08 15:10:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='npiv-package'>
Nonparametric Instrumental Variables Estimation and Inference
</h2><span id='topic+npiv-package'></span>

<h3>Description</h3>

<p>This package implements the nonparametric instrumental variables estimation and inference methods described in Chen, Christensen, and Kankanala (2024) and Chen and Christensen (2018). The function <code>npiv</code> estimates the nonparametric structural function <code>h0</code> using B-splines and constructs uniform confidence bands for <code>h0</code>. The function <code>npiv_choose_J</code> performs data-driven choice of sieve dimension. All methods in this package apply to estimation and inference for nonparametric regression as a special case.</p>


<h3>Details</h3>

<p>This package provides a function <code>npiv(...)</code> with a simple interface for performing nonparametric instrumental variable estimation and inference. 
</p>
<p>Given a dependent variable vector <code>Y</code>, matrix of endogenous regressors <code>X</code>, and matrix of instruments <code>W</code>, <code>npiv</code> nonparametrically estimates the structural function <code>h0</code> and its derivative using B-splines. <code>npiv</code> can also be used for estimting the conditional mean <code>h0</code> of <code>Y</code> given <code>X</code>, as as well as the derivative of the conditional mean function, by nonparametric regression. 
</p>
<p>The function <code>npiv</code> also constructs uniform confidence bands for <code>h0</code> and its derivative.
</p>
<p>Sieve dimensions are determined in a data-dependent way if not provided by the user via the function <code>npiv_choose_J</code>, which implements the methods described in Chen, Christensen, and Kankanala (2024). This data-driven choice of sieve dimension ensures estimators of <code>h0</code> and its derivatives converge at the optimal sup-norm rate. The resulting uniform confidence bands for <code>h0</code> and its derivative contract within a logarithmic factor of the optimal rate. In this way, <code>npiv</code> facilitates fully data-driven estimation and uniform inference on <code>h0</code> and its derivative.
</p>
<p>If sieve dimensions are provided by the user, <code>npiv</code> implements the bootstrap-based procedure of Chen and Christensen (2018) to construct uniform confidence bands for <code>h0</code> and its derivative. 
</p>


<h3>Author(s)</h3>

<p>Jeffrey S. Racine &lt;racinej@mcmaster.ca&gt;, Timothy Christensen &lt;timothy.christensen@yale.edu&gt;
</p>
<p>Maintainer: Timothy Christensen &lt;timothy.christensen@yale.edu&gt;
</p>


<h3>References</h3>

<p>Chen, X. and T. Christensen (2018). &ldquo;Optimal Sup-norm Rates and Uniform Inference on Nonlinear Functionals of Nonparametric IV Regression.&rdquo; <em>Quantitative Economics</em>, <strong>9</strong>(1), 39-85. <a href="https://doi.org/10.3982/QE722">doi:10.3982/QE722</a>
</p>
<p>Chen, X., T. Christensen and S. Kankanala (2024). &ldquo;Adaptive Estimation and Uniform Confidence Bands for Nonparametric Structural Functions and Elasticities.&rdquo; <em>Review of Economic Studies</em>, <strong>forthcoming</strong>. <a href="https://doi.org/10.1093/restud/rdae025">doi:10.1093/restud/rdae025</a>
</p>

<hr>
<h2 id='Engel95'> 1995 British Family Expenditure Survey  </h2><span id='topic+Engel95'></span>

<h3>Description</h3>

<p>This dataset is based on a sample taken from the British Family Expenditure Survey for 1995. It includes households consisting of married or cohabiting couples with an employed head of household, aged between 25 and 55 years, and with at most two children. There are 1655 household-level observations in total.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data("Engel95")</code></pre>


<h3>Format</h3>

<p> A data frame with 10 columns, and 1655 rows.
</p>

<dl>
<dt>food</dt><dd><p> expenditure share on food, of type <code>numeric</code></p>
</dd>
<dt>catering</dt><dd><p> expenditure share on catering, of type <code>numeric</code></p>
</dd>
<dt>alcohol</dt><dd><p> expenditure share on alcohol, of type <code>numeric</code></p>
</dd>
<dt>fuel</dt><dd><p> expenditure share on fuel, of type <code>numeric</code></p>
</dd>
<dt>motor</dt><dd><p> expenditure share on motor, of type <code>numeric</code></p>
</dd>
<dt>fares</dt><dd><p> expenditure share on fares, of type <code>numeric</code></p>
</dd>
<dt>leisure</dt><dd><p> expenditure share on leisure, of type <code>numeric</code></p>
</dd>
<dt>logexp</dt><dd><p> logarithm of total expenditure, of type <code>numeric</code></p>
</dd>
<dt>logwages</dt><dd><p> logarithm of total earnings, of type <code>numeric</code></p>
</dd>
<dt>nkids</dt><dd><p> '0' indicates no children, '1' indicates 1-2 children, of type <code>numeric</code></p>
</dd>  
</dl>



<h3>Source</h3>

<p> Richard Blundell and Dennis Kristensen </p>


<h3>References</h3>

<p>Blundell, R., X. Chen and D. Kristensen (2007). &ldquo;Semi-Nonparametric IV Estimation of Shape-Invariant Engel Curves.&rdquo; <em>Econometrica</em>, <strong>75</strong>(6), 1613-1669. <a href="https://doi.org/10.1111/j.1468-0262.2007.00808.x">doi:10.1111/j.1468-0262.2007.00808.x</a>
</p>
<p>Chen, X. and T. Christensen (2018). &ldquo;Optimal Sup-norm Rates and Uniform Inference on Nonlinear Functionals of Nonparametric IV Regression.&rdquo; <em>Quantitative Economics</em>, <strong>9</strong>(1), 39-85. <a href="https://doi.org/10.3982/QE722">doi:10.3982/QE722</a>
</p>
<p>Chen, X., T. Christensen and S. Kankanala (2024). &ldquo;Adaptive Estimation and Uniform Confidence Bands for Nonparametric Structural Functions and Elasticities.&rdquo; <em>Review of Economic Studies</em>, <strong>forthcoming</strong>. <a href="https://doi.org/10.1093/restud/rdae025">doi:10.1093/restud/rdae025</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Load data
data("Engel95", package = "npiv")

## Sort on logexp (the regressor) for plotting purposes
Engel95 &lt;- Engel95[order(Engel95$logexp),] 
attach(Engel95)
logexp.eval &lt;- seq(4.5,6.5,length=100)

## Estimate the Engel curve for food using logwages as an instrument
food_engel &lt;- npiv(food, logexp, logwages, X.eval = logexp.eval)

## Plot the estimated function and uniform confidence bands
plot(food_engel, showdata = TRUE)
</code></pre>

<hr>
<h2 id='gsl.bs'>
GSL (GNU Scientific Library) B-spline/B-spline Derivatives
</h2><span id='topic+gsl.bs'></span><span id='topic+gsl.bs.default'></span><span id='topic+gsl.bs.predict'></span>

<h3>Description</h3>

 <p><code>gsl.bs</code> generates the B-spline basis matrix for a
polynomial spline and (optionally) the B-spline basis matrix
derivative of a specified order with respect to each predictor </p>


<h3>Usage</h3>

<pre><code class='language-R'>gsl.bs(...)
## Default S3 method:
gsl.bs(x,
       degree = 3,
       nbreak = 2,
       deriv = 0,
       x.min = NULL,
       x.max = NULL,
       intercept = FALSE,
       knots = NULL,
       ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="gsl.bs_+3A_x">x</code></td>
<td>
<p> the predictor variable.  Missing values are not allowed </p>
</td></tr>
<tr><td><code id="gsl.bs_+3A_degree">degree</code></td>
<td>
<p> degree of the piecewise polynomial - default is
&lsquo;3&rsquo; (cubic spline) </p>
</td></tr>
<tr><td><code id="gsl.bs_+3A_nbreak">nbreak</code></td>
<td>
<p> number of breaks in each interval - default is &lsquo;2&rsquo;</p>
</td></tr>
<tr><td><code id="gsl.bs_+3A_deriv">deriv</code></td>
<td>
<p> the order of the derivative to be computed-default if
<code>0</code></p>
</td></tr>
<tr><td><code id="gsl.bs_+3A_x.min">x.min</code></td>
<td>
<p> the lower bound on which to construct the spline -
defaults to <code>min(x)</code></p>
</td></tr>
<tr><td><code id="gsl.bs_+3A_x.max">x.max</code></td>
<td>
<p> the upper bound on which to construct the spline -
defaults to <code>max(x)</code></p>
</td></tr>
<tr><td><code id="gsl.bs_+3A_intercept">intercept</code></td>
<td>
<p> if &lsquo;TRUE&rsquo;, an intercept is included in the
basis; default is &lsquo;FALSE&rsquo; </p>
</td></tr>
<tr><td><code id="gsl.bs_+3A_knots">knots</code></td>
<td>
<p> a vector (default <code>knots="NULL"</code>) specifying knots
for the spline basis (default enables uniform knots, otherwise those
provided are used)</p>
</td></tr>
<tr><td><code id="gsl.bs_+3A_...">...</code></td>
<td>
<p> optional arguments </p>
</td></tr>
</table>


<h3>Details</h3>

<p>Typical usages are (see below for a  list of options and also
the examples at the end of this help file)
</p>
<pre>
    B &lt;- gsl.bs(x,degree=10)
    B.predict &lt;- predict(gsl.bs(x,degree=10),newx=xeval)
  </pre>


<h3>Value</h3>

<p><code>gsl.bs</code> returns a <code>gsl.bs</code> object.  A matrix of dimension
&lsquo;c(length(x), degree+nbreak-1)&rsquo;.  The generic function
<code><a href="stats.html#topic+predict">predict</a></code> extracts (or generates) predictions from the
returned object.
</p>
<p>A primary use is in modelling formulas to directly specify a piecewise
polynomial term in a model. See <a href="https://www.gnu.org/software/gsl/">https://www.gnu.org/software/gsl/</a>
for further details.
</p>


<h3>Author(s)</h3>

<p>Jeffrey S. Racine <a href="mailto:racinej@mcmaster.ca">racinej@mcmaster.ca</a>
</p>


<h3>References</h3>

<p>Chen, X., T. Christensen and S. Kankanala (2024). &ldquo;Adaptive Estimation and Uniform Confidence Bands for Nonparametric Structural Functions and Elasticities.&rdquo; <em>Review of Economic Studies</em>, <strong>forthcoming</strong>. <a href="https://doi.org/10.1093/restud/rdae025">doi:10.1093/restud/rdae025</a>
</p>


<h3>See Also</h3>

<p><code><a href="splines.html#topic+bs">bs</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Plot the spline bases and their first order derivatives
x &lt;- seq(0,1,length=100)
matplot(x,gsl.bs(x,degree=5),type="l")
matplot(x,gsl.bs(x,degree=5,deriv=1),type="l")

## Regression example
n &lt;- 1000
x &lt;- sort(runif(n))
y &lt;- cos(2*pi*x) + rnorm(n,sd=.25)
B &lt;- gsl.bs(x,degree=5,intercept=FALSE)
plot(x,y,cex=.5,col="grey")
lines(x,fitted(lm(y~B)))
</code></pre>

<hr>
<h2 id='npiv'>
Nonparametric Instrumental Variable Estimation and Inference
</h2><span id='topic+npiv'></span><span id='topic+npiv.default'></span><span id='topic+npiv.formula'></span>

<h3>Description</h3>

<p><code>npiv</code> performs nonparametric a structural function <code>h0</code> and its derivatives using a B-spline sieve. It also constructs uniform confidence bands for <code>h0</code> and its derivative. 
</p>
<p>Sieve dimensions are determined in a data-dependent way if not provided by the user, via the methods described in Chen, Christensen, and Kankanala (2024). This data-driven choice of sieve dimension ensures estimators of <code>h0</code> and its derivatives converge at the optimal sup-norm rate. The resulting uniform confidence bands for <code>h0</code> and its derivatives also converge at the minimax rate up to log factors; see Chen, Christensen, and Kankanala (2024).
</p>
<p>If sieve dimensions are provided by the user, <code>npiv</code> implements the bootstrap-based procedure of Chen and Christensen (2018) to construct uniform confidence bands based on undersmoothing for <code>h0</code> and its derivatives. 
</p>
<p>The methods in <code>npiv</code> apply to estimation and inference on a nonparametric regression function as a special case.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>npiv(...)

## S3 method for class 'formula'
npiv(formula,
     data=NULL,
     newdata=NULL,
     subset=NULL,
     na.action="na.omit",
     call,
     ...)

## Default S3 method:
npiv(Y,
     X,
     W,
     X.eval=NULL,
     X.grid=NULL,
     alpha=0.05,
     basis=c("tensor","additive","glp"),
     boot.num=99,
     check.is.fullrank=FALSE,
     deriv.index=1,
     deriv.order=1,
     grid.num=50,
     J.x.degree=3,
     J.x.segments=NULL,
     K.w.degree=4,
     K.w.segments=NULL,
     K.w.smooth=2,
     knots=c("uniform","quantiles"),
     progress=TRUE,
     ucb.h=TRUE,
     ucb.deriv=TRUE,
     W.max=NULL,
     W.min=NULL,
     X.min=NULL,
     X.max=NULL,
     ...)

</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="npiv_+3A_formula">formula</code></td>
<td>
 
<p>a symbolic description of the model to be fit.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_data">data</code></td>
<td>
 
<p>an optional data frame containing the variables in the model. 
</p>
</td></tr>
<tr><td><code id="npiv_+3A_newdata">newdata</code></td>
<td>

<p>an optional data frame in which to look for variables with which to predict (i.e., predictors in <code>X</code> passed in <code>X.eval</code> which must contain identically named variables).
</p>
</td></tr>
<tr><td><code id="npiv_+3A_subset">subset</code></td>
<td>

<p>an optional vector specifying a subset of observations to be used in the fitting process (see additional details about how this argument interacts with data-dependent bases in the &lsquo;Details&rsquo; section of the <code><a href="stats.html#topic+model.frame">model.frame</a></code> documentation).
</p>
</td></tr>
<tr><td><code id="npiv_+3A_na.action">na.action</code></td>
<td>

<p>a function which indicates what should happen when the data contain NAs. The default is set by the <code>na.action</code> setting of <code><a href="base.html#topic+options">options</a></code>, and is <code><a href="stats.html#topic+na.fail">na.fail</a></code> if that is unset. The &lsquo;factory-fresh&rsquo; default is <code><a href="stats.html#topic+na.omit">na.omit</a></code>. Another possible value is <code>NULL</code>, no action. Value <code><a href="stats.html#topic+na.exclude">na.exclude</a></code> can be useful.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_call">call</code></td>
<td>

<p>the original function call (this is passed internally by <code><a href="#topic+npiv">npiv</a></code>). It is not recommended that the user set this.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_y">Y</code></td>
<td>

<p>dependent variable vector.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_x">X</code></td>
<td>

<p>matrix of endogenous regressors.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_w">W</code></td>
<td>

<p>matrix of instrumental variables. Set <code>W=X</code> for nonparametric regression.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_x.eval">X.eval</code></td>
<td>

<p>optional matrix of evaluation data for the endogenous regressors.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_x.grid">X.grid</code></td>
<td>

<p>optional vector of grid points for <code>X</code> when determining model complexity. Default (<code>X.grid=NULL</code>) uses 50 equally spaced points (can be changed in <code>grid.num</code>) over the support of each <code>X</code> variable.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_alpha">alpha</code></td>
<td>

<p>nominal size of the uniform confidence bands. Default is <code>0.05</code> for 95% uniform confidence bands.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_basis">basis</code></td>
<td>

<p>basis type (if <code>X</code> or <code>W</code> are multivariate), a character string. Options are:
</p>
<p><code>tensor</code> tensor product basis. Default option.
</p>
<p><code>additive</code> additive basis for additively separable models.
</p>
<p><code>glp</code> generalized B-spline polynomial basis.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_boot.num">boot.num</code></td>
<td>

<p>number of bootstrap replications.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_check.is.fullrank">check.is.fullrank</code></td>
<td>

<p>check that <code>X</code> and <code>W</code> have full rank. Default is <code>FALSE</code>.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_deriv.index">deriv.index</code></td>
<td>

<p>integer indicating the column of <code>X</code> for which to compute the derivative.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_deriv.order">deriv.order</code></td>
<td>

<p>integer indicating the order of derivative to be computed.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_grid.num">grid.num</code></td>
<td>

<p>number of grid points for each <code>X</code> variable if <code>X.grid</code> is not provided.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_j.x.degree">J.x.degree</code></td>
<td>

<p>B-spline degree (integer or vector of integers of length <code>ncol(X)</code>) for approximating the structural function. Default is <code>degree=3</code> (cubic B-spline).
</p>
</td></tr>
<tr><td><code id="npiv_+3A_j.x.segments">J.x.segments</code></td>
<td>

<p>B-spline number of segments (integer or vector of integers of length <code>ncol(X)</code>) for approximating the structural function. Default is <code>NULL</code>. If either <code>J.x.segments=NULL</code> or <code>K.w.segments=NULL</code>, these are both chosen automatically using <code><a href="#topic+npiv_choose_J">npiv_choose_J</a></code>.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_k.w.degree">K.w.degree</code></td>
<td>

<p>B-spline degree (integer or vector of integers of lenth <code>ncol(W)</code>) for estimating the nonparametric first-stage. Default is <code>degree=4</code> (quartic B-spline).
</p>
</td></tr>
<tr><td><code id="npiv_+3A_k.w.segments">K.w.segments</code></td>
<td>

<p>B-spline number of segments (integer or vector of integers of length <code>ncol(W)</code>) estimating the nonparametric first stage. Defulat is <code>NULL</code>. If either <code>J.x.segments=NULL</code> or <code>K.w.segments=NULL</code>, these are both chosen automatically using <code><a href="#topic+npiv_choose_J">npiv_choose_J</a></code>.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_k.w.smooth">K.w.smooth</code></td>
<td>

<p>non-negative integer. Basis for the nonparametric first-stage uses <code class="reqn">2^{K.w.smooth}</code> more B-spline segments for each instrument than the basis approximating the structural function. Default is <code>2</code>. Setting <code>K.w.smooth=0</code> uses the same number of segments for <code>X</code> and <code>W</code>.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_knots">knots</code></td>
<td>

<p>knots type, a character string. Options are:
</p>
<p><code>quantiles</code> interior knots are placed at equally spaced quantiles (equal number of observations lie in each segment). 
</p>
<p><code>uniform</code> interior knots are placed at equally spoaced intervals over the support of the variable. Default option.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_progress">progress</code></td>
<td>

<p>whether to display progress bar or not. Default is <code>TRUE</code>.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_ucb.h">ucb.h</code></td>
<td>

<p>whether to compute a uniform confidence band for the structural function. Default is <code>TRUE</code>.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_ucb.deriv">ucb.deriv</code></td>
<td>

<p>whether to compute a uniform confidence band for the derivative of the structural function. Default is <code>TRUE</code>.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_w.min">W.min</code></td>
<td>

<p>lower bound on the support of each <code>W</code> variable. Default is <code>min(W)</code>.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_w.max">W.max</code></td>
<td>

<p>upper bound on the support of each <code>W</code> variable. Default is <code>max(W)</code>.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_x.min">X.min</code></td>
<td>

<p>lower bound on the support of each <code>X</code> variable. Default is <code>min(X)</code>.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_x.max">X.max</code></td>
<td>

<p>upper bound on the support of each <code>X</code> variable. Default is <code>max(X)</code>.
</p>
</td></tr>
<tr><td><code id="npiv_+3A_...">...</code></td>
<td>

<p>optional arguments
</p>
</td></tr>
</table>


<h3>Details</h3>

<p><code>npiv</code> estimates and constructs uniform confidence bands for a nonparametric structural function <code class="reqn">h_0</code> and its derivatives in the model 
<code class="reqn">Y=h_0(X)+U,\quad E[U|W]=0\quad{(\rm almost\, surely).}</code>
Estimation is performed using nonparametric two-stage least-squares with a B-spline sieve. The key tuning parameter is the dimension <code class="reqn">J</code> of the sieve used to approximate <code class="reqn">h_0</code>. The dimension is tuned via modifying the number and placement of interior knots in the B-spline basis  (equivalently, the number of segments of the basis). Sieve dimensions can be user-provided or data-determined using the procedure of Chen, Christensen, and Kankanala (2024).
</p>
<p>Typical usages mirror <code>ivreg</code> (see above and below for a list of options and the example at the bottom of this document)
</p>
<pre>
    foo &lt;- npiv(y~x|w)
    foo &lt;- npiv(y~x1+x2|w1+w2)
    foo &lt;- npiv(Y=y,X=x,W=w)
  </pre>
<p><code>npiv</code> can be used in two ways:
</p>
<p>1. Data-driven sieve dimension is invoked if either <code>K.w.segments</code> or <code>J.x.segments</code> are unspecified or <code>NULL</code> (the default). Sieve dimensions are chosen automatically using <code>npiv_choose_J</code>. Uniform confidence bands for <code class="reqn">h_0</code> and its derivatives are constructed using the data-driven method of Chen, Christensen, and Kankanala (2024).
</p>
<p>2. The user may specify the sieve dimensions of both bases by specifying values for <code>K.w.segments</code> and <code>J.x.segments</code>. Uniform confidence bands for <code class="reqn">h_0</code> and its derivatives are constructed using the method of Chen and Christensen (2018).
</p>
<p><code>npiv</code> can also be used for estimation and inference on a nonparametric regression function by setting <code>W=X</code>.
</p>


<h3>Value</h3>

<p><code>npiv</code> returns a <code>npiv</code> object. The generic function <code><a href="stats.html#topic+fitted">fitted</a></code> extracts the estimated values for the sample (or evaluation data, if provided), while the generic function <code><a href="stats.html#topic+residuals">residuals</a></code> extracts the sample residuals. The generic function <code><a href="base.html#topic+summary">summary</a></code> provides a simple model summary. The generic function <code><a href="base.html#topic+plot">plot</a></code> also plots the estimated function and derivative, together with uniform confidence bands.
</p>
<p>The function <code>npiv</code> returns a list with the following components:
</p>
<table role = "presentation">
<tr><td><code>h</code></td>
<td>
<p>estimated structural function evaluated at the sample data (or evaluation data, if provided).</p>
</td></tr>
<tr><td><code>residuals</code></td>
<td>
<p>residuals for the sample data.</p>
</td></tr>
<tr><td><code>deriv</code></td>
<td>
<p>estimated derivative of the structural function evaluated at the sample data (or evaluation data, if provided).</p>
</td></tr>
<tr><td><code>asy.se</code></td>
<td>
<p>pre-asymptotic standard errors for the estimator of the structural function evaluated at the sample data (or evaluation data, if provided) </p>
</td></tr>
<tr><td><code>deriv.asy.se</code></td>
<td>
<p>pre-asymptotic standard errors for the estimator of the derivative of the structural function evaluated at the sample data (or evaluation data, if provided).</p>
</td></tr>
<tr><td><code>deriv.index</code></td>
<td>
<p>index for the estimated derivative.</p>
</td></tr>
<tr><td><code>deriv.order</code></td>
<td>
<p>order of the estimated derivative.</p>
</td></tr>
<tr><td><code>K.w.degree</code></td>
<td>
<p>value of <code>K.w.degree</code> used.</p>
</td></tr>
<tr><td><code>K.w.segments</code></td>
<td>
<p>value of <code>K.w.segments</code> used (will be data-determined if not provided).</p>
</td></tr>
<tr><td><code>J.x.degree</code></td>
<td>
<p>value of <code>J.x.degree</code> used.</p>
</td></tr>
<tr><td><code>J.x.segments</code></td>
<td>
<p>value of <code>J.x.segments</code> used (will be data-determined if not provided).</p>
</td></tr>
<tr><td><code>beta</code></td>
<td>
<p>vector of estimated spline coefficients.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Jeffrey S. Racine &lt;racinej@mcmaster.ca&gt;, Timothy Christensen &lt;timothy.christensen@yale.edu&gt;
</p>


<h3>References</h3>

<p>Chen, X. and T. Christensen (2018). &ldquo;Optimal Sup-norm Rates and Uniform Inference on Nonlinear Functionals of Nonparametric IV Regression.&rdquo; <em>Quantitative Economics</em>, <strong>9</strong>(1), 39-85. <a href="https://doi.org/10.3982/QE722">doi:10.3982/QE722</a>
</p>
<p>Chen, X., T. Christensen and S. Kankanala (2024). &ldquo;Adaptive Estimation and Uniform Confidence Bands for Nonparametric Structural Functions and Elasticities.&rdquo; <em>Review of Economic Studies</em>, <strong>forthcoming</strong>. <a href="https://doi.org/10.1093/restud/rdae025">doi:10.1093/restud/rdae025</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+npiv_choose_J">npiv_choose_J</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## load data
data("Engel95", package = "npiv")

## sort on logexp (the regressor) for plotting purposes
Engel95 &lt;- Engel95[order(Engel95$logexp),] 
attach(Engel95)

## Estimate the Engel curve for food using logwages as an instrument
fm1 &lt;- npiv(food ~ logexp | logwages)

## Plot the estimated Engel curve and data-driven uniform confidence bands
plot(logexp,food,
     ylab="Food Budget Share",
     xlab="log(Total Household Expenditure)",
     xlim=c(4.75, 6.25),
     ylim=c(0, 0.4),
     main="",
     type="p",
     cex=.5,
     col="lightgrey")
lines(logexp,fm1$h,col="blue",lwd=2,lty=1)
lines(logexp,fm1$h.upper,col="blue",lwd=2,lty=2)
lines(logexp,fm1$h.lower,col="blue",lwd=2,lty=2)

## Estimate the Engel curve using pre-specified sieve dimension 
## (dimension 5 for logexp, dimension 9 for logwages)
fm2 &lt;- npiv(food ~ logexp | logwages,
            J.x.segments = 2,
            K.w.segments = 5)

## Plot uniform confidence bands based on undersmoothing
lines(logexp,fm2$h.upper,col="red",lwd=2,lty=2)
lines(logexp,fm2$h.lower,col="red",lwd=2,lty=2)

## Plot pointwise confidence bands based on pre-asymptotic standard errors
lines(logexp,fm2$h+1.96*fm2$asy.se,col="red",lwd=2,lty=3)
lines(logexp,fm2$h-1.96*fm2$asy.se,col="red",lwd=2,lty=3)

legend("topright",
       legend=c("Data-driven Estimate",
                "Data-driven UCBs",
                "Undersmoothed UCBs",
                "Pointwise CBs"),
       col=c("blue","blue","red","red"),
       lty=c(1,2,2,3),
       lwd=c(2,2,2,2))

## Plot the data-driven estimate of the derivative of the Engel curve
plot(logexp,fm1$deriv,col="blue",lwd=2,lty=1,type="l",
     ylab="Derivative of Food Budget Share",
     xlab="log(Total Household Expenditure)",
     xlim=c(4.75, 6.25),
     ylim=c(-1,1))

## Plot data-driven uniform confidence bands for the derivative
lines(logexp,fm1$h.upper.deriv,col="blue",lwd=2,lty=2)
lines(logexp,fm1$h.lower.deriv,col="blue",lwd=2,lty=2)

## Plot uniform confidence bands based on undersmoothing
lines(logexp,fm2$h.upper.deriv,col="red",lwd=2,lty=2)
lines(logexp,fm2$h.lower.deriv,col="red",lwd=2,lty=2)

## Plot pointwise confidence bands based on pre-asymptotic standard errors
lines(logexp,fm2$deriv+1.96*fm2$deriv.asy.se,col="red",lwd=2,lty=3)
lines(logexp,fm2$deriv-1.96*fm2$deriv.asy.se,col="red",lwd=2,lty=3)

legend("topright",
       legend=c("Data-driven Estimate",
                "Data-driven UCBs",
                "Undersmoothed UCBs",
                "Pointwise CBs"),
       col=c("blue","blue","red","red"),
       lty=c(1,2,2,3),
       lwd=c(2,2,2,2))
</code></pre>

<hr>
<h2 id='npiv_choose_J'>
Data-driven Choice of Sieve Dimension for Nonparametric Instrumental Variables Estimation and Inference
</h2><span id='topic+npiv_choose_J'></span>

<h3>Description</h3>

<p><code>npiv_choose_J</code> implements the data-driven choice of sieve dimension developed in Chen, Christensen, and Kankanala (2024) for nonparametric instrumental variables estimation using a B-spline sieve. It applies to nonparametric regression as a special case.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>npiv_choose_J(Y, 
              X,
              W,
              X.grid = NULL,
              J.x.degree = 3,
              K.w.degree = 4,
              K.w.smooth = 2,
              knots = c("uniform", "quantiles"),
              basis = c("tensor", "additive", "glp"),
              X.min = NULL,
              X.max = NULL,
              W.min = NULL,
              W.max = NULL,
              grid.num = 50,
              boot.num = 99,
              check.is.fullrank = FALSE,
              progress = TRUE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="npiv_choose_J_+3A_y">Y</code></td>
<td>

<p>dependent variable vector.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_x">X</code></td>
<td>

<p>matrix of endogenous regressors.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_w">W</code></td>
<td>

<p>matrix of instrumental variables. Set <code>W=X</code> for nonparametric regression.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_x.grid">X.grid</code></td>
<td>

<p>vector of grid point(s). Default uses 50 equally spaced points over the support of each <code>X</code> variable.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_j.x.degree">J.x.degree</code></td>
<td>

<p>B-spline degree (integer or vector of integers of length <code>ncol(X)</code>) for approximating the structural function. Default is <code>degree=3</code> (cubic B-spline).
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_k.w.degree">K.w.degree</code></td>
<td>

<p>B-spline degree (integer or vector of integers of lenth <code>ncol(W)</code>) for estimating the nonparametric first-stage. Default is <code>degree=4</code> (quartic B-spline).
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_k.w.smooth">K.w.smooth</code></td>
<td>

<p>non-negative integer. Basis for the nonparametric first-stage uses <code class="reqn">2^{K.w.smooth}</code> more B-spline segments for each instrument than the basis approximating the structural function. Default is <code>2</code>. Setting <code>K.w.smooth=0</code> uses the same number of segments for <code>X</code> and <code>W</code>.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_knots">knots</code></td>
<td>

<p>knots type, a character string. Options are:
</p>
<p><code>quantiles</code> interior knots are placed at equally spaced quantiles (equal number of observations lie in each segment). 
</p>
<p><code>uniform</code> interior knots are placed at equally spoaced intervals over the support of the variable. Default option.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_basis">basis</code></td>
<td>

<p>basis type (if <code>X</code> or <code>W</code> are multivariate), a character string. Options are:
</p>
<p><code>tensor</code> tensor product basis. Default option.
</p>
<p><code>additive</code> additive basis for additively separable models.
</p>
<p><code>glp</code> generalized B-spline polynomial basis.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_x.min">X.min</code></td>
<td>

<p>lower bound on the support of each <code>X</code> variable. Default is <code>min(X)</code>.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_x.max">X.max</code></td>
<td>

<p>upper bound on the support of each <code>X</code> variable. Default is <code>max(X)</code>.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_w.min">W.min</code></td>
<td>

<p>lower bound on the support of each <code>W</code> variable. Default is <code>min(W)</code>.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_w.max">W.max</code></td>
<td>

<p>upper bound on the support of each <code>W</code> variable. Default is <code>max(W)</code>.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_grid.num">grid.num</code></td>
<td>

<p>number of grid points for each <code>X</code> variable if <code>X.grid</code> is not provided.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_boot.num">boot.num</code></td>
<td>

<p>number of bootstrap replications.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_check.is.fullrank">check.is.fullrank</code></td>
<td>

<p>check that <code>X</code> and <code>W</code> have full rank. Default is <code>FALSE</code>.
</p>
</td></tr>
<tr><td><code id="npiv_choose_J_+3A_progress">progress</code></td>
<td>

<p>whether to display progress bar or not. Default is <code>TRUE</code>.
</p>
</td></tr>  
</table>


<h3>Value</h3>

<table role = "presentation">
<tr><td><code>J.hat.max</code></td>
<td>
<p>largest element of candidate set of sieve dimensions searched over.</p>
</td></tr>
<tr><td><code>J.hat.n</code></td>
<td>
<p>second largest element of candidate set of sieve dimensions searched over.</p>
</td></tr>
<tr><td><code>J.hat</code></td>
<td>
<p>bootstrap-based Lepski choice of sieve dimension.</p>
</td></tr>
<tr><td><code>J.tilde</code></td>
<td>
<p>data-driven choice of sieve dimension using the method of Chen, Christensen, and Kankanala (2024). Minimum of <code>J.hat</code> and <code>J.hat.n</code>.</p>
</td></tr>
<tr><td><code>J.x.seg</code></td>
<td>
<p>data-driven number of segments for <code>X</code> using the method of Chen, Christensen, and Kankanala (2024).</p>
</td></tr>
<tr><td><code>K.w.seg</code></td>
<td>
<p>data-driven number of segments for <code>W</code> using the method of Chen, Christensen, and Kankanala (2024).</p>
</td></tr>
<tr><td><code>theta.star</code></td>
<td>
<p>Lepski critical value used in determination of <code>J.hat</code>.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Jeffrey S. Racine &lt;racinej@mcmaster.ca&gt;, Timothy Christensen &lt;timothy.christensen@yale.edu&gt;
</p>


<h3>References</h3>

<p>Chen, X., T. Christensen and S. Kankanala (2024). &ldquo;Adaptive Estimation and Uniform Confidence Bands for Nonparametric Structural Functions and Elasticities.&rdquo; <em>Review of Economic Studies</em>, <strong>forthcoming</strong>. <a href="https://doi.org/10.1093/restud/rdae025">doi:10.1093/restud/rdae025</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+npiv">npiv</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>library(MASS)

## Simulate the data
n &lt;- 10000
cov.ux &lt;- 0.5
var.u &lt;- 0.1
mu &lt;- c(1,1,0)
Sigma &lt;- matrix(c(1.0,0.85,cov.ux,
                  0.85,1.0,0.0,
                  cov.ux,0.0,1.0),
                3,3,
                byrow=TRUE)
foo &lt;- mvrnorm(n = n,
               mu,
               Sigma)
X &lt;- 2*pnorm(foo[,1],mean=mu[1],sd=sqrt(Sigma[1,1])) -1
W &lt;- 2*pnorm(foo[,2],mean=mu[2],sd=sqrt(Sigma[2,2])) -1
U &lt;- foo[,3]
## Cosine structural function
h0 &lt;- sin(pi*X)
Y &lt;- h0 + sqrt(var.u)*U

npiv_choose_J(Y,X,W)
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
