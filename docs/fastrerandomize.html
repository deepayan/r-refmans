<!DOCTYPE html><html lang="en"><head><title>Help for package fastrerandomize</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {fastrerandomize}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#build_backend'><p>A function to build the environment for fastrerandomize. Builds a conda environment in which 'JAX' and 'np' are installed. Users can also create a conda environment where 'JAX' and 'np' are installed themselves.</p></a></li>
<li><a href='#check_jax_availability'><p>Check if 'Python' and 'JAX' are available</p></a></li>
<li><a href='#fastrerandomize_class'><p>Constructor for fastrerandomize randomizations</p></a></li>
<li><a href='#fastrerandomize_test'><p>Constructor for fastrerandomize randomization test objects</p></a></li>
<li><a href='#generate_randomizations'><p>Generate randomizations for a rerandomization-based experimental design</p></a></li>
<li><a href='#generate_randomizations_exact'><p>Generate Complete Randomizations with Optional Balance Constraints</p></a></li>
<li><a href='#generate_randomizations_mc'><p>Draws a random sample of acceptable randomizations from all possible complete randomizations using Monte Carlo sampling</p></a></li>
<li><a href='#plot.fastrerandomize_randomizations'><p>Plot method for fastrerandomize_test objects</p></a></li>
<li><a href='#plot.fastrerandomize_test'><p>Plot method for fastrerandomize_test objects</p></a></li>
<li><a href='#print.fastrerandomize_randomizations'><p>Print method for fastrerandomize_randomizations objects</p></a></li>
<li><a href='#print.fastrerandomize_test'><p>Print method for fastrerandomize_test objects</p></a></li>
<li><a href='#print2'><p>Print timestamped messages with optional quieting</p></a></li>
<li><a href='#QJEData'><p>QJEData: Agricultural Treatment Experiment Data</p></a></li>
<li><a href='#randomization_test'><p>Fast randomization test</p></a></li>
<li><a href='#summary.fastrerandomize_randomizations'><p>Summary method for fastrerandomize_randomizations objects</p></a></li>
<li><a href='#summary.fastrerandomize_test'><p>Summary method for fastrerandomize_test objects</p></a></li>
<li><a href='#YOPData'><p>YOPData</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Title:</td>
<td>Hardware-Accelerated Rerandomization for Improved Balance</td>
</tr>
<tr>
<td>Version:</td>
<td>0.2</td>
</tr>
<tr>
<td>Description:</td>
<td>Provides hardware-accelerated tools for performing rerandomization
    and randomization testing in experimental research. Using a 'JAX' backend, the
    package enables exact rerandomization inference even for large experiments
    with hundreds of billions of possible randomizations. Key functionalities
    include generating pools of acceptable rerandomizations based on covariate
    balance, conducting exact randomization tests, and performing pre-analysis
    evaluations to determine optimal rerandomization acceptance thresholds. The
    package supports various hardware acceleration frameworks including 'CPU',
    'CUDA', and 'METAL', making it versatile across accelerated computing environments. This
    allows researchers to efficiently implement stringent rerandomization designs and
    conduct valid inference even with large sample sizes. The package is partly based on Jerzak and Goldstein (2023) &lt;<a href="https://doi.org/10.48550%2FarXiv.2310.00861">doi:10.48550/arXiv.2310.00861</a>&gt;. </td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://github.com/cjerzak/fastrerandomize-software">https://github.com/cjerzak/fastrerandomize-software</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/cjerzak/fastrerandomize-software/issues">https://github.com/cjerzak/fastrerandomize-software/issues</a></td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 3.5.0)</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a></td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>LazyData:</td>
<td>false</td>
</tr>
<tr>
<td>Imports:</td>
<td>reticulate, assertthat, utils, stats, graphics</td>
</tr>
<tr>
<td>Suggests:</td>
<td>knitr, rmarkdown</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.3.2</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2025-01-14 03:02:08 UTC; cjerzak</td>
</tr>
<tr>
<td>Author:</td>
<td>Fucheng Warren Zhu
    <a href="https://orcid.org/0009-0001-5692-7572"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [aut],
  Aniket Sachin Kamat
    <a href="https://orcid.org/0009-0003-6411-1084"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [aut],
  Connor Jerzak <a href="https://orcid.org/0000-0003-1914-8905"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre],
  Rebecca Goldstein <a href="https://orcid.org/0000-0002-9944-8440"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Connor Jerzak &lt;connor.jerzak@gmail.com&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2025-01-14 08:00:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='build_backend'>A function to build the environment for fastrerandomize. Builds a conda environment in which 'JAX' and 'np' are installed. Users can also create a conda environment where 'JAX' and 'np' are installed themselves.</h2><span id='topic+build_backend'></span>

<h3>Description</h3>

<p>A function to build the environment for fastrerandomize. Builds a conda environment in which 'JAX' and 'np' are installed. Users can also create a conda environment where 'JAX' and 'np' are installed themselves.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>build_backend(conda_env = "fastrerandomize", conda = "auto")
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="build_backend_+3A_conda_env">conda_env</code></td>
<td>
<p>(default = <code>"fastrerandomize"</code>) Name of the conda environment in which to place the backends.</p>
</td></tr>
<tr><td><code id="build_backend_+3A_conda">conda</code></td>
<td>
<p>(default = <code>auto</code>) The path to a conda executable. Using <code>"auto"</code> allows reticulate to attempt to automatically find an appropriate conda binary.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Invisibly returns NULL; this function is used for its side effects
of creating and configuring a conda environment for <code>fastrerandomize</code>.
This function requires an Internet connection.
You can find out a list of conda Python paths via: <code>Sys.which("python")</code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
# Create a conda environment named "fastrerandomize"
# and install the required Python packages (jax, numpy, etc.)
build_backend(conda_env = "fastrerandomize", conda = "auto")

# If you want to specify a particular conda path:
# build_backend(conda_env = "fastrerandomize", conda = "/usr/local/bin/conda")

## End(Not run)

</code></pre>

<hr>
<h2 id='check_jax_availability'>Check if 'Python' and 'JAX' are available</h2><span id='topic+check_jax_availability'></span>

<h3>Description</h3>

<p>This function checks if 'Python' and 'JAX' can be accessed via 'reticulate'. If not,
it returns 'NULL' and prints a message suggesting to run 'build_backend()'.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>check_jax_availability(conda_env = "fastrerandomize", conda = "auto")
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="check_jax_availability_+3A_conda_env">conda_env</code></td>
<td>
<p>A character string specifying the name of the conda environment. 
Default is '&quot;fastrerandomize&quot;'.</p>
</td></tr>
<tr><td><code id="check_jax_availability_+3A_conda">conda</code></td>
<td>
<p>The path to a conda executable, or '&quot;auto&quot;'. Default is '&quot;auto&quot;'.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns &lsquo;TRUE' (invisibly) if both &rsquo;Python' and 'JAX' are available; otherwise returns 'NULL'.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
  check_jax_availability()

## End(Not run)

</code></pre>

<hr>
<h2 id='fastrerandomize_class'>Constructor for fastrerandomize randomizations</h2><span id='topic+fastrerandomize_class'></span>

<h3>Description</h3>

<p>Create an S3 object of class <code>fastrerandomize_randomizations</code> that stores
the randomizations (and optionally balance statistics) generated by 
functions such as <code><a href="#topic+generate_randomizations">generate_randomizations</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>fastrerandomize_class(
  randomizations,
  balance = NULL,
  fastrr_env = NULL,
  call = NULL
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="fastrerandomize_class_+3A_randomizations">randomizations</code></td>
<td>
<p>A matrix or array where each row (or slice) represents one 
randomization.</p>
</td></tr>
<tr><td><code id="fastrerandomize_class_+3A_balance">balance</code></td>
<td>
<p>A numeric vector or similar object holding balance statistics 
for each randomization, or <code>NULL</code> if not applicable.</p>
</td></tr>
<tr><td><code id="fastrerandomize_class_+3A_fastrr_env">fastrr_env</code></td>
<td>
<p>Associated <code>fastrr_env</code> environment.</p>
</td></tr>
<tr><td><code id="fastrerandomize_class_+3A_call">call</code></td>
<td>
<p>The function call, if you wish to store it for reference (optional).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An object of class <code>fastrerandomize_randomizations</code>.
</p>

<hr>
<h2 id='fastrerandomize_test'>Constructor for fastrerandomize randomization test objects</h2><span id='topic+fastrerandomize_test'></span>

<h3>Description</h3>

<p>Constructor for fastrerandomize randomization test objects
</p>


<h3>Usage</h3>

<pre><code class='language-R'>fastrerandomize_test(p_value, FI, tau_obs, fastrr_env = NULL, call = NULL, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="fastrerandomize_test_+3A_p_value">p_value</code></td>
<td>
<p>A numeric value representing the p-value of the test.</p>
</td></tr>
<tr><td><code id="fastrerandomize_test_+3A_fi">FI</code></td>
<td>
<p>A numeric vector (length 2) representing the fiducial interval, or <code>NULL</code> if not requested.</p>
</td></tr>
<tr><td><code id="fastrerandomize_test_+3A_tau_obs">tau_obs</code></td>
<td>
<p>A numeric value (or vector) representing the estimated treatment effect.</p>
</td></tr>
<tr><td><code id="fastrerandomize_test_+3A_fastrr_env">fastrr_env</code></td>
<td>
<p>Associated 'fastrr_env' environment.</p>
</td></tr>
<tr><td><code id="fastrerandomize_test_+3A_call">call</code></td>
<td>
<p>An optional function call, stored for reference.</p>
</td></tr>
<tr><td><code id="fastrerandomize_test_+3A_...">...</code></td>
<td>
<p>Other slots you may want to store (e.g. additional diagnostics).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An object of class <code>fastrerandomize_test</code>.
</p>

<hr>
<h2 id='generate_randomizations'>Generate randomizations for a rerandomization-based experimental design</h2><span id='topic+generate_randomizations'></span>

<h3>Description</h3>

<p>This function generates randomizations for experimental design using either exact enumeration
or Monte Carlo sampling methods. It provides a unified interface to both approaches while
handling memory and computational constraints appropriately.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>generate_randomizations(
  n_units,
  n_treated,
  X = NULL,
  randomization_accept_prob,
  threshold_func = NULL,
  max_draws = 10^6,
  batch_size = 1000,
  randomization_type = "monte_carlo",
  approximate_inv = TRUE,
  file = NULL,
  return_type = "R",
  verbose = TRUE,
  conda_env = "fastrerandomize",
  conda_env_required = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="generate_randomizations_+3A_n_units">n_units</code></td>
<td>
<p>An integer specifying the total number of experimental units.</p>
</td></tr>
<tr><td><code id="generate_randomizations_+3A_n_treated">n_treated</code></td>
<td>
<p>An integer specifying the number of units to be assigned to treatment.</p>
</td></tr>
<tr><td><code id="generate_randomizations_+3A_x">X</code></td>
<td>
<p>A numeric matrix of covariates used for balance checking. Cannot be <code>NULL</code>.</p>
</td></tr>
<tr><td><code id="generate_randomizations_+3A_randomization_accept_prob">randomization_accept_prob</code></td>
<td>
<p>A numeric value between 0 and 1 specifying the probability threshold for accepting randomizations based on balance.</p>
</td></tr>
<tr><td><code id="generate_randomizations_+3A_threshold_func">threshold_func</code></td>
<td>
<p>A 'JAX' function that computes a balance measure for each randomization. Only used for Monte Carlo sampling.</p>
</td></tr>
<tr><td><code id="generate_randomizations_+3A_max_draws">max_draws</code></td>
<td>
<p>An integer specifying the maximum number of randomizations to draw in Monte Carlo sampling.</p>
</td></tr>
<tr><td><code id="generate_randomizations_+3A_batch_size">batch_size</code></td>
<td>
<p>An integer specifying batch size for Monte Carlo processing.</p>
</td></tr>
<tr><td><code id="generate_randomizations_+3A_randomization_type">randomization_type</code></td>
<td>
<p>A string specifying the type of randomization: either <code>"exact"</code> or <code>"monte_carlo"</code>.</p>
</td></tr>
<tr><td><code id="generate_randomizations_+3A_approximate_inv">approximate_inv</code></td>
<td>
<p>A logical value indicating whether to use an approximate inverse
(diagonal of the covariance matrix) instead of the full matrix inverse when computing
balance metrics. This can speed up computations for high-dimensional covariates.
Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="generate_randomizations_+3A_file">file</code></td>
<td>
<p>A string specifying where to save candidate randomizations (if saving, not returning).</p>
</td></tr>
<tr><td><code id="generate_randomizations_+3A_return_type">return_type</code></td>
<td>
<p>A string specifying the format of the returned randomizations and balance
measures. Allowed values are <code>"R"</code> for base R objects (e.g., <code>matrix</code>, <code>numeric</code>)
or <code>"jax"</code> for 'JAX' arrays. Default is <code>"R"</code>.</p>
</td></tr>
<tr><td><code id="generate_randomizations_+3A_verbose">verbose</code></td>
<td>
<p>A logical value indicating whether to print progress information. Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="generate_randomizations_+3A_conda_env">conda_env</code></td>
<td>
<p>A character string specifying the name of the conda environment to use
via <code>reticulate</code>. Default is <code>"fastrerandomize"</code>.</p>
</td></tr>
<tr><td><code id="generate_randomizations_+3A_conda_env_required">conda_env_required</code></td>
<td>
<p>A logical indicating whether the specified conda environment
must be strictly used. If <code>TRUE</code>, an error is thrown if the environment is not found.
Default is <code>TRUE</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function supports two methods of generating randomizations:
</p>

<ol>
<li><p> Exact enumeration: Generates all possible randomizations (memory intensive but exact).
</p>
</li>
<li><p> Monte Carlo sampling: Generates randomizations through sampling (more memory efficient).
</p>
</li></ol>

<p>For large problems (e.g., X with &gt;20 rows), Monte Carlo sampling is recommended.
</p>


<h3>Value</h3>

<p>Returns an S3 object with slots: </p>

<ul>
<li> <p><code>assignments</code> An array where each row represents one possible treatment assignment vector containing the accepted randomizations.
</p>
</li>
<li> <p><code>balance_measures</code> A numeric vector containing the balance measure for each corresponding randomization.
</p>
</li>
<li> <p><code>fastrr_env</code> The fastrerandomize environment.
</p>
</li>
<li> <p><code>file_output</code> If file is specified, results are saved to the given file path instead of being returned.
</p>
</li></ul>



<h3>See Also</h3>

<p><code><a href="#topic+generate_randomizations_exact">generate_randomizations_exact</a></code> for the exact enumeration method.
<code><a href="#topic+generate_randomizations_mc">generate_randomizations_mc</a></code> for the Monte Carlo sampling method.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
## Not run: 
# Generate synthetic data 
X &lt;- matrix(rnorm(20*5), 20, 5)

# Generate randomizations using exact enumeration
RandomizationSet_Exact &lt;- generate_randomizations(
               n_units = nrow(X), 
               n_treated = round(nrow(X)/2), 
               X = X, 
               randomization_accept_prob=0.1,
               randomization_type="exact")

# Generate randomizations using Monte Carlo sampling
RandomizationSet_MC &lt;- generate_randomizations(
               n_units = nrow(X), 
               n_treated = round(nrow(X)/2), 
               X = X,
               randomization_accept_prob = 0.1,
               randomization_type = "monte_carlo",
               max_draws = 100000,
               batch_size = 1000)
 
## End(Not run)

</code></pre>

<hr>
<h2 id='generate_randomizations_exact'>Generate Complete Randomizations with Optional Balance Constraints</h2><span id='topic+generate_randomizations_exact'></span>

<h3>Description</h3>

<p>Generates all possible treatment assignments for a completely randomized experiment,
optionally filtering them based on covariate balance criteria. The function can
generate either all possible randomizations or a subset that meets specified
balance thresholds using Hotelling's T-squared statistic.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>generate_randomizations_exact(
  n_units,
  n_treated,
  X = NULL,
  randomization_accept_prob = 1,
  approximate_inv = TRUE,
  threshold_func = NULL,
  verbose = TRUE,
  conda_env = "fastrerandomize",
  conda_env_required = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="generate_randomizations_exact_+3A_n_units">n_units</code></td>
<td>
<p>An integer specifying the total number of experimental units</p>
</td></tr>
<tr><td><code id="generate_randomizations_exact_+3A_n_treated">n_treated</code></td>
<td>
<p>An integer specifying the number of units to be assigned to treatment</p>
</td></tr>
<tr><td><code id="generate_randomizations_exact_+3A_x">X</code></td>
<td>
<p>A numeric matrix of covariates where rows represent units and columns
represent different covariates. Default is <code>NULL</code>, in which case all possible
randomizations are returned without balance filtering.</p>
</td></tr>
<tr><td><code id="generate_randomizations_exact_+3A_randomization_accept_prob">randomization_accept_prob</code></td>
<td>
<p>A numeric value between 0 and 1 specifying the
quantile threshold for accepting randomizations based on balance statistics.
Default is 1 (accept all randomizations).</p>
</td></tr>
<tr><td><code id="generate_randomizations_exact_+3A_approximate_inv">approximate_inv</code></td>
<td>
<p>A logical value indicating whether to use an approximate inverse 
(diagonal of the covariance matrix) instead of the full matrix inverse when computing 
balance metrics. This can speed up computations for high-dimensional covariates.
Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="generate_randomizations_exact_+3A_threshold_func">threshold_func</code></td>
<td>
<p>A function that calculates balance statistics for candidate
randomizations. Default is <code>VectorizedFastHotel2T2</code> which computes Hotelling's T-squared
statistic.</p>
</td></tr>
<tr><td><code id="generate_randomizations_exact_+3A_verbose">verbose</code></td>
<td>
<p>A logical value indicating whether to print progress information. Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="generate_randomizations_exact_+3A_conda_env">conda_env</code></td>
<td>
<p>A character string specifying the name of the conda environment to use 
via <code>reticulate</code>. Default is &quot;fastrerandomize&quot;.</p>
</td></tr>
<tr><td><code id="generate_randomizations_exact_+3A_conda_env_required">conda_env_required</code></td>
<td>
<p>A logical indicating whether the specified conda environment 
must be strictly used. If <code>TRUE</code>, an error is thrown if the environment is not found. 
Default is TRUE.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function works in two main steps:
1. Generates all possible combinations of treatment assignments given n_units
and n_treated
2. If covariates (X) are provided, filters these combinations based on balance
criteria using the specified threshold function
</p>
<p>The balance filtering process uses Hotelling's T-squared statistic by default to measure
multivariate balance between treatment and control groups. Randomizations are
accepted if their balance measure is below the specified quantile threshold.
</p>


<h3>Value</h3>

<p>The function returns a <em>list</em> with two elements:
<code>candidate_randomizations</code>: an array of randomization vectors
<code>M_candidate_randomizations</code>: an array of their balance measures.
</p>


<h3>Note</h3>

<p>This function requires 'JAX' and 'NumPy' to be installed and accessible through
the reticulate package.
</p>


<h3>References</h3>

<p>Hotelling, H. (1931). The generalization of Student's ratio. 
The Annals of Mathematical Statistics, 2(3), 360-378.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+generate_randomizations">generate_randomizations</a></code> for full randomization generation function. 
<code><a href="#topic+generate_randomizations_mc">generate_randomizations_mc</a></code> for the Monte Carlo version.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
## Not run: 
# Generate synthetic data 
X &lt;- matrix(rnorm(60), nrow = 10)  # 10 units, 6 covariates

# Generate balanced randomizations with covariates
BalancedRandomizations &lt;- generate_randomizations_exact(
  n_units = 10,
  n_treated = 5,
  X = X,
  randomization_accept_prob = 0.25  # Keep top 25% most balanced
)

## End(Not run)

</code></pre>

<hr>
<h2 id='generate_randomizations_mc'>Draws a random sample of acceptable randomizations from all possible complete randomizations using Monte Carlo sampling</h2><span id='topic+generate_randomizations_mc'></span>

<h3>Description</h3>

<p>This function performs sampling with replacement to generate randomizations in a memory-efficient way.
It processes randomizations in batches to avoid memory issues and filters them based on covariate balance.
The function uses JAX for fast computation and memory management.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>generate_randomizations_mc(
  n_units,
  n_treated,
  X,
  randomization_accept_prob = 1,
  threshold_func = NULL,
  max_draws = 1e+05,
  batch_size = 1000,
  approximate_inv = TRUE,
  verbose = TRUE,
  conda_env = "fastrerandomize",
  conda_env_required = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="generate_randomizations_mc_+3A_n_units">n_units</code></td>
<td>
<p>An integer specifying the total number of experimental units.</p>
</td></tr>
<tr><td><code id="generate_randomizations_mc_+3A_n_treated">n_treated</code></td>
<td>
<p>An integer specifying the number of units to be assigned to treatment.</p>
</td></tr>
<tr><td><code id="generate_randomizations_mc_+3A_x">X</code></td>
<td>
<p>A numeric matrix of covariates used for balance checking. Cannot be NULL.</p>
</td></tr>
<tr><td><code id="generate_randomizations_mc_+3A_randomization_accept_prob">randomization_accept_prob</code></td>
<td>
<p>A numeric value between 0 and 1 specifying the probability threshold for accepting randomizations based on balance. Default is 1</p>
</td></tr>
<tr><td><code id="generate_randomizations_mc_+3A_threshold_func">threshold_func</code></td>
<td>
<p>A JAX function that computes a balance measure for each randomization. Must be vectorized using <code>jax$vmap</code> with <code>in_axes = list(NULL, 0L, NULL, NULL)</code>, and inputs covariates (matrix of X), treatment_assignment (vector of 0s and 1s), n0 (scalar), n1 (scalar). Default is <code>VectorizedFastHotel2T2</code> which uses Hotelling's T-squared statistic.</p>
</td></tr>
<tr><td><code id="generate_randomizations_mc_+3A_max_draws">max_draws</code></td>
<td>
<p>An integer specifying the maximum number of randomizations to draw.</p>
</td></tr>
<tr><td><code id="generate_randomizations_mc_+3A_batch_size">batch_size</code></td>
<td>
<p>An integer specifying how many randomizations to process at once. Lower values use less memory but may be slower.</p>
</td></tr>
<tr><td><code id="generate_randomizations_mc_+3A_approximate_inv">approximate_inv</code></td>
<td>
<p>A logical value indicating whether to use an approximate inverse
(diagonal of the covariance matrix) instead of the full matrix inverse when computing
balance metrics. This can speed up computations for high-dimensional covariates.
Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="generate_randomizations_mc_+3A_verbose">verbose</code></td>
<td>
<p>A logical value indicating whether to print detailed information about batch processing progress, and GPU memory usage. Default is <code>FALSE</code>.</p>
</td></tr>
<tr><td><code id="generate_randomizations_mc_+3A_conda_env">conda_env</code></td>
<td>
<p>A character string specifying the name of the conda environment to use
via <code>reticulate</code>. Default is <code>"fastrerandomize"</code>.</p>
</td></tr>
<tr><td><code id="generate_randomizations_mc_+3A_conda_env_required">conda_env_required</code></td>
<td>
<p>A logical indicating whether the specified conda environment
must be strictly used. If <code>TRUE</code>, an error is thrown if the environment is not found.
Default is <code>TRUE</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function works by:
</p>

<ol>
<li><p> Generating batches of random permutations.
</p>
</li>
<li><p> Computing balance measures for each permutation using the provided threshold function.
</p>
</li>
<li><p> Keeping only the top permutations that meet the acceptance probability threshold.
</p>
</li>
<li><p> Managing memory by clearing unused objects and caches between batches.
</p>
</li></ol>

<p>The function uses smaller data types (int8, float16) where possible to reduce memory usage.
It also includes assertions to verify array shapes and dimensions throughout.
</p>


<h3>Value</h3>

<p>The function returns a <em>list</em> with two elements:
<code>candidate_randomizations</code>: an array of randomization vectors
<code>M_candidate_randomizations</code>: an array of their balance measures.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+generate_randomizations">generate_randomizations</a></code> for full randomization generation function.
<code><a href="#topic+generate_randomizations_exact">generate_randomizations_exact</a></code> for the exact version.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
## Not run: 
# Generate synthetic data 
X &lt;- matrix(rnorm(100*5), 100, 5) # 5 covariates

# Generate 1000 randomizations for 100 units with 50 treated
rand_less_strict &lt;- generate_randomizations_mc(
               n_units = 100, 
               n_treated = 50, 
               X = X, 
               randomization_accept_prob=0.01, 
               max_draws = 100000,
               batch_size = 1000)

# Use a stricter balance criterion
rand_more_strict &lt;- generate_randomizations_mc(
               n_units = 100, 
               n_treated = 50, 
               X = X, 
               randomization_accept_prob=0.001, 
               max_draws = 1000000,
               batch_size = 1000)

## End(Not run)

</code></pre>

<hr>
<h2 id='plot.fastrerandomize_randomizations'>Plot method for fastrerandomize_test objects</h2><span id='topic+plot.fastrerandomize_randomizations'></span>

<h3>Description</h3>

<p>Plots the observed treatment effect and, if available, the fiducial interval 
on a horizontal axis.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'fastrerandomize_randomizations'
plot(x, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="plot.fastrerandomize_randomizations_+3A_x">x</code></td>
<td>
<p>An object of class <code>fastrerandomize_test</code>.</p>
</td></tr>
<tr><td><code id="plot.fastrerandomize_randomizations_+3A_...">...</code></td>
<td>
<p>Further graphical parameters passed to <code><a href="base.html#topic+plot">plot</a></code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>No return value. This function is called for the side effect of
generating a histogram of the accepted balance measures of object with class <code>fastrerandomize_randomizations</code>.
</p>

<hr>
<h2 id='plot.fastrerandomize_test'>Plot method for fastrerandomize_test objects</h2><span id='topic+plot.fastrerandomize_test'></span>

<h3>Description</h3>

<p>Plots a simple visualization of the observed effect and the 
fiducial interval (if present) on a horizontal axis.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'fastrerandomize_test'
plot(x, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="plot.fastrerandomize_test_+3A_x">x</code></td>
<td>
<p>An object of class <code>fastrerandomize_test</code>.</p>
</td></tr>
<tr><td><code id="plot.fastrerandomize_test_+3A_...">...</code></td>
<td>
<p>Further graphical parameters passed to <code><a href="base.html#topic+plot">plot</a></code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>No output returned. Performs side effect of plotting <code>fastrerandomize_test</code> class objects.
</p>

<hr>
<h2 id='print.fastrerandomize_randomizations'>Print method for fastrerandomize_randomizations objects</h2><span id='topic+print.fastrerandomize_randomizations'></span>

<h3>Description</h3>

<p>Print method for fastrerandomize_randomizations objects
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'fastrerandomize_randomizations'
print(x, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="print.fastrerandomize_randomizations_+3A_x">x</code></td>
<td>
<p>An object of class <code>fastrerandomize_instance</code>.</p>
</td></tr>
<tr><td><code id="print.fastrerandomize_randomizations_+3A_...">...</code></td>
<td>
<p>Further arguments passed to or from other methods.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Prints an object of class <code>fastrerandomize_randomizations</code>.
</p>

<hr>
<h2 id='print.fastrerandomize_test'>Print method for fastrerandomize_test objects</h2><span id='topic+print.fastrerandomize_test'></span>

<h3>Description</h3>

<p>Print method for fastrerandomize_test objects
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'fastrerandomize_test'
print(x, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="print.fastrerandomize_test_+3A_x">x</code></td>
<td>
<p>An object of class <code>fastrerandomize_test</code>.</p>
</td></tr>
<tr><td><code id="print.fastrerandomize_test_+3A_...">...</code></td>
<td>
<p>Further arguments passed to or from other methods.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>No return value, prints object of class <code>fastrerandomize_test</code>.
</p>

<hr>
<h2 id='print2'>Print timestamped messages with optional quieting</h2><span id='topic+print2'></span>

<h3>Description</h3>

<p>This function prints messages prefixed with the current timestamp in a standardized format.
Messages can be suppressed using the quiet parameter.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>print2(text, quiet = FALSE)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="print2_+3A_text">text</code></td>
<td>
<p>A character string containing the message to be printed.</p>
</td></tr>
<tr><td><code id="print2_+3A_quiet">quiet</code></td>
<td>
<p>A logical value indicating whether to suppress output. Default is <code>FALSE</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function prepends the current timestamp in &quot;YYYY-MM-DD HH:MM:SS&quot; format
to the provided message.
</p>


<h3>Value</h3>

<p>No return value, called for side effect of printing with timestamp.
</p>


<h3>See Also</h3>

<p><code>Sys.time</code> for the underlying timestamp functionality.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Print a basic message with timestamp
print2("Processing started")

# Suppress output
print2("This won't show", quiet = TRUE)

# Use in a loop
for(i in 1:3) {
  print2(sprintf("Processing item %d", i))
}

</code></pre>

<hr>
<h2 id='QJEData'>QJEData: Agricultural Treatment Experiment Data</h2><span id='topic+QJEData'></span>

<h3>Description</h3>

<p>Data from a field experiment studying moral hazard in tenancy contracts in agriculture.
</p>
<p>After subsetting, this dataset includes observations on 968 experimental units
with the following variables of interest: household composition,
treatment assignment, and agricultural outcomes.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(QJEData)
</code></pre>


<h3>Format</h3>

<p>A data frame with 968 rows and 7 columns:
</p>

<dl>
<dt>children</dt><dd><p>Numeric (integer). Number of children in the household. Larger numbers may reflect increased household labor needs and different investment or effort incentives.</p>
</dd>
<dt>married</dt><dd><p>Numeric/binary. Whether the household head is currently married (1) or not (0). Marital status may influence decision-making and risk preferences in farming.</p>
</dd>
<dt>hh_size</dt><dd><p>Numeric (integer). Household size. Differences in family labor availability or consumption needs can influence effort levels and thus relate to moral hazard in production decisions.</p>
</dd>
<dt>hh_sexrat</dt><dd><p>Numeric. The ratio of adult men to adult women in the household. Imbalances in the male–female ratio can affect labor division and investment decisions.</p>
</dd>
<dt>treat1</dt><dd><p>Numeric/binary. Primary treatment indicator (e.g., whether a farmer is offered a specific tenancy contract or cost-sharing arrangement).</p>
</dd>
<dt>R_yield_ELA_sqm</dt><dd><p>Numeric. Crop yield per square meter (e.g., kilograms of output per square meter). This is a principal outcome measure for evaluating productivity and treatment impact on farm performance.</p>
</dd>
<dt>ELA_Fertil_D</dt><dd><p>Numeric/binary. Indicator for whether fertilizer was used (1) or not (0). This measures input investment—a key mechanism in moral hazard models (farmers may alter input use under different contracts).</p>
</dd>
</dl>



<h3>Source</h3>

<p>Burchardi, K.B., Ghatak, M., &amp; Johanssen, A. (2019). 
Moral hazard: Experimental evidence from tenancy contracts.
<em>The Quarterly Journal of Economics</em>, 134(1), 281-347.
</p>

<hr>
<h2 id='randomization_test'>Fast randomization test</h2><span id='topic+randomization_test'></span>

<h3>Description</h3>

<p>Fast randomization test
</p>


<h3>Usage</h3>

<pre><code class='language-R'>randomization_test(
  obsW = NULL,
  obsY = NULL,
  X = NULL,
  alpha = 0.05,
  candidate_randomizations = NULL,
  candidate_randomizations_array = NULL,
  n0_array = NULL,
  n1_array = NULL,
  randomization_accept_prob = 1,
  findFI = FALSE,
  c_initial = 2,
  max_draws = 10^6,
  batch_size = 10^5,
  randomization_type = "monte_carlo",
  approximate_inv = TRUE,
  file = NULL,
  verbose = TRUE,
  conda_env = "fastrerandomize",
  conda_env_required = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="randomization_test_+3A_obsw">obsW</code></td>
<td>
<p>A numeric vector where <code>0</code>'s correspond to control units and <code>1</code>'s to treated units.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_obsy">obsY</code></td>
<td>
<p>An optional numeric vector of observed outcomes. If not provided, the function assumes a NULL value.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_x">X</code></td>
<td>
<p>A numeric matrix of covariates.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_alpha">alpha</code></td>
<td>
<p>The significance level for the test. Default is <code>0.05</code>.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_candidate_randomizations">candidate_randomizations</code></td>
<td>
<p>A numeric matrix of candidate randomizations.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_candidate_randomizations_array">candidate_randomizations_array</code></td>
<td>
<p>An optional 'JAX' array of candidate randomizations. If not provided, the function coerces <code>candidate_randomizations</code> into a 'JAX' array.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_n0_array">n0_array</code></td>
<td>
<p>An optional array specifying the number of control units.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_n1_array">n1_array</code></td>
<td>
<p>An optional array specifying the number of treated units.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_randomization_accept_prob">randomization_accept_prob</code></td>
<td>
<p>An numeric scalar or vector of probabilities for accepting each randomization.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_findfi">findFI</code></td>
<td>
<p>A logical value indicating whether to find the fiducial interval. Default is FALSE.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_c_initial">c_initial</code></td>
<td>
<p>A numeric value representing the initial criterion for the randomization. Default is <code>2</code>.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_max_draws">max_draws</code></td>
<td>
<p>An integer specifying the maximum number of candidate randomizations
to generate (or to consider) for the test when <code>randomization_type = "monte_carlo"</code>.
Default is <code>1e6</code>.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_batch_size">batch_size</code></td>
<td>
<p>An integer specifying the batch size for Monte Carlo sampling.
Batches are processed one at a time for memory efficiency. Default is <code>1e5</code>.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_randomization_type">randomization_type</code></td>
<td>
<p>A string specifying the type of randomization for the test.
Allowed values are &quot;exact&quot; or &quot;monte_carlo&quot;. Default is &quot;monte_carlo&quot;.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_approximate_inv">approximate_inv</code></td>
<td>
<p>A logical value indicating whether to use an approximate inverse
(diagonal of the covariance matrix) instead of the full matrix inverse when computing
balance metrics. This can speed up computations for high-dimensional covariates.
Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_file">file</code></td>
<td>
<p>A character string specifying the path (including filename) where candidate
randomizations will be saved or loaded from. If <code>NULL</code>, randomizations
remain in memory. Default is NULL.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_verbose">verbose</code></td>
<td>
<p>A logical value indicating whether to print progress information. Default is <code>TRUE</code>.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_conda_env">conda_env</code></td>
<td>
<p>A character string specifying the name of the conda environment to use
via <code>reticulate</code>. Default is <code>"fastrerandomize"</code>.</p>
</td></tr>
<tr><td><code id="randomization_test_+3A_conda_env_required">conda_env_required</code></td>
<td>
<p>A logical indicating whether the specified conda environment
must be strictly used. If <code>TRUE</code>, an error is thrown if the environment is not found.
Default is <code>TRUE</code>.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns an S3 object with slots: </p>

<ul>
<li> <p><code>p_value</code> A numeric value or vector representing the p-value of the test (or the expected p-value under the prior structure specified in the function inputs).
</p>
</li>
<li> <p><code>FI</code> A numeric vector representing the fiducial interval if <code>findFI=TRUE</code>.
</p>
</li>
<li> <p><code>tau_obs</code> A numeric value or vector representing the estimated treatment effect(s).
</p>
</li>
<li> <p><code>fastrr_env</code> The fastrerandomize environment.
</p>
</li></ul>



<h3>References</h3>


<ul>
<li><p> Zhang, Y. and Zhao, Q., 2023. What is a randomization test?. Journal of the American Statistical Association, 118(544), pp.2928-2942.
</p>
</li></ul>



<h3>See Also</h3>

<p><code><a href="#topic+generate_randomizations">generate_randomizations</a></code> for randomization generation function.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
# A small synthetic demonstration with 6 units, 3 treated and 3 controls:

# Generate pre-treatment covariates
X &lt;- matrix(rnorm(24*2), ncol = 2)

# Generate candidate randomizations
RandomizationSet_MC &lt;- generate_randomizations(
  n_units = nrow(X),
  n_treated = round(nrow(X)/2),
  X = X,
  randomization_accept_prob = 0.1,
  randomization_type = "monte_carlo",
  max_draws = 100000,
  batch_size = 1000
)

# Generate outcome
W &lt;- RandomizationSet_MC$randomizations[1,]
obsY &lt;- rnorm(nrow(X), mean = 2 * W)

# Perform randomization test
results_base &lt;- randomization_test(
  obsW = W,
  obsY = obsY,
  X = X,
  candidate_randomizations = RandomizationSet_MC$randomizations,
)
print(results_base)

# Perform randomization test
result_fi &lt;- randomization_test(
  obsW = W,
  obsY = obsY,
  X = X,
  candidate_randomizations = RandomizationSet_MC$randomizations,
  findFI = TRUE
)
print(result_fi)

## End(Not run)

</code></pre>

<hr>
<h2 id='summary.fastrerandomize_randomizations'>Summary method for fastrerandomize_randomizations objects</h2><span id='topic+summary.fastrerandomize_randomizations'></span>

<h3>Description</h3>

<p>Summary method for fastrerandomize_randomizations objects
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'fastrerandomize_randomizations'
summary(object, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="summary.fastrerandomize_randomizations_+3A_object">object</code></td>
<td>
<p>An object of class <code>fastrerandomize_randomizations</code>.</p>
</td></tr>
<tr><td><code id="summary.fastrerandomize_randomizations_+3A_...">...</code></td>
<td>
<p>Further arguments passed to or from other methods.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list with summary statistics, printed by default.
</p>

<hr>
<h2 id='summary.fastrerandomize_test'>Summary method for fastrerandomize_test objects</h2><span id='topic+summary.fastrerandomize_test'></span>

<h3>Description</h3>

<p>Summary method for fastrerandomize_test objects
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'fastrerandomize_test'
summary(object, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="summary.fastrerandomize_test_+3A_object">object</code></td>
<td>
<p>An object of class <code>fastrerandomize_test</code>.</p>
</td></tr>
<tr><td><code id="summary.fastrerandomize_test_+3A_...">...</code></td>
<td>
<p>Further arguments passed to or from other methods.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns an (invisible) list with a summary of <code>fastrerandomize_test</code> class objects.
</p>

<hr>
<h2 id='YOPData'>YOPData</h2><span id='topic+YOPData'></span>

<h3>Description</h3>

<p>Data from a re-analysis of the Youth Opportunities Program anti-poverty RCT 
in Uganda, with satellite imagery neural representations linked to RCT units.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(YOPData)
</code></pre>


<h3>Format</h3>

<p>A list containing two data frames:
</p>

<dl>
<dt>RCTData</dt><dd><p>Treatment, outcome, and geolocation information</p>
</dd>
<dt>ImageEmbeddings</dt><dd><p>CLIP-RSICD neural embeddings of satellite imagery</p>
</dd>
</dl>



<h3>Source</h3>


<ul>
<li><p> Blattman, C., Fiala, N. and Martinez, S. (2020). The Long-term Impacts 
of Grants on Poverty: Nine-year Evidence from Uganda's Youth Opportunities Program. 
American Economic Review: Insights, 2(3), 287-304.
</p>
</li>
<li><p> Jerzak, C.T., Johansson, F.D. and Daoud, A. (2023). Image-based Treatment 
Effect Heterogeneity. Conference on Causal Learning and Reasoning, 531-552. PMLR.
</p>
</li></ul>


</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
