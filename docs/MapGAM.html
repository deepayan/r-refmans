<!DOCTYPE html><html><head><title>Help for package MapGAM</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {MapGAM}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#MapGAM-package'>
<p>Mapping Smoothed Effect Estimates from Individual-Level Spatial Data</p></a></li>
<li><a href='#AIC.modgam'>
<p>AIC of the <code>modgam</code> Object</p></a></li>
<li><a href='#beertweets'>
<p>Geocoded Tweets with Beer Indicator</p></a></li>
<li><a href='#CAdata'>
<p>Deidentified Survival Data for California</p></a></li>
<li><a href='#CAgrid'>
<p>A Grid on State of California</p></a></li>
<li><a href='#CAmap'>
<p>Map of California</p></a></li>
<li><a href='#coef.gamcox'>
<p>Coefficents of the <code>gamcox</code> Object</p></a></li>
<li><a href='#coef.modgam'>
<p>Coefficients of the <code>modgam</code> Object</p></a></li>
<li><a href='#colormap'>
<p>Maps Predicted Values and Clusters on a Two-Dimentional Map</p></a></li>
<li><a href='#dls'>
<p>Calculating Derivatives of Partial Likelihood for Cox Proportional Hazard Additive Models</p></a></li>
<li><a href='#formula.gamcox'>
<p>Formula of the <code>gamcox</code> Object</p></a></li>
<li><a href='#formula.modgam'>
<p>Formula of the <code>modgam</code> Object</p></a></li>
<li><a href='#gamcox'>
<p>Fit a Cox Additive Model with a Two-Dimensional Smooth</p></a></li>
<li><a href='#MAdata'>
<p>Synthetic Case-Control Data for Massachusetts</p></a></li>
<li><a href='#MAmap'>
<p>Map of Massachusetts</p></a></li>
<li><a href='#MapGAM.version'>
<p>Revision Dates for MapGAM Functions</p></a></li>
<li><a href='#modgam'>
<p>Fit a Generalized Additive Model (GAM) with a Two-Dimensional Smooth and Make Predictions</p></a></li>
<li><a href='#mypredict.gam'>
<p>Prediction for GAM Fits</p></a></li>
<li><a href='#optspan'>
<p>Determine the Optimal Span Size for <code>modgam</code></p></a></li>
<li><a href='#plot.modgam'>
<p>Maps Predicted Values and Clusters for <code>modgam</code> Objects</p></a></li>
<li><a href='#predgrid'>
<p>Create a Grid and Clip It to a Map and Data Bounds</p></a></li>
<li><a href='#predict.gamcox'>
<p>Prediction Method for <code>gamcox</code> Fits</p></a></li>
<li><a href='#print.gamcox'>
<p>Print the <code>gamcox</code> Object</p></a></li>
<li><a href='#print.modgam'>
<p>Print the <code>modgam</code> Object</p></a></li>
<li><a href='#residuals.gamcox'>
<p>Residuals of the <code>gamcox</code> Object</p></a></li>
<li><a href='#residuals.modgam'>
<p>Residuals of the <code>modgam</code> Object</p></a></li>
<li><a href='#sampcont'>
<p>Unmatched Control Sampling</p></a></li>
<li><a href='#summary.gamcox'>
<p>Summarize the <code>gamcox</code> Object</p></a></li>
<li><a href='#summary.modgam'>
<p>Summarize the <code>modgam</code> Object</p></a></li>
<li><a href='#toformula'>
<p>Build a Formula Based on Data for <code>modgam</code> Function</p></a></li>
<li><a href='#trimdata'>
<p>Trim a Data Set To Map Boundaries</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Mapping Smoothed Effect Estimates from Individual-Level Data</td>
</tr>
<tr>
<td>Version:</td>
<td>1.3</td>
</tr>
<tr>
<td>Date:</td>
<td>2023-07-12</td>
</tr>
<tr>
<td>Author:</td>
<td>Lu Bai, Scott Bartell, Robin Bliss, and Veronica Vieira</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Scott Bartell &lt;sbartell@uci.edu&gt;</td>
</tr>
<tr>
<td>Description:</td>
<td>Contains functions for mapping odds ratios, hazard ratios, or other effect estimates using individual-level data such as case-control study data, using generalized additive models (GAMs) or Cox models for smoothing with a two-dimensional predictor (e.g., geolocation or exposure to chemical mixtures) while adjusting linearly for confounding variables, using methods described by Kelsall and Diggle (1998), Webster at al. (2006), and Bai et al. (2020).  Includes convenient functions for mapping point estimates and confidence intervals, efficient control sampling, and permutation tests for the null hypothesis that the two-dimensional predictor is not associated with the outcome variable (adjusting for confounders).     </td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a></td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 2.10.0), sp, gam, survival</td>
</tr>
<tr>
<td>Imports:</td>
<td>sf, colorspace, PBSmapping</td>
</tr>
<tr>
<td>Suggests:</td>
<td>maps, mapproj</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2023-07-13 14:04:56 UTC; sbartell</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2023-07-15 11:00:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='MapGAM-package'>
Mapping Smoothed Effect Estimates from Individual-Level Spatial Data
</h2><span id='topic+MapGAM-package'></span><span id='topic+MapGAM'></span>

<h3>Description</h3>

<p>Contains functions for estimating and mapping hazard ratios, odds ratios, rate ratios, and continuous outcomes from individual-level data such as case-control study data, using generalized additive models (GAMs) or extended Cox models.  This allows for smoothing with a two-dimensional predictor such as geolocation or exposure to chemical mixtures, while adjusting for confounding variables using methods described by Kelsall and Diggle (1998), Webster at al. (2006), Bai et al. (2020), and Tang et al. (2023).  Includes convenient functions for mapping, efficient control sampling, confidence intervals, and permutation tests for the null hypothesis that the two-dimensional predictor is not associated with the outcome variable, adjusting for confounders.     
</p>


<h3>Details</h3>


<table>
<tr>
 <td style="text-align: left;">
Package: </td><td style="text-align: left;"> MapGAM</td>
</tr>
<tr>
 <td style="text-align: left;">
Type: </td><td style="text-align: left;"> Package</td>
</tr>
<tr>
 <td style="text-align: left;">
Version: </td><td style="text-align: left;"> 1.3</td>
</tr>
<tr>
 <td style="text-align: left;">
Date: </td><td style="text-align: left;"> 2023-07-12</td>
</tr>
<tr>
 <td style="text-align: left;">
License: </td><td style="text-align: left;"> GPL-3</td>
</tr>
<tr>
 <td style="text-align: left;">
</td>
</tr>

</table>

<p>Typical spatial applications will start with the predgrid function to create a regular grid of points within the study area, with optional map boundaries (e.g., a country, state, or regional map).  Crude or adjusted odds ratios, hazard ratios, or continuous outcomes are then estimated at each grid point using the modgam function to smooth by geolocation.  Finally, the predicted values (and optionally, &quot;clusters&quot;&ndash;areas of signficantly increased or decreased values determined via permutation tests or confidence intervals) are plotted using the plot or colormap functions.  Most users will use the plot function to create maps from modgam objects, but colormap is provided for backwards compatibility as well as for creating maps from models fit using functions other than modgam.  The trimdata and sampcont functions can be used to restrict data to those within map boundaries and to conduct simple or spatiotemporal stratified sampling from eligible controls.  The optspan function can be used to find an optimal span size for the LOESS smoother used by the modgam function; it is automatically used within the modgam function when the span size is not provided by the user.  These functions can also be applied to non-spatial data when two-dimensional smoothing is of interest, such as investigation of the effects of a mixture of two chemicals.</p>


<h3>Author(s)</h3>

<p>Lu Bai, Scott Bartell, Robin Bliss, and Veronica Vieira
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>References</h3>

<p>Bai L, Gillen DL, Bartell SM, Vieira VM. <a href="https://doi.org/10.32614/RJ-2020-001">doi:10.32614/RJ-2020-001</a>Mapping smoothed spatial effect estimates from individual-level data:  MapGAM. The R Journal 2020, 12:32-48. 
</p>
<p>Hastie TJ, Tibshirani RJ. Generalized Additive Models.  (Chapman &amp; Hall/CRC Monographs on Statistics &amp; Applied Probability, Boca Raton, Florida, 1990).  
</p>
<p>Kelsall J, Diggle P. <a href="https://doi.org/10.1111/1467-9876.00128">doi:10.1111/1467-9876.00128</a>Spatial variation in risk of disease: a nonparametric binary regression approach. J Roy Stat Soc C-App 1998, 47:559-573. 	
</p>
<p>Tang IW, Bartell SM, Vieira VM. <a href="https://doi.org/10.1016/j.sste.2023.100584">doi:10.1016/j.sste.2023.100584</a>Unmatched Spatially Stratified Controls: A simulation study examining efficiency and precision using spatially-diverse controls and generalized additive models. Spatial and Spatio-temporal Epidemiology 2023, 45:100584.
</p>
<p>Vieira V, Webster T, Weinberg J, Aschengrau A, Ozonoff D. <a href="https://doi.org/10.1186/1476-069X-4-11">doi:10.1186/1476-069X-4-11</a>Spatial analysis of lung, colorectal, and breast cancer on Cape Cod: An application of generalized additive models to case-control data. Environmental Health 2005, 4:11. 
</p>
<p>Webster T, Vieira V, Weinberg J, Aschengrau A. <a href="https://doi.org/10.1186/1476-072X-5-26">doi:10.1186/1476-072X-5-26</a>Method for mapping population-based case-control studies using Generalized Additive Models. International Journal of Health Geographics 2006, 5:26.
</p>
<p>Young RL, Weinberg J, Vieira V, Ozonoff A, Webster TF. <a href="https://doi.org/10.1186/1476-072X-9-37">doi:10.1186/1476-072X-9-37</a>A power comparison of generalized additive models and the spatial scan statistic in a case-control setting. International Journal of Health Geographics 2010, 9:37.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+trimdata">trimdata</a></code>, 
<code><a href="#topic+sampcont">sampcont</a></code>, 
<code><a href="#topic+predgrid">predgrid</a></code>, 
<code><a href="#topic+optspan">optspan</a></code>, 
<code><a href="#topic+modgam">modgam</a></code>,
<code><a href="#topic+colormap">colormap</a></code>.
<code><a href="#topic+plot.modgam">plot.modgam</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Load synthetic data and a preformatted base map
data(MAmap)		
data(MAdata)

# Create a grid on the base map 
gamgrid &lt;- predgrid(MAdata, map=MAmap) 
# Fit a GAM with a smooth term for spatial location
fit1 &lt;- modgam(data=MAdata, rgrid=gamgrid, m="crude", sp=0.5)   
# Display odds ratio estimates on the base map
plot(fit1, MAmap, exp=TRUE)								

#### See colormap and modgam help files for more examples 
</code></pre>

<hr>
<h2 id='AIC.modgam'>
AIC of the <code><a href="#topic+modgam">modgam</a></code> Object</h2><span id='topic+AIC.modgam'></span>

<h3>Description</h3>

<p>This function summarizes the AIC of a modgam object produced by <code><a href="#topic+modgam">modgam</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'modgam'
 AIC(object, ...) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="AIC.modgam_+3A_object">object</code></td>
<td>

<p>a modgam object.
</p>
</td></tr>
<tr><td><code id="AIC.modgam_+3A_...">...</code></td>
<td>

<p>extra arguments for S3 generic, ignored by <code>AIC.modgam</code>.   	
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>
<code><a href="#topic+gamcox">gamcox</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>

<hr>
<h2 id='beertweets'>
Geocoded Tweets with Beer Indicator</h2><span id='topic+beertweets'></span>

<h3>Description</h3>

<p>Geocoded tweets from Twitter, with an indicator variable for any mention of beer, time stamp, and state of origin.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(MAmap)</code></pre>


<h3>Format</h3>

<p>A data frame with 10000 observations on 5 variables:
</p>

<dl>
<dt><code>beer</code></dt><dd><p>1 for tweets about beer, 0 for other tweets.</p>
</dd>
<dt><code>longitude</code></dt><dd><p>geocoded longitude.</p>
</dd>
<dt><code>latitude</code></dt><dd><p>geocoded latitude.</p>
</dd>
<dt><code>state</code></dt><dd><p>a factor with the name of the state.</p>
</dd>
<dt><code>time</code></dt><dd><p>a list of POSIXlt format dates and times for the tweets.</p>
</dd>
</dl>



<h3>Details</h3>

<p>A sample of geocoded tweets from within in the contiguous US, from June to October of 2012.  Tweets mentioning beer (cases) are oversampled by a factor of 100.  Geocoding is typically at the level of city or town; tweets that could not be geocoded were excluded from this data set.          
</p>


<h3>Source</h3>

<p>Dr. Matthew Zook, University of Kentucky, floatingsheep.org
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(beertweets)
attach(beertweets)
plot(longitude,latitude,col=beer+1)  # beer in red, non-beer in black
</code></pre>

<hr>
<h2 id='CAdata'>
Deidentified Survival Data for California
</h2><span id='topic+CAdata'></span>

<h3>Description</h3>

<p>Survival time, censoring status, and geolocations (jittered to preserve anonymity) for 5000 ovarian cancer patients in California, using a Lambert projection (in meters).  <code><a href="#topic+CAmap">CAmap</a></code> is a map of California using the same projection.</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(CAdata)</code></pre>


<h3>Format</h3>

<p>A data frame with 5000 observations on the following 6 variables.
</p>

<dl>
<dt><code>time</code></dt><dd><p>survival time.</p>
</dd>
<dt><code>event</code></dt><dd><p>censoring status.</p>
</dd>
<dt><code>X</code></dt><dd><p>projected X coordinate.</p>
</dd>
<dt><code>Y</code></dt><dd><p>projected Y coordinate.</p>
</dd>
<dt><code>AGE</code></dt><dd><p>patient age.</p>
</dd>
<dt><code>INS</code></dt><dd><p>insurance type: <code>Mng</code> (Managed Care: managed care, HMO, PPO and other private insurance), <code>Mcr</code> (Medicare), <code>Mcd</code> (Medicaid), <code>Oth</code>: (Other Insurance: military, county-funded), <code>Uni</code> (Not Insured, self-pay) and <code>Unk</code> (Unknown).</p>
</dd>
</dl>



<h3>Examples</h3>

<pre><code class='language-R'>data(CAdata)
summary(CAdata)
plot(CAdata$X,CAdata$Y) 
</code></pre>

<hr>
<h2 id='CAgrid'>
A Grid on State of California
</h2><span id='topic+CAgrid'></span>

<h3>Description</h3>

<p>An evenly-spaced grid of prediction points approximately 5km apart that extended across the latitude and longitude coordinates of participants' locations throughout California with over 7,500 points. Areas with sparse population data are clipped.</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(CAgrid)</code></pre>


<h3>Format</h3>

<p>A data frame with 7579 geolocations.
</p>

<dl>
<dt><code>X</code></dt><dd><p>projected X coordinate.</p>
</dd>
<dt><code>Y</code></dt><dd><p>projected Y coordinate.</p>
</dd>
</dl>



<h3>Source</h3>

<p>Dr. Veronica Vieira, University of California, Irvine
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(CAgrid)
data(CAmap)
plot(CAmap)
points(CAgrid)
</code></pre>

<hr>
<h2 id='CAmap'>
Map of California
</h2><span id='topic+CAmap'></span>

<h3>Description</h3>

<p>A map of the outline of CA in SpatialPolygonsDataFrame format, converted from an ESRI shapefile using the <code>readShapePoly</code> function in the <span class="pkg">maptools</span> package.</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(CAmap)</code></pre>


<h3>Format</h3>

<p>The format is class SpatialPolygonsDataFrame (package &quot;sp&quot;).
</p>


<h3>Details</h3>

<p>State Plane Projected coordinate system, North America Datum 1983 (NAD_1983_StatePlane_California_I_FIPS_0401) for California, using standard parallels 40.00000000 and 41.66666667.  The latitude of origin is 39.3, the central meridian is -122.0 and the projection units are meters (False Easting: 200000 m; False Northing: 500000 m).   
</p>


<h3>Source</h3>

<p>Dr. Veronica Vieira, University of California, Irvine
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(CAmap)
plot(CAmap)
</code></pre>

<hr>
<h2 id='coef.gamcox'>
Coefficents of the <code><a href="#topic+gamcox">gamcox</a></code> Object
</h2><span id='topic+coef.gamcox'></span>

<h3>Description</h3>

<p>This function provides coefficients of a gamcox object produced by <code><a href="#topic+gamcox">gamcox</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'gamcox'
 coef(object,...) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="coef.gamcox_+3A_object">object</code></td>
<td>

<p>a <code>gamcox</code> object.
</p>
</td></tr>
<tr><td><code id="coef.gamcox_+3A_...">...</code></td>
<td>
<p>.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>
<code><a href="#topic+gamcox">gamcox</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data(CAdata)
fit &lt;- gamcox(Surv(time,event)~lo(X,Y)+AGE+INS,data=CAdata, span = 0.2)
coef(fit)

</code></pre>

<hr>
<h2 id='coef.modgam'>
Coefficients of the <code><a href="#topic+modgam">modgam</a></code> Object</h2><span id='topic+coef.modgam'></span>

<h3>Description</h3>

<p>This function provides coefficients of a modgam object produced by <code><a href="#topic+modgam">modgam</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'modgam'
 coef(object, ...) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="coef.modgam_+3A_object">object</code></td>
<td>

<p>a modgam object.
</p>
</td></tr>
<tr><td><code id="coef.modgam_+3A_...">...</code></td>
<td>

<p>extra arguments for S3 generic, ignored by <code>coef.modgam</code>.   	
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>
<code><a href="#topic+gamcox">gamcox</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>

<hr>
<h2 id='colormap'>
Maps Predicted Values and Clusters on a Two-Dimentional Map
</h2><span id='topic+colormap'></span>

<h3>Description</h3>

<p>Displays a color image map, including a legend, scale bar, and optional North arrow, showing values for a grid of points. Irregular grids are allowed.  Also draws contour lines for regions of signficantly increased or decreased predicted values (&quot;clusters&quot;).      
</p>


<h3>Usage</h3>

<pre><code class='language-R'>colormap(obj, map=NULL, exp=FALSE, add=FALSE,  mapmin=NULL, mapmax=NULL, 
         col.seq=rev(rainbow(201,start=0,end=0.66)), anchor=FALSE,
         border.gray = 0.3, contours="none", 
         contours.drawlabels=FALSE, contours.lty=1,
         contours.lwd=1, contours.levels, contours.labcex=0.7, 
         interval.exclude=0, arrow=TRUE, axes=FALSE, ptsize=0.9, mai, 
         legend.name = "predicted values",legend.cex=1,
         legend.add.line,alpha,...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="colormap_+3A_obj">obj</code></td>
<td>

<p>(Required) A list containing at least these two elements:  &quot;grid&quot; (a 2 column data frame with X and Y coordinates) and &quot;fit&quot; (the value to displayed on the map).   
</p>
</td></tr>
<tr><td><code id="colormap_+3A_map">map</code></td>
<td>

<p>Can be used to map <code>fit</code> on a base map from the <code>map</code> function in the <span class="pkg">maps</span> package, or on a base map produced by the <code>readOGR</code> function in the <span class="pkg">rgdal</span> package.  <code>readOGR</code> reads maps from external files in the ESRI shapefile format.  <code>map=NULL</code> produces a color image without any base map.
</p>
</td></tr>
<tr><td><code id="colormap_+3A_exp">exp</code></td>
<td>

<p>If <code>exp=T</code>, <code>fit</code> will be displayed in exponential scale.  
</p>
</td></tr>
<tr><td><code id="colormap_+3A_add">add</code></td>
<td>

<p>Use <code>add=T</code> to add the color map to an existing plot.  This will often result in loss of the legend and scale, which are added outside of the normal
map boundaries.  <code>add</code> is ignored when a map is provided using the 
<code>map</code> argument.
</p>
</td></tr>
<tr><td><code id="colormap_+3A_mapmin">mapmin</code></td>
<td>

<p>The minimum value for the color scale legend.  When not specified, it will be set to the minimum predicted value. 
</p>
</td></tr>
<tr><td><code id="colormap_+3A_mapmax">mapmax</code></td>
<td>

<p>The maximum value for the color scale legend.  When not specified, it will be set to the maximum predicted value. 
</p>
</td></tr>
<tr><td><code id="colormap_+3A_col.seq">col.seq</code></td>
<td>

<p>The color sequence (palette) used to display the predicted values on the map.  The default is a 
rainbow palette, but divergent or sequential palettes may be better for some applications.  See the
colorspace library and the example below for other options.      
</p>
</td></tr>
<tr><td><code id="colormap_+3A_anchor">anchor</code></td>
<td>

<p>Use <code>anchor=TRUE</code> to center the color palette on <code>legend.add.line</code>.  When <code>anchor=FALSE</code> (the default) or when <code>legend.add.line</code> is not specified, the color palette will be centered halfway between mapmin and mapmax.  <code>anchor=TRUE</code> is recommended when using a divergent palette.          	
</p>
</td></tr>
<tr><td><code id="colormap_+3A_border.gray">border.gray</code></td>
<td>

<p>Gray scale for the border of <code>map</code>, ranges from 0 to 1. It is white with <code>border.gray=1</code>, and black with <code>border.gray=0</code>. The defalt scale is 0.9.
</p>
</td></tr>
<tr><td><code id="colormap_+3A_contours">contours</code></td>
<td>

<p>When <code>contours="interval"</code>, two other elements <code>conf.low</code> and <code>conf.high</code> must be included in <code>obj</code>, and regions excluding a user-specified <code>interval.exclude</code> will be circled on the map. By specifying an element name in <code>obj</code> for <code>contours</code>, contour lines for the specified element will be added on the map, e.g. <code>contours="fit"</code> or  <code>contours="exp.fit"</code> for a <code>modgam</code> object.  The default is &quot;none&quot; which produces no contour lines.  
</p>
</td></tr>
<tr><td><code id="colormap_+3A_contours.drawlabels">contours.drawlabels</code></td>
<td>

<p>Use <code>contours.drawlabels = TRUE</code> add labels on contour lines.   
</p>
</td></tr>
<tr><td><code id="colormap_+3A_contours.lty">contours.lty</code></td>
<td>

<p>The line type for contour lines
</p>
</td></tr>
<tr><td><code id="colormap_+3A_contours.lwd">contours.lwd</code></td>
<td>

<p>The width for contour lines.
</p>
</td></tr> 
<tr><td><code id="colormap_+3A_contours.levels">contours.levels</code></td>
<td>

<p>The levels for contour lines. When <code>exp=T</code>, the levels will also be used in an exponential scale.
</p>
</td></tr> 
<tr><td><code id="colormap_+3A_contours.labcex">contours.labcex</code></td>
<td>

<p>cex for contour labelling. This is an absolute size, not a multiple of <code>par("cex")</code> 
</p>
</td></tr>
<tr><td><code id="colormap_+3A_interval.exclude">interval.exclude</code></td>
<td>

<p>If <code>contours="interval"</code>, regions with confidence intervals excluding <code>interval.exclude</code> will be circled  
</p>
</td></tr>
<tr><td><code id="colormap_+3A_arrow">arrow</code></td>
<td>

<p>Use arrow=T to add a North arrow to the map.  	
</p>
</td></tr>
<tr><td><code id="colormap_+3A_axes">axes</code></td>
<td>

<p>Use axes=T to add axes to the map (useful for chemical mixture isoboles).
</p>
</td></tr>
<tr><td><code id="colormap_+3A_ptsize">ptsize</code></td>
<td>

<p>The size of the points used to fill in colors on the map.  Increase to remove white space inside the map or decrease to remove color outside the map boundaries.  NOTE: white space can also be eliminated by increasing the grid size in <code>predgrid</code>, which is often preferable as it results in a higher resolution map.   
</p>
</td></tr>
<tr><td><code id="colormap_+3A_mai">mai</code></td>
<td>

<p>The margins of the plot. Details see <a href="graphics.html#topic+par">par</a>,</p>
</td></tr>
<tr><td><code id="colormap_+3A_legend.name">legend.name</code></td>
<td>

<p>The name of displayed for the legend bar.</p>
</td></tr>
<tr><td><code id="colormap_+3A_legend.cex">legend.cex</code></td>
<td>

<p>A numerical value giving the amount by which legend text should be magnified relative to the default.  
</p>
</td></tr>
<tr><td><code id="colormap_+3A_legend.add.line">legend.add.line</code></td>
<td>

<p>A numerical value at which a line will be added on the legend bar to indicate the color for the value.  
</p>
</td></tr>
<tr><td><code id="colormap_+3A_alpha">alpha</code></td>
<td>
<p>Levels</p>
</td></tr>
<tr><td><code id="colormap_+3A_...">...</code></td>
<td>

<p>Other auguments past to <a href="base.html#topic+plot">plot</a> function
</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Produces an image map.  If the base map is in <code>readOGR</code> format a scale bar is included, showing whatever measurement units are recorded in the shapefile.  If the 
units are missing from the shapefile conversion they are assumed to be meters.   
</p>


<h3>Author(s)</h3>

<p>Scott Bartell, Lu Bai, Robin Bliss, and Veronica Vieira
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+trimdata">trimdata</a></code>, 
<code><a href="#topic+predgrid">predgrid</a></code>, 
<code><a href="#topic+plot.modgam">plot.modgam</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(MAdata)
data(MAmap)
obj &lt;- list(grid=data.frame(MAdata$Xcoord,MAdata$Ycoord),fit=MAdata$Mercury)
colormap(obj, MAmap, legend.name = "mercury")

# map the same data using a divergent color palette anchored to the median
if (require(colorspace)) {
  newpal &lt;- diverge_hsv(201)   # from the colorspace library
  colormap(obj, MAmap, legend.name = "mercury", col.seq = newpal, 
	legend.add.line=round(median(obj$fit),2), anchor = TRUE)
  }
</code></pre>

<hr>
<h2 id='dls'>
Calculating Derivatives of Partial Likelihood for Cox Proportional Hazard Additive Models</h2><span id='topic+dls'></span>

<h3>Description</h3>

<p>Calculate the log partial likelihood and derivatives with respect to the subject log hazard ratio (compared to the baseline) for Cox proportional hazard additive model described in <code><a href="#topic+gamcox">gamcox</a></code>. Results are used to update estimates in <code><a href="#topic+gamcox">gamcox</a></code> function.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>dls(Y,X,which,eta,span=0.5,adjust=TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="dls_+3A_y">Y</code></td>
<td>

<p>a list including two elements: <code>time</code> for survival times and <code>event</code> for censoring statu.
</p>
</td></tr>
<tr><td><code id="dls_+3A_x">X</code></td>
<td>

<p>a data frame containing the variables in the model. The data must be structured so that the X and Y coordinates for two-dimensional predictor (e.g., geolocation) are in the 1st and 2nd columns, respectively. 
</p>
</td></tr>
<tr><td><code id="dls_+3A_which">which</code></td>
<td>

<p>matrix index for smooth term.
</p>
</td></tr>
<tr><td><code id="dls_+3A_eta">eta</code></td>
<td>

<p>current estimated subject log hazard ratio compared to the baseline. 
</p>
</td></tr>
<tr><td><code id="dls_+3A_span">span</code></td>
<td>

<p>smoothing parameter that been used to smoothing the second derivative of the log partial likelihood.
</p>
</td></tr>
<tr><td><code id="dls_+3A_adjust">adjust</code></td>
<td>

<p><code>adjust=TRUE</code> means there are confounders included in the model.
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>For data that having tied failure times, Efron's approximation method is used to calculate the log partial likelihood and correspongding derivatives. Let <code class="reqn">\eta</code> denote the log hazard ratio, and <em>l</em> denote the partial likelihood. When fitting a Cox proportional hazard additive model, <code class="reqn">\eta</code> is updated by
</p>
<p style="text-align: center;"><code class="reqn">
\eta^{new} = \eta^{old} - \frac{dl/d{\eta}}{smooth(d^2l/d\eta^2)}
</code>
</p>



<h3>Value</h3>

<table>
<tr><td><code>deltaeta</code></td>
<td>
<p>difference between the input <code>eta</code> and the new updated <code>eta</code>.</p>
</td></tr>
<tr><td><code>w</code></td>
<td>
<p>inverse of smoothed second derivatives.</p>
</td></tr>
<tr><td><code>l</code></td>
<td>

<p>partial likelihood baed on input <code>eta</code>.
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai and Scott Bartell
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>References</h3>

<p>Hastie TJ, Tibshirani RJ.  Generalized Additive Models.  (Chapman &amp; Hall/CRC Monographs on Statistics &amp; Applied Probability, Boca Raton, Florida, 1990). 
</p>
<p>Bristow RE, Chang J, Ziogas A, Gillen DL, Bai L, Vieira VM. Spatial Analysis of Advanced-stage Ovarian Cancer Mortality in California. American Journal of Obstetrics and Gynecology 2015, 213(1), e1-43).
</p>


<h3>See Also</h3>

<p><code><a href="#topic+gamcox">gamcox</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data(CAdata)
Y = CAdata[,c("time","event")]
X = CAdata[,c(3:5)]
eta = coxph(Surv(time,event)~AGE,data=CAdata)$linear.predictors
result = dls(Y,X,1:2,eta,span=0.2)
plot(eta,result$deltaeta)

</code></pre>

<hr>
<h2 id='formula.gamcox'>
Formula of the <code><a href="#topic+gamcox">gamcox</a></code> Object
</h2><span id='topic+formula.gamcox'></span>

<h3>Description</h3>

<p>This function provides the formula of a gamcox object produced by <code><a href="#topic+gamcox">gamcox</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'gamcox'
 formula(x,...) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="formula.gamcox_+3A_x">x</code></td>
<td>

<p>a <code>gamcox</code> object.
</p>
</td></tr>
<tr><td><code id="formula.gamcox_+3A_...">...</code></td>
<td>
<p>.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>
<code><a href="#topic+gamcox">gamcox</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data(CAdata)
fit &lt;- gamcox(Surv(time,event)~lo(X,Y)+AGE+INS,data=CAdata, span = 0.2)
formula(fit)

</code></pre>

<hr>
<h2 id='formula.modgam'>
Formula of the <code><a href="#topic+modgam">modgam</a></code> Object</h2><span id='topic+formula.modgam'></span>

<h3>Description</h3>

<p>This function provide the formula of a modgam object produced by <code><a href="#topic+modgam">modgam</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'modgam'
 formula(x, ...) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="formula.modgam_+3A_x">x</code></td>
<td>

<p>a modgam object.
</p>
</td></tr>
<tr><td><code id="formula.modgam_+3A_...">...</code></td>
<td>

<p>extra arguments for S3 generic, ignored by <code>formula.modgam</code>.   	
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>
<code><a href="#topic+gamcox">gamcox</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>

<hr>
<h2 id='gamcox'>
Fit a Cox Additive Model with a Two-Dimensional Smooth</h2><span id='topic+gamcox'></span><span id='topic+gamcox.fit'></span>

<h3>Description</h3>

<p>Fits a Cox proportional hazard additive model with a two-dimensional LOESS smooth for geolocation (or any other two-dimensional predictor). <code>gamcox</code> uses the backfitting algorithm to combine the smoothing and fitting methods. The smoothing method currently supported is local regression (LOESS).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>gamcox(formula, data, subset, weights, span=0.5, I.span=0.2, degree = 1, 
       loess.trace = "exact", Maxiter = 40, tol = 1e-07)

gamcox.fit(Y, X, smooth.frame, weights, span=0.5, I.span=0.2, degree = 1, 
           loess.trace = "exact", Maxiter = 40, tol = 1e-07)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="gamcox_+3A_formula">formula</code></td>
<td>

<p>a formula expression (required), with the response on the left of a ~ oprator, and the predictors on the right. The response must be a survival object as returned by the Surv function. A built-in nonparametric smoothing term is indicated by <code>lo</code> for loess smooth terms. The two-dimensional predictor (e.g.,geolocation) should be specified as auguments in <code>lo()</code>.
</p>
</td></tr>
<tr><td><code id="gamcox_+3A_data">data</code></td>
<td>

<p>a data frame containing the variables in the model.If not found in <code>data</code>, the variables are taken from <code>environment(formula)</code>.
</p>
</td></tr>
<tr><td><code id="gamcox_+3A_y">Y</code>, <code id="gamcox_+3A_x">X</code></td>
<td>

<p>for <code>gamcox.fit</code>: <code>Y</code> is a list including two elements: <code>time</code> for survival times and <code>event</code> for censoring status. <code>X</code> is a data frame containing the variables in the model. The data must be structured so that the X and Y coordinates for two-dimensional predictor (e.g., geolocation) are in the 1st and 2nd columns, respectively. 
</p>
</td></tr>
<tr><td><code id="gamcox_+3A_smooth.frame">smooth.frame</code></td>
<td>

<p>the model matrix for the smooth term.  
</p>
</td></tr>
<tr><td><code id="gamcox_+3A_subset">subset</code></td>
<td>

<p>an optional vector specifying a subset of observations to be used in the fitting process.
</p>
</td></tr>
<tr><td><code id="gamcox_+3A_weights">weights</code></td>
<td>

<p>an optional vector of weights to be used in the fitting process.
</p>
</td></tr>
<tr><td><code id="gamcox_+3A_span">span</code></td>
<td>

<p>the span size for the LOESS smooth of the two-dimensional predictor, which controls the degree of smoothing. 
</p>
</td></tr>
<tr><td><code id="gamcox_+3A_i.span">I.span</code></td>
<td>

<p>the span size for the LOESS smooth of the Fisher information. 
</p>
</td></tr>
<tr><td><code id="gamcox_+3A_degree">degree</code></td>
<td>

<p>the degree of the polynomials to be used for LOESS smooth, normally 1 or 2.
</p>
</td></tr>
<tr><td><code id="gamcox_+3A_loess.trace">loess.trace</code></td>
<td>

<p>whether the trace of the smoother matrix be computed exactly (<code>"exact"</code>) or approximately (<code>"approximate"</code>). It is recommended to use <code>"approximate"</code> for more than about 1000 data points.
</p>
</td></tr>
<tr><td><code id="gamcox_+3A_maxiter">Maxiter</code></td>
<td>

<p>the maximum number of iterations in backfitting algorithm.  
</p>
</td></tr>
<tr><td><code id="gamcox_+3A_tol">tol</code></td>
<td>

<p>the tolerence threshold for convergence.  
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The model used to fit the data is a Cox proportional hazard additive model with a LOESS smooth for a two-dimensional predictor such as geolocation (Hastie and Tibshirani, 1990):
</p>
<p style="text-align: center;"><code class="reqn">\boldsymbol{\lambda}(t)=\boldsymbol{\lambda}_{0}(t)\exp\left\{ S(x_{i},y_{i}) + \mathbf{Z_{i}} \boldsymbol{\beta}\right\}</code>
</p>
	
<p>where <code class="reqn">\boldsymbol{\lambda}(t)</code> is the hazard at time <em>t</em> for participant <em>i</em>, <code class="reqn">x_{i}</code> and <code class="reqn">y_{i}</code> are predictor coordinates for participant <em>i</em> (i.e., projected distance east and north, respectively, from an arbitrarily defined origin location), <em>S(.,.)</em> is a 2-dimensional smoothing function (currently LOESS), <code class="reqn">\mathbf{Z_{i}}</code> is a row vector of covariate values for participant <em>i</em>, and <code class="reqn">\boldsymbol{\beta}</code> is a vector of unknown regression parameters. See the references for more details.              
</p>


<h3>Value</h3>

<p><code>gamcox</code> returns an object of class <code>gamcox</code>. It can be examined by <code>print</code> and <code>predict</code>.
</p>
<table>
<tr><td><code>coefficients</code></td>
<td>
<p>a named vector of coefficients for the parametric part of the additive predictors, which multiply the columns of the model matrix. The names of the coefficients are the names of the single-degree-of-freedom effects (the columns of the model matrix). If the model is overdetermined there will be missing values in the coefficients corresponding to inestimable coefficients.</p>
</td></tr>
<tr><td><code>additive.predictors</code></td>
<td>
<p>the additive fit, given by the product of the model matrix and the coefficients, plus the columns of the <code>$smooth</code> component.</p>
</td></tr>
<tr><td><code>smooth</code></td>
<td>

<p>estimated smoothing term. Nonlinear part of the spatial effect on survival rates.
</p>
</td></tr>
<tr><td><code>var</code></td>
<td>

<p>the approximate pointwise variances for the columns of smooth.</p>
</td></tr>
<tr><td><code>residuals</code></td>
<td>
<p>the residuals from the final weighted additive fit; also known as residuals, these are typically not interpretable without rescaling by the weights.</p>
</td></tr>
<tr><td><code>deviance</code></td>
<td>
<p>up to a constant, minus twice the maximized log-likelihood. Similar to the residual sum of squares. Where sensible, the constant is chosen so that a saturated model has deviance zero.</p>
</td></tr>
<tr><td><code>df.residual</code></td>
<td>
<p>the residual degrees of freedom.</p>
</td></tr>
<tr><td><code>aic</code></td>
<td>
<p>AIC of the fitted model.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>References</h3>

<p>Hastie TJ, Tibshirani RJ.  Generalized Additive Models.  (Chapman &amp; Hall/CRC Monographs on Statistics &amp; Applied Probability, Boca Raton, Florida, 1990). 
</p>
<p>Bristow RE, Chang J, Ziogas A, Gillen DL, Bai L, Vieira VM. Spatial Analysis of Advanced-stage Ovarian Cancer Mortality in California. American Journal of Obstetrics and Gynecology 2015, 213(1), e1-43)
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data(CAdata)
data(CAmap)

fit &lt;- gamcox(Surv(time,event)~AGE + factor(INS) + lo(X,Y),data=CAdata,
span=0.2,loess.trace="approximate")
fit
pred = predict(fit)
colormap(list(fit=pred$pred,grid=data.frame(X=CAdata$X,Y=CAdata$Y)),map=CAmap,
border.gray=0.5)


</code></pre>

<hr>
<h2 id='MAdata'>
Synthetic Case-Control Data for Massachusetts
</h2><span id='topic+MAdata'></span>

<h3>Description</h3>

<p>90 cases and 910 controls with random smoking covarate values and random geolocations within Massachusetts, geocoded on a Lambert projection (in meters).  <code><a href="#topic+MAmap">MAmap</a></code> is a map of Massachusetts using the same projection.</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(MAdata)</code></pre>


<h3>Format</h3>

<p>A data frame with 1000 observations on the following 6 variables.
</p>

<dl>
<dt><code>Case</code></dt><dd><p>0 for controls, 1 for cases.</p>
</dd>
<dt><code>Xcoord</code></dt><dd><p>projected X coordinate.</p>
</dd>
<dt><code>Ycoord</code></dt><dd><p>projected Y coordinate.</p>
</dd>
<dt><code>Smoking</code></dt><dd><p>0 for nonsmokers, 1 for smokers.</p>
</dd>
<dt><code>Mercury</code></dt><dd><p>continuous variable for mercury exposure.</p>
</dd>
<dt><code>Selenium</code></dt><dd><p>continuous variable for selenium exposure.</p>
</dd>
</dl>



<h3>Details</h3>

<p>Lambert conformal conic projection for the State of Massachusetts, using standard parallels 41.71666667 and 42.68333333.  The latitude of origin is 41.0, the central meridian is -71.5, and the projection units are meters (False Easting: 200000 m; False Northing: 750000 m).   
</p>


<h3>Source</h3>

<p>Simulated data provided by package authors
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(MAdata)
summary(MAdata)
attach(MAdata)
# map participants, cases in red and controls in black
plot(Xcoord,Ycoord,col=Case+1) 
</code></pre>

<hr>
<h2 id='MAmap'>
Map of Massachusetts
</h2><span id='topic+MAmap'></span>

<h3>Description</h3>

<p>A map of the outline of MA in SpatialPolygonsDataFrame format, converted from an ESRI shapefile using the <code>readShapePoly</code> function in the <span class="pkg">maptools</span> package.</p>


<h3>Usage</h3>

<pre><code class='language-R'>data(MAmap)</code></pre>


<h3>Format</h3>

<p>The format is class SpatialPolygonsDataFrame (package &quot;sp&quot;).
</p>


<h3>Details</h3>

<p>Lambert conformal conic projection for the State of Massachusetts, using standard parallels 41.71666667 and 42.68333333.  The latitude of origin is 41.0, the central meridian is -71.5, and the projection units are meters (False Easting: 200000 m; False Northing: 750000 m).   
</p>


<h3>Source</h3>

<p>Dr. Veronica Vieira, University of California, Irvine
</p>


<h3>Examples</h3>

<pre><code class='language-R'>data(MAmap)
plot(MAmap)
</code></pre>

<hr>
<h2 id='MapGAM.version'>
Revision Dates for MapGAM Functions
</h2><span id='topic+MapGAM.version'></span>

<h3>Description</h3>

<p>Print version and dates for MapGAM package and functions.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>  MapGAM.version()
</code></pre>


<h3>Author(s)</h3>

<p>Scott Bartell	
Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+MapGAM-package">MapGAM-package</a></code>, 
</p>

<hr>
<h2 id='modgam'>
Fit a Generalized Additive Model (GAM) with a Two-Dimensional Smooth and Make Predictions</h2><span id='topic+modgam'></span>

<h3>Description</h3>

<p>Fits a crude or adjusted regression on a user-supplied grid for spatial analysis using a generalized additive model with a two-dimensional LOESS smooth for geolocation (or any other two-dimensional predictor).  Includes optional pointwise confidence intervals and permutation tests for global and local tests of the null hypothesis that the two-dimensional predictor (e.g., geolocation) is not associated with the outcome.  Most applications will pass the output of this function to <code>plot.modgam</code> to map the resulting odds ratios or other effect estimates.</p>


<h3>Usage</h3>

<pre><code class='language-R'>modgam(formula, rgrid, data, subset, offset, family = binomial(), permute = 0, 
       conditional = TRUE, pointwise = FALSE, m = "adjusted", sp = seq(0.05,0.95,0.05), 
       degree=1, keep=FALSE, type=c("spatial","all"), reference = "median", 
       se.fit = FALSE, alpha = 0.05, verbose = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="modgam_+3A_formula">formula</code></td>
<td>

<p>a formula expression, with the response on the left of a ~ oprator, and the predictors on the right. If fitting a Cox additive model, the response must be a survival object as returned by the Surv function. A built-in nonparametric smoothing term is indicated by <code>lo</code> for loess smooth terms. The two-dimensional predictor (e.g.,geolocation) should be specified as auguments in <code>lo()</code>. <code>formula</code> can be missing if <code>data</code> and <code>family</code> are specified.
</p>
</td></tr>
<tr><td><code id="modgam_+3A_rgrid">rgrid</code></td>
<td>

<p>a data frame containing the values of X and Y coordinates at which to generate predictions. If missing, the predictions will be generated for the two-dimentional predictor in <code>data</code>. The <code>predgrid</code> function can be used to supply an appropriate rgrid for rdata, with the grid clipped according to any specified base map (see examples below).   
</p>
</td></tr>
<tr><td><code id="modgam_+3A_data">data</code></td>
<td>

<p>a data frame containing the variables in the model. If <code>formula</code> is specified, <code>data</code> is optional. In this way, if not found in <code>data</code>, the variables are taken from <code>environment(formula)</code>. If <code>formula</code> is missing, the data must be structured so that the outcome is in the 1st column (1st and 2nd colums for survival data) and the X and Y coordinates for two-dimensional predictor (e.g., geolocation) are in the 2nd and 3rd columns (3rd and 4th columns for survival data), respectively.  If more than 3 (4 for survival data) columns are provided and <code>m = "adjusted"</code>, the additional columns will be entered as linear predictors in the GAM model.    
</p>
</td></tr>
<tr><td><code id="modgam_+3A_family">family</code></td>
<td>

<p>a description of the error distribution and link function to be used in the model. This can be a character string naming a family function, a family function or the result of a call to a family function. (See <code><a href="stats.html#topic+family">family</a></code> for details of family functions.  Note that unlike other packages, MapGAM defaults to the binomial family and logit link, i.e., a logistic model.). If <code>formula</code> is missing, <code>family = "survival"</code> must be specified to fit a Cox proportional hazard additive model.
</p>
</td></tr>
<tr><td><code id="modgam_+3A_subset">subset</code></td>
<td>

<p>an optional vector specifying a subset of observations to be used in the fitting process.
</p>
</td></tr>
<tr><td><code id="modgam_+3A_offset">offset</code></td>
<td>

<p>name in data and rgrid that will be used as offset in the model. It will be ignored if offset is specified in <code>formula</code>. <code>offset</code> will be ignored if <code>family="survival"</code>
</p>
</td></tr>
<tr><td><code id="modgam_+3A_permute">permute</code></td>
<td>

<p>the number of permutations of the data set for testing the significance of the two-dimensional predictor. <code>permute = 0</code> (default) produces no permutation tests.  If <code>permute &gt; 0</code>, the paired coordinates for the two-dimensional predictor are randomly permuted in order to simulate the distribution of results under the null hypothesis that location is not associated with the outcome.  1000 permutations are recommended for reasonable accuracy of p-values.  WARNING: Because each permutation requires refitting the GAM, permutation tests can be quite slow.    
</p>
</td></tr>
<tr><td><code id="modgam_+3A_conditional">conditional</code></td>
<td>

<p>a logical value indicating whether to run a conditional or unconditional permutation test; this argument is used only when <code>permute &gt; 0</code>.  The default is a conditional permutation test: the span size is held fixed throughout all permutations even if <code>sp = NULL</code> to optimize the span size for the original data (see Young et al., 2012).  The unconditional permutation test repeats the span size optimization for each permutation, which is more conservative but takes about 20 times longer to compute.  If <code>conditional = FALSE</code> the sp argument is ignored when fitting both the original and permuted data sets.               
</p>
</td></tr>
<tr><td><code id="modgam_+3A_pointwise">pointwise</code></td>
<td>

<p>a logical value indicated whether to include pointwise permutation tests for every grid point.  This argument is only used
when <code>permute &gt; 0</code>.  Using <code>se.fit = TRUE</code> to determine grid points with significantly different outcomes is usually preferable to using pointwise permutation tests.     	
</p>
</td></tr>
<tr><td><code id="modgam_+3A_m">m</code></td>
<td>

<p>model type for the GAM.  Options are &quot;crude&quot; or &quot;adjusted&quot; (default).  If &quot;crude&quot;, only the smooth for the two-dimensional predictor is included in the model (i.e., &quot;crude&quot; is a synonym for &quot;unadjusted&quot;).  If &quot;adjusted&quot;, all covariates in the data set (columns &gt;= 4) are included in the model.     
</p>
</td></tr>
<tr><td><code id="modgam_+3A_sp">sp</code></td>
<td>

<p>the span size for the LOESS smooth of the two-dimensional predictor.  If <code>sp</code> is a vector an optimal span size will be determined using the <code>optspan</code> function, using the vector as candidate values.  By default the optimal span is chosen from among a sequence of values ranging from 0.05 to 0.95, in increments of 0.05. See the help file for <code><a href="#topic+optspan">optspan</a></code> for more details. It will be ignored if span is indicated in <code>formula</code>.  
</p>
</td></tr>
<tr><td><code id="modgam_+3A_degree">degree</code></td>
<td>

<p>the degree of the polynomials to be used for LOESS smooth, normally 1 or 2. It will be ignored if the degree is indicated in <code>formula</code>.
</p>
</td></tr>
<tr><td><code id="modgam_+3A_keep">keep</code></td>
<td>

<p>a logical value indicating whether to store and return the pointwise odds ratios, and if conditional = FALSE the span size, for every permuted data set.  These values aren't necessary for mapping or cluster identification, and storing them slows the permutation tests, so the default is <code>keep = FALSE</code>.
</p>
</td></tr>
<tr><td><code id="modgam_+3A_type">type</code></td>
<td>

<p>use <code>type="spatial"</code>(default for censored survival data) to estimate the spatial effect, or <code>type="all"</code>(default for univariate outcome) to estimate the effect of all covariates included in the model.  
</p>
</td></tr>
<tr><td><code id="modgam_+3A_reference">reference</code></td>
<td>

<p>referent for the predicted values or effects. If <code>reference="none"</code>, the output will be predicted values at each grid point for either the spatial effect (<code>type="spatial"</code>) or the linear predictor including all covariates (<code>type="all"</code>).  If <code>reference = "median"</code>, the output will be the difference between the estimated effect/predictor at each grid point and the median effect/predictor (e.g., the log odds ratio for a binomial model with logit link). If <code>reference = "mean"</code>, the output will be the difference between the estimated effect/predictor at each grid point and the mean effect/predictor.  If <code>reference</code> is a data frame indicating a specific geolocation, the output will be the difference between the estimated effect/predictor at each grid point and the effect/predictor at the geolocation specified by <code>reference</code>.
</p>
</td></tr>
<tr><td><code id="modgam_+3A_se.fit">se.fit</code></td>
<td>

<p>if <code>TRUE</code>, pointwise standard errors and confidence intervals are computed along with the predictions.  Results can be passed to <code>plot.modgam</code> with <code>contours = "interval"</code> to identify  clusters of the outcome (e.g., spatial regions with statistically significant outcomes&ndash;e.g., unusually high or low risks).   
</p>
</td></tr>
<tr><td><code id="modgam_+3A_alpha">alpha</code></td>
<td>

<p>the significace level used for confidence intervals when <code>se.fit = TRUE</code>  
</p>
</td></tr>
<tr><td><code id="modgam_+3A_verbose">verbose</code></td>
<td>

<p>a logical value indicating whether to print the GAM model statement, the percentile rank for the global deviance statistic in the permutation test, and the progress of the permutation test (report completion of every 10 permutations).  The default is <code>verbose = TRUE</code>.      
</p>
</td></tr>
<tr><td><code id="modgam_+3A_...">...</code></td>
<td>

<p>further arguments to be passed to the <code><a href="mgcv.html#topic+gam">gam</a></code> or <code><a href="#topic+gamcox">gamcox</a></code> function (e.g., weights).  	
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The model used to fit the data is a generalized additive model with a LOESS smooth for a two-dimensional predictor such as geolocation (Hastie and Tibshirani, 1990; Kelsall and Diggle, 1998; Webster et al., 2006).  Although any family and link function supported by the <code>gam</code> function is supported, the default binomial family with logit link yields the following model:
</p>
<p style="text-align: center;"><code class="reqn">\ln \left(\frac{\pi_{i}}{1-\pi_{i}}\right) = S(x_{i},y_{i}) + \mathbf{Z_{i}} \boldsymbol{\beta}</code>
</p>
	
<p>where <code class="reqn">\pi_{i}</code> is the probability that the outcome is 1 for participant <em>i</em>, <code class="reqn">x_{i}</code> and <code class="reqn">y_{i}</code> are predictor coordinates for participant <em>i</em> (i.e., projected distance east and north, respectively, from an arbitrarily defined origin location), <code class="reqn">S(.,.)</code> is a 2-dimensional smoothing function (currently LOESS), <code class="reqn">\mathbf{Z_{i}}</code> is a row vector of covariate values for participant <em>i</em>, and <code class="reqn">\boldsymbol{\beta}</code> is a vector of unknown regression parameters (including an intercept).  
When a permutation test is requested, for each permutation the paired X and Y coordinates in the data set are randomly reassigned to participants, consistent with the null hypothesis that the geolocation (or another two-dimensional predictor entered in place of X and Y) is not associated with the outcome.  Note that this procedure intentionally preserves associations between other covariates and the outcome variable so the permutation test reflects the significance of geolocation.  See the references for more details.              
</p>


<h3>Value</h3>

<p><code>modgam</code> returns an object of class <code>modgam</code>. It can be examined by <code>print</code> and <code>plot</code>.
</p>
<table>
<tr><td><code>grid</code></td>
<td>
<p>a data frame with X and Y coordinates from rgrid.</p>
</td></tr>
<tr><td><code>span</code></td>
<td>
<p>the span size used for the LOESS smooth.  If <code>keep = TRUE</code> and <code>conditional = FALSE</code>, a vector with optimized span sizes for the original data set and each of the permuted data sets.</p>
</td></tr>
<tr><td><code>gamobj</code></td>
<td>
<p>the <code><a href="mgcv.html#topic+gam">gam</a></code> or <code><a href="#topic+gamcox">gamcox</a></code> model object from the fit to the data.</p>
</td></tr>
<tr><td><code>predobj</code></td>
<td>
<p>the <code><a href="#topic+mypredict.gam">mypredict.gam</a></code> or <code><a href="#topic+predict.gamcox">predict.gamcox</a></code> model object from the fit to the data.</p>
</td></tr>
<tr><td><code>family</code></td>
<td>
<p>the family and link function used for the model.</p>
</td></tr>
<tr><td><code>fit</code></td>
<td>
<p>the predicted values for each point on the grid.  For Gaussian family models, predicted values are for the outcome variable at each grid point.  For non-Gaussian families, predicted values are for the spatial effect alone on the scale of the linear predictor, compared to a referent specified through augument <code>reference</code> (e.g., for a binomial family logit link model with <code>reference = "median"</code>, the fit values are the difference in log odds of the outcome between the grid point and the median log odds, holding other predictors constant).  If predicted responses are desired for non-Gaussian families, they can be obtained from the fit values by setting <code>reference="none"</code> and applying the inverse link function.</p>
</td></tr>
<tr><td><code>exp.fit</code></td>
<td>
<p>the exponential of <code>fit</code>.  Primarily useful for logit or log link functions (e.g., this provides odds ratios for a binomial family with logit link function.)</p>
</td></tr>
<tr><td><code>global.pvalue</code></td>
<td>
<p>the p-value based on the likelihood ratio test comparing models with and without geolocation (or other two-dimensional predictor).
</p>
</td></tr>
</table>
<p>If <code>se.fit = TRUE</code> then the following values are provided:
</p>
<table>
<tr><td><code>se</code></td>
<td>
<p>an estimated standard error for each predicted value.</p>
</td></tr>
<tr><td><code>conf.low</code></td>
<td>
<p>the lower bounds for pointwise (1-<code>alpha</code>) confidence intervals.</p>
</td></tr>
<tr><td><code>conf.high</code></td>
<td>
<p>the higher bounds for pointwise (1-<code>alpha</code>) confidence intervals.</p>
</td></tr>
</table>
<p>If <code>permute &gt; 0</code> then the following values are also provided:
</p>
<table>
<tr><td><code>global.permt</code></td>
<td>
<p>the p-value based on the deviance statistic comparing models with and without geolocation (or other two-dimensional predictor), using the distribution of deviance statistics from the permuted data sets to represent the null distribution.  For a test of H0: geolocation is unassociated with the outcome variable (adjusting for any covariates if <code>m = "adjusted"</code>), reject H0 if the percentile rank is below alpha.   WARNING: by default <code>modgam</code> uses a conditional permutation test which produces inflated type I error rates; Young et al. (2012) recommend using alpha=0.025 to limit the type I error rate to approximately 5%.</p>
</td></tr> 
<tr><td><code>pointwise.permt</code></td>
<td>
<p>Only provided when <code>pointwise = TRUE</code>.  For each point on the grid, the percentile rank of the local linear predictor for the model compared to the local linear predictor distribution from the permuted data sets.  This result can be used to define clusters of the outcome (e.g., spatial regions with statistically significant outcomes&ndash;e.g., unusually high or low risks), as in <code>plot.modgam</code> with <code>contours="permrank"</code>.</p>
</td></tr>
</table>
<p>If <code>permute</code> &gt; 0 and <code>keep = T</code> then the following values are also provided:
</p>
<table>
<tr><td><code>permutations</code></td>
<td>
<p>a matrix containing null permuted values for each point on the grid, with the results for each permutation in a separate column.  For the binomial family and logit link these are provided as odds ratios, otherwise they are reported as linear predictors.</p>
</td></tr>
<tr><td><code>deviances.permt</code></td>
<td>
<p>a vector containing deviances for each permutation.</p>
</td></tr>
</table>


<h3>Warning </h3>

<p>Permutation tests are computationally intensive, often requiring several hours or more.</p>


<h3>Author(s)</h3>

<p>Lu Bai, Scott Bartell, Robin Bliss, and Veronica Vieira 
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>References</h3>

<p>Bai L, Gillen DL, Bartell SM, Vieira VM. <a href="https://doi.org/10.32614/RJ-2020-001">doi:10.32614/RJ-2020-001</a>Mapping smoothed spatial effect estimates from individual-level data:  MapGAM. The R Journal 2020, 12:32-48. 
</p>
<p>Hastie TJ, Tibshirani RJ. Generalized Additive Models.  (Chapman &amp; Hall/CRC Monographs on Statistics &amp; Applied Probability, Boca Raton, Florida, 1990).  
</p>
<p>Kelsall J, Diggle P. <a href="https://doi.org/10.1111/1467-9876.00128">doi:10.1111/1467-9876.00128</a>Spatial variation in risk of disease: a nonparametric binary 
regression approach. J Roy Stat Soc C-App 1998, 47:559-573. 	
</p>
<p>Vieira V, Webster T, Weinberg J, Aschengrau A, Ozonoff D. <a href="https://doi.org/10.1186/1476-069X-4-11">doi:10.1186/1476-069X-4-11</a>Spatial analysis of lung, colorectal, and breast cancer on Cape Cod: An application of generalized additive models to case-control data. Environmental Health 2005, 4:11. 
</p>
<p>Webster T, Vieira V, Weinberg J, Aschengrau A. <a href="https://doi.org/10.1186/1476-072X-5-26">doi:10.1186/1476-072X-5-26</a>Method for mapping population-based case-control studies using Generalized Additive Models. International Journal of Health Geographics 2006, 5:26.
</p>
<p>Young RL, Weinberg J, Vieira V, Ozonoff A, Webster TF. <a href="https://doi.org/10.1186/1476-072X-9-37">doi:10.1186/1476-072X-9-37</a>A power comparison of generalized additive models and the spatial scan statistic in a case-control setting. International Journal of Health Geographics 2010, 9:37.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+predgrid">predgrid</a></code>, 
<code><a href="#topic+optspan">optspan</a></code>, 
<code><a href="#topic+plot.modgam">plot.modgam</a></code>
<code><a href="#topic+colormap">colormap</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# Load base map in SpatialPolygonsDataFrame format
# This map was read from ESRI shapefiles using the readShapePoly function (soon to be deprecated)
data(MAmap)	
# Load data and create grid on base map
data(MAdata)							
gamgrid &lt;- predgrid(MAdata, map=MAmap)    
# Fit crude logistic GAM to the MA data using span size of 50%
# and predict odds ratios for every point on gamgrid
fit1 &lt;- modgam(data=MAdata, rgrid=gamgrid, m="crude", sp=0.5)  
# Summary statistics for pointwise crude odds ratios 
summary(fit1$exp.fit)			
# Summary stats for pointwise crude log odds (linear predictor) 
summary(fit1$fit)			

# fit adjusted GAM using span size of 50%, 
# including a (too small) conditional permutation test
fit2 &lt;- modgam(data=MAdata, rgrid=gamgrid, permute=25, m="adjusted", sp=0.5)  
fit2

# fit adjusted GAM by specifiying formula
fit2.f &lt;- modgam(Case~lo(Xcoord,Ycoord)+Smoking + Mercury + Selenium,data=MAdata,
          rgrid=gamgrid, sp=0.5)
fit2.f

# Detailed example with a continuous outcome variable, map projections, 
# and data trimming:  investigating tweet times by geolocation
# NOTE: this example requires the maps and mapproj packages
# Convert base map and beer tweet data locations to US Albers projection 
# for better distance estimates than using (lat,long) as (X,Y) coords 
if(require(maps) &amp; require(mapproj)) {
	USmap &lt;- map("state",projection="albers",parameters=c(29.5,45.5),
		plot=FALSE,fill=TRUE,col="transparent")
	data(beertweets)
	# Reuse last map projection to convert data coordinates	
	XY &lt;- mapproject(beertweets$longitude,beertweets$latitude)[1:2]  
	jtime &lt;- julian(beertweets$time)
	# Convert tweet dates and times to time of day (24-hour)
	tweettime &lt;- as.numeric(jtime-trunc(jtime))*24
	beerproj &lt;- data.frame(tweettime, XY[1], XY[2], beertweets$beer)			 
	# Generate grid on the US map, trimmed to range of beer data
	USgrid &lt;- predgrid(beerproj, map=USmap)						
	# Fit adjusted model--adjusting for beer indicator variable 
	fit3 &lt;- modgam(data=beerproj, rgrid=USgrid, family=gaussian, 
		reference="none", m="adjusted", sp=0.05)	
	# Get summary statistics for predicted tweet times across grid points 
	summary(fit3$fit)	
}

# Smoothing survival rates over geolocations with adjustement of Age and Insurance
# Including generating pointwise standard errors and confidence intervals
data(CAdata)
data(CAgrid)
data = CAdata[1:1000,]	# use a subset of the California data
# manually set the categorical variables as factors
data$INS = factor(data$INS)
# no formula needed if data are arranged in a specific order (see \code{data} argument)
fit4 &lt;- modgam(data=data, rgrid=CAgrid, family="survival", sp=0.2)
fit4
# fit the same model using the formula argument, with data columns in any order
fit4.f &lt;- modgam(Surv(time,event)~AGE+factor(INS)+lo(X,Y), data=data,
                rgrid = CAgrid, family="survival", sp=0.2)

# Smoothing for two-dimensional chemical exposure instead of geolocation
# case status in 1st column, mercury and selenium in 2nd and 3rd columns   
ma2 &lt;- MAdata[,c(1,5:6)]  
expgrid &lt;- predgrid(ma2)
fit5 &lt;- modgam(data=ma2,rgrid=expgrid,sp=.5,m="crude") 
summary(fit5$exp.fit)
# plot the results, with mercury on the X axis and selenium on the Y axis
plot(fit5, contours="response", arrow=FALSE, axes=TRUE) 

</code></pre>

<hr>
<h2 id='mypredict.gam'>
Prediction for GAM Fits</h2><span id='topic+mypredict.gam'></span>

<h3>Description</h3>

<p>Obtains spatial effects predictions and optionally estimates standard errors and confidence intervals of those predictions from a fitted generalized additive model object.</p>


<h3>Usage</h3>

<pre><code class='language-R'>mypredict.gam(object, newdata, se.fit = FALSE, type=c("all","spatial"),
              reference = "median", level = 0.05,verbose=FALSE) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="mypredict.gam_+3A_object">object</code></td>
<td>

<p>a fitted <code>gam</code> object.
</p>
</td></tr>
<tr><td><code id="mypredict.gam_+3A_newdata">newdata</code></td>
<td>

<p>a data frame containing the values at which predictions are required. This argument can be missing, in which case predictions are made at the same values used to compute the object. Only two-dimentional predictor need be present by name in newdata.
</p>
</td></tr>
<tr><td><code id="mypredict.gam_+3A_se.fit">se.fit</code></td>
<td>

<p>if TRUE, pointwise standard errors and confidence intervals are computed along with the predictions.
</p>
</td></tr>
<tr><td><code id="mypredict.gam_+3A_type">type</code></td>
<td>

<p>use <code>type="spatial"</code> to estimate spatial effect, and use <code>type="all"</code>(default) to estimate the effect of all covariates included in the model.  
</p>
</td></tr>
<tr><td><code id="mypredict.gam_+3A_reference">reference</code></td>
<td>

<p>the type of reference for the estimated effect. If <code>reference = "median"</code>,  the output will be the estimated effect difference (or log ratio) compared to the median effect. If <code>reference = "mean"</code>,the output will be the estimated effect difference (or log-ratio) compared to the mean effect.If <code>reference</code> is a data frame indicating a specific geolocation, the output will be the estimated effect difference (or log-ratio) compared to the effect of the geolocation specified by <code>reference</code>.
</p>
</td></tr> 
<tr><td><code id="mypredict.gam_+3A_level">level</code></td>
<td>

<p>the siginificance level used when <code>se.fit=TRUE</code>.
</p>
</td></tr>
<tr><td><code id="mypredict.gam_+3A_verbose">verbose</code></td>
<td>

<p>a logical value indicating whether to print filling values for newdata. The default is <code>verbose = FALSE</code>.      
</p>
</td></tr>
</table>


<h3>Value</h3>

<table>
<tr><td><code>pred</code></td>
<td>
<p>the estimated effect difference or (log ratio) compare to the effect specified by <code>reference</code>.</p>
</td></tr>
<tr><td><code>se</code></td>
<td>

<p>the standard errors along with the predictions.
</p>
</td></tr>
<tr><td><code>conf.low</code></td>
<td>
<p>the lower bounds for pointwise (1-<code>level</code>) confidence intervals.</p>
</td></tr>
<tr><td><code>conf.high</code></td>
<td>
<p>the higher bounds for pointwise (1-<code>level</code>) confidence intervals.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>References</h3>

<p>Hastie TJ, Tibshirani RJ.  Generalized Additive Models.  (Chapman &amp; Hall/CRC Monographs on Statistics &amp; Applied Probability, Boca Raton, Florida, 1990).  
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data(MAdata)							
data(MAmap)
gamgrid &lt;- predgrid(MAdata, map=MAmap)

fit &lt;- gam(Case~lo(Xcoord,Ycoord,span=0.2)+Smoking,data=MAdata,family=binomial())
pred1 = mypredict.gam(fit)
colormap(list(fit=pred1$pred,grid=data.frame(X=MAdata$X,Y=MAdata$Y)),map=MAmap)

pred2 = mypredict.gam(fit,gamgrid)
colormap(list(fit=pred2$pred,grid=data.frame(X=gamgrid$X,Y=gamgrid$Y)),map=MAmap)

pred3 = mypredict.gam(fit,gamgrid,se.fit=TRUE)
colormap(list(fit=pred3$pred,conf.low = pred3$conf.low, conf.high = pred3$conf.high, 
          grid=data.frame(X=gamgrid$X,Y=gamgrid$Y)),map=MAmap,contours = "interval")



</code></pre>

<hr>
<h2 id='optspan'>
Determine the Optimal Span Size for <code><a href="#topic+modgam">modgam</a></code>  
</h2><span id='topic+optspan'></span>

<h3>Description</h3>

<p>Determines the optimal span size for <code>modgam</code>, a spatial generalized additive model (GAM) with a two-dimensional LOESS smooth for location, by minimizing the AIC.  
</p>


<h3>Usage</h3>

<pre><code class='language-R'>  optspan(formula, data, offset,spans = seq(0.05, 0.95, by = 0.05), m ="adjusted", 
          family = binomial(), verbose =TRUE, degree = 1, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="optspan_+3A_formula">formula</code></td>
<td>

<p>a formula expression for the model, with the response on the left of a ~ oprator, and the predictors on the right. If fitting a Cox additive model, the response must be a survival object as returned by the Surv function. A built-in nonparametric smoothing term is indicated by <code>lo</code> for loess smooth terms. The two-dimensional predictor (e.g.,geolocation) should be specified as auguments in <code>lo()</code>. <code>formula</code> can be missing if <code>data</code> is well structured and <code>family</code> is specified.     
</p>
</td></tr>
<tr><td><code id="optspan_+3A_data">data</code></td>
<td>

<p>a data frame containing the variables in the model. <code>data</code> can be missing if <code>formula</code> is specified. If <code>formula</code> is missing, the data must be structured so that the outcome variable is in the 1st (1st and 2nd for survival data) column and X and Y location values are in the 2nd and 3rd (3rd and 4th for survival data) columns.  Any additional columns will be entered as covariates with linear effects in the model. 
</p>
</td></tr>
<tr><td><code id="optspan_+3A_offset">offset</code></td>
<td>

<p>the name in data that will be used as offset in the model. It will be ignored if offset is specified in <code>formula</code>.
</p>
</td></tr>
<tr><td><code id="optspan_+3A_spans">spans</code></td>
<td>

<p>a vector of candidate span sizes that the optimal span is chosen from.
</p>
</td></tr>
<tr><td><code id="optspan_+3A_m">m</code></td>
<td>

<p>the model type.  Options are &quot;crude&quot; or &quot;adjusted&quot; (default).  If &quot;crude&quot;, only the spatial smooth term for location is included in the model.  If &quot;adjusted&quot;, all covariates in the data set (columns &gt;= 4) are included in the model.  
</p>
</td></tr>
<tr><td><code id="optspan_+3A_family">family</code></td>
<td>

<p>a family function or the result of a call to a family function. (See <code><a href="stats.html#topic+family">family</a></code> for details of family functions. <code>famil = "survival"</code> for survival data.	
</p>
</td></tr>
<tr><td><code id="optspan_+3A_verbose">verbose</code></td>
<td>

<p>a logical argument; if TRUE shows the AIC for each candidate span size.
</p>
</td></tr>
<tr><td><code id="optspan_+3A_degree">degree</code></td>
<td>

<p>a smoothing parameter used in <code><a href="#topic+modgam">modgam</a></code>.  
</p>
</td></tr>
<tr><td><code id="optspan_+3A_...">...</code></td>
<td>

<p>any additional arguments to pass to the gam function.
</p>
</td></tr>
</table>


<h3>Value</h3>

<p>The optimal span size, determined by minimizing the AIC
</p>


<h3>Note</h3>

<p>This function does not return model predictions&ndash;only the optimal span size.  To obtain model predictions use the modgam function.   
</p>


<h3>Author(s)</h3>

<p>Lu Bai, Scott Bartell, Robin Bliss, and Veronica Vieira
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+predgrid">predgrid</a></code>, 
<code><a href="#topic+modgam">modgam</a></code>, 
<code><a href="#topic+colormap">colormap</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data(MAdata)
optspan(data=MAdata, m="crude")

data(CAdata)
optspan(Surv(time,event)~AGE+factor(INS)+lo(X,Y), data=CAdata,
        spans=c(0.1,0.2,0.3),family="survival")

</code></pre>

<hr>
<h2 id='plot.modgam'>
Maps Predicted Values and Clusters for <code><a href="#topic+modgam">modgam</a></code> Objects
</h2><span id='topic+plot.modgam'></span>

<h3>Description</h3>

<p>Displays a color image map, including a legend, scale bar, and optional North arrow, showing crude or adjusted odds ratios (or linear predictors) for a grid of points.  Irregular grids are allowed.  Also draws contour lines for regions of signficantly increased or decreased values of the outcome variable (&quot;clusters&quot;), if permutation ranks are provided.  Designed to display <code>modgam</code> objects but can be used with other model results if the modgamobj list contains the correct elements.      
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'modgam'
plot(x, map = NULL, exp = FALSE, add = FALSE, intervals=TRUE, 
       mapmin = NULL, mapmax = NULL, col.seq = diverge_hsv(201), anchor=FALSE, 
       border.gray = 0.3, contours=c("none","response","permrank","interval"),
       contours.drawlabels=FALSE, contours.lty=1, contours.lwd=1, 
       contours.levels, contours.labcex=0.7, arrow=TRUE, axes=FALSE, ptsize=0.9,
       alpha=0.05, mai, legend.name = "predicted values", legend.cex=1, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="plot.modgam_+3A_x">x</code></td>
<td>

<p>(required) an object of class <code>modgam</code>, usually returned by the <code>modgam</code> function.  
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_map">map</code></td>
<td>

<p>can be used to map predicted values on a base map from the <code>map</code> function in the <span class="pkg">maps</span> package, or on a base map produced by the <code>readShapePoly</code> function in <span class="pkg">maptools</span> package.  ReadShapePoly reads maps from external files in the ESRI shapefile format.  <code>map=NULL</code> produces a color image without any base map.
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_exp">exp</code></td>
<td>

<p>if <code>exp=T</code>, <code>fit</code> will be displayed in exponential scale.  
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_add">add</code></td>
<td>

<p>use <code>add=T</code> to add the color map to an existing plot.  This will often result in loss of the legend and scale, which are added outside of the normal
map boundaries.  <code>add</code> is ignored when a map is provided using the 
<code>map</code> argument.
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_intervals">intervals</code></td>
<td>

<p>if the <code>modgam</code> object contains confidence intervals, the lower and higher intervals will be plotted if <code>intervals=T</code>.  
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_mapmin">mapmin</code></td>
<td>

<p>the minimum value for the color scale legend. 
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_mapmax">mapmax</code></td>
<td>

<p>the maximum value for the color scale legend. 
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_col.seq">col.seq</code></td>
<td>

<p>The color sequence (palette) used to display the predicted values on the map.
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_anchor">anchor</code></td>
<td>

<p>Use <code>anchor=TRUE</code> to center the color palette on <code>legend.add.line</code>.  When <code>anchor=FALSE</code> or when <code>legend.add.line</code> is not specified, the color palette will be centered halfway between mapmin and mapmax.  <code>anchor=TRUE</code> is recommended when using a divergent palette.    
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_border.gray">border.gray</code></td>
<td>

<p>gray scale for the border of <code>map</code>, ranges from 0 to 1. It is white with <code>border.gray=1</code>, and black with <code>border.gray=0</code>. The defalt scale is 0.3.
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_contours">contours</code></td>
<td>

<p>use <code>contours="response"</code> to add contour lines for the predicted response, for example to draw isoboles for mixtures of exposures.  Use <code>contours="permrank"</code> to add contour lines for pointwise p-values computed from the permutation ranks, at <code>alpha/2</code> and <code>(1-alpha)/2</code>. use <code>contours = "intervals"</code> to add contour lines for areas where the confidence intervals do not include 0. The default is &quot;none&quot; which produces no contour lines.
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_contours.drawlabels">contours.drawlabels</code></td>
<td>

<p>use <code>contours.drawlabels = TRUE</code> add labels on contour lines.   
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_contours.lty">contours.lty</code></td>
<td>

<p>the line type for contour lines.
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_contours.lwd">contours.lwd</code></td>
<td>

<p>the width for contour lines.
</p>
</td></tr> 
<tr><td><code id="plot.modgam_+3A_contours.levels">contours.levels</code></td>
<td>

<p>the levels for contour lines. When <code>exp=T</code>, the levels will also be used in an exponential scale.
</p>
</td></tr> 
<tr><td><code id="plot.modgam_+3A_contours.labcex">contours.labcex</code></td>
<td>

<p>cex for contour labelling. This is an absolute size, not a multiple of <code>par("cex")</code> 
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_arrow">arrow</code></td>
<td>

<p>use <code>arrow=T</code> to add a North arrow to the map.  	
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_axes">axes</code></td>
<td>

<p>use <code>axes=T</code> to add axes to the map (useful for chemical mixture isoboles).
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_ptsize">ptsize</code></td>
<td>

<p>the size of the points used to fill in colors on the map.  Increase to remove white space inside the map or decrease to remove color outside the map boundaries.  NOTE: white space can also be eliminated by increasing the grid size in <code>predgrid</code>, which is often preferable as it results in a higher resolution map.   
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_alpha">alpha</code></td>
<td>

<p>the nominal pointwise type I error rate; only used when <code>contours="permrank"</code>.  
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_mai">mai</code></td>
<td>

<p>the margins of the plot. Details see <a href="graphics.html#topic+par">par</a>.</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_legend.name">legend.name</code></td>
<td>

<p>the name of displayed for the legend bar.</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_legend.cex">legend.cex</code></td>
<td>

<p>a numerical value giving the amount by which legend text should be magnified relative to the default.  
</p>
</td></tr>
<tr><td><code id="plot.modgam_+3A_...">...</code></td>
<td>

<p>other arguments to be passed to <a href="#topic+colormap">colormap</a> function.
</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Produces an image map showing crude or adjusted linear predictors (or odds ratios).  If the base map is in <code>readShapePoly</code> format a scale bar is included.  The scale bar assumes that the X and Y coordinates are provided in meters.      
</p>


<h3>Warning</h3>

<p>Note that the contour lines use a pointwise nominal type I error rate of alpha; the chance of a type I error occurring for <strong>at least</strong> one point on the map is much higher, typically approaching 100% at alpha=0.05, because a spatial prediction grid generally contains many points.</p>


<h3>Author(s)</h3>

<p>Scott Bartell, Lu Bai, Robin Bliss, and Veronica Vieira
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+trimdata">trimdata</a></code>, 
<code><a href="#topic+predgrid">predgrid</a></code>, 
<code><a href="#topic+optspan">optspan</a></code>, 
<code><a href="#topic+modgam">modgam</a></code>,
<code><a href="#topic+colormap">colormap</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data(MAmap)		
data(MAdata) 
# Create a grid on the base map 
MAgrid &lt;- predgrid(MAdata, map=MAmap)
# fit crude GAM model to the MA data using span size of 50%
fit1 &lt;- modgam(data=MAdata, rgrid=MAgrid, m="crude", sp=0.5)  
# Plot a map showing crude odds ratios
plot(fit1, MAmap)					

#### A detailed example including map projections and data trimming
# NOTE: this example requires the maps and mapproj packages
# Convert base map and beer tweet data locations to US Albers projection 
# projected coords yield better distance estimates than (lat,long)
if(require(maps) &amp; require(mapproj)) {
  USmap &lt;- map("state",projection="albers",parameters=c(29.5,45.5),
               plot=FALSE,fill=TRUE,col="transparent")
  data(beertweets)
  case &lt;- beertweets$beer
  # Reuse last map projection to convert data coordinates	
  XY &lt;- mapproject(beertweets$longitude,beertweets$latitude)[1:2]  
  beerproj &lt;- data.frame(case, XY[1], XY[2])			 
  # Generate grid on the US map, trimmed to range of beer data
  USgrid &lt;- predgrid(beerproj, map=USmap)						
  # Fit unadjusted model--geolocation only
  fit2 &lt;- modgam(data=beerproj, rgrid=USgrid, m="unadjusted", sp=0.05)	
  dev.new(width=7,height=5)
  plot(fit2, USmap)
  title(main="Beer Tweet Odds Ratios")	
}

</code></pre>

<hr>
<h2 id='predgrid'>
Create a Grid and Clip It to a Map and Data Bounds
</h2><span id='topic+predgrid'></span>

<h3>Description</h3>

<p>Creates a data frame containing a rectangular grid of points to cover the range of X and Y coordinates provided in a data set, and trims the grid so that the points do not extend beyond the boundaries shown on a map.  Users can omit a data set to create a grid covering the whole map, or omit a map to create a grid covering the whole data set. 
</p>


<h3>Usage</h3>

<pre><code class='language-R'>predgrid(dataXY = NULL, map = NULL, nrow = 100, ncol = 100, X = NULL, Y = NULL)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="predgrid_+3A_dataxy">dataXY</code></td>
<td>

<p>A data frame with X and Y coordinates.  If the data frame has more than 2 columns, the X and Y coordinates must be in the 2nd and 3rd columns, respectively (the format for the data argument in the <code>modgam</code> function).  If the data frame has only 2 columns, the X coordinates must be in the 1st column and Y coordinates in the 2nd column.  If no data are provided for this argument or for the X and Y arguments, the grid will cover the entire map.          	
</p>
</td></tr>
<tr><td><code id="predgrid_+3A_map">map</code></td>
<td>

<p>a map for clipping the grid, provided in a recognized format.  Supported map classes include &quot;map&quot; (the format produced by the maps package), &quot;sf&quot; (the ISO standard format supported by the sf package), &quot;Raster&quot; (used by the raster package), or &quot;Spatial&quot; (a legacy format used by the maptools package).  To load a map from an ESRI shapefile into R, use the st_read function in the sf library, the readOGR function in the rgdal package, or the readShapePoly function in the maptools package. If <code>map = NULL</code> (default), a rectangular grid is produced covering the range of geolocations within <code>dataXY</code>.  For Raster format maps, the grid will be rectangular, rather than clipped to the raster boundaries.  If no map is provided the grid will cover the whole data set.  
</p>
</td></tr>
<tr><td><code id="predgrid_+3A_nrow">nrow</code></td>
<td>

<p>the number of rows in the grid (default=100).
</p>
</td></tr>
<tr><td><code id="predgrid_+3A_ncol">ncol</code></td>
<td>

<p>the number of columns in the grid (default=100).
</p>
</td></tr>
<tr><td><code id="predgrid_+3A_x">X</code></td>
<td>

<p>a vector of X coordinates, supplied instead of (or in addition to) dataXY.  If both X and dataXY are provided, X will be used instead of the corresponding column of dataXY.
</p>
</td></tr>    
<tr><td><code id="predgrid_+3A_y">Y</code></td>
<td>

<p>a vector of Y coordinates, supplied instead of (or in addition to) dataXY.  If both Y and dataXY are provided, Y will be used instead of the corresponding column of dataXY.
</p>
</td></tr>    
</table>


<h3>Details</h3>

<p><code>predgrid</code> creates a grid of dimensions nrow*ncol using the range of X and Y coordinates (e.g., longitude and latitude) in the data frame supplied as <code>dataXY</code>. If the map argument is used, the function <code>trimdata</code> is automatically used to clip the grid.  Users should be sure to use the same projection for the map and the data; putting both on the same plot can help reveal differing projections.  If the map centroid is not in the range of the data a warning message is printed; this might indicate differing projections but can occur naturally when the data were not sampled from the entire extent of the map, or when map boundaries are concave.  
</p>


<h3>Value</h3>

<p>A data frame with X and Y coordinates in the first two columns.  The column names from dataXY are used for the output.  If the columns of dataXY are unnamed then the names &quot;X&quot; and &quot;Y&quot; are assigned to the data frame.        
</p>


<h3>Author(s)</h3>

<p>Veronica Vieira, Scott Bartell, and Robin Bliss
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+trimdata">trimdata</a></code>, 
<code><a href="#topic+optspan">optspan</a></code>, 
<code><a href="#topic+modgam">modgam</a></code>, 
<code><a href="#topic+colormap">colormap</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'># define a rectangular 100x100 grid covering the MA data 
data(MAdata)
gamgrid &lt;- predgrid(MAdata)
# plot the grid points
plot(gamgrid$Xcoord, gamgrid$Ycoord, cex=0.1, col="red")
# and the data locations
points(MAdata$Xcoord,MAdata$Ycoord)

# But that grid extends beyond the state boundaries and into the ocean!
# Better to also clip the grid to a map of MA using the following code:

# Clip a 50x50 grid covering the MA data to a map of MA 
data(MAmap)
gamgrid2 &lt;- predgrid(MAdata, map=MAmap, nrow=50, ncol=50)
# plot the MA map and grid points
plot(MAmap)
points(gamgrid2, cex=0.1, col="red")

</code></pre>

<hr>
<h2 id='predict.gamcox'>
Prediction Method for <code>gamcox</code> Fits</h2><span id='topic+predict.gamcox'></span>

<h3>Description</h3>

<p>Obtains spatial effects predictions and optionally estimates standard errors and confidence intervals of those predictions from a fitted Cox proportional hazard additive model object.</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class "gamcox"
## S3 method for class 'gamcox'
 predict(object, newdata = object$data, se.fit = FALSE, type=c("spatial","all"),
        reference = "median", level = 0.05, verbose=FALSE,...) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="predict.gamcox_+3A_object">object</code></td>
<td>

<p>a fitted <code>gamcox</code> object.
</p>
</td></tr>
<tr><td><code id="predict.gamcox_+3A_newdata">newdata</code></td>
<td>

<p>a data frame containing the values at which predictions are required. This argument can be missing, in which case predictions are made at the same values used to compute the object. A comprehensive effect (hazard ratio) of the covariates included in <code>newdata</code> will be predicted.
</p>
</td></tr>
<tr><td><code id="predict.gamcox_+3A_se.fit">se.fit</code></td>
<td>

<p>if <code>TRUE</code>, pointwise standard errors and confidence intervals are computed along with the predictions.
</p>
</td></tr>
<tr><td><code id="predict.gamcox_+3A_type">type</code></td>
<td>

<p>use <code>type="spatial"</code>(default) to estimate spatial effect, and use <code>type="all"</code> to estimate the effect of all covariates included in the model.  
</p>
</td></tr>
<tr><td><code id="predict.gamcox_+3A_reference">reference</code></td>
<td>

<p>the type of reference for the estimated effect. If <code>reference = "median"</code>,  the output will be the estimated hazard ratio (or log-ratio) compared to the median effect. If <code>reference = "mean"</code>,the output will be the estimated hazard ratio (or log-ratio) compared to the mean effect.If <code>reference</code> is a data frame indicating a specific geolocation, the out put will be the estimated hazard ratio (or log ratio) compared to the hazard of the geolocation specified by <code>reference</code>.
</p>
</td></tr> 
<tr><td><code id="predict.gamcox_+3A_level">level</code></td>
<td>
<p>the confidence level for condifence bands.</p>
</td></tr>
<tr><td><code id="predict.gamcox_+3A_verbose">verbose</code></td>
<td>

<p>a logical value indicating whether to print filling values for newdata. The default is <code>verbose = FALSE</code>.      
</p>
</td></tr>
<tr><td><code id="predict.gamcox_+3A_...">...</code></td>
<td>
<p>extra arguments for S3 generic, ignored by <code>predict.gamcox</code>.</p>
</td></tr>   
</table>


<h3>Value</h3>

<table>
<tr><td><code>pred</code></td>
<td>
<p>the estimated log hazards ratio compared to the effect specified by <code>reference</code>.</p>
</td></tr>
<tr><td><code>se</code></td>
<td>

<p>the standard errors along with the predictions.
</p>
</td></tr>
<tr><td><code>conf.low</code></td>
<td>
<p>the lower bounds for pointwise (1-<code>level</code>) confidence intervals.</p>
</td></tr>
<tr><td><code>conf.high</code></td>
<td>
<p>the higher bounds for pointwise (1-<code>level</code>) confidence intervals.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>References</h3>

<p>Hastie TJ, Tibshirani RJ.  Generalized Additive Models.  (Chapman &amp; Hall/CRC Monographs on Statistics &amp; Applied Probability, Boca Raton, Florida, 1990).  
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data(CAdata)
data(CAmap)
fit &lt;- gamcox(Surv(time,event)~AGE + factor(INS) + lo(X,Y),data=CAdata,
       span=0.2,loess.trace="approximate")
fit
pred1 = predict(fit)
colormap(list(fit=pred1$pred,grid=data.frame(X=CAdata$X,Y=CAdata$Y)),map=CAmap,
         border.gray=0.5)

data(CAgrid)
pred2 = predict(fit,CAgrid[,c("X","Y")])
colormap(list(fit=pred2$pred,grid=data.frame(X=CAgrid$X,Y=CAgrid$Y)),map=CAmap,
        border.gray=0.5, legend.name="log hazard ratio")

## Circle significant areas based on the confidence intervals specified by conf.low and conf.high
pred3 = predict(fit,CAgrid[,c("X","Y")],se.fit=TRUE)
colormap(list(fit=pred3$pred,conf.low = pred3$conf.low, conf.high = pred3$conf.high,
          grid=data.frame(X=CAgrid$X,Y=CAgrid$Y)),map=CAmap,border.gray = 0.7,
          contours = "interval",legend.name="log hazard ratio")

</code></pre>

<hr>
<h2 id='print.gamcox'>
Print the <code><a href="#topic+gamcox">gamcox</a></code> Object
</h2><span id='topic+print.gamcox'></span>

<h3>Description</h3>

<p>This function displays information about a gamcox object produced by <code><a href="#topic+gamcox">gamcox</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'gamcox'
 print(x,...) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="print.gamcox_+3A_x">x</code></td>
<td>

<p>a <code>gamcox</code> object.
</p>
</td></tr>
<tr><td><code id="print.gamcox_+3A_...">...</code></td>
<td>
<p>.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>
<code><a href="#topic+gamcox">gamcox</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data(CAdata)
fit &lt;- gamcox(Surv(time,event)~lo(X,Y)+AGE+INS,data=CAdata, span = 0.2)
print(fit)

</code></pre>

<hr>
<h2 id='print.modgam'>
Print the <code><a href="#topic+modgam">modgam</a></code> Object</h2><span id='topic+print.modgam'></span>

<h3>Description</h3>

<p>This function displays information about a modgam object produced by <code><a href="#topic+modgam">modgam</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'modgam'
 print(x, ...) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="print.modgam_+3A_x">x</code></td>
<td>

<p>a modgam object.
</p>
</td></tr>
<tr><td><code id="print.modgam_+3A_...">...</code></td>
<td>

<p>extra arguments for S3 generic, ignored by <code>print.modgam</code>.   	
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>
<code><a href="#topic+gamcox">gamcox</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>

<hr>
<h2 id='residuals.gamcox'>
Residuals of the <code><a href="#topic+gamcox">gamcox</a></code> Object
</h2><span id='topic+residuals.gamcox'></span>

<h3>Description</h3>

<p>This function provides residuals of a gamcox object produced by <code><a href="#topic+gamcox">gamcox</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'gamcox'
 residuals(object,...) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="residuals.gamcox_+3A_object">object</code></td>
<td>

<p>a <code>gamcox</code> object.
</p>
</td></tr>
<tr><td><code id="residuals.gamcox_+3A_...">...</code></td>
<td>
<p>.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>
<code><a href="#topic+gamcox">gamcox</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data(CAdata)
fit &lt;- gamcox(Surv(time,event)~lo(X,Y)+AGE+INS,data=CAdata, span = 0.2)
residuals(fit)

</code></pre>

<hr>
<h2 id='residuals.modgam'>
Residuals of the <code><a href="#topic+modgam">modgam</a></code> Object</h2><span id='topic+residuals.modgam'></span>

<h3>Description</h3>

<p>This function provides residuals of a modgam object produced by <code><a href="#topic+modgam">modgam</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'modgam'
 residuals(object, ...) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="residuals.modgam_+3A_object">object</code></td>
<td>

<p>a modgam object.
</p>
</td></tr>
<tr><td><code id="residuals.modgam_+3A_...">...</code></td>
<td>

<p>extra arguments for S3 generic, ignored by <code>residuals.modgam</code>.   	
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>
<code><a href="#topic+gamcox">gamcox</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>

<hr>
<h2 id='sampcont'>
Unmatched Control Sampling
</h2><span id='topic+sampcont'></span>

<h3>Description</h3>

<p>Take all cases and a random sample of controls from a data frame.  Simple random sampling and spatially stratified random sampling are available.  For spatially statified random sampling, strata can be defined by region, or by region and additional stratification variables (see Tang et al., 2023 for examples and simulation comparisons).  If no specific regions are specified with stratified sampling, the function will create a regular grid for spactially stratified sampling.     
</p>


<h3>Usage</h3>

<pre><code class='language-R'>sampcont(rdata, type = "stratified", casecol=1, Xcol=2, Ycol=3, regions = NULL, 
		addstrat = NULL, times = NULL, n = 1, nrow = 100, ncol = 100)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="sampcont_+3A_rdata">rdata</code></td>
<td>

<p>a data frame with case status in the <code>casecol</code> column (by default, the 1st column), and the geocoordinates (e.g., X and Y) in the <code>Xcol</code> and <code>Ycol</code> columns (by default, the 2nd and 3rd columns).  Additional columns are not used in the sampling scheme but are retained in the sampled data frame.  
</p>
</td></tr>
<tr><td><code id="sampcont_+3A_casecol">casecol</code></td>
<td>

<p>the column number in <code>rdata</code> for the case status (coded with 0 for controls, 1 for cases).  	
</p>
</td></tr>
<tr><td><code id="sampcont_+3A_xcol">Xcol</code></td>
<td>

<p>the column number in <code>rdata</code> for the X geocoordinate.	
</p>
</td></tr>
<tr><td><code id="sampcont_+3A_ycol">Ycol</code></td>
<td>

<p>the column number in <code>rdata</code> for the Y geocoordinate.  	
</p>
</td></tr>
<tr><td><code id="sampcont_+3A_type">type</code></td>
<td>

<p><code>"stratified"</code> (default) or <code>"simple"</code>.  If <code>"simple"</code> then a simple random sample of <code>n</code> controls (rows of <code>rdata</code> with <code>outcome=0</code>) is obtained.  If <code>"stratified"</code> then a stratified random sample of controls is obtained, with up to <code>n</code> controls per stratum.  Sampling strata are defined by the <code>regions</code> and <code>times</code> arguments.  All cases (rows with outcome=1) are taken for the sample regardless of the value supplied for <code>type</code>.  
</p>
</td></tr>
<tr><td><code id="sampcont_+3A_regions">regions</code></td>
<td>

<p>a vector of length equal to the number of rows in <code>rdata</code>, used to construct sampling strata.  Only used if <code>type = "stratified"</code>.  If <code>regions = NULL</code> then the function will define <code>regions</code> as a vector of specific grid cells on a regular grid with <code>nrow</code> rows and <code>ncol</code> columns.  If <code>times = NULL</code> then the nonempty regions are used as the sampling strata.  If <code>times</code> is a vector, then the sampling strata are all nonempty combinations of <code>regions</code> and <code>times</code>.      
</p>
</td></tr>
<tr><td><code id="sampcont_+3A_addstrat">addstrat</code></td>
<td>

<p>a vector of length equal to the number of rows in <code>rdata</code>, used along with <code>regions</code> to construct sampling strata.  If <code>addstrat = NULL</code> then the sampling strata are defined only by the <code>regions</code> argument.  If <code>addstrat</code> is a vector, then the sampling strata are all nonempty combinations of <code>regions</code> and <code>addstrat</code>.  Continuous variables should generally be binned before being passed through this argument, as there are no efficiency gains if each value in <code>addstrat</code> is unique.     
</p>
</td></tr>
<tr><td><code id="sampcont_+3A_times">times</code></td>
<td>

<p>included for backward compatibility; now replaced by the <code>addstrat</code> argument which serves the same purpose.   	
</p>
</td></tr>
<tr><td><code id="sampcont_+3A_n">n</code></td>
<td>

<p>the number of controls to sample from the eligible controls in each stratum.  All available controls will be taken for strata with fewer than <code>n</code> eligible controls.  
</p>
</td></tr>
<tr><td><code id="sampcont_+3A_nrow">nrow</code></td>
<td>

<p>the number of rows used to create a regular grid for sampling regions.  Only used when <code>regions = NULL</code>.
</p>
</td></tr>
<tr><td><code id="sampcont_+3A_ncol">ncol</code></td>
<td>

<p>the number of columns used to create a regular grid for sampling regions.  Only used when <code>regions = NULL</code>.
</p>
</td></tr>
</table>


<h3>Value</h3>

<table>
<tr><td><code>rdata</code></td>
<td>

<p>a data frame with all cases and a random sample of controls.  
</p>
</td></tr>
<tr><td><code>w</code></td>
<td>

<p>the inverse probability weights for the rows in <code>rdata</code>.  Important to include as weights in subsequent analyses.    	
</p>
</td></tr>
<tr><td><code>ncont</code></td>
<td>

<p>the total number of controls in the sample. 
</p>
</td></tr>
<tr><td><code>type</code></td>
<td>

<p>statified or simple sampling, as specified by the same argument described above.
</p>
</td></tr>
<tr><td><code>gridsize</code></td>
<td>

<p>a vector with the numbers of rows and columns for the stratified sampling grid.
</p>
</td></tr>
<tr><td><code>grid</code></td>
<td>

<p>the stratified sampling grid in PolySet format.
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Scott M. Bartell and Ian W. Tang
<a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>References</h3>

<p>Tang IW, Bartell SM, Vieira VM. <a href="https://doi.org/10.1016/j.sste.2023.100584">doi:10.1016/j.sste.2023.100584</a>Unmatched Spatially Stratified Controls: A simulation study examining efficiency and precision using spatially-diverse controls and generalized additive models. Spatial and Spatio-temporal Epidemiology 2023, 45:100584.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>#### load beertweets data, which has 719 cases and 9281 controls
data(beertweets)
# take a simple random sample of 1000 controls
samp1 &lt;- sampcont(beertweets, type="simple", n=1000)

# take a stratified random sample of controls on a 80x50 grid
samp2 &lt;- NULL

samp2 &lt;- sampcont(beertweets, nrow=80, ncol=50)

# Compare locations for the two sampling designs (cases in red)
par(mfrow=c(2,1), mar=c(0,3,4,3))
plot(samp1$rdata$longitude, samp1$rdata$latitude, col=3-samp1$rdata$beer,
	cex=0.5, type="p", axes=FALSE, ann=FALSE)
# Show US base map if maps package is available
mapUS &lt;- require(maps)
if (mapUS) map("state", add=TRUE)
title("Simple Random Sample, 1000 Controls")

if (!is.null(samp2)) {
	plot(samp2$rdata$longitude, samp2$rdata$latitude, 
		col=3-samp2$rdata$beer, cex=0.5, type="p", axes=FALSE, 
		ann=FALSE)
	if (mapUS) map("state", add=TRUE)
	title(paste("Spatially Stratified Sample,",samp2$ncont,"Controls"))
	}

par(mfrow=c(1,1))

## Note that weights are needed in statistical analyses
# Prevalence of cases in sample--not in source data
mean(samp1$rdata$beer)		 
# Estimated prevalence of cases in source data 
weighted.mean(samp1$rdata$beer, w=samp1$w)	
## Do beer tweet odds differ below the 36.5 degree parallel?
# Using full data
glm(beer~I(latitude&lt;36.5), family=binomial, data=beertweets) 
# Stratified sample requires sampling weights 
if (!is.null(samp2)) glm(beer~I(latitude&lt;36.5), family=binomial, 
	data=samp2$rdata, weights=samp2$w)
</code></pre>

<hr>
<h2 id='summary.gamcox'>
Summarize the <code><a href="#topic+gamcox">gamcox</a></code> Object
</h2><span id='topic+summary.gamcox'></span>

<h3>Description</h3>

<p>This function summarizes information about a gamcox object produced by <code><a href="#topic+gamcox">gamcox</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'gamcox'
 summary(object,...) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="summary.gamcox_+3A_object">object</code></td>
<td>

<p>a <code>gamcox</code> object.
</p>
</td></tr>
<tr><td><code id="summary.gamcox_+3A_...">...</code></td>
<td>
<p>.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>
<code><a href="#topic+gamcox">gamcox</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data(CAdata)
fit &lt;- gamcox(Surv(time,event)~lo(X,Y)+AGE+INS,data=CAdata, span = 0.2)
summary(fit)

</code></pre>

<hr>
<h2 id='summary.modgam'>
Summarize the <code><a href="#topic+modgam">modgam</a></code> Object</h2><span id='topic+summary.modgam'></span>

<h3>Description</h3>

<p>This function summarizes information about a modgam object produced by <code><a href="#topic+modgam">modgam</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'modgam'
 summary(object, ...) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="summary.modgam_+3A_object">object</code></td>
<td>

<p>a modgam object.
</p>
</td></tr>
<tr><td><code id="summary.modgam_+3A_...">...</code></td>
<td>

<p>extra arguments for S3 generic, ignored by <code>summary.modgam</code>.   	
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>
<code><a href="#topic+gamcox">gamcox</a></code>, 
<code><a href="#topic+predict.gamcox">predict.gamcox</a></code>.
</p>

<hr>
<h2 id='toformula'>
Build a Formula Based on Data for <code><a href="#topic+modgam">modgam</a></code> Function</h2><span id='topic+toformula'></span>

<h3>Description</h3>

<p>Based on the arguments in <code><a href="#topic+modgam">modgam</a></code>, build a formula used for model fitting.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>toformula(formula, data,m="adjusted",surv = FALSE, span=0.5,degree=2,
          smooth = TRUE,offset='')
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="toformula_+3A_formula">formula</code></td>
<td>

<p>a user specified formula expression (for <code><a href="#topic+modgam">modgam</a></code>).
</p>
</td></tr>
<tr><td><code id="toformula_+3A_data">data</code></td>
<td>

<p>a well structured data frame with the two geolocation parameters in the first and second columns. <code>data</code> is ingnored if <code>formula</code> is specified.
</p>
</td></tr>
<tr><td><code id="toformula_+3A_m">m</code></td>
<td>

<p>use <code>m="adjusted"</code> to specify a model including adjusted confounders. Use <code>m="unadjusted"</code> to specify a unadjusted model.
</p>
</td></tr>
<tr><td><code id="toformula_+3A_surv">surv</code></td>
<td>

<p><code>surv=TRUE</code> specifies a model for censored surival dataset. 
</p>
</td></tr>
<tr><td><code id="toformula_+3A_span">span</code>, <code id="toformula_+3A_degree">degree</code></td>
<td>

<p>smoothing parameters used for smoothing functions (see details in <code><a href="#topic+modgam">modgam</a></code>) if <code>smooth=TRUE</code>.
</p>
</td></tr>
<tr><td><code id="toformula_+3A_smooth">smooth</code></td>
<td>

<p><code>smooth=TRUE</code> specifies a smooth term in the model.
</p>
</td></tr>
<tr><td><code id="toformula_+3A_offset">offset</code></td>
<td>

<p>the name for offset.
</p>
</td></tr>
</table>


<h3>Value</h3>

<p>The function returns the formula for the model.
</p>


<h3>Author(s)</h3>

<p>Lu Bai
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+modgam">modgam</a></code>, .
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
data(CAdata)
toformula(data=CAdata, surv=TRUE)

</code></pre>

<hr>
<h2 id='trimdata'>
Trim a Data Set To Map Boundaries 
</h2><span id='topic+trimdata'></span>

<h3>Description</h3>

<p>Takes a subset of a data frame: returns rows with geolocations inside the boundaries determined by a map.  If <code>rectangle=FALSE</code>, strict map boundaries are used.  If <code>rectangle=TRUE</code>, a rectangular boundary is determined based on the range of X and Y coordinates for the map, along with an optional buffer.   
</p>


<h3>Usage</h3>

<pre><code class='language-R'>trimdata(rdata, map, Xcol=2, Ycol=3, rectangle=F, buffer=0.05)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="trimdata_+3A_rdata">rdata</code></td>
<td>

<p>the data set (required).  If <code>rdata</code> has only 2 columns then they are assumed to be the X and Y coordinates, in that order.  If <code>rdata</code> has more than 2 columns then identify the positions of the X and Y coordinates with <code>Xcol</code> and <code>Ycol</code>, respectively.
</p>
</td></tr>
<tr><td><code id="trimdata_+3A_map">map</code></td>
<td>

<p>a map for clipping the grid, provided in a recognized format.  Supported map classes include &quot;map&quot; (the format produced by the maps package), &quot;sf&quot; (the ISO standard format for maps, supported by the sf package), &quot;Raster&quot; (used by the raster package), or &quot;Spatial&quot; (a legacy format used by the maptools package).  To load a map from an ESRI shapefile into R, use the <code>st_read</code> function in the sf library, the <code>readOGR</code> function in the rgdal package, or the <code>readShapePoly</code> function in the maptools package (soon to be deprecated).  For Raster format maps, the grid will be rectangular, rather than clipped to the raster boundaries.
</p>
</td></tr>
<tr><td><code id="trimdata_+3A_xcol">Xcol</code></td>
<td>

<p>the column number of rdata for the X coordinates of geolocation.  Only used if rdata has &gt;2 columns.
</p>
</td></tr>
<tr><td><code id="trimdata_+3A_ycol">Ycol</code></td>
<td>

<p>the column number of rdata for the Y coordinates of geolocation.  Only used if rdata has &gt;2 columns.
</p>
</td></tr>
<tr><td><code id="trimdata_+3A_rectangle">rectangle</code></td>
<td>

<p>if <code>rectangle=FALSE</code> (default), only data with geolocations strictly within the map boundaries are retained.  If <code>rectangle=TRUE</code>, only data with geolocations within a rectangular boundary are retained.  The rectangular boundary coordinates are determined using the ranges of X and Y coordinates for the map, along with an optional buffer.   
</p>
</td></tr>
<tr><td><code id="trimdata_+3A_buffer">buffer</code></td>
<td>

<p>a fraction of the map range to add to either side of the rectangular boundary before trimming the data (default 5%).  The buffer argument is ignored if <code>rectangle=FALSE</code>.  If a vector of length 2 is supplied, the first value as the buffer fraction for the X coordinate range and the second value is used as the buffer fraction for the Y coordinate range. 
</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Functions from the sf package are used to convert map formats and clip the grid to points inside the map boundaries.  Be sure to use <code>fill=T</code> when using the <code>map</code> function to produce maps for <code>trimdata</code>: maps produced using the default <code>fill=F</code> argument do not work properly with this function!  If the map bounding box centroid is not in the range of the data, a warning message is printed; this might indicate differing projections, but can occur naturally when the data were not sampled from the entire extent of the map, or when map boundaries are concave.      
</p>


<h3>Value</h3>

<p>A subset of the rdata data frame containing only those rows with geolocations within the specified boundaries.      
</p>


<h3>Author(s)</h3>

<p>Veronica Vieira, Scott Bartell, and Robin Bliss
</p>
<p>Send bug reports to <a href="mailto:sbartell@uci.edu">sbartell@uci.edu</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+predgrid">predgrid</a></code>,
<code><a href="#topic+optspan">optspan</a></code>, 
<code><a href="#topic+modgam">modgam</a></code>, 
<code><a href="#topic+colormap">colormap</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>	
# This example uses the "sf" package to read in an external ESRI shapefile for Maine
if (require(sf)) {
  # download example shapefile zip from github, and unzip
  zippath &lt;- paste(tempdir(),"Income_schooling.zip",sep="/")	
  download.file("https://github.com/mgimond/Spatial/raw/main/Data/Income_schooling.zip", 
              destfile = zippath, mode='wb')
  unzip(zippath, exdir = tempdir())

  # read shapefile into sf format 
  shppath &lt;- paste(tempdir(),"Income_schooling.shp",sep="/")	
  basemap0 &lt;- st_read(shppath)  
  
  # Create example data by randomly sampling within bounding box
  rs &lt;- st_bbox(basemap0)   # get ranges of X and Y
  MEdata &lt;- data.frame(X=runif(300,rs[1],rs[3]), Y=runif(300,rs[2],rs[4]))
  plot(basemap0["NAME"], reset=FALSE)
  plot(st_as_sf(MEdata,coords=1:2), add=TRUE)  # plot data in black
  
  # trim data to basemap, and plot trimmed data with red X's
  dME &lt;- trimdata(MEdata, basemap0)
  plot(st_as_sf(dME,coords=1:2), col="red", pch="X", add=TRUE) 
  dev.off() 	  # clear map settings
}
	
# The following examples use the "maps" package, which includes its own maps
if (require(maps)) {
  data(beertweets)

  ### Trim beer tweet data to US base map, and plot them
  basemap1 &lt;- map("usa", fill=TRUE, col="transparent")	
  dUS &lt;- trimdata(beertweets, basemap1)	 				 
  # Plot tweet locations (beer tweets in red)
  points(dUS$longitude, dUS$latitude, col=dUS$beer+1, cex=0.5)		
  dev.off()  # clear map settings
  
  ### Trim beer tweet data to Texas base map, and plot them
  basemap2 &lt;- map("state", regions="texas", fill=TRUE, col="transparent") 
  dTX &lt;- trimdata(beertweets, basemap2) 								
  # Plot tweet locations (beer tweets in red)
  points(dTX$longitude, dTX$latitude, col=dTX$beer+1, cex=0.5) 
}
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
