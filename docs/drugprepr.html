<!DOCTYPE html><html><head><title>Help for package drugprepr</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {drugprepr}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#clean_duration'><p>Clean implausibly-long prescription durations</p></a></li>
<li><a href='#close_small_gaps'><p>Close small gaps between successive prescriptions</p></a></li>
<li><a href='#compute_ndd'><p>Compute numerical daily dose from free-text prescribing instructions</p></a></li>
<li><a href='#dataset1'><p>Example data from the Clinical Practice Research Datalink (CPRD).</p></a></li>
<li><a href='#decision_1'><p>Decision 1: impute implausible total quantities</p></a></li>
<li><a href='#decision_10'><p>Decision 10: close small gaps between successive prescriptions</p></a></li>
<li><a href='#decision_2'><p>Decision 2: impute missing total quantities</p></a></li>
<li><a href='#decision_3'><p>Decision 3: impute implausible daily doses</p></a></li>
<li><a href='#decision_4'><p>Decision 4: impute missing daily doses</p></a></li>
<li><a href='#decision_5'><p>Decision 5: impute implausible prescription durations</p></a></li>
<li><a href='#decision_6'><p>Decision 6: choose method of calculating prescription duration</p></a></li>
<li><a href='#decision_7'><p>Decision 7: impute missing prescription durations</p></a></li>
<li><a href='#decision_8'><p>Decision 8: disambiguate prescriptions with the same start date</p></a></li>
<li><a href='#decision_9'><p>Decision 9: handle overlapping prescription periods</p></a></li>
<li><a href='#drug_prep'><p>Run drug preparation algorithm</p></a></li>
<li><a href='#example_therapy'><p>Example electronic prescription dataset</p></a></li>
<li><a href='#get_mode'><p>Get the mode (most common value) of a vector</p></a></li>
<li><a href='#impute'><p>Impute missing or implausible values</p></a></li>
<li><a href='#impute_duration'><p>Replace missing or implausible prescription durations</p></a></li>
<li><a href='#impute_ndd'><p>Replace implausible or missing numerical daily doses (NDD)</p></a></li>
<li><a href='#impute_qty'><p>Find implausible entries</p>
Replace implausible or missing prescription quantities</a></li>
<li><a href='#isolate_overlaps'><p>Separating overlapping prescription periods</p></a></li>
<li><a href='#make_decisions'><p>Human-friendly interface to the drug prep algorithm</p></a></li>
<li><a href='#min_max_dat'><p>Example min-max data.</p></a></li>
<li><a href='#outside_range'><p>Do values fall outside a specified 'plausible' range?</p></a></li>
<li><a href='#shift_interval'><p>Shift time intervals until they no longer overlap</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Title:</td>
<td>Prepare Electronic Prescription Record Data to Estimate Drug
Exposure</td>
</tr>
<tr>
<td>Version:</td>
<td>0.0.4</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>David Selby &lt;David.Selby@manchester.ac.uk&gt;</td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/belayb/drugprepr/issues">https://github.com/belayb/drugprepr/issues</a></td>
</tr>
<tr>
<td>Description:</td>
<td>Prepare prescription data (such as from the Clinical Practice Research Datalink) into an analysis-ready format, with start and stop dates for each patient's prescriptions. Based on Pye et al (2018) &lt;<a href="https://doi.org/10.1002%2Fpds.4440">doi:10.1002/pds.4440</a>&gt;.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file LICENSE</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>Language:</td>
<td>en-GB</td>
</tr>
<tr>
<td>LazyData:</td>
<td>true</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.1.2</td>
</tr>
<tr>
<td>Imports:</td>
<td>dplyr, doseminer, rlang, tidyr, sqldf, stringr, purrr,
DescTools</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 2.10)</td>
</tr>
<tr>
<td>Suggests:</td>
<td>knitr, rmarkdown, testthat, kableExtra</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2021-11-09 11:50:09 UTC; j10204ds</td>
</tr>
<tr>
<td>Author:</td>
<td>Belay Birlie Yimer
    <a href="https://orcid.org/0000-0001-8621-6539"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [aut],
  David Selby <a href="https://orcid.org/0000-0001-8026-5663"><img alt="ORCID iD"src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a> [aut,
    cre],
  Meghna Jani [aut],
  Goran Nenadic [aut],
  Mark Lunt [aut],
  William G. Dixon [aut]</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2021-11-09 18:50:05 UTC</td>
</tr>
</table>
<hr>
<h2 id='clean_duration'>Clean implausibly-long prescription durations</h2><span id='topic+clean_duration'></span>

<h3>Description</h3>

<p>Given a prescription length limit, truncate any prescriptions that appear to
be longer than this, or mark them as missing.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>clean_duration(data, max_months = Inf, method = c("truncate", "remove"))
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="clean_duration_+3A_data">data</code></td>
<td>
<p>A data frame containing a column called <code>duration</code></p>
</td></tr>
<tr><td><code id="clean_duration_+3A_max_months">max_months</code></td>
<td>
<p>The maximum plausible prescription length in months</p>
</td></tr>
<tr><td><code id="clean_duration_+3A_method">method</code></td>
<td>
<p>Either 'truncate' or 'remove'. See details</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The method 'truncate' causes any duration longer than <code>max_months</code> to
be replaced with the value of <code>max_months</code> (albeit converted to days).
The method 'remove' causes such durations to be replaced with <code>NA</code>.
There is no explicit 'ignore' method, but if you want to 'do nothing', simply
set <code>max_months</code> to an arbitrarily high number.
By default, the maximum is infinite, so nothing should happen.
(Of course, you could also just <em>not</em> run the function...)
</p>


<h3>Value</h3>

<p>A data frame of the same structure as the input, possibly with some elements of the <code>duration</code> column changed
</p>


<h3>Note</h3>

<p>Currently the variable name is hard-coded as 'duration', but in
principle this could be parametrised for datasets where the column has a
different name.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>long_presc &lt;- data.frame(duration = c(100, 300, 400, 800))
clean_duration(long_presc, 6)
clean_duration(long_presc, 12, 'remove')

</code></pre>

<hr>
<h2 id='close_small_gaps'>Close small gaps between successive prescriptions</h2><span id='topic+close_small_gaps'></span>

<h3>Description</h3>

<p>Given a series of prescriptions in <code>data</code>, if one prescription
(for the same patient and drug) starts <code class="reqn">\leq</code> <code>min_gap</code> days
after the previous one finishes, we extend the length of the previous
prescription to cover the gap.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>close_small_gaps(data, min_gap = 0L)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="close_small_gaps_+3A_data">data</code></td>
<td>
<p>A data frame containing columns <code>prodcode</code>, <code>patid</code>,
<code>start_date</code> and <code>stop_date</code></p>
</td></tr>
<tr><td><code id="close_small_gaps_+3A_min_gap">min_gap</code></td>
<td>
<p>Size of largest gaps to close. Default is zero, i.e. do nothing</p>
</td></tr>
</table>


<h3>Value</h3>

<p>The input data frame <code>data</code>, possibly with some of the
<code>stop_date</code>s changed.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>gappy_data &lt;- data.frame(
  patid = 1,
  prodcode = 'a',
  start_date = Sys.Date() + (0:6) * 7,
  stop_date = Sys.Date() + (0:6) * 7 + 4
)
close_small_gaps(gappy_data)
close_small_gaps(gappy_data, 7)

</code></pre>

<hr>
<h2 id='compute_ndd'>Compute numerical daily dose from free-text prescribing instructions</h2><span id='topic+compute_ndd'></span>

<h3>Description</h3>

<p>The function calls the <span class="rlang"><b>R</b></span> package <strong>doseminer</strong> to extract dose
information from free-text prescribing instructions, then computes the
average numerical daily dose according to a given decision rule.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>compute_ndd(data, dose_fn = mean, freq_fn = mean, interval_fn = mean)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="compute_ndd_+3A_data">data</code></td>
<td>
<p>a data frame containing free-text prescribing instructions in a
column called <code>text</code>.</p>
</td></tr>
<tr><td><code id="compute_ndd_+3A_dose_fn">dose_fn</code></td>
<td>
<p>function to summarise range of numbers by a single value</p>
</td></tr>
<tr><td><code id="compute_ndd_+3A_freq_fn">freq_fn</code></td>
<td>
<p>function to summarise range of frequencies by a single value</p>
</td></tr>
<tr><td><code id="compute_ndd_+3A_interval_fn">interval_fn</code></td>
<td>
<p>function to summarise range of intervals by a single value</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The general formula for computing numerical daily dose (ndd) is given by
</p>
<p style="text-align: center;"><code class="reqn">\mbox{ndd} = \mbox{DF} \times \mbox{DN} / \mbox{DI},</code>
</p>

<p>where
</p>

<dl>
<dt>DF</dt><dd><p>is dose frequency, the number of dose 'events' per day</p>
</dd>
<dt>DN</dt><dd><p>is dose number, or number of units of drug taken during each dose 'event'</p>
</dd>
<dt>DI</dt><dd><p>is dose interval, or the number of days between 'dose days', where an interval of 1 means every day</p>
</dd>
</dl>

<p>Prescriptions can have a variable dose frequency or dose number, such as
'2-4 tablets up to 3 times per day'. In this case, the user can choose
to reduce these ranges to single values by taking the minimum, maximum or
average of these endpoints.
</p>


<h3>Value</h3>

<p>A data frame mapping the raw <code>text</code> to structured dosage information.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>compute_ndd(dataset1, min, min, mean)

</code></pre>

<hr>
<h2 id='dataset1'>Example data from the Clinical Practice Research Datalink (CPRD).</h2><span id='topic+dataset1'></span>

<h3>Description</h3>

<p>A dataset containing prescription information for two individuals.
The dataset is a hypothetical dataset resembling the real CPRD data.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>dataset1
</code></pre>


<h3>Format</h3>

<p>A data frame with 18 rows and 9 variables:
</p>

<dl>
<dt>patid</dt><dd><p>unique identifier given to a patient in CPRD GOLD</p>
</dd>
<dt>pracid</dt><dd><p>unique identifier given to a practice in CPRD GOLD</p>
</dd>
<dt>start_date</dt><dd><p>Beginning of the prescription period</p>
</dd>
<dt>prodcode</dt><dd><p>CPRD unique code for the treatment selected by the GP</p>
</dd>
<dt>dossageid</dt><dd><p>Identifier that allows dosage information on the event to be retrieved from Common Dosages Lookup table</p>
</dd>
<dt>text</dt><dd><p>Prescription instruction for the prescribed product, as entered by the GP</p>
</dd>
<dt>qty</dt><dd><p>Total quantity entered by the GP for the prescribed product</p>
</dd>
<dt>numdays</dt><dd><p>Number of treatment days prescribed for a specific therapy event</p>
</dd>
<dt>dose_duration</dt><dd><p>an estimated prescription duration, as entered by CPRD</p>
</dd>
</dl>
<p>...

</p>


<h3>Source</h3>

<p><a href="https://cprdcw.cprd.com/_docs/CPRD_GOLD_Full_Data_Specification_v2.0.pdf">https://cprdcw.cprd.com/_docs/CPRD_GOLD_Full_Data_Specification_v2.0.pdf</a>
</p>

<hr>
<h2 id='decision_1'>Decision 1: impute implausible total quantities</h2><span id='topic+decision_1'></span>

<h3>Description</h3>

<p>A light wrapper around <code><a href="#topic+impute_qty">impute_qty</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>decision_1(data, decision = "a")
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="decision_1_+3A_data">data</code></td>
<td>
<p>a data frame</p>
</td></tr>
<tr><td><code id="decision_1_+3A_decision">decision</code></td>
<td>
<p>one of the following strings:
</p>

<dl>
<dt>&quot;a&quot;</dt><dd><p>do nothing; leave implausible values as-is</p>
</dd>
<dt>&quot;b&quot;</dt><dd><p>set implausible values to missing</p>
</dd>
<dt>&quot;c1&quot;</dt><dd><p>set to mean for individual's prescriptions for that drug</p>
</dd>
<dt>&quot;c2&quot;</dt><dd><p>set to mean for practice's prescriptions for that drug</p>
</dd>
<dt>&quot;c3&quot;</dt><dd><p>set to mean for populations's prescriptions for that drug</p>
</dd>
<dt>&quot;d1&quot;</dt><dd><p>set to median for individual's prescriptions for that drug</p>
</dd>
<dt>&quot;d2&quot;</dt><dd><p>set to median for practice's prescriptions for that drug</p>
</dd>
<dt>&quot;d3&quot;</dt><dd><p>set to median for population's prescriptions for that drug</p>
</dd>
<dt>&quot;e1&quot;</dt><dd><p>set to mode for individual's prescriptions for that drug</p>
</dd>
<dt>&quot;e2&quot;</dt><dd><p>set to mode for practice's prescriptions for that drug</p>
</dd>
<dt>&quot;e3&quot;</dt><dd><p>set to mode for population's prescriptions for that drug</p>
</dd>
<dt>&quot;f1&quot;</dt><dd><p>use value of individual's next prescription</p>
</dd>
<dt>&quot;f2&quot;</dt><dd><p>use value of practice's next prescription</p>
</dd>
<dt>&quot;f3&quot;</dt><dd><p>use value of population's next prescription</p>
</dd>
<dt>&quot;g1&quot;</dt><dd><p>use value of individual's previous prescription</p>
</dd>
<dt>&quot;g2&quot;</dt><dd><p>use value of practice's previous prescription</p>
</dd>
<dt>&quot;g3&quot;</dt><dd><p>use value of population's previous prescription</p>
</dd>
</dl>
</td></tr>
</table>


<h3>Note</h3>

<p>Decisions <code>f</code> and <code>g</code> are not yet implemented.
</p>


<h3>See Also</h3>

<p>Other decision functions: 
<code><a href="#topic+decision_10">decision_10</a>()</code>,
<code><a href="#topic+decision_2">decision_2</a>()</code>,
<code><a href="#topic+decision_3">decision_3</a>()</code>,
<code><a href="#topic+decision_4">decision_4</a>()</code>,
<code><a href="#topic+decision_5">decision_5</a>()</code>,
<code><a href="#topic+decision_6">decision_6</a>()</code>,
<code><a href="#topic+decision_7">decision_7</a>()</code>,
<code><a href="#topic+decision_8">decision_8</a>()</code>,
<code><a href="#topic+decision_9">decision_9</a>()</code>,
<code><a href="#topic+drug_prep">drug_prep</a>()</code>
</p>

<hr>
<h2 id='decision_10'>Decision 10: close small gaps between successive prescriptions</h2><span id='topic+decision_10'></span>

<h3>Description</h3>

<p>Where one prescription (for the same drug and patient) starts only a short
time after the previous finishes, this function can close the gap, as if
the prescription was continuous over the entire period.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>decision_10(data, decision = "a")
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="decision_10_+3A_data">data</code></td>
<td>
<p>a data frame</p>
</td></tr>
<tr><td><code id="decision_10_+3A_decision">decision</code></td>
<td>
<p>one of the following strings:
</p>

<dl>
<dt>&quot;a&quot;</dt><dd><p>do nothing</p>
</dd>
<dt>&quot;b_15&quot;</dt><dd><p>change stop date of first prescription to start date of next if gap is <code class="reqn">\leq 15</code> days</p>
</dd>
<dt>&quot;b_30&quot;</dt><dd><p>change stop date of first prescription to start date of next if gap is <code class="reqn">\leq 30</code> days</p>
</dd>
<dt>&quot;b_60&quot;</dt><dd><p>change stop date of first prescription to start date of next if gap is <code class="reqn">\leq 60</code> days</p>
</dd>
</dl>
</td></tr>
</table>


<h3>Details</h3>

<p>The underlying function is called <code>close_small_gaps</code>
</p>


<h3>See Also</h3>

<p>Other decision functions: 
<code><a href="#topic+decision_1">decision_1</a>()</code>,
<code><a href="#topic+decision_2">decision_2</a>()</code>,
<code><a href="#topic+decision_3">decision_3</a>()</code>,
<code><a href="#topic+decision_4">decision_4</a>()</code>,
<code><a href="#topic+decision_5">decision_5</a>()</code>,
<code><a href="#topic+decision_6">decision_6</a>()</code>,
<code><a href="#topic+decision_7">decision_7</a>()</code>,
<code><a href="#topic+decision_8">decision_8</a>()</code>,
<code><a href="#topic+decision_9">decision_9</a>()</code>,
<code><a href="#topic+drug_prep">drug_prep</a>()</code>
</p>

<hr>
<h2 id='decision_2'>Decision 2: impute missing total quantities</h2><span id='topic+decision_2'></span>

<h3>Description</h3>

<p>A light wrapper around <code><a href="#topic+impute_qty">impute_qty</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>decision_2(data, decision = "a")
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="decision_2_+3A_data">data</code></td>
<td>
<p>a data frame</p>
</td></tr>
<tr><td><code id="decision_2_+3A_decision">decision</code></td>
<td>
<p>one of the following strings:
</p>

<dl>
<dt>&quot;a&quot;</dt><dd><p>Leave as missing (implicitly drop this prescription)</p>
</dd>
<dt>&quot;b1&quot;</dt><dd><p>set to mean for individual's prescriptions for that drug</p>
</dd>
<dt>&quot;b2&quot;</dt><dd><p>set to mean for practice's prescriptions for that drug</p>
</dd>
<dt>&quot;b3&quot;</dt><dd><p>set to mean for populations's prescriptions for that drug</p>
</dd>
<dt>&quot;c1&quot;</dt><dd><p>set to median for individual's prescriptions for that drug</p>
</dd>
<dt>&quot;c2&quot;</dt><dd><p>set to median for practice's prescriptions for that drug</p>
</dd>
<dt>&quot;c3&quot;</dt><dd><p>set to median for population's prescriptions for that drug</p>
</dd>
<dt>&quot;d1&quot;</dt><dd><p>set to mode for individual's prescriptions for that drug</p>
</dd>
<dt>&quot;d2&quot;</dt><dd><p>set to mode for practice's prescriptions for that drug</p>
</dd>
<dt>&quot;d3&quot;</dt><dd><p>set to mode for population's prescriptions for that drug</p>
</dd>
<dt>&quot;e1&quot;</dt><dd><p>use value of individual's next prescription</p>
</dd>
<dt>&quot;e2&quot;</dt><dd><p>use value of practice's next prescription</p>
</dd>
<dt>&quot;e3&quot;</dt><dd><p>use value of population's next prescription</p>
</dd>
<dt>&quot;f1&quot;</dt><dd><p>use value of individual's previous prescription</p>
</dd>
<dt>&quot;f2&quot;</dt><dd><p>use value of practice's previous prescription</p>
</dd>
<dt>&quot;f3&quot;</dt><dd><p>use value of population's previous prescription</p>
</dd>
</dl>
</td></tr>
</table>


<h3>Note</h3>

<p>Decisions <code>e</code> and <code>f</code> are not yet implemented.
</p>


<h3>See Also</h3>

<p>Other decision functions: 
<code><a href="#topic+decision_10">decision_10</a>()</code>,
<code><a href="#topic+decision_1">decision_1</a>()</code>,
<code><a href="#topic+decision_3">decision_3</a>()</code>,
<code><a href="#topic+decision_4">decision_4</a>()</code>,
<code><a href="#topic+decision_5">decision_5</a>()</code>,
<code><a href="#topic+decision_6">decision_6</a>()</code>,
<code><a href="#topic+decision_7">decision_7</a>()</code>,
<code><a href="#topic+decision_8">decision_8</a>()</code>,
<code><a href="#topic+decision_9">decision_9</a>()</code>,
<code><a href="#topic+drug_prep">drug_prep</a>()</code>
</p>

<hr>
<h2 id='decision_3'>Decision 3: impute implausible daily doses</h2><span id='topic+decision_3'></span>

<h3>Description</h3>

<p>A light wrapper around <code><a href="#topic+impute_ndd">impute_ndd</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>decision_3(data, decision = "a")
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="decision_3_+3A_data">data</code></td>
<td>
<p>a data frame</p>
</td></tr>
<tr><td><code id="decision_3_+3A_decision">decision</code></td>
<td>
<p>one of the following strings:
</p>

<dl>
<dt>&quot;a&quot;</dt><dd><p>do nothing; leave implausible values as-is</p>
</dd>
<dt>&quot;b&quot;</dt><dd><p>set implausible values to missing</p>
</dd>
<dt>&quot;c1&quot;</dt><dd><p>set to mean for individual's prescriptions for that drug</p>
</dd>
<dt>&quot;c2&quot;</dt><dd><p>set to mean for practice's prescriptions for that drug</p>
</dd>
<dt>&quot;c3&quot;</dt><dd><p>set to mean for populations's prescriptions for that drug</p>
</dd>
<dt>&quot;d1&quot;</dt><dd><p>set to median for individual's prescriptions for that drug</p>
</dd>
<dt>&quot;d2&quot;</dt><dd><p>set to median for practice's prescriptions for that drug</p>
</dd>
<dt>&quot;d3&quot;</dt><dd><p>set to median for population's prescriptions for that drug</p>
</dd>
<dt>&quot;e1&quot;</dt><dd><p>set to mode for individual's prescriptions for that drug</p>
</dd>
<dt>&quot;e2&quot;</dt><dd><p>set to mode for practice's prescriptions for that drug</p>
</dd>
<dt>&quot;e3&quot;</dt><dd><p>set to mode for population's prescriptions for that drug</p>
</dd>
<dt>&quot;f1&quot;</dt><dd><p>use value of individual's next prescription</p>
</dd>
<dt>&quot;f2&quot;</dt><dd><p>use value of practice's next prescription</p>
</dd>
<dt>&quot;f3&quot;</dt><dd><p>use value of population's next prescription</p>
</dd>
<dt>&quot;g1&quot;</dt><dd><p>use value of individual's previous prescription</p>
</dd>
<dt>&quot;g2&quot;</dt><dd><p>use value of practice's previous prescription</p>
</dd>
<dt>&quot;g3&quot;</dt><dd><p>use value of population's previous prescription</p>
</dd>
</dl>
</td></tr>
</table>


<h3>Note</h3>

<p>Decisions <code>f</code> and <code>g</code> are not yet implemented.
</p>


<h3>See Also</h3>

<p>Other decision functions: 
<code><a href="#topic+decision_10">decision_10</a>()</code>,
<code><a href="#topic+decision_1">decision_1</a>()</code>,
<code><a href="#topic+decision_2">decision_2</a>()</code>,
<code><a href="#topic+decision_4">decision_4</a>()</code>,
<code><a href="#topic+decision_5">decision_5</a>()</code>,
<code><a href="#topic+decision_6">decision_6</a>()</code>,
<code><a href="#topic+decision_7">decision_7</a>()</code>,
<code><a href="#topic+decision_8">decision_8</a>()</code>,
<code><a href="#topic+decision_9">decision_9</a>()</code>,
<code><a href="#topic+drug_prep">drug_prep</a>()</code>
</p>

<hr>
<h2 id='decision_4'>Decision 4: impute missing daily doses</h2><span id='topic+decision_4'></span>

<h3>Description</h3>

<p>A light wrapper around <code><a href="#topic+impute_ndd">impute_ndd</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>decision_4(data, decision = "a")
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="decision_4_+3A_data">data</code></td>
<td>
<p>a data frame</p>
</td></tr>
<tr><td><code id="decision_4_+3A_decision">decision</code></td>
<td>
<p>one of the following strings:
</p>

<dl>
<dt>&quot;a&quot;</dt><dd><p>Leave as missing (implicitly drop this prescription)</p>
</dd>
<dt>&quot;b1&quot;</dt><dd><p>set to mean for individual's prescriptions for that drug</p>
</dd>
<dt>&quot;b2&quot;</dt><dd><p>set to mean for practice's prescriptions for that drug</p>
</dd>
<dt>&quot;b3&quot;</dt><dd><p>set to mean for populations's prescriptions for that drug</p>
</dd>
<dt>&quot;c1&quot;</dt><dd><p>set to median for individual's prescriptions for that drug</p>
</dd>
<dt>&quot;c2&quot;</dt><dd><p>set to median for practice's prescriptions for that drug</p>
</dd>
<dt>&quot;c3&quot;</dt><dd><p>set to median for population's prescriptions for that drug</p>
</dd>
<dt>&quot;d1&quot;</dt><dd><p>set to mode for individual's prescriptions for that drug</p>
</dd>
<dt>&quot;d2&quot;</dt><dd><p>set to mode for practice's prescriptions for that drug</p>
</dd>
<dt>&quot;d3&quot;</dt><dd><p>set to mode for population's prescriptions for that drug</p>
</dd>
<dt>&quot;e1&quot;</dt><dd><p>use value of individual's next prescription</p>
</dd>
<dt>&quot;e2&quot;</dt><dd><p>use value of practice's next prescription</p>
</dd>
<dt>&quot;e3&quot;</dt><dd><p>use value of population's next prescription</p>
</dd>
<dt>&quot;f1&quot;</dt><dd><p>use value of individual's previous prescription</p>
</dd>
<dt>&quot;f2&quot;</dt><dd><p>use value of practice's previous prescription</p>
</dd>
<dt>&quot;f3&quot;</dt><dd><p>use value of population's previous prescription</p>
</dd>
</dl>
</td></tr>
</table>


<h3>Note</h3>

<p>Decisions <code>e</code> and <code>f</code> are not yet implemented.
</p>


<h3>See Also</h3>

<p>Other decision functions: 
<code><a href="#topic+decision_10">decision_10</a>()</code>,
<code><a href="#topic+decision_1">decision_1</a>()</code>,
<code><a href="#topic+decision_2">decision_2</a>()</code>,
<code><a href="#topic+decision_3">decision_3</a>()</code>,
<code><a href="#topic+decision_5">decision_5</a>()</code>,
<code><a href="#topic+decision_6">decision_6</a>()</code>,
<code><a href="#topic+decision_7">decision_7</a>()</code>,
<code><a href="#topic+decision_8">decision_8</a>()</code>,
<code><a href="#topic+decision_9">decision_9</a>()</code>,
<code><a href="#topic+drug_prep">drug_prep</a>()</code>
</p>

<hr>
<h2 id='decision_5'>Decision 5: impute implausible prescription durations</h2><span id='topic+decision_5'></span>

<h3>Description</h3>

<p>A light wrapper around <code><a href="#topic+clean_duration">clean_duration</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>decision_5(data, decision = "a")
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="decision_5_+3A_data">data</code></td>
<td>
<p>a data frame</p>
</td></tr>
<tr><td><code id="decision_5_+3A_decision">decision</code></td>
<td>
<p>one of the following strings:
</p>

<dl>
<dt>&quot;a&quot;</dt><dd><p>leave duration as-is</p>
</dd>
<dt>&quot;b_6&quot;</dt><dd><p>set to missing if &gt; 6 months</p>
</dd>
<dt>&quot;b_12&quot;</dt><dd><p>set to missing if &gt; 12 months</p>
</dd>
<dt>&quot;b_24&quot;</dt><dd><p>set to missing if &gt; 24 months</p>
</dd>
<dt>&quot;c_6&quot;</dt><dd><p>set to 6 months if &gt; 6 months</p>
</dd>
<dt>&quot;c_12&quot;</dt><dd><p>set to 12 months if &gt; 12 months</p>
</dd>
<dt>&quot;c_24&quot;</dt><dd><p>set to 24 months if &gt; 24 months</p>
</dd>
</dl>
</td></tr>
</table>


<h3>See Also</h3>

<p>Other decision functions: 
<code><a href="#topic+decision_10">decision_10</a>()</code>,
<code><a href="#topic+decision_1">decision_1</a>()</code>,
<code><a href="#topic+decision_2">decision_2</a>()</code>,
<code><a href="#topic+decision_3">decision_3</a>()</code>,
<code><a href="#topic+decision_4">decision_4</a>()</code>,
<code><a href="#topic+decision_6">decision_6</a>()</code>,
<code><a href="#topic+decision_7">decision_7</a>()</code>,
<code><a href="#topic+decision_8">decision_8</a>()</code>,
<code><a href="#topic+decision_9">decision_9</a>()</code>,
<code><a href="#topic+drug_prep">drug_prep</a>()</code>
</p>

<hr>
<h2 id='decision_6'>Decision 6: choose method of calculating prescription duration</h2><span id='topic+decision_6'></span>

<h3>Description</h3>

<p>This is just shorthand for defining a column equal to one of the specified
formulae. If the column(s) corresponding to <code>decision</code> are missing, an
error will be thrown.
If you have already calculated or obtained the column <code>duration</code> from
elsewhere, this step is not necessary.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>decision_6(data, decision = "c")
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="decision_6_+3A_data">data</code></td>
<td>
<p>a data frame</p>
</td></tr>
<tr><td><code id="decision_6_+3A_decision">decision</code></td>
<td>
<p>one of the following strings:
</p>

<dl>
<dt>&quot;a&quot;</dt><dd><p><code>numdays</code></p>
</dd>
<dt>&quot;b&quot;</dt><dd><p><code>dose_duration</code></p>
</dd>
<dt>&quot;c&quot;</dt><dd><p><code>qty / ndd</code></p>
</dd>
</dl>
</td></tr>
</table>


<h3>Note</h3>

<p>This step actually takes place <em>before</em> <code><a href="#topic+decision_5">decision_5</a></code>.
</p>


<h3>See Also</h3>

<p>Other decision functions: 
<code><a href="#topic+decision_10">decision_10</a>()</code>,
<code><a href="#topic+decision_1">decision_1</a>()</code>,
<code><a href="#topic+decision_2">decision_2</a>()</code>,
<code><a href="#topic+decision_3">decision_3</a>()</code>,
<code><a href="#topic+decision_4">decision_4</a>()</code>,
<code><a href="#topic+decision_5">decision_5</a>()</code>,
<code><a href="#topic+decision_7">decision_7</a>()</code>,
<code><a href="#topic+decision_8">decision_8</a>()</code>,
<code><a href="#topic+decision_9">decision_9</a>()</code>,
<code><a href="#topic+drug_prep">drug_prep</a>()</code>
</p>

<hr>
<h2 id='decision_7'>Decision 7: impute missing prescription durations</h2><span id='topic+decision_7'></span>

<h3>Description</h3>

<p>A light wrapper around <code><a href="#topic+impute_duration">impute_duration</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>decision_7(data, decision = "a")
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="decision_7_+3A_data">data</code></td>
<td>
<p>a data frame</p>
</td></tr>
<tr><td><code id="decision_7_+3A_decision">decision</code></td>
<td>
<p>one  of the following strings:
</p>

<dl>
<dt>&quot;a&quot;</dt><dd><p>Leave missing durations as-is (implicitly drop the prescription)</p>
</dd>
<dt>&quot;b&quot;</dt><dd><p>Use mean prescription duration for that drug, for that individual</p>
</dd>
<dt>&quot;c&quot;</dt><dd><p>Use mean prescription duration for that drug, for the population</p>
</dd>
<dt>&quot;d&quot;</dt><dd><p>Use individual mean duration; if not available use population mean</p>
</dd>
</dl>
</td></tr>
</table>


<h3>See Also</h3>

<p>Other decision functions: 
<code><a href="#topic+decision_10">decision_10</a>()</code>,
<code><a href="#topic+decision_1">decision_1</a>()</code>,
<code><a href="#topic+decision_2">decision_2</a>()</code>,
<code><a href="#topic+decision_3">decision_3</a>()</code>,
<code><a href="#topic+decision_4">decision_4</a>()</code>,
<code><a href="#topic+decision_5">decision_5</a>()</code>,
<code><a href="#topic+decision_6">decision_6</a>()</code>,
<code><a href="#topic+decision_8">decision_8</a>()</code>,
<code><a href="#topic+decision_9">decision_9</a>()</code>,
<code><a href="#topic+drug_prep">drug_prep</a>()</code>
</p>

<hr>
<h2 id='decision_8'>Decision 8: disambiguate prescriptions with the same start date</h2><span id='topic+decision_8'></span>

<h3>Description</h3>

<p>A light wrapper around <code><a href="#topic+impute_duration">impute_duration</a></code>, followed by removing
duplicate rows with the same combination of <code>prodcode</code>, <code>patid</code>
and <code>start_date</code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>decision_8(data, decision = "a")
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="decision_8_+3A_data">data</code></td>
<td>
<p>a data frame</p>
</td></tr>
<tr><td><code id="decision_8_+3A_decision">decision</code></td>
<td>
<p>one of the following strings
</p>

<dl>
<dt>&quot;a&quot;</dt><dd><p>do nothing</p>
</dd>
<dt>&quot;b&quot;</dt><dd><p>replace with a prescription of duration equal to the mean</p>
</dd>
<dt>&quot;c&quot;</dt><dd><p>choose the shortest prescription</p>
</dd>
<dt>&quot;d&quot;</dt><dd><p>choose longest prescription</p>
</dd>
<dt>&quot;e&quot;</dt><dd><p>replace with a prescription of duration equal to the sum</p>
</dd>
</dl>
</td></tr>
</table>


<h3>See Also</h3>

<p>Other decision functions: 
<code><a href="#topic+decision_10">decision_10</a>()</code>,
<code><a href="#topic+decision_1">decision_1</a>()</code>,
<code><a href="#topic+decision_2">decision_2</a>()</code>,
<code><a href="#topic+decision_3">decision_3</a>()</code>,
<code><a href="#topic+decision_4">decision_4</a>()</code>,
<code><a href="#topic+decision_5">decision_5</a>()</code>,
<code><a href="#topic+decision_6">decision_6</a>()</code>,
<code><a href="#topic+decision_7">decision_7</a>()</code>,
<code><a href="#topic+decision_9">decision_9</a>()</code>,
<code><a href="#topic+drug_prep">drug_prep</a>()</code>
</p>

<hr>
<h2 id='decision_9'>Decision 9: handle overlapping prescription periods</h2><span id='topic+decision_9'></span>

<h3>Description</h3>

<p>In situations where one prescription starts before another (for the same
patient and drug) finishes, this function will either implicitly sum the
doses (i.e. do nothing) or it will divide the intervals into non-overlapping
subsets, shifting these sub-intervals forward in time until there is no
overlap.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>decision_9(data, decision = "a")
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="decision_9_+3A_data">data</code></td>
<td>
<p>a data frame</p>
</td></tr>
<tr><td><code id="decision_9_+3A_decision">decision</code></td>
<td>
<p>one of the following strings:
</p>

<dl>
<dt>&quot;a&quot;</dt><dd><p>allow overlapping prescriptions (implicitly sum doses)</p>
</dd>
<dt>&quot;b&quot;</dt><dd><p>move later prescription to next available time that this product is not prescribed</p>
</dd>
</dl>
</td></tr>
</table>


<h3>Details</h3>

<p>The underlying algorithm for shifting overlapping intervals is implemented
by the internal function <code>shift_interval</code>.
</p>


<h3>See Also</h3>

<p>Other decision functions: 
<code><a href="#topic+decision_10">decision_10</a>()</code>,
<code><a href="#topic+decision_1">decision_1</a>()</code>,
<code><a href="#topic+decision_2">decision_2</a>()</code>,
<code><a href="#topic+decision_3">decision_3</a>()</code>,
<code><a href="#topic+decision_4">decision_4</a>()</code>,
<code><a href="#topic+decision_5">decision_5</a>()</code>,
<code><a href="#topic+decision_6">decision_6</a>()</code>,
<code><a href="#topic+decision_7">decision_7</a>()</code>,
<code><a href="#topic+decision_8">decision_8</a>()</code>,
<code><a href="#topic+drug_prep">drug_prep</a>()</code>
</p>

<hr>
<h2 id='drug_prep'>Run drug preparation algorithm</h2><span id='topic+drug_prep'></span>

<h3>Description</h3>

<p>Run drug preparation algorithm
</p>


<h3>Usage</h3>

<pre><code class='language-R'>drug_prep(data, plausible_values, decisions = rep("a", 10))
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="drug_prep_+3A_data">data</code></td>
<td>
<p>data frame containing prescription data</p>
</td></tr>
<tr><td><code id="drug_prep_+3A_plausible_values">plausible_values</code></td>
<td>
<p>data frame containing variables <code>prodcode</code>,
<code>min_qty</code>, <code>max_qty</code>, <code>min_ndd</code>, <code>max_ndd</code> describing
plausible ranges for values for each drug</p>
</td></tr>
<tr><td><code id="drug_prep_+3A_decisions">decisions</code></td>
<td>
<p>character vector of length 10</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame including estimated <code>stop_date</code> for each prescription
</p>


<h3>See Also</h3>

<p>Other decision functions: 
<code><a href="#topic+decision_10">decision_10</a>()</code>,
<code><a href="#topic+decision_1">decision_1</a>()</code>,
<code><a href="#topic+decision_2">decision_2</a>()</code>,
<code><a href="#topic+decision_3">decision_3</a>()</code>,
<code><a href="#topic+decision_4">decision_4</a>()</code>,
<code><a href="#topic+decision_5">decision_5</a>()</code>,
<code><a href="#topic+decision_6">decision_6</a>()</code>,
<code><a href="#topic+decision_7">decision_7</a>()</code>,
<code><a href="#topic+decision_8">decision_8</a>()</code>,
<code><a href="#topic+decision_9">decision_9</a>()</code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>plausible_values &lt;- data.frame(
  prodcode = c('a', 'b', 'c'),
  min_qty = 0,
  max_qty = c(50, 100, 200),
  min_ndd = 0,
  max_ndd = c(10, 20, 30)
)
drug_prep(example_therapy,
          plausible_values,
          decisions = c('a', 'a', 'a', 'a', 'a',
                        'c', 'a', 'a', 'a', 'a'))

</code></pre>

<hr>
<h2 id='example_therapy'>Example electronic prescription dataset</h2><span id='topic+example_therapy'></span>

<h3>Description</h3>

<p>Based on a hypothetical 'therapy' file from the Clinical Practical Research
Datalink (CPRD), a UK database of primary care records.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>example_therapy
</code></pre>


<h3>Format</h3>

<p>An object of class <code>data.frame</code> with 30 rows and 6 columns.
</p>


<h3>Note</h3>

<p>This dataset is now generated deterministically, so it will not vary
between sessions.
</p>

<hr>
<h2 id='get_mode'>Get the mode (most common value) of a vector</h2><span id='topic+get_mode'></span>

<h3>Description</h3>

<p>Get the mode (most common value) of a vector
</p>


<h3>Usage</h3>

<pre><code class='language-R'>get_mode(v, na.rm = TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="get_mode_+3A_v">v</code></td>
<td>
<p>a vector</p>
</td></tr>
<tr><td><code id="get_mode_+3A_na.rm">na.rm</code></td>
<td>
<p>Logical. If <code>TRUE</code> (the default), find mode of non-<code>NA</code> values</p>
</td></tr>
</table>

<hr>
<h2 id='impute'>Impute missing or implausible values</h2><span id='topic+impute'></span>

<h3>Description</h3>

<p>This is a workhorse function used by <code><a href="#topic+impute_ndd">impute_ndd</a></code>,
<code><a href="#topic+impute_qty">impute_qty</a></code> and others.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>impute(
  data,
  variable,
  method = c("ignore", "mean", "median", "mode", "replace", "min", "max", "sum"),
  where = is.na,
  group,
  ...,
  replace_with = NA_real_
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="impute_+3A_data">data</code></td>
<td>
<p>A data frame containing columns <code>prodcode</code>, <code>pracid</code>, <code>patid</code></p>
</td></tr>
<tr><td><code id="impute_+3A_variable">variable</code></td>
<td>
<p>Unquoted name of the column in <code>dataset</code> to be imputed</p>
</td></tr>
<tr><td><code id="impute_+3A_method">method</code></td>
<td>
<p>Method for imputing the values. See details.</p>
</td></tr>
<tr><td><code id="impute_+3A_where">where</code></td>
<td>
<p>Logical vector, or function applied to <code>variable</code> returning such a vector, indicating which elements to impute. Defaults to <code><a href="base.html#topic+NA">is.na</a></code></p>
</td></tr>
<tr><td><code id="impute_+3A_group">group</code></td>
<td>
<p>Level of structure for imputation. Defaults to whole study population.</p>
</td></tr>
<tr><td><code id="impute_+3A_...">...</code></td>
<td>
<p>Extra arguments, currently ignored</p>
</td></tr>
<tr><td><code id="impute_+3A_replace_with">replace_with</code></td>
<td>
<p>if the method 'replace' is selected, which value should be inserted?
</p>

<ul>
<li> <p><code>ignore</code>. Do nothing, leaving input unchanged.
</p>
</li>
<li> <p><code>mean</code>. Replace values with the mean by <code>group</code>
</p>
</li>
<li> <p><code>median</code>. Replace values with the median by <code>group</code>
</p>
</li>
<li> <p><code>mode</code>. Replace values with the most common value by <code>group</code>
</p>
</li>
<li> <p><code>replace</code>. Replace values with <code>replace_with</code>, which defaults to <code>NA</code> (i.e. mark as missing)
</p>
</li>
<li> <p><code>min</code>. Replace with minimum value.
</p>
</li>
<li> <p><code>max</code>. Replace with maximum value.
</p>
</li>
<li> <p><code>sum</code>. Replace with sum of values.
</p>
</li></ul>
</td></tr>
</table>


<h3>Details</h3>

<p>The argument <code>where</code> indicates which values are to be imputed.
It can be specified as either a vector or as a function. Thus you can
specify, for example, <code><a href="Matrix.html#topic+is.na">is.na</a></code> to impute all missing values, or
you can pass in a vector, if it depends on something else rather than just
the current values of the variable to imputed.
This design may change in future. In particular, if we want to impute
implausible values and impute missing values separately, it's important that
these steps are independent.
</p>


<h3>Value</h3>

<p>A data frame of the same structure as <code>data</code>, with values imputed
</p>

<hr>
<h2 id='impute_duration'>Replace missing or implausible prescription durations</h2><span id='topic+impute_duration'></span>

<h3>Description</h3>

<p>Instead of replacing missing stop dates, we impute the durations and then
infer the stop dates from there.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>impute_duration(
  data,
  method,
  where = is.na,
  group = c("patid", "start_date"),
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="impute_duration_+3A_data">data</code></td>
<td>
<p>A data frame containing columns <code>prodcode</code>, <code>pracid</code>, <code>patid</code></p>
</td></tr>
<tr><td><code id="impute_duration_+3A_method">method</code></td>
<td>
<p>Method for imputing the values. See details.</p>
</td></tr>
<tr><td><code id="impute_duration_+3A_where">where</code></td>
<td>
<p>Logical vector, or function applied to <code>variable</code> returning such a vector, indicating which elements to impute. Defaults to <code><a href="base.html#topic+NA">is.na</a></code></p>
</td></tr>
<tr><td><code id="impute_duration_+3A_group">group</code></td>
<td>
<p>Level of structure for imputation. Defaults to whole study population.</p>
</td></tr>
<tr><td><code id="impute_duration_+3A_...">...</code></td>
<td>
<p>Extra arguments, currently ignored</p>
</td></tr>
</table>


<h3>Details</h3>

<p>We can fix clashing start dates by setting <code>group</code> to <code>start_date</code>
and <code>patid</code>, i.e. average over groups with more than one member;
any metric should return the original values if the group size is one.
</p>


<h3>Value</h3>

<p>A data frame of the same structure as <code>data</code>, with values imputed
</p>


<h3>Examples</h3>

<pre><code class='language-R'>example_duration &lt;- transform(example_therapy, duration = qty / ndd)
impute_duration(example_duration, method = 'mean', group = 'patid')

</code></pre>

<hr>
<h2 id='impute_ndd'>Replace implausible or missing numerical daily doses (NDD)</h2><span id='topic+impute_ndd'></span>

<h3>Description</h3>

<p>Replace implausible or missing numerical daily doses (NDD)
</p>


<h3>Usage</h3>

<pre><code class='language-R'>impute_ndd(data, method, where = is.na, group = "population", ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="impute_ndd_+3A_data">data</code></td>
<td>
<p>A data frame containing columns <code>prodcode</code>, <code>pracid</code>, <code>patid</code></p>
</td></tr>
<tr><td><code id="impute_ndd_+3A_method">method</code></td>
<td>
<p>Method for imputing the values. See details.</p>
</td></tr>
<tr><td><code id="impute_ndd_+3A_where">where</code></td>
<td>
<p>Logical vector, or function applied to <code>variable</code> returning such a vector, indicating which elements to impute. Defaults to <code><a href="base.html#topic+NA">is.na</a></code></p>
</td></tr>
<tr><td><code id="impute_ndd_+3A_group">group</code></td>
<td>
<p>Level of structure for imputation. Defaults to whole study population.</p>
</td></tr>
<tr><td><code id="impute_ndd_+3A_...">...</code></td>
<td>
<p>Extra arguments, currently ignored</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame of the same structure as <code>data</code>, with values imputed
</p>


<h3>Examples</h3>

<pre><code class='language-R'>impute_ndd(example_therapy, 'mean')

</code></pre>

<hr>
<h2 id='impute_qty'>Find implausible entries
Replace implausible or missing prescription quantities</h2><span id='topic+impute_qty'></span>

<h3>Description</h3>

<p>Find implausible entries
Replace implausible or missing prescription quantities
</p>


<h3>Usage</h3>

<pre><code class='language-R'>impute_qty(data, method, where = is.na, group = "population", ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="impute_qty_+3A_data">data</code></td>
<td>
<p>A data frame containing columns <code>prodcode</code>, <code>pracid</code>, <code>patid</code></p>
</td></tr>
<tr><td><code id="impute_qty_+3A_method">method</code></td>
<td>
<p>Method for imputing the values. See details.</p>
</td></tr>
<tr><td><code id="impute_qty_+3A_where">where</code></td>
<td>
<p>Logical vector, or function applied to <code>variable</code> returning such a vector, indicating which elements to impute. Defaults to <code><a href="base.html#topic+NA">is.na</a></code></p>
</td></tr>
<tr><td><code id="impute_qty_+3A_group">group</code></td>
<td>
<p>Level of structure for imputation. Defaults to whole study population.</p>
</td></tr>
<tr><td><code id="impute_qty_+3A_...">...</code></td>
<td>
<p>Extra arguments, currently ignored</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame of the same structure as <code>data</code>, with values imputed
</p>


<h3>Examples</h3>

<pre><code class='language-R'>impute_qty(example_therapy, 'mean')

</code></pre>

<hr>
<h2 id='isolate_overlaps'>Separating overlapping prescription periods</h2><span id='topic+isolate_overlaps'></span>

<h3>Description</h3>

<p>Run this function and then you can either simply discard overlapping
intervals or shift them around using an appropriate algorithm.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>isolate_overlaps(data)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="isolate_overlaps_+3A_data">data</code></td>
<td>
<p>A data frame including variables <code>patid</code>, <code>start_date</code>,
<code>stop_date</code> and <code>prodcode</code></p>
</td></tr>
</table>


<h3>Details</h3>

<p>The older implementation used <code>isolateoverlaps</code> from the
<code>intervalaverage</code> package and <code>Overlap</code> from the <code>DescTools</code>
package. Here we refactor it using functions from <code>tidyverse</code> instead.
</p>


<h3>Value</h3>

<p>A data frame of <code>patid</code>, <code>prodcode</code>, <code>start_date</code> and
<code>stop_date</code>, where intervals are either exactly overlapping or mutually
non-overlapping (but not partially overlapping), such that the union of such
intervals is equivalent to those originally provided in <code>data</code>
</p>


<h3>Note</h3>

<p>This function currently doesn't use any keys except <code>patid</code> and
<code>prodcode</code>. It may be desirable to add a row ID, for matching each
partial interval back to the original interval from which it was derived.
This may be relevant to models using weighted dosages.
</p>


<h3>See Also</h3>

<p><code>intervalaverage::isolateoverlaps</code>,
<code><a href="data.table.html#topic+foverlaps">foverlaps</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>set.seed(1)
overlapping_data &lt;- data.frame(
  rowid = 1:20,
  patid = 1:2,
  prodcode = 'a',
  start_date = Sys.Date() + c(round(rexp(19, 1/7)), -20),
  qty = rpois(20, 64),
  ndd = sample(seq(.5, 12, by = .5), 20, replace = TRUE),
  stringsAsFactors = FALSE
)
overlapping_data &lt;- transform(overlapping_data,
  stop_date = start_date + qty / ndd
)
isolate_overlaps(overlapping_data)

</code></pre>

<hr>
<h2 id='make_decisions'>Human-friendly interface to the drug prep algorithm</h2><span id='topic+make_decisions'></span>

<h3>Description</h3>

<p>A helper function that allows specifying decision rules using English
words rather than alphanumeric codes. Translates the rules into the
corresponding codes and then passes them to <code><a href="#topic+drug_prep">drug_prep</a></code> functions.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>make_decisions(
  implausible_qty,
  missing_qty,
  implausible_ndd,
  missing_ndd,
  implausible_duration,
  calculate_duration,
  missing_duration,
  clash_start,
  overlapping,
  small_gaps
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="make_decisions_+3A_implausible_qty">implausible_qty</code></td>
<td>
<p>implausible total drug quantities</p>
</td></tr>
<tr><td><code id="make_decisions_+3A_missing_qty">missing_qty</code></td>
<td>
<p>missing total drug quantities</p>
</td></tr>
<tr><td><code id="make_decisions_+3A_implausible_ndd">implausible_ndd</code></td>
<td>
<p>implausible daily dosage</p>
</td></tr>
<tr><td><code id="make_decisions_+3A_missing_ndd">missing_ndd</code></td>
<td>
<p>missing daily dosage</p>
</td></tr>
<tr><td><code id="make_decisions_+3A_implausible_duration">implausible_duration</code></td>
<td>
<p>overly-long prescription durations</p>
</td></tr>
<tr><td><code id="make_decisions_+3A_calculate_duration">calculate_duration</code></td>
<td>
<p>formula or variable to compute prescription duration</p>
</td></tr>
<tr><td><code id="make_decisions_+3A_missing_duration">missing_duration</code></td>
<td>
<p>missing prescription duration</p>
</td></tr>
<tr><td><code id="make_decisions_+3A_clash_start">clash_start</code></td>
<td>
<p>how to disambiguate prescriptions that start on the same date</p>
</td></tr>
<tr><td><code id="make_decisions_+3A_overlapping">overlapping</code></td>
<td>
<p>how to handle prescription periods that overlap with one another</p>
</td></tr>
<tr><td><code id="make_decisions_+3A_small_gaps">small_gaps</code></td>
<td>
<p>how to handle short gaps between successive prescriptions
</p>
<p>The argument <code>decision_phrases</code> may contain the following terms (without brackets, separated with spaces).
Additional or incorrectly-named elements will be ignored.
</p>

<dl>
<dt>implausible_qty</dt><dd><p>(ignore|missing|mean|median|mode|next|previous) (individual|practice|population)</p>
</dd>
<dt>implausible_ndd</dt><dd><p>(ignore|missing|mean|median|mode|next|previous) (individual|practice|population)</p>
</dd>
<dt>implausible_duration</dt><dd><p>(ignore|missing|truncate) (6|12|24)</p>
</dd>
<dt>missing_qty</dt><dd><p>(ignore|mean|median|mode|next|previous) (individual|practice|population)</p>
</dd>
<dt>missing_ndd</dt><dd><p>(ignore|mean|median|mode|next|previous) (individual|practice|population)</p>
</dd>
<dt>missing_duration</dt><dd><p>(ignore|mean) (individual|population|both)</p>
</dd>
<dt>calculate_duration</dt><dd><p>(numdays|dose_duration|qty/ndd)</p>
</dd>
<dt>clash_start</dt><dd><p>(ignore|mean|shortest|longest|sum)</p>
</dd>
<dt>overlapping</dt><dd><p>(allow|shift)</p>
</dd>
<dt>small_gaps</dt><dd><p>(ignore|close) (15|30|60)</p>
</dd>
</dl>
</td></tr>
</table>


<h3>Value</h3>

<p>A character vector suitable for passing to the <code>decisions</code> argument of
the <code><a href="#topic+drug_prep">drug_prep</a></code> function.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>make_decisions('ignore',
               'mean population',
               'missing',
               'mean practice',
               'truncate 6',
               'qty / ndd',
               'mean individual',
               'mean',
               'allow',
               'close 15')

</code></pre>

<hr>
<h2 id='min_max_dat'>Example min-max data.</h2><span id='topic+min_max_dat'></span>

<h3>Description</h3>

<p>A dataset containing minimum and maximum possible values for quantity and
number of daily dose for given prescription.
The dataset is hypothetical.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>min_max_dat
</code></pre>


<h3>Format</h3>

<p>A data frame with 2 rows and 5 variables:
</p>

<dl>
<dt>prodcode</dt><dd><p>CPRD unique code for the treatment selected by the GP</p>
</dd>
<dt>max_qty</dt><dd><p>maximum possible quantity to be prescribed for the product</p>
</dd>
<dt>min_qty</dt><dd><p>minimum possible quantity to be prescribed for the product</p>
</dd>
<dt>max_ndd</dt><dd><p>maximum possible number of daily dose to be prescribed for the product</p>
</dd>
<dt>min_ndd</dt><dd><p>minimum possible number of daily dose  to be prescribed for the product</p>
</dd>
</dl>
<p>...

</p>

<hr>
<h2 id='outside_range'>Do values fall outside a specified 'plausible' range?</h2><span id='topic+outside_range'></span>

<h3>Description</h3>

<p>A utility function for indicating if elements of a vector are implausible.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>outside_range(x, lower, upper, open = TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="outside_range_+3A_x">x</code></td>
<td>
<p>numeric vector</p>
</td></tr>
<tr><td><code id="outside_range_+3A_lower">lower</code></td>
<td>
<p>minimum plausible value</p>
</td></tr>
<tr><td><code id="outside_range_+3A_upper">upper</code></td>
<td>
<p>maximum plausible value</p>
</td></tr>
<tr><td><code id="outside_range_+3A_open">open</code></td>
<td>
<p>logical. If <code>TRUE</code>, values exactly equal to <code>lower</code> or <code>upper</code> are also considered implausible</p>
</td></tr>
</table>


<h3>Details</h3>

<p>Though the function <code><a href="dplyr.html#topic+between">between</a></code> already exists, it is not vectorised over the bounds.
</p>

<hr>
<h2 id='shift_interval'>Shift time intervals until they no longer overlap</h2><span id='topic+shift_interval'></span>

<h3>Description</h3>

<p>This is a function used by <code><a href="#topic+decision_9">decision_9</a></code>.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>shift_interval(x)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="shift_interval_+3A_x">x</code></td>
<td>
<p>a data frame containing variables <code>start_date</code>,
<code>stop_date</code> and <code>patid</code></p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame with time intervals moved such that they no longer overlap
</p>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
