<!DOCTYPE html><html><head><title>Help for package R.matlab</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {R.matlab}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#1. The MATLAB server running in MATLAB'><p>1. The MATLAB server running in MATLAB</p></a></li>
<li><a href='#as.character.Matlab'><p>Gets a string describing the current MATLAB connection</p></a></li>
<li><a href='#close.Matlab'><p>Closes connection to MATLAB server</p></a></li>
<li><a href='#evaluate.Matlab'><p>Evaluates a MATLAB expression</p></a></li>
<li><a href='#finalize.Matlab'><p>(internal) Finalizes the object if deleted</p></a></li>
<li><a href='#getOption.Matlab'><p>Gets the value of an option</p></a></li>
<li><a href='#getVariable.Matlab'><p>Gets one or several MATLAB variables</p></a></li>
<li><a href='#isOpen.Matlab'><p>Checks if connection to the MATLAB server is open</p></a></li>
<li><a href='#Matlab'><p>MATLAB client for remote or local MATLAB access</p></a></li>
<li><a href='#Matlab$startServer'><p>Static method which starts a MATLAB server</p></a></li>
<li><a href='#Non-documented objects'><p>Non-documented objects</p></a></li>
<li><a href='#open.Matlab'><p>Tries to open a connection to the MATLAB server</p></a></li>
<li><a href='#R.matlab-package'><p>Package R.matlab</p></a></li>
<li><a href='#readMat'><p>Reads a MAT file structure from a connection or a file</p></a></li>
<li><a href='#readResult.Matlab'><p>(internal) Reads results from the MATLAB server</p></a></li>
<li><a href='#setFunction.Matlab'><p>Defines a MATLAB function</p></a></li>
<li><a href='#setOption.Matlab'><p>Sets the value of an option</p></a></li>
<li><a href='#setVariable.Matlab'><p>Sets one or several MATLAB variables</p></a></li>
<li><a href='#setVerbose.Matlab'><p>Sets the verbose level to get more details about the MATLAB access</p></a></li>
<li><a href='#writeCommand.Matlab'><p>(internal) Writes (sends) an R-to-MATLAB command to the MATLAB server</p></a></li>
<li><a href='#writeMat'><p>Writes a MAT file structure</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Version:</td>
<td>3.7.0</td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 2.14.0)</td>
</tr>
<tr>
<td>Imports:</td>
<td>methods, utils, R.methodsS3 (&ge; 1.7.1), R.oo (&ge; 1.23.0),
R.utils (&ge; 2.5.0)</td>
</tr>
<tr>
<td>Suggests:</td>
<td>Matrix, SparseM</td>
</tr>
<tr>
<td>Title:</td>
<td>Read and Write MAT Files and Call MATLAB from Within R</td>
</tr>
<tr>
<td>Author:</td>
<td>Henrik Bengtsson [aut, cre, cph],
  Andy Jacobson [ctb] (Internal MAT v4 reader),
  Jason Riedy [ctb] (Support for reading compressed files, sparse
    matrices and UTF-encoded strings.)</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Henrik Bengtsson &lt;henrikb@braju.com&gt;</td>
</tr>
<tr>
<td>Description:</td>
<td>Methods readMat() and writeMat() for reading and writing MAT files.  For user with MATLAB v6 or newer installed (either locally or on a remote host), the package also provides methods for controlling MATLAB (trademark) via R and sending and retrieving data between R and MATLAB.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/LGPL-2.1">LGPL-2.1</a> | <a href="https://www.r-project.org/Licenses/LGPL-3">LGPL-3</a> [expanded from: LGPL (&ge; 2.1)]</td>
</tr>
<tr>
<td>LazyLoad:</td>
<td>TRUE</td>
</tr>
<tr>
<td>ByteCompile:</td>
<td>TRUE</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://github.com/HenrikBengtsson/R.matlab">https://github.com/HenrikBengtsson/R.matlab</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/HenrikBengtsson/R.matlab/issues">https://github.com/HenrikBengtsson/R.matlab/issues</a></td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2022-08-25 21:09:53 UTC; hb</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2022-08-25 21:52:34 UTC</td>
</tr>
</table>
<hr>
<h2 id='1.+20The+20MATLAB+20server+20running+20in+20MATLAB'>1. The MATLAB server running in MATLAB</h2><span id='topic+1.+20The+20MATLAB+20server+20running+20in+20MATLAB'></span>

<h3>Description</h3>

<p>This section gives addition details on the MATLAB server.
At the end, the MatlabServer.m script and the
InputStreamByteWrapper.java code is shown.
</p>


<h3>Starting the MATLAB server on Windows</h3>

<p>Note that you &quot;cannot prevent MATLAB from creating a window when
starting on Windows systems, but you can force the window to be hidden,
by using &quot; the option -minimize.
See <a href="https://www.mathworks.com/matlabcentral/answers/102082">https://www.mathworks.com/matlabcentral/answers/102082</a>
for more information.
</p>


<h3>MatlabServer.m script</h3>

<pre>
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% MatlabServer
%
% This scripts starts a minimalistic MATLAB "server".
%
% When started, the server listens for connections at port 9999 or the
% port number specified by the environment variable 'MATLABSERVER_PORT'.
%
% Troubleshooting: If not working out of the box, add this will to the
% MATLAB path. Make sure InputStreamByteWrapper.class is in the same
% directory as this file!
%
% Requirements:
% This requires MATLAB with Java support, i.e. MATLAB v6 or higher.
%
% Author: Henrik Bengtsson, 2002-2016
%
% References:
% [1] http://www.mathworks.com/access/helpdesk/help/techdoc/
%                                     matlab_external/ch_jav34.shtml#49439
% [2] http://staff.science.uva.nl/~horus/dox/horus2.0/user/
%                                                  html/n_installUnix.html
% [3] http://www.mathworks.com/access/helpdesk/help/toolbox/
%                                              modelsim/a1057689278b4.html
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
fprintf(2, 'Running MatlabServer v3.5.9-9000\n');

%  addpath R/R_LIBS/linux/library/R.matlab/misc/

% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
% MATLAB version-dependent setup
% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
% Identify major version of Matlab
MatlabServer_tmp_hasMajor = eval('length(regexp(version, ''^[0-9]'')) ~= 0', '0');
if (MatlabServer_tmp_hasMajor)
  MatlabServer_tmp_verParts = sscanf(version, '%d.');
  MatlabServer_tmp_verMajor = MatlabServer_tmp_verParts(1);
  clear MatlabServer_tmp_verParts;
else
  MatlabServer_tmp_verMajor = -1;
end
clear MatlabServer_tmp_hasMajor;

if (MatlabServer_tmp_verMajor &lt; 6)
  % Java is not available/supported
  error('MATLAB v5.x and below is not supported.');
elseif (MatlabServer_tmp_verMajor == 6)
  fprintf(2, 'MATLAB v6.x detected.\n');
  % Default save option
  MatlabServer_saveOption = '';
  % In MATLAB v6 only the static Java CLASSPATH is supported. It is
  % specified by a 'classpath.txt' file. The default one can be found
  % by which('classpath.txt'). If a 'classpath.txt' exists in the
  % current(!) directory (that MATLAB is started from), it *replaces*
  % the global one. Thus, it is not possible to add additional paths;
  % the global ones has to be copied to the local 'classpath.txt' file.
  %
  % To do the above automatically from R, does not seem to be an option.
else
  fprintf(2, 'MATLAB v7.x or higher detected.\n');
  % MATLAB v7 and above saves compressed files, which is not recognized
  % by R.matlab's readMat(); force saving in old format.
  MatlabServer_saveOption = '-V6';
  fprintf(2, 'Saving with option -V6.\n');

  % In MATLAB v7 and above both static and dynamic Java CLASSPATH:s exist.
  % Using dynamic ones, it is possible to add the file
  % InputStreamByteWrapper.class to CLASSPATH, given it is
  % in the same directory as this script.
  javaaddpath({fileparts(which('MatlabServer'))});
  fprintf(2, 'Added InputStreamByteWrapper to dynamic Java CLASSPATH.\n');
end
clear MatlabServer_tmp_verMajor;


% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
% Import Java classes
% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
import java.io.*;
import java.net.*;


% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
% If an old MATLAB server is running, close it
% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
% If a server object exists from a previous run, close it.
if (exist('MatlabServer_server'))
  close(MatlabServer_server);
  clear MatlabServer_server;
end

% If an input stream exists from a previous run, close it.
if (exist('MatlabServer_is'))
  close(MatlabServer_is);
  clear MatlabServer_is;
end

% If an output stream exists from a previous run, close it.
if (exist('MatlabServer_os'))
  close(MatlabServer_os);
  clear MatlabServer_os;
end

fprintf(2, '----------------------\n');
fprintf(2, 'MATLAB server started!\n');
fprintf(2, '----------------------\n');

fprintf(2, 'MATLAB working directory: %s\n', pwd);


% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
% Initiate server socket to which clients may connect
% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
MatlabServer_port = getenv('MATLABSERVER_PORT');
if (length(MatlabServer_port) &gt; 0)
  MatlabServer_port = str2num(MatlabServer_port);
else
  % Try to open a server socket on port 9999
  MatlabServer_port = 9999;
end

% Ports 1-1023 are reserved for the Internet Assigned Numbers Authority.
% Ports 49152-65535 are dynamic ports for the OS. [3]
if (MatlabServer_port &lt; 1023 | MatlabServer_port &gt; 65535)
  error('Cannot not open connection. Port (''MATLABSERVER_PORT'') is out of range [1023,65535]: %d', MatlabServer_port);
end

fprintf(2, 'Trying to open server socket (port %d)...', MatlabServer_port);
MatlabServer_server = java.net.ServerSocket(MatlabServer_port);
fprintf(2, 'done.\n');


% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
% Wait for client to connect
% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
% Create a socket object from the ServerSocket to listen and accept
% connections.
% Open input and output streams

% Wait for the client to connect
fprintf(2, 'Waiting for client to connect (port %d)...', MatlabServer_port);
MatlabServer_clientSocket = accept(MatlabServer_server);
fprintf(2, 'connected.\n');

% ...client connected.
MatlabServer_is = java.io.DataInputStream(getInputStream(MatlabServer_clientSocket));
MatlabServer_os = java.io.DataOutputStream(getOutputStream(MatlabServer_clientSocket));



% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
% The MATLAB server state machine
% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
% Commands
MatlabServer_commands = {'eval', 'send', 'receive', 'send-remote', 'receive-remote', 'echo', 'evalc'};

MatlabServer_lasterr = [];
MatlabServer_variables = [];

% As long as we receive data, echo that data back to the client.
MatlabServer_state = 0;
while (MatlabServer_state &gt;= 0),
  if (MatlabServer_state == 0)
    MatlabServer_tmp_cmd = readByte(MatlabServer_is);
    fprintf(2, 'Received cmd: %d\n', MatlabServer_tmp_cmd);
    if (MatlabServer_tmp_cmd &lt; -1 | MatlabServer_tmp_cmd &gt; length(MatlabServer_commands))
      fprintf(2, 'Unknown command code: %d\n', MatlabServer_tmp_cmd);
    else
      MatlabServer_state = MatlabServer_tmp_cmd;
    end
    clear MatlabServer_tmp_cmd;

  %-------------------
  % 'evalc'
  %-------------------
  elseif (MatlabServer_state == strmatch('evalc', MatlabServer_commands, 'exact'))
    MatlabServer_tmp_bfr = char(readUTF(MatlabServer_is));
    fprintf(2, '"evalc" string: "%s"\n', MatlabServer_tmp_bfr);
    try
      MatlabServer_tmp_bfr = sprintf(MatlabServer_tmp_bfr);
      MatlabServer_tmp_result = evalc(MatlabServer_tmp_bfr);
      writeByte(MatlabServer_os, 0);
      fprintf(2, 'Sent byte: %d\n', 0);
      writeUTF(MatlabServer_os, MatlabServer_tmp_result);
      fprintf(2, 'Sent UTF: %s\n', MatlabServer_tmp_result);
      flush(MatlabServer_os);
      clear MatlabServer_tmp_result;
    catch
      MatlabServer_lasterr = sprintf('Failed to evaluate expression ''%s''.', MatlabServer_tmp_bfr);
      fprintf(2, 'EvaluationException: %s\n', MatlabServer_lasterr);
      writeByte(MatlabServer_os, -1);
      fprintf(2, 'Sent byte: %d\n', -1);
      writeUTF(MatlabServer_os, MatlabServer_lasterr);
      fprintf(2, 'Sent UTF: %s\n', MatlabServer_lasterr);
      flush(MatlabServer_os);
    end
    flush(MatlabServer_os);
    MatlabServer_state = 0;
    clear MatlabServer_tmp_bfr;

  %-------------------
  % 'eval'
  %-------------------
  elseif (MatlabServer_state == strmatch('eval', MatlabServer_commands, 'exact'))
    MatlabServer_tmp_bfr = char(readUTF(MatlabServer_is));
    fprintf(2, '"eval" string: "%s"\n', MatlabServer_tmp_bfr);
    try
      eval(MatlabServer_tmp_bfr);
      writeByte(MatlabServer_os, 0);
      fprintf(2, 'Sent byte: %d\n', 0);
      flush(MatlabServer_os);
    catch
      MatlabServer_lasterr = sprintf('Failed to evaluate expression ''%s''.', MatlabServer_tmp_bfr);
      fprintf(2, 'EvaluationException: %s\n', MatlabServer_lasterr);
      writeByte(MatlabServer_os, -1);
      fprintf(2, 'Sent byte: %d\n', -1);
      writeUTF(MatlabServer_os, MatlabServer_lasterr);
      fprintf(2, 'Sent UTF: %s\n', MatlabServer_lasterr);
      flush(MatlabServer_os);
    end
    flush(MatlabServer_os);
    MatlabServer_state = 0;
    clear MatlabServer_tmp_bfr;
 
  %-------------------
  % 'send'
  %-------------------
  elseif (MatlabServer_state == strmatch('send', MatlabServer_commands, 'exact'))
    MatlabServer_tmp_tmpname = sprintf('%s_%d.mat', tempname, MatlabServer_port);
    MatlabServer_tmp_expr = sprintf('save(MatlabServer_tmp_tmpname, ''%s''', MatlabServer_saveOption);
    MatlabServer_tmp_ok = 1;
    for MatlabServer_tmp_k=1:length(MatlabServer_variables),
      MatlabServer_tmp_variable = MatlabServer_variables{MatlabServer_tmp_k};
      if (exist(MatlabServer_tmp_variable) ~= 1)
        MatlabServer_lasterr = sprintf('Variable ''%s'' not found.', MatlabServer_tmp_variable);
        fprintf(2, '%s\n', MatlabServer_lasterr);
        MatlabServer_tmp_ok = 0;
        break;
      end;
      MatlabServer_tmp_expr = sprintf('%s, ''%s''', MatlabServer_tmp_expr, MatlabServer_tmp_variable);
    end;

    MatlabServer_tmp_expr = sprintf('%s)', MatlabServer_tmp_expr);
    if (~MatlabServer_tmp_ok)
      writeInt(MatlabServer_os, -1);
      writeUTF(MatlabServer_os, MatlabServer_lasterr);
    else
      fprintf(2, '%s\n', MatlabServer_tmp_expr);
      eval(MatlabServer_tmp_expr);
      writeInt(MatlabServer_os, 0); % Here anything but -1 means "success"
      writeUTF(MatlabServer_os, MatlabServer_tmp_tmpname);
    end
   
    MatlabServer_tmp_answer = readByte(MatlabServer_is);
    fprintf(2, 'answer=%d\n', MatlabServer_tmp_answer);
   
    MatlabServer_state = 0;
    clear MatlabServer_tmp_name MatlabServer_tmp_expr MatlabServer_tmp_ok MatlabServer_tmp_answer;

  %-------------------
  % 'send-remote'
  %-------------------
  elseif (MatlabServer_state == strmatch('send-remote', MatlabServer_commands, 'exact'))
    MatlabServer_tmp_tmpname = sprintf('%s_%d.mat', tempname, MatlabServer_port);
    MatlabServer_tmp_expr = sprintf('save(MatlabServer_tmp_tmpname, ''%s''', MatlabServer_saveOption);
    MatlabServer_tmp_ok = 1;
    for MatlabServer_tmp_k=1:length(MatlabServer_variables),
      MatlabServer_tmp_variable = MatlabServer_variables{MatlabServer_tmp_k};
      if (exist(MatlabServer_tmp_variable) ~= 1)
        MatlabServer_lasterr = sprintf('Variable ''%s'' not found.', MatlabServer_tmp_variable);
        fprintf(2, '%s\n', MatlabServer_lasterr);
        MatlabServer_tmp_ok = 0;
        break;
      end;
      MatlabServer_tmp_expr = sprintf('%s, ''%s''', MatlabServer_tmp_expr, MatlabServer_tmp_variable);
    end;
    clear MatlabServer_tmp_k MatlabServer_tmp_variable;

    MatlabServer_tmp_expr = sprintf('%s)', MatlabServer_tmp_expr);
    if (~MatlabServer_tmp_ok)
      writeInt(MatlabServer_os, -1);
      writeUTF(MatlabServer_os, MatlabServer_lasterr);
    else
      fprintf(2, '%s\n', MatlabServer_tmp_expr);
      eval(MatlabServer_tmp_expr);
      MatlabServer_tmp_file = java.io.File(MatlabServer_tmp_tmpname);
      MatlabServer_tmp_maxLength = length(MatlabServer_tmp_file);
      clear MatlabServer_tmp_file;
      writeInt(MatlabServer_os, MatlabServer_tmp_maxLength); % Here anything but -1 means "success"
      fprintf(2, 'Send int: %d (maxLength)\n', MatlabServer_tmp_maxLength);
      MatlabServer_tmp_fid = fopen(MatlabServer_tmp_tmpname, 'r');
      MatlabServer_tmp_count = 1;
      while (MatlabServer_tmp_count ~= 0)
        [MatlabServer_tmp_bfr, MatlabServer_tmp_count] = fread(MatlabServer_tmp_fid, 65536, 'int8');
        if (MatlabServer_tmp_count &gt; 0)
          write(MatlabServer_os, MatlabServer_tmp_bfr);
        end;
      end;
      fclose(MatlabServer_tmp_fid);
      fprintf(2, 'Send buffer: %d bytes.\n', MatlabServer_tmp_maxLength);
      delete(MatlabServer_tmp_tmpname);
      clear MatlabServer_tmp_bfr MatlabServer_tmp_count MatlabServer_tmp_maxLength MatlabServer_tmp_fid MatlabServer_tmp_tmpname;
    end
    flush(MatlabServer_os);
   
    MatlabServer_tmp_answer = readByte(MatlabServer_is);
    fprintf(2, 'answer=%d\n', MatlabServer_tmp_answer);
   
    MatlabServer_state = 0;
    clear MatlabServer_tmp_name MatlabServer_tmp_expr MatlabServer_tmp_ok MatlabServer_tmp_answer; 

  %-------------------
  % 'receive-remote'
  %-------------------
  elseif (MatlabServer_state == strmatch('receive-remote', MatlabServer_commands, 'exact'))
    MatlabServer_tmp_len = readInt(MatlabServer_is);
    fprintf(2, 'Will read MAT file structure of length: %d bytes.\n', MatlabServer_tmp_len);

    MatlabServer_tmp_reader = InputStreamByteWrapper(4096);
    MatlabServer_tmp_bfr = [];
    MatlabServer_tmp_count = 1;
    while (MatlabServer_tmp_len &gt; 0 &amp; MatlabServer_tmp_count &gt; 0)
      MatlabServer_tmp_count = MatlabServer_tmp_reader.read(MatlabServer_is, min(4096, MatlabServer_tmp_len));
      if (MatlabServer_tmp_count &gt; 0)
        MatlabServer_tmp_bfr = [MatlabServer_tmp_bfr; MatlabServer_tmp_reader.bfr(1:MatlabServer_tmp_count)];
        MatlabServer_tmp_len = MatlabServer_tmp_len - MatlabServer_tmp_count;
      end;
    end;

    clear MatlabServer_tmp_reader MatlabServer_tmp_count MatlabServer_tmp_len;

    MatlabServer_tmp_tmpfile = sprintf('%s_%d.mat', tempname, MatlabServer_port);
    MatlabServer_tmp_fh = fopen(MatlabServer_tmp_tmpfile, 'wb');
    fwrite(MatlabServer_tmp_fh, MatlabServer_tmp_bfr, 'int8');
    fclose(MatlabServer_tmp_fh);

    clear MatlabServer_tmp_fh MatlabServer_tmp_bfr;
   
    load(MatlabServer_tmp_tmpfile);
   
    delete(MatlabServer_tmp_tmpfile);
    clear MatlabServer_tmp_tmpfile;
    writeByte(MatlabServer_os, 0);

    MatlabServer_state = 0;
   
  %-------------------
  % 'receive'
  %-------------------
  elseif (MatlabServer_state == strmatch('receive', MatlabServer_commands, 'exact'))
    MatlabServer_tmp_filename = char(readUTF(MatlabServer_is));
    fprintf(2, 'Will read MAT file: "%s"\n', MatlabServer_tmp_filename);
    load(MatlabServer_tmp_filename);
    clear MatlabServer_tmp_filename;
    writeByte(MatlabServer_os, 0);
    MatlabServer_state = 0;
    clear MatlabServer_tmp_filename;
  end
end


% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
% Shutting down the MATLAB server
% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

fprintf(2, '-----------------------\n');
fprintf(2, 'MATLAB server shutdown!\n');
fprintf(2, '-----------------------\n');
writeByte(MatlabServer_os, 0);
close(MatlabServer_os);
close(MatlabServer_is);
close(MatlabServer_server);
quit;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% HISTORY:
% 2016-04-05 [v3.6.0]
% o All verbose/debug messages are outputted to stream #2 ("stderr").
% 2015-09-11 [v3.3.0]
% o Now temporary files use format &lt;tempname&gt;_&lt;port&gt;.mat.
% o Add 'MatlabServer_' prefix to all variables.
% o Add 'evalc' command.  Thanks to Rohan Shah for this.
% 2015-01-08 [v3.1.2]
% o BUG FIX: Matlab$getVariable() for a non-existing variable would
%   crash the R-to-Matlab communication if remote=FALSE.
% 2014-06-23 [v3.0.2]
% o ROBUSTNESS: Variables 'lasterr' and 'variables' are now always
%   defined. Potential bug spotted by Steven Jaffe at Morgan Stanley.
% o Added more progress/verbose output, e.g. current working directory.
% 2014-01-21 [v2.2.0]
% o BUG FIX: The MatlabServer.m script would incorrectly consider
%   Matlab v8 and above as Matlab v6.  Thanks to Frank Stephen at NREL
%   for reporting on this and providing a patch.
% 2013-07-11 [v1.3.5]
% o Updated messages to use 'MATLAB' instead of 'Matlab'.
% 2010-10-25 [v1.3.4]
% o BUG FIX: The MatlabServer.m script incorrectly referred to the
%   InputStreamByteWrapper class as java.io.InputStreamByteWrapper.
%   Thanks Kenvor Cothey at GMO LCC for reporting on this.
% 2010-08-28
% o Now the MatlabServer script reports its version when started.
% 2010-08-27
% o BUG FIX: Now MatlabServer.m saves variables using the function form,
%   i.e. save().  This solves the problem of having single quotation marks
%   in the pathname. Thanks Michael Q. Fan at NC State University for
%   reporting this problem.
% 2009-08-25
% o BUG FIX: Started to get the error "Undefined function or method
%   'ServerSocket' for input arguments of type 'double'.".  It seems like
%   import java.net.* etc does not work. A workaround is to specify the
%   full path for all Java classes, e.g. java.net.ServerSocket.
%   Thanks Nicolas Stadler for reporting this issue.
% 2006-12-28
% o Extended the accepted range of ports from [1023,49151] to [1023,66535].
% 2006-05-08
% o BUG FIX: The error message string for reporting port out of range
%   was invalid and gave the error '... Line: 109 Column: 45 ")" expected,
%   "identifier" found.'.  Thanks Alexander Nervedi for reporting this.
% 2006-01-21
% o Now an error is thrown if port number is out of (safe) range.
% o Added option to specify the port number via the system environment
%   variable MATLABSERVER_PORT, after request by Wang Yu, Iowa State Univ.
% 2005-03-08
% o BUG FIX: substring() is not recognized by MATLAB v7. Using regexp()
%   which works in MATLAB 6.5 and 7. Workaround eval('try', 'catch').
%   Thanks Patrick Drechsler, University of Wuerzburg for the bug report.
% 2005-02-24
% o Now the dynamic Java classpath is set for MATLAB v7 or higher. This
%   will simplify life for MATLAB v7 users.
% 2005-02-22
% o Added javaaddpath() to include InputStreamByteWrapper.class.
%   Thanks Yichun Wei for feedback and great suggestions.
% 2005-02-11
% o If MATLAB v7 or higher is detected, all MAT structures are saved with
%   option '-V6' so readMat() in R.matlab can read them.
% 2002-09-02 [or maybe a little bit earlier]
% o Created.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

 </pre>


<h3>InputStreamByteWrapper.(class|java) script</h3>

<p>The Java class InputStreamByteWrapper is needed in order for MATLAB to
<em>receive</em> <em>data</em> via a data stream. <span class="rlang"><b>R</b></span> sends data via a data
stream if, and only if, the connection was setup for &quot;remote&quot;
communication, that is, with argument <code>remote = TRUE</code>).
</p>
<pre>
 
import java.io.*;

/*********************************************************************
% Compile from within MATLAB with:
% !javac InputStreamByteWrapper.java

% MATLAB example that reads a file using Java code and writes it
% back to a temporary file using MATLAB code. Finally the contents
% of the new file is displayed.

reader = InputStreamByteWrapper;  % Default buffer size is 4096 bytes.

in = java.io.FileInputStream('InputStreamByteWrapper.java');

bfr = [];
len = 1;
while (len &gt; 0)
  len = reader.read(in, 16);  % Read 16 bytes at the time (offset=0).
  if (len &gt; 0)
    bfr = [bfr; reader.bfr(1:len)];  % Add bytes to my MATLAB buffer.
  end
end

close(in);
clear in, reader;

disp(bfr');

tmpfile = tempname;
fh = fopen(tmpfile, 'wb');
fwrite(fh, bfr, 'char');
fclose(fh);

type(tmpfile);
*********************************************************************/
public class InputStreamByteWrapper {
  public static byte[] bfr = null;

  public InputStreamByteWrapper(int capasity) {
    bfr = new byte[capasity];
  }

  public InputStreamByteWrapper() {
    this(4096);
  }

  public int read(InputStream in, int offset, int length) throws IOException {
    return in.read(bfr, offset, length);
  }

  public int read(InputStream in, int length) throws IOException {
    return read(in, 0, length);
  }

  public int read(InputStream in) throws IOException {
    return in.read(bfr);
  }
}

/*********************************************************************
 HISTORY:
2013-07-11
 o Updated comments to use 'MATLAB' instead of 'Matlab'.
2002-09-02 [or maybe a little bit earlier]
 o Created.
*********************************************************************/


 </pre>

<hr>
<h2 id='as.character.Matlab'>Gets a string describing the current MATLAB connection</h2><span id='topic+as.character.Matlab'></span><span id='topic+Matlab.as.character'></span><span id='topic+as.character+2CMatlab-method'></span>

<h3>Description</h3>

<p>Gets a string describing the current MATLAB connection.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
as.character(x, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="as.character.Matlab_+3A_...">...</code></td>
<td>
<p>Not used.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns a <code><a href="base.html#topic+character">character</a></code> string.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='close.Matlab'>Closes connection to MATLAB server</h2><span id='topic+close.Matlab'></span><span id='topic+Matlab.close'></span><span id='topic+close+2CMatlab-method'></span>

<h3>Description</h3>

<p>Closes connection to MATLAB server. After closing the connection the MATLAB
server can never more be access again.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
close(con, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="close.Matlab_+3A_...">...</code></td>
<td>
<p>Not used.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns what <code><a href="#topic+close.Matlab">*close</a>()</code> returns.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='evaluate.Matlab'>Evaluates a MATLAB expression</h2><span id='topic+evaluate.Matlab'></span><span id='topic+Matlab.evaluate'></span><span id='topic+evaluate+2CMatlab-method'></span>

<h3>Description</h3>

<p>Evaluates one or several MATLAB expressions on the MATLAB server. This
method will not return until the MATLAB server is done.
</p>
<p>If an error occurred in MATLAB an exception will be thrown. This
exception can be caught by <code><a href="base.html#topic+conditions">tryCatch</a>()</code>.
</p>
<p>If you receive error message <em>Expected an 'answer' from MATLAB,
but kept receiving nothing</em>, see &quot;Troubleshooting&quot; under ?R.matlab.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
evaluate(this, ..., collapse=";", capture=FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="evaluate.Matlab_+3A_...">...</code></td>
<td>
<p>One or several string with MATLAB expressions. If several
strings are given they will be concatenated with the separator
<code>collapse</code>.</p>
</td></tr>
<tr><td><code id="evaluate.Matlab_+3A_collapse">collapse</code></td>
<td>
<p>Separator to be used to concatenate expressions.</p>
</td></tr>
<tr><td><code id="evaluate.Matlab_+3A_capture">capture</code></td>
<td>
<p>If <code><a href="base.html#topic+logical">TRUE</a></code>, MATLAB output is captured into a string,
otherwise not.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>If <code>caputure</code> is <code><a href="base.html#topic+logical">TRUE</a></code>, then a <code><a href="base.html#topic+character">character</a></code> string of MATLAB output
is returned, otherwise the MATLAB status code.
The MATLAB status code is also/always returned as attribute <code>status</code>.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='finalize.Matlab'>(internal) Finalizes the object if deleted</h2><span id='topic+finalize.Matlab'></span><span id='topic+Matlab.finalize'></span><span id='topic+finalize+2CMatlab-method'></span>

<h3>Description</h3>

<p>(internal) Finalizes the object if deleted. If a MATLAB connection is opened, it is closed.
</p>
<p>Note that you should never have to call this method explicitly. It is
called automatically whenever the object is removed from memory
(by the garbage collector).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
finalize(this, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="finalize.Matlab_+3A_...">...</code></td>
<td>
<p>Not used.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns nothing.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='getOption.Matlab'>Gets the value of an option</h2><span id='topic+getOption.Matlab'></span><span id='topic+Matlab.getOption'></span><span id='topic+getOption+2CMatlab-method'></span>

<h3>Description</h3>

<p>Gets the value of an option where the option is specified like a file pathname, e.g.
&quot;readResult/maxTries&quot;.  See <code><a href="#topic+setOption.Matlab">*setOption</a>()</code> for what options
are available.
See the <a href="R.utils.html#topic+Options">Options</a> class for details.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
getOption(this, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="getOption.Matlab_+3A_...">...</code></td>
<td>
<p>Arguments passed to
<code><a href="R.utils.html#topic+getOption.Options">getOption</a></code>()
of the Options class.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns the value of the option.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p><code><a href="#topic+setOption.Matlab">*setOption</a>()</code>.
For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='getVariable.Matlab'>Gets one or several MATLAB variables</h2><span id='topic+getVariable.Matlab'></span><span id='topic+Matlab.getVariable'></span><span id='topic+getVariable+2CMatlab-method'></span>

<h3>Description</h3>

<p>Gets one or several MATLAB variables from the MATLAB server.
The transfer of the data can be done locally via a temporary file
(<code>remote = FALSE</code>) or through the socket <code><a href="base.html#topic+connections">connection</a></code> (<code>remote = TRUE</code>),
which is always available.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
getVariable(this, variables, remote=this$remote, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="getVariable.Matlab_+3A_variables">variables</code></td>
<td>
<p>String vector of MATLAB containing names of variable that
are to be retrieved from the MATLAB server.</p>
</td></tr>
<tr><td><code id="getVariable.Matlab_+3A_remote">remote</code></td>
<td>
<p>If <code><a href="base.html#topic+logical">TRUE</a></code> the variables are transferred on the
socket <code><a href="base.html#topic+connections">connection</a></code>, otherwise they are transferred via a temporary file.</p>
</td></tr>
<tr><td><code id="getVariable.Matlab_+3A_...">...</code></td>
<td>
<p>Not used.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns a <code>list</code> structure containing the MATLAB variables as named
values.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='isOpen.Matlab'>Checks if connection to the MATLAB server is open</h2><span id='topic+isOpen.Matlab'></span><span id='topic+Matlab.isOpen'></span><span id='topic+isOpen+2CMatlab-method'></span>

<h3>Description</h3>

<p>Checks if connection to the MATLAB server is open.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
isOpen(con, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="isOpen.Matlab_+3A_...">...</code></td>
<td>
<p>Not used.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns <code><a href="base.html#topic+logical">TRUE</a></code> if <code><a href="base.html#topic+connections">connection</a></code> is open, otherwise <code><a href="base.html#topic+logical">FALSE</a></code>.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='Matlab'>MATLAB client for remote or local MATLAB access</h2><span id='topic+Matlab'></span>

<h3>Description</h3>

<p>Package:  R.matlab <br />
<b>Class Matlab</b><br />
</p>
<p><code><a href="R.oo.html#topic+Object">Object</a></code><br />
<code>~~|</code><br />
<code>~~+--</code><code>Matlab</code><br />
</p>
<p><b>Directly known subclasses:</b><br />
<br />
</p>
<p>public static class <b>Matlab</b><br />
extends <a href="R.oo.html#topic+Object">Object</a><br />
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Matlab(host="localhost", port=9999, remote=!(host %in% c("localhost", "127.0.0.1")))
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="Matlab_+3A_host">host</code></td>
<td>
<p>Name of host to connect to.</p>
</td></tr>
<tr><td><code id="Matlab_+3A_port">port</code></td>
<td>
<p>Port number on host to connect to.</p>
</td></tr>
<tr><td><code id="Matlab_+3A_remote">remote</code></td>
<td>
<p>If <code><a href="base.html#topic+logical">TRUE</a></code>, all data to and from the MATLAB server will
be transferred through the socket <code><a href="base.html#topic+connections">connection</a></code>, otherwise the data will
be transferred via a temporary file.</p>
</td></tr>
</table>


<h3>Fields and Methods</h3>

<p><b>Methods:</b><br />
</p>

<table>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+as.character.Matlab">as.character</a></code> </td><td style="text-align: left;"> Gets a string describing the current MATLAB connection.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+close.Matlab">close</a></code> </td><td style="text-align: left;"> Closes connection to MATLAB server.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+evaluate.Matlab">evaluate</a></code> </td><td style="text-align: left;"> Evaluates a MATLAB expression.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+finalize.Matlab">finalize</a></code> </td><td style="text-align: left;"> (internal) Finalizes the object if deleted.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+getOption.Matlab">getOption</a></code> </td><td style="text-align: left;"> Gets the value of an option.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+getVariable.Matlab">getVariable</a></code> </td><td style="text-align: left;"> Gets one or several MATLAB variables.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+isOpen.Matlab">isOpen</a></code> </td><td style="text-align: left;"> Checks if connection to the MATLAB server is open.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+open.Matlab">open</a></code> </td><td style="text-align: left;"> Tries to open a connection to the MATLAB server.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+readResult.Matlab">readResult</a></code> </td><td style="text-align: left;"> (internal) Reads results from the MATLAB server.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+setFunction.Matlab">setFunction</a></code> </td><td style="text-align: left;"> Defines a MATLAB function.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+setOption.Matlab">setOption</a></code> </td><td style="text-align: left;"> Sets the value of an option.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+setVariable.Matlab">setVariable</a></code> </td><td style="text-align: left;"> Sets one or several MATLAB variables.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+setVerbose.Matlab">setVerbose</a></code> </td><td style="text-align: left;"> Sets the verbose level to get more details about the MATLAB access.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+startServer.Matlab">startServer</a></code> </td><td style="text-align: left;"> Static method which starts a MATLAB server.</td>
</tr>
<tr>
 <td style="text-align: right;">
 </td><td style="text-align: left;"> <code><a href="#topic+writeCommand.Matlab">writeCommand</a></code> </td><td style="text-align: left;"> (internal) Writes (sends) an R-to-MATLAB command to the MATLAB server.</td>
</tr>
<tr>
 <td style="text-align: right;">
</td>
</tr>

</table>

<p><b>Methods inherited from Object</b>:<br />
$, $&lt;-, [[, [[&lt;-, as.character, attach, attachLocally, clearCache, clearLookupCache, clone, detach, equals, extend, finalize, getEnvironment, getFieldModifier, getFieldModifiers, getFields, getInstantiationTime, getStaticInstance, hasField, hashCode, ll, load, names, objectSize, print, save
</p>


<h3>Requirements</h3>

<p>In order for <span class="rlang"><b>R</b></span> to communicate with MATLAB, MATLAB v6 or higher is
needed. It will <em>not</em> work with previous versions, because they
do not support Java.<br />
</p>
<p>We use the term <em>server</em> to say that MATLAB acts like a server
with regard to <span class="rlang"><b>R</b></span>. Note that it a standard MATLAB session that runs.<br />
</p>
<p>Also, the starting of the MatlabServer is simpler from MATLAB v7,
although it is pretty straightforward for MATLAB v6 too.
It is easier in MATLAB v7 and above, because the Java class required
for remote-data-transfer can be automatically/dynamically added to
the MATLAB Java classpath, whereas for MATLAB v6 it has to be
added manually (see below).
</p>


<h3>Remote and non-remote connections</h3>

<p>When a remote connection (argument <code>remote = TRUE</code>) is used,
data is send to and from MATLAB via a data stream. This is needed
when <span class="rlang"><b>R</b></span> is running on a host with a separated file system than
the one MATLAB is running on.
</p>
<p>If not connection &quot;remotely&quot; (<code>remote = FALSE</code>), data is
communicated via the file system, that is, by saving and reading
it to temporary MAT files. <br />
</p>
<p>Troubleshooting: If &quot;remote&quot; transfers are used, the
InputStreamByteWrapper Java class must be found by MATLAB,
otherwise an error will occur in MATLAB as soon as data is
send from <span class="rlang"><b>R</b></span> to MATLAB. In all other cases, the above Java class
is <em>not</em> needed.
</p>


<h3>Starting the MATLAB server from within <span class="rlang"><b>R</b></span></h3>

<p>The MATLAB server may be started from within <span class="rlang"><b>R</b></span> by
calling <code>Matlab$startServer()</code>. By default 'matlab' is called
if named differently set <code>options(matlab = "matlab6.5")</code>, say.
<em>The method is experimental and may not work on your system.</em>
By default the MATLAB server listens for connections on port 9999.
For other ports, set argument <code>port</code>, e.g.
<code>Matlab$startServer(port = 9998)</code>.
</p>
<p>Note that the code will <em>not</em> halt and wait for MATLAB to get
started. Thus, you have to make sure you will wait long enough for
the server to get up and running before the <span class="rlang"><b>R</b></span> client try to
connect. By default, the client will try once a second for 30 seconds
before giving up.
Moreover, on non-Windows systems, the above command will start MATLAB
in the background making all MATLAB messages be sent to the <span class="rlang"><b>R</b></span> output
screen.
In addition, the method will copy the MatlabServer.m and
InputStreamByteWrapper.class files to the current directory
and start MATLAB from there.
</p>


<h3>Starting the MATLAB server without <span class="rlang"><b>R</b></span></h3>

<p>If the above does not work, the MATLAB server may be started manually
from MATLAB itself.  Please follow the below instructions carefully.
</p>
<p><b>To be done once:</b><br />
In MATLAB, add the path to the directory where MatlabServer.m sits.
See <code>help pathtool</code> in MATLAB on how to do this.
In R you can type <code>system.file("externals", package = "R.matlab")</code>
to find out the path to MatlabServer.m.
</p>
<p><b>For MATLAB v6 only:</b> Contrary to MATLAB v7 and above, MATLAB v6
cannot find the InputStreamByteWrapper class automatically. Instead,
the so called Java classpath has to be set manually. In MATLAB, type
<code>which('classpath.txt')</code> to find where the default
MATLAB classpath.txt file is located. Copy this file to the
<em>current directory</em>, and append the <em>path</em> (the directory)
of InputStreamByteWrapper.class to the end of classpath.txt.
The path of InputStreamByteWrapper.class can be identified by
<code>system.file("java", package = "R.matlab")</code> in R.<br />
</p>
<p><b>Lazy alternative:</b> Instead of setting path and classpaths,
you may try to copy the MatlabServer.m and InputStreamByteWrapper.class
to the current directory from which MATLAB is then started.
</p>
<p><b>To start the server:</b><br />
In order to start the MATLAB server, type<br />
</p>
<p><code>matlab -nodesktop -nosplash -r MatlabServer</code><br />
</p>
<p>If using MATLAB v6, make sure your <code>classpath.txt</code> is the
current directory!
</p>
<p>This will start MATLAB and immediately call the MatlabServer(.m)
script. Here is how it should look like when the server starts:
</p>
<pre>
  
                            &lt; M A T L A B (R) &gt;
                  Copyright 1984-2012 The MathWorks, Inc.
                    R2012a (7.14.0.739) 64-bit (glnxa64)
                              February 9, 2012


To get started, type one of these: helpwin, helpdesk, or demo.
For product information, visit www.mathworks.com.

Running MatlabServer v3.0.2
MATLAB v7.x or higher detected.
Saving with option -V6.
Added InputStreamByteWrapper to dynamic Java CLASSPATH.
----------------------
MATLAB server started!
----------------------
MATLAB working directory: /home/AwesomeUser/FabulousProject/
Trying to open server socket (port 9999)...done.

  </pre>
<p>Alternatively you can start MATLAB and type <code>MatlabServer</code>
at the prompt.
</p>
<p>By default the MATLAB server listens for connections on port 9999.
For other ports, set environment variable <code>MATLABSERVER_PORT</code>.
</p>


<h3>Confirmed MATLAB versions</h3>

<p>This package has been confirmed to work <em>successfully</em> out of
the box together with the following MATLAB versions:
MATLAB v6.1.0.450 (R12.1) [Jun 2001],
MATLAB v6.5.0.180913a (R13) [Jul 2002],
MATLAB v7.0.0.19901 (R14) [Jun 2004],
MATLAB v7.0.1.24704 (R14SP1) [Oct 2004],
MATLAB v7.0.4.365 (R14SP2) [Mar 2005],
MATLAB v7.2.0.232 (R2006a) [Mar 2006],
MATLAB v7.4.0 (R2007a) [Mar 2007]],
MATLAB v7.7.0.471 (R2008b) [Oct 2008],
MATLAB v7.10.0.499 (R2010a) [Mar 2010],
MATLAB v7.11.0.584 (R2010b) [Sep 2010],
MATLAB v7.14.0.739 (R2012a) [Mar 2012],
MATLAB v8.2.0.701 (R2013b) [Sep 2013], and
MATLAB v8.4.0 (R2014b) [Oct 2014].
If you successfully use a different/higher MATLAB version,
please tell us, so we can share it here.
</p>
<p>It does <em>not</em> work with MATLAB v5 or before.
</p>


<h3>Security</h3>

<p>There is <em>no</em> security in the communication with the MATLAB
server. This means that if you start the MATLAB server, it will
wait for requests via the connection at the specified port. As
long as your <span class="rlang"><b>R</b></span> session has not connected to this port, others
may be able to steal the connection and send malicious commands
(if they know the R.matlab protocol). The MATLAB server only
allows one connection. In other words, if you are connected it
is not possible for others to connect to the MATLAB server.
</p>


<h3>MATLAB server is timing out</h3>

<p>It might be that an <code><a href="#topic+evaluate.Matlab">*evaluate</a>()</code> call to the MATLAB server
takes a long time for the server to finish resulting in a time-out
exception.  By default this happens after 30 seconds, but it can
be changed by modifying options, cf. <code><a href="#topic+setOption">setOption</a></code>().
</p>


<h3>Multiple parallel MATLAB instances</h3>

<p>You can launch multiple parallel MATLAB instance using this interface.
This can be done in separate R sessions or in a single one.  As long
as each MATLAB server/session is communicating on a separate port,
there is no limitation in the number of parallel MATLAB instances
that can be used.  Example:
</p>
<pre>
   &gt; library('R.matlab')
   ## Start two separate MATLAB servers
   &gt; Matlab$startServer(port = 9997)
   &gt; Matlab$startServer(port = 9999)

   ## Connect to each of them
   &gt; matlab1 &lt;- Matlab(port = 9997); open(matlab1)
   &gt; matlab2 &lt;- Matlab(port = 9999); open(matlab2)

   ## Evaluate expression in each of them
   &gt; evaluate(matlab1, "x = 1+2; x")
   &gt; evaluate(matlab2, "y = 1+2; y")
  </pre>
<p>Note that the two MATLAB instance neither communicate nor
share variables.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>Stand-alone methods <code><a href="#topic+readMat">readMat</a></code>() and <code><a href="#topic+writeMat">writeMat</a></code>()
for reading and writing MAT file structures.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# This example will try to start the MATLAB server on the local machine,
# and then setup a Matlab object in R for communicating data between R
# and MATLAB and for sending commands from R to MATLAB.
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# 1.  Load R.matlab
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
library(R.matlab)


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# 2.  Start MATLAB
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# 2.1.  Start MATLAB from R?
# Start MATLAB server on the local machine (if this fails,
# see help(Matlab) for alternatives).
Matlab$startServer()

# 2.2.  OR start MATLAB externally,
#       THEN add 'externals' subdirectory to the MATLAB path

#  (Where is the 'externals' subdirectory?)
print(system.file("externals", package = "R.matlab"))

#       THEN from within MATLAB,
#            issue MATLAB command "MatlabServer"
# Note: If issued from a MATLAB command line, this last command
#       prevents further MATLAB 'command line' input
#       until something like close(matlab) at the end of this script

# 2.3.  If both these options fail, see help(Matlab) for alternatives.


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# 3. Create a MATLAB client object used to communicate with MATLAB
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
matlab &lt;- Matlab()

# 3.1 Check status of MATLAB connection (not yet connected)
print(matlab)

# 3.2 If you experience any problems, ask for detailed outputs
#     by uncommenting the next line
# setVerbose(matlab, -2)

# 3.3 Connect to the MATLAB server.
isOpen &lt;- open(matlab)

# 3.4 Confirm that the MATLAB server is open, and running
if (!isOpen)
  throw("MATLAB server is not running: waited 30 seconds.")

# 3.5 Check status of MATLAB connection (now connected)
print(matlab)


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# 4.  Sample uses of the MATLAB server
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# 4.1 Run MATLAB expressions on the MATLAB server
evaluate(matlab, "A = 1+2;", "B = ones(2, 20);")

# 4.2 Ask MATLAB to display a value (without transferring it to R)
evaluate(matlab, "A")

# 4.3 Get MATLAB variables
data &lt;- getVariable(matlab, c("A", "B"))
cat("Received variables:\n")
str(data)

# 4.4 Set variables in MATLAB
ABCD &lt;- matrix(rnorm(10000), ncol = 100)
str(ABCD)
setVariable(matlab, ABCD = ABCD)

# 4.5 Retrieve what we just set
data &lt;- getVariable(matlab, "ABCD")
cat("Received variables:\n")
str(data)

# 4.6 Create a function (M-file) on the MATLAB server
setFunction(matlab, "            \
  function [win, aver] = dice(B) \
  %Play the dice game B times    \
  gains = [-1, 2, -3, 4, -5, 6]; \
  plays = unidrnd(6, B, 1);      \
  win = sum(gains(plays));       \
  aver = win/B;                  \
")

# 4.7 Use the MATLAB function just created
evaluate(matlab, "[w, a] = dice(1000);")
res &lt;- getVariable(matlab, c("w", "a"))
print(res)


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# 5. Exception handling
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# 5.1 Try to get non-existing MATLAB variable
#     (will result in an informative error)
tryCatch({
  data &lt;- getVariable(matlab, "unknown")
  cat("Received variables:\n")
  str(data)
}, error = function(ex) {
  print(ex)
})
# Confirm that things still work
data &lt;- getVariable(matlab, "A")
cat("Received variables:\n")
str(data)


# 5.2 Try to evaluate a MATLAB expression that fails
#     (will result in an informative error)
tryCatch({
  res &lt;- evaluate(matlab, "C = 1+unknown;")
  res
}, error = function(ex) {
  print(ex)
})
# Confirm that things still work
res &lt;- evaluate(matlab, "C = 1+2;")
print(res)
data &lt;- getVariable(matlab, "C")
cat("Received variables:\n")
str(data)


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# 6.  Done:  close the MATLAB client
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# When done, close the MATLAB client, which will also shutdown
# the MATLAB server and the connection to it.
close(matlab)

# 6.1 Check status of MATLAB connection (now disconnected)
print(matlab)

## End(Not run)</code></pre>

<hr>
<h2 id='Matlab+24startServer'>Static method which starts a MATLAB server</h2><span id='topic+Matlab+24startServer'></span><span id='topic+startServer.Matlab'></span><span id='topic+Matlab.startServer'></span><span id='topic+startServer+2CMatlab-method'></span>

<h3>Description</h3>

<p>Static method which starts a MATLAB server on the local machine. Note
that MATLAB v6 or later is required, since the MATLAB server relies on
Java.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## Static method (use this):
## Matlab$startServer(matlab=getOption("matlab"), port=9999, minimize=TRUE,
##   options=c("nodesktop", "nodisplay", "nosplash"), workdir=".", ...)

## Don't use the below:
## S3 method for class 'Matlab'
startServer(this, matlab=getOption("matlab"), port=9999, minimize=TRUE,
  options=c("nodesktop", "nodisplay", "nosplash"), workdir=".", ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="Matlab+2B24startServer_+3A_matlab">matlab</code></td>
<td>
<p>An optional <code><a href="base.html#topic+character">character</a></code> string specifying the name of
the matlab command, if different from <code>"matlab"</code>. An absolute
path are possible.</p>
</td></tr>
<tr><td><code id="Matlab+2B24startServer_+3A_port">port</code></td>
<td>
<p>An optional <code><a href="base.html#topic+integer">integer</a></code> in [1023, 65535].
If given, the environment variable <code>MATLABSERVER_PORT</code> is
set specifying which port the MATLAB server should listen to for
clients trying to connect.  The default port is 9999.</p>
</td></tr>
<tr><td><code id="Matlab+2B24startServer_+3A_minimize">minimize</code></td>
<td>
<p>When starting MATLAB on Windows, it is always opened
in a new window (see <code><a href="#topic+1.+20The+20MATLAB+20server+20running+20in+20MATLAB">1. The MATLAB server running in MATLAB</a></code>).
If this argument is <code><a href="base.html#topic+logical">TRUE</a></code>, the new window is minimized, otherwise not.
This argument is ignored on non-Windows systems.</p>
</td></tr>
<tr><td><code id="Matlab+2B24startServer_+3A_options">options</code></td>
<td>
<p>A <code><a href="base.html#topic+character">character</a></code> <code><a href="base.html#topic+vector">vector</a></code> of options used to call the
MATLAB application.</p>
</td></tr>
<tr><td><code id="Matlab+2B24startServer_+3A_workdir">workdir</code></td>
<td>
<p>The working directory to be used by MATLAB.</p>
</td></tr>
<tr><td><code id="Matlab+2B24startServer_+3A_...">...</code></td>
<td>
<p>Not used.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This method is currently supported on Windows and Unix systems. Other
systems are untested, but might work anyway.
</p>
<p>Note that this method will return immediately upon calling
<code>system()</code> internally, i.e. you will not receive a return value
telling whether MATLAB was successfully started or not.
</p>
<p>To specify the full path to the matlab software set the <code>matlab</code>
option, e.g. <code>options(matlab = "/opt/bin/matlab6.1")</code>. If no such
option exists, the value <code>"matlab"</code> will be used.
</p>
<p>The MATLAB server relies on two files:
1) MatlabServer.m and 2) InputStreamByteWrapper.class
These files exists in the externals/ and java/ directories of this
package. However, if they do not exist in the current directory,
which is the directory where MATLAB is started, copies of them will
automatically be made.
</p>


<h3>Value</h3>

<p>Returns nothing.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='Non-documented+20objects'>Non-documented objects</h2><span id='topic+Non-documented+20objects'></span><span id='topic+evaluate'></span><span id='topic+getOption'></span><span id='topic+getOption.default'></span><span id='topic+getVariable'></span><span id='topic+isOpen'></span><span id='topic+isOpen.default'></span><span id='topic+readResult'></span><span id='topic+setFunction'></span><span id='topic+setOption'></span><span id='topic+setVariable'></span><span id='topic+setVerbose'></span><span id='topic+startServer'></span><span id='topic+writeCommand'></span>

<h3>Description</h3>

<p>This page contains aliases for all &quot;non-documented&quot; objects that
<code>R CMD check</code> detects in this package.
</p>
<p>Almost all of them are <em>generic</em> functions that have specific
document for the corresponding method coupled to a specific class.
Other functions are re-defined by <code>setMethodS3()</code> to
<em>default</em> methods. Neither of these two classes are non-documented
in reality.
The rest are deprecated methods.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>

<hr>
<h2 id='open.Matlab'>Tries to open a connection to the MATLAB server</h2><span id='topic+open.Matlab'></span><span id='topic+Matlab.open'></span><span id='topic+open+2CMatlab-method'></span>

<h3>Description</h3>

<p>Tries to open a socket connection to the MATLAB server. If the connection
could not be opened it the first time it will try to open it every
<code>interval</code> second up to <code>trials</code> times.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
open(con, trials=30, interval=1, timeout=getOption("timeout"), ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="open.Matlab_+3A_trials">trials</code></td>
<td>
<p>The number of trials before giving up.</p>
</td></tr>
<tr><td><code id="open.Matlab_+3A_interval">interval</code></td>
<td>
<p>The interval in seconds between trials.</p>
</td></tr>
<tr><td><code id="open.Matlab_+3A_timeout">timeout</code></td>
<td>
<p>The timeout for the socket connection</p>
</td></tr>
<tr><td><code id="open.Matlab_+3A_...">...</code></td>
<td>
<p>Not used.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns <code><a href="base.html#topic+logical">TRUE</a></code> if a socket <code><a href="base.html#topic+connections">connection</a></code> to the MATLAB server was
successfully opened, otherwise <code><a href="base.html#topic+logical">FALSE</a></code>.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='R.matlab-package'>Package R.matlab</h2><span id='topic+R.matlab-package'></span><span id='topic+R.matlab'></span>

<h3>Description</h3>

<p>Methods readMat() and writeMat() for reading and writing MAT files.  For user with MATLAB v6 or newer installed (either locally or on a remote host), the package also provides methods for controlling MATLAB (trademark) via R and sending and retrieving data between R and MATLAB.
</p>
<p>In brief, this package provides a one-directional interface from
<span class="rlang"><b>R</b></span> to MATLAB, with communication taking place via a TCP/IP connection
and with data transferred either through another connection or via
the file system. On the MATLAB side, the TCP/IP connection is handled
by a small Java add-on.
</p>
<p>The methods for reading and writing MAT files are stable.
The <span class="rlang"><b>R</b></span> to MATLAB interface, that is the Matlab class, is less
prioritized and should be considered a beta version.
</p>
<p>For package history, see <code>showHistory(R.matlab)</code>.
</p>


<h3>Requirements</h3>

<p>This is a cross-platform package implemented in plain <span class="rlang"><b>R</b></span>.
This package depends on the <span class="pkg">R.oo</span> package [1].
</p>
<p>To use the Matlab class or requesting verbose output messages, the
<a href="R.utils.html#topic+R.utils-package">R.utils</a> package is loaded
when needed (and therefore required in those cases).
</p>
<p>The <code>readMat()</code> and <code>writeMat()</code> methods do <code class="reqn">not</code>
require a MATLAB installation neither do they depend on the
<code><a href="#topic+Matlab">Matlab</a></code> class.
</p>
<p>To connect to MATLAB, MATLAB v6 or higher is required.
It does <em>not</em> work with MATLAB v5 or before (because those
versions do not support Java).
For confirmed MATLAB versions, see the <code><a href="#topic+Matlab">Matlab</a></code> class.
</p>


<h3>Installation</h3>

<p>To install this package do<br />
</p>
<p><code>install.packages("R.matlab")</code>
</p>


<h3>To get started</h3>

<p>To get started, see:
</p>

<ol>
<li> <p><code><a href="#topic+readMat">readMat</a></code>() and <code><a href="#topic+writeMat">writeMat</a></code>() - For reading and writing
MAT files (MATLAB is <em>not</em> needed).
</p>
</li>
<li> <p><code><a href="#topic+Matlab">Matlab</a></code> - To start MATLAB and communicate with it from <span class="rlang"><b>R</b></span>.
</p>
</li></ol>



<h3>Miscellaneous</h3>

<p>A related initiative is <em>RMatlab</em> by Duncan Temple Lang
and Omegahat.  It provides a bi-directional interface between the
<span class="rlang"><b>R</b></span> and MATLAB languages. For more details, see
<a href="https://www.omegahat.net/RMatlab/">https://www.omegahat.net/RMatlab/</a>.
To call R from MATLAB on Windows (only), see <em>MATLAB R-link</em>
by Robert Henson available at the MATLAB Central File Exchange
(<a href="https://www.mathworks.com/matlabcentral/fileexchange/5051-matlab-r-link">https://www.mathworks.com/matlabcentral/fileexchange/5051-matlab-r-link</a>).
</p>


<h3>How to cite this package</h3>

<p>Whenever using this package, please cite as<br />
</p>



<h3>Troubleshooting</h3>

<p><b>In general</b>:<br />
For trouble shooting in general, rerun erroneous function with
verbose/debug messages turned on. For <code>readMat()</code> and <code>writeMat()</code>
see their help. For communication with a MATLAB server, use
</p>
<pre>
   matlab &lt;- Matlab()
   setVerbose(matlab, threshold = -2)
  </pre>
<p>The lower the threshold is the more information you will see.<br />
</p>
<p><b>Cannot connect to MATLAB</b>:<br />
If R fails to connect to MATLAB, make sure to try the example in
help(Matlab) first.  Make sure that the MATLAB server is running
before trying to connect to it from R first.  If MATLAB is running
but <code>open()</code> times out, make sure MATLAB is listening to the
same port that R is trying to connect to.  If that does not help,
try to increase the time-out limit, see help(open.Matlab).<br />
</p>
<p><b>Expected an 'answer' from MATLAB, but kept receiving nothing.</b>:<br />
When launching a really long MATLAB process by <code>evaluate()</code>, you
may get the above error message.<br />
<em>Reason:</em> This happens because <code>evaluate()</code> expect a reply
from MATLAB as soon as MATLAB is done. The waiting should be &quot;blocked&quot;,
i.e. it should wait until it receives something. For unknown reasons,
this is not always happening. The workaround we have implemented is to
try <code>readResult/maxTries</code> waiting <code>readResult/interval</code> seconds
in-between.<br />
<em>Solution:</em>
Increase the total waiting time by setting the above options, e.g.
</p>
<pre>
   setOption(matlab, "readResult/interval", 10)     # Default is 1 second
   setOption(matlab, "readResult/maxTries", 30 * (60 / 10)) # ~30 minutes
  </pre>


<h3>Wishlist</h3>

<p>Here is a list of features that would be useful, but which I have
too little time to add myself. Contributions are appreciated.
</p>

<ul>
<li><p> Add a function, say, <code>Matlab$createShortcut()</code> which
creates a Windows shortcut to start the MATLAB server
by double clicking it. It should be possible to create
it in the current directory or to the Desktop.
Maybe it is possible to do this upon installation and
even to a Start -&gt; All Programs -&gt; R menu.
</p>
</li>
<li><p> To improve security, update the MatlabServer.m script to
allow the user to specify a &quot;password&quot; to be send upon
connection from R in order for MATLAB to accept the
connection. This password should be possible to specify
from the command line when starting MATLAB. If not given,
no password is required.
</p>
</li>
<li><p> Add additional methods to the Matlab class. For instance,
inline function in MATLAB could have its own method.
</p>
</li>
<li><p> Wrap up common MATLAB commands as methods of the Matlab
class, e.g. <code>who(matlab)</code>, <code>clear(matlab)</code> etc.
Can this be done automatically using &quot;reflection&quot;, so
that required arguments are automatically detected?
</p>
</li>
<li><p> Add access to MATLAB variables via <code>"$"</code> and
<code>"$&lt;-"</code>, e.g. <code>matlab$A</code> and
<code>matlab$A &lt;- 1234</code>. Is this wanted?
Maybe the same for functions, e.g. <code>matlab$dice(1000)</code>.
Is it possible to return multiple return values?
</p>
</li></ul>

<p>If you consider implement some of the above, make sure it is not
already implemented by downloading the latest &quot;devel&quot; version!
</p>


<h3>Acknowledgments</h3>

<p>Thanks to the following people who contributed with valuable
feedback, suggestions, code and more:
</p>

<ul>
<li><p> Patrick Drechsler, Biocenter, University of Wuerzburg.
</p>
</li>
<li><p> Spencer Graves.
</p>
</li>
<li><p> Andy Jacobson, Atmospheric and Oceanic Sciences Program,
Princeton University.
</p>
</li>
<li><p> Jason Riedy, Computer Science Division,
University of California, Berkeley.
</p>
</li>
<li><p> Chris Sims, Department of Economics, Princeton University.
</p>
</li>
<li><p> Frank Stephen, National Renewable Energy Laboratory.
</p>
</li>
<li><p> Yichun Wei, Department of Biological Sciences,
University of Southern California.
</p>
</li>
<li><p> Wang Yu, ECE Department, Iowa State University.
</p>
</li></ul>



<h3>License</h3>

<p>The releases of this package is licensed under
LGPL version 2.1 or newer.
</p>
<p>The development code of the packages is under a private license
(where applicable) and patches sent to the author fall under the
latter license, but will be, if incorporated, released under the
&quot;release&quot; license above.
</p>


<h3>References</h3>

<p>[1] H. Bengtsson, <em>The R.oo package - Object-Oriented Programming with References Using Standard R Code</em>, In Kurt Hornik, Friedrich Leisch and Achim Zeileis, editors, Proceedings of the 3rd International Workshop on Distributed Statistical Computing (DSC 2003), March 20-22, Vienna, Austria. <a href="https://www.r-project.org/conferences/DSC-2003/Proceedings/">https://www.r-project.org/conferences/DSC-2003/Proceedings/</a>
<br />
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>

<hr>
<h2 id='readMat'>Reads a MAT file structure from a connection or a file</h2><span id='topic+readMat.default'></span><span id='topic+readMat'></span>

<h3>Description</h3>

<p>Reads a MAT file structure from a connection or a file.
Both the MAT version 4 and MAT version 5 file formats are
supported. The implementation is based on [1-5].
Note: Do not mix up version numbers for the MATLAB software and
the MATLAB file formats.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## Default S3 method:
readMat(con, maxLength=NULL, fixNames=TRUE, drop=c("singletonLists"),
  sparseMatrixClass=c("Matrix", "SparseM", "matrix"), verbose=FALSE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="readMat_+3A_con">con</code></td>
<td>
<p>Binary <code><a href="base.html#topic+connections">connection</a></code> from which the MAT file structure
should be read.
If a <code><a href="base.html#topic+character">character</a></code> string, it is interpreted as filename, which then
will be opened (and closed afterwards).
If a <code><a href="base.html#topic+raw">raw</a></code> <code><a href="base.html#topic+vector">vector</a></code>, it will be read via as a raw binary <code><a href="base.html#topic+connections">connection</a></code>.
</p>
</td></tr>
<tr><td><code id="readMat_+3A_maxlength">maxLength</code></td>
<td>
<p>The maximum number of bytes to be read from the input
stream, which should be equal to the length of the MAT file structure.
If <code>NULL</code>, data will be read until End Of File has been reached.</p>
</td></tr>
<tr><td><code id="readMat_+3A_fixnames">fixNames</code></td>
<td>
<p>If <code><a href="base.html#topic+logical">TRUE</a></code>, underscores within names of MATLAB variables
and fields are converted to periods.</p>
</td></tr>
<tr><td><code id="readMat_+3A_drop">drop</code></td>
<td>
<p>A <code><a href="base.html#topic+character">character</a></code> <code><a href="base.html#topic+vector">vector</a></code> specifying cases when one or more dimensions
of elements should be dropped in order to decrease the amount of &quot;nestedness&quot;
of the returned data structure.  This only applies to the MAT v5 file format.</p>
</td></tr>
<tr><td><code id="readMat_+3A_sparsematrixclass">sparseMatrixClass</code></td>
<td>
<p>If <code>"matrix"</code>, a sparse matrix is expanded to
a regular <code><a href="base.html#topic+matrix">matrix</a></code>.  If either <code>"Matrix"</code> (default) or <code>"SparseM"</code>,
the sparse matrix representation by the package of the same name will be used.
These packages are only loaded if the a sparse matrix is read.</p>
</td></tr>
<tr><td><code id="readMat_+3A_verbose">verbose</code></td>
<td>
<p>Either a <code><a href="base.html#topic+logical">logical</a></code>, a <code><a href="base.html#topic+numeric">numeric</a></code>, or a <code><a href="R.utils.html#topic+Verbose">Verbose</a></code>
object specifying how much verbose/debug information is written to
standard output. If a Verbose object, how detailed the information is
is specified by the threshold level of the object. If a numeric, the
value is used to set the threshold of a new Verbose object. If <code><a href="base.html#topic+logical">TRUE</a></code>,
the threshold is set to -1 (minimal). If <code><a href="base.html#topic+logical">FALSE</a></code>, no output is written.
</p>
</td></tr>
<tr><td><code id="readMat_+3A_...">...</code></td>
<td>
<p>Not used.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns a named <code><a href="base.html#topic+list">list</a></code> structure containing all variables in the
MAT file structure.
</p>


<h3>Speed performance</h3>

<p>This function uses a MAT file parser implemented completely using
pure R. For MAT files containing large vectorized objects, for instance
long vectors and large matrices, the R implementation is indeed fast
enough because it can read and parse each such objects in one go.
</p>
<p>On the other hand, for MAT files containing a large number of small
objects, e.g. a large number of cell structures, there will be a
significant slowdown, because each of the small objects has to be
parsed individually.
In such cases, if possible, try to (re)save the data in MATLAB
using larger (&quot;more vectorized&quot;) objects.
</p>


<h3>MAT cell structures</h3>

<p>For the MAT v5 format, <em>cell</em> structures are read into
<span class="rlang"><b>R</b></span> as a <code><a href="base.html#topic+list">list</a></code> structure.
</p>


<h3>Unicode strings</h3>

<p>Recent versions of MATLAB store some strings using Unicode
encodings.  If the R installation supports <code><a href="base.html#topic+iconv">iconv</a></code>,
these strings will be read correctly.  Otherwise non-ASCII codes
are converted to NA.  Saving to an earlier file format version
may avoid this problem as well.
</p>


<h3>Reading compressed MAT files</h3>

<p>From MATLAB v7, <em>compressed</em> MAT version 5 files are used by
default [3-5], which is supported by this function.
</p>
<p>If for some reason it fails, use <code>save -V6</code> in MATLAB to write
non-compressed MAT v5 files (sic!).
</p>


<h3>About MAT files saved in MATLAB using '-v7.3'</h3>

<p>MAT v7.3 files, saved using for instance <code>save('foo.mat', '-v7.3')</code>,
stores the data in the Hierarchical Data Format (HDF5) [6, 7], which
is a format not supported by this function/package.
However, there exist other R packages that can parse HDF5, e.g.
CRAN package <span class="pkg">h5</span> and Bioconductor package <span class="pkg">rhdf5</span>.
</p>


<h3>Reading MAT file structures input streams</h3>

<p>Reads a MAT file structure from an input stream, either until End of File
is detected or until <code>maxLength</code> bytes has been read.
Using <code>maxLength</code> it is possible to read MAT file structure over
socket connections and other non-terminating input streams. In such cases
the <code>maxLength</code> has to be communicated before sending the actual
MAT file structure.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson.
The internal MAT v4 reader was written by
Andy Jacobson (Princeton University).
Support for reading sparse matrices, UTF-encoded strings and
compressed files, was contributed by Jason Riedy (UC Berkeley).
</p>


<h3>References</h3>

<p>[1] The MathWorks Inc., <em>MATLAB - MAT-File Format, version 5</em>, June 1999.<br />
[2] The MathWorks Inc., <em>MATLAB - Application Program Interface Guide, version 5</em>, 1998.<br />
[3] The MathWorks Inc., <em>MATLAB - MAT-File Format, version 7</em>, September 2009.<br />
[4] The MathWorks Inc., <em>MATLAB - MAT-File Format, version R2012a</em>, September 2012.<br />
[5] The MathWorks Inc., <em>MATLAB - MAT-File Format, version R2015b</em>, September 2015.<br />
[6] The MathWorks Inc., <em>MATLAB - MAT-File Versions</em>, December 2015.
<a href="https://www.mathworks.com/help/matlab/import_export/mat-file-versions.html">https://www.mathworks.com/help/matlab/import_export/mat-file-versions.html</a><br />
[7] Undocumented Matlab, <em>Improving save performance</em>, May 2013.
<a href="https://undocumentedmatlab.com/articles/improving-save-performance/">https://undocumentedmatlab.com/articles/improving-save-performance/</a><br />
[8] J. Gilbert et al., Sparse Matrices in MATLAB: Design and Implementation, SIAM J. Matrix Anal. Appl., 1992.
<a href="https://www.mathworks.com/help/pdf_doc/otherdocs/simax.pdf">https://www.mathworks.com/help/pdf_doc/otherdocs/simax.pdf</a><br />
[9] J. Burkardt, <em>HB Files: Harwell Boeing Sparse Matrix File Format</em>, Apr 2010.
<a href="https://people.sc.fsu.edu/~jburkardt/data/hb/hb.html">https://people.sc.fsu.edu/~jburkardt/data/hb/hb.html</a>
</p>


<h3>See Also</h3>

<p><code><a href="#topic+writeMat">writeMat</a></code>().
</p>


<h3>Examples</h3>

<pre><code class='language-R'>path &lt;- system.file("mat-files", package = "R.matlab")
pathname &lt;- file.path(path, "ABC.mat")
data &lt;- readMat(pathname)
print(data)
</code></pre>

<hr>
<h2 id='readResult.Matlab'>(internal) Reads results from the MATLAB server</h2><span id='topic+readResult.Matlab'></span><span id='topic+Matlab.readResult'></span><span id='topic+readResult+2CMatlab-method'></span>

<h3>Description</h3>

<p>(internal) Reads results from the MATLAB server.
</p>
<p><em>This method is for internal use only.</em>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
readResult(this, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="readResult.Matlab_+3A_...">...</code></td>
<td>
<p>Not used.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns an <span class="rlang"><b>R</b></span> object.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='setFunction.Matlab'>Defines a MATLAB function</h2><span id='topic+setFunction.Matlab'></span><span id='topic+Matlab.setFunction'></span><span id='topic+setFunction+2CMatlab-method'></span>

<h3>Description</h3>

<p>Creates an M-file on the MATLAB server machine (in the working directory)
containing the specified MATLAB function definition.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
setFunction(this, code, name=NULL, collapse="\n", ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="setFunction.Matlab_+3A_code">code</code></td>
<td>
<p>The MATLAB function definition.</p>
</td></tr>
<tr><td><code id="setFunction.Matlab_+3A_name">name</code></td>
<td>
<p>Optional name of the function, which will defined the
name of the M-file where the function is stored. If <code><a href="base.html#topic+NULL">NULL</a></code>,
the name is extracted from the code.</p>
</td></tr>
<tr><td><code id="setFunction.Matlab_+3A_collapse">collapse</code></td>
<td>
<p>The string that the code lines, if there are more than
one, is going to be concatenated with.</p>
</td></tr>
<tr><td><code id="setFunction.Matlab_+3A_...">...</code></td>
<td>
<p>Not used.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns nothing.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: code &lt;- c(
  "function [win, aver] = dice(B)",
  "%Play the dice game B times",
  "gains = [-1, 2, -3, 4, -5, 6];",
  "plays = unidrnd(6, B, 1);",
  "win = sum(gains(plays));",
  "aver = win;"
)

setFunction(matlab, code)
evaluate(matlab, "[w, a] = dice(1000);")
res &lt;- getVariable(matlab, c("w", "a"))
print(res)

## End(Not run)</code></pre>

<hr>
<h2 id='setOption.Matlab'>Sets the value of an option</h2><span id='topic+setOption.Matlab'></span><span id='topic+Matlab.setOption'></span><span id='topic+setOption+2CMatlab-method'></span>

<h3>Description</h3>

<p>Sets the value of an option where the option is specified like a file pathname, e.g.
&quot;readResult/maxTries&quot;. See the <a href="R.utils.html#topic+Options">Options</a> class for details.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
setOption(this, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="setOption.Matlab_+3A_...">...</code></td>
<td>
<p>Arguments passed to
<code><a href="R.utils.html#topic+getOption.Options">setOption()</a></code>
of the Options class.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns the previous value of the option.
</p>


<h3>Available options</h3>


<ul>
<li><p>readResult/maxTriesThe maximum number of times the connection
is check for an answer from the MATLAB server before giving up.
Default values is 30 times.
</p>
</li>
<li><p>readResult/intervalThe interval in seconds between each poll
for an answer.  Default interval is 1 (second).
</p>
</li></ul>

<p>With default values of the above options, the <span class="rlang"><b>R</b></span> MATLAB client waits
30 seconds for a reply from the MATLAB server before giving up.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p><code><a href="#topic+getOption.Matlab">*getOption</a>()</code>.
For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='setVariable.Matlab'>Sets one or several MATLAB variables</h2><span id='topic+setVariable.Matlab'></span><span id='topic+Matlab.setVariable'></span><span id='topic+setVariable+2CMatlab-method'></span>

<h3>Description</h3>

<p>Sets one or several <span class="rlang"><b>R</b></span> variables on the MATLAB server.
The transfer of the data can be done locally via a temporary file
(<code>remote = FALSE</code>) or through the socket <code><a href="base.html#topic+connections">connection</a></code> (<code>remote = TRUE</code>),
which is always available.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
setVariable(this, ..., remote=this$remote)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="setVariable.Matlab_+3A_...">...</code></td>
<td>
<p>Named <span class="rlang"><b>R</b></span> variables to be set in MATLAB.</p>
</td></tr>
<tr><td><code id="setVariable.Matlab_+3A_remote">remote</code></td>
<td>
<p>If <code><a href="base.html#topic+logical">TRUE</a></code> the variables are transferred on the
socket <code><a href="base.html#topic+connections">connection</a></code>, otherwise they are transferred via a temporary file.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns nothing. If the MATLAB server did not received the variables
successfully an exception is thrown.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='setVerbose.Matlab'>Sets the verbose level to get more details about the MATLAB access</h2><span id='topic+setVerbose.Matlab'></span><span id='topic+Matlab.setVerbose'></span><span id='topic+setVerbose+2CMatlab-method'></span>

<h3>Description</h3>

<p>Sets the verbose level to get more details about the MATLAB access.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
setVerbose(this, threshold=0, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="setVerbose.Matlab_+3A_threshold">threshold</code></td>
<td>
<p>A threshold that the <code>level</code> argument
of any write method has to be equal to or larger than in order to the
message being written.
Thus, the lower the threshold is the more and more details will be
outputted. If a large <code><a href="base.html#topic+numeric">numeric</a></code> or <code><a href="base.html#topic+logical">FALSE</a></code>, no verbose output will be
given.</p>
</td></tr>
<tr><td><code id="setVerbose.Matlab_+3A_...">...</code></td>
<td>
<p>Not used.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>If the threshold is set to zero (default) general comments about the
MATLAB access is given, such as the MATLAB server is started etc.
If the threshold is <code>-1</code>, details about the communication with the
MATLAB server is given.
If the threshold is <code>-2</code>, low-level details about the communication
with the MATLAB server is given, such as what commands are sent etc.
</p>


<h3>Value</h3>

<p>Returns the previous threshold value (an <code><a href="base.html#topic+integer">integer</a></code>) used.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='writeCommand.Matlab'>(internal) Writes (sends) an R-to-MATLAB command to the MATLAB server</h2><span id='topic+writeCommand.Matlab'></span><span id='topic+Matlab.writeCommand'></span><span id='topic+writeCommand+2CMatlab-method'></span>

<h3>Description</h3>

<p>(internal) Writes (sends) an R-to-MATLAB command to the MATLAB server.
</p>
<p><em>This method is for internal use only.</em>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'Matlab'
writeCommand(this, cmd, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="writeCommand.Matlab_+3A_cmd">cmd</code></td>
<td>
<p>A <code><a href="base.html#topic+character">character</a></code> string specifying the command.</p>
</td></tr>
<tr><td><code id="writeCommand.Matlab_+3A_...">...</code></td>
<td>
<p>Not used.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Returns nothing.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>See Also</h3>

<p>For more information see <code><a href="#topic+Matlab">Matlab</a></code>.
</p>

<hr>
<h2 id='writeMat'>Writes a MAT file structure</h2><span id='topic+writeMat.default'></span><span id='topic+writeMat'></span>

<h3>Description</h3>

<p>This function takes the given variables (<code>...</code>) and places them in a
MAT file structure, which is then written to a binary connection.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## Default S3 method:
writeMat(con, ..., fixNames=TRUE, matVersion="5", onWrite=NULL, verbose=FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="writeMat_+3A_con">con</code></td>
<td>
<p>Binary <code><a href="base.html#topic+connections">connection</a></code> to which the MAT file structure should be
written to. A string is interpreted as filename, which then will be
opened (and closed afterwards).</p>
</td></tr>
<tr><td><code id="writeMat_+3A_...">...</code></td>
<td>
<p><em>Named</em> variables to be written where the names
must be unique.</p>
</td></tr>
<tr><td><code id="writeMat_+3A_fixnames">fixNames</code></td>
<td>
<p>If <code><a href="base.html#topic+logical">TRUE</a></code>, periods within names of R variables
and fields are converted to underscores.</p>
</td></tr>
<tr><td><code id="writeMat_+3A_matversion">matVersion</code></td>
<td>
<p>A <code><a href="base.html#topic+character">character</a></code> string specifying what MAT file format
version to be written to the connection. If <code>"5"</code>, a MAT v5 file
structure is written. No other formats are currently supported.</p>
</td></tr>
<tr><td><code id="writeMat_+3A_onwrite">onWrite</code></td>
<td>
<p>Function to be called just before starting to write to
connection. Since the MAT file structure does not contain information
about the total size of the structure this argument makes it possible
to first write the structure size (in bytes) to the connection.</p>
</td></tr>
<tr><td><code id="writeMat_+3A_verbose">verbose</code></td>
<td>
<p>Either a <code><a href="base.html#topic+logical">logical</a></code>, a <code><a href="base.html#topic+numeric">numeric</a></code>, or a <code><a href="R.utils.html#topic+Verbose">Verbose</a></code>
object specifying how much verbose/debug information is written to
standard output. If a Verbose object, how detailed the information is
is specified by the threshold level of the object. If a numeric, the
value is used to set the threshold of a new Verbose object. If <code><a href="base.html#topic+logical">TRUE</a></code>,
the threshold is set to -1 (minimal). If <code><a href="base.html#topic+logical">FALSE</a></code>, no output is written
(and neither is the <a href="R.utils.html#topic+R.utils-package">R.utils</a> package required).
</p>
</td></tr>
</table>
<p>Note that <code>...</code> must <em>not</em> contain variables with names equal
to the arguments <code>matVersion</code> and <code>onWrite</code>, which were chosen
because we believe they are quite unique to this write method.
</p>


<h3>Value</h3>

<p>Returns (invisibly) the number of bytes written. Any bytes written by
any onWrite function are <em>not</em> included in this count.
</p>


<h3>Limitations</h3>

<p>Currently only the uncompressed MAT version 5 file format [6] is
supported, that is, compressed MAT files cannot be written (only read).
</p>
<p>Moreover, the maximum variable size supported by the MAT version 5
file format is 2^31 bytes [6].  In R, this limitation translates to
2^31-1 bytes, which corresponds to for instance an integer object
with 536870912 elements or double object with 268435456 elements.
</p>


<h3>Details on onWrite()</h3>

<p>If specified, the <code>onWrite()</code> function is called before the
data is written to the connection.  This function must take a <code><a href="base.html#topic+list">list</a></code>
argument as the first argument.  This will hold the element <code>con</code>
which is the opened <code><a href="base.html#topic+connections">connection</a></code> to be written to.
It will also hold the element <code>length</code>, which specified the
number of bytes to be written.  See example for an illustration.
</p>
<p><em>Note</em>, in order to provide the number of bytes before actually
writing the data, a two-pass procedure has to be taken, where the
first pass is imitating a complete writing without writing anything
to the connection but only counting the total number of bytes. Then
in the second pass, after calling <code>onWrite()</code>, the data is written.
</p>


<h3>Author(s)</h3>

<p>Henrik Bengtsson</p>


<h3>References</h3>

<p>[1] The MathWorks Inc., <em>MATLAB - MAT-File Format, version 5</em>, June 1999.<br />
[2] The MathWorks Inc., <em>MATLAB - Application Program Interface Guide, version 5</em>, 1998.<br />
[3] The MathWorks Inc., <em>MATLAB - MAT-File Format, version 7</em>, September 2009.<br />
[4] The MathWorks Inc., <em>MATLAB - MAT-File Format, version R2012a</em>, September 2012.<br />
[5] The MathWorks Inc., <em>MATLAB - MAT-File Format, version R2015b</em>, September 2015.<br />
[6] The MathWorks Inc., <em>MATLAB - MAT-File Versions</em>, December 2015.
<a href="https://www.mathworks.com/help/matlab/import_export/mat-file-versions.html">https://www.mathworks.com/help/matlab/import_export/mat-file-versions.html</a><br />
</p>


<h3>See Also</h3>

<p><code><a href="#topic+readMat">readMat</a></code>().
</p>


<h3>Examples</h3>

<pre><code class='language-R'>A &lt;- matrix(1:27, ncol = 3)
B &lt;- as.matrix(1:10)
C &lt;- array(1:18, dim = c(2, 3, 3))

filename &lt;- paste(tempfile(), ".mat", sep = "")

writeMat(filename, A = A, B = B, C = C)
data &lt;- readMat(filename)
str(data)

X &lt;- list(A = A, B = B, C = C)
stopifnot(all.equal(X, data[names(X)]))

unlink(filename)


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# All objects written must be named uniquely
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
tryCatch({
  # Named
  writeMat(filename, A = A)
  # Not named
  writeMat(filename, A)
}, error = function(ex) {
  cat("ERROR:", ex$message, "\n")
})


tryCatch({
  # Uniquely named
  writeMat(filename, A = A, B = B, C = C)
  # Not uniquely named
  writeMat(filename, A = A, B = B, A = C)
}, error = function(ex) {
  cat("ERROR:", ex$message, "\n")
})


## Not run: 
# When writing to a stream connection the receiver needs to know on
# beforehand how many bytes are available. This can be done by using
# the 'onWrite' argument.
onWrite &lt;- function(x)
  writeBin(x$length, con = x$con, size = 4, endian = "little")
  writeMat(con, A = A, B = B, onWrite = onWrite)

## End(Not run)
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
