<!DOCTYPE html><html><head><title>Help for package CARBayesST</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {CARBayesST}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#CARBayesST-package'>
<p>Spatio-Temporal Generalised Linear Mixed Models For Areal Unit Data</p></a></li>
<li><a href='#coef.CARBayesST'>
<p>Extract the regression coefficients from a model.</p></a></li>
<li><a href='#fitted.CARBayesST'>
<p>Extract the fitted values from a model.</p></a></li>
<li><a href='#logLik.CARBayesST'>
<p>Extract the estimated loglikelihood from a fitted model.</p></a></li>
<li><a href='#model.matrix.CARBayesST'>
<p>Extract the model (design) matrix from a model.</p></a></li>
<li><a href='#MVST.CARar'>
<p>Fit a multivariate spatio-temporal generalised linear mixed model to data, with a multivariate spatio-temporal autoregressive process.</p></a></li>
<li><a href='#print.CARBayesST'>
<p>Print a summary of the fitted model to the screen.</p></a></li>
<li><a href='#residuals.CARBayesST'>
<p>Extract the residuals from a model.</p></a></li>
<li><a href='#ST.CARadaptive'>
<p>Fit a spatio-temporal generalised linear mixed model to data, with a spatio-temporal</p>
autoregressive process that has an adaptive autocorrelation stucture.</a></li>
<li><a href='#ST.CARanova'>
<p>Fit a spatio-temporal generalised linear mixed model to data, with spatial and  temporal main</p>
effects and a spatio-temporal interaction.</a></li>
<li><a href='#ST.CARar'>
<p>Fit a spatio-temporal generalised linear mixed model to data, with a spatio-temporal</p>
autoregressive process.</a></li>
<li><a href='#ST.CARclustrends'>
<p>Fit a spatio-temporal generalised linear mixed model to data, with a clustering</p>
of temporal trend functions and a temporally common spatial surface.</a></li>
<li><a href='#ST.CARlinear'>
<p>Fit a spatio-temporal generalised linear mixed model to data, where the spatial</p>
units have linear time trends with spatially varying intercepts and slopes.</a></li>
<li><a href='#ST.CARlocalised'>
<p>Fit a spatio-temporal generalised linear mixed model to data, with a spatio-temporal</p>
autoregressive process and a piecewise constant intercept term.</a></li>
<li><a href='#ST.CARsepspatial'>
<p>Fit a spatio-temporal generalised linear mixed model to data, with a common</p>
temporal main effect and separate spatial surfaces with individual variances.</a></li>
<li><a href='#W.estimate'><p>Estimate an appropriate neighbourhood matrix for a set of spatial data using a baseline neighbourhood matrix and a  graph based optimisation algorithm.</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Spatio-Temporal Generalised Linear Mixed Models for Areal Unit
Data</td>
</tr>
<tr>
<td>Version:</td>
<td>4.0</td>
</tr>
<tr>
<td>Date:</td>
<td>2023-10-31</td>
</tr>
<tr>
<td>Author:</td>
<td>Duncan Lee, Alastair Rushworth, Gary Napier and William Pettersson </td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Duncan Lee &lt;Duncan.Lee@glasgow.ac.uk&gt;</td>
</tr>
<tr>
<td>Description:</td>
<td>Implements a class of univariate and multivariate spatio-temporal generalised linear mixed models for areal unit data, with inference in a Bayesian setting using Markov chain Monte Carlo (MCMC) simulation. The response variable can be binomial, Gaussian, or Poisson, but for some models only the binomial and Poisson data likelihoods are available. The spatio-temporal autocorrelation is modelled by  random effects, which are assigned conditional autoregressive (CAR) style prior distributions. A number of different random effects structures are available, including models similar to Rushworth et al. (2014) &lt;<a href="https://doi.org/10.1016%2Fj.sste.2014.05.001">doi:10.1016/j.sste.2014.05.001</a>&gt;. Full details are given in the vignette accompanying this package. The creation and development of this package was supported by the Engineering and Physical Sciences Research Council  (EPSRC) grants EP/J017442/1 and EP/T004878/1 and the Medical Research Council (MRC) grant MR/L022184/1.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a> | <a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a> [expanded from: GPL (&ge; 2)]</td>
</tr>
<tr>
<td>Depends:</td>
<td>MASS, R (&ge; 3.5.0), Rcpp (&ge; 0.11.5)</td>
</tr>
<tr>
<td>Imports:</td>
<td>CARBayesdata, coda, dplyr, GGally, ggplot2, gridExtra, gtools,
leaflet, matrixStats, MCMCpack, parallel, sf, spam, spdep,
stats, truncdist, truncnorm, utils</td>
</tr>
<tr>
<td>LinkingTo:</td>
<td>Rcpp</td>
</tr>
<tr>
<td>LazyLoad:</td>
<td>yes</td>
</tr>
<tr>
<td>ByteCompile:</td>
<td>yes</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://github.com/duncanplee/CARBayesST">https://github.com/duncanplee/CARBayesST</a></td>
</tr>
<tr>
<td>BugReports:</td>
<td><a href="https://github.com/duncanplee/CARBayesST/issues">https://github.com/duncanplee/CARBayesST/issues</a></td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>yes</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2023-10-30 15:43:55 UTC; duncanlee</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2023-10-30 16:40:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='CARBayesST-package'>
Spatio-Temporal Generalised Linear Mixed Models For Areal Unit Data
</h2><span id='topic+CARBayesST-package'></span><span id='topic+CARBayesST'></span>

<h3>Description</h3>

<p>Implements a class of univariate and multivariate spatio-temporal generalised 
linear mixed models for areal unit data, with inference in a Bayesian setting 
using Markov chain Monte Carlo (MCMC) simulation. The response variable can be 
binomial, Gaussian or Poisson, but for some models only the binomial and Poisson 
data likelihoods are available. The spatio-temporal autocorrelation is modelled 
by random effects,  which are assigned conditional autoregressive (CAR) style 
prior distributions. A number of different random effects structures are available, 
and full details are given in the vignette accompanying this package and the 
references below. The creation and development of this package was supported by the 
Engineering and Physical Sciences Research Council  (EPSRC) grants EP/J017442/1 and
EP/T004878/1 and the Medical Research Council (MRC) grant MR/L022184/1.
</p>


<h3>Details</h3>


<table>
<tr>
 <td style="text-align: left;">
Package: </td><td style="text-align: left;"> CARBayesST</td>
</tr>
<tr>
 <td style="text-align: left;">
Type: </td><td style="text-align: left;"> Package</td>
</tr>
<tr>
 <td style="text-align: left;">
Version: </td><td style="text-align: left;"> 4.0</td>
</tr>
<tr>
 <td style="text-align: left;">
Date: </td><td style="text-align: left;"> 2023-10-31</td>
</tr>
<tr>
 <td style="text-align: left;">
License: </td><td style="text-align: left;"> GPL (&gt;= 2)</td>
</tr>
<tr>
 <td style="text-align: left;">
</td>
</tr>

</table>



<h3>Author(s)</h3>

<p>Author: Duncan Lee, Alastair Rushworth, Gary Napier and William Pettersson 
</p>
<p>Maintainer: Duncan Lee &lt;Duncan.Lee@glasgow.ac.uk&gt;
</p>


<h3>References</h3>

<p>Bernardinelli, L., D. Clayton, C.Pascuto, C.Montomoli, M.Ghislandi, and M. Songini
(1995). Bayesian analysis of space-time variation in disease risk. Statistics in 
Medicine, 14, 2433-2443.
</p>
<p>Knorr-Held, L. (2000). Bayesian modelling of inseparable space-time variation in disease risk. 
Statistics in Medicine, 19, 2555-2567.
</p>
<p>Lee, D and Lawson, C  (2016). Quantifying the spatial inequality and temporal trends in
maternal smoking rates in Glasgow, Annals of Applied Statistics, 10, 1427-1446.
</p>
<p>Lee, D and Rushworth, A and Napier, G (2018). Spatio-Temporal Areal Unit Modeling in 
R with Conditional Autoregressive Priors Using the CARBayesST Package, 
Journal of Statistical Software, 84, 9, 1-39.
</p>
<p>Lee, D and Meeks, K and Pettersson, W (2021). Improved inference for areal unit count data using graph-based 
optimisation. Statistics and Computing, 31:51.
</p>
<p>Lee D, Robertson C, and Marques, D (2022). Quantifying the small-area spatio-temporal 
dynamics of the Covid-19 pandemic in Scotland during a period with limited testing 
capacity, Spatial Statistics, https://doi.org/10.1016/j.spasta.2021.100508.
</p>
<p>Napier, G, D. Lee, C. Robertson, A. Lawson, and K. Pollock (2016). A model to estimate the 
impact of changes in MMR vaccination uptake on inequalities in measles susceptibility in 
Scotland, Statistical Methods in Medical Research, 25, 1185-1200.
</p>
<p>Napier, G., Lee, D., Robertson, C., and Lawson, A. (2019). A Bayesian space-time 
model for clustering areal units based on their disease trends, Biostatistics,
20, 681-697.
</p>
<p>Rushworth, A., D. Lee, and R. Mitchell (2014). A spatio-temporal model for estimating the 
long-term effects of air pollution on respiratory hospital admissions in Greater London. 
Spatial and Spatio-temporal Epidemiology 10, 29-38.
</p>
<p>Rushworth, A., Lee, D., and Sarran, C (2017).  An adaptive spatio-temporal smoothing model for 
estimating trends and step changes in disease risk. Journal of the Royal Statistical Society 
Series C, 66, 141-157.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## See the examples in the function specific help files and in the vignette
## accompanying this package.
</code></pre>

<hr>
<h2 id='coef.CARBayesST'>
Extract the regression coefficients from a model.
</h2><span id='topic+coef.CARBayesST'></span>

<h3>Description</h3>

<p>This function takes a CARBayesST object and returns the vector of estimated
regression coefficients (posterior means).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>    ## S3 method for class 'CARBayesST'
coef(object, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="coef.CARBayesST_+3A_object">object</code></td>
<td>

<p>A CARBayesST fitted model object.
</p>
</td></tr>
<tr><td><code id="coef.CARBayesST_+3A_...">...</code></td>
<td>

<p>Ignored.
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Duncan Lee
</p>

<hr>
<h2 id='fitted.CARBayesST'>
Extract the fitted values from a model.
</h2><span id='topic+fitted.CARBayesST'></span>

<h3>Description</h3>

<p>This function takes a CARBayesST object and returns the vector of fitted
values (posterior means).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>    ## S3 method for class 'CARBayesST'
fitted(object, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="fitted.CARBayesST_+3A_object">object</code></td>
<td>

<p>A CARBayesST fitted model object.
</p>
</td></tr>
<tr><td><code id="fitted.CARBayesST_+3A_...">...</code></td>
<td>

<p>Ignored.
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Duncan Lee
</p>

<hr>
<h2 id='logLik.CARBayesST'>
Extract the estimated loglikelihood from a fitted model.
</h2><span id='topic+logLik.CARBayesST'></span>

<h3>Description</h3>

<p>This function takes a CARBayesST object and returns the estimated loglikelihood
(posterior means).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>    ## S3 method for class 'CARBayesST'
logLik(object, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="logLik.CARBayesST_+3A_object">object</code></td>
<td>

<p>A CARBayesST fitted model object.
</p>
</td></tr>
<tr><td><code id="logLik.CARBayesST_+3A_...">...</code></td>
<td>

<p>Ignored.
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Duncan Lee
</p>

<hr>
<h2 id='model.matrix.CARBayesST'>
Extract the model (design) matrix from a model.
</h2><span id='topic+model.matrix.CARBayesST'></span>

<h3>Description</h3>

<p>This function takes a CARBayesST object and returns the design matrix.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>    ## S3 method for class 'CARBayesST'
model.matrix(object, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="model.matrix.CARBayesST_+3A_object">object</code></td>
<td>

<p>A CARBayesST fitted model object.
</p>
</td></tr>
<tr><td><code id="model.matrix.CARBayesST_+3A_...">...</code></td>
<td>

<p>Ignored.
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Duncan Lee
</p>

<hr>
<h2 id='MVST.CARar'>
Fit a multivariate spatio-temporal generalised linear mixed model to data, with a multivariate spatio-temporal autoregressive process.
</h2><span id='topic+MVST.CARar'></span>

<h3>Description</h3>

<p>Fit a multivariate spatio-temporal generalised linear mixed model to 
multivariate areal unit data, where the response variable can be binomial, 
Gaussian or Poisson. The linear predictor is modelled by known covariates and a 
vector of random effects. The latter allows for correlations over: (i) K areal
units; (ii) N time periods; and (iii) J outcomes. These random effects are 
modelled by either a multivariate first order autoregressive time series 
process or a multivariate second order autoregressive time series process. 
In both cases the spatial and between outcome correlation is modelled via the 
precision matrix, and the spatial correlation is represented by the 
conditional autoregressive (CAR) prior proposed by Leroux et al. (2000). In 
contrast, the between outcome correlation structure is estimated from the data,
and no prior form is assumed. Missing values are allowed in the response in this 
model, and are sampled from in the model using data augmentation. Further details are 
given in the vignette accompanying this package. Inference is conducted in a 
Bayesian setting using Markov chain Monte Carlo (MCMC) simulation.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>MVST.CARar(formula, family, data=NULL,  trials=NULL, W, burnin, n.sample, thin=1, 
n.chains=1,  n.cores=1, prior.mean.beta=NULL, prior.var.beta=NULL, prior.nu2=NULL, 
prior.Sigma.df=NULL, prior.Sigma.scale=NULL, AR=NULL, rho.S=NULL, rho.T=NULL, 
MALA=TRUE, verbose=TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="MVST.CARar_+3A_formula">formula</code></td>
<td>

<p>A formula for the covariate part of the model using the syntax of the lm() 
function. Offsets can be included here using the offset() function. The response 
and the offset (if included) should be matrices of dimension (KN)*J, where K is 
the number of spatial units, N is the number of time periods and J is the number 
of different variables. Each column of the response and offset matrices relates to
a different outcome variable. The values in each column of these matrices should be 
ordered so that the first K data points are the set of all K spatial locations at 
time 1, the next K are the set of spatial locations for time 2 and so on. The 
covariates should each be a (KN)*1 vector, and different regression parameters are 
estimated for each of the J variables. The response can contain missing (NA) values. 
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_family">family</code></td>
<td>

<p>One of either &quot;binomial&quot;, &quot;gaussian&quot; or &quot;poisson&quot;, which respectively specify a 
binomial likelihood model with a logistic link function, a Gaussian likelihood 
model with an identity link function, or a Poisson likelihood model with a log 
link function.
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_data">data</code></td>
<td>

<p>An optional data.frame containing the  variables in the formula.
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_trials">trials</code></td>
<td>

<p>A (KN)*J matrix of the same dimension as the response. Only used if 
family=&quot;binomial&quot;. 
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_w">W</code></td>
<td>
<p>A non-negative K by K neighbourhood matrix (where K is the number of 
spatial units). Typically a binary specification is used, where the jkth 
element equals one if areas (j, k) are spatially close (e.g. share a common 
border) and is zero otherwise. The matrix can be non-binary, but each row must 
contain at least one non-zero entry.
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_burnin">burnin</code></td>
<td>

<p>The number of MCMC samples to discard as the burn-in period.
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_n.sample">n.sample</code></td>
<td>

<p>The number of MCMC samples to generate.
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_thin">thin</code></td>
<td>

<p>The level of thinning to apply to the MCMC samples to reduce their temporal 
autocorrelation. Defaults to 1 (no thinning).
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_n.chains">n.chains</code></td>
<td>

<p>The number of MCMC chains to run when fitting the model. Defaults to 1.
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_n.cores">n.cores</code></td>
<td>

<p>The number of computer cores to run the MCMC chains on. Must be less than or 
equal to n.chains. Defaults to 1.
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_prior.mean.beta">prior.mean.beta</code></td>
<td>

<p>A vector of prior means for the regression parameters beta (Gaussian priors are 
assumed). Defaults to a vector of zeros.
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_prior.var.beta">prior.var.beta</code></td>
<td>

<p>A vector of prior variances for the regression parameters beta (Gaussian priors 
are assumed). Defaults to a vector with values 100,000.
</p>
</td></tr>   
<tr><td><code id="MVST.CARar_+3A_prior.nu2">prior.nu2</code></td>
<td>

<p>The prior shape and scale in the form of c(shape, scale) for an Inverse-Gamma(shape, scale) 
prior for nu2_j for each outcome j. Defaults to c(1, 0.01) and only used if family=&quot;Gaussian&quot;.   
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_prior.sigma.df">prior.Sigma.df</code></td>
<td>

<p>The degrees of freedom for the Inverse-Wishart prior formulation for the 
covariance matrix Sigma. This prior formulation follows the marginally 
weakly-informative specification proposed by Huang and Wand (2013). Defaults 
to 2, which corresponds to non-informative uniform priors on the interval [-1,1]
being assigned to each correlation parameter within the Sigma matrix. 
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_prior.sigma.scale">prior.Sigma.scale</code></td>
<td>

<p>The J times 1  vector of prior scales for the  square roots of the diagonal 
elements of the covariance matrix Sigma. This prior formulation is the marginally 
weakly-informative prior specification proposed by Huang and Wand (2013). Thus,
the jth element of this vector is the scale parameter for the zero centred
half-t prior (with shape given by prior.Sigma.df) assumed for the standard 
deviation of the random effects corresponding to the jth outcome. Defaults to 
a vector of values of 100,000.
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_ar">AR</code></td>
<td>

<p>The order of the autoregressive time series process that must be either 1 or 2. 
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_rho.s">rho.S</code></td>
<td>

<p>The value in the interval [0, 1] that the spatial dependence parameter rho.S is 
fixed at if it should not be estimated. If this arugment is NULL then rho.S is
estimated in the model. 
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_rho.t">rho.T</code></td>
<td>

<p>Whether to fix or estimate the temporal dependence parameter(s) rho.T in the model. 
If this arugment is NULL then they are estimated in the model. If you want to fix
them and AR=1 then it must be a single value. If  AR=2 then it must be
a vector of length two with the first and second order autoregressive coefficients.
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_mala">MALA</code></td>
<td>

<p>Logical, should the function use Metropolis adjusted Langevin algorithm (MALA)
updates (TRUE, default) or simple random walk (FALSE) updates for the regression 
parameters. Not applicable if family=&quot;gaussian&quot;.    
</p>
</td></tr>
<tr><td><code id="MVST.CARar_+3A_verbose">verbose</code></td>
<td>

<p>Logical, should the function update the user on its progress.  
</p>
</td></tr>
</table>


<h3>Value</h3>

<table>
<tr><td><code>summary.results</code></td>
<td>
<p>A summary table of the parameters.</p>
</td></tr>
<tr><td><code>samples</code></td>
<td>
<p>A list containing the MCMC samples from the model.</p>
</td></tr>
<tr><td><code>fitted.values</code></td>
<td>
<p>A matrix of fitted values for each area, time period and response 
variable in the same order as the response variable.</p>
</td></tr>
<tr><td><code>residuals</code></td>
<td>
<p>A list with 2 elements, where each element is a matrix of a type  
of residual. Each row of a matrix relates to an area and time period and each column to a 
response (category). The types of residual are &quot;response&quot; (raw), and &quot;pearson&quot;.
</p>
</td></tr>
<tr><td><code>modelfit</code></td>
<td>
<p>Model fit criteria including the Deviance Information Criterion 
(DIC) and its corresponding estimated effective number of parameters (p.d), the Log 
Marginal Predictive Likelihood (LMPL), the Watanabe-Akaike Information Criterion 
(WAIC) and its corresponding estimated number of effective parameters (p.w), and
the loglikelihood.</p>
</td></tr>
<tr><td><code>accept</code></td>
<td>
<p>The acceptance probabilities for the parameters.</p>
</td></tr>
<tr><td><code>localised.structure</code></td>
<td>
<p>NULL, for compatability with the other models.</p>
</td></tr>
<tr><td><code>formula</code></td>
<td>
<p>The formula (as a text string) for the response, covariate and 
offset parts of the model.</p>
</td></tr>
<tr><td><code>model</code></td>
<td>
<p>A text string describing the model fit.</p>
</td></tr>
<tr><td><code>mcmc.info</code></td>
<td>
<p>A vector giving details of the numbers of MCMC samples generated.</p>
</td></tr>
<tr><td><code>X</code></td>
<td>
<p>The design matrix of covariates.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Duncan Lee
</p>


<h3>References</h3>

<p>Gelfand, A and Vounatsou, P (2003). Proper multivariate conditional autoregressive
models for spatial data analysis, Biostatistics, 4, 11-25.
</p>
<p>Huang, A., and Wand, M (2013). Simple Marginally Noninformative Prior Distributions 
for Covariance Matrices. Bayesian Analysis, 8, 439-452.
</p>
<p>Lee D, Robertson C, and Marques, D (2022). Quantifying the small-area spatio-temporal 
dynamics of the Covid-19 pandemic in Scotland during a period with limited testing 
capacity, Spatial Statistics, https://doi.org/10.1016/j.spasta.2021.100508.
</p>
<p>Leroux B, Lei X, Breslow N (2000). &quot;Estimation of Disease Rates in SmallAreas: A 
New Mixed Model for Spatial Dependence.&quot; In M Halloran, D Berry (eds.), 
<em>Statistical Models in Epidemiology, the Environment and Clinical Trials</em>,
pp. 179-191. Springer-Verlag, New York.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>#################################################
#### Run the model on simulated data on a lattice
#################################################
#### Set up a square lattice region
x.easting &lt;- 1:8
x.northing &lt;- 1:8
Grid &lt;- expand.grid(x.easting, x.northing)


#### Set up the coordinate dimensions
K &lt;- nrow(Grid)
N &lt;- 15
J &lt;- 2
N.all &lt;- N * K * J


#### set up distance and neighbourhood (W, based on sharing a common border) matrices
distance &lt;- as.matrix(dist(Grid))
W &lt;-array(0, c(K,K))
W[distance==1] &lt;-1 	


#### Set up the spatial covariance matrix
Q.W &lt;- 0.8 * (diag(apply(W, 2, sum)) - W) + 0.2 * diag(rep(1,K))
Q.W.inv &lt;- solve(Q.W)


#### Set up the multivariate outcome covariance matrix
Sigma &lt;- 0.01 * array(c(1, 1, 1, 2), c(2,2))
Sigma.inv &lt;- solve(Sigma)


#### Spatial and between outcome covariance
QSig.prec &lt;- kronecker(Q.W, Sigma.inv)
QSig.var &lt;-solve(QSig.prec)


#### Generate the covariate
x1 &lt;- rnorm(n=N * K, mean=0, sd=1)
lp.regression.mat &lt;- cbind(0.1 + 0.1 * x1, 0.1 - 0.1*x1)
lp.regression &lt;- as.numeric(t(lp.regression.mat))


#### Spatio-temporal random effects
phi.temp &lt;- mvrnorm(n=1, mu=rep(0,(J*K)), Sigma=QSig.var)
phi &lt;- phi.temp
    for(i in 2:N)
    {
    phi.temp2 &lt;- mvrnorm(n=1, mu=(0.8 * phi.temp), Sigma=QSig.var)
    phi.temp &lt;- phi.temp2
    phi &lt;- c(phi, phi.temp)
    }
phi &lt;- phi - mean(phi)
phi.true &lt;- matrix(phi, ncol=2, byrow=TRUE)


#### Generate the binomial counts
lp &lt;- lp.regression + phi
p &lt;- exp(lp) / (1+exp(lp))
trials &lt;- rpois(N.all, lambda=100)
Y &lt;- rbinom(n=N.all, size=trials, prob=p)
Y.mat &lt;- matrix(Y, nrow=(K*N), ncol=J, byrow=TRUE)
trials.mat &lt;- matrix(trials, nrow=(K*N), ncol=J, byrow=TRUE)
formula &lt;- Y.mat~x1

#### Run the model
formula &lt;- Y.mat ~ x1
## Not run: mod &lt;- MVST.CARar(formula=formula, family="binomial", trials=trials.mat, W=W, 
burnin=10000, n.sample=50000, AR=1, MALA=FALSE)
## End(Not run)

#### Toy example for checking
mod &lt;- MVST.CARar(formula=formula, family="binomial", trials=trials.mat, W=W, 
burnin=10, n.sample=50, AR=1, MALA=FALSE)
</code></pre>

<hr>
<h2 id='print.CARBayesST'>
Print a summary of the fitted model to the screen.
</h2><span id='topic+print.CARBayesST'></span>

<h3>Description</h3>

<p>This function takes a CARBayesST object and returns a summary of the fitted model.
The summary includes, for selected parameters, posterior means and 95 percent 
credible intervals, the effective number of independent samples and the Geweke 
convergence diagnostic in the form of a Z-score.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'CARBayesST'
print(x, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="print.CARBayesST_+3A_x">x</code></td>
<td>

<p>A CARBayesST fitted model object.
</p>
</td></tr>
<tr><td><code id="print.CARBayesST_+3A_...">...</code></td>
<td>

<p>Ignored.
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Duncan Lee
</p>

<hr>
<h2 id='residuals.CARBayesST'>
Extract the residuals from a model.
</h2><span id='topic+residuals.CARBayesST'></span>

<h3>Description</h3>

<p>This function takes a CARBayesST object and returns a set of residuals. 
The allowable types of residual are &quot;response&quot; (raw), and &quot;pearson&quot; (the 
default). In each case the fitted values are based on posterior means.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>    ## S3 method for class 'CARBayesST'
residuals(object, type, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="residuals.CARBayesST_+3A_object">object</code></td>
<td>

<p>A CARBayesST fitted model object.
</p>
</td></tr>
<tr><td><code id="residuals.CARBayesST_+3A_type">type</code></td>
<td>

<p>A text string and one of c(&quot;response&quot;, &quot;pearson&quot;). If this
argument is omitted the default is &quot;pearson&quot;.
</p>
</td></tr>
<tr><td><code id="residuals.CARBayesST_+3A_...">...</code></td>
<td>

<p>Ignored.
</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Duncan Lee
</p>

<hr>
<h2 id='ST.CARadaptive'>
Fit a spatio-temporal generalised linear mixed model to data, with a spatio-temporal
autoregressive process that has an adaptive autocorrelation stucture.
</h2><span id='topic+ST.CARadaptive'></span>

<h3>Description</h3>

<p>Fit a spatio-temporal generalised linear mixed model to areal unit data, where 
the response variable can be binomial, Gaussian or Poisson. The linear predictor 
is modelled by known covariates and a vector of random effects. The latter follows 
a multivariate first order autoregressive time series process, where spatial 
autocorrelation is modelled via the precision matrix, which is based on a CAR type
structure and a neighbourhood (adjacency) matrix W. The non-zero elements of W 
associated with each pair of geographically adjacent areal units are treated as 
random variables with ranges in the unit interval, which allows step changes to 
be identified in the random effects surface between geographically adjacent 
regions. The model is similar to that proposed by Rushworth et al. (2017). Further 
details are given in the vignette accompanying this package. Inference is conducted 
in a Bayesian setting using Markov chain Monte Carlo (MCMC) simulation. 
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ST.CARadaptive(formula, family, data=NULL, trials=NULL, W, burnin, n.sample, thin=1,  
prior.mean.beta=NULL, prior.var.beta=NULL, prior.nu2=NULL, prior.tau2=NULL, 
rho = NULL, epsilon = 0, MALA=TRUE, verbose=TRUE) 
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="ST.CARadaptive_+3A_formula">formula</code></td>
<td>

<p>A formula for the covariate part of the model using the syntax of the lm() 
function. Offsets can be included here using the offset() function. The response 
and each covariate should be vectors of length (KN)*1, where K is the number of 
spatial units and N is the number of time periods. Each vector should be ordered 
so that the first K data points are the set of all K spatial locations at time 1, 
the next K are the set of spatial locations for time 2 and so on. The response 
must NOT contain missing (NA) values.
</p>
</td></tr>
<tr><td><code id="ST.CARadaptive_+3A_family">family</code></td>
<td>

<p>One of either &quot;binomial&quot;, &quot;gaussian&quot;, or &quot;poisson&quot;, which respectively specify a 
binomial likelihood model with a logistic link function, a Gaussian likelihood 
model with an identity link function, or a Poisson likelihood model with a log 
link function.
</p>
</td></tr>
<tr><td><code id="ST.CARadaptive_+3A_data">data</code></td>
<td>

<p>An optional data.frame containing the  variables in the formula.
</p>
</td></tr>
<tr><td><code id="ST.CARadaptive_+3A_trials">trials</code></td>
<td>

<p>A vector the same length and in the same order as the response containing the 
total number of trials for each area and time period. Only used if family=&quot;binomial&quot;. 
</p>
</td></tr>
<tr><td><code id="ST.CARadaptive_+3A_w">W</code></td>
<td>

<p>A non-negative K by K neighbourhood matrix (where K is the number of spatial units). 
Typically a binary specification is used, where the jkth element equals one if 
areas (j, k) are spatially close (e.g. share a common border) and is zero otherwise. 
For this model the matrix must be binary.
</p>
</td></tr> 
<tr><td><code id="ST.CARadaptive_+3A_burnin">burnin</code></td>
<td>

<p>The number of MCMC samples to discard as the burn-in period.
</p>
</td></tr>
<tr><td><code id="ST.CARadaptive_+3A_n.sample">n.sample</code></td>
<td>

<p>The number of MCMC samples to generate.
</p>
</td></tr>
<tr><td><code id="ST.CARadaptive_+3A_thin">thin</code></td>
<td>

<p>The level of thinning to apply to the MCMC samples to reduce their temporal 
autocorrelation. Defaults to 1 (no thinning).
</p>
</td></tr>
<tr><td><code id="ST.CARadaptive_+3A_prior.mean.beta">prior.mean.beta</code></td>
<td>

<p>A vector of prior means for the regression parameters beta (Gaussian priors are 
assumed). Defaults to a vector of zeros.
</p>
</td></tr>
<tr><td><code id="ST.CARadaptive_+3A_prior.var.beta">prior.var.beta</code></td>
<td>

<p>A vector of prior variances for the regression parameters beta (Gaussian priors 
are assumed). Defaults to a vector with values 100,000.
</p>
</td></tr>  
<tr><td><code id="ST.CARadaptive_+3A_prior.nu2">prior.nu2</code></td>
<td>

<p>The prior shape and scale in the form of c(shape, scale) for an Inverse-Gamma(shape, scale) 
prior for nu2. Defaults to c(1, 0.01) and only used if family=&quot;Gaussian&quot;.   
</p>
</td></tr>
<tr><td><code id="ST.CARadaptive_+3A_prior.tau2">prior.tau2</code></td>
<td>

<p>The prior shape and scale in the form of c(shape, scale) for an Inverse-Gamma(shape, scale) 
prior for tau2. Defaults to c(1, 0.01).  
</p>
</td></tr>
<tr><td><code id="ST.CARadaptive_+3A_rho">rho</code></td>
<td>

<p>The value in the interval [0, 1] that the spatial dependence parameter rho is 
fixed at if it should not be estimated. If this arugment is NULL then rho is
estimated in the model. Setting rho=1, reduces the random effects prior to the 
intrinsic CAR model but does require epsilon&gt;0.
</p>
</td></tr>
<tr><td><code id="ST.CARadaptive_+3A_epsilon">epsilon</code></td>
<td>

<p>Diagonal ridge parameter to add to the random effects prior precision matrix, only 
required when rho = 1, and the prior precision is improper.  Defaults to 0.
</p>
</td></tr>
<tr><td><code id="ST.CARadaptive_+3A_mala">MALA</code></td>
<td>

<p>Logical, should the function use Metropolis adjusted Langevin algorithm (MALA)
updates (TRUE, default) or simple random walk (FALSE) updates for the regression 
parameters. Not applicable if family=&quot;gaussian&quot;.     
</p>
</td></tr>
<tr><td><code id="ST.CARadaptive_+3A_verbose">verbose</code></td>
<td>

<p>Logical, should the function update the user on its progress.  
</p>
</td></tr>
</table>


<h3>Value</h3>

<table>
<tr><td><code>summary.results</code></td>
<td>
<p>A summary table of the parameters.</p>
</td></tr>
<tr><td><code>samples</code></td>
<td>
<p>A list containing the MCMC samples from the model.</p>
</td></tr>
<tr><td><code>fitted.values</code></td>
<td>
<p>A vector of fitted values for each area and time period.</p>
</td></tr>
<tr><td><code>residuals</code></td>
<td>
<p>A matrix with 2 columns where each column is a type of 
residual and each row relates to an area and time period. The types are &quot;response&quot; 
(raw), and &quot;pearson&quot;.</p>
</td></tr>
<tr><td><code>modelfit</code></td>
<td>
<p>Model fit criteria including the Deviance Information Criterion 
(DIC) and its corresponding estimated effective number of parameters (p.d), the Log 
Marginal Predictive Likelihood (LMPL), the Watanabe-Akaike Information Criterion 
(WAIC) and its corresponding estimated number of effective parameters (p.w), and
the loglikelihood.</p>
</td></tr>
<tr><td><code>accept</code></td>
<td>
<p>The acceptance probabilities for the parameters.</p>
</td></tr>
<tr><td><code>localised.structure</code></td>
<td>
<p>A list with 2 K*K matrices, Wmedian and W99 summarising 
the estimated adjacency relationships. Wmedian contains the posterior median for 
each w_ij element estimated in the model for adjacent areal units, while W99 
contains binary indicator variables for whether Prob(w_ij &lt; 0.5|data)&gt;0.99. 
For both matrices, elements corresponding to non-adjacent pairs of areas have 
NA values.</p>
</td></tr>
<tr><td><code>formula</code></td>
<td>
<p>The formula (as a text string) for the response, covariate and 
offset parts of the model.</p>
</td></tr>
<tr><td><code>model</code></td>
<td>
<p>A text string describing the model fit.</p>
</td></tr>
<tr><td><code>X</code></td>
<td>
<p>The design matrix of covariates.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Alastair Rushworth
</p>


<h3>References</h3>

<p>Rushworth, A., Lee, D., and Sarran, C (2017).  An adaptive spatio-temporal smoothing 
model for estimating trends and step changes in disease risk. Journal of the Royal 
Statistical Society Series C, 66, 141-157.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>#################################################
#### Run the model on simulated data on a lattice
#################################################
#### set up the regular lattice    
x.easting &lt;- 1:10
x.northing &lt;- 1:10
Grid &lt;- expand.grid(x.easting, x.northing)
K &lt;- nrow(Grid)
N &lt;- 10
N.all &lt;- N * K
  
    
#### set up spatial neighbourhood matrix W
distance &lt;- as.matrix(dist(Grid))
W &lt;-array(0, c(K,K))
W[distance==1] &lt;-1 	


#### Simulate the elements in the linear predictor and the data
Q.W &lt;- 0.99 * (diag(apply(W, 2, sum)) - W) + 0.01 * diag(rep(1,K))
Q.W.inv &lt;- solve(Q.W)
phi.temp &lt;- mvrnorm(n=1, mu=rep(0,K), Sigma=(0.1 * Q.W.inv))
phi &lt;- phi.temp
    for(i in 2:N)
    {
    phi.temp2 &lt;- mvrnorm(n=1, mu=(0.8 * phi.temp), Sigma=(0.1 * Q.W.inv))
    phi.temp &lt;- phi.temp2
    phi &lt;- c(phi, phi.temp)
    }
jump &lt;- rep(c(rep(2, 70), rep(4, 30)),N)
LP &lt;- jump + phi
fitted &lt;- exp(LP)
Y &lt;- rpois(n=N.all, lambda=fitted)


#### Run the model     
## Not run: model &lt;- ST.CARadaptive(formula=Y~1, family="poisson", W=W, burnin=10000,
n.sample=50000)
## End(Not run)


#### Toy example for checking    
model &lt;- ST.CARadaptive(formula=Y~1, family="poisson", W=W, burnin=10,
n.sample=50)
</code></pre>

<hr>
<h2 id='ST.CARanova'>
Fit a spatio-temporal generalised linear mixed model to data, with spatial and  temporal main
effects and a spatio-temporal interaction.
</h2><span id='topic+ST.CARanova'></span>

<h3>Description</h3>

<p>Fit a spatio-temporal generalised linear mixed model to areal unit data, where the 
response variable can be binomial, Gaussian or Poisson. The linear predictor is 
modelled by known covariates and three vectors of random effects. The latter 
include spatial and temporal main effects and a spatio-temporal interaction. 
The spatial and temporal main effects are modelled by the conditional 
autoregressive (CAR) prior proposed by Leroux et al. (2000), while the 
spatio-temporal interaction random effects are independent. Due to the lack of 
identifiability between the interactions and the Gaussian errors, only main 
effects  are allowed in the Gaussian model. Missing values are allowed in the 
response in this model, and are sampled from in the model using data augmentation.
The model is similar to that proposed by Knorr-Held (2000), and further details 
are given in the vignette accompanying this package. Inference is conducted in a 
Bayesian setting using Markov chain Monte Carlo (MCMC) simulation. 
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ST.CARanova(formula, family, data=NULL,  trials=NULL, W, interaction=TRUE, burnin, 
n.sample, thin=1, n.chains=1,  n.cores=1, prior.mean.beta=NULL, prior.var.beta=NULL, 
prior.nu2=NULL, prior.tau2=NULL, rho.S=NULL, rho.T=NULL, MALA=TRUE, verbose=TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="ST.CARanova_+3A_formula">formula</code></td>
<td>

<p>A formula for the covariate part of the model using the syntax of the lm() 
function. Offsets can be included here using the offset() function. The response 
and each covariate should be vectors of length (KN)*1, where K is the number of 
spatial units and N is the number of time periods. Each vector should be ordered 
so that the first K data points are the set of all K spatial locations at time 1, 
the next K are the set of spatial locations for time 2 and so on. The response can 
contain missing (NA) values.
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_family">family</code></td>
<td>

<p>One of either &quot;binomial&quot;, &quot;gaussian&quot; or &quot;poisson&quot;, which respectively specify a 
binomial likelihood model with a logistic link function, a Gaussian likelihood 
model with an identity link function, or a Poisson likelihood model with a log 
link function.
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_data">data</code></td>
<td>

<p>An optional data.frame containing the  variables in the formula.
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_trials">trials</code></td>
<td>

<p>A vector the same length and in the same order as the response containing the 
total number of trials for each area and time period. Only used if family=&quot;binomial&quot;. 
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_w">W</code></td>
<td>
<p>A non-negative K by K neighbourhood matrix (where K is the number of 
spatial units). Typically a binary specification is used, where the jkth 
element equals one if areas (j, k) are spatially close (e.g. share a common 
border) and is zero otherwise. The matrix can be non-binary, but each row must 
contain at least one non-zero entry.
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_interaction">interaction</code></td>
<td>

<p>TRUE or FALSE indicating whether the spatio-temporal interaction random effects
should be included. Defaults to TRUE unless family=&quot;gaussian&quot; in which case 
interactions are not allowed.
</p>
</td></tr>    
<tr><td><code id="ST.CARanova_+3A_burnin">burnin</code></td>
<td>

<p>The number of MCMC samples to discard as the burn-in period.
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_n.sample">n.sample</code></td>
<td>

<p>The number of MCMC samples to generate.
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_thin">thin</code></td>
<td>

<p>The level of thinning to apply to the MCMC samples to reduce their temporal 
autocorrelation. Defaults to 1 (no thinning).
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_n.chains">n.chains</code></td>
<td>

<p>The number of MCMC chains to run when fitting the model. Defaults to 1.
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_n.cores">n.cores</code></td>
<td>

<p>The number of computer cores to run the MCMC chains on. Must be less than or 
equal to n.chains. Defaults to 1.
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_prior.mean.beta">prior.mean.beta</code></td>
<td>

<p>A vector of prior means for the regression parameters beta (Gaussian priors are 
assumed). Defaults to a vector of zeros.
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_prior.var.beta">prior.var.beta</code></td>
<td>

<p>A vector of prior variances for the regression parameters beta (Gaussian priors 
are assumed). Defaults to a vector with values 100,000.
</p>
</td></tr>   
<tr><td><code id="ST.CARanova_+3A_prior.nu2">prior.nu2</code></td>
<td>

<p>The prior shape and scale in the form of c(shape, scale) for an Inverse-Gamma(shape, scale) 
prior for nu2. Defaults to c(1, 0.01) and only used if family=&quot;Gaussian&quot;.   
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_prior.tau2">prior.tau2</code></td>
<td>

<p>The prior shape and scale in the form of c(shape, scale) for an Inverse-Gamma(shape, scale) 
prior for tau2. Defaults to c(1, 0.01).  
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_rho.s">rho.S</code></td>
<td>

<p>The value in the interval [0, 1] that the spatial dependence parameter rho.S is 
fixed at if it should not be estimated. If this arugment is NULL then rho.S is
estimated in the model. 
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_rho.t">rho.T</code></td>
<td>

<p>The value in the interval [0, 1] that the temporal dependence parameter rho.T is 
fixed at if it should not be estimated. If this arugment is NULL then rho.T is
estimated in the model. 
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_mala">MALA</code></td>
<td>

<p>Logical, should the function use Metropolis adjusted Langevin algorithm (MALA)
updates (TRUE, default) or simple random walk (FALSE) updates for the regression 
parameters. Not applicable if family=&quot;gaussian&quot;.    
</p>
</td></tr>
<tr><td><code id="ST.CARanova_+3A_verbose">verbose</code></td>
<td>

<p>Logical, should the function update the user on its progress.  
</p>
</td></tr>
</table>


<h3>Value</h3>

<table>
<tr><td><code>summary.results</code></td>
<td>
<p>A summary table of the parameters.</p>
</td></tr>
<tr><td><code>samples</code></td>
<td>
<p>A list containing the MCMC samples from the model.</p>
</td></tr>
<tr><td><code>fitted.values</code></td>
<td>
<p>A vector of fitted values for each area and time period.</p>
</td></tr>
<tr><td><code>residuals</code></td>
<td>
<p>A matrix with 2 columns where each column is a type of 
residual and each row relates to an area and time period. The types are &quot;response&quot; 
(raw), and &quot;pearson&quot;.</p>
</td></tr>
<tr><td><code>modelfit</code></td>
<td>
<p>Model fit criteria including the Deviance Information Criterion 
(DIC) and its corresponding estimated effective number of parameters (p.d), the Log 
Marginal Predictive Likelihood (LMPL), the Watanabe-Akaike Information Criterion 
(WAIC) and its corresponding estimated number of effective parameters (p.w), and
the loglikelihood.</p>
</td></tr>
<tr><td><code>accept</code></td>
<td>
<p>The acceptance probabilities for the parameters.</p>
</td></tr>
<tr><td><code>localised.structure</code></td>
<td>
<p>NULL, for compatability with the other models.</p>
</td></tr>
<tr><td><code>formula</code></td>
<td>
<p>The formula (as a text string) for the response, covariate and 
offset parts of the model.</p>
</td></tr>
<tr><td><code>model</code></td>
<td>
<p>A text string describing the model fit.</p>
</td></tr>
<tr><td><code>mcmc.info</code></td>
<td>
<p>A vector giving details of the numbers of MCMC samples generated.</p>
</td></tr>
<tr><td><code>X</code></td>
<td>
<p>The design matrix of covariates.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Duncan Lee
</p>


<h3>References</h3>

<p>Knorr-Held, L. (2000). Bayesian modelling of inseparable space-time variation in 
disease risk. Statistics in Medicine, 19, 2555-2567.
</p>
<p>Leroux, B., X. Lei, and N. Breslow (2000). Estimation of disease rates in small 
areas: A new mixed model for spatial dependence, Chapter Statistical Models in 
Epidemiology, the Environment and Clinical Trials, Halloran, M and Berry, D (eds),
pp. 135-178. Springer-Verlag, New York.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>#################################################
#### Run the model on simulated data on a lattice
#################################################
#### set up the regular lattice    
x.easting &lt;- 1:10
x.northing &lt;- 1:10
Grid &lt;- expand.grid(x.easting, x.northing)
K &lt;- nrow(Grid)
N &lt;- 10
N.all &lt;- N * K


#### set up spatial (W) and temporal (D) neighbourhood matrices
distance &lt;- as.matrix(dist(Grid))
W &lt;-array(0, c(K,K))
W[distance==1] &lt;-1 	
	
D &lt;-array(0, c(N,N))
for(i in 1:N)
{
    for(j in 1:N)
    {
        if(abs((i-j))==1)  D[i,j] &lt;- 1 
    }	
}


#### Simulate the elements in the linear predictor and the data
gamma &lt;- rnorm(n=N.all, mean=0, sd=0.001)
x &lt;- rnorm(n=N.all, mean=0, sd=1)
beta &lt;- 0.1

Q.W &lt;- 0.99 * (diag(apply(W, 2, sum)) - W) + 0.01 * diag(rep(1,K))
Q.W.inv &lt;- solve(Q.W)
phi &lt;- mvrnorm(n=1, mu=rep(0,K), Sigma=(0.01 * Q.W.inv))

Q.D &lt;- 0.99 * (diag(apply(D, 2, sum)) - D) + 0.01 * diag(rep(1,N))
Q.D.inv &lt;- solve(Q.D)
delta &lt;- mvrnorm(n=1, mu=rep(0,N), Sigma=(0.01 * Q.D.inv))

phi.long &lt;- rep(phi, N)
delta.long &lt;- kronecker(delta, rep(1,K))
LP &lt;- 4 +  x * beta + phi.long +  delta.long + gamma
mean &lt;- exp(LP)
Y &lt;- rpois(n=N.all, lambda=mean)


#### Run the model
## Not run: model &lt;- ST.CARanova(formula=Y~x, family="poisson", interaction=TRUE, 
W=W, burnin=10000, n.sample=50000)
## End(Not run)


#### Toy example for checking
model &lt;- ST.CARanova(formula=Y~x, family="poisson", interaction=TRUE, 
W=W, burnin=10, n.sample=50)
</code></pre>

<hr>
<h2 id='ST.CARar'>
Fit a spatio-temporal generalised linear mixed model to data, with a spatio-temporal
autoregressive process.
</h2><span id='topic+ST.CARar'></span>

<h3>Description</h3>

<p>Fit a spatio-temporal generalised linear mixed model to areal unit data, where the 
response variable can be binomial, Gaussian or Poisson. The linear predictor is 
modelled by known covariates and a vector of random effects. The latter follows either 
a multivariate first order autoregressive time series process or a multivariate
second order autoregressive time series process. In both cases the spatial 
autocorrelation is modelled via the precision matrix corresponding to the conditional 
autoregressive (CAR) prior proposed by Leroux et al. (2000), and the initial 
AR(1) model was proposed by Rushworth et al. (2014).  Missing values are 
allowed in the response in this model, and are sampled from in the model using 
data augmentation. Further details are given in the vignette accompanying this 
package. Inference is conducted in a Bayesian setting using Markov chain Monte 
Carlo (MCMC) simulation. 
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ST.CARar(formula, family, data=NULL,  trials=NULL, W, burnin, n.sample, thin=1, 
n.chains=1,  n.cores=1, prior.mean.beta=NULL, prior.var.beta=NULL, prior.nu2=NULL, 
prior.tau2=NULL, AR=NULL, rho.S=NULL, rho.T=NULL, MALA=TRUE, verbose=TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="ST.CARar_+3A_formula">formula</code></td>
<td>

<p>A formula for the covariate part of the model using the syntax of the lm() 
function. Offsets can be included here using the offset() function. The response 
and each covariate should be vectors of length (KN)*1, where K is the number of 
spatial units and N is the number of time periods. Each vector should be ordered 
so that the first K data points are the set of all K spatial locations at time 1, 
the next K are the set of spatial locations for time 2 and so on. The response can 
contain missing (NA) values.
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_family">family</code></td>
<td>

<p>One of either &quot;binomial&quot;, &quot;gaussian&quot; or &quot;poisson&quot;, which respectively specify a 
binomial likelihood model with a logistic link function, a Gaussian likelihood 
model with an identity link function, or a Poisson likelihood model with a log 
link function.
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_data">data</code></td>
<td>

<p>An optional data.frame containing the  variables in the formula.
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_trials">trials</code></td>
<td>

<p>A vector the same length and in the same order as the response containing the 
total number of trials for each area and time period. Only used if family=&quot;binomial&quot;. 
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_w">W</code></td>
<td>
<p>A non-negative K by K neighbourhood matrix (where K is the number of 
spatial units). Typically a binary specification is used, where the jkth 
element equals one if areas (j, k) are spatially close (e.g. share a common 
border) and is zero otherwise. The matrix can be non-binary, but each row must 
contain at least one non-zero entry.
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_burnin">burnin</code></td>
<td>

<p>The number of MCMC samples to discard as the burn-in period.
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_n.sample">n.sample</code></td>
<td>

<p>The number of MCMC samples to generate.
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_thin">thin</code></td>
<td>

<p>The level of thinning to apply to the MCMC samples to reduce their temporal 
autocorrelation. Defaults to 1 (no thinning).
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_n.chains">n.chains</code></td>
<td>

<p>The number of MCMC chains to run when fitting the model. Defaults to 1.
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_n.cores">n.cores</code></td>
<td>

<p>The number of computer cores to run the MCMC chains on. Must be less than or 
equal to n.chains. Defaults to 1.
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_prior.mean.beta">prior.mean.beta</code></td>
<td>

<p>A vector of prior means for the regression parameters beta (Gaussian priors are 
assumed). Defaults to a vector of zeros.
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_prior.var.beta">prior.var.beta</code></td>
<td>

<p>A vector of prior variances for the regression parameters beta (Gaussian priors 
are assumed). Defaults to a vector with values 100,000.
</p>
</td></tr>   
<tr><td><code id="ST.CARar_+3A_prior.nu2">prior.nu2</code></td>
<td>

<p>The prior shape and scale in the form of c(shape, scale) for an Inverse-Gamma(shape, scale) 
prior for nu2. Defaults to c(1, 0.01) and only used if family=&quot;Gaussian&quot;.   
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_prior.tau2">prior.tau2</code></td>
<td>

<p>The prior shape and scale in the form of c(shape, scale) for an Inverse-Gamma(shape, scale) 
prior for tau2. Defaults to c(1, 0.01).  
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_ar">AR</code></td>
<td>

<p>The order of the autoregressive time series process that must be either 1 or 2. 
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_rho.s">rho.S</code></td>
<td>

<p>The value in the interval [0, 1] that the spatial dependence parameter rho.S is 
fixed at if it should not be estimated. If this arugment is NULL then rho.S is
estimated in the model. 
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_rho.t">rho.T</code></td>
<td>

<p>Whether to fix or estimate the temporal dependence parameter(s) rho.T in the model. 
If this arugment is NULL then they are estimated in the model. If you want to fix
them and AR=1 then it must be a single value. If  AR=2 then it must be
a vector of length two with the first and second order autoregressive coefficients.
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_mala">MALA</code></td>
<td>

<p>Logical, should the function use Metropolis adjusted Langevin algorithm (MALA)
updates (TRUE, default) or simple random walk (FALSE) updates for the regression 
parameters. Not applicable if family=&quot;gaussian&quot;.    
</p>
</td></tr>
<tr><td><code id="ST.CARar_+3A_verbose">verbose</code></td>
<td>

<p>Logical, should the function update the user on its progress.  
</p>
</td></tr>
</table>


<h3>Value</h3>

<table>
<tr><td><code>summary.results</code></td>
<td>
<p>A summary table of the parameters.</p>
</td></tr>
<tr><td><code>samples</code></td>
<td>
<p>A list containing the MCMC samples from the model.</p>
</td></tr>
<tr><td><code>fitted.values</code></td>
<td>
<p>A vector of fitted values for each area and time period.</p>
</td></tr>
<tr><td><code>residuals</code></td>
<td>
<p>A matrix with 2 columns where each column is a type of 
residual and each row relates to an area and time period. The types are &quot;response&quot; 
(raw), and &quot;pearson&quot;.</p>
</td></tr>
<tr><td><code>modelfit</code></td>
<td>
<p>Model fit criteria including the Deviance Information Criterion 
(DIC) and its corresponding estimated effective number of parameters (p.d), the Log 
Marginal Predictive Likelihood (LMPL), the Watanabe-Akaike Information Criterion 
(WAIC) and its corresponding estimated number of effective parameters (p.w), and
the loglikelihood.</p>
</td></tr>
<tr><td><code>accept</code></td>
<td>
<p>The acceptance probabilities for the parameters.</p>
</td></tr>
<tr><td><code>localised.structure</code></td>
<td>
<p>NULL, for compatability with the other models.</p>
</td></tr>
<tr><td><code>formula</code></td>
<td>
<p>The formula (as a text string) for the response, covariate and 
offset parts of the model.</p>
</td></tr>
<tr><td><code>model</code></td>
<td>
<p>A text string describing the model fit.</p>
</td></tr>
<tr><td><code>mcmc.info</code></td>
<td>
<p>A vector giving details of the numbers of MCMC samples generated.</p>
</td></tr>
<tr><td><code>X</code></td>
<td>
<p>The design matrix of covariates.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Duncan Lee
</p>


<h3>References</h3>

<p>Rushworth, A., D. Lee, and R. Mitchell (2014). A spatio-temporal model for estimating
the long-term effects of air pollution on respiratory hospital admissions in Greater
London. Spatial and Spatio-temporal Epidemiology 10, 29-38.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>#################################################
#### Run the model on simulated data on a lattice
#################################################
#### set up the regular lattice    
x.easting &lt;- 1:10
x.northing &lt;- 1:10
Grid &lt;- expand.grid(x.easting, x.northing)
K &lt;- nrow(Grid)
N &lt;- 10
N.all &lt;- N * K

    
#### set up spatial neighbourhood matrix W
distance &lt;- as.matrix(dist(Grid))
W &lt;-array(0, c(K,K))
W[distance==1] &lt;-1 	


#### Simulate the elements in the linear predictor and the data
gamma &lt;- rnorm(n=N.all, mean=0, sd=0.001)
x &lt;- rnorm(n=N.all, mean=0, sd=1)
beta &lt;- 0.1
    
Q.W &lt;- 0.99 * (diag(apply(W, 2, sum)) - W) + 0.01 * diag(rep(1,K))
Q.W.inv &lt;- solve(Q.W)
phi.temp &lt;- mvrnorm(n=1, mu=rep(0,K), Sigma=(0.1 * Q.W.inv))
phi &lt;- phi.temp
    for(i in 2:N)
    {
    phi.temp2 &lt;- mvrnorm(n=1, mu=(0.8 * phi.temp), Sigma=(0.1 * Q.W.inv))
    phi.temp &lt;- phi.temp2
    phi &lt;- c(phi, phi.temp)
    }
    
LP &lt;- 3 + x * beta  + phi
mean &lt;- exp(LP)
Y &lt;- rpois(n=N.all, lambda=mean)
    

#### Run the model
## Not run: model &lt;- ST.CARar(formula=Y~x, family="poisson",  W=W, burnin=10000,
    n.sample=50000, AR=1)
## End(Not run)
    
    
#### Toy example for checking  
model &lt;- ST.CARar(formula=Y~x, family="poisson",  W=W, burnin=10,
    n.sample=50, AR=1)
</code></pre>

<hr>
<h2 id='ST.CARclustrends'>
Fit a spatio-temporal generalised linear mixed model to data, with a clustering 
of temporal trend functions and a temporally common spatial surface.
</h2><span id='topic+ST.CARclustrends'></span>

<h3>Description</h3>

<p>Fit a spatio-temporal generalised linear mixed model to areal unit data, where the 
response variable can be binomial or Poisson. The linear predictor is modelled by 
known covariates, a temoporally common spatial surface, and a mixture of temporal 
trend functions. The spatial component is modelled by the conditional autoregressive 
(CAR) prior proposed by Leroux et al. (2000). The temporal trend functions are 
user-specified and are fixed parametric forms (e.g. linear, step-change) or 
constrained shapes (e.g. monotonically increasing). Further details are given 
in Napier et al. (2018) and in the vignette accompanying this package. Inference 
is conducted in a Bayesian setting using Metropolis coupled Markov chain Monte 
Carlo (MCMCMC) simulation. 
</p>


<h3>Usage</h3>

<pre><code class='language-R'>    ST.CARclustrends(formula, family, data=NULL, trials=NULL, W, burnin, n.sample,
    thin=1, trends=NULL, changepoint=NULL, knots=NULL, prior.mean.beta=NULL,
    prior.var.beta=NULL, prior.mean.gamma=NULL, prior.var.gamma=NULL,
    prior.lambda=NULL, prior.tau2=NULL, Nchains=4, verbose=TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="ST.CARclustrends_+3A_formula">formula</code></td>
<td>

<p>A formula using the syntax of the lm() function. However, due to identifiability 
issues covariates are not allowed. So the only elements allowed on the right side
of the formula are an intercept term and an offset term using the offset() 
function. The response variable and the offset (if specified) should be vectors 
of length (KN)*1, where K is the number of spatial units and N is the number of 
time periods. Each vector should be ordered so that the first K data points are 
the set of all K spatial locations at time 1, the next K are the set of spatial 
locations for time 2 and so on.
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_family">family</code></td>
<td>

<p>One of either &quot;binomial&quot; or&quot;poisson&quot;, which respectively specify a binomial 
likelihood model with a logistic link function, or a Poisson likelihood model 
with a log link function.
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_data">data</code></td>
<td>

<p>An optional data.frame containing the variables in the formula.
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_trials">trials</code></td>
<td>

<p>A vector the same length and in the same order as the response containing the 
total number of trials for each area and time period. Only used if family=&quot;binomial&quot;.     
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_w">W</code></td>
<td>
<p>A non-negative K by K neighbourhood matrix (where K is the number of 
spatial units). Typically a binary specification is used, where the jkth 
element equals one if areas (j, k) are spatially close (e.g. share a common 
border) and is zero otherwise. The matrix can be non-binary, but each row must 
contain at least one non-zero entry.
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_burnin">burnin</code></td>
<td>

<p>The number of MCMC samples to discard as the burn-in period.
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_n.sample">n.sample</code></td>
<td>

<p>The number of MCMC samples to generate.
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_thin">thin</code></td>
<td>

<p>The level of thinning to apply to the MCMC samples to reduce their temporal 
autocorrelation. Defaults to 1 (no thinning).
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_trends">trends</code></td>
<td>

<p>A vector containing the temporal trend functions to include in the model, which 
include: constant (&quot;Constant&quot;&quot;); linear decreasing (&quot;LD&quot;); linear increasing 
(&quot;LI&quot;); Known change point, where the trend can increase towards the change point 
before subsequently decreasing (&quot;CP&quot;); or decrease towards the change point before 
subsequently increasing (&quot;CT&quot;); and monotonic cubic splines which are decreasing 
(&quot;MD&quot;) or increasing (&quot;MI&quot;). At least two trends have to be selected, with the 
constant trend always included. To avoid identifiability problems only one of &quot;LI&quot; 
or &quot;MI&quot; can be included at a given time (similarily for &quot;LD&quot; and &quot;MD&quot;).
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_changepoint">changepoint</code></td>
<td>

<p>A scalar indicating the position of the change point should one of the change point 
trend functions be included in the trends vector, i.e. if &quot;CP&quot; or &quot;CT&quot; is specified.
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_knots">knots</code></td>
<td>

<p>A scalar indicating the number of knots to use should one of the monotonic cubic 
splines trend functions be included in the trends vector, i.e. if &quot;MD&quot; or &quot;MI&quot; is 
specified.
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_prior.mean.beta">prior.mean.beta</code></td>
<td>

<p>A vector of prior means for the regression parameters beta (Gaussian priors are 
assumed). Defaults to a vector of zeros.
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_prior.var.beta">prior.var.beta</code></td>
<td>

<p>A vector of prior variances for the regression parameters beta (Gaussian priors 
are assumed). Defaults to a vector with values 100,000.
</p>
</td></tr>  
<tr><td><code id="ST.CARclustrends_+3A_prior.mean.gamma">prior.mean.gamma</code></td>
<td>

<p>A vector of prior means for the temporal trend parameters (Gaussian priors are 
assumed). Defaults to a vector of zeros.
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_prior.var.gamma">prior.var.gamma</code></td>
<td>

<p>A vector of prior variances for the temporal trend parameters (Gaussian priors 
are assumed). Defaults to a vector with values 100,000.
</p>
</td></tr>  
<tr><td><code id="ST.CARclustrends_+3A_prior.lambda">prior.lambda</code></td>
<td>

<p>A vector of prior samples sizes for the Dirichlet prior controlling the 
probabilities that each trend function is chosen. The vector should be the same 
length as the trends vector and defaults to a vector of ones.
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_prior.tau2">prior.tau2</code></td>
<td>

<p>The prior shape and scale in the form of c(shape, scale) for an Inverse-Gamma(shape, scale) 
prior for the random effect variances tau2. Defaults to c(1, 0.01).  
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_nchains">Nchains</code></td>
<td>

<p>The number of parallel Markov chains to be used in the Metropolis coupled Markov 
chain Monte Carlo (MCMCMC) simulations. Defaults to 4.
</p>
</td></tr>
<tr><td><code id="ST.CARclustrends_+3A_verbose">verbose</code></td>
<td>

<p>Logical, should the function update the user on its progress.  
</p>
</td></tr>
</table>


<h3>Value</h3>

<table>
<tr><td><code>summary.results</code></td>
<td>
<p>A summary table of the parameters.</p>
</td></tr>
<tr><td><code>samples</code></td>
<td>
<p>A list containing the MCMC samples from the model.</p>
</td></tr>
<tr><td><code>fitted.values</code></td>
<td>
<p>A vector of fitted values for each area and time period.</p>
</td></tr>
<tr><td><code>residuals</code></td>
<td>
<p>A matrix with 2 columns where each column is a type of 
residual and each row relates to an area and time period. The types are &quot;response&quot; 
(raw), and &quot;pearson&quot;.</p>
</td></tr>
<tr><td><code>modelfit</code></td>
<td>
<p>Model fit criteria including the Deviance Information Criterion 
(DIC) and its corresponding estimated effective number of parameters (p.d), the Log 
Marginal Predictive Likelihood (LMPL), the Watanabe-Akaike Information Criterion 
(WAIC) and its corresponding estimated number of effective parameters (p.w), and
the loglikelihood.</p>
</td></tr>
<tr><td><code>accept</code></td>
<td>
<p>The acceptance probabilities for the parameters.</p>
</td></tr>
<tr><td><code>localised.structure</code></td>
<td>
<p>A list containing two elements. The first is &quot;trends&quot;,
which is a vector the same length and in the same order as the number of areas. 
The kth element specifies which trend area k has been allocated to based on the 
posterior mode. The second element is &quot;trend.probs&quot;, which is a matrix containing 
the probabilities associated with each trend for each areal unit.</p>
</td></tr>
<tr><td><code>formula</code></td>
<td>
<p>The formula (as a text string) for the response, covariate and 
offset parts of the model.</p>
</td></tr>
<tr><td><code>model</code></td>
<td>
<p>A text string describing the model fit.</p>
</td></tr>
<tr><td><code>X</code></td>
<td>
<p>The design matrix of covariates.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Gary Napier
</p>


<h3>References</h3>

<p>Leroux, B., Lei, X., and Breslow, N. (2000). Estimation of disease rates in small 
areas: A new mixed model for spatial dependence, Chapter Statistical Models in 
Epidemiology, the Environment and Clinical Trials, Halloran, M and Berry, D (eds),
pp. 135-178. Springer-Verlag, New York.
</p>
<p>Napier, G., Lee, D., Robertson, C., and Lawson, A. (2019). A Bayesian space-time 
model for clustering areal units based on their disease trends, Biostatistics,
20, 681-697.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>##################################################
#### Run the model on simulated data on a lattice
##################################################
#### Load libraries
library(truncnorm)
library(gtools)


#### set up the regular lattice    
x.easting &lt;- 1:10
x.northing &lt;- 1:10
Grid &lt;- expand.grid(x.easting, x.northing)
K &lt;- nrow(Grid)
N &lt;- 10
N.all &lt;- N * K

#### set up spatial neighbourhood matrix W
distance &lt;- as.matrix(dist(Grid))
W &lt;-array(0, c(K,K))
W[distance==1] &lt;-1 	


#### Create the spatial covariance matrix
Q.W &lt;- 0.99 * (diag(apply(W, 2, sum)) - W) + 0.01 * diag(rep(1,K))
Q.W.inv &lt;- solve(Q.W)
  
           
#### Simulate the elements in the linear predictor and the data
beta &lt;- 0.01
gamma &lt;- 0.7
phi &lt;- mvrnorm(n=1, mu=rep(0,K), Sigma=(0.01 * Q.W.inv))

lambda &lt;- rep(1/2, 2)
w &lt;- t(rmultinom(K, 1, lambda))

Y &lt;- matrix(NA, nrow = K, ncol = N)
for (i in 1:N)
{
  LP &lt;- beta + w[, 2] * (gamma * i) + phi
  mean &lt;- exp(LP)
  Y[, i] &lt;- rpois(n=K, lambda=mean)
 }
Y &lt;- as.numeric(Y)


#### Run the model
## Not run: model &lt;- ST.CARclustrends(formula=Y~1, family="poisson", W=W, burnin=10000, 
n.sample=50000, trends=c("Constant", "LI"))
## End(Not run)


#### Toy example for checking
model &lt;- ST.CARclustrends(formula=Y~1, family="poisson", W=W, burnin=10, 
n.sample=50, trends=c("Constant", "LI"))
</code></pre>

<hr>
<h2 id='ST.CARlinear'>
Fit a spatio-temporal generalised linear mixed model to data, where the spatial
units have linear time trends with spatially varying intercepts and slopes.
</h2><span id='topic+ST.CARlinear'></span>

<h3>Description</h3>

<p>Fit a spatio-temporal generalised linear mixed model to areal unit data, where the 
response variable can be binomial, Gaussian or Poisson. The linear predictor is 
modelled by known covariates and an area specific linear time trend. The area 
specific intercepts and slopes are spatially autocorrelated and modelled by the 
conditional autoregressive (CAR) prior proposed by Leroux et al. (2000). The model 
is similar to that proposed by Bernardinelli et al. (1995) and further details are 
given in the vignette accompanying this package. Missing values are allowed in the 
response in this model, and are sampled from in the model using data augmentation. 
Inference is conducted in a Bayesian setting using Markov chain Monte Carlo (MCMC) 
simulation. 
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ST.CARlinear(formula, family, data=NULL,  trials=NULL, W, burnin, n.sample, thin=1, 
n.chains=1,  n.cores=1, prior.mean.beta=NULL, prior.var.beta=NULL, 
prior.mean.alpha=NULL, prior.var.alpha=NULL, prior.nu2=NULL, prior.tau2=NULL, 
rho.slo=NULL, rho.int=NULL, MALA=TRUE, verbose=TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="ST.CARlinear_+3A_formula">formula</code></td>
<td>

<p>A formula for the covariate part of the model using the syntax of the lm() 
function. Offsets can be included here using the offset() function. The response 
and each covariate should be vectors of length (KN)*1, where K is the number of 
spatial units and N is the number of time periods. Each vector should be ordered 
so that the first K data points are the set of all K spatial locations at time 1, 
the next K are the set of spatial locations for time 2 and so on. The response can 
contain missing (NA) values.
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_family">family</code></td>
<td>

<p>One of either &quot;binomial&quot;, &quot;gaussian&quot; or &quot;poisson&quot;, which respectively specify a 
binomial likelihood model with a logistic link function, a Gaussian likelihood 
model with an identity link function, or a Poisson likelihood model with a log 
link function.
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_data">data</code></td>
<td>

<p>An optional data.frame containing the  variables in the formula.
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_trials">trials</code></td>
<td>

<p>A vector the same length and in the same order as the response containing the 
total number of trials for each area and time period. Only used if family=&quot;binomial&quot;. 
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_w">W</code></td>
<td>
<p>A non-negative K by K neighbourhood matrix (where K is the number of 
spatial units). Typically a binary specification is used, where the jkth 
element equals one if areas (j, k) are spatially close (e.g. share a common 
border) and is zero otherwise. The matrix can be non-binary, but each row must 
contain at least one non-zero entry.
</p>
</td></tr> 
<tr><td><code id="ST.CARlinear_+3A_burnin">burnin</code></td>
<td>

<p>The number of MCMC samples to discard as the burn-in period.
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_n.sample">n.sample</code></td>
<td>

<p>The number of MCMC samples to generate.
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_thin">thin</code></td>
<td>

<p>The level of thinning to apply to the MCMC samples to reduce their temporal 
autocorrelation. Defaults to 1 (no thinning).
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_n.chains">n.chains</code></td>
<td>

<p>The number of MCMC chains to run when fitting the model. Defaults to 1.
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_n.cores">n.cores</code></td>
<td>

<p>The number of computer cores to run the MCMC chains on. Must be less than or 
equal to n.chains. Defaults to 1.
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_prior.mean.beta">prior.mean.beta</code></td>
<td>

<p>A vector of prior means for the regression parameters beta (Gaussian priors are 
assumed). Defaults to a vector of zeros.
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_prior.var.beta">prior.var.beta</code></td>
<td>

<p>A vector of prior variances for the regression parameters beta (Gaussian priors 
are assumed). Defaults to a vector with values 100,000.
</p>
</td></tr>  
<tr><td><code id="ST.CARlinear_+3A_prior.mean.alpha">prior.mean.alpha</code></td>
<td>

<p>The prior mean for the average slope of the linear time trend alpha (a Gaussian prior
is assumed). Defaults to  zero.
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_prior.var.alpha">prior.var.alpha</code></td>
<td>

<p>The prior variance for the average slope of the linear time trend alpha (a Gaussian 
prior is assumed). Defaults to 100,000.
</p>
</td></tr>  
<tr><td><code id="ST.CARlinear_+3A_prior.nu2">prior.nu2</code></td>
<td>

<p>The prior shape and scale in the form of c(shape, scale) for an Inverse-Gamma(shape, scale) 
prior for nu2. Defaults to c(1, 0.01) and only used if family=&quot;Gaussian&quot;.   
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_prior.tau2">prior.tau2</code></td>
<td>

<p>The prior shape and scale in the form of c(shape, scale) for an Inverse-Gamma(shape, scale) 
prior for tau2. Defaults to c(1, 0.01).  
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_rho.slo">rho.slo</code></td>
<td>

<p>The value in the interval [0, 1] that the spatial dependence parameter for the 
slope of the linear time trend, rho.slo, is fixed at if it should not be estimated. 
If this arugment is NULL then rho.slo is estimated in the model. 
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_rho.int">rho.int</code></td>
<td>

<p>The value in the interval [0, 1] that the spatial dependence parameter for the 
intercept of the linear time trend, rho.int, is fixed at if it should not be 
estimated. If this arugment is NULL then rho.int is estimated in the model. 
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_mala">MALA</code></td>
<td>

<p>Logical, should the function use Metropolis adjusted Langevin algorithm (MALA)
updates (TRUE, default) or simple random walk (FALSE) updates for the regression 
parameters. Not applicable if family=&quot;gaussian&quot;.    
</p>
</td></tr>
<tr><td><code id="ST.CARlinear_+3A_verbose">verbose</code></td>
<td>

<p>Logical, should the function update the user on its progress.  
</p>
</td></tr>
</table>


<h3>Value</h3>

<table>
<tr><td><code>summary.results</code></td>
<td>
<p>A summary table of the parameters.</p>
</td></tr>
<tr><td><code>samples</code></td>
<td>
<p>A list containing the MCMC samples from the model.</p>
</td></tr>
<tr><td><code>fitted.values</code></td>
<td>
<p>A vector of fitted values for each area and time period.</p>
</td></tr>
<tr><td><code>residuals</code></td>
<td>
<p>A matrix with 2 columns where each column is a type of 
residual and each row relates to an area and time period. The types are &quot;response&quot; 
(raw), and &quot;pearson&quot;.</p>
</td></tr>
<tr><td><code>modelfit</code></td>
<td>
<p>Model fit criteria including the Deviance Information Criterion 
(DIC) and its corresponding estimated effective number of parameters (p.d), the Log 
Marginal Predictive Likelihood (LMPL), the Watanabe-Akaike Information Criterion 
(WAIC) and its corresponding estimated number of effective parameters (p.w), and
the loglikelihood.</p>
</td></tr>
<tr><td><code>accept</code></td>
<td>
<p>The acceptance probabilities for the parameters.</p>
</td></tr>
<tr><td><code>localised.structure</code></td>
<td>
<p>NULL, for compatability with the other models.</p>
</td></tr>
<tr><td><code>formula</code></td>
<td>
<p>The formula (as a text string) for the response, covariate and 
offset parts of the model.</p>
</td></tr>
<tr><td><code>model</code></td>
<td>
<p>A text string describing the model fit.</p>
</td></tr>
<tr><td><code>mcmc.info</code></td>
<td>
<p>A vector giving details of the numbers of MCMC samples generated.</p>
</td></tr>
<tr><td><code>X</code></td>
<td>
<p>The design matrix of covariates.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Duncan Lee
</p>


<h3>References</h3>

<p>Bernardinelli, L., D. Clayton, C.Pascuto, C.Montomoli, M.Ghislandi, and M. Songini
(1995). Bayesian analysis of space-time variation in disease risk. Statistics in 
Medicine, 14, 2433-2443.
</p>
<p>Leroux, B., X. Lei, and N. Breslow (2000). Estimation of disease rates in small 
areas: A new mixed model for spatial dependence, Chapter Statistical Models in 
Epidemiology, the Environment and Clinical Trials, Halloran, M and Berry, D (eds),
pp. 135-178. Springer-Verlag, New York.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>#################################################
#### Run the model on simulated data on a lattice
#################################################
#### set up the regular lattice    
x.easting &lt;- 1:10
x.northing &lt;- 1:10
Grid &lt;- expand.grid(x.easting, x.northing)
K &lt;- nrow(Grid)
N &lt;- 10
N.all &lt;- K * N


#### set up spatial neighbourhood matrix W
distance &lt;- as.matrix(dist(Grid))
W &lt;-array(0, c(K,K))
W[distance==1] &lt;-1 	


#### Simulate the elements in the linear predictor and the data
x &lt;- rnorm(n=N.all, mean=0, sd=1)
beta &lt;- 0.1
Q.W &lt;- 0.99 * (diag(apply(W, 2, sum)) - W) + 0.01 * diag(rep(1,K))
Q.W.inv &lt;- solve(Q.W)
phi &lt;- mvrnorm(n=1, mu=rep(0,K), Sigma=(0.1 * Q.W.inv))
delta &lt;- mvrnorm(n=1, mu=rep(0,K), Sigma=(0.1 * Q.W.inv))
trend &lt;- array(NA, c(K, N))
time &lt;-(1:N - mean(1:N))/N
    for(i in 1:K)
    {
    trend[i, ] &lt;- phi[i] + delta[i] * time        
    }
trend.vec &lt;- as.numeric(trend)
LP &lt;- 4 + x * beta + trend.vec
mean &lt;- exp(LP)
Y &lt;- rpois(n=N.all, lambda=mean)


#### Run the model
## Not run: model &lt;- ST.CARlinear(formula=Y~x, family="poisson", W=W, burnin=10000, 
n.sample=50000)
## End(Not run)


#### Toy example for checking 
model &lt;- ST.CARlinear(formula=Y~x, family="poisson", W=W, burnin=10, 
n.sample=50)
</code></pre>

<hr>
<h2 id='ST.CARlocalised'>
Fit a spatio-temporal generalised linear mixed model to data, with a spatio-temporal
autoregressive process and a piecewise constant intercept term.
</h2><span id='topic+ST.CARlocalised'></span>

<h3>Description</h3>

<p>Fit a spatio-temporal generalised linear mixed model to areal unit data, where the 
response variable can be binomial or Poisson. The linear predictor is modelled by 
known covariates, a vector of random effects and a piecewise constant intercept 
process. The random effects follow the multivariate first order autoregressive 
time series process proposed by Rushworth et al.(2014), which is the same as that 
used in the ST.CARar() function. The piecewise constant intercept component allows
neighbouring areal units to have very different values if they are assigned to a 
different intercept component. This model allows for localised smoothness, because 
some pairs of neighbouring areas or time periods can have similar values (same 
intercept) while other neighbouring pairs have very different values (different 
intercepts). Furter details are given in Lee and Lawson (2016) and in the vignette 
accompanying this package. Inference is conducted in a Bayesian setting using 
Markov chain Monte Carlo (MCMC) simulation. 
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ST.CARlocalised(formula, family, data=NULL,  G, trials=NULL, W, burnin, n.sample, 
thin=1, n.chains=1,  n.cores=1, prior.mean.beta=NULL, prior.var.beta=NULL, 
prior.delta=NULL, prior.tau2=NULL, MALA=TRUE, verbose=TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="ST.CARlocalised_+3A_formula">formula</code></td>
<td>

<p>A formula for the covariate part of the model using the syntax of the lm() 
function. Offsets can be included here using the offset() function. The response 
and each covariate should be vectors of length (KN)*1, where K is the number of 
spatial units and N is the number of time periods. Each vector should be ordered 
so that the first K data points are the set of all K spatial locations at time 1, 
the next K are the set of spatial locations for time 2 and so on. The response 
must NOT contain missing (NA) values.
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_family">family</code></td>
<td>

<p>One of either &quot;binomial&quot;, or &quot;poisson&quot;, which respectively specify a binomial 
likelihood model with a logistic link function, or a Poisson likelihood model 
with a log link function.
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_data">data</code></td>
<td>

<p>An optional data.frame containing the  variables in the formula.
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_g">G</code></td>
<td>

<p>The maximum number of distinct intercept terms (clusters) to allow in the model.
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_trials">trials</code></td>
<td>

<p>A vector the same length and in the same order as the response containing the 
total number of trials for each area and time period. Only used if family=&quot;binomial&quot;. 
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_w">W</code></td>
<td>
<p>A non-negative K by K neighbourhood matrix (where K is the number of 
spatial units). Typically a binary specification is used, where the jkth 
element equals one if areas (j, k) are spatially close (e.g. share a common 
border) and is zero otherwise. The matrix can be non-binary, but each row must 
contain at least one non-zero entry.
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_burnin">burnin</code></td>
<td>

<p>The number of MCMC samples to discard as the burn-in period.
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_n.sample">n.sample</code></td>
<td>

<p>The number of MCMC samples to generate.
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_thin">thin</code></td>
<td>

<p>The level of thinning to apply to the MCMC samples to reduce their temporal 
autocorrelation. Defaults to 1 (no thinning).
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_n.chains">n.chains</code></td>
<td>

<p>The number of MCMC chains to run when fitting the model. Defaults to 1.
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_n.cores">n.cores</code></td>
<td>

<p>The number of computer cores to run the MCMC chains on. Must be less than or 
equal to n.chains. Defaults to 1.
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_prior.mean.beta">prior.mean.beta</code></td>
<td>

<p>A vector of prior means for the regression parameters beta (Gaussian priors are 
assumed). Defaults to a vector of zeros.
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_prior.var.beta">prior.var.beta</code></td>
<td>

<p>A vector of prior variances for the regression parameters beta (Gaussian priors 
are assumed). Defaults to a vector with values 100,000.
</p>
</td></tr>   
<tr><td><code id="ST.CARlocalised_+3A_prior.delta">prior.delta</code></td>
<td>

<p>The prior maximum M, in a Uniform(0,M) prior, for the intercept process smoothing 
parameter delta. Defaults to 10.  
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_prior.tau2">prior.tau2</code></td>
<td>

<p>The prior shape and scale in the form of c(shape, scale) for an Inverse-Gamma(shape, scale) 
prior for tau2. Defaults to c(1, 0.01).  
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_mala">MALA</code></td>
<td>

<p>Logical, should the function use Metropolis adjusted Langevin algorithm (MALA)
updates (TRUE, default) or simple random walk (FALSE) updates for the regression 
parameters. Not applicable if family=&quot;gaussian&quot;.    
</p>
</td></tr>
<tr><td><code id="ST.CARlocalised_+3A_verbose">verbose</code></td>
<td>

<p>Logical, should the function update the user on its progress.  
</p>
</td></tr>
</table>


<h3>Value</h3>

<table>
<tr><td><code>summary.results</code></td>
<td>
<p>A summary table of the parameters.</p>
</td></tr>
<tr><td><code>samples</code></td>
<td>
<p>A list containing the MCMC samples from the model.</p>
</td></tr>
<tr><td><code>fitted.values</code></td>
<td>
<p>A vector of fitted values for each area and time period.</p>
</td></tr>
<tr><td><code>residuals</code></td>
<td>
<p>A matrix with 2 columns where each column is a type of 
residual and each row relates to an area and time period. The types are &quot;response&quot; 
(raw), and &quot;pearson&quot;.</p>
</td></tr>
<tr><td><code>modelfit</code></td>
<td>
<p>Model fit criteria including the Deviance Information Criterion 
(DIC) and its corresponding estimated effective number of parameters (p.d), the Log 
Marginal Predictive Likelihood (LMPL), the Watanabe-Akaike Information Criterion 
(WAIC) and its corresponding estimated number of effective parameters (p.w), and
the loglikelihood.</p>
</td></tr>
<tr><td><code>accept</code></td>
<td>
<p>The acceptance probabilities for the parameters.</p>
</td></tr>
<tr><td><code>localised.structure</code></td>
<td>
<p>A vector giving the posterior mean of which intercept 
component (cluster) each data point is in.</p>
</td></tr>
<tr><td><code>formula</code></td>
<td>
<p>The formula (as a text string) for the response, covariate and 
offset parts of the model.</p>
</td></tr>
<tr><td><code>model</code></td>
<td>
<p>A text string describing the model fit.</p>
</td></tr>
<tr><td><code>mcmc.info</code></td>
<td>
<p>A vector giving details of the numbers of MCMC samples generated.</p>
</td></tr>
<tr><td><code>X</code></td>
<td>
<p>The design matrix of covariates.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Duncan Lee
</p>


<h3>References</h3>

<p>Lee, D and Lawson, C  (2016). Quantifying the spatial inequality and temporal trends in
maternal smoking rates in Glasgow, Annals of Applied Statistics, 10, 1427-1446.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>#################################################
#### Run the model on simulated data on a lattice
#################################################
#### set up the regular lattice    
x.easting &lt;- 1:10
x.northing &lt;- 1:10
Grid &lt;- expand.grid(x.easting, x.northing)
K &lt;- nrow(Grid)
N &lt;- 10
N.all &lt;- N * K
   
    
#### set up spatial neighbourhood matrix W
distance &lt;- as.matrix(dist(Grid))
W &lt;-array(0, c(K,K))
W[distance==1] &lt;-1 	


#### Simulate the elements in the linear predictor and the data
Q.W &lt;- 0.99 * (diag(apply(W, 2, sum)) - W) + 0.01 * diag(rep(1,K))
Q.W.inv &lt;- solve(Q.W)
phi.temp &lt;- mvrnorm(n=1, mu=rep(0,K), Sigma=(0.1 * Q.W.inv))
phi &lt;- phi.temp
    for(i in 2:N)
    {
    phi.temp2 &lt;- mvrnorm(n=1, mu=(0.8 * phi.temp), Sigma=(0.1 * Q.W.inv))
    phi.temp &lt;- phi.temp2
    phi &lt;- c(phi, phi.temp)
    }
jump &lt;- rep(c(rep(2, 70), rep(4, 30)),N)
LP &lt;- jump + phi
fitted &lt;- exp(LP)
Y &lt;- rpois(n=N.all, lambda=fitted)


#### Run the model     
## Not run: model &lt;- ST.CARlocalised(formula=Y~1, family="poisson", G=3, W=W, burnin=10000,
n.sample=50000)
## End(Not run)


#### Toy example for checking
model &lt;- ST.CARlocalised(formula=Y~1, family="poisson", G=3, W=W, burnin=10,
n.sample=50)
</code></pre>

<hr>
<h2 id='ST.CARsepspatial'>
Fit a spatio-temporal generalised linear mixed model to data, with a common 
temporal main effect and separate spatial surfaces with individual variances.
</h2><span id='topic+ST.CARsepspatial'></span>

<h3>Description</h3>

<p>Fit a spatio-temporal generalised linear mixed model to areal unit data, where the 
response variable can be binomial or Poisson. The linear predictor is modelled by
known covariates and two sets of random effects. These include a common temporal 
main effect, and separate time period specific spatial effects with a common 
spatial dependence parameter but separate variance parameters. Each component is 
modelled by the conditional autoregressive (CAR) prior proposed by Leroux et al. 
(2000). Further details are given in Napier et al. (2016) and in the vignette 
accompanying this package. Inference is conducted in a Bayesian setting using 
Markov chain Monte Carlo (MCMC) simulation. 
</p>


<h3>Usage</h3>

<pre><code class='language-R'>ST.CARsepspatial(formula, family, data=NULL,  trials=NULL, W, burnin, n.sample,
thin=1, n.chains=1,  n.cores=1, prior.mean.beta=NULL, prior.var.beta=NULL, 
prior.tau2=NULL, rho.S=NULL, rho.T=NULL, MALA=TRUE, verbose=TRUE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="ST.CARsepspatial_+3A_formula">formula</code></td>
<td>

<p>A formula for the covariate part of the model using the syntax of the lm() 
function. Offsets can be included here using the offset() function. The response 
and each covariate should be vectors of length (KN)*1, where K is the number of 
spatial units and N is the number of time periods. Each vector should be ordered 
so that the first K data points are the set of all K spatial locations at time 1, 
the next K are the set of spatial locations for time 2 and so on. The response 
must NOT contain missing (NA) values.
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_family">family</code></td>
<td>

<p>One of either &quot;binomial&quot; or &quot;poisson&quot;, which respectively specify a binomial 
likelihood model with a logistic link function, or a Poisson likelihood model with
a log link function.
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_data">data</code></td>
<td>

<p>An optional data.frame containing the  variables in the formula.
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_trials">trials</code></td>
<td>

<p>A vector the same length and in the same order as the response containing the 
total number of trials for each area and time period. Only used if family=&quot;binomial&quot;. 
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_w">W</code></td>
<td>
<p>A non-negative K by K neighbourhood matrix (where K is the number of 
spatial units). Typically a binary specification is used, where the jkth 
element equals one if areas (j, k) are spatially close (e.g. share a common 
border) and is zero otherwise. The matrix can be non-binary, but each row must 
contain at least one non-zero entry.
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_burnin">burnin</code></td>
<td>

<p>The number of MCMC samples to discard as the burn-in period.
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_n.sample">n.sample</code></td>
<td>

<p>The number of MCMC samples to generate.
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_thin">thin</code></td>
<td>

<p>The level of thinning to apply to the MCMC samples to reduce their temporal 
autocorrelation. Defaults to 1 (no thinning).
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_n.chains">n.chains</code></td>
<td>

<p>The number of MCMC chains to run when fitting the model. Defaults to 1.
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_n.cores">n.cores</code></td>
<td>

<p>The number of computer cores to run the MCMC chains on. Must be less than or 
equal to n.chains. Defaults to 1.
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_prior.mean.beta">prior.mean.beta</code></td>
<td>

<p>A vector of prior means for the regression parameters beta (Gaussian priors are 
assumed). Defaults to a vector of zeros.
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_prior.var.beta">prior.var.beta</code></td>
<td>

<p>A vector of prior variances for the regression parameters beta (Gaussian priors 
are assumed). Defaults to a vector with values 100,000.
</p>
</td></tr>  
<tr><td><code id="ST.CARsepspatial_+3A_prior.tau2">prior.tau2</code></td>
<td>

<p>The prior shape and scale in the form of c(shape, scale) for an Inverse-Gamma(shape, scale) 
prior for tau2. Defaults to c(1, 0.01).  
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_rho.s">rho.S</code></td>
<td>

<p>The value in the interval [0, 1] that the spatial dependence parameter rho.S is 
fixed at if it should not be estimated. If this arugment is NULL then rho.S is
estimated in the model. 
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_rho.t">rho.T</code></td>
<td>

<p>The value in the interval [0, 1] that the temporal dependence parameter rho.T is 
fixed at if it should not be estimated. If this arugment is NULL then rho.T is
estimated in the model. 
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_mala">MALA</code></td>
<td>

<p>Logical, should the function use Metropolis adjusted Langevin algorithm (MALA)
updates (TRUE, default) or simple random walk (FALSE) updates for the regression 
parameters. Not applicable if family=&quot;gaussian&quot;.    
</p>
</td></tr>
<tr><td><code id="ST.CARsepspatial_+3A_verbose">verbose</code></td>
<td>

<p>Logical, should the function update the user on its progress.  
</p>
</td></tr>
</table>


<h3>Value</h3>

<table>
<tr><td><code>summary.results</code></td>
<td>
<p>A summary table of the parameters.</p>
</td></tr>
<tr><td><code>samples</code></td>
<td>
<p>A list containing the MCMC samples from the model.</p>
</td></tr>
<tr><td><code>fitted.values</code></td>
<td>
<p>A vector of fitted values for each area and time period.</p>
</td></tr>
<tr><td><code>residuals</code></td>
<td>
<p>A matrix with 2 columns where each column is a type of 
residual and each row relates to an area and time period. The types are &quot;response&quot; 
(raw), and &quot;pearson&quot;.</p>
</td></tr>
<tr><td><code>modelfit</code></td>
<td>
<p>Model fit criteria including the Deviance Information Criterion 
(DIC) and its corresponding estimated effective number of parameters (p.d), the Log 
Marginal Predictive Likelihood (LMPL), the Watanabe-Akaike Information Criterion 
(WAIC) and its corresponding estimated number of effective parameters (p.w), and
the loglikelihood.</p>
</td></tr>
<tr><td><code>accept</code></td>
<td>
<p>The acceptance probabilities for the parameters.</p>
</td></tr>
<tr><td><code>localised.structure</code></td>
<td>
<p>NULL, for compatability with the other models.</p>
</td></tr>
<tr><td><code>formula</code></td>
<td>
<p>The formula (as a text string) for the response, covariate and 
offset parts of the model.</p>
</td></tr>
<tr><td><code>model</code></td>
<td>
<p>A text string describing the model fit.</p>
</td></tr>
<tr><td><code>mcmc.info</code></td>
<td>
<p>A vector giving details of the numbers of MCMC samples generated.</p>
</td></tr>
<tr><td><code>X</code></td>
<td>
<p>The design matrix of covariates.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>Gary Napier
</p>


<h3>References</h3>

<p>Napier, G, D. Lee, C. Robertson, A. Lawson, and K. Pollock (2016). A model to 
estimate the impact of changes in MMR vaccination uptake on inequalities in 
measles susceptibility in Scotland, Statistical Methods in Medical Research, 25, 
1185-1200.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>#################################################
#### Run the model on simulated data on a lattice
#################################################
#### set up the regular lattice    
x.easting &lt;- 1:10
x.northing &lt;- 1:10
Grid &lt;- expand.grid(x.easting, x.northing)
K &lt;- nrow(Grid)
N &lt;- 5
N.all &lt;- N * K
  
        
#### set up spatial neighbourhood matrix W
distance &lt;- as.matrix(dist(Grid))
W &lt;-array(0, c(K,K))
W[distance==1] &lt;-1 	


#### Create the spatial covariance matrix
Q.W &lt;- 0.99 * (diag(apply(W, 2, sum)) - W) + 0.01 * diag(rep(1,K))
Q.W.inv &lt;- solve(Q.W)
  
           
#### Simulate the elements in the linear predictor and the data
x &lt;- rnorm(n=N.all, mean=0, sd=1)
beta &lt;- 0.1

phi1 &lt;- mvrnorm(n=1, mu=rep(0,K), Sigma=(0.01 * Q.W.inv))
phi2 &lt;- mvrnorm(n=1, mu=rep(0,K), Sigma=(0.01 * Q.W.inv))
phi3 &lt;- mvrnorm(n=1, mu=rep(0,K), Sigma=(0.01 * Q.W.inv))
phi4 &lt;- mvrnorm(n=1, mu=rep(0,K), Sigma=(0.05 * Q.W.inv))
phi5 &lt;- mvrnorm(n=1, mu=rep(0,K), Sigma=(0.05 * Q.W.inv))
  
delta &lt;- c(0, 0.5, 0, 0.5, 0)
phi.long &lt;- c(phi1, phi2, phi3, phi4, phi5)
delta.long &lt;- kronecker(delta, rep(1,K))
LP &lt;- 4 +  x * beta + phi.long +  delta.long
mean &lt;- exp(LP)
Y &lt;- rpois(n=N.all, lambda=mean)
  
                
#### Run the model
## Not run: model &lt;- ST.CARsepspatial(formula=Y~x, family="poisson", W=W, burnin=10000, 
n.sample=50000)
## End(Not run)


#### Toy example for checking
model &lt;- ST.CARsepspatial(formula=Y~x, family="poisson", W=W, burnin=10, 
n.sample=50)
</code></pre>

<hr>
<h2 id='W.estimate'>Estimate an appropriate neighbourhood matrix for a set of spatial data using a baseline neighbourhood matrix and a  graph based optimisation algorithm. 
</h2><span id='topic+W.estimate'></span>

<h3>Description</h3>

<p>Estimate an appropriate neighbourhood matrix (W.est) for a given set of spatial data (spdata) from a baseline neighbourhood matrix (W) using the graph-based optimisation algorithm proposed by Lee, Meeks and Pettersson (2021). The baseline neighbourhood matrix W should be binary and based on a simple geographical specification such as the border sharing rule. The estimated neighbourhood matrix is constructed by removing neighbour relations (i.e. setting w_ij = w_ji = 0) if they are not appropriate for the data. Note, new edges not in the initial W matrix
cannot be added when creating W.est.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>W.estimate(W, spdata, add=FALSE, remove=TRUE, remove_first=FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="W.estimate_+3A_w">W</code></td>
<td>
<p>A binary K * K neighbourhood matrix, where K is the number of 
spatial units. A typical specification would have the jkth element 
equalling one if areas (j, k) are spatially close (e.g. share a common 
border) and  zero otherwise. Each row must contain at least one non-zero entry.
</p>
</td></tr>
<tr><td><code id="W.estimate_+3A_spdata">spdata</code></td>
<td>

<p>A K * 1 vector of spatial data that you wish to optimise the neighbourhood matrix
for. The kth element of this vector must correspond to the area represented
by the kth row of the W matrix.
</p>
</td></tr>
<tr><td><code id="W.estimate_+3A_add">add</code></td>
<td>

<p>Allow the optimiser to add edges back in to the graph if they have previously been removed. Defaults to FALSE.
</p>
</td></tr>
<tr><td><code id="W.estimate_+3A_remove">remove</code></td>
<td>

<p>Allow the optimiser to remove edges from the graph if they have previously been added in. Defaults to TRUE.
</p>
</td></tr>
<tr><td><code id="W.estimate_+3A_remove_first">remove_first</code></td>
<td>

<p>If only one of add or remove are TRUE, then this option has no effect. If both add and remove are TRUE, then this option determines whether the optimiser first tries to add or remove edges (before alternating between the two phases). Defaults to FALSE, meaning that the optimiser tries to add edges first.
</p>
</td></tr> 
</table>


<h3>Value</h3>

<table>
<tr><td><code>W.est</code></td>
<td>
<p>An optimised K by K neighbourhood matrix.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>William Pettersson (william.pettersson@glasgow.ac.uk) and Kitty Meeks
</p>


<h3>References</h3>

<p>Lee, D and Meeks, K (2020). Improved inference for areal unit count data using graph-based optimisation. arXiv:2010.10893.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>####################################################
#### Run the optmiser on simulated data on a lattice
####################################################
#### Load other libraries required
library(MASS)

#### Set up a square lattice region
x.easting &lt;- 1:10
x.northing &lt;- 1:10
Grid &lt;- expand.grid(x.easting, x.northing)
K &lt;- nrow(Grid)

#### Split the area into two groups between which there will be a boundary.
groups &lt;-rep(1, K) 
groups[Grid$Var1&gt;5] &lt;- 2

#### set up distance and neighbourhood (W, based on sharing a common border) matrices
distance &lt;- as.matrix(dist(Grid))
W &lt;-array(0, c(K,K))
W[distance==1] &lt;-1 	

#### Generate the response data
phi &lt;- mvrnorm(n=1, mu=groups, Sigma=0.05 * exp(-0.1 * distance))
lp &lt;- 4 + phi
Y &lt;- rpois(n=K, lambda =exp(lp))


# Compute the spdata object on the linear predictor scale
spdata &lt;- log(Y) - mean(log(Y))

#### Run W matrix optmiser
W.est &lt;- W.estimate(W, spdata)
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
