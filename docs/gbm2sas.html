<!DOCTYPE html><html lang="en"><head><title>Help for package gbm2sas</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {gbm2sas}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#gbm2sas-package'>
<p>Convert GBM Object Trees to SAS Code</p></a></li>
<li><a href='#gbm2sas'>
<p>Convert GBM Object Trees to SAS Code</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Convert GBM Object Trees to SAS Code</td>
</tr>
<tr>
<td>Version:</td>
<td>3.0</td>
</tr>
<tr>
<td>Date:</td>
<td>2024-01-23</td>
</tr>
<tr>
<td>Author:</td>
<td>John R. Dixon</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>John R. Dixon &lt;gbm2sas@gmail.com&gt;</td>
</tr>
<tr>
<td>Description:</td>
<td>Writes SAS code to get predicted values from every tree of a gbm.object.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a></td>
</tr>
<tr>
<td>Depends:</td>
<td>gbm, utils</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2024-01-23 17:11:04 UTC; user</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2024-01-23 17:40:06 UTC</td>
</tr>
</table>
<hr>
<h2 id='gbm2sas-package'>
Convert GBM Object Trees to SAS Code
</h2><span id='topic+gbm2sas-package'></span>

<h3>Description</h3>

<p>Writes SAS code to get predicted values from every tree of a gbm object. 
</p>


<h3>Author(s)</h3>

<p>John R. Dixon  &lt;gbm2sas@gmail.com&gt;
</p>
<p>Maintainer: John R Dixon &lt;gbm2sas@gmail.com&gt;                     
</p>

<hr>
<h2 id='gbm2sas'>
Convert GBM Object Trees to SAS Code                          
</h2><span id='topic+gbm2sas'></span>

<h3>Description</h3>

<p>Writes SAS code to get predicted values for every tree of a gbm object.  The predicted values
are as reported by the gbm package function pretty.gbm.tree. 
</p>


<h3>Usage</h3>

<pre><code class='language-R'>gbm2sas(
gbmobject,
data=NULL,
sasfile=NULL,
ntrees=NULL,
mysasdata="mysasdata",
treeval="treeval",
prefix="do_"
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="gbm2sas_+3A_gbmobject">gbmobject</code></td>
<td>

<p>An object of type gbm.object.                     
</p>
</td></tr>
<tr><td><code id="gbm2sas_+3A_data">data</code></td>
<td>

<p>Data used to fit gbm.object.
</p>
</td></tr>
<tr><td><code id="gbm2sas_+3A_sasfile">sasfile</code></td>
<td>

<p>Name of file to write the SAS code to. 
</p>
</td></tr>
<tr><td><code id="gbm2sas_+3A_ntrees">ntrees</code></td>
<td>

<p>Optional number of trees to use in prediction.  Default is the value n.trees from gbmobject.                      
</p>
</td></tr>
<tr><td><code id="gbm2sas_+3A_mysasdata">mysasdata</code></td>
<td>

<p>Optional name of dataset operated on in the SAS code. Default is &quot;mysasdata&quot;.
</p>
</td></tr>
<tr><td><code id="gbm2sas_+3A_treeval">treeval</code></td>
<td>

<p>Optional name to use for the value from each gbm tree.  These will have a number appended.
Default variable names will be of the form &quot;treeval1&quot;, &quot;treeval2&quot;, etc. 
Set this to a different prefix to avoid overwriting SAS dataset values, if necessary.
</p>
</td></tr>
<tr><td><code id="gbm2sas_+3A_prefix">prefix</code></td>
<td>

<p>Optional prefix to use for intermediate SAS program control variables.  These will have a number 
appended.  Default variable names will be of the form &quot;do_1&quot;, &quot;do_2&quot;, etc. Set this to a different
prefix to avoid overwriting SAS dataset values, if necessary.
</p>
</td></tr>
</table>


<h3>Value</h3>

<table role = "presentation">
<tr><td><code>sasfile</code></td>
<td>
<p>SAS code will be written to sasfile.</p>
</td></tr>
</table>


<h3>Author(s)</h3>

<p>John R. Dixon &lt;gbm2sas@gmail.com&gt;         
</p>


<h3>References</h3>

<p>Package 'gbm'. Greg Ridgeway with contributions from others.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>set.seed(18221)
# This example is taken from the gbm package documentation.
# create some data
N &lt;- 1000
X1 &lt;- runif(N)
X2 &lt;- 2*runif(N)
X3 &lt;- ordered(sample(letters[1:4],N,replace=TRUE),levels=letters[4:1])
X4 &lt;- factor(sample(letters[1:6],N,replace=TRUE))
X5 &lt;- factor(sample(letters[1:3],N,replace=TRUE))
X6 &lt;- 3*runif(N) 
mu &lt;- c(-1,0,1,2)[as.numeric(X3)]

SNR &lt;- 10 # signal-to-noise ratio
Y &lt;- X1**1.5 + 2 * (X2**.5) + mu
sigma &lt;- sqrt(var(Y)/SNR)
Y &lt;- Y + rnorm(N,0,sigma)

# introduce some missing values
X1[sample(1:N,size=500)] &lt;- NA
X4[sample(1:N,size=300)] &lt;- NA

thedata &lt;- data.frame(Y=Y,X1=X1,X2=X2,X3=X3,X4=X4,X5=X5,X6=X6)

# fit initial model
gbm1 &lt;-
gbm(Y~X1+X2+X3+X4+X5+X6,         
    data=thedata,                   
    var.monotone=c(0,0,0,0,0,0), 
    distribution="gaussian",     
    n.trees=1000,               
    shrinkage=0.05,            
    interaction.depth=3,      
    bag.fraction = 0.5,      
    train.fraction = 1, 
    n.minobsinnode = 10,         
    cv.folds = 3,               
    keep.data=TRUE,            
    verbose=FALSE,            
    n.cores=1)               

# We will pass a csv file to SAS, to demonstrate that the tree values from gbm2sas agree 
# with R.  Note that if train.fraction were &lt;1 above, we would need to pass the 
# analogous subsample to sas via the csv file below. Since the fraction used was 1, 
# we pass the entire dataset "thedata" below.
best.iter&lt;-gbm.perf(gbm1,method="cv",plot.it=FALSE) # find a good number of trees 
fit_from_r&lt;-predict(gbm1, n.trees=best.iter) # get fitted values from R 
avgresponse&lt;-gbm1$initF # we will pass gbm1's intercept to SAS via the csv file        
numtrees&lt;-best.iter # we will pass the total number of trees to SAS via the csv file 
fitdata&lt;-cbind(thedata,avgresponse,numtrees,fit_from_r) # augment the training data
# Write the csv file.  We require SAS's missing() function and R agree on what values 
# are missing.  Hence the "na" argument below, which assures SAS's proc import will 
# assign missing values in agreement with what R considers a missing value.
write.table(fitdata,"checkdata.csv",
sep=",", quote=FALSE, row.names=FALSE, col.names=TRUE, na="") 

# Now use gbm2sas
gbm2sas(
gbm1, # gbm object from above
data=thedata, # dataset used to fit model
sasfile="gbmforest.sas", # name to use for SAS code file
ntrees=best.iter, # number of trees
mysasdata="sasdataset", # name to use for dataset within SAS
treeval="treevalue", # name to use for value returned for each tree from pretty.gbm.tree
prefix="dobranch_" # variable name for controlling branching in SAS code 
)

# SAS program to check R versus SAS fitted values 
#proc import out=sasdataset
#     datafile= "checkdata.csv" /* file written by the R example code */
#     dbms=csv replace;
#     getnames=yes;
#run;
#/* Below we assume the SAS missing() function and R agree on what values are missing.
#The missing values were written by R to checkdata.csv such that proc import will 
#correctly assign a missing value to them. */
#
#%include "gbmforest.sas"; /* SAS code written by gbm2sas */
#
#data sasdataset;
#set sasdataset;
#call symput('numtrees', numtrees); /* define macro variable holding ntrees */
#run;
#
#%macro checksascode(); /* macro to check SAS versus R */
#data sasdataset; set sasdataset;
#fit_from_sas=avgresponse; /* we need to start with the intercept from the gbm.object */
#%DO loop = 1 %TO &amp;numtrees.; 
#fit_from_sas=fit_from_sas+treevalue&amp;loop.; /* add fitted value from each tree */
#%END;
#/* find the discrepancy between R and SAS fitted values for this observation */
#diff=abs(fit_from_sas-fit_from_r); 
#run;
#%mend checksascode;
#
#%checksascode() /* call the checking macro */
#
#/* get worst discrepancy over all observations */
#proc sql; select max(diff) as max_discrepancy from sasdataset; quit; 
#
# output from SAS
#max_discrepancy
#---------------
#       7.33E-15

file.remove("checkdata.csv")
file.remove("gbmforest.sas")
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
