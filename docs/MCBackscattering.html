<!DOCTYPE html><html><head><title>Help for package MCBackscattering</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {MCBackscattering}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#Absorb'><p>Absorbtion of Single Photon Energy in Media</p></a></li>
<li><a href='#Bounce'><p>Bounce Photon Interaction with Surface</p></a></li>
<li><a href='#Chart'><p>Plot Backscattering Photon Flux Profile</p></a></li>
<li><a href='#Export'><p>Export Simulation Result</p></a></li>
<li><a href='#Launch'><p>Launch Photons into Semi-infinite Media</p></a></li>
<li><a href='#MCBS'><p>Monte Carlo Backscattering class</p></a></li>
<li><a href='#Move'><p>Moves Single Photon in Media</p></a></li>
<li><a href='#print'><p>Print text report on console</p></a></li>
<li><a href='#Randomize'><p>Random Numbers Selection for Single Photon Trajectory</p></a></li>
<li><a href='#Scatter'><p>Scattering of Single Photon in Media</p></a></li>
<li><a href='#Setup'><p>Initial Configuration of MCBS Class</p></a></li>
<li><a href='#Simulation'><p>Runs the Monte Carlo Simulation</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Monte Carlo Simulation for Surface Backscattering</td>
</tr>
<tr>
<td>Version:</td>
<td>0.1.1</td>
</tr>
<tr>
<td>Author:</td>
<td>Laszlo Baranyai &lt;lbaranyai@atb-potsdam.de&gt;</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Laszlo Baranyai &lt;Baranyai.Laszlo@etk.szie.hu&gt;</td>
</tr>
<tr>
<td>Description:</td>
<td>Monte Carlo simulation is a stochastic method computing trajectories of photons in media. Surface backscattering is performing calculations in semi-infinite media and summarizing photon flux leaving the surface. This simulation is modeling the optical measurement of diffuse reflectance using an incident light beam. The semi-infinite media is considered to have flat surface. Media, typically biological tissue, is described by four optical parameters: absorption coefficient, scattering coefficient, anisotropy factor, refractive index. The media is assumed to be homogeneous.
    Computational parameters of the simulation include: number of photons, radius of incident light beam, lowest photon energy threshold, intensity profile (halo) radius, spatial resolution of intensity profile.
    You can find more information and validation in the Open Access paper.
    Laszlo Baranyai (2020) &lt;<a href="https://doi.org/10.1016%2Fj.mex.2020.100958">doi:10.1016/j.mex.2020.100958</a>&gt;.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/LGPL-2.1">LGPL-2.1</a></td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>LazyData:</td>
<td>true</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2020-06-30 07:37:32 UTC; drbaranyailaszlo</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2020-06-30 10:50:11 UTC</td>
</tr>
</table>
<hr>
<h2 id='Absorb'>Absorbtion of Single Photon Energy in Media</h2><span id='topic+Absorb'></span><span id='topic+Absorb.MCBS'></span>

<h3>Description</h3>

<p>This function calculates how photon energy decreases during interaction with media.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Absorb(myObject)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="Absorb_+3A_myobject">myObject</code></td>
<td>
<p>The mandatory parameter of this function is the MCBS class created by <code><a href="#topic+MCBS">MCBS</a></code> constructor function.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The <code>Absorb</code> function, alias <code>Absorb.MCBS</code>, calculates the new energy level after interaction event in the media. If photon energy falls below 0.001, a roulette algorithm makes decision when photon has 10% chance to survive with higher energy and 90% chance to loose all energy. Please keep in mind, that photons start with <code>weight = 1</code> but the first interaction happens at boundary, where photons enter the media.
</p>


<h3>Value</h3>

<p>The <code>Absorb</code> function returns an MCBS object as <code><a href="base.html#topic+class">class</a></code>. Typically the same object is used in argument and result.
One parameter of a single photon is updated in this procedure:
</p>
<table>
<tr><td><code>weight</code></td>
<td>
<p>photon energy. Its initial value is 1 and decrease according to the albedo.</p>
</td></tr>
</table>


<h3>Note</h3>

<p>Please note that this function is designed to be used in <code><a href="#topic+Simulation">Simulation</a></code> function. You may use it separately in case you design your own procedure. In such a case, please note that function <code><a href="#topic+Randomize">Randomize</a></code> prepares trajectory data for each photon and iterations are done using move index <code>myObject$midx</code>. Function <code>Absorb</code> uses random data in roulette algorithm to make decision about photon survival at low energy level.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+MCBS">MCBS</a></code> for construction of object with initial input parameters.
<code><a href="#topic+Simulation">Simulation</a></code> for running the simulation with adjusted parameters.
<code><a href="#topic+Chart">Chart</a></code> for plot of calculated photon flux profile.
<code><a href="#topic+Export">Export</a></code> for export of photon flux with corresponding radii.
<code><a href="#topic+Setup">Setup</a></code> for initial computation of specular reflection and transport albedo.
<code><a href="#topic+Launch">Launch</a></code> for start position of single photon and initial direction in media.
<code><a href="#topic+Bounce">Bounce</a></code> for interaction with surface and computation of photon flux leaving media.
<code><a href="#topic+Move">Move</a></code> for moving single photon forward.
<code><a href="#topic+Scatter">Scatter</a></code> for single photon scattering interaction with media.
<code><a href="#topic+Randomize">Randomize</a></code> for adjustment of random trajectory vectors.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Apple simulation data according to Qin and Lu (2006).
## DOI: 10.13031/2013.20862

# create object
cfgMedia &lt;- c(0.63,30,0,1.4)
cfgSimulation &lt;- c(1e6,0.05,1e-9,3,0.012)
apple &lt;- MCBS(cfgMedia,cfgSimulation)
apple &lt;- Setup(apple)
apple &lt;- Randomize(apple)

# launch with 10Â° incident angle and move first photon
apple$idx &lt;- 1
apple &lt;- Launch(apple,10)
# initial weight in media
cat("Photon energy level",apple$weight,"\n")
# first interaction event
apple$midx &lt;- 1
apple &lt;- Absorb(apple)
cat("Photon energy level",apple$weight,"\n")

</code></pre>

<hr>
<h2 id='Bounce'>Bounce Photon Interaction with Surface</h2><span id='topic+Bounce'></span><span id='topic+Bounce.MCBS'></span>

<h3>Description</h3>

<p>This function is applied when photon trajectory goes out of the media or reaches the surface (z &lt;= 0). The photon flux is summarized upon leaving semi-infinite media through the surface.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Bounce(myObject)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="Bounce_+3A_myobject">myObject</code></td>
<td>
<p>The mandatory parameter of this function is the MCBS class created by <code><a href="#topic+MCBS">MCBS</a></code> constructor function.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The <code>Bounce</code> function, alias <code>Bounce.MCBS</code>, calculates internal reflection if incident angle to surface boundary was higher than critical angle. In all other cases, Fresnel reflection is calculated according to the direction and refractive index of media. Remaining photon weight that leaves the media is collected and summarized by the position. Position is calculated as distance from incident point. This way, radial averaging is performed with rigns of width of the spatial resolution. The internally reflected part of photon energy still follows trajectory until reaches limiting energy or expected trajectory length.
</p>


<h3>Value</h3>

<p>The <code>Bounce</code> function returns an MCBS object as <code><a href="base.html#topic+class">class</a></code>. Typically the same object is used in argument and result.
The function collects photon flux in an array:
</p>
<table>
<tr><td><code>heat</code></td>
<td>
<p>vector of photon flux scattered back from media. One element represent a ring of width of the spatial resolution. The center of the ring is the incident point.</p>
</td></tr>
</table>


<h3>Note</h3>

<p>Please note thet this is an internal function of <code><a href="#topic+Simulation">Simulation</a></code>. Do not use it separately, unless you build your own simulation procedure. The function uses the coordinates <code>c(x,y,z)</code> of the current photon and the <code>c(u,v,w)</code> direction of its last move.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+MCBS">MCBS</a></code> for construction of object with initial input parameters.
<code><a href="#topic+Simulation">Simulation</a></code> for running the simulation with adjusted parameters.
<code><a href="#topic+Chart">Chart</a></code> for plot of calculated photon flux profile.
<code><a href="#topic+Export">Export</a></code> for export of photon flux with corresponding radii.
<code><a href="#topic+Setup">Setup</a></code> for initial computation of specular reflection and transport albedo.
<code><a href="#topic+Launch">Launch</a></code> for start position of single photon and initial direction in media.
<code><a href="#topic+Move">Move</a></code> for moving single photon forward.
<code><a href="#topic+Absorb">Absorb</a></code> for absorption of single photon energy in interaction with media.
<code><a href="#topic+Scatter">Scatter</a></code> for single photon scattering interaction with media.
<code><a href="#topic+Randomize">Randomize</a></code> for adjustment of random trajectory vectors.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Apple simulation data according to Qin and Lu (2006).
## DOI: 10.13031/2013.20862

# create object
cfgMedia &lt;- c(0.63,30,0,1.4)
cfgSimulation &lt;- c(1e6,0.05,1e-9,3,0.012)
apple &lt;- MCBS(cfgMedia,cfgSimulation)
apple &lt;- Setup(apple)
apple &lt;- Randomize(apple)

# launch and move first photon
apple$idx &lt;- 1
apple &lt;- Launch(apple)
# first move
apple$midx &lt;- 1
apple &lt;- Move(apple)
if (apple$z &lt;= 0) {
 apple &lt;- Bounce(apple)
}

</code></pre>

<hr>
<h2 id='Chart'>Plot Backscattering Photon Flux Profile</h2><span id='topic+Chart'></span><span id='topic+Chart.MCBS'></span>

<h3>Description</h3>

<p>This function creates a plot of diffuse reflectance (backscattering) intensity measured on the surface. The photon flux is shown by radius (distance from incident point).
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Chart(myObject,isLog=FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="Chart_+3A_myobject">myObject</code></td>
<td>
<p>The mandatory parameter of this function is the MCBS class created by <code><a href="#topic+MCBS">MCBS</a></code> constructor function.</p>
</td></tr>
<tr><td><code id="Chart_+3A_islog">isLog</code></td>
<td>
<p>Logical variable. Default value is FALSE. If set to TRUE, photon flux will be shown in logarithmic scale.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The <code>Chart</code> function, alias <code>Chart.MCBS</code>, plots simulation results. Photon flux is computed by <code><a href="#topic+Simulation">Simulation</a></code> function. The chart shows flux according to the spatial resolution of the simulation. In case you wish to make your customized chart, please use the <code><a href="#topic+Export">Export</a></code> function to receive data.
</p>


<h3>Value</h3>

<p>This function does not have any result value.
</p>


<h3>Note</h3>

<p>In case you wish to customize your chart, please use <code><a href="#topic+Export">Export</a></code> function to receive data.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+MCBS">MCBS</a></code> for construction of object with initial input parameters.
<code><a href="#topic+Setup">Setup</a></code> for initial computation of specular reflection and transport albedo.
<code><a href="#topic+Simulation">Simulation</a></code> for running the simulation with adjusted parameters.
<code><a href="#topic+print">print</a></code> show adjusted parameters and total backscattered reflection.
<code><a href="#topic+Export">Export</a></code> for export of photon flux with corresponding radii.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Apple simulation data according to Qin and Lu (2006).
## DOI: 10.13031/2013.20862

# create object
cfgMedia &lt;- c(0.63,30,0,1.4)
# the 100 low number of photons is only for demonstration
cfgSimulation &lt;- c(100,0.05,1e-9,3,0.1)
apple &lt;- MCBS(cfgMedia,cfgSimulation)
apple &lt;- Simulation(apple)

# show simulation result
Chart(apple)
# show simulation result with logarithmic scale
Chart(apple,TRUE)
</code></pre>

<hr>
<h2 id='Export'>Export Simulation Result</h2><span id='topic+Export'></span><span id='topic+Export.MCBS'></span>

<h3>Description</h3>

<p>This function exports simulation results in table format. It can be used to save results into file or make customized charts.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Export(myObject)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="Export_+3A_myobject">myObject</code></td>
<td>
<p>The mandatory parameter of this function is the MCBS class created by <code><a href="#topic+MCBS">MCBS</a></code> constructor function.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The <code>Export</code> function, alias <code>Export.MCBS</code>, provides a table with column names. Results of Monte Carlo simulation computed by the <code><a href="#topic+Simulation">Simulation</a></code> function are given as <code>data.frame</code>. The radii are automatically calculated according to the spatial resolution.
</p>


<h3>Value</h3>

<p>Results are provided as <code>data.frame</code> in table format. Two columns represent radii and photon flux.
</p>
<table>
<tr><td><code>Radius</code></td>
<td>
<p>radius of concentric rings, where photon flux is calculated. Starts with incident point at radius of zero (r=0). The unit is cm.</p>
</td></tr>
<tr><td><code>Flux</code></td>
<td>
<p>calculated photon flux, 1/cm^2</p>
</td></tr>
</table>


<h3>See Also</h3>

<p><code><a href="#topic+MCBS">MCBS</a></code> for construction of object with initial input parameters.
<code><a href="#topic+Setup">Setup</a></code> for initial computation of specular reflection and transport albedo.
<code><a href="#topic+Simulation">Simulation</a></code> for running the simulation with adjusted parameters.
<code><a href="#topic+print">print</a></code> show adjusted parameters and total backscattered reflection.
<code><a href="#topic+Chart">Chart</a></code> for plot of calculated photon flux profile.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Apple simulation data according to Qin and Lu (2006).
## DOI: 10.13031/2013.20862

# create object
cfgMedia &lt;- c(0.63,30,0,1.4)
# the 100 low number of photons is only for demonstration
cfgSimulation &lt;- c(100,0.05,1e-9,3,0.1)
apple &lt;- MCBS(cfgMedia,cfgSimulation)
apple &lt;- Simulation(apple)

# show photon flux near incident point
tbl &lt;- Export(apple)
tbl[1:3,]

# save results into file
write.table(Export(apple),tempfile("apple",fileext=".dat"))
</code></pre>

<hr>
<h2 id='Launch'>Launch Photons into Semi-infinite Media</h2><span id='topic+Launch'></span><span id='topic+Launch.MCBS'></span>

<h3>Description</h3>

<p>This function starts single photon into the semi-infinite media from surface (z = 0). The 3D launch direction <code>c(u,v,w)</code> points into the media, according to the incident angle (relative to normal) and refractive index. If incident angle was zero, the incidence is normal (perpendicular to surface). If incidence angle was not zero, elliptical distortion of circular light beam is also considered.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Launch(myObject,iAngle=0)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="Launch_+3A_myobject">myObject</code></td>
<td>
<p>The mandatory parameter of this function is the MCBS class created by <code><a href="#topic+MCBS">MCBS</a></code> constructor function.</p>
</td></tr>
<tr><td><code id="Launch_+3A_iangle">iAngle</code></td>
<td>
<p>This optional parameter means the incident angle relative to normal. The default value is 0 (the incidence is perpendicular to surface).</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The <code>Launch</code> function, alias <code>Launch.MCBS</code>, calculates the start position of the single photon on the surface. The coordinates <code>c(x,y,z)</code> are computed as z = 0 and <code>c(x,y)</code> represent random position in circular light beam. The values z &gt; 0 are inside the media. Beam intensity distribution is considered to be flat, what means that positions have equal probability to occur. Starting polar coordinates are adjusted randomly using uniform distribution by function <code><a href="#topic+Setup">Setup</a></code>. If incident angle was not zero, elliptical distortion is corrected along the y-axis.
</p>


<h3>Value</h3>

<p>The <code>Launch</code> function returns an MCBS object as <code><a href="base.html#topic+class">class</a></code>. Typically the same object is used in argument and result.
Position and starting 3D vector are calculated:
</p>
<table>
<tr><td><code>x</code></td>
<td>
<p>position along x-axis, calculated from random polar coordinates.</p>
</td></tr>
<tr><td><code>y</code></td>
<td>
<p>position along y-axis, calculated from random polar coordinates. If incident angle was not zero, this value is distorted.</p>
</td></tr>
<tr><td><code>z</code></td>
<td>
<p>initial depth, z=0 on the surface.</p>
</td></tr>
<tr><td><code>u</code></td>
<td>
<p>launch vector coordinate along x-axis.</p>
</td></tr>
<tr><td><code>v</code></td>
<td>
<p>launch vector coordinate along y-axis. If incident angle was not zero, this value is calculated according to the incident angle and refractive index.</p>
</td></tr>
<tr><td><code>w</code></td>
<td>
<p>launch vector coordinate along z-axis. If incident angle was not zero, this value is calculated according to the incident angle and refractive index.</p>
</td></tr>
</table>


<h3>Note</h3>

<p>Theoretical models assume the incident angle is zero. During measurement, camera and lightsource cannot occupy the same direction. According to the Fresnel reflection equations, incident angle below 20Â° is recommended. The non-zero incident angle requires correction in computation by means of refraction of the initial direction inside media and elliptical distortion of circular light beam on the surface.
Please note that this function is not intended to use independently. It calculates start values for photon of index <code>myObject$idx</code>. If you want to use it to build your custom simulation, do not forget to assign index, such as <code>myObject$idx &lt;- 1</code>. Index number must be between 1 and <code>myObject$MAXLEN</code>.
</p>


<h3>References</h3>

<p>Jacques, S.L. (1998)
Light Distributions from Point, Line and Plane Sources for Photochemical Reactions and Fluorescence in Turbid Biological Tissues.
<em>Photochemistry and Photobiology</em>, <b>67(1)</b>: 23â-32.
doi: <a href="https://doi.org/10.1111/j.1751-1097.1998.tb05161.x">10.1111/j.1751-1097.1998.tb05161.x</a>.
</p>
<p>Wang, L., Jacques, S.L., Zheng, L. (1997)
CONV-convolution for responses to a finite diameter photon beam incident on multi-layered tissues.
<em>Computer Methods and Programs in Biomedicine</em>, <b>54</b>: 141â-150.
doi: <a href="https://doi.org/10.1016/S0169-2607(97)00021-7">10.1016/S0169-2607(97)00021-7</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+MCBS">MCBS</a></code> for construction of object with initial input parameters.
<code><a href="#topic+Simulation">Simulation</a></code> for running the simulation with adjusted parameters.
<code><a href="#topic+Chart">Chart</a></code> for plot of calculated photon flux profile.
<code><a href="#topic+Export">Export</a></code> for export of photon flux with corresponding radii.
<code><a href="#topic+Setup">Setup</a></code> for initial computation of specular reflection and transport albedo.
<code><a href="#topic+Bounce">Bounce</a></code> for interaction with surface and computation of photon flux leaving media.
<code><a href="#topic+Move">Move</a></code> for moving single photon forward.
<code><a href="#topic+Absorb">Absorb</a></code> for absorption of single photon energy in interaction with media.
<code><a href="#topic+Scatter">Scatter</a></code> for single photon scattering interaction with media.
<code><a href="#topic+Randomize">Randomize</a></code> for adjustment of random trajectory vectors.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Apple simulation data according to Qin and Lu (2006).
## DOI: 10.13031/2013.20862

# create object
cfgMedia &lt;- c(0.63,30,0,1.4)
cfgSimulation &lt;- c(1e6,0.05,1e-9,3,0.012)
apple &lt;- MCBS(cfgMedia,cfgSimulation)
apple &lt;- Setup(apple)

# calculate first photon
apple$idx &lt;- 1
apple &lt;- Launch(apple)
# see vector coordinates
cat("Start position",apple$x,":",apple$y,"\n")
cat("Direction",apple$u,":",apple$v,":",apple$w,"\n")

# calculate first photon with 10Â° incident angle
apple$idx &lt;- 1
apple &lt;- Launch(apple,10)
# see vector coordinates
cat("Start position",apple$x,":",apple$y,"\n")
cat("Direction",apple$u,":",apple$v,":",apple$w,"\n")
</code></pre>

<hr>
<h2 id='MCBS'>Monte Carlo Backscattering class</h2><span id='topic+MCBS'></span>

<h3>Description</h3>

<p>This function is the constructor of Monte Carlo Backscattering (MCBS) class. Diffuse reflection, also called as backscattering, is the phenomena when light enters into the media, such as biological tissue, and after traveling some distance it leaves the media or tissue through the surface.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>MCBS(myTissue,myLight)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="MCBS_+3A_mytissue">myTissue</code></td>
<td>
<p>collection of optical parameters of the semi-infinite medium. It is a list of numbers: <code>c(mua,mus,g,n)</code> as absorption coefficient (1/cm), scattering coefficient (1/cm), anisortopy factor, refractive index.</p>
</td></tr>
<tr><td><code id="MCBS_+3A_mylight">myLight</code></td>
<td>
<p>collection of computational parameters. It is a list of numbers: <code>c(photons,beamradius,limitingenergy,haloradius,resolution)</code> as number of photons used in calculation, radius of incident light beam (cm), photon energy threshold to stop tracing if energy decreased too much, radius of surface area where photon flux is collected (cm), spatial resolution (cm/pixel). Due to the simulation of optical measurement, spatial resolution is expressed on the basis of pixel (px).</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The <code>MCBS</code> function creates and initializes a class using the given parameters. The two arguments are separated according to their role. The first one describes media in which photons travel. The second defines simulation parameters. See arguments for details.
</p>
<p>The optical parameters describing observed media typically has the relationship of <code>mua &lt;&lt; mus</code>, which means absorption coefficient is much smaller that scattering coefficient. Many research papers publish the reduced scattering coefficient <code>rmus = mus*(1-g)</code>. The general problem of comparison and validation is that <code>list(mus=2,g=0)</code> results the same reduced scattering coefficient like <code>list(mus=20,g=0.9)</code>. The value of g shows the most likely direction of light after interaction event in media: g = 1 means continue forward, g = 0 means there is no expected direction and media is isotropic, g = -1 means reflected backward. In biological tissues, anisotropy factor (g) is reported to be in the range of 0.8 - 0.99.
</p>
<p>Since argument <code>myLight</code> is reflecting measurement conditions and hardware setup, it can be considered constant for one system. Please note that quality of results depends on the number of photons. The more is used the better quality you get. The minimum suggested number is 100,000 photons. If you calculate the amount of photons with sensor or camera integration time, this number will increase above billion.
The argument <code>myTissue</code> includes optical parameters of the sample, this is expected to change during experiment such as storage, grading, etc.
</p>


<h3>Value</h3>

<p>The <code>MCBS</code> function returns an object of <code><a href="base.html#topic+class">class</a></code>. Package functions are used to access their parameters for reporting, adjustment and computation. Direct manipulation of object parameters is highly not recommended. Please use the provided functions to reach what is necessary or use them read-only.
An object of class <code>"MCBS"</code> is a list containing at least the following components:
</p>
<table>
<tr><td><code>mu_a</code></td>
<td>
<p>absorption coeffieint, 1/cm</p>
</td></tr>
<tr><td><code>mu_s</code></td>
<td>
<p>scattering coefficient, 1/cm</p>
</td></tr>
<tr><td><code>g</code></td>
<td>
<p>anisotropy factor</p>
</td></tr>
<tr><td><code>n</code></td>
<td>
<p>relative refractive index of media (the other media is assumed to be air)</p>
</td></tr>
<tr><td><code>albedo</code></td>
<td>
<p>transport albedo, the descrease of photon energy after one absorption event in media. The value is initialized by <code><a href="#topic+Setup">Setup</a></code> function.</p>
</td></tr>
<tr><td><code>cangle</code></td>
<td>
<p>cosine of critical angle. The value is initialized by <code><a href="#topic+Setup">Setup</a></code> function.</p>
</td></tr>
<tr><td><code>rs</code></td>
<td>
<p>specular reflection. The value is calculated on the basis of refractive index by <code><a href="#topic+Setup">Setup</a></code> function.</p>
</td></tr>
</table>
<p>Other parameters include containers for calculation. Please do not use them directly. See examples how to extract data.
</p>


<h3>Author(s)</h3>

<p>The object design was inspired by the C code &quot;Small Monte Carlo&quot; written by Scott Prahl (http://omlc.org).
</p>


<h3>References</h3>

<p>Jacques, S.L. (1998)
Light Distributions from Point, Line and Plane Sources for Photochemical Reactions and Fluorescence in Turbid Biological Tissues.
<em>Photochemistry and Photobiology</em>, <b>67(1)</b>: 23-â32.
doi: <a href="https://doi.org/10.1111/j.1751-1097.1998.tb05161.x">10.1111/j.1751-1097.1998.tb05161.x</a>.
</p>
<p>Wang, L., Jacques, S.L., Zheng, L. (1995)
MCML â Monte Carlo modeling of light transport in multi-layered tissues.
<em>Computer Methods and Programs in Biomedicine</em>, <b>47</b>: 131-â146.
doi: <a href="https://doi.org/10.1016/0169-2607(95)01640-F">10.1016/0169-2607(95)01640-F</a>.
</p>
<p>Wang, L., Jacques, S.L., Zheng, L. (1997)
CONV-convolution for responses to a finite diameter photon beam incident on multi-layered tissues.
<em>Computer Methods and Programs in Biomedicine</em>, <b>54</b>: 141â-150.
doi: <a href="https://doi.org/10.1016/S0169-2607(97)00021-7">10.1016/S0169-2607(97)00021-7</a>.
</p>
<p>ZoÅek, N.S., Liebert, A., Maniewski, R. (2006)
Optimization of the Monte Carlo code for modeling of photon migration in tissue.
<em>Computer Methods and Programs in Biomedicine</em>, <b>84</b>: 50â-57.
doi: <a href="https://doi.org/10.1016/j.cmpb.2006.07.007">10.1016/j.cmpb.2006.07.007</a>.
</p>
<p>Baranyai, L., Zude, M. (2009)
Analysis of laser light propagation in kiwifruit using backscattering imaging and Monte Carlo simulation.
<em>Computers and Electronics in Agriculture</em>, <b>69</b>: 33-â39.
doi: <a href="https://doi.org/10.1016/j.compag.2009.06.011">10.1016/j.compag.2009.06.011</a>.
</p>
<p>Baranyai, L. (2020)
Laser induced diffuse reflectance imaging â Monte Carlo simulation of backscattering measured on the surface.
<em>MethodsX</em>, <b>7</b>: 100958.
doi: <a href="https://doi.org/10.1016/j.mex.2020.100958">10.1016/j.mex.2020.100958</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+Setup">Setup</a></code> for initial computation of specular reflection and transport albedo.
<code><a href="#topic+Randomize">Randomize</a></code> for adjustment of random trajectory vectors.
<code><a href="#topic+Simulation">Simulation</a></code> for running the simulation with adjusted parameters.
<code><a href="#topic+print">print</a></code> show adjusted parameters and total backscattered reflection.
<code><a href="#topic+Chart">Chart</a></code> for plot of calculated photon flux profile.
<code><a href="#topic+Export">Export</a></code> for export of photon flux with corresponding radii.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Apple simulation data according to Qin and Lu (2006).
## DOI: 10.13031/2013.20862

cfgMedia &lt;- c(
0.63,  # absorption, 670 nm
30,    # reduced scattering, 670 nm
0,     # isotropic tissue assumed
1.4)   # refractive index

cfgSimulation &lt;- c(
1e6,   # 1 million photons
0.05,  # 1 mm diameter (0.05 cm radius) laser light beam
1e-9,  # limiting energy level
3,     # 3 cm radius is computed
0.012) # 0.012 cm/pixel resolution is assumed

apple &lt;- MCBS(cfgMedia,cfgSimulation)

cfgMedia &lt;- c(
0.63,  # absorption, 670 nm
300,   # scattering, 670 nm
0.9,   # anisotropic tissue with forward scattering is assumed
1.4)   # refractive index
apple &lt;- MCBS(cfgMedia,cfgSimulation)
</code></pre>

<hr>
<h2 id='Move'>Moves Single Photon in Media</h2><span id='topic+Move'></span><span id='topic+Move.MCBS'></span>

<h3>Description</h3>

<p>This function calculates the move of single photon in media.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Move(myObject)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="Move_+3A_myobject">myObject</code></td>
<td>
<p>The mandatory parameter of this function is the MCBS class created by <code><a href="#topic+MCBS">MCBS</a></code> constructor function.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The <code>Move</code> function, alias <code>Move.MCBS</code>, calculates updated position coordinates <code>c(x,y,z)</code> according to the motion vector <code>c(u,v,w)</code> and the travel length until next interaction event.
The movement of single photon is calculated in 3 dimensional space. The length of the straight section a photon can travel until the next interaction event is estimated as <code>-log( rnd )</code> where <code>rnd</code> is a uniformly distributed random variable from range 0-1.
</p>


<h3>Value</h3>

<p>The <code>Move</code> function returns an MCBS object as <code><a href="base.html#topic+class">class</a></code>. Typically the same object is used in argument and result.
As a result, the 3D position of the photon is updated:
</p>
<table>
<tr><td><code>x</code></td>
<td>
<p>position along x-axis</p>
</td></tr>
<tr><td><code>y</code></td>
<td>
<p>position along y-axis</p>
</td></tr>
<tr><td><code>z</code></td>
<td>
<p>position along z-axis, the depth</p>
</td></tr>
</table>


<h3>Note</h3>

<p>Please note that this function is designed to be used in <code><a href="#topic+Simulation">Simulation</a></code> function. You may use it separately in case you design your own procedure. In such a case, please note that function <code><a href="#topic+Randomize">Randomize</a></code> prepares trajectory data for each photon and steps are done using move index <code>myObject$midx</code>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+MCBS">MCBS</a></code> for construction of object with initial input parameters.
<code><a href="#topic+Simulation">Simulation</a></code> for running the simulation with adjusted parameters.
<code><a href="#topic+Chart">Chart</a></code> for plot of calculated photon flux profile.
<code><a href="#topic+Export">Export</a></code> for export of photon flux with corresponding radii.
<code><a href="#topic+Setup">Setup</a></code> for initial computation of specular reflection and transport albedo.
<code><a href="#topic+Launch">Launch</a></code> for start position of single photon and initial direction in media.
<code><a href="#topic+Bounce">Bounce</a></code> for interaction with surface and computation of photon flux leaving media.
<code><a href="#topic+Absorb">Absorb</a></code> for absorption of single photon energy in interaction with media.
<code><a href="#topic+Scatter">Scatter</a></code> for single photon scattering interaction with media.
<code><a href="#topic+Randomize">Randomize</a></code> for adjustment of random trajectory vectors.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Apple simulation data according to Qin and Lu (2006).
## DOI: 10.13031/2013.20862

# create object
cfgMedia &lt;- c(0.63,30,0,1.4)
cfgSimulation &lt;- c(1e6,0.05,1e-9,3,0.012)
apple &lt;- MCBS(cfgMedia,cfgSimulation)
apple &lt;- Setup(apple)
apple &lt;- Randomize(apple)

# launch with 10Â° incident angle and move first photon
apple$idx &lt;- 1
apple &lt;- Launch(apple,10)
# first move
apple$midx &lt;- 1
cat("Position",apple$x,":",apple$y,":",apple$z,"\n")
apple &lt;- Move(apple)
cat("Position",apple$x,":",apple$y,":",apple$z,"\n")
# second move
apple$midx &lt;- 2
apple &lt;- Move(apple)
cat("Position",apple$x,":",apple$y,":",apple$z,"\n")

</code></pre>

<hr>
<h2 id='print'>Print text report on console</h2><span id='topic+print'></span><span id='topic+print.MCBS'></span>

<h3>Description</h3>

<p>This function prints text report about simulation parameters and calculated coeeficients (albedo, critical angle) and total backscattered reflection.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>print(myObject)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="print_+3A_myobject">myObject</code></td>
<td>
<p>The mandatory parameter of this function is the MCBS class created by <code><a href="#topic+MCBS">MCBS</a></code> constructor function.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The <code>print</code> function, alias <code>print.MCBS</code>, provides text description of simulation. Results of Monte Carlo simulation computed by the <code><a href="#topic+Simulation">Simulation</a></code> function are given as <code>data.frame</code>. Text report includes: absorption coefficient, scattering coefficient, anisotropy factor, refractive index, transport albedo, specular reflection, critical angle, backscattered total reflection.
</p>


<h3>Value</h3>

<p>Results of simulation are provided as <code>data.frame</code> in table format. Print function lists adjusted parameters on console, does not return any value.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+MCBS">MCBS</a></code> for construction of object with initial input parameters.
<code><a href="#topic+Setup">Setup</a></code> for initial computation of specular reflection and transport albedo.
<code><a href="#topic+Simulation">Simulation</a></code> for running the simulation with adjusted parameters.
<code><a href="#topic+Chart">Chart</a></code> for plot of calculated photon flux profile.
<code><a href="#topic+Export">Export</a></code> for export of photon flux with corresponding radii.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Apple simulation data according to Qin and Lu (2006).
## DOI: 10.13031/2013.20862

# create object
cfgMedia &lt;- c(0.63,30,0,1.4)
# the 100 low number of photons is only for demonstration
cfgSimulation &lt;- c(100,0.05,1e-9,3,0.1)
apple &lt;- MCBS(cfgMedia,cfgSimulation)
apple &lt;- Simulation(apple)

# show simulation report
print(apple)
</code></pre>

<hr>
<h2 id='Randomize'>Random Numbers Selection for Single Photon Trajectory</h2><span id='topic+Randomize'></span><span id='topic+Randomize.MCBS'></span>

<h3>Description</h3>

<p>This function prepares vectors of random numbers to accelerate trajectory computation. Random numbers are selected from uniform distribution.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Randomize(myObject)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="Randomize_+3A_myobject">myObject</code></td>
<td>
<p>The mandatory parameter of this function is the MCBS class created by <code><a href="#topic+MCBS">MCBS</a></code> constructor function.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The <code>Randomize</code> function, alias <code>Randomize.MCBS</code>, puts random numbers into the container vectors created with the object. During trajectory computation, each interaction event occurs randomly. Prepared container vectors accelerate computation, since values for each event are accessible with <code>myObject$midx</code> move index. Vector length <code>myObject$MAXLEN</code> is adjusted by <code><a href="#topic+Setup">Setup</a></code> function based on transport albedo and limiting energy.
</p>


<h3>Value</h3>

<p>The <code>Randomize</code> function returns an MCBS object as <code><a href="base.html#topic+class">class</a></code>. Typically the same object is used in argument and result.
There are five containers of random numbers. Values are in the range of 0 to +1 unless indicated in description.
</p>
<table>
<tr><td><code>rmv</code></td>
<td>
<p>length of linear section between interaction events. Used by <code><a href="#topic+Move">Move</a></code> function.</p>
</td></tr>
<tr><td><code>rabs</code></td>
<td>
<p>decision values for roulette algorithm. Used by <code><a href="#topic+Absorb">Absorb</a></code> function.</p>
</td></tr>
<tr><td><code>rx1</code></td>
<td>
<p>new scattering direction in the range of -1 to +1. Used by <code><a href="#topic+Scatter">Scatter</a></code> function.</p>
</td></tr>
<tr><td><code>rx1</code></td>
<td>
<p>new scattering direction in the range of -1 to +1. Used by <code><a href="#topic+Scatter">Scatter</a></code> function.</p>
</td></tr>
<tr><td><code>rmu</code></td>
<td>
<p>variable for Heyney-Greenstein phase function. Used by <code><a href="#topic+Scatter">Scatter</a></code> function.</p>
</td></tr>
</table>


<h3>Note</h3>

<p>Please note that this function is designed to be used in <code><a href="#topic+Simulation">Simulation</a></code> function. You may use it separately in case you design your own procedure. In such a case, please note that function <code><a href="#topic+Randomize">Randomize</a></code> prepares random values for one photon and has to be run always before calculating single photon trajectory.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+MCBS">MCBS</a></code> for construction of object with initial input parameters.
<code><a href="#topic+Simulation">Simulation</a></code> for running the simulation with adjusted parameters.
<code><a href="#topic+Chart">Chart</a></code> for plot of calculated photon flux profile.
<code><a href="#topic+Export">Export</a></code> for export of photon flux with corresponding radii.
<code><a href="#topic+Setup">Setup</a></code> for initial computation of specular reflection and transport albedo.
<code><a href="#topic+Move">Move</a></code> for moving single photon forward.
<code><a href="#topic+Absorb">Absorb</a></code> for absorption of single photon energy in interaction with media.
<code><a href="#topic+Scatter">Scatter</a></code> for single photon scattering interaction with media.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Apple simulation data according to Qin and Lu (2006).
## DOI: 10.13031/2013.20862

# create object
cfgMedia &lt;- c(0.63,30,0,1.4)
cfgSimulation &lt;- c(1e6,0.05,1e-9,3,0.012)
apple &lt;- MCBS(cfgMedia,cfgSimulation)
apple &lt;- Setup(apple)

# first five random values of move length
apple &lt;- Randomize(apple)
apple$rmv[1:5]
</code></pre>

<hr>
<h2 id='Scatter'>Scattering of Single Photon in Media</h2><span id='topic+Scatter'></span><span id='topic+Scatter.MCBS'></span>

<h3>Description</h3>

<p>Scattering is the interaction event in the media when photon hits structural elements and changes direction as a result of collision.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Scatter(myObject)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="Scatter_+3A_myobject">myObject</code></td>
<td>
<p>The mandatory parameter of this function is the MCBS class created by <code><a href="#topic+MCBS">MCBS</a></code> constructor function.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The <code>Scatter</code> function, alias <code>Scatter.MCBS</code>, calculates the new direction of photon travel. In isotropic media, any new 3D direction can occur with equal probability. In anisotropic media, the new direction is decided according to the Heyney-Greenstein phase function. The isotropic and anisotropic behavior of media is shown by anisotropy factor (g). The anisotropy factor is zero (g = 0) for isotropic media, g = -1 means backward reflection (backscattering) is the most likely, while g = +1 means the most likely result is that photon continues forward (forward scattering). Biological tissues were reported to have high positive anisotropy factor g &gt; 0.8.
</p>


<h3>Value</h3>

<p>The <code>Scatter</code> function returns an MCBS object as <code><a href="base.html#topic+class">class</a></code>. Typically the same object is used in argument and result.
As a result of <code>Scatter</code> function, new direction is given by <code>c(u,v,w)</code>. These values are used in function <code><a href="#topic+Move">Move</a></code> to calculate next position.
</p>
<table>
<tr><td><code>u</code></td>
<td>
<p>3D vector coordinate along x-axis</p>
</td></tr>
<tr><td><code>v</code></td>
<td>
<p>3D vector coordinate along y-axis</p>
</td></tr>
<tr><td><code>w</code></td>
<td>
<p>3D vector coordinate along z-axis</p>
</td></tr>
</table>


<h3>Note</h3>

<p>Please note that this function is designed to be used in <code><a href="#topic+Simulation">Simulation</a></code> function. You may use it separately in case you design your own procedure. In such a case, please note that function <code><a href="#topic+Randomize">Randomize</a></code> prepares trajectory data for each photon and iterations are done using move index <code>myObject$midx</code>. Results of <code>Scatter</code> function are used in <code><a href="#topic+Move">Move</a></code> function.
</p>


<h3>References</h3>

<p>Henyey, L.G., Greenstein, J.L. (1941)
Diffuse Radiation in the Galaxy.
<em>Astrophysical Journal</em>, <b>93</b>, 70&ndash;83.
doi: <a href="https://doi.org/10.1086/144246">10.1086/144246</a>.
</p>
<p>Jacques, S.L. (1998)
Light Distributions from Point, Line and Plane Sources for Photochemical Reactions and Fluorescence in Turbid Biological Tissues.
<em>Photochemistry and Photobiology</em>, <b>67(1)</b>: 23-â32.
doi: <a href="https://doi.org/10.1111/j.1751-1097.1998.tb05161.x">10.1111/j.1751-1097.1998.tb05161.x</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+MCBS">MCBS</a></code> for construction of object with initial input parameters.
<code><a href="#topic+Simulation">Simulation</a></code> for running the simulation with adjusted parameters.
<code><a href="#topic+Chart">Chart</a></code> for plot of calculated photon flux profile.
<code><a href="#topic+Export">Export</a></code> for export of photon flux with corresponding radii.
<code><a href="#topic+Setup">Setup</a></code> for initial computation of specular reflection and transport albedo.
<code><a href="#topic+Randomize">Randomize</a></code> for adjustment of random trajectory vectors.
<code><a href="#topic+Launch">Launch</a></code> for start position of single photon and initial direction in media.
<code><a href="#topic+Bounce">Bounce</a></code> for interaction with surface and computation of photon flux leaving media.
<code><a href="#topic+Move">Move</a></code> for moving single photon forward.
<code><a href="#topic+Absorb">Absorb</a></code> for absorption of single photon energy in interaction with media.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Apple simulation data according to Qin and Lu (2006).
## DOI: 10.13031/2013.20862

# create object
cfgMedia &lt;- c(0.63,30,0,1.4)
cfgSimulation &lt;- c(1e6,0.05,1e-9,3,0.012)
apple &lt;- MCBS(cfgMedia,cfgSimulation)
apple &lt;- Setup(apple)
apple &lt;- Randomize(apple)

# launch with 10Â° incident angle and move first photon
apple$idx &lt;- 1
apple &lt;- Launch(apple)

# first interaction event
cat("Direction",apple$u,":",apple$v,":",apple$w,"\n")
apple$midx &lt;- 1
apple &lt;- Scatter(apple)
cat("Direction",apple$u,":",apple$v,":",apple$w,"\n")
</code></pre>

<hr>
<h2 id='Setup'>Initial Configuration of MCBS Class</h2><span id='topic+Setup'></span><span id='topic+Setup.MCBS'></span>

<h3>Description</h3>

<p>This function performs the basic configuration of Monte Carlo Backscattering (<a href="#topic+MCBS">MCBS</a>) class. It calculates specular reflection, transport albedo, critical angle and similar parameters.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Setup(myObject)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="Setup_+3A_myobject">myObject</code></td>
<td>
<p>The mandatory parameter of this function is the MCBS class created by <code><a href="#topic+MCBS">MCBS</a></code> constructor function.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function <code>Setup</code>, alias <code>Setup.MCBS</code>, performs the initial calculation of essential parameters for computation. Additionally, computes the maximum expected trajectory length and prepares the launch position of all photons with random polar coordinates within circular beam.
</p>


<h3>Value</h3>

<p>The <code>Setup</code> function returns an MCBS object as <code><a href="base.html#topic+class">class</a></code>. Typically the same object is used in argument and result.
The new parameters calculated in <code>Setup</code> are:
</p>
<table>
<tr><td><code>albedo</code></td>
<td>
<p>transport albedo</p>
</td></tr>
<tr><td><code>rs</code></td>
<td>
<p>specular reflection</p>
</td></tr>
<tr><td><code>cangle</code></td>
<td>
<p>cosine value of critical angle</p>
</td></tr>
<tr><td><code>MAXLEN</code></td>
<td>
<p>maximum expected length of photon trajectory. This length depends on the albedo and limiting energy.</p>
</td></tr>
</table>
<p>There are additional containers for random launch position of photons. Launch position is given with polar coordinates (radius, angle).
</p>


<h3>Note</h3>

<p>Please note that this function is designed to be used in <code><a href="#topic+Simulation">Simulation</a></code> function. You may use it separately in case you design your own procedure.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+MCBS">MCBS</a></code> for construction of object with initial input parameters.
<code><a href="#topic+Simulation">Simulation</a></code> for running the simulation with adjusted parameters.
<code><a href="#topic+Chart">Chart</a></code> for plot of calculated photon flux profile.
<code><a href="#topic+Export">Export</a></code> for export of photon flux with corresponding radii.
<code><a href="#topic+Launch">Launch</a></code> for start position of single photon and initial direction in media.
<code><a href="#topic+Randomize">Randomize</a></code> for adjustment of random trajectory vectors.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Apple simulation data according to Qin and Lu (2006).
## DOI: 10.13031/2013.20862

# create object
cfgMedia &lt;- c(0.63,30,0,1.4)
cfgSimulation &lt;- c(1e6,0.05,1e-9,3,0.012)
apple &lt;- MCBS(cfgMedia,cfgSimulation)

apple &lt;- Setup(apple)
# transport albedo
apple$albedo
# specular reflection
apple$rs
</code></pre>

<hr>
<h2 id='Simulation'>Runs the Monte Carlo Simulation</h2><span id='topic+Simulation'></span><span id='topic+Simulation.MCBS'></span>

<h3>Description</h3>

<p>This function performs all actions to run the simulation. It calls other functions that prepare computation and calculate photon trajectory. Please keep in mind, that this technique can be slow depending on the number of photons and computational power of your hardware.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>Simulation(myObject,iAngle=0)
</code></pre>


<h3>Arguments</h3>

<table>
<tr><td><code id="Simulation_+3A_myobject">myObject</code></td>
<td>
<p>The mandatory parameter of this function is the MCBS class created by <code><a href="#topic+MCBS">MCBS</a></code> constructor function.</p>
</td></tr>
<tr><td><code id="Simulation_+3A_iangle">iAngle</code></td>
<td>
<p>The optional parameter <code>iAngle</code> defines the incident angle of light beam. It is measured from normal position, perpendicular to the surface. The default value is zero (iAngle=0). This parameter is passed to <code><a href="#topic+Launch">Launch</a></code> function.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function <code>Simulation</code>, alias <code>Simulation.MCBS</code>, was designed to take every steps such as <code>Setup</code> initial conditions and compute each photon trajectory individually. It was written keeping clarity in mind. In case you want to make your own procedure, this function can be used as a template.
</p>
<p>The result of simulation is photon flux, which is expressed as relative fluence rate (F/P, 1/cm^2) where F is the fluence rate and P is the power of light source. The fluence rate (F) is computed in concentric rings around the incident point.
</p>


<h3>Value</h3>

<p>The <code>Simulation</code> function returns an MCBS object as <code><a href="base.html#topic+class">class</a></code>. Typically the same object is used in argument and result.
The main objective of the simulation is to calculate spatial photon flux. The flux is computed with radial averaging relative to the incident point. Each value represent the average flux of the ring with the width of resolution (1 pixel).
</p>
<table>
<tr><td><code>heat</code></td>
<td>
<p>calculated photon flux, 1/cm^2</p>
</td></tr>
</table>


<h3>Note</h3>

<p>Please note that quality of results depends on the number of photons. The more is used the better quality you get. The minimum suggested number is 100,000 photons. If you calculate the amount of photons with sensor or camera integration time, this number will increase above billion.
Validation of computations is difficult, because other Monte Carlo programs or the diffusion theory model can be used as reference. The diffusion theory model does not consider many parameters included in Monte Carlo simulation, such as beam radius, incident angle, anisotropy. Please note that models and reports usually use the reduced scattering coefficient <code>rms = (1-g)*ms</code> what means that different scattering and anisotropy parameters, like <code>list(ms=20,g=0)</code> and <code>list(ms=200,g=0.9)</code>, result the same reduced scattering coefficient.
Do not access and manipulate the result data vector <code>myObject$heat</code> directly. You can receive results by using the <code><a href="#topic+Export">Export</a></code> function.
</p>


<h3>References</h3>

<p>Farrell, T.J., Patterson, M.S., Wilson, B. (1992)
A diffusion theory model of spatially resolved, steady-state diffuse reflectance for the noninvasive determination of tissue optical properties in vivo.
<em>Medical Physics</em>, <b>19(4)</b>: 879&ndash;888.
doi: <a href="https://doi.org/10.1118/1.596777">10.1118/1.596777</a>.
</p>
<p>Jacques, S.L. (1998)
Light Distributions from Point, Line and Plane Sources for Photochemical Reactions and Fluorescence in Turbid Biological Tissues.
<em>Photochemistry and Photobiology</em>, <b>67(1)</b>: 23-â32.
doi: <a href="https://doi.org/10.1111/j.1751-1097.1998.tb05161.x">10.1111/j.1751-1097.1998.tb05161.x</a>.
</p>
<p>Wang, L., Jacques, S.L., Zheng, L. (1995)
MCML â Monte Carlo modeling of light transport in multi-layered tissues.
<em>Computer Methods and Programs in Biomedicine</em>, <b>47</b>: 131-â146.
doi: <a href="https://doi.org/10.1016/0169-2607(95)01640-F">10.1016/0169-2607(95)01640-F</a>.
</p>
<p>Wang, L., Jacques, S.L., Zheng, L. (1997)
CONV-convolution for responses to a finite diameter photon beam incident on multi-layered tissues.
<em>Computer Methods and Programs in Biomedicine</em>, <b>54</b>: 141â-150.
doi: <a href="https://doi.org/10.1016/S0169-2607(97)00021-7">10.1016/S0169-2607(97)00021-7</a>.
</p>
<p>ZoÅek, N.S., Liebert, A., Maniewski, R. (2006)
Optimization of the Monte Carlo code for modeling of photon migration in tissue.
<em>Computer Methods and Programs in Biomedicine</em>, <b>84</b>: 50â-57.
doi: <a href="https://doi.org/10.1016/j.cmpb.2006.07.007">10.1016/j.cmpb.2006.07.007</a>.
</p>
<p>Baranyai, L., Zude, M. (2009)
Analysis of laser light propagation in kiwifruit using backscattering imaging and Monte Carlo simulation.
<em>Computers and Electronics in Agriculture</em>, <b>69</b>: 33-â39.
doi: <a href="https://doi.org/10.1016/j.compag.2009.06.011">10.1016/j.compag.2009.06.011</a>.
</p>
<p>Baranyai, L. (2020)
Laser induced diffuse reflectance imaging â Monte Carlo simulation of backscattering measured on the surface.
<em>MethodsX</em>, <b>7</b>: 100958.
doi: <a href="https://doi.org/10.1016/j.mex.2020.100958">10.1016/j.mex.2020.100958</a>.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+MCBS">MCBS</a></code> for construction of object with initial input parameters.
<code><a href="#topic+Setup">Setup</a></code> for initial computation of specular reflection and transport albedo.
<code><a href="#topic+Randomize">Randomize</a></code> for adjustment of random trajectory vectors.
<code><a href="#topic+print">print</a></code> show adjusted parameters and total backscattered reflection.
<code><a href="#topic+Chart">Chart</a></code> for plot of calculated photon flux profile.
<code><a href="#topic+Export">Export</a></code> for export of photon flux with corresponding radii.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Apple simulation data according to Qin and Lu (2006).
## DOI: 10.13031/2013.20862

# create object
cfgMedia &lt;- c(0.63,30,0,1.4)
# the 100 low number of photons is only for demonstration
cfgSimulation &lt;- c(100,0.05,1e-9,3,0.1)
apple &lt;- MCBS(cfgMedia,cfgSimulation)

# run simulation with default incident angle
apple &lt;- Simulation(apple)
print(apple)

# run simulation with 10 deg incident angle
apple &lt;- Simulation(apple,10)
Chart(apple)
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
