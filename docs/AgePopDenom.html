<!DOCTYPE html><html lang="en"><head><title>Help for package AgePopDenom</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {AgePopDenom}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#aggregate_and_extract_gamma'><p>Aggregate Individual Survey Data and Extract Gamma Parameters by Location</p></a></li>
<li><a href='#compute_cov'><p>Compute Covariance Matrix for Spatial Model</p></a></li>
<li><a href='#create_prediction_data'><p>Generate or Load Cached Predictors Data</p></a></li>
<li><a href='#create_project_structure'><p>Create a Standardized Project Folder Structure</p></a></li>
<li><a href='#download_dhs_datasets'><p>Main Function to Download DHS Datasets</p></a></li>
<li><a href='#download_pop_rasters'><p>Download population rasters for given country codes.</p></a></li>
<li><a href='#download_shapefile'><p>Download WHO ADM2 Boundaries with Partial Update</p></a></li>
<li><a href='#extract_afurextent'><p>Extract Urban/Rural Extent Raster</p></a></li>
<li><a href='#extract_age_param'><p>Extract Parameters and Optimization Details with Log-Likelihood</p></a></li>
<li><a href='#extract_betas'><p>Extract Beta Parameters from Model Output</p></a></li>
<li><a href='#fit_spatial_model'><p>Fit a Spatial Model for Age Parameters using TMB</p></a></li>
<li><a href='#generate_age_pop_raster'><p>Generate Age Population Raster</p></a></li>
<li><a href='#generate_age_pop_table'><p>Generate Age Population Tables</p></a></li>
<li><a href='#generate_age_pyramid_plot'><p>Generate and Save Age Pyramid Plot</p></a></li>
<li><a href='#generate_gamma_predictions'><p>Predict Gamma Distribution Parameters for Spatial Grid</p></a></li>
<li><a href='#generate_gamma_raster_plot'><p>Generate and Save Raster Plot for Gamma Predictions</p></a></li>
<li><a href='#generate_variogram_plot'><p>Generate Variogram Plot</p></a></li>
<li><a href='#init'><p>Initialize Full Pipeline Script and Model Script</p></a></li>
<li><a href='#install_suggested_packages'><p>Package Initialization and Dependency Check</p></a></li>
<li><a href='#log_lik'><p>Log-Likelihood Function for Spatial Model</p></a></li>
<li><a href='#process_dhs_data'><p>Process DHS Data: Merge RDS Files with Shapefiles and Extract Gamma</p>
Parameters</a></li>
<li><a href='#process_final_population_data'><p>Process Final Population Data</p></a></li>
<li><a href='#process_gamma_predictions'><p>Process Gamma Prediction Results</p></a></li>
<li><a href='#rasterize_data'><p>Rasterize Spatial Data</p></a></li>
<li><a href='#run_full_workflow'><p>Run Country-Specific Spatial Modeling Workflow with Logging</p></a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Model Fine-Scale Age-Structured Population Data using
Open-Source Data</td>
</tr>
<tr>
<td>Version:</td>
<td>0.4.0</td>
</tr>
<tr>
<td>Description:</td>
<td>Automate the modelling of age-structured population data
  using survey data, grid population estimates and urban-rural extents.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file LICENSE</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>SystemRequirements:</td>
<td>C++17, TMB</td>
</tr>
<tr>
<td>Imports:</td>
<td>TMB, dplyr, curl, exactextractr, ggplot2, numDeriv, pdist,
utils, sf, cli, tibble, terra, tidyr, httr</td>
</tr>
<tr>
<td>Suggests:</td>
<td>stats, stringr, openxlsx2, countrycode, crayon, scales, glue,
haven, here, rstudioapi, geodata, pbmcapply, future,
future.apply, purrr, rdhs, rlang, pak, sp, automap, testthat
(&ge; 3.0.0), knitr, rmarkdown, matrixStats, mockery, gstat,
RcppEigen</td>
</tr>
<tr>
<td>RoxygenNote:</td>
<td>7.3.2</td>
</tr>
<tr>
<td>VignetteBuilder:</td>
<td>knitr</td>
</tr>
<tr>
<td>Config/testthat/edition:</td>
<td>3</td>
</tr>
<tr>
<td>URL:</td>
<td><a href="https://truenomad.github.io/AgePopDenom/">https://truenomad.github.io/AgePopDenom/</a></td>
</tr>
<tr>
<td>Depends:</td>
<td>R (&ge; 4.1.0)</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>no</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2025-02-25 10:13:37 UTC; mohamedyusuf</td>
</tr>
<tr>
<td>Author:</td>
<td>Mohamed A. Yusuf <a href="https://orcid.org/0000-0002-9339-4613"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut, cre],
  Victor A. Alegana <a href="https://orcid.org/0000-0001-5177-9227"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut],
  Chris Nnanatu <a href="https://orcid.org/0000-0002-5841-3700"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut],
  Andrew Tatem <a href="https://orcid.org/0000-0002-7270-941X"><img alt="ORCID iD"  src="https://cloud.R-project.org/web/orcid.svg" style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:middle" /></a>
    [aut]</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Mohamed A. Yusuf &lt;moyusuf@who.int&gt;</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2025-02-25 18:10:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='aggregate_and_extract_gamma'>Aggregate Individual Survey Data and Extract Gamma Parameters by Location</h2><span id='topic+aggregate_and_extract_gamma'></span>

<h3>Description</h3>

<p>This script aggregates the individual Survey data to location level and extracts
the gamma parameters for the locations.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>aggregate_and_extract_gamma(
  data,
  lat_column = "lat",
  long_column = "long",
  age_column = "ageyrs",
  urban_column = "urban"
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="aggregate_and_extract_gamma_+3A_data">data</code></td>
<td>
<p>Data frame containing individual-level age data with
coordinates and urban/rural classification.</p>
</td></tr>
<tr><td><code id="aggregate_and_extract_gamma_+3A_lat_column">lat_column</code></td>
<td>
<p>Column name for latitude coordinates (default: &quot;lat&quot;)</p>
</td></tr>
<tr><td><code id="aggregate_and_extract_gamma_+3A_long_column">long_column</code></td>
<td>
<p>Column name for longitude coordinates (default: &quot;long&quot;)</p>
</td></tr>
<tr><td><code id="aggregate_and_extract_gamma_+3A_age_column">age_column</code></td>
<td>
<p>Column name for age values (default: &quot;ageyrs&quot;)</p>
</td></tr>
<tr><td><code id="aggregate_and_extract_gamma_+3A_urban_column">urban_column</code></td>
<td>
<p>Column name for urban/rural classification (default:
&quot;urban&quot;)</p>
</td></tr>
</table>


<h3>Value</h3>

<p>List containing:
</p>

<ul>
<li><p> outlier_free_data: Original data with added spatial
coordinates, outliers removed, and clusters with less than
10 samples removed
</p>
</li>
<li><p> age_param_data: Location-level gamma parameters with columns:
lon, lat, web_x, web_y, log_scale, log_shape, urban,
b1, c, b2, nsampled
</p>
</li></ul>


<hr>
<h2 id='compute_cov'>Compute Covariance Matrix for Spatial Model</h2><span id='topic+compute_cov'></span>

<h3>Description</h3>

<p>This function computes a block covariance matrix for a bivariate spatial
model with age-structured parameters.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>compute_cov(
  gamma,
  sigma2,
  phi,
  u_dist,
  n_x,
  tau2_1 = 1,
  tau2_2 = 1,
  age_param_data
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="compute_cov_+3A_gamma">gamma</code></td>
<td>
<p>Correlation parameter between the two spatial processes</p>
</td></tr>
<tr><td><code id="compute_cov_+3A_sigma2">sigma2</code></td>
<td>
<p>Variance parameter for the spatial processes</p>
</td></tr>
<tr><td><code id="compute_cov_+3A_phi">phi</code></td>
<td>
<p>Range parameter for the spatial correlation</p>
</td></tr>
<tr><td><code id="compute_cov_+3A_u_dist">u_dist</code></td>
<td>
<p>Distance matrix between locations</p>
</td></tr>
<tr><td><code id="compute_cov_+3A_n_x">n_x</code></td>
<td>
<p>Number of spatial locations</p>
</td></tr>
<tr><td><code id="compute_cov_+3A_tau2_1">tau2_1</code></td>
<td>
<p>Variance parameter for first process (default = 1)</p>
</td></tr>
<tr><td><code id="compute_cov_+3A_tau2_2">tau2_2</code></td>
<td>
<p>Variance parameter for second process (default = 1)</p>
</td></tr>
<tr><td><code id="compute_cov_+3A_age_param_data">age_param_data</code></td>
<td>
<p>List containing age-structured parameters:
</p>

<ul>
<li><p> b1: Vector of age parameters for first process
</p>
</li>
<li><p> b2: Vector of age parameters for second process
</p>
</li>
<li><p> c: Vector of cross-process age parameters
</p>
</li></ul>
</td></tr>
</table>


<h3>Value</h3>

<p>A sparse symmetric matrix of dimension 2n_x Ã— 2n_x
</p>

<hr>
<h2 id='create_prediction_data'>Generate or Load Cached Predictors Data</h2><span id='topic+create_prediction_data'></span>

<h3>Description</h3>

<p>This function creates predictors data based on spatial inputs or loads cached
predictors data if the file already exists. It saves the generated data to a
specified directory for reuse and provides progress updates.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>create_prediction_data(
  country_code,
  country_shape,
  pop_raster,
  ur_raster,
  adm2_shape,
  cell_size = 5000,
  ignore_cache = FALSE,
  output_dir = here::here("03_outputs", "3a_model_outputs")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="create_prediction_data_+3A_country_code">country_code</code></td>
<td>
<p>A string representing the country code (e.g., &quot;KEN&quot;).</p>
</td></tr>
<tr><td><code id="create_prediction_data_+3A_country_shape">country_shape</code></td>
<td>
<p>An &lsquo;sf' object representing the country&rsquo;s administrative
boundaries.</p>
</td></tr>
<tr><td><code id="create_prediction_data_+3A_pop_raster">pop_raster</code></td>
<td>
<p>A 'terra' raster object representing the population raster.</p>
</td></tr>
<tr><td><code id="create_prediction_data_+3A_ur_raster">ur_raster</code></td>
<td>
<p>A 'terra' raster object representing the urban extent
raster.</p>
</td></tr>
<tr><td><code id="create_prediction_data_+3A_adm2_shape">adm2_shape</code></td>
<td>
<p>An 'sf' object representing the administrative level 2
boundaries.</p>
</td></tr>
<tr><td><code id="create_prediction_data_+3A_cell_size">cell_size</code></td>
<td>
<p>An integer specifying the cell size for the prediction grid
in meters (default is 5000).</p>
</td></tr>
<tr><td><code id="create_prediction_data_+3A_ignore_cache">ignore_cache</code></td>
<td>
<p>A boolean input which is set to determine whether
to ignore the existing cache and write over it. Default is set to FALSE.</p>
</td></tr>
<tr><td><code id="create_prediction_data_+3A_output_dir">output_dir</code></td>
<td>
<p>A string specifying the directory where the predictors data
file should be saved (default is &quot;03_outputs/3a_model_outputs&quot;).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data object ('predictor_data') containing the generated predictors.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
tf &lt;- file.path(tempdir(), "test_env")

# Initialize with normalized path
dir.create(tf, recursive = TRUE, showWarnings = FALSE)

init(
  r_script_name = "full_pipeline.R",
  cpp_script_name = "model.cpp",
  path = tf,
  open_r_script = FALSE
)

# Download shapefiles
download_shapefile(
  country_codes =  "COM",
  dest_file = file.path(
    tf, "01_data", "1c_shapefiles",
    "district_shape.gpkg"
  )
)

# Download population rasters from worldpop
download_pop_rasters(
  country_codes = "COM",
  dest_dir = file.path(tf, "01_data", "1b_rasters", "pop_raster")
)

# Extract urban extent raster
extract_afurextent(
  dest_dir = file.path(tf, "01_data", "1b_rasters", "urban_extent")
)


urban_raster &lt;-  terra::rast(
  file.path(tf, "01_data", "1b_rasters",
            "urban_extent", "afurextent.asc"))

pop_raster &lt;-  terra::rast(
  file.path(tf, "01_data", "1b_rasters", "pop_raster",
            "com_ppp_2020_constrained.tif")

)

adm2_sf &lt;- sf::read_sf(
 file.path(tf, "01_data", "1c_shapefiles",
            "district_shape.gpkg"))

country_sf &lt;- sf::st_union(adm2_sf)

predictors &lt;- create_prediction_data(
  country_code =  "COM",
  country_shape = country_sf,
  pop_raster = pop_raster,
  ur_raster = urban_raster,
  adm2_shape = adm2_sf,
  cell_size = 5000,
  output_dir = file.path(
    tf, "03_outputs/3a_model_outputs"
  )
)


</code></pre>

<hr>
<h2 id='create_project_structure'>Create a Standardized Project Folder Structure</h2><span id='topic+create_project_structure'></span>

<h3>Description</h3>

<p>This function creates a standardized folder structure for organizing
data, scripts, and outputs within a project directory. It ensures
consistency and reproducibility for data-related workflows.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>create_project_structure(base_path = here::here())
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="create_project_structure_+3A_base_path">base_path</code></td>
<td>
<p>A character string specifying the root directory where
the folder structure will be created. Defaults to 'here::here()'
to use the current project directory.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function generates the following folder structure:
</p>
<pre>
# 01_data/
# +-- 1a_survey_data/
# |    +-- processed/
# |    \-- raw/
# +-- 1b_rasters/
# |    +-- urban_extent/
# |    \-- pop_raster/
# +-- 1c_shapefiles/
# 02_scripts/
# 03_outputs/
# +-- 3a_model_outputs/
# +-- 3b_visualizations/
# +-- 3c_table_outputs/
# \-- 3d_compiled_results/
</pre>


<h3>Value</h3>

<p>Creates directories under the specified 'base_path'. Returns
invisible 'NULL' and prints messages about folder creation status.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# Create temp directory with normalized path
tf &lt;- file.path(tempdir(), "test_env")
dir.create(tf, recursive = TRUE, showWarnings = FALSE)

#  Initialize with normalized path
cpp_path &lt;- file.path(tf, "02_scripts", "model")
dir.create(cpp_path, recursive = TRUE, showWarnings = FALSE)
cpp_path &lt;- normalizePath(cpp_path, winslash = "/", mustWork = FALSE)

create_project_structure(base_path = tf)

</code></pre>

<hr>
<h2 id='download_dhs_datasets'>Main Function to Download DHS Datasets</h2><span id='topic+download_dhs_datasets'></span>

<h3>Description</h3>

<p>Downloads the latest PR (household) and GE (geographic) DHS datasets for
specified countries.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>download_dhs_datasets(
  country_codes,
  cache_path = here::here("01_data", "1a_survey_data", "raw"),
  output_dir_root = here::here("01_data", "1a_survey_data", "raw"),
  survey_id = NULL,
  email,
  project,
  verbose = TRUE,
  clear_cache = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="download_dhs_datasets_+3A_country_codes">country_codes</code></td>
<td>
<p>A character vector of ISO3 country codes.</p>
</td></tr>
<tr><td><code id="download_dhs_datasets_+3A_cache_path">cache_path</code></td>
<td>
<p>A character string specifying the cache path for RDHS.</p>
</td></tr>
<tr><td><code id="download_dhs_datasets_+3A_output_dir_root">output_dir_root</code></td>
<td>
<p>A character string specifying the root directory for
output.</p>
</td></tr>
<tr><td><code id="download_dhs_datasets_+3A_survey_id">survey_id</code></td>
<td>
<p>A character vector of survey IDs. If NULL, uses latest
survey.</p>
</td></tr>
<tr><td><code id="download_dhs_datasets_+3A_email">email</code></td>
<td>
<p>A character string. Email registered with DHS.</p>
</td></tr>
<tr><td><code id="download_dhs_datasets_+3A_project">project</code></td>
<td>
<p>A character string. Project name as registered with DHS.</p>
</td></tr>
<tr><td><code id="download_dhs_datasets_+3A_verbose">verbose</code></td>
<td>
<p>Logical for rdhs setup and messages to be printed.</p>
</td></tr>
<tr><td><code id="download_dhs_datasets_+3A_clear_cache">clear_cache</code></td>
<td>
<p>Logical whether to clear cache before downloading.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Invisibly returns a list of downloaded dataset filenames.
</p>

<hr>
<h2 id='download_pop_rasters'>Download population rasters for given country codes.</h2><span id='topic+download_pop_rasters'></span>

<h3>Description</h3>

<p>This function attempts to download population rasters from WorldPop for the
specified country codes. If 'dest_dir' is not provided, file paths will be
generated based on the given country codes and saved into the current
project directory (using 'here::here()'). It first checks if a local file
already exists, and if so, it will skip downloading.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>download_pop_rasters(
  country_codes,
  dest_dir = here::here("01_data", "1b_rasters", "pop_raster"),
  quiet = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="download_pop_rasters_+3A_country_codes">country_codes</code></td>
<td>
<p>A character vector of ISO3 country codes.</p>
</td></tr>
<tr><td><code id="download_pop_rasters_+3A_dest_dir">dest_dir</code></td>
<td>
<p>A character vector of file paths for saving rasters.
If NULL, defaults to &quot;&lt;cc&gt;_ppp_2020_constrained2.tif&quot; in the project dir.</p>
</td></tr>
<tr><td><code id="download_pop_rasters_+3A_quiet">quiet</code></td>
<td>
<p>Logical; if TRUE, suppress status messages.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function tries a baseline URL (BSGM) for each country code. If the file
is not found there, it then tries a secondary URL (maxar_v1). If neither
location provides the file, it returns NA and prompts you to check the
WorldPop website directly.
</p>


<h3>Value</h3>

<p>Invisibly returns a vector of downloaded file paths
(or NA if not found).
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
download_pop_rasters(country_codes = "COM", dest_dir = tempdir())


</code></pre>

<hr>
<h2 id='download_shapefile'>Download WHO ADM2 Boundaries with Partial Update</h2><span id='topic+download_shapefile'></span>

<h3>Description</h3>

<p>This function ensures the specified shapefile ('dest_file') contains
boundaries for all requested ISO3 codes ('country_codes'). It dynamically
Downloades only the missing codes and appends them to the file, ensuring no
duplication.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>download_shapefile(
  country_codes,
  dest_file = here::here("01_data", "1c_shapefiles", "district_shape.gpkg")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="download_shapefile_+3A_country_codes">country_codes</code></td>
<td>
<p>Character vector of ISO3 country codes
(e.g. c(&quot;KEN&quot;,&quot;UGA&quot;)).</p>
</td></tr>
<tr><td><code id="download_shapefile_+3A_dest_file">dest_file</code></td>
<td>
<p>File path where data is saved (default:
&quot;01_data/1c_shapefiles/district_shape.gpkg&quot;).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>An 'sf' object of combined boundaries for all requested country
codes.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>


tf &lt;- file.path(tempdir(), "test_env")

# Download population rasters from worldpop
download_shapefile(
  country_codes = "COM",
  dest_file = here::here(tf, "district_shape.gpkg")
)

</code></pre>

<hr>
<h2 id='extract_afurextent'>Extract Urban/Rural Extent Raster</h2><span id='topic+extract_afurextent'></span>

<h3>Description</h3>

<p>Extracts the &lsquo;afurextent.asc' raster file from the package&rsquo;s 'inst/extdata'
directory to a specified destination.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>extract_afurextent(
  dest_dir = here::here("01_data", "1b_rasters", "urban_extent"),
  overwrite = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="extract_afurextent_+3A_dest_dir">dest_dir</code></td>
<td>
<p>A character string specifying the directory to save the
extracted raster file.</p>
</td></tr>
<tr><td><code id="extract_afurextent_+3A_overwrite">overwrite</code></td>
<td>
<p>Logical. Whether to overwrite an existing file in the
destination directory. Default is FALSE.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function extracts the &lsquo;afurextent.asc' file from the package&rsquo;s
'extdata' directory, where it is stored as a compressed '.zip' file. It
requires the 'raster' package to load the raster file.
</p>


<h3>Value</h3>

<p>A character string representing the full path to the extracted raster
file.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
 extract_afurextent(tempdir(), overwrite = TRUE)

</code></pre>

<hr>
<h2 id='extract_age_param'>Extract Parameters and Optimization Details with Log-Likelihood</h2><span id='topic+extract_age_param'></span>

<h3>Description</h3>

<p>Reads files matching the pattern &quot;age_param_spatial_urban&quot; in a specified
directory, extracts the country name, parameter values, and optimization
details, combines the results into a data frame, and optionally saves
the output to a file.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>extract_age_param(
  dir_path = here::here("03_outputs", "3a_model_outputs"),
  output_file = here::here("03_outputs", "3d_compiled_results", "model_params.csv")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="extract_age_param_+3A_dir_path">dir_path</code></td>
<td>
<p>A character string specifying the directory containing the
files.</p>
</td></tr>
<tr><td><code id="extract_age_param_+3A_output_file">output_file</code></td>
<td>
<p>A character string specifying the path to save the output
data frame. If NULL, the output will not be saved.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A data frame with the extracted parameters, log-likelihood,
and optimization details.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

# Create temporary directory for dummy parameter files
dummy_dir &lt;- tempdir()

dummy_params &lt;- list(
  par = c(0.5, 1.2, 0.8, log(2), log(3), log(4)),
  objective = -123.45,
  convergence = 0,
  iterations = 10,
  evaluations = c("function = 20, gradient = 15"),
  message = "Converged"
)

saveRDS(dummy_params, file = file.path(dummy_dir,
                                       "abc_age_param_spatial_urban.rds"))

params_df &lt;- extract_age_param(dir_path = dummy_dir,
                               output_file = tempdir())


</code></pre>

<hr>
<h2 id='extract_betas'>Extract Beta Parameters from Model Output</h2><span id='topic+extract_betas'></span>

<h3>Description</h3>

<p>This function extracts beta coefficients from a model parameter object,
separating them into beta1 and beta2 components.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>extract_betas(
  params_result,
  params = c("gamma", "log_sigma2", "log_phi", "log_tau1")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="extract_betas_+3A_params_result">params_result</code></td>
<td>
<p>A model parameter object containing parameter estimates</p>
</td></tr>
<tr><td><code id="extract_betas_+3A_params">params</code></td>
<td>
<p>A character vector specifying parameter names, defaults to
c(&quot;gamma&quot;, &quot;log_sigma2&quot;, &quot;log_phi&quot;, &quot;log_tau1&quot;)</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function assumes the parameter vector contains beta coefficients
followed by other model parameters. It splits the betas into two equal
groups after removing the last 4 parameters.
</p>


<h3>Value</h3>

<p>A list with two components:
</p>

<ul>
<li><p> beta1: First set of beta coefficients
</p>
</li>
<li><p> beta2: Second set of beta coefficients
</p>
</li></ul>


<hr>
<h2 id='fit_spatial_model'>Fit a Spatial Model for Age Parameters using TMB</h2><span id='topic+fit_spatial_model'></span>

<h3>Description</h3>

<p>Fits a spatial model for age parameters using Template Model Builder (TMB)
and C++. The model incorporates spatial correlation through distance matrices
and handles both scale and shape parameters simultaneously. Progress is
tracked with clear status updates. Can optionally load from cache.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>fit_spatial_model(
  data,
  country_code = NULL,
  scale_outcome,
  shape_outcome,
  covariates,
  cpp_script_name,
  verbose = TRUE,
  control_params = list(trace = 2),
  manual_params = NULL,
  output_dir = NULL,
  ignore_cache = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="fit_spatial_model_+3A_data">data</code></td>
<td>
<p>A data frame containing the response variables, covariates, and
spatial coordinates (web_x, web_y)</p>
</td></tr>
<tr><td><code id="fit_spatial_model_+3A_country_code">country_code</code></td>
<td>
<p>Optional country code to save/load cached model. Default
NULL runs model without caching.</p>
</td></tr>
<tr><td><code id="fit_spatial_model_+3A_scale_outcome">scale_outcome</code></td>
<td>
<p>Character string specifying the column name for the
scale parameter response variable</p>
</td></tr>
<tr><td><code id="fit_spatial_model_+3A_shape_outcome">shape_outcome</code></td>
<td>
<p>Character string specifying the column name for the
shape parameter response variable</p>
</td></tr>
<tr><td><code id="fit_spatial_model_+3A_covariates">covariates</code></td>
<td>
<p>Character vector of covariate names to include in both
scale and shape models</p>
</td></tr>
<tr><td><code id="fit_spatial_model_+3A_cpp_script_name">cpp_script_name</code></td>
<td>
<p>Character string specifying the name of the C++ file
(without extension) containing the TMB model definition</p>
</td></tr>
<tr><td><code id="fit_spatial_model_+3A_verbose">verbose</code></td>
<td>
<p>Logical indicating whether to show progress updates. Default
TRUE</p>
</td></tr>
<tr><td><code id="fit_spatial_model_+3A_control_params">control_params</code></td>
<td>
<p>List of control parameters passed to nlminb optimizer.
Default: list(trace = 2)</p>
</td></tr>
<tr><td><code id="fit_spatial_model_+3A_manual_params">manual_params</code></td>
<td>
<p>Optional list of manual parameter values. If NULL
(default), initial parameters are estimated from linear regression. The
list should contain:
</p>

<ul>
<li><p> beta1: Vector of coefficients for scale model
</p>
</li>
<li><p> beta2: Vector of coefficients for shape model
</p>
</li>
<li><p> gamma: Scalar value (default 1.0)
</p>
</li>
<li><p> log_sigma2: Log of sigma squared (default log(1.0))
</p>
</li>
<li><p> log_phi: Log of phi (estimated from variogram)
</p>
</li>
<li><p> log_tau2_1: Log of tau squared (default log(1.0))
</p>
</li></ul>
</td></tr>
<tr><td><code id="fit_spatial_model_+3A_output_dir">output_dir</code></td>
<td>
<p>Directory to save cached models. Only used if country_code
is provided.</p>
</td></tr>
<tr><td><code id="fit_spatial_model_+3A_ignore_cache">ignore_cache</code></td>
<td>
<p>Whether to ignore existing cache. Default FALSE.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function performs the following steps with progress tracking:
1. Fits initial linear models for scale and shape parameters
2. Calculates spatial distance matrix from web coordinates
3. Estimates optimal phi parameter using variogram:
- Computes empirical variogram using automap
- Automatically selects best theoretical variogram model
- Range parameter is used to initialize spatial correlation
- Default range of 100 used if estimation fails
4. Compiles and loads the TMB C++ template
5. Optimizes the joint likelihood using nlminb
</p>
<p>The spatial correlation is modeled using an exponential variogram with
parameters estimated from the data. The distance matrix is computed from
the web coordinates (web_x, web_y) and used in the spatial covariance
structure.
</p>
<p>The C++ template should implement the joint spatial model for both
parameters.
</p>


<h3>Value</h3>

<p>An object of class 'nlminb' containing:
</p>

<ul>
<li><p> par - Optimized parameter values
</p>
</li>
<li><p> objective - Final value of objective function
</p>
</li>
<li><p> convergence - Convergence code
</p>
</li>
<li><p> message - Convergence message
</p>
</li>
<li><p> iterations - Number of iterations
</p>
</li>
<li><p> evaluations - Number of function/gradient evaluations
</p>
</li>
<li><p> scale_formula - Formula used for scale model
</p>
</li>
<li><p> shape_formula - Formula used for shape model
</p>
</li>
<li><p> variogram - Fitted variogram model from automap containing:
</p>

<ul>
<li><p> range - Spatial correlation range parameter
</p>
</li>
<li><p> psill - Partial sill (structured variance)
</p>
</li>
<li><p> nugget - Nugget effect (unstructured variance)
</p>
</li>
<li><p> kappa - Smoothness parameter for Matern models
</p>
</li></ul>

</li></ul>



<h3>Note</h3>

<p>Requires TMB package and a working C++ compiler. The C++ template must be
properly structured for TMB. The automap package is required for variogram
fitting.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

set.seed(123)
# Set parameters for simulation
total_population &lt;- 266
urban_proportion &lt;- 0.602
total_coords &lt;- 266
lon_range &lt;- c(-16.802, -13.849)
lat_range &lt;- c(13.149, 13.801)
mean_web_x &lt;- -1764351
mean_web_y &lt;- 1510868

# Simulate processed survey dataset for Gambia
df_gambia &lt;- NULL
df_gambia$age_param_data &lt;- dplyr::tibble(
  country = "Gambia",
  country_code_iso3 = "GMB",
  country_code_dhs = "GM",
  year_of_survey = 2024,
  id_coords = rep(1:total_coords, length.out = total_population),
  lon = runif(total_population, lon_range[1], lon_range[2]),
  lat = runif(total_population, lat_range[1], lat_range[2]),
  web_x = rnorm(total_population, mean_web_x, 50000),
  web_y = rnorm(total_population, mean_web_y, 50000),
  log_scale = rnorm(total_population, 2.82, 0.2),
  log_shape = rnorm(total_population, 0.331, 0.1),
  urban = rep(c(1, 0), c(
    round(total_population * urban_proportion),
    total_population - round(total_population * urban_proportion)
 )),
 b1 = rnorm(total_population, 0.0142, 0.002),
 c = rnorm(total_population, -0.00997, 0.001),
  b2 = rnorm(total_population, 0.00997, 0.002),
  nsampled = sample(180:220, total_population, replace = TRUE)
)


tf &lt;- file.path(tempdir(), "test_env")
dir.create(tf, recursive = TRUE, showWarnings = FALSE)

#initialise files and key scripts
init(
  r_script_name = "full_pipeline.R",
  cpp_script_name = "model.cpp",
  path = tf,
  open_r_script = FALSE
)

mod &lt;- fit_spatial_model(
  df_gambia$age_param_data,
  scale_outcome = "log_scale",
  shape_outcome = "log_shape",
  covariates = "urban",
  cpp_script_name = file.path(tf, "02_scripts/model"),
  country_code = "GMB",
  output_dir = file.path(tf, "03_outputs/3a_model_outputs")
)


</code></pre>

<hr>
<h2 id='generate_age_pop_raster'>Generate Age Population Raster</h2><span id='topic+generate_age_pop_raster'></span>

<h3>Description</h3>

<p>Creates age-stratified population raster layers from predictor data and gamma
distribution parameters. Supports parallel processing and caching of results.
The output is a multi-layer raster stack with each layer representing the
population proportion for a specific age interval.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>generate_age_pop_raster(
  predictor_data,
  scale_pred,
  shape_pred,
  age_range = c(0, 10),
  age_interval = 1,
  country_code,
  ignore_cache = FALSE,
  output_dir,
  n_cores = parallel::detectCores() - 2
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="generate_age_pop_raster_+3A_predictor_data">predictor_data</code></td>
<td>
<p>Data frame containing population and spatial data with
columns: country, region, district, pop, web_x, web_y</p>
</td></tr>
<tr><td><code id="generate_age_pop_raster_+3A_scale_pred">scale_pred</code></td>
<td>
<p>Matrix of scale parameters for gamma distribution
predictions</p>
</td></tr>
<tr><td><code id="generate_age_pop_raster_+3A_shape_pred">shape_pred</code></td>
<td>
<p>Matrix of shape parameters for gamma distribution
predictions</p>
</td></tr>
<tr><td><code id="generate_age_pop_raster_+3A_age_range">age_range</code></td>
<td>
<p>Numeric vector of length 2 specifying min and max ages,
default c(0,99)</p>
</td></tr>
<tr><td><code id="generate_age_pop_raster_+3A_age_interval">age_interval</code></td>
<td>
<p>Numeric interval size between age groups in years,
default 1</p>
</td></tr>
<tr><td><code id="generate_age_pop_raster_+3A_country_code">country_code</code></td>
<td>
<p>Character ISO3 country code</p>
</td></tr>
<tr><td><code id="generate_age_pop_raster_+3A_ignore_cache">ignore_cache</code></td>
<td>
<p>Logical whether to ignore cached results, default FALSE</p>
</td></tr>
<tr><td><code id="generate_age_pop_raster_+3A_output_dir">output_dir</code></td>
<td>
<p>Character path to output directory</p>
</td></tr>
<tr><td><code id="generate_age_pop_raster_+3A_n_cores">n_cores</code></td>
<td>
<p>Integer number of cores for parallel processing, default
detectCores()-2</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function processes age intervals sequentially, computing population
proportions using parallel processing. Results are cached as a GeoTIFF file
for future use. The output raster maintains spatial properties of the input
data and is suitable for GIS analysis and visualization.
</p>


<h3>Value</h3>

<p>SpatRaster object (terra package) containing multiple layers, where
each layer represents the population proportion for an age interval.
Layer names indicate the age range (e.g., &quot;Age 0 to 1 years&quot;).
The raster uses EPSG:3857 projection with 5000m resolution.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
predictor_data &lt;- data.frame(
 country = rep("CountryX", 100),
 region = rep("RegionA", 100),
 district = rep("District1", 100),
 pop = sample(100:1000, 100, replace = TRUE),
 web_x = runif(100, -100, 100),
 web_y = runif(100, -50, 50)
)

scale_pred &lt;- matrix(runif(100 * 10, 1, 5), nrow = 100, ncol = 10)
shape_pred &lt;- matrix(runif(100 * 10, 1, 5), nrow = 100, ncol = 10)

res &lt;- generate_age_pop_raster(predictor_data,
                       scale_pred,
                       shape_pred,
                       country_code = "COD",
                       output_dir = file.path(tempdir()),
                       n_cores = 1)


</code></pre>

<hr>
<h2 id='generate_age_pop_table'>Generate Age Population Tables</h2><span id='topic+generate_age_pop_table'></span>

<h3>Description</h3>

<p>Creates age-stratified population tables from predictor data and gamma
distribution parameters. Supports parallel processing and caching of results.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>generate_age_pop_table(
  predictor_data,
  scale_pred,
  shape_pred,
  age_range = c(0, 99),
  age_interval = 1,
  country_code,
  ignore_cache = FALSE,
  output_dir,
  n_cores = parallel::detectCores() - 2
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="generate_age_pop_table_+3A_predictor_data">predictor_data</code></td>
<td>
<p>Data frame containing population data with columns:
country, region, district, pop</p>
</td></tr>
<tr><td><code id="generate_age_pop_table_+3A_scale_pred">scale_pred</code></td>
<td>
<p>Matrix of scale parameters for gamma distribution
predictions</p>
</td></tr>
<tr><td><code id="generate_age_pop_table_+3A_shape_pred">shape_pred</code></td>
<td>
<p>Matrix of shape parameters for gamma distribution
predictions</p>
</td></tr>
<tr><td><code id="generate_age_pop_table_+3A_age_range">age_range</code></td>
<td>
<p>Numeric vector of length 2 specifying min and max ages,
default c(0,99)</p>
</td></tr>
<tr><td><code id="generate_age_pop_table_+3A_age_interval">age_interval</code></td>
<td>
<p>Numeric interval size between age groups in years,
default 1</p>
</td></tr>
<tr><td><code id="generate_age_pop_table_+3A_country_code">country_code</code></td>
<td>
<p>Character ISO3 country code</p>
</td></tr>
<tr><td><code id="generate_age_pop_table_+3A_ignore_cache">ignore_cache</code></td>
<td>
<p>Logical whether to ignore cached results, default FALSE</p>
</td></tr>
<tr><td><code id="generate_age_pop_table_+3A_output_dir">output_dir</code></td>
<td>
<p>Character path to output directory</p>
</td></tr>
<tr><td><code id="generate_age_pop_table_+3A_n_cores">n_cores</code></td>
<td>
<p>Integer number of cores for parallel processing, default
detectCores()-2</p>
</td></tr>
</table>


<h3>Value</h3>

<p>List containing two data frames:
- prop_df: Age-stratified population proportions with uncertainty intervals
- pop_df: Age-stratified population counts with uncertainty intervals
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

predictor_data &lt;- data.frame(
 country = rep("ABC", 1100),
  region = rep("Region1", 1100),
  district = rep("District1", 1100),
  pop = rep(1000, 1100)
)
scale_pred &lt;- matrix(rep(1:10, 1100), nrow = 1100, ncol = 10)
shape_pred &lt;- matrix(rep(1:10, 1100), nrow = 1100, ncol = 10)
output &lt;- generate_age_pop_table(
  predictor_data, scale_pred, shape_pred, age_range = c(0, 99),
  age_interval = 10, country_code = "ABC", ignore_cache = TRUE,
  output_dir = tempdir(), n_cores = 1
)


</code></pre>

<hr>
<h2 id='generate_age_pyramid_plot'>Generate and Save Age Pyramid Plot</h2><span id='topic+generate_age_pyramid_plot'></span>

<h3>Description</h3>

<p>This function processes an input dataset to compute age distribution,
generates age pyramid plots by region showing both proportions and counts,
and saves the plots to a specified directory.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>generate_age_pyramid_plot(
  dataset,
  country_code,
  output_dir,
  line_color = "#67000d",
  fill_high = "#fee0d2",
  fill_low = "#a50f15",
  break_axis_by = 10,
  caption = paste0("Note: Total population includes ",
    "ages 99+, pyramid shows ages 0-99")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="generate_age_pyramid_plot_+3A_dataset">dataset</code></td>
<td>
<p>A list containing two data frames:
- prop_df: Population proportions data frame
- pop_df: Population counts data frame
Each with columns for 'country', 'region', 'district', and columns ending
with &quot;mean&quot;</p>
</td></tr>
<tr><td><code id="generate_age_pyramid_plot_+3A_country_code">country_code</code></td>
<td>
<p>A string representing the country code (e.g., &quot;ken&quot;).</p>
</td></tr>
<tr><td><code id="generate_age_pyramid_plot_+3A_output_dir">output_dir</code></td>
<td>
<p>A string specifying the directory where plots should be saved.</p>
</td></tr>
<tr><td><code id="generate_age_pyramid_plot_+3A_line_color">line_color</code></td>
<td>
<p>A string specifying the color of the plot's lines. Default
is '&quot;#67000d&quot;'.</p>
</td></tr>
<tr><td><code id="generate_age_pyramid_plot_+3A_fill_high">fill_high</code></td>
<td>
<p>A string specifying the fill color for high values. Default
is '&quot;#fee0d2&quot;'.</p>
</td></tr>
<tr><td><code id="generate_age_pyramid_plot_+3A_fill_low">fill_low</code></td>
<td>
<p>A string specifying the fill color for low values. Default
is '&quot;#a50f15&quot;'</p>
</td></tr>
<tr><td><code id="generate_age_pyramid_plot_+3A_break_axis_by">break_axis_by</code></td>
<td>
<p>break axis to show less cluttered age groups. Default
is 10</p>
</td></tr>
<tr><td><code id="generate_age_pyramid_plot_+3A_caption">caption</code></td>
<td>
<p>A string specifying the caption text. Default is &quot;Note: Total
population includes ages 99+, pyramid shows ages 0-99&quot;</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list containing both proportion and count plots.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
set.seed(123)
prop_df &lt;- data.frame(
 country = rep("COD", 10),
 region = rep("RegionA", 10),
 district = paste("District", 1:10),
 popsize = runif(10, 2340, 28761),
 `0-4_mean` = runif(10, 0.1, 0.5),
 `5-9_mean` = runif(10, 0.05, 0.4),
 `10-14_mean` = runif(10, 0.03, 0.3)
)

pop_df &lt;- data.frame(
 country = rep("COD", 10),
 region = rep("RegionA", 10),
 district = paste("District", 1:10),
 popsize = runif(10, 2340, 28761),
 `0-4_mean` = runif(10, 1000, 5000),
 `5-9_mean` = runif(10, 800, 4500),
 `10-14_mean` = runif(10, 700, 4000)
)

dataset &lt;- list(prop_df = prop_df, pop_df = pop_df)

res &lt;- generate_age_pyramid_plot(
         dataset = dataset,
         country_code = "COD",
         output_dir = file.path(tempdir()))


</code></pre>

<hr>
<h2 id='generate_gamma_predictions'>Predict Gamma Distribution Parameters for Spatial Grid</h2><span id='topic+generate_gamma_predictions'></span>

<h3>Description</h3>

<p>This function predicts the scale and shape parameters of a Gamma distribution
across a spatial grid using a bivariate spatial model. It can either generate
new predictions or load cached results if available.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>generate_gamma_predictions(
  country_code,
  age_param_data,
  model_params,
  predictor_data,
  shapefile,
  cell_size = 5000,
  n_sim = 5000,
  ignore_cache = FALSE,
  save_file = FALSE,
  output_dir = here::here("03_outputs", "3a_model_outputs")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="generate_gamma_predictions_+3A_country_code">country_code</code></td>
<td>
<p>A string representing the country code (e.g., &quot;KEN&quot;).</p>
</td></tr>
<tr><td><code id="generate_gamma_predictions_+3A_age_param_data">age_param_data</code></td>
<td>
<p>A data frame containing:
</p>

<ul>
<li><p> web_x, web_y: Spatial coordinates
</p>
</li>
<li><p> urban: Urban/rural indicator
</p>
</li>
<li><p> log_scale: Log of scale parameter at observed locations
</p>
</li>
<li><p> log_shape: Log of shape parameter at observed locations
</p>
</li></ul>
</td></tr>
<tr><td><code id="generate_gamma_predictions_+3A_model_params">model_params</code></td>
<td>
<p>A list containing model parameters:
</p>

<ul>
<li><p> par: Named vector with gamma, log_sigma2, log_phi, log_tau1
</p>
</li>
<li><p> Additional parameters for extracting beta coefficients
</p>
</li></ul>
</td></tr>
<tr><td><code id="generate_gamma_predictions_+3A_predictor_data">predictor_data</code></td>
<td>
<p>A data object containing the predictors data.</p>
</td></tr>
<tr><td><code id="generate_gamma_predictions_+3A_shapefile">shapefile</code></td>
<td>
<p>An sf object defining the boundary for predictions</p>
</td></tr>
<tr><td><code id="generate_gamma_predictions_+3A_cell_size">cell_size</code></td>
<td>
<p>Numeric. Grid cell size in meters (default: 5000)</p>
</td></tr>
<tr><td><code id="generate_gamma_predictions_+3A_n_sim">n_sim</code></td>
<td>
<p>Integer. Number of simulations for prediction (default: 5000)</p>
</td></tr>
<tr><td><code id="generate_gamma_predictions_+3A_ignore_cache">ignore_cache</code></td>
<td>
<p>A boolean input which is set to determine whether
to ignore the existing cache and write over it. Default is set to FALSE.</p>
</td></tr>
<tr><td><code id="generate_gamma_predictions_+3A_save_file">save_file</code></td>
<td>
<p>A boolean to determine whether to save prediction or not.
Default is FALSE as this will require lots of space.</p>
</td></tr>
<tr><td><code id="generate_gamma_predictions_+3A_output_dir">output_dir</code></td>
<td>
<p>A string specifying the directory where the predictions
file should be saved (default is &quot;03_outputs/3a_model_outputs&quot;).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list containing:
</p>

<ul>
<li><p> scale_pred: Matrix of simulated scale parameters
</p>
</li>
<li><p> shape_pred: Matrix of simulated shape parameters
</p>
</li></ul>


<hr>
<h2 id='generate_gamma_raster_plot'>Generate and Save Raster Plot for Gamma Predictions</h2><span id='topic+generate_gamma_raster_plot'></span>

<h3>Description</h3>

<p>This function creates rasters from prediction data, combines them into a
stack, and saves the faceted plot to a specified file.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>generate_gamma_raster_plot(
  predictor_data,
  pred_list,
  country_code,
  output_dir,
  save_raster = TRUE,
  file_name_suffix = "gamma_prediction_rasters",
  width = 2500,
  height = 2000,
  png_resolution = 300
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="generate_gamma_raster_plot_+3A_predictor_data">predictor_data</code></td>
<td>
<p>A data frame containing 'web_x' and 'web_y'
coordinates and associated prediction values.</p>
</td></tr>
<tr><td><code id="generate_gamma_raster_plot_+3A_pred_list">pred_list</code></td>
<td>
<p>A list containing predictions ('shape_hat', 'scale_hat',
'mean_age_pred') for creating rasters.</p>
</td></tr>
<tr><td><code id="generate_gamma_raster_plot_+3A_country_code">country_code</code></td>
<td>
<p>A string representing the lowercase country code,
used for naming the output file.</p>
</td></tr>
<tr><td><code id="generate_gamma_raster_plot_+3A_output_dir">output_dir</code></td>
<td>
<p>A string specifying the directory where the plot should
be saved.</p>
</td></tr>
<tr><td><code id="generate_gamma_raster_plot_+3A_save_raster">save_raster</code></td>
<td>
<p>A logical input specifying whether to save output or not.
Default is TRUE.</p>
</td></tr>
<tr><td><code id="generate_gamma_raster_plot_+3A_file_name_suffix">file_name_suffix</code></td>
<td>
<p>A string specifying the suffix for the file name
(default is &quot;gamma_prediction_rasters&quot;).</p>
</td></tr>
<tr><td><code id="generate_gamma_raster_plot_+3A_width">width</code></td>
<td>
<p>Numeric. Width of output plot in pixels (default: 2500).</p>
</td></tr>
<tr><td><code id="generate_gamma_raster_plot_+3A_height">height</code></td>
<td>
<p>Numeric. Height of output plot in pixels (default: 2000).</p>
</td></tr>
<tr><td><code id="generate_gamma_raster_plot_+3A_png_resolution">png_resolution</code></td>
<td>
<p>An integer specifying the resolution of the plot in DPI
(default: 300).</p>
</td></tr>
</table>


<h3>Value</h3>

<p>The path to the saved raster plot.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

predictor_data &lt;- data.frame(
  web_x = runif(100, -100, 100),
  web_y = runif(100, -50, 50)
)

pred_list &lt;- list(
  shape_hat = rnorm(100, mean = 2, sd = 0.5),
  scale_hat = rnorm(100, mean = 10, sd = 2),
  mean_age_pred = rnorm(100, mean = 30, sd = 5)
)

generate_gamma_raster_plot(predictor_data,
                           pred_list,
                           country_code = "COD",
                           output_dir = file.path(tempdir()))


</code></pre>

<hr>
<h2 id='generate_variogram_plot'>Generate Variogram Plot</h2><span id='topic+generate_variogram_plot'></span>

<h3>Description</h3>

<p>Creates a variogram plot showing the spatial dependence structure of the
data. The plot includes both the empirical variogram points and the fitted
theoretical variogram line. The empirical variogram points show the actual
semivariance values at different distances, while the red line shows the
fitted exponential
variogram model.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>generate_variogram_plot(
  age_param_data,
  fit_vario,
  country_code,
  scale_outcome = "log_scale",
  output_dir,
  width = 12,
  height = 9,
  png_resolution = 300
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="generate_variogram_plot_+3A_age_param_data">age_param_data</code></td>
<td>
<p>Data frame containing the age parameter data. Must
include columns 'web_x' and 'web_y' for spatial coordinates and the
response variable specified in scale_outcome.</p>
</td></tr>
<tr><td><code id="generate_variogram_plot_+3A_fit_vario">fit_vario</code></td>
<td>
<p>Fitted variogram object from automap package. Should contain
components $psill (partial sill) and $range (range parameter) for the
exponential variogram model.</p>
</td></tr>
<tr><td><code id="generate_variogram_plot_+3A_country_code">country_code</code></td>
<td>
<p>Character string of the country code (e.g. &quot;TZA&quot;) used
for plot title and output filename.</p>
</td></tr>
<tr><td><code id="generate_variogram_plot_+3A_scale_outcome">scale_outcome</code></td>
<td>
<p>Character string specifying the column name for the
scale parameter response variable (default: &quot;log_scale&quot;). This is the
variable for which the variogram is computed.</p>
</td></tr>
<tr><td><code id="generate_variogram_plot_+3A_output_dir">output_dir</code></td>
<td>
<p>Character string specifying the directory path where the
plot will be saved as a PNG file.</p>
</td></tr>
<tr><td><code id="generate_variogram_plot_+3A_width">width</code></td>
<td>
<p>Plot width in pixels (default: 2000). Controls the output image
width.</p>
</td></tr>
<tr><td><code id="generate_variogram_plot_+3A_height">height</code></td>
<td>
<p>Plot height in pixels (default: 1500). Controls the output
image height.</p>
</td></tr>
<tr><td><code id="generate_variogram_plot_+3A_png_resolution">png_resolution</code></td>
<td>
<p>PNG resolution in DPI (dots per inch, default: 300).
Higher values create larger, higher quality images.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function creates a variogram plot with the following elements:
- Points showing empirical semivariance values at different distances
- A red line showing the fitted exponential variogram model
- Clear axis labels and title
- Comma-formatted distance values on x-axis
- Clean theme with black and white style
</p>
<p>The output filename is constructed as lowercase country
code + &quot;_variogram.png&quot;
</p>


<h3>Value</h3>

<p>Invisibly returns the ggplot object containing the variogram plot.
The plot is also saved as a PNG file in the specified output directory.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
set.seed(123)  # For reproducibility
age_param_data &lt;- data.frame(
  country = rep("TZA", 100),
  web_x = runif(100, 0, 100),
  web_y = runif(100, 0, 100),
  log_scale = rnorm(100, mean = 5, sd = 2)
)

# Create a dummy fitted variogram object
fit_vario &lt;- list(
  psill = c(0.1, 0.5),
  range = c(0, 50)
)

vario_plot &lt;- generate_variogram_plot(
   age_param_data = age_param_data,
   fit_vario = fit_vario,
   country_code = "TZA",
   output_dir = file.path(tempdir()))


</code></pre>

<hr>
<h2 id='init'>Initialize Full Pipeline Script and Model Script</h2><span id='topic+init'></span>

<h3>Description</h3>

<p>Creates a full pipeline R script and a model C++ script, saving them to the
appropriate folders within the project directory structure. The folder
structure is created using 'AgePopDenom::create_project_structure()'.
The scripts contain example code for downloading and processing DHS data,
shapefiles, and running models.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>init(
  r_script_name = "full_pipeline.R",
  cpp_script_name = "model.cpp",
  path = here::here(),
  open_r_script = TRUE,
  setup_rscript = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="init_+3A_r_script_name">r_script_name</code></td>
<td>
<p>Character. The name of the R script file to be created.
Defaults to '&quot;full_pipeline.R&quot;'.</p>
</td></tr>
<tr><td><code id="init_+3A_cpp_script_name">cpp_script_name</code></td>
<td>
<p>Character. The name of the C++ script file to be
created. Defaults to '&quot;model.cpp&quot;'.</p>
</td></tr>
<tr><td><code id="init_+3A_path">path</code></td>
<td>
<p>Character. The directory in which to create the scripts.
Defaults to 'here::here()'.</p>
</td></tr>
<tr><td><code id="init_+3A_open_r_script">open_r_script</code></td>
<td>
<p>Logical. Whether to open the R script automatically in
RStudio (if available). Defaults to 'TRUE'.</p>
</td></tr>
<tr><td><code id="init_+3A_setup_rscript">setup_rscript</code></td>
<td>
<p>Logical. Whether to setup the R script with example
code. Defaults to 'TRUE'.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>Invisibly returns a list containing:
</p>

<ul>
<li><p> r_script_path: Path to the created R script
</p>
</li>
<li><p> cpp_script_path: Path to the created C++ script
</p>
</li></ul>

<p>The function also prints success messages upon script creation.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# Create temp directory with normalized path
tf &lt;- file.path(tempdir(), "test_env")
dir.create(tf, recursive = TRUE, showWarnings = FALSE)

#  Initialize with normalized path
cpp_path &lt;- file.path(tf, "02_scripts", "model")
dir.create(cpp_path, recursive = TRUE, showWarnings = FALSE)
cpp_path &lt;- normalizePath(cpp_path, winslash = "/", mustWork = FALSE)

init(
r_script_name = "full_pipeline.R",
cpp_script_name = "model.cpp",
path = tf,
open_r_script = FALSE
)

</code></pre>

<hr>
<h2 id='install_suggested_packages'>Package Initialization and Dependency Check</h2><span id='topic+install_suggested_packages'></span>

<h3>Description</h3>

<p>This function checks for suggested packages and prompts the user to install
any missing ones that are needed for full functionality.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>install_suggested_packages(libname = NULL, pkgname = NULL)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="install_suggested_packages_+3A_libname">libname</code></td>
<td>
<p>The library name where the package is installed (not used)</p>
</td></tr>
<tr><td><code id="install_suggested_packages_+3A_pkgname">pkgname</code></td>
<td>
<p>The name of the package being loaded (not used)</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function maintains a predefined list of suggested packages and checks if
they are installed. For missing packages, it prompts the user for
installation in interactive sessions.
</p>
<p>The function uses 'cli' for user communication and handles errors gracefully
during installation attempts. In non-interactive sessions, it skips
installation and returns with a warning.
</p>


<h3>Value</h3>

<p>Returns NULL invisibly. The function's main effects are:
</p>

<ul>
<li><p> Checking for missing suggested packages
</p>
</li>
<li><p> Displaying missing packages to user
</p>
</li>
<li><p> Installing packages if user agrees
</p>
</li>
<li><p> Providing feedback on installation success/failure
</p>
</li></ul>



<h3>Note</h3>

<p>- Function requires an interactive session for package installation
- Some functionality may be limited if suggested packages are not installed
- Installation errors are caught and reported but don't stop execution
</p>

<hr>
<h2 id='log_lik'>Log-Likelihood Function for Spatial Model</h2><span id='topic+log_lik'></span>

<h3>Description</h3>

<p>Computes the log-likelihood for a spatial statistical model with a covariance
structure determined by parameters including spatial decay and variance.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>log_lik(
  par,
  p1,
  p2,
  d1,
  d2,
  y,
  u_dist,
  n_x,
  tau2_1 = 1,
  tau2_2 = 1,
  age_param_data
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="log_lik_+3A_par">par</code></td>
<td>
<p>A numeric vector of parameters to estimate. The vector contains:
</p>

<ul>
<li> <p><code>par[1:p1]</code>: Coefficients for fixed effects in dataset 1
(<code class="reqn">\beta_1</code>).
</p>
</li>
<li> <p><code>par[(p1 + 1):(p1 + p2)]</code>: Coefficients for fixed effects in
dataset 2 (<code class="reqn">\beta_2</code>).
</p>
</li>
<li> <p><code>par[p1 + p2 + 1]</code>: Spatial decay parameter (<code class="reqn">\gamma</code>).
</p>
</li>
<li> <p><code>par[p1 + p2 + 2]</code>: Log of the variance parameter
(<code class="reqn">\sigma^2</code>).
</p>
</li>
<li> <p><code>par[p1 + p2 + 3]</code>: Log of the range parameter (<code class="reqn">\phi</code>).
</p>
</li></ul>
</td></tr>
<tr><td><code id="log_lik_+3A_p1">p1</code></td>
<td>
<p>An integer. The number of fixed-effect parameters in dataset 1.</p>
</td></tr>
<tr><td><code id="log_lik_+3A_p2">p2</code></td>
<td>
<p>An integer. The number of fixed-effect parameters in dataset 2.</p>
</td></tr>
<tr><td><code id="log_lik_+3A_d1">d1</code></td>
<td>
<p>A numeric matrix. Design matrix for dataset 1 used to model the
mean structure.</p>
</td></tr>
<tr><td><code id="log_lik_+3A_d2">d2</code></td>
<td>
<p>A numeric matrix. Design matrix for dataset 2 used to model the
mean structure.</p>
</td></tr>
<tr><td><code id="log_lik_+3A_y">y</code></td>
<td>
<p>A numeric vector. Observed response variable, including both
datasets.</p>
</td></tr>
<tr><td><code id="log_lik_+3A_u_dist">u_dist</code></td>
<td>
<p>A numeric matrix. Distance matrix for spatial locations.</p>
</td></tr>
<tr><td><code id="log_lik_+3A_n_x">n_x</code></td>
<td>
<p>An integer. The number of unique spatial locations.</p>
</td></tr>
<tr><td><code id="log_lik_+3A_tau2_1">tau2_1</code></td>
<td>
<p>Variance parameter for first process (default = 1)</p>
</td></tr>
<tr><td><code id="log_lik_+3A_tau2_2">tau2_2</code></td>
<td>
<p>Variance parameter for second process (default = 1)</p>
</td></tr>
<tr><td><code id="log_lik_+3A_age_param_data">age_param_data</code></td>
<td>
<p>A numeric matrix or vector. Additional parameters
specific to age-based modeling.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The log-likelihood is computed as:
</p>
<p style="text-align: center;"><code class="reqn">
-0.5 \left[ \log(\det(M)) + (y - \mu)^T M^{-1} (y - \mu) \right]
</code>
</p>

<p>where:
</p>

<ul>
<li> <p><code class="reqn">M</code> is the covariance matrix, computed using <code>compute_cov</code>.
</p>
</li>
<li> <p><code class="reqn">\mu</code> is the mean structure, determined by the design matrices
<code>d1</code>, <code>d2</code> and coefficients <code class="reqn">\beta_1, \beta_2</code>.
</p>
</li></ul>

<p>The covariance matrix <code class="reqn">M</code> is computed using spatial parameters
(<code class="reqn">\gamma, \sigma^2, \phi</code>) and the distance matrix <code>u_dist</code>.
</p>


<h3>Value</h3>

<p>A numeric scalar. The computed log-likelihood value.
</p>


<h3>Note</h3>

<p>This function requires a helper function, <code>compute_cov</code>, to compute
the covariance matrix based on spatial parameters.
</p>

<hr>
<h2 id='process_dhs_data'>Process DHS Data: Merge RDS Files with Shapefiles and Extract Gamma
Parameters</h2><span id='topic+process_dhs_data'></span>

<h3>Description</h3>

<p>This function processes DHS (Demographic and Health Survey) data by:
1. Reading RDS files and shapefiles for each country.
2. Merging demographic data with geographic information.
3. Cleaning and aggregating the data.
4. Extracting gamma parameters for age-related analysis.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>process_dhs_data(
  rds_dir = here::here("01_data", "1a_survey_data", "raw", "pr_records"),
  shp_dir = here::here("01_data", "1a_survey_data", "raw", "shapefiles"),
  output_path = here::here("01_data", "1a_survey_data", "processed",
    "dhs_pr_records_combined.rds")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="process_dhs_data_+3A_rds_dir">rds_dir</code></td>
<td>
<p>Character. Path to the directory containing raw RDS files.</p>
</td></tr>
<tr><td><code id="process_dhs_data_+3A_shp_dir">shp_dir</code></td>
<td>
<p>Character. Path to the directory containing shapefiles.</p>
</td></tr>
<tr><td><code id="process_dhs_data_+3A_output_path">output_path</code></td>
<td>
<p>Character. Path to save the final processed dataset as an
RDS file.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function loops through RDS files, processes each country's data by
merging demographic information with shapefile data, and computes gamma
parameters for age-related analysis. The progress is tracked and displayed
for each country.
</p>
<p>The function also filters out incomplete data (e.g., age values of '98') and
handles labelled data using the 'haven::zap_labels' function.
</p>
<p>The final output includes two datasets:
1. Outlier-free data.
2. Aggregated age parameter data.
</p>


<h3>Value</h3>

<p>None. Saves the final combined dataset to the specified output path.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
tf &lt;- file.path(tempdir(), "test_env")
dir.create(tf, recursive = TRUE, showWarnings = FALSE)
tmp_rds_dir &lt;- file.path(tf, "rds")
tmp_shp_dir &lt;- file.path(tf, "shp")
tmp_output &lt;- file.path(tf, "output.rds")

dir.create(tmp_rds_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(tmp_shp_dir, recursive = TRUE, showWarnings = FALSE)

# Create fake DHS data
create_fake_dhs_data &lt;- function(country_code) {
  set.seed(123) # For reproducibility
  n &lt;- 100

  # Create labelled vectors
  hv007 &lt;- haven::labelled(
    sample(c(2015, 2016), n, replace = TRUE),
    labels = c("2015" = 2015, "2016" = 2016)
  )

  hv001 &lt;- haven::labelled(
    sample(1:20, n, replace = TRUE),
    labels = setNames(1:20, paste("Cluster", 1:20))
  )

  hv105 &lt;- haven::labelled(
    sample(c(1:97, 98), n, replace = TRUE),
    labels = c(setNames(1:97, paste("Age", 1:97)), "Don't know" = 98)
  )

  # Combine into data frame
  data.frame(
    hv007 = hv007,
    hv001 = hv001,
    hv105 = hv105
  )
}

# Create fake shapefile data
# Create fake shapefile data with explicit CRS
create_fake_shapefile &lt;- function(country_code) {
  set.seed(123)
  n_clusters &lt;- 20

  # Create spatial data frame with explicit CRS
  sf_data &lt;- sf::st_as_sf(
    dplyr::tibble(
      DHSCLUST = 1:n_clusters,
      URBAN_RURA = sample(c("R", "U"), n_clusters, replace = TRUE),
      LATNUM = runif(n_clusters, -10, 10),
    LONGNUM = runif(n_clusters, -10, 10)
  ),
    coords = c("LONGNUM", "LATNUM"),
    crs = 4326 # WGS84
  ) |&gt;
    dplyr::mutate(
      LATNUM = runif(n_clusters, -10, 10),
      LONGNUM = runif(n_clusters, -10, 10)
    )
}

# Save test data for two countries
countries &lt;- c("KE", "TZ")
for (country in countries) {
  saveRDS(
    create_fake_dhs_data(country),
    file = file.path(tmp_rds_dir, paste0(country, "HR71FL.rds"))
  )
  saveRDS(
    create_fake_shapefile(country),
    file = file.path(tmp_shp_dir, paste0(country, "HR7SHP.rds"))
  )
}

# Run the function
process_dhs_data(
  rds_dir = tmp_rds_dir,
  shp_dir = tmp_shp_dir,
  output_path = tmp_output
)


</code></pre>

<hr>
<h2 id='process_final_population_data'>Process Final Population Data</h2><span id='topic+process_final_population_data'></span>

<h3>Description</h3>

<p>Reads population and proportion data from RDS files, processes the data to
generate age-group-based population summaries and proportions at different
administrative levels (Country, Region, District), and writes the results to
an Excel file with separate sheets for each level and metric.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>process_final_population_data(
  input_dir = here::here("03_outputs", "3c_table_outputs"),
  excel_output_file = here::here("03_outputs", "3d_compiled_results",
    "age_pop_denom_compiled.xlsx")
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="process_final_population_data_+3A_input_dir">input_dir</code></td>
<td>
<p>A character string specifying the directory containing RDS
files. Default is &quot;03_outputs/3c_table_outputs&quot; in the project directory.</p>
</td></tr>
<tr><td><code id="process_final_population_data_+3A_excel_output_file">excel_output_file</code></td>
<td>
<p>A character string specifying the output Excel file
path. Default is &quot;03_outputs/3d_compiled_results/age_pop_denom_compiled.xlsx&quot;
in the project directory.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>None. The function writes an Excel file to the specified output
location with six sheets containing population counts and proportions at
different administrative levels.
</p>

<hr>
<h2 id='process_gamma_predictions'>Process Gamma Prediction Results</h2><span id='topic+process_gamma_predictions'></span>

<h3>Description</h3>

<p>This function processes gamma prediction results to calculate the mean age
predictions, scale, and shape parameters efficiently.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>process_gamma_predictions(gamma_prediction)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="process_gamma_predictions_+3A_gamma_prediction">gamma_prediction</code></td>
<td>
<p>A list containing 'scale_pred' and 'shape_pred'
matrices from the gamma prediction model.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A list containing the following elements:
- 'mean_age_pred': A vector of mean age predictions.
- 'scale_hat': A vector of mean scale parameters.
- 'shape_hat': A vector of mean shape parameters.
</p>

<hr>
<h2 id='rasterize_data'>Rasterize Spatial Data</h2><span id='topic+rasterize_data'></span>

<h3>Description</h3>

<p>This function converts spatial data with x, y coordinates and a value field
into a raster using a specified resolution and CRS.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>rasterize_data(x_coords, y_coords, values, cell_size = 5000, crs, fun = mean)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="rasterize_data_+3A_x_coords">x_coords</code></td>
<td>
<p>Numeric vector of x-coordinates (e.g., longitude).</p>
</td></tr>
<tr><td><code id="rasterize_data_+3A_y_coords">y_coords</code></td>
<td>
<p>Numeric vector of y-coordinates (e.g., latitude).</p>
</td></tr>
<tr><td><code id="rasterize_data_+3A_values">values</code></td>
<td>
<p>Numeric vector of values associated with each point.</p>
</td></tr>
<tr><td><code id="rasterize_data_+3A_cell_size">cell_size</code></td>
<td>
<p>Numeric. Grid cell size in meters (default: 5000).</p>
</td></tr>
<tr><td><code id="rasterize_data_+3A_crs">crs</code></td>
<td>
<p>Character, the coordinate reference system in EPSG format
(e.g., &quot;EPSG:3857&quot;).</p>
</td></tr>
<tr><td><code id="rasterize_data_+3A_fun">fun</code></td>
<td>
<p>Function to aggregate values in cells (default is 'mean').</p>
</td></tr>
</table>


<h3>Value</h3>

<p>A 'terra::SpatRaster' object.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>

x_coords &lt;- runif(100, -100, 100)
y_coords &lt;- runif(100, -50, 50)
values &lt;- rnorm(100, mean = 10, sd = 5)

rasterize_data(x_coords, y_coords, values,
               cell_size = 5000, crs = "EPSG:3857", fun = mean)


</code></pre>

<hr>
<h2 id='run_full_workflow'>Run Country-Specific Spatial Modeling Workflow with Logging</h2><span id='topic+run_full_workflow'></span>

<h3>Description</h3>

<p>This function runs the entire spatial modeling workflow for a given country
code and logs the results. It processes Survey data, fits a spatial model,
generates predictions, creates population tables, and produces raster
outputs. The function is modular and can be reused for different countries
with minimal adjustments.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>run_full_workflow(
  country_code,
  survey_data_path = here::here("01_data", "1a_survey_data", "processed"),
  survey_data_suffix = "dhs_pr_records_combined.rds",
  shape_path = here::here("01_data", "1c_shapefiles"),
  shape_suffix = "district_shape.gpkg",
  pop_raster_path = here::here("01_data", "1b_rasters", "pop_raster"),
  pop_raster_suffix = "_ppp_2020_constrained.tif",
  ur_raster_path = here::here("01_data", "1b_rasters", "urban_extent"),
  ur_raster_suffix = "afurextent.asc",
  pred_save_file = FALSE,
  raster_width = 2500,
  raster_height = 2000,
  raster_resolution = 300,
  save_raster = TRUE,
  generate_pop_raster = FALSE,
  pyramid_line_color = "#67000d",
  pyramid_fill_high = "#fee0d2",
  pyramid_fill_low = "#a50f15",
  pyramid_caption = paste0("Note: Total population includes ",
    "ages 99+, pyramid shows ages 0-99"),
  output_paths = list(),
  model_params = list(),
  return_results = FALSE,
  n_cores = parallel::detectCores() - 2,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="run_full_workflow_+3A_country_code">country_code</code></td>
<td>
<p>Character. The ISO3 country code (e.g., &quot;TZA&quot;).</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_survey_data_path">survey_data_path</code></td>
<td>
<p>Character. Path to Survey data.
Default: &quot;01_data/1a_survey_data/processed&quot;.</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_survey_data_suffix">survey_data_suffix</code></td>
<td>
<p>Character. Suffix for Survey data files.
Default: &quot;dhs_pr_records_combined.rds&quot;.</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_shape_path">shape_path</code></td>
<td>
<p>Character. Path to shapefile data.
Default: &quot;01_data/1c_shapefiles&quot;.</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_shape_suffix">shape_suffix</code></td>
<td>
<p>Character. Suffix for shapefile data.
Default: &quot;district_shape.gpkg&quot;.</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_pop_raster_path">pop_raster_path</code></td>
<td>
<p>Character. Path to population raster data.
Default: &quot;01_data/1b_rasters/pop_raster&quot;.</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_pop_raster_suffix">pop_raster_suffix</code></td>
<td>
<p>Character. Suffix for population raster files.
Default: &quot;_ppp_2020_constrained.tif&quot;.</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_ur_raster_path">ur_raster_path</code></td>
<td>
<p>Character. Path to urban-rural extent data.
Default: &quot;01_data/1b_rasters/urban_extent&quot;.</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_ur_raster_suffix">ur_raster_suffix</code></td>
<td>
<p>Character. Suffix for urban-rural raster.
Default: &quot;afurextent.asc&quot;.</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_pred_save_file">pred_save_file</code></td>
<td>
<p>Logical. Whether to save prediction files.
Default: FALSE</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_raster_width">raster_width</code></td>
<td>
<p>Integer. Width of raster plots in pixels.
Default: 2500</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_raster_height">raster_height</code></td>
<td>
<p>Integer. Height of raster plots in pixels.
Default: 2000</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_raster_resolution">raster_resolution</code></td>
<td>
<p>Integer. Resolution of PNG outputs.
Default: 300</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_save_raster">save_raster</code></td>
<td>
<p>Logical. Whether to save raster outputs to disk.
Default: TRUE</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_generate_pop_raster">generate_pop_raster</code></td>
<td>
<p>Logical. Whether to generate population raster.
Default: FALSE</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_pyramid_line_color">pyramid_line_color</code></td>
<td>
<p>Character. Hex color code for the age pyramid's
outline. Default: &quot;#67000d&quot;</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_pyramid_fill_high">pyramid_fill_high</code></td>
<td>
<p>Character. Hex color code for the age pyramid's
higher values fill. Default: &quot;#fee0d2&quot;</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_pyramid_fill_low">pyramid_fill_low</code></td>
<td>
<p>Character. Hex color code for the age pyramid's
lower values fill. Default: &quot;#a50f15&quot;</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_pyramid_caption">pyramid_caption</code></td>
<td>
<p>Character. Caption text for the age pyramid plot.
Default:
&quot;Note: Total population includes ages 99+, pyramid shows ages 0-99&quot;</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_output_paths">output_paths</code></td>
<td>
<p>List of output paths:
</p>

<ul>
<li><p> model: Path for model outputs.
Default: &quot;03_outputs/3a_model_outputs&quot;
</p>
</li>
<li><p> plot: Path for plots.
Default: &quot;03_outputs/3b_visualizations&quot;
</p>
</li>
<li><p> raster: Path for rasters.
Default: &quot;03_outputs/3c_raster_outputs&quot;
</p>
</li>
<li><p> table: Path for tables.
Default: &quot;03_outputs/3c_table_outputs&quot;
</p>
</li>
<li><p> compiled: Path for compiled results.
Default: &quot;03_outputs/3d_compiled_results&quot;
</p>
</li>
<li><p> excel: Path for Excel outputs.
Default:
&quot;03_outputs/3d_compiled_results/age_pop_denom_compiled.xlsx&quot;
</p>
</li>
<li><p> log: Path for logs.
Default: &quot;03_outputs/3a_model_outputs/modelling_log.rds&quot;
</p>
</li></ul>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_model_params">model_params</code></td>
<td>
<p>List of model parameters:
</p>

<ul>
<li><p> cell_size: Cell size in meters. Default: 5000
</p>
</li>
<li><p> n_sim: Number of simulations. Default: 5000
</p>
</li>
<li><p> ignore_cache: Whether to ignore cache. Default: FALSE
</p>
</li>
<li><p> age_range: Age range vector. Default: c(0, 99)
</p>
</li>
<li><p> age_interval: Age interval. Default: 1
</p>
</li>
<li><p> return_prop: Return proportions. Default: TRUE
</p>
</li>
<li><p> scale_outcome: Scale outcome variable. Default: &quot;log_scale&quot;
</p>
</li>
<li><p> shape_outcome: Shape outcome variable. Default: &quot;log_shape&quot;
</p>
</li>
<li><p> covariates: Model covariates. Default: &quot;urban&quot;
</p>
</li>
<li><p> cpp_script: C++ script path. Default: &quot;02_scripts/model&quot;
</p>
</li>
<li><p> control_params: Control parameters. Default: list(trace = 2)
</p>
</li>
<li><p> manual_params: Manual parameters. Default: NULL
</p>
</li>
<li><p> verbose: Verbose output. Default: TRUE
</p>
</li>
<li><p> age_range_raster: Age range for raster output. Default: c(0, 10)
</p>
</li>
<li><p> age_interval_raster: Age interval for raster output. Default: 1
</p>
</li></ul>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_return_results">return_results</code></td>
<td>
<p>Logical. Whether to return results. Default: FALSE.</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_n_cores">n_cores</code></td>
<td>
<p>Integer number of cores for parallel processing for age
population table, default detectCores()-2</p>
</td></tr>
<tr><td><code id="run_full_workflow_+3A_...">...</code></td>
<td>
<p>Additional arguments passed to subfunctions.</p>
</td></tr>
</table>


<h3>Value</h3>

<p>If return_results is TRUE, a list containing:
</p>

<ul>
<li><p> spat_model_param: Fitted spatial model parameters
</p>
</li>
<li><p> predictor_data: Predictor dataset
</p>
</li>
<li><p> gamma_prediction: Generated gamma predictions
</p>
</li>
<li><p> pred_list: Processed gamma prediction results
</p>
</li>
<li><p> final_age_pop_table: Age-population table data
</p>
</li>
<li><p> final_pop: Compiled population data
</p>
</li>
<li><p> all_mod_params: Compiled model parameters
</p>
</li></ul>

<p>If return_results is FALSE, the function saves all outputs to disk and
returns NULL invisibly.
</p>


<h3>See Also</h3>


<ul>
<li> <p><code><a href="#topic+fit_spatial_model">fit_spatial_model</a></code>: Fits the spatial model for age
parameters
</p>
</li>
<li> <p><code><a href="#topic+create_prediction_data">create_prediction_data</a></code>: Creates predictor dataset from
spatial inputs
</p>
</li>
<li> <p><code><a href="#topic+generate_gamma_predictions">generate_gamma_predictions</a></code>: Generates predictions using
fitted model
</p>
</li>
<li> <p><code><a href="#topic+process_gamma_predictions">process_gamma_predictions</a></code>: Processes gamma prediction
results
</p>
</li>
<li> <p><code><a href="#topic+generate_gamma_raster_plot">generate_gamma_raster_plot</a></code>: Creates prediction raster
plots
</p>
</li>
<li> <p><code><a href="#topic+generate_age_pop_table">generate_age_pop_table</a></code>: Generates age-population tables
</p>
</li>
<li> <p><code><a href="#topic+generate_age_pyramid_plot">generate_age_pyramid_plot</a></code>: Creates age pyramid plots
</p>
</li>
<li> <p><code><a href="#topic+extract_age_param">extract_age_param</a></code>: Extracts and compiles model
parameters
</p>
</li>
<li> <p><code><a href="#topic+process_final_population_data">process_final_population_data</a></code>: Processes final
population data
</p>
</li>
<li> <p><code><a href="#topic+generate_variogram_plot">generate_variogram_plot</a></code>: Creates variogram plots
showing spatial dependence structure
</p>
</li></ul>



<h3>Examples</h3>

<pre><code class='language-R'>

# set country code
country_codeiso &lt;- "GMB"

set.seed(123)
# Set parameters for simulation
total_population &lt;- 266
urban_proportion &lt;- 0.602
total_coords &lt;- 266
lon_range &lt;- c(-16.802, -13.849)
lat_range &lt;- c(13.149, 13.801)
mean_web_x &lt;- -1764351
mean_web_y &lt;- 1510868

# Simulate processed survey dataset for Gambia
df_gambia &lt;- NULL
df_gambia$age_param_data &lt;- dplyr::tibble(
  country = "Gambia",
  country_code_iso3 = "GMB",
  country_code_dhs = "GM",
  year_of_survey = 2024,
  id_coords = rep(1:total_coords, length.out = total_population),
  lon = runif(total_population, lon_range[1], lon_range[2]),
  lat = runif(total_population, lat_range[1], lat_range[2]),
  web_x = rnorm(total_population, mean_web_x, 50000),
  web_y = rnorm(total_population, mean_web_y, 50000),
  log_scale = rnorm(total_population, 2.82, 0.2),
  log_shape = rnorm(total_population, 0.331, 0.1),
  urban = rep(c(1, 0), c(
    round(total_population * urban_proportion),
    total_population - round(total_population * urban_proportion)
  )),
  b1 = rnorm(total_population, 0.0142, 0.002),
  c = rnorm(total_population, -0.00997, 0.001),
  b2 = rnorm(total_population, 0.00997, 0.002),
 nsampled = sample(180:220, total_population, replace = TRUE)
)


# Create temp directory with normalized path
tf &lt;- file.path(tempdir(), "test_env")
dir.create(tf, recursive = TRUE, showWarnings = FALSE)
tf &lt;- normalizePath(tf, winslash = "/", mustWork = FALSE)

AgePopDenom::init(
  r_script_name = "full_pipeline.R",
  cpp_script_name = "model.cpp",
  path = tf,
  open_r_script = FALSE
)

# save as processed dhs data
saveRDS(
  df_gambia,
  file = file.path(
    tf, "01_data", "1a_survey_data", "processed",
    "dhs_pr_records_combined.rds"
  ) |&gt;
    normalizePath(winslash = "/", mustWork = FALSE)
)

# Download shapefiles
download_shapefile(
  country_codes = country_codeiso,
  dest_file = file.path(
    tf, "01_data", "1c_shapefiles",
    "district_shape.gpkg"
  ) |&gt;
    normalizePath(winslash = "/", mustWork = FALSE)
)

# Download population rasters from worldpop
download_pop_rasters(
 country_codes = country_codeiso,
  dest_dir = file.path(tf, "01_data", "1b_rasters", "pop_raster") |&gt;
    normalizePath(winslash = "/", mustWork = FALSE)
)
# Extract urban extent raster
extract_afurextent(
  dest_dir = file.path(tf, "01_data", "1b_rasters", "urban_extent") |&gt;
    normalizePath(winslash = "/", mustWork = FALSE)
)

# Modelling --------------------------------------------------------------

run_full_workflow(
  country_code = country_codeiso,
  survey_data_path = file.path(
    tf, "01_data", "1a_survey_data", "processed"
  ) |&gt;
    normalizePath(winslash = "/", mustWork = FALSE),
  survey_data_suffix = "dhs_pr_records_combined.rds",
  shape_path = file.path(
    tf, "01_data", "1c_shapefiles"
  ) |&gt;
    normalizePath(winslash = "/", mustWork = FALSE),
  shape_suffix = "district_shape.gpkg",
  pop_raster_path = file.path(
    tf, "01_data", "1b_rasters", "pop_raster"
  ) |&gt;
    normalizePath(winslash = "/", mustWork = FALSE),
  pop_raster_suffix = "_ppp_2020_constrained.tif",
  ur_raster_path = file.path(
    tf, "01_data", "1b_rasters", "urban_extent"
  ) |&gt;
    normalizePath(winslash = "/", mustWork = FALSE),
  ur_raster_suffix = "afurextent.asc",
  pred_save_file = FALSE,
  raster_width = 2500,
  raster_height = 2000,
  raster_resolution = 300,
  save_raster = TRUE,
  pyramid_line_color = "#67000d",
  pyramid_fill_high = "#fee0d2",
  pyramid_fill_low = "#a50f15",
  pyramid_caption = paste0(
    "Note: Total population includes ",
    "ages 99+, pyramid shows ages 0-99"
  ),
  generate_pop_raster = TRUE,
  output_paths = list(
    model = file.path(tf, "03_outputs", "3a_model_outputs"),
    plot = file.path(tf, "03_outputs", "3b_visualizations"),
    raster = file.path(tf, "03_outputs", "3c_raster_outputs"),
    table = file.path(tf, "03_outputs", "3c_table_outputs"),
    compiled = file.path(tf, "03_outputs", "3d_compiled_results"),
    excel = file.path(
      tf, "03_outputs", "3d_compiled_results",
      "age_pop_denom_compiled.xlsx"
    ),
    log = file.path(
      tf, "03_outputs", "3a_model_outputs", "modelling_log.rds"
    )
  ) |&gt; lapply(\(x) normalizePath(x, winslash = "/", mustWork = FALSE)),
  model_params = list(
    cell_size = 5000,
    n_sim = 10,
    ignore_cache = FALSE,
    age_range = c(0, 1),
    age_interval = 1,
    return_prop = TRUE,
    scale_outcome = "log_scale",
    shape_outcome = "log_shape",
    covariates = "urban",
    cpp_script = file.path(tf, "02_scripts", "model") |&gt;
      normalizePath(winslash = "/", mustWork = FALSE),
    control_params = list(trace = 2),
    manual_params = NULL,
    verbose = TRUE
  ),
  return_results = FALSE,
  n_cores = 1
)


</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
