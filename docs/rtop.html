<!DOCTYPE html><html lang="en"><head><title>Help for package rtop</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
<script type="text/javascript">
const macros = { "\\R": "\\textsf{R}", "\\code": "\\texttt"};
function processMathHTML() {
    var l = document.getElementsByClassName('reqn');
    for (let e of l) { katex.render(e.textContent, e, { throwOnError: false, macros }); }
    return;
}</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
    onload="processMathHTML();"></script>
<link rel="stylesheet" type="text/css" href="R-nav.css" />
</head><body><div class="container"><nav class="package" aria-label="Topic Navigation">
<div class="dropdown-menu">
<h1>Package {rtop}</h1>
<h2>Contents</h2>
<ul class="menu">
<li><a href='#rtop-package'><p>A package providing methods for analysis and spatial interpolation</p>
of data with an irregular support</a></li>
<li><a href='#checkVario'><p> Plot variogram fitted to data with support</p></a></li>
<li><a href='#createRtopObject'><p>Create an object for interpolation within the rtop package</p></a></li>
<li><a href='#downloadRtopExampleData'>
<p>Download additional example data</p></a></li>
<li><a href='#gDist'><p>calculate geostatistical distances between areas</p></a></li>
<li><a href='#getRtopParams'><p> Setting parameters for the intamap package</p></a></li>
<li><a href='#plot.rtopVariogramCloud'>
<p>Plot and Identify Data Pairs on Sample Variogram Cloud</p></a></li>
<li><a href='#readAreaInfo'><p> create SpatialPointsDataFrame with observations</p>
of data with a spatial support</a></li>
<li><a href='#readAreas'><p> help file for creating SpatialPolygonsDataFrame with observations and/or predictionLocations</p>
of data with a spatial support</a></li>
<li><a href='#rtopCluster'><p>start, access, stop or restart a cluster for parallel computation with rtop</p></a></li>
<li><a href='#rtopDisc'><p>Discretize areas</p></a></li>
<li><a href='#rtopFitVariogram'><p>Fit variogram model to sample variogram of data with spatial support</p></a></li>
<li><a href='#rtopKrige'><p>Spatial interpolation of data with spatial support</p></a></li>
<li><a href='#rtopSim'><p>Spatial simulation of data with spatial support</p></a></li>
<li><a href='#rtopVariogram'><p> create variogram for data with spatial support</p></a></li>
<li><a href='#sceua'>
<p>Optimisation with the Shuffle Complex Evolution method</p></a></li>
<li><a href='#useRtopWithIntamap'>
<p>Integrates the rtop package with the <code>intamap</code> package</p></a></li>
<li><a href='#variogramModel'><p> create or update variogram model</p></a></li>
<li><a href='#varMat'><p> create a semivariogram matrix between a set of locations, or semivariogram</p>
matrices between and within two sets of locations</a></li>
</ul>
</div>
<hr>
</nav>
<main>
<table role='presentation'>
<tr>
<td>Type:</td>
<td>Package</td>
</tr>
<tr>
<td>Title:</td>
<td>Interpolation of Data with Variable Spatial Support</td>
</tr>
<tr>
<td>Version:</td>
<td>0.6-9</td>
</tr>
<tr>
<td>Date:</td>
<td>2024-01-29</td>
</tr>
<tr>
<td>Maintainer:</td>
<td>Jon Olav Skøien &lt;jon.skoien@gmail.com&gt;</td>
</tr>
<tr>
<td>Imports:</td>
<td>gstat, graphics, stats, methods, utils, grDevices, sf, units,
sp</td>
</tr>
<tr>
<td>Suggests:</td>
<td>parallel, intamap, spacetime, data.table, reshape2</td>
</tr>
<tr>
<td>Description:</td>
<td>Data with irregular spatial support, such as runoff related data or data from administrative units, can with 'rtop' be interpolated to locations without observations with the top-kriging method. A description of the package is given by Skøien et al (2014) &lt;<a href="https://doi.org/10.1016%2Fj.cageo.2014.02.009">doi:10.1016/j.cageo.2014.02.009</a>&gt;.</td>
</tr>
<tr>
<td>License:</td>
<td><a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a> | <a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a> [expanded from: GPL (&ge; 2)]</td>
</tr>
<tr>
<td>NeedsCompilation:</td>
<td>yes</td>
</tr>
<tr>
<td>Encoding:</td>
<td>UTF-8</td>
</tr>
<tr>
<td>Packaged:</td>
<td>2024-01-29 19:34:50 UTC; skoiejo</td>
</tr>
<tr>
<td>Author:</td>
<td>Jon Olav Skøien [aut, cre],
  Qingyun Duan [ctb] (For the original FORTRAN code of SCE-UA, translated
    and modified to R in this package.)</td>
</tr>
<tr>
<td>Repository:</td>
<td>CRAN</td>
</tr>
<tr>
<td>Date/Publication:</td>
<td>2024-01-30 07:20:02 UTC</td>
</tr>
</table>
<hr>
<h2 id='rtop-package'>A package providing methods for analysis and spatial interpolation
of data with an irregular support </h2><span id='topic+rtop-package'></span>

<h3>Description</h3>

<p>This package provides geostatistical methods for analysis and
interpolation of data that has an irregular support, such as as runoff
characteristics or population health data.
The methods in this package are based on the top-kriging approach
suggested in Skoien et al (2006), with some extensions from Gottschalk (1993).
This package can be used as an add-on package for the automatic interpolation
package developed within the intamap project (www.intamap.org).
</p>


<h3>Workflow</h3>

<p>The work flow within the package suggests that the user is interested in
a prediction of a process at a series of locations where observations have not been made.
The example below shows a regionalization of mean annual runoff in Austria.
</p>
<p>Although it is possible to perform each step with all necessary arguments, 
the easiest interface to
the method is to store all variables (such as observations, prediction locations
and parameters) in an rtop-object, which is created by a call to
<code><a href="#topic+createRtopObject">createRtopObject</a></code>. The element <code>params</code> below consists of
changes to the default parameters. A further description can be found
in <code><a href="#topic+getRtopParams">getRtopParams</a></code>. The changes below means that
the functions will use geostatistical distance instead of full regularization,
and that the variogram model will be fitted to the variogram cloud.
Most other functions in the <code>rtop</code>-package can take this object as an argument,
and will add the results as one or more new element(s) to this object.
</p>
<p>The data in the example below are stored as shape-files
in the extdata-directory of the rtop-pacakge, use the directory of your own data instead. 
The observations consist of mean summer runoff
from 138 catchments in Upper Austria. The predictionLocations are 863 catchments
in the same region. observations and predictionLocations can either be stored as
<code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code>-objects, or as <code><a href="sf.html#topic+sf">sf</a></code>-polygons.
</p>
<pre>
rpath = system.file("extdata",package="rtop")
library(sf)
observations = st_read(rpath, "observations")
predictionLocations = st_read(rpath,"predictionLocations")


# Create a column with the specific runoff:
observations$obs = observations$QSUMMER_OB/observations$AREASQKM
params = list(gDist = TRUE, cloud = TRUE)
rtopObj = createRtopObject(observations, predictionLocations, 
          params = params)
</pre>
<p>There are help-methods available in cases when data are not available as
shape-files, or when the observations are not part of the shape-files.
See <code><a href="#topic+readAreaInfo">readAreaInfo</a></code> and <code><a href="#topic+readAreas">readAreas</a></code>.
</p>
<p>A call to <code><a href="#topic+rtopVariogram">rtopVariogram</a></code> adds the sample variogram to the object,
whereas <br />
<code><a href="#topic+rtopFitVariogram">rtopFitVariogram</a></code> fits a variogram model. The last function
will call <code><a href="#topic+rtopVariogram">rtopVariogram</a></code> if <code>rtopObj</code> does not contain a sample variogram.
</p>
<pre>
rtopObj = rtopVariogram(rtopObj)
rtopObj = rtopFitVariogram(rtopObj, maxn = 2000)
</pre>
<p>The function <code><a href="#topic+checkVario">checkVario</a></code> is useful to produce some
diagnostic plots for the sample variogram and the fitted variogram model.
</p>
<pre>
checkVario(rtopObj)
</pre>
<p>The interpolation function (<code><a href="#topic+rtopKrige">rtopKrige</a></code>) solves the kriging system based on the
computed regularized semivariances. The covariance matrices are created in a
separate regularization function (<code><a href="#topic+varMat">varMat</a></code>), and are stored in
the rtop-object for easier access if it is necessary to redo parts of the
analysis, as this is the computationally expensive part of the interpolation.
Cross-validation can be called with the argument <code>cv=TRUE</code>, either in
<code>params</code> or in the call to <code><a href="#topic+rtopKrige">rtopKrige</a></code>.
</p>
<pre>
rtopObj = rtopKrige(rtopObj)
if (is(rtopObj$predictions, "Spatial")) {
  spplot(rtopObj$predictions, col.regions = bpy.colors(), c("var1.pred"))
} else {
# the plotting order to get small polygons on top is not automatic with sf, 
# but here is a method that works without modifying the predictions
  library(dplyr)
# Arrange according to areas attribute in descending order
  rtopObj$predictions |&gt; arrange(desc(AREASQKM)) |&gt;
  # Make ggplot and set fill color to var1.pred
  ggplot(aes(fill = var1.pred)) + geom_sf() 
}
rtopObj = rtopKrige(rtopObj, cv = TRUE)

if (is(rtopObj$predictions, "Spatial")) {
  spplot(rtopObj$predictions, col.regions = bpy.colors(), c("var1.pred","var1.var"))
} else {
# Here is an alternative method for plotting small polygons on top of the larger ones, 
# modifying the predictions 
  rtopObj$predictions = rtopObj$predictions[order(rtopObj$predictions$AREASQ, decreasing = TRUE), ]
# It is also possible to change the order of the polygons 
  ggplot(rtopObj$predictions) + aes(fill = var1.pred) + geom_sf() + scale_fill_distiller(palette = "YlOrRd")
}
</pre>


<h3>References</h3>

<p>L. Gottschalk. Interpolation of runoff applying objective methods.
Stochastic Hydrology and Hydraulics, 7:269-281, 1993.
</p>
<p>Skoien J. O., R. Merz, and G. Bloschl. Top-kriging - geostatistics on stream networks.
Hydrology and Earth System Sciences, 10:277-287, 2006.
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>

<hr>
<h2 id='checkVario'> Plot variogram fitted to data with support </h2><span id='topic+checkVario'></span><span id='topic+checkVario.rtop'></span><span id='topic+checkVario.rtopVariogramModel'></span>

<h3>Description</h3>

<p>The function will create diagnostic plots for analysis of the variograms fitted
to sample variograms of data with support
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'rtop'
checkVario(object, acor = 1, log = "xy", cloud = FALSE, 
           gDist = TRUE, acomp = NULL, curveSmooth = FALSE, params = list(), ...) 

## S3 method for class 'rtopVariogramModel'
checkVario(object, 
           sampleVariogram = NULL, observations = NULL, 
           areas = NULL, dists = NULL, acomp = NULL,  
           params = list(), compVars = list(), acor = 1, 
           log = "xy", legx = NULL, legy = NULL, 
           plotNugg = TRUE, curveSmooth = FALSE, ...) 
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="checkVario_+3A_object">object</code></td>
<td>
<p>either: object of class <code>rtop</code> (see <code><a href="#topic+rtop-package">rtop-package</a></code>), or an object of type <br />
<code>rtopVariogram</code> </p>
</td></tr>
<tr><td><code id="checkVario_+3A_acor">acor</code></td>
<td>
<p>unit correction factor in the key, e.g. to see numbers more easily 
interpretable for large areas. As an example, ucor = 0.000001 when area
is given in square meters and should rather be shown as square kilometers.
Note that this parameter also changes the value of the nugget to the new unit.</p>
</td></tr>
<tr><td><code id="checkVario_+3A_log">log</code></td>
<td>
<p>text variable for log-plots, default to log-log <code>"xy"</code>, can otherwise be set
to <code>"x"</code>, <code>"y"</code> or <code>""</code></p>
</td></tr>
<tr><td><code id="checkVario_+3A_cloud">cloud</code></td>
<td>
<p>logical; whether to look at the cloud variogram instead of the binned variogram</p>
</td></tr>
<tr><td><code id="checkVario_+3A_gdist">gDist</code></td>
<td>
<p>logical; whether to use ghosh-distance for semivariogram regularization instead of full integration of the semivariogram</p>
</td></tr>
<tr><td><code id="checkVario_+3A_samplevariogram">sampleVariogram</code></td>
<td>
<p>a sample variogram of the data</p>
</td></tr>
<tr><td><code id="checkVario_+3A_observations">observations</code></td>
<td>
<p>a set of observations</p>
</td></tr>
<tr><td><code id="checkVario_+3A_areas">areas</code></td>
<td>
<p>either an array of areas that should be used as examples, or 
the number of areas per order of magnitude (similar to the parameter <code>amul</code>;
see <code><a href="#topic+getRtopParams">getRtopParams</a></code>. amul from <code>rtopObj</code>
or from the default parameter set will be used if not defined here.</p>
</td></tr>
<tr><td><code id="checkVario_+3A_dists">dists</code></td>
<td>
<p>either an array of distances that should be used as examples, or
the number of distances per order of magnitude(similar to the parameter <code>amul</code>;
see <code><a href="#topic+getRtopParams">getRtopParams</a></code>. amul from <code>rtopObj</code>
or from the default parameter set will be used if not defined here.</p>
</td></tr>
<tr><td><code id="checkVario_+3A_acomp">acomp</code></td>
<td>
<p>either a matrix with the area bins that should be visualized, or a number 
giving the number of pairs to show. If a sample variogram is given, the <code>acomp</code>
pairs with highest number of pairs will be used</p>
</td></tr>
<tr><td><code id="checkVario_+3A_curvesmooth">curveSmooth</code></td>
<td>
<p>logical or numerical; describing whether the curves in the last plot should be smoothed or not. If numeric,
it gives the degrees of freedom (df) for the splines used for smoothing. See also <code><a href="stats.html#topic+smooth.spline">smooth.spline</a></code></p>
</td></tr>
<tr><td><code id="checkVario_+3A_params">params</code></td>
<td>
<p>list of parameters to modify the default parameters of rtopObj or 
the default parameters found from <code><a href="#topic+getRtopParams">getRtopParams</a></code></p>
</td></tr>
<tr><td><code id="checkVario_+3A_compvars">compVars</code></td>
<td>
<p>a list of variograms of <code>gstat</code>-type for comparison, see 
<code><a href="gstat.html#topic+vgm">vgm</a></code>. The names of the variograms in the list will
be used in the key.</p>
</td></tr>
<tr><td><code id="checkVario_+3A_legx">legx</code></td>
<td>
<p>x-coordinate of the legend for fine-tuning of position, see x-argument of <br />
<code><a href="graphics.html#topic+legend">legend</a></code></p>
</td></tr>
<tr><td><code id="checkVario_+3A_legy">legy</code></td>
<td>
<p>y-coordinate of the legend for fine-tuning of position, see y-argument of <br />
<code><a href="graphics.html#topic+legend">legend</a></code></p>
</td></tr>
<tr><td><code id="checkVario_+3A_plotnugg">plotNugg</code></td>
<td>
<p>logical; whether the nugget effect should be added to the plot or not</p>
</td></tr>
<tr><td><code id="checkVario_+3A_...">...</code></td>
<td>
<p>arguments to lower level functions</p>
</td></tr>
</table>


<h3>Value</h3>

 
<p>The function gives diagnostic plots for the fitted variograms, where the
regularized variograms are shown together with the sample variograms and 
possibly also user defined variograms. In addition, if an rtopObject
is submitted, the function will also give plots of the relationship between
variance and area size and a scatter plot of the fit of the observed and
regularized variogram values. The sizes of the dots are relative to the number
of pairs in each group.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

 
<p>Skoien J. O., R. Merz, and G. Bloschl. Top-kriging - geostatistics on stream networks.
Hydrology and Earth System Sciences, 10:277-287, 2006.
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
library(gstat)
rpath = system.file("extdata",package="rtop")
library(sf)
observations = st_read(rpath, "observations")
predictionLocations = st_read(rpath,"predictionLocations")

# Create a column with the specific runoff:
observations$obs = observations$QSUMMER_OB/observations$AREASQKM
params = list(cloud = TRUE, gDist = TRUE)
rtopObj = createRtopObject(observations, predictionLocations, 
                           params = params)

# Fit a variogram (function also creates it)
rtopObj = rtopFitVariogram(rtopObj, maxn = 2000)
checkVario(rtopObj, 
    compVars = list(first = vgm(5e-6, "Sph", 30000,5e-8), 
                   second = vgm(2e-6, "Sph", 30000,5e-8)))

rtopObj = checkVario(rtopObj, acor = 0.000001, 
          acomp = data.frame(acl1 = c(2,2,2,2,3,3,3,4,4), 
          acl2 = c(2,3,4,5,3,4,5,4,5)))
rtopObj = checkVario(rtopObj, cloud = TRUE, identify = TRUE, 
          acor = 0.000001)

</code></pre>

<hr>
<h2 id='createRtopObject'>Create an object for interpolation within the rtop package</h2><span id='topic+createRtopObject'></span>

<h3>Description</h3>

<p>This is a help function for creating an object (see <code><a href="#topic+rtop-package">rtop-package</a></code>
to be used for interpolation within the rtop package
</p>


<h3>Usage</h3>

<pre><code class='language-R'>createRtopObject(observations, predictionLocations,
   formulaString, params=list(), overlapObs,
   overlapPredObs, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="createRtopObject_+3A_observations">observations</code></td>
<td>
<p><code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code> or <code><a href="sf.html#topic+sf">sf</a></code>-polygons with observations</p>
</td></tr>
<tr><td><code id="createRtopObject_+3A_predictionlocations">predictionLocations</code></td>
<td>
<p>a <code><a href="sp.html#topic+SpatialPolygons">SpatialPolygons</a></code>,  
<code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code>-object or 
<code><a href="sf.html#topic+sf">sf</a></code>-polygons with 
prediction locations</p>
</td></tr>
<tr><td><code id="createRtopObject_+3A_formulastring">formulaString</code></td>
<td>
<p>formula that defines the dependent variable as a linear model 
of independent variables; suppose the dependent variable has name <code>z</code>, 
for ordinary and simple kriging use the formula <code>z~1</code>; 
for universal kriging, suppose <code>z</code> is linearly dependent on 
<code>x</code> and <code>y</code>, use the formula <code>z~x+y</code>. The formulaString defaults
to <code>"value~1"</code> if <code>value</code> is a part of the data set. 
If not, the first column of the data set is used. Universal kriging 
is not yet properly implemented in the <code>rtop</code>-package, this 
element is mainly used for defining the dependent variable.</p>
</td></tr>
<tr><td><code id="createRtopObject_+3A_params">params</code></td>
<td>
<p>parameters to modify the default parameters of the rtop-package, 
set internally in this function by a call to <code><a href="#topic+getRtopParams">getRtopParams</a></code> </p>
</td></tr>
<tr><td><code id="createRtopObject_+3A_overlapobs">overlapObs</code></td>
<td>
<p>matrix with observations that overlap each other</p>
</td></tr>
<tr><td><code id="createRtopObject_+3A_overlappredobs">overlapPredObs</code></td>
<td>
<p>matrix with <code>observations</code> and <code>predictionLocations</code>
that overlap each other</p>
</td></tr>
<tr><td><code id="createRtopObject_+3A_...">...</code></td>
<td>
<p>Extra parameters to <code><a href="#topic+getRtopParams">getRtopParams</a></code> and possibility
to pass depreceted arguments</p>
</td></tr>
</table>


<h3>Value</h3>

 
<p>An object of class <code>rtop</code> with observations, prediction locations, 
parameters and possible other elements useful for interpolation in the rtop-package.
Most other externally visible functions in the package will be able to 
work with this object, and add the results as a new element.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

 
<p>Skoien J. O., R. Merz, and G. Bloschl. Top-kriging - geostatistics on stream networks.
Hydrology and Earth System Sciences, 10:277-287, 2006.
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+getRtopParams">getRtopParams</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
rpath = system.file("extdata",package="rtop")
library(sf)
observations = st_read(rpath, "observations")
predictionLocations = st_read(rpath,"predictionLocations")

# Create a column with the specific runoff:
observations$obs = observations$QSUMMER_OB/observations$AREASQKM

# Setting some parameters 
params = list(gDist = TRUE, cloud = FALSE)
# Create a column with the specific runoff:
observations$obs = observations$QSUMMER_OB/observations$AREASQKM
# Build an object
rtopObj = createRtopObject(observations, predictionLocations, 
                           params = params)


</code></pre>

<hr>
<h2 id='downloadRtopExampleData'>
Download additional example data
</h2><span id='topic+downloadRtopExampleData'></span>

<h3>Description</h3>

<p>Download additional example data from Vienna University of Technology
</p>


<h3>Usage</h3>

<pre><code class='language-R'>downloadRtopExampleData(folder = system.file("extdata",
                        package="rtop"))
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="downloadRtopExampleData_+3A_folder">folder</code></td>
<td>
<p>the folder to which the downloaded data set will be copied</p>
</td></tr>
</table>


<h3>Value</h3>

<p>The function will have as a side effect that additional example data is
downloaded from Vienna University of Techology. This will for the default
case replace the existing example data-set in the <code>rtop</code> package. Alternatively
the user can specify a separate directory for the data set.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

 
<p>Skoien J. O., R. Merz, and G. Bloschl. Top-kriging - geostatistics on stream networks.
Hydrology and Earth System Sciences, 10:277-287, 2006.
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
  downloadRtopExampleData()
  rpath = system.file("extdata",package="rtop")
  library(sf)
  observations = st_read(rpath,"observations") 

## End(Not run)
</code></pre>

<hr>
<h2 id='gDist'>calculate geostatistical distances between areas</h2><span id='topic+gDist'></span><span id='topic+gDist.rtop'></span><span id='topic+gDist.SpatialPolygonsDataFrame'></span><span id='topic+gDist.SpatialPolygons'></span><span id='topic+gDist.list'></span>

<h3>Description</h3>

<p>Calculate geostatistical distances (Ghosh-distances) between
areas
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'rtop'
gDist(object, params = list(), ...) 
## S3 method for class 'SpatialPolygonsDataFrame'
gDist(object, object2 = NULL, ...) 
## S3 method for class 'SpatialPolygons'
gDist(object, object2 = NULL, ...) 
## S3 method for class 'list'
gDist(object, object2 = NULL, diag = FALSE, debug.level = 0, ...) 
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="gDist_+3A_object">object</code></td>
<td>
<p>object of class <code><a href="sp.html#topic+SpatialPolygons">SpatialPolygons</a></code> or 
<code><a href="sp.html#topic+SpatialPolygons">SpatialPolygonsDataFrame</a></code> with boundaries of areas;
or list of discretized areas, typically from a call to <br />
<code><a href="#topic+rtopDisc">rtopDisc</a></code>; or
object of class <code>rtop</code> with such boundaries and/or discretized
elements (the individual areas)</p>
</td></tr>
<tr><td><code id="gDist_+3A_params">params</code></td>
<td>
<p>a set of parameters, used to modify the default parameters for 
the <code>rtop</code> package, set in <code><a href="#topic+getRtopParams">getRtopParams</a></code>. The argument params can also be used
for the other methods, through the ...-argument.</p>
</td></tr>
<tr><td><code id="gDist_+3A_object2">object2</code></td>
<td>
<p>an object of same type as <code>object</code>, except for <code>rtop</code>;
for calculation of geostatistical
distances also between the elements in the two different objects </p>
</td></tr>
<tr><td><code id="gDist_+3A_diag">diag</code></td>
<td>
<p>logical; if TRUE only calculate the geostatistical distances between
each element and itself, only when the objects are lists of discretized
areas and object2 = object or object2 = NULL</p>
</td></tr>
<tr><td><code id="gDist_+3A_debug.level">debug.level</code></td>
<td>
<p>debug.level = 0 will suppress output from the call to 
varMat, done for calculation of the geostatistical distances</p>
</td></tr>
<tr><td><code id="gDist_+3A_...">...</code></td>
<td>
<p>other parameters, for <code>gDist.list</code> when calling one of the 
other methods, or for <code><a href="#topic+varMat">varMat</a></code>, in which the calculations take place</p>
</td></tr>
</table>


<h3>Value</h3>

 
<p>If called with one list of discretized elements, a matrix with the geostatistical distances 
between the elements within the list. If called with two lists of discretized elements, 
a matrix with the geostatistical distances between the elements in the two lists.
If called with <code>diag = TRUE</code>, the function returns an array of the geostatistical 
distance within each of the elements in the list.
</p>
<p>If called with one <code><a href="sp.html#topic+SpatialPolygons">SpatialPolygons</a></code> or <code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code>
or the function returns a list with one matrix with geostatistical distances between 
the elements of the object. If called with two objects, the list will also containt 
a matrix of the geostatistical distances between the elements of the two objects, and an array
of the geostatistical distances within the elements of the second object. 
</p>
<p>If called with an rtop-object, the function will return the object, amended with the 
list above.
</p>


<h3>Note</h3>

<p>The geostatistical distance can be seen as the average distance between 
points in two elements, or the average distance within points in a single element.
The distance measure is also sometimes referred to as Ghosh-distance, from
Ghosh (1951) who found analytical expressions for these distances between 
blocks with regular geometry.
</p>
<p>The use of geostatistical distances within <code>rtop</code> is based on an idea 
from Gottschalk (1993), who suggested
to replace the traditional regularization of variograms within block-kriging
(as done in the original top-kriging application of Skoien et al (2006))
with covariances of the geostatistical distance. The covariance between two
areas can then be found as <code>C(a1,a2) = cov(gd)</code> where <code>gd</code> is the geostatistical
distance between the two areas <code>a1</code> and <code>a2</code>, instead of an integration 
of the covariance function between the two areas. 
</p>
<p><code>rtop</code> is based on semivariograms
instead of covariances, and the semivariogram value between the two areas
can be found as <code>gamma(a1,a2) = g(gd) - 0.5 (g(gd1) + g(gd2))</code> where
<code>g</code> is a semivariogram valid for point support, <code>gd1)</code> and <code>gd2</code>
are the geostatistical distances within each of the two areas.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

 
<p>Ghosh, B. 1951. Random distances within a rectangle and between two rectangles. Bull. Calcutta Math. Soc., 43, 17-24.
</p>
<p>Gottschalk, L. 1993. Correlation and covariance of runoff. Stochastic Hydrology and Hydraulics, 7, 85-101.
</p>
<p>Skoien, J. O., R. Merz, and G. Bloschl. 2006. Top-kriging - geostatistics on stream networks. Hydrology and Earth System Sciences, 10, 277-287.
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
rpath = system.file("extdata",package="rtop")
library(sf)
observations = st_read(rpath, "observations")
gDist = gDist(observations)


</code></pre>

<hr>
<h2 id='getRtopParams'> Setting parameters for the intamap package</h2><span id='topic+getRtopParams'></span>

<h3>Description</h3>

<p> This function sets a range of the parameters for the intamap package, 
to be included in the object described in <code><a href="#topic+rtop-package">rtop-package</a></code></p>


<h3>Usage</h3>

<pre><code class='language-R'>getRtopParams(params,newPar, observations, formulaString, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="getRtopParams_+3A_params">params</code></td>
<td>
<p>An existing set of parameters for the interpolation process, 
of class <br />
<code>intamapParams</code> or a list of parameters for modification
of the default parameters</p>
</td></tr>
<tr><td><code id="getRtopParams_+3A_newpar">newPar</code></td>
<td>
<p>A <code>list</code> of parameters for updating <code>params</code> or for
modification of the default parameters. 
Possible parameters with their defaults are given below</p>
</td></tr>
<tr><td><code id="getRtopParams_+3A_observations">observations</code></td>
<td>
<p><code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code> with observations,
used for setting some of the default parameters</p>
</td></tr>
<tr><td><code id="getRtopParams_+3A_formulastring">formulaString</code></td>
<td>
<p>formula that defines the dependent variable as a linear model 
of independent variables, see e.g. <code><a href="#topic+createRtopObject">createRtopObject</a></code> for more details.</p>
</td></tr>
<tr><td><code id="getRtopParams_+3A_...">...</code></td>
<td>
<p>Individual parameters for updating <code>params</code> or for
modification of the default parameters.
Possible parameters with their defaults are given below 
</p>

<dl>
<dt>model = &quot;Ex1&quot;</dt><dd><p> - variogram model type. Currently the following models are implemented:
</p>

<dl>
<dt>Exp</dt><dd><p> - Exponential model</p>
</dd>
<dt>Ex1</dt><dd><p> - Multiplication of a modified exponential and fractal model, 
the same model as used in Skoien et al(2006).</p>
</dd>
<dt>Gau</dt><dd><p> - Gaussian model</p>
</dd>
<dt>Ga1</dt><dd><p> - Multiplication of gaussian and fractal model</p>
</dd>
<dt>Sph</dt><dd><p> - Spherical model</p>
</dd>
<dt>Sp1</dt><dd><p> - Multiplication of spherical and fractal model</p>
</dd>
<dt>Fra</dt><dd><p> - Fractal model</p>
</dd>
</dl>
</dd>
<dt>parInit</dt><dd><p> - the initial parameters and the limits of the variogram model to be fitted,
given as a matrix with three columns, where the first column is the 
lower limit, the second column is the upper limit and the third column
are starting values.</p>
</dd>
<dt>nugget = FALSE</dt><dd><p> - logical; if TRUE, nugget effect should be estimated</p>
</dd>
<dt>unc = TRUE</dt><dd><p> - logical; if TRUE the variance of observations are in column <code>unc</code></p>
</dd>
<dt>rresol = 100</dt><dd><p> - minimum number of discretization points in each area</p>
</dd>  
<dt>hresol = 5</dt><dd><p> - number of discretization points in one direction for elements in binned variograms</p>
</dd>
<dt>cloud = FALSE</dt><dd><p> - logical; if TRUE use the cloud variogram for variogram fitting</p>
</dd>
<dt>amul = 1</dt><dd><p> - defines the number of areal bins within one order of magnitude. Numbers between 1 and 3 
are possible, as this parameter refers to the <code>axp</code> parameter of
<code><a href="graphics.html#topic+axTicks">axTicks</a></code>.</p>
</dd>
<dt>dmul = 3</dt><dd><p> - defines the number of distance bins within one order of magnitude. Numbers between 1 and 3 
are possible, as this parameter refers to the <code>axp</code> parameter of
<code><a href="graphics.html#topic+axTicks">axTicks</a></code>.</p>
</dd>
<dt>fit.method = 9</dt><dd><p> - defines the type of Least Square method for fitting of variogram. 
The methods 1-7 correspond to the similar methods in <code><a href="gstat.html#topic+fit.variogram">fit.variogram</a></code> of <code><a href="gstat.html#topic+gstat">gstat</a></code>.
</p>

<dl>
<dt>1</dt><dd><p> - weighted least squares with number of pairs per bin: <br /> 
err = n * (yobs-ymod)^2</p>
</dd>
<dt>2</dt><dd><p> - weighted least squares difference according to Cressie (1985): <br />
err2 = abs(yobs/ymod-1)</p>
</dd>
<dt>6</dt><dd><p> - ordinary least squares difference: err = (yobs-ymod)^2</p>
</dd>
<dt>7</dt><dd><p> - similar to default of gstat, where higher weights are given to shorter distances err = n/h^2 * (yobs-mod)^2</p>
</dd>
<dt>8</dt><dd><p> - Opposite of weighted least squares difference according to Cressie (1985): err3=abs(ymod/yobs-1)</p>
</dd>
<dt>9</dt><dd><p> - neutral WLS-method - err = min(err2,err3)</p>
</dd>
</dl>

</dd>
<dt>gDistEst = FALSE</dt><dd><p> - use geostatistical distance when fitting variograms</p>
</dd>
<dt>gDistPred = FALSE</dt><dd><p> - use geostatistical distance for semivariogram matrices</p>
</dd>
<dt>gDist</dt><dd><p> - parameter to set jointly <code>gDistEst = gDistPred = gDist</code></p>
</dd>
<dt>nmax = 10</dt><dd><p>for local kriging: the number of nearest observations that
should be used for a kriging prediction or simulation, where
nearest is defined in terms of the space of the spatial locations.
By default, 10 observations are used.</p>
</dd>
<dt>maxdist = Inf</dt><dd><p> - for local kriging: only observations within a distance 
of <code>maxdist</code> from the prediction location are used for prediction 
or simulation; if combined with nmax, both criteria apply </p>
</dd>
<dt>hstype = &quot;regular&quot;</dt><dd><p> - sampling type for binned variograms</p>
</dd>
<dt>rstype = &quot;rtop&quot;</dt><dd><p> - sampling type for the elements, see also <code><a href="#topic+rtopDisc">rtopDisc</a></code></p>
</dd>
<dt>nclus = 1</dt><dd><p>- number of CPUs to use if parallel processing is wanted; nclus = 1 means
no parallelization</p>
</dd>
<dt>cnAreas = 100</dt><dd><p>- limit whether parallel processing should be applied; the minimum number
of areas in <code><a href="#topic+varMat">varMat</a></code>, and also controlling when to use parallel 
processing in
<code><a href="#topic+rtopDisc">rtopDisc</a></code>, when <br />
<code>nAreas*params$rresol/100 &gt; cnAreas</code> </p>
</dd>
<dt>clusType = NULL</dt><dd><p>- the cluster type to be started for parallel processing; uses the default 
type of the system when clusType = NULL</p>
</dd>
<dt>outfile = NULL</dt><dd><p>file where output can be printed during parallel execution</p>
</dd>
<dt>varClean = FALSE</dt><dd><p>logical; if TRUE it will remove highly correlated areas from the covariance matrix during simulation </p>
</dd>
<dt>wlim = 1.5</dt><dd><p> - an upper limit for the norm of the weights in kriging, see <code><a href="#topic+rtopKrige">rtopKrige</a></code></p>
</dd>
<dt>wlimMethod = &quot;all&quot;</dt><dd><p>which method to use for reducing the norm of the weights if necessary. Either &quot;all&quot;, which modifies all weights equally or &quot;neg&quot; which reduces negative weights and large weights more than the smallest weights </p>
</dd>
<dt>singularSolve</dt><dd><p> - logical; When TRUE, the kriging function will attempt to solve singular kriging matrices by removing catchments that have the same correlations. This will usually happen when two catchments are almost overlapping, and they are discretized with the same points. See also <code><a href="#topic+rtopKrige">rtopKrige</a></code>.</p>
</dd>
<dt>cv = FALSE</dt><dd><p> - logical; for cross-validation of observations</p>
</dd>
<dt>debug.level = 1</dt><dd><p> - used in some functions for giving additional output. See 
individual functions for more information.</p>
</dd>
<dt>partialOverlap = FALSE</dt><dd><p>whether to work with partially overlapping areas</p>
</dd>
<dt>olim = 1e-4</dt><dd><p>smallest overlapping area to be used for partial overlap, relative to the smallest of the areas</p>
</dd>
<dt>nclus = 1</dt><dd><p>option to use parallel processing, nclus &gt; 1 defines the number of workers to be started</p>
</dd>
<dt>clusType = NA</dt><dd><p>which cluster type to start if nclus &gt; 1; the default is used if nclusType = NA </p>
</dd>
<dt>cnAreas = 200</dt><dd><p>The minimum number of observations or observations plus predictions allowing parallelization in
the creation of the covariance matrix</p>
</dd>
<dt>cDlim = 1e6</dt><dd><p>The minimum number of discretization points for allowing parallelization in the discretization process</p>
</dd>
<dt>observations</dt><dd><p> - used for initial values of parameters if supplied</p>
</dd>
<dt>formulaString</dt><dd><p> - used for initial values of parameters if supplied</p>
</dd>
</dl>

</td></tr>
</table>


<h3>Value</h3>

 
<p>A list of the parameters with class <code>rtopParams</code> to be included in the 
<code>object</code> described in <a href="#topic+rtop-package">rtop-package</a></p>


<h3>Note</h3>

<p>This function will mainly be called by <code><a href="#topic+createRtopObject">createRtopObject</a></code>, but 
can also be called by the user to create a parameter set or update an 
existing parameter set. If none of the arguments is a list of class
<code>rtopParams</code>, the function will assume that the argument(s) are
modifications to the default set of parameters. The function can also be called
by other functions in the rtop-package if the users chooses not to work with
an object of class <code>rtop</code>.
</p>
<p>If the function is called with two lists of parameters (but the first one is
not of class <code>rtopParams</code>) they are both seen as modifications to the 
default parameter set. If they share some parameters, the parameter values from
the second list will be applied.
</p>
<p>Parallel processing has been included for some of the functions. The default is no 
parallel procesing, and the package also attempts to decide whether it is sensible to 
start a set of clusters and distribute jobs to them based on the size of the job. 
The default limit might not be the best for every system.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

 
<p>Cressie, N. 1985. Fitting variogram models by weighted least squares. Mathematical Geology, 17 (5), 563-586
</p>
<p>Skoien J. O., R. Merz, and G. Bloschl. Top-kriging - geostatistics on stream networks.
Hydrology and Earth System Sciences, 10:277-287, 2006
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+createRtopObject">createRtopObject</a></code> and <code><a href="#topic+rtop-package">rtop-package</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'># Create a new set of intamapParameters, with default parameters:
params = getRtopParams()
# Make modifications to the default list of parameters
params = getRtopParams(newPar = list(gDist = TRUE, nugget = FALSE))
# Make modifications to an existing list of parameters
params = getRtopParams(params = params, newPar = list(gDist = TRUE,
         nugget = FALSE))
</code></pre>

<hr>
<h2 id='plot.rtopVariogramCloud'>
Plot and Identify Data Pairs on Sample Variogram Cloud
</h2><span id='topic+plot.rtopVariogramCloud'></span>

<h3>Description</h3>

<p>Plot a sample variogram cloud, possibly with identification of
individual point pairs
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'rtopVariogramCloud'
plot(x, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="plot.rtopVariogramCloud_+3A_x">x</code></td>
<td>
<p> object of class <code>variogramCloud</code></p>
</td></tr>
<tr><td><code id="plot.rtopVariogramCloud_+3A_...">...</code></td>
<td>
<p> parameters that are passed through to <code><a href="gstat.html#topic+plot.variogramCloud">plot.variogramCloud</a></code>
The most important are:
</p>

<dl>
<dt>identify</dt><dd><p> logical; if TRUE, the plot allows identification of
a series of individual point pairs that correspond to individual variogram
cloud points (use left mouse button to select; right mouse button ends) </p>
</dd>
<dt>digitize</dt><dd><p> logical; if TRUE, select point pairs by digitizing a
region with the mouse (left mouse button adds a point, right mouse button
ends) </p>
</dd>
<dt>xlim</dt><dd><p> limits of x-axis </p>
</dd>
<dt>ylim</dt><dd><p> limits of y-axis </p>
</dd>
<dt>xlab</dt><dd><p> x axis label </p>
</dd>
<dt>ylab</dt><dd><p> y axis label </p>
</dd>
<dt>keep</dt><dd><p> logical; if TRUE and <code>identify</code> is TRUE, the labels
identified and their position are kept and glued to object x, which is
returned. Subsequent calls to plot this object will now have the labels
shown, e.g. to plot to hardcopy </p>
</dd>
</dl>

</td></tr>
</table>


<h3>Note</h3>

<p>This function is mainly a wrapper around <code><a href="gstat.html#topic+plot.variogramCloud">plot.variogramCloud</a></code>,
necessary because of different column names and different class names. The 
description of arguments and value can therefore be found in
the help page of <code><a href="gstat.html#topic+plot.variogramCloud">plot.variogramCloud</a></code>.</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

 
<p><a href="http://www.gstat.org/">http://www.gstat.org/</a>
</p>


<h3>See Also</h3>

<p><a href="gstat.html#topic+plot.gstatVariogram">plot.gstatVariogram</a>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
rpath = system.file("extdata",package="rtop")
library(sf)
observations = st_read(rpath, "observations")

observations$obs = observations$QSUMMER_OB/observations$AREASQKM

# Create the sample variogram
rtopVario = rtopVariogram(observations, params = list(cloud = TRUE))
plot(rtopVario)


</code></pre>

<hr>
<h2 id='readAreaInfo'> create SpatialPointsDataFrame with observations
of data with a spatial support </h2><span id='topic+readAreaInfo'></span>

<h3>Description</h3>

<p>readAreaInfo will read a text file with observations and descriptions of 
data with a spatial support.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>readAreaInfo(fname = "ainfo.txt", id = "id",
                iobs = "iobs", obs = "obs", unc = "unc",
                filenames= "filenames", sep = "\t", 
                debug.level = 1, moreCols = list(NULL)) 
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="readAreaInfo_+3A_fname">fname</code></td>
<td>
<p> name of file with areal information</p>
</td></tr>
<tr><td><code id="readAreaInfo_+3A_id">id</code></td>
<td>
<p> name of column with observation id </p>
</td></tr>
<tr><td><code id="readAreaInfo_+3A_iobs">iobs</code></td>
<td>
<p> name of column with number of observations</p>
</td></tr>
<tr><td><code id="readAreaInfo_+3A_obs">obs</code></td>
<td>
<p> name of column with observations </p>
</td></tr>
<tr><td><code id="readAreaInfo_+3A_unc">unc</code></td>
<td>
<p> name of column with possible uncertainty of observation</p>
</td></tr>
<tr><td><code id="readAreaInfo_+3A_filenames">filenames</code></td>
<td>
<p> name of column with filenames of areas if different names than id should
be used.</p>
</td></tr>
<tr><td><code id="readAreaInfo_+3A_sep">sep</code></td>
<td>
<p>separator in csv-file</p>
</td></tr>
<tr><td><code id="readAreaInfo_+3A_debug.level">debug.level</code></td>
<td>
<p>used for giving additional output</p>
</td></tr>
<tr><td><code id="readAreaInfo_+3A_morecols">moreCols</code></td>
<td>
<p>name of other column names the user wants included in ainfo</p>
</td></tr>
</table>


<h3>Details</h3>

<p>The function is of particular use when data are not available as
shape-files, or when the observations are not part of the shape-files.
This function is mainly for compatibility with the former FORTRAN-version.
The simplest way to read the data in that case is through <code><a href="sf.html#topic+st_read">st_read</a></code>. See
also <code><a href="#topic+rtop-package">rtop-package</a></code>.
</p>


<h3>Value</h3>

 
<p><code><a href="sp.html#topic+SpatialPoints">SpatialPointDataFrame</a></code> with information about observations and/or
predictionLocations.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>

<hr>
<h2 id='readAreas'> help file for creating SpatialPolygonsDataFrame with observations and/or predictionLocations
of data with a spatial support </h2><span id='topic+readAreas'></span>

<h3>Description</h3>

<p>readAreas will read area-files, add observations and convert the result to <br />
<code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code>
</p>


<h3>Usage</h3>

<pre><code class='language-R'>readAreas(object, adir=".",ftype = "xy",projection = NA, ...) 
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="readAreas_+3A_object">object</code></td>
<td>
<p>either name of file with areal information or <code><a href="sp.html#topic+SpatialPointsDataFrame">SpatialPointsDataFrame</a></code>
with observations</p>
</td></tr>
<tr><td><code id="readAreas_+3A_adir">adir</code></td>
<td>
<p>directory where the files with areal information are to be found</p>
</td></tr>
<tr><td><code id="readAreas_+3A_ftype">ftype</code></td>
<td>
<p>type of file, the only type supported currently is &quot;xy&quot;, 
referring to x- and y-coordinates of boundaries</p>
</td></tr>
<tr><td><code id="readAreas_+3A_projection">projection</code></td>
<td>
<p>add projection to the object if input is boundary-files </p>
</td></tr>
<tr><td><code id="readAreas_+3A_...">...</code></td>
<td>
<p>further parameters to be passed to <code><a href="#topic+readAreaInfo">readAreaInfo</a></code></p>
</td></tr>
</table>


<h3>Details</h3>

<p>If <code>object</code> is a file name, <code><a href="#topic+readAreaInfo">readAreaInfo</a></code> will be called.
If it is a <br />
<code><a href="sp.html#topic+SpatialPoints">SpatialPointsDataFrame</a></code> with observations and/or 
predictionLocations, the function will read areal data from files according 
to the ID associated with each observation/predictionLocation. 
</p>
<p>The function is of particular use when data are not available as
shape-files, or when the observations are not part of the shape-files.
This function is mainly for compatibility with the former FORTRAN-version.
The simplest way to read the data in that case is through <code><a href="sf.html#topic+st_read">st_read</a></code>. See
also <code><a href="#topic+rtop-package">rtop-package</a></code>.
</p>


<h3>Value</h3>

 
<p>The function creates a <code><a href="sp.html#topic+SpatialPolygons">SpatialPolygonsDataFrame</a></code> of observations
and/or predictionLocations, depending on the information given in <code>object</code>.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>

<hr>
<h2 id='rtopCluster'>start, access, stop or restart a cluster for parallel computation with rtop</h2><span id='topic+rtopCluster'></span>

<h3>Description</h3>

<p>Convenience function for using parallel computation with rtop. The function is usually not 
called by the user.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>rtopCluster(nclus, ..., action = "start", type, outfile = NULL)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="rtopCluster_+3A_nclus">nclus</code></td>
<td>
<p>The number of workers in the cluster</p>
</td></tr>
<tr><td><code id="rtopCluster_+3A_...">...</code></td>
<td>
<p>Arguments for <code><a href="parallel.html#topic+clusterEvalQ">clusterEvalQ</a></code>; commands to be evaluated for each worker, such as library-calls</p>
</td></tr>
<tr><td><code id="rtopCluster_+3A_action">action</code></td>
<td>
<p>Defines the action of the function. There are three options:
</p>

<dl>
<dt>&quot;start&quot;</dt><dd><p>Starts a new cluster if necessary, reuses an existing if it has already been started</p>
</dd>
<dt>&quot;restart&quot;</dt><dd><p>Stops the cluster and starts it again. To be used in case there are difficulties with the cluster, 
or if the user wants to change the type of the cluster</p>
</dd>
</dl>

</td></tr>
<tr><td><code id="rtopCluster_+3A_type">type</code></td>
<td>
<p>The type of cluster; see <code><a href="parallel.html#topic+makeCluster">makeCluster</a></code> for more details. 
The default of makeCluster is used if type is missing or NA.</p>
</td></tr>
<tr><td><code id="rtopCluster_+3A_outfile">outfile</code></td>
<td>
<p>File to direct the output, <code><a href="parallel.html#topic+makeCluster">makeCluster</a></code> for more details. </p>
</td></tr>
</table>


<h3>Details</h3>

<p>It is usually not necessary for the user to call this function for starting or accessing a cluster. This is done automatically
by the different rtop-functions when needed if the parameter nclus is larger than one (see <code><a href="#topic+getRtopParams">getRtopParams</a></code>). If the user actually starts the cluster by a call to this function, it will 
also be necessary to set the nclus parameter to a value larger than one for the cluster to be used by different functions.
</p>
<p>Restarting the cluster might be necessary if the cluster has a problem (e.g. does not return memory) or if the user wants to change to a different cluster type. 
</p>
<p>Stopping the cluster is useful when the user does not want to continue with parallel computation and wants to close down the workers.
</p>


<h3>Value</h3>

 
<p>If the function is called with action equal to &quot;start&quot; or &quot;restart&quot;, the result is a cluster with nclus workers.
The cluster is also added to the global options with the name rtopCluster <br />
(<code>getOption("rtopCluster")</code>).
</p>
<p>If the function is called with action equal to &quot;stop&quot;, the function stops the cluster, sets the rtopCluster of options to NULL and returns NULL to the user.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>

<hr>
<h2 id='rtopDisc'>Discretize areas</h2><span id='topic+rtopDisc'></span><span id='topic+rtopDisc.rtop'></span><span id='topic+rtopDisc.SpatialPolygonsDataFrame'></span><span id='topic+rtopDisc.SpatialPolygons'></span><span id='topic+rtopDisc.rtopVariogram'></span>

<h3>Description</h3>

<p><code>rtopDisc</code> will discretize an area for 
regularization or calculation of Ghosh-distance
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'rtop'
rtopDisc(object, params = list(),...) 
## S3 method for class 'SpatialPolygonsDataFrame'
rtopDisc(object, params = list(), bb = bbox(object), ...) 
## S3 method for class 'SpatialPolygons'
rtopDisc(object, params = list(), bb = bbox(object),  ...) 
## S3 method for class 'rtopVariogram'
rtopDisc(object, params = list(), ...) 
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="rtopDisc_+3A_object">object</code></td>
<td>
<p>object of class <code><a href="sp.html#topic+SpatialPolygons">SpatialPolygons</a></code> or <code><a href="sp.html#topic+SpatialPolygons">SpatialPolygonsDataFrame</a></code>
or <code>rtopVariogram</code>,
or an object with class <code>rtop</code> that includes one of the above
</p>
</td></tr>
<tr><td><code id="rtopDisc_+3A_bb">bb</code></td>
<td>
<p>boundary box, usually modified to be the common boundary box for two 
spatial object</p>
</td></tr>
<tr><td><code id="rtopDisc_+3A_params">params</code></td>
<td>
<p>possibility to pass parameters to modify the default parameters for 
the <code>rtop</code> package, set in <code><a href="#topic+getRtopParams">getRtopParams</a></code>. Typical parameters
to modify for this function are:
</p>

<ul>
<li><p>rresol = 100; minimum number of discretization points in areas  
</p>
</li>
<li><p>hresol = 5; number of discretization points in one direction for areas in binned variograms
</p>
</li>
<li><p>hstype = &quot;regular&quot;; sampling type for binned variograms
</p>
</li>
<li><p>rstype = &quot;rtop&quot;; sampling type for real areas
</p>
</li></ul>
    
</td></tr>
<tr><td><code id="rtopDisc_+3A_...">...</code></td>
<td>
<p>Possibility to pass individual parameters</p>
</td></tr>
</table>


<h3>Details</h3>

<p>There are different options for discretizing the objects. When the areas
from the bins are discretized, the options are <code>random</code> or <code>regular</code> sampling, 
<code>regular</code> sampling is the default.
</p>
<p>For the real areas, regular sampling appears to have computational advantages compared
with random sampling. In addition to the traditional regular sampling, <code>rtop</code>
also offers a third type of sampling which assures that the same discretization
points are used for overlapping areas. 
</p>
<p>Starting with a coarse grid covering the 
region of interest, this will for a certain support be refined till a 
requested minimum number of points from the grid is within the support. 
In this way, for areal supports, the number of points in the area with the 
largest number of points will be approximately four times the requested minimum 
number of points. This methods also assure that points used to discretize a 
large support will be reused when discretizing smaller supports within the 
large one, e.g. subcatchments within larger catchments. 
</p>


<h3>Value</h3>

 
<p>The function returns a list of discretized areas, or if called with an 
rtop-object as argument, the object with lists of discretizations of the
observations and prediction locations (if part of the object). If the function
is called with an rtopVariogram (usually this is an internal call), the 
list contains discretized pairs of hypothetical objects from each bin of 
the semivariogram with a centre-to-centre
distance equal to the average distance between the objects in a certain bin.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

 
<p>Skoien J. O., R. Merz, and G. Bloschl. Top-kriging - geostatistics on stream networks.
Hydrology and Earth System Sciences, 10:277-287, 2006.
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+rtopVariogram">rtopVariogram</a></code>
</p>

<hr>
<h2 id='rtopFitVariogram'>Fit variogram model to sample variogram of data with spatial support</h2><span id='topic+rtopFitVariogram'></span><span id='topic+rtopFitVariogram.rtop'></span><span id='topic+rtopFitVariogram.SpatialPolygonsDataFrame'></span><span id='topic+rtopFitVariogram.SpatialPointsDataFrame'></span><span id='topic+rtopFitVariogram.rtopVariogram'></span><span id='topic+rtopFitVariogram.rtopVariogramCloud'></span>

<h3>Description</h3>

<p>rtopFitVariogram will fit a variogram model to the estimated binned variogram or cloud variogram of data
with an areal support.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'rtop'
rtopFitVariogram(object, params = list(), iprint = 0, ...) 
## S3 method for class 'SpatialPolygonsDataFrame'
rtopFitVariogram(object, params=list(), ...) 
## S3 method for class 'SpatialPointsDataFrame'
rtopFitVariogram(object, params=list(), ...) 
## S3 method for class 'rtopVariogram'
rtopFitVariogram(object, observations, dists = NULL, 
                    params=list(), mr = FALSE, aOver = NULL, iprint = 0, ...) 
## S3 method for class 'rtopVariogramCloud'
rtopFitVariogram(object, observations, dists = NULL, 
                    aOver = NULL, params=list(), mr = FALSE, iprint = 0, ...) 
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="rtopFitVariogram_+3A_object">object</code></td>
<td>
<p>object of class <code>rtopVariogram</code> or <code>rtopVariogramCloud</code>,
or an object with class <code>rtop</code> that includes the sample variograms.
</p>
<p>The object can also be of class <code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code> or <br />
<code><a href="sp.html#topic+SpatialPointsDataFrame">SpatialPointsDataFrame</a></code>
with observations. If <code>object</code> is a <br />
<code><a href="sp.html#topic+SpatialPointsDataFrame">SpatialPointsDataFrame</a></code>,
it must have a column with name <code>area</code>.
</p>
</td></tr>
<tr><td><code id="rtopFitVariogram_+3A_observations">observations</code></td>
<td>
<p>the observations, passed as a Spatial*DataFrame object, if
object is an <br />
<code>rtopVariogram</code> or <code>rtopVariogramCloud</code></p>
</td></tr>
<tr><td><code id="rtopFitVariogram_+3A_params">params</code></td>
<td>
<p>a set of parameters, used to modify the default parameters for 
the <code>rtop</code> package, set in <code><a href="#topic+getRtopParams">getRtopParams</a></code>. The argument params can also be used
for the other methods, through the ...-argument.</p>
</td></tr>
<tr><td><code id="rtopFitVariogram_+3A_dists">dists</code></td>
<td>
<p>either a matrix with geostatistical distances (created by a call
to the function <code><a href="#topic+gDist">gDist</a></code> or a list with the
areas  discretized (from a call to <code><a href="#topic+rtopDisc">rtopDisc</a></code>.</p>
</td></tr>
<tr><td><code id="rtopFitVariogram_+3A_mr">mr</code></td>
<td>
<p>logical; defining whether the function should return a list with 
discretized elements and geostatistical distances, even if it was not
called with an rtop-object as argument.</p>
</td></tr>
<tr><td><code id="rtopFitVariogram_+3A_aover">aOver</code></td>
<td>
<p>a matrix with the overlapping areas of the observations, used for computation of the nugget effect. 
It will normally be recomputed by the function if it is NULL and necessary</p>
</td></tr>
<tr><td><code id="rtopFitVariogram_+3A_iprint">iprint</code></td>
<td>
<p>print flag that is passed to <code><a href="#topic+sceua">sceua</a></code> </p>
</td></tr>
<tr><td><code id="rtopFitVariogram_+3A_...">...</code></td>
<td>
<p>Other parameters to functions called from <code>rtopFitVarigoram</code>. For the
three first methods of the function, <code>...</code> can also include
parameters to the last two methods. </p>
</td></tr>
</table>


<h3>Value</h3>

 
<p>The function creates an object with the fitted 
variogram Model (<code>variogramModel</code>) 
and a <br />
<code><a href="base.html#topic+data.frame">data.frame</a></code> (<code>varFit</code>) with the 
differences between the sample semivariances and the regularized semivariances.
If <code>mr</code> = TRUE, the function also returns other objects (discretized elements
and geostatistical distances, if created) as a part of the returned object.
If the function is called with an rtop-object as argument, it will return an
rtop-object with <code>variogramModel</code> and <code>varFit</code> added to the object,
in addition to other objects created.
</p>


<h3>Note</h3>

<p>There are several options for fitting of the variogramModel, where the parameters
can be set in <code>params</code>, which is a list of parameters for modification
of the default parameters of the rtop-package given in a call to 
<code><a href="#topic+getRtopParams">getRtopParams</a></code>. The first choice is between individual fitting and binned
fitting. This is based on the type of variogram submitted, individual fitting is done
if a cloud variogram (of class <code>rtopVariogramCloud</code>) is passed as argument, 
and binned fitting if the submitted variogram is of class <code>rtopVariogram</code>.
If the function is called with an object of class <code>rtop</code>, having both
<code>variogram</code> and <code>variogramCloud</code> among its arguments, the variogram
model is fitted to the variogram which is consistent with the parameter <code>cloud</code>.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

 
<p>Skoien J. O., R. Merz, and G. Bloschl. Top-kriging - geostatistics on stream networks.
Hydrology and Earth System Sciences, 10:277-287, 2006.
</p>
<p>Skoien, J. O. and G. Bloschl. Spatio-Temporal Top-Kriging of Runoff Time Series. Water Resources Research 43:W09419, 2007.
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
rpath = system.file("extdata",package="rtop")
library(sf)
observations = st_read(rpath, "observations")
predictionLocations = st_read(rpath,"predictionLocations")

# Create a column with the specific runoff:
observations$obs = observations$QSUMMER_OB/observations$AREASQKM

# Setting some parameters 
params = list(gDist = TRUE, cloud = FALSE)
# Create a column with the specific runoff:
observations$obs = observations$QSUMMER_OB/observations$AREASQKM
# Build an object
rtopObj = createRtopObject(observations,predictionLocations, 
                           params = params)
# Fit a variogram (function also creates it)
rtopObj = rtopFitVariogram(rtopObj)
rtopObj$variogramModel

</code></pre>

<hr>
<h2 id='rtopKrige'>Spatial interpolation of data with spatial support</h2><span id='topic+rtopKrige'></span><span id='topic+rtopKrige.rtop'></span><span id='topic+rtopKrige.SpatialPolygonsDataFrame'></span><span id='topic+rtopKrige.STSDF'></span><span id='topic+rtopKrige.default'></span>

<h3>Description</h3>

<p>rtopKrige perform spatial interpolation or cross validation of data with areal support.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'rtop'
rtopKrige(object, varMatUpdate = FALSE, params = list(), ...) 
## S3 method for class 'SpatialPolygonsDataFrame'
rtopKrige(object, predictionLocations = NULL,
    varMatObs, varMatPredObs, varMat, params = list(), 
    formulaString, sel, ...) 
## S3 method for class 'STSDF'
rtopKrige(object, predictionLocations = NULL,
    varMatObs, varMatPredObs, varMat, params = list(), 
    formulaString, sel, olags = NULL, plags = NULL, 
    lagExact = TRUE, ...) 
## Default S3 method:
rtopKrige(object, predictionLocations = NULL,
    varMatObs,  varMatPredObs, varMat, params = list(),
    formulaString, sel, wret = FALSE, ...) 



</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="rtopKrige_+3A_object">object</code></td>
<td>
<p>object of class <code>rtop</code> or <code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code> or <code><a href="spacetime.html#topic+STSDF">STSDF</a></code></p>
</td></tr>
<tr><td><code id="rtopKrige_+3A_varmatupdate">varMatUpdate</code></td>
<td>
<p>logical; if TRUE, also existing variance matrices will 
be recomputed, if FALSE, only missing variance matrices will be computed,
see also <code><a href="#topic+varMat">varMat</a></code></p>
</td></tr>
<tr><td><code id="rtopKrige_+3A_predictionlocations">predictionLocations</code></td>
<td>
<p><code><a href="sp.html#topic+SpatialPolygons">SpatialPolygons</a></code> or <code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code> or 
<code><a href="spacetime.html#topic+STSDF">STSDF</a></code> 
with prediction locations. NULL if cross validation is to be performed.</p>
</td></tr>
<tr><td><code id="rtopKrige_+3A_varmatobs">varMatObs</code></td>
<td>
<p>covariance matrix of observations, where diagonal must consist 
of internal variance, typically generated from call
to <code><a href="#topic+varMat">varMat</a></code> </p>
</td></tr>
<tr><td><code id="rtopKrige_+3A_varmatpredobs">varMatPredObs</code></td>
<td>
<p>covariance matrix between observation locations and 
prediction locations, typically generated from call
to <code><a href="#topic+varMat">varMat</a></code></p>
</td></tr>
<tr><td><code id="rtopKrige_+3A_varmat">varMat</code></td>
<td>
<p>list covariance matrices including the two above</p>
</td></tr>
<tr><td><code id="rtopKrige_+3A_params">params</code></td>
<td>
<p>a set of parameters, used to modify the default parameters for 
the <code>rtop</code> package, set in <code><a href="#topic+getRtopParams">getRtopParams</a></code>. Additionally,
it is possible overrule some of the parameters in <code>object$params</code> by passing
them as separate arguments.</p>
</td></tr>
<tr><td><code id="rtopKrige_+3A_formulastring">formulaString</code></td>
<td>
<p>formula that defines the dependent variable as a linear model 
of independent variables, see e.g. <code><a href="#topic+createRtopObject">createRtopObject</a></code> for more details.</p>
</td></tr>
<tr><td><code id="rtopKrige_+3A_sel">sel</code></td>
<td>
<p>array of prediction location numbers, if only a limited number of locations are to be
interpolated/crossvalidated</p>
</td></tr>
<tr><td><code id="rtopKrige_+3A_wret">wret</code></td>
<td>
<p>logical; if TRUE, return a matrix of weights instead of the predictions,
useful for batch processing of time series, see also details</p>
</td></tr>
<tr><td><code id="rtopKrige_+3A_olags">olags</code></td>
<td>
<p>A vector describing the relative lag which should be applied for the observation locations. See also details</p>
</td></tr>
<tr><td><code id="rtopKrige_+3A_plags">plags</code></td>
<td>
<p>A vector describing the relative lag which should be applied for the predicitonLocations. See also details</p>
</td></tr>
<tr><td><code id="rtopKrige_+3A_lagexact">lagExact</code></td>
<td>
<p>logical; whether differences in lagtime should be computed exactly or approximate</p>
</td></tr>
<tr><td><code id="rtopKrige_+3A_...">...</code></td>
<td>
<p>from <code>rtopKrige.rtop</code>, arguments to be passed to 
<code>rtopKrige.default</code>. In <code>rtopKrige.default</code>,
parameters for modification of the object parameters or default parameters.
Of particular interest are <code>cv</code>, a logical for doing cross-validation,
<code>nmax</code>, and <code>maxdist</code> for maximum number of neighbours and
maximum distance to neighbours, respectively, and <code>wlim</code>, the limit for
the absolute values of the weights. It can also be useful to set <code>singularSolve</code> if some of the areas are almost similar, see also details below.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function is the interpolation routine of the rtop-package.
The simplest way of calling the function is with an rtop-object that 
contains the fitted variogram model and all the other necessary data (see
<code><a href="#topic+createRtopObject">createRtopObject</a></code> or <code><a href="#topic+rtop-package">rtop-package</a></code>). 
</p>
<p>The function will, if called with covariance matrices between observations
and between observations and prediction locations, use these for the interpolation.
If the function is called without these matrices, <code><a href="#topic+varMat">varMat</a></code> will be
called to create them. These matrices can therefore be reused if necessary,
an advantage as it is computationally expensive to create them.
</p>
<p>The interpolation that takes part within <code>rtopKrige.default</code> is based on 
the semivariance matrices between observations and between observations and prediction
locations. It is therefore possible to use this function also to interpolate
data where the matrices have been created in other ways, e.g. based on distances
in physiographical space or distances along a stream.
</p>
<p>The function returns the weights rather than the predictions if <code>wret = TRUE</code>.
This is useful for batch processing of time series, e.g. once the weights are 
created, they can be used to compute the interpolated values for each time step.
</p>
<p>rtop is able to take some advantage of multiple CPUs, which can be invoked with the 
parameter <code>nclus</code>. When it gets a number larger than one, <code>rtopKrige</code> will start a cluster with <code>nclus</code> workers,
if the <code><a href="parallel.html#topic+parallel">parallel</a></code>-package has been installed. 
</p>
<p>The parameter <code>singularSolve</code> can be used when some areas are almost completely overlapping. In this case, the discretization of them might be equal, and the covariances to other areas will also be equal. The kriging matrix will in this case be singular. When <code>singularSolve = TRUE</code>, <code>rtopKrige</code> will remove one of the neighbours, and instead work with the mean of the two observations. An overview of removed neighbours can be seen in the resulting object, under the name <code>removed</code>.
</p>
<p>Kriging of time series is possible when <code>observations</code> and <code>predictionLocations</code>
are spatiotemporal objects of type <code><a href="spacetime.html#topic+STSDF">STSDF</a></code>. The interpolation is 
still spatial, in the sense that the regularisation of the variograms are just done
using the spatial extent of the observations, not a possible temporal extent, such as
done by Skoien and Bloschl (2007). However, it is possible to make predictions based on observations 
from different time steps, through the use of the lag-vectors. These vectors describe a typical &quot;delay&quot;
for each observation and prediction location. This delay could for runoff related variables be similar
to travel time to each gauging location. For a certain prediction location, earlier time steps would be picked for neighbours with shorter travel time and later time steps for neighbours with slower travel times.
</p>
<p>The lagExact parameter indicates whether to use a weighted average of two time steps, or just the time step which is closest to the difference in lag times. 
</p>
<p>The use of lag times should in theory increase the computation time, but might, due to different computation methods, even speed up the computation when the number of neighbours to be used (parameter nmax) is small compared to the number of observations. If computation is slow, it can be useful to test olags = rep(0, dim(observations)[1]) and similar for predictionLocations.
</p>


<h3>Value</h3>

 
<p>If called with <code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code>, the function returns a <br />
<code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code> with predictions, either at the 
locations defined in <br />
<code>predictionLocations</code>, or as leave-one-out
cross-validation predicitons at the same locations as in object if 
<code>cv = TRUE</code>
</p>
<p>If called with an rtop-object, the function returns the same object with the
predictions added to the object.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

 
<p>Skoien J. O., R. Merz, and G. Bloschl. Top-kriging - geostatistics on stream networks.
Hydrology and Earth System Sciences, 10:277-287, 2006.
</p>
<p>Skoien, J. O. and G. Bloschl. Spatio-Temporal Top-Kriging of Runoff Time Series. Water Resources Research 43:W09419, 2007.
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# The following command will download  the complete example data set
# downloadRtopExampleData() 
# observations$obs = observations$QSUMMER_OB/observations$AREASQKM

rpath = system.file("extdata",package="rtop")
library(sf)
observations = st_read(rpath, "observations")
predictionLocations = st_read(rpath,"predictionLocations")

# Setting some parameters; nclus &gt; 1 will start a cluster with nclus 
# workers for parallel processing
params = list(gDist = TRUE, cloud = FALSE, nclus = 1, rresol = 25)

# Create a column with the specific runoff:
observations$obs = observations$QSUMMER_OB/observations$AREASQKM

# Build an object
rtopObj = createRtopObject(observations, predictionLocations, 
           params = params)

# Fit a variogram (function also creates it)
rtopObj = rtopFitVariogram(rtopObj)

# Predicting at prediction locations
rtopObj = rtopKrige(rtopObj)

# Cross-validation
rtopObj = rtopKrige(rtopObj,cv=TRUE)
cor(rtopObj$predictions$observed,rtopObj$predictions$var1.pred)

</code></pre>

<hr>
<h2 id='rtopSim'>Spatial simulation of data with spatial support</h2><span id='topic+rtopSim'></span><span id='topic+rtopSim.rtop'></span><span id='topic+rtopSim.default'></span>

<h3>Description</h3>

<p>rtopSim will conditionally or unconditionally simulate data with areal support. This function should be seen as experimental, some issues are described below.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>

  
## S3 method for class 'rtop'
rtopSim(object, varMatUpdate = FALSE, beta = NA, 
      largeFirst = TRUE, replace = FALSE, params = list(), 
      dump = NULL, debug.level, ...) 
## Default S3 method:
rtopSim(object = NULL, predictionLocations,
    varMatObs,  varMatPredObs, varMatPred, variogramModel, ...) 
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="rtopSim_+3A_object">object</code></td>
<td>
<p>object of class <code>rtop</code> or <code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code> or
<code>sf</code> (<code><a href="sf.html#topic+st_sf">st_sf</a></code>) or <code>NULL</code></p>
</td></tr>
<tr><td><code id="rtopSim_+3A_varmatupdate">varMatUpdate</code></td>
<td>
<p>logical; if TRUE, also existing variance matrices will 
be recomputed, if FALSE, only missing variance matrices will be computed,
see also <code><a href="#topic+varMat">varMat</a></code></p>
</td></tr>
<tr><td><code id="rtopSim_+3A_beta">beta</code></td>
<td>
<p>The expected mean of the data, for unconditional simulations</p>
</td></tr>
<tr><td><code id="rtopSim_+3A_largefirst">largeFirst</code></td>
<td>
<p>Although the simulation method follows a random path around the 
predictionLocations, simulating the largest area first will assure
that the true mean of the simulated values will be closer to beta</p>
</td></tr>
<tr><td><code id="rtopSim_+3A_replace">replace</code></td>
<td>
<p>logical; if observation locations are also present as predictions, should they be replaced?
This is particularly when doing conditional simulations for a set of observations 
with uncertainty.</p>
</td></tr>
<tr><td><code id="rtopSim_+3A_params">params</code></td>
<td>
<p>a set of parameters, used to modify the standard parameters for 
the <code>rtop</code> package, set in <code><a href="#topic+getRtopParams">getRtopParams</a></code>. The argument params can also be used
for the other methods, through the ...-argument.</p>
</td></tr>
<tr><td><code id="rtopSim_+3A_dump">dump</code></td>
<td>
<p>file name for saving the updated object, after adding variance matrices. Useful if there
are problems with the simulation, particularly if it for some reason crashes.</p>
</td></tr>
<tr><td><code id="rtopSim_+3A_debug.level">debug.level</code></td>
<td>
<p>logical that controls some output, will override the object parameters</p>
</td></tr>
<tr><td><code id="rtopSim_+3A_predictionlocations">predictionLocations</code></td>
<td>
<p><code><a href="sp.html#topic+SpatialPolygons">SpatialPolygons</a></code> or <code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code>
or <code>sf</code>-object with locations for simulations. </p>
</td></tr>
<tr><td><code id="rtopSim_+3A_varmatobs">varMatObs</code></td>
<td>
<p>covariance matrix of possible observations, where diagonal must consist 
of internal variance, typically generated from call
to <code><a href="#topic+varMat">varMat</a></code> </p>
</td></tr>
<tr><td><code id="rtopSim_+3A_varmatpredobs">varMatPredObs</code></td>
<td>
<p>covariance matrix between possible observation locations and 
simulation locations, typically generated from call
to <code><a href="#topic+varMat">varMat</a></code></p>
</td></tr>
<tr><td><code id="rtopSim_+3A_varmatpred">varMatPred</code></td>
<td>
<p>covariance matrix between simulation locations, typically generated
from a call to <code><a href="#topic+varMat">varMat</a></code></p>
</td></tr>
<tr><td><code id="rtopSim_+3A_variogrammodel">variogramModel</code></td>
<td>
<p>a variogram model of type <code><a href="#topic+rtopVariogramModel">rtopVariogramModel</a></code> </p>
</td></tr>
<tr><td><code id="rtopSim_+3A_...">...</code></td>
<td>
<p>possible modification of the object parameters or default parameters.</p>
</td></tr>
</table>


<h3>Details</h3>

<p>This function can do constrained or unconstrained simulation for areas.
The simplest way of calling the function is with an rtop-object that 
contains the fitted variogram model and all the other necessary data (see
<code><a href="#topic+createRtopObject">createRtopObject</a></code> or <code><a href="#topic+rtop-package">rtop-package</a></code>). <code>rtopSim</code>
is the only function in <code>rtop</code> which does not need  observations. 
However, a variogram model is still necessary to perform simulations.
</p>
<p>The arguments <code>beta</code> and <code>largeFirst</code> are only used for unconditional simulations.
</p>
<p>The function is still in an experimental stage, and might change in the future. There are some issues with the current implementation:
</p>

<ul>
<li><p>Numerical issues can in some cases give negative estimation variances, which will result in an invalid distribution for the simulation. This will result in simulated NA values for these locations.
</p>
</li>
<li><p>The variability of simulated values for small areas (such as small headwater catchments) will be relatively high based on the statistical uncertainty. This could be overestimated compared to the uncertainty which is possible based on rainfall.
</p>
</li></ul>



<h3>Value</h3>

 
<p>If called with <code><a href="sp.html#topic+SpatialPolygons">SpatialPolygons</a></code> or <code>sf</code> as predictionLocations
and either <br />
<code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code>, <code>sf</code> or <code>NULL</code> for
observations, the function returns a<br />
<code><a href="sp.html#topic+SpatialPolygonsDataFrame">SpatialPolygonsDataFrame</a></code> or <code>sf</code> with simulations at the 
locations defined in <br />
<code>predictionLocations</code>
</p>
<p>If called with an rtop-object, the function returns the same object with the
simulations added to the object.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

 
<p>Skoien J. O., R. Merz, and G. Bloschl. Top-kriging - geostatistics on stream networks.
Hydrology and Earth System Sciences, 10:277-287, 2006.
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>
# The following command will download  the complete example data set
# downloadRtopExampleData() 

rpath = system.file("extdata",package="rtop")
library(sf)
observations = st_read(rpath, "observations")
predictionLocations = st_read(rpath,"predictionLocations")

# Setting some parameters; nclus &gt; 1 will start a cluster with nclus 
# workers for parallel processing
params = list(gDist = TRUE, cloud = FALSE, nclus = 1, rresol = 25)

# Create a column with the specific runoff:
observations$obs = observations$QSUMMER_OB/observations$AREASQKM

# Build an object
rtopObj = createRtopObject(observations, predictionLocations, 
                           params = params, formulaString = "obs~1")

# Fit a variogram (function also creates it)
rtopObj = rtopFitVariogram(rtopObj)

# Conditional simulations for two new locations 
rtopObj10 = rtopSim(rtopObj, nsim = 5)
rtopObj11 = rtopObj

# Unconditional simulation at the observation locations
# (These are moved to the predictionLocations)
rtopObj11$predictionLocations = rtopObj11$observations
rtopObj11$observations = NULL
# Setting varMatUpdate to TRUE, to make sure that covariance
# matrices are recomputed
rtopObj12 = rtopSim(rtopObj11, nsim = 10, beta = 0.01, 
                    varMatUpdate = TRUE)

summary(data.frame(rtopObj10$simulations))
summary(data.frame(rtopObj12$simulations))


</code></pre>

<hr>
<h2 id='rtopVariogram'> create variogram for data with spatial support </h2><span id='topic+rtopVariogram'></span><span id='topic+rtopVariogram.rtop'></span><span id='topic+rtopVariogram.SpatialPolygonsDataFrame'></span><span id='topic+rtopVariogram.SpatialPointsDataFrame'></span><span id='topic+rtopVariogram.STSDF'></span>

<h3>Description</h3>

<p>rtopVariogram will create binned variogram or cloud variogram of data
with an areal support.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'rtop'
rtopVariogram(object, params = list(), ...) 
## S3 method for class 'SpatialPolygonsDataFrame'
rtopVariogram(object, ...) 
## S3 method for class 'SpatialPointsDataFrame'
rtopVariogram(object, formulaString, params=list(), cloud, 
                       abins, dbins, ...) 
## S3 method for class 'STSDF'
rtopVariogram(object, formulaString, params=list(), cloud, 
                       abins, dbins, data.table = FALSE, ...) 
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="rtopVariogram_+3A_object">object</code></td>
<td>
<p> object of class <code>rtop</code> (see <a href="#topic+rtop-package">rtop-package</a>) or a <br />
<code><a href="sp.html#topic+SpatialPolygons">SpatialPolygonsDataFrame</a></code>
or <code><a href="sp.html#topic+SpatialPoints">SpatialPointsDataFrame</a></code>
with information about observations. If <br />
<code>object</code> is a <br />
<code><a href="sp.html#topic+SpatialPoints">SpatialPointsDataFrame</a></code>,
it must have a column with name <code>area</code>.
</p>
</td></tr>
<tr><td><code id="rtopVariogram_+3A_formulastring">formulaString</code></td>
<td>
<p>formula that defines the dependent variable as a linear model 
of independent variables; suppose the dependent variable has name <code>z</code>, 
for ordinary and simple kriging use the formula <code>z~1</code>; 
for universal kriging, suppose <code>z</code> is linearly dependent on 
<code>x</code> and <code>y</code>, use the formula <code>z~x+y</code>. The formulaString defaults
to <code>"value~1"</code> if <code>value</code> is a part of the data set. 
If not, the first column of the data set is used.</p>
</td></tr>
<tr><td><code id="rtopVariogram_+3A_params">params</code></td>
<td>
<p>a set of parameters, used to modify the default parameters for 
the <code>rtop</code> package, set in <code><a href="#topic+getRtopParams">getRtopParams</a></code>. </p>
</td></tr>
<tr><td><code id="rtopVariogram_+3A_cloud">cloud</code></td>
<td>
<p>logical; if TRUE, calculate the semivariogram cloud, can be used
to overrule the cloud parameter in params. </p>
</td></tr>
<tr><td><code id="rtopVariogram_+3A_abins">abins</code></td>
<td>
<p>possibility to set areal bins (not yet implemented)</p>
</td></tr>
<tr><td><code id="rtopVariogram_+3A_dbins">dbins</code></td>
<td>
<p>possibility to set distance bins (not yet implemented)</p>
</td></tr>
<tr><td><code id="rtopVariogram_+3A_data.table">data.table</code></td>
<td>
<p>an option to use data.table internally for the variogram computation for 
<code><a href="spacetime.html#topic+STSDF">STSDF</a></code>-objects</p>
</td></tr>
<tr><td><code id="rtopVariogram_+3A_...">...</code></td>
<td>
<p>parameters to other functions called, e.g. gstat's 
<code><a href="gstat.html#topic+variogram">variogram</a></code>-function and to <code><a href="#topic+rtopVariogram.SpatialPointsDataFrame">rtopVariogram.SpatialPointsDataFrame</a></code>
when the method is called with an object of a different class</p>
</td></tr>
</table>


<h3>Value</h3>

 
<p>The function creates a variogram, either of type <code>rtopVariogram</code> or 
<code>rtopVariogramCloud</code>. This variogram is based on the <code><a href="gstat.html#topic+variogram">variogram</a></code>
function from gstat, but has additional information about the spatial size or
length of the observations. An rtop-object with the variogram added is 
returned if the function is called with an rtop-object as argument.
</p>
<p>For spatio-temporal objects (<code><a href="spacetime.html#topic+STSDF">STSDF</a></code>), the variogram is the spatially variogram, averaged for all time steps. There is a possibility to use data.table internally in this function, which can improve computation time for some cases.
</p>


<h3>Note</h3>

<p>The variogram cloud is similar to the variogram cloud from <code><a href="gstat.html#topic+gstat">gstat</a></code>,
with the area/length added to the resulting data.frame. The binned variogram is 
also based on the area or length, in addition to the distance between observations.
The bins equally distanced in the log10-space of the distances and areas (lengths).
The size of the bins is decided from the parameters <code>amul</code> and <code>dmul</code>, 
defining the number of bins per order of magnitude (1:10, 10:100, and so on).
</p>
<p>The distances between areas are in this function based on the centre of gravity.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

 
<p>Skoien J. O., R. Merz, and G. Bloschl. Top-kriging - geostatistics on stream networks.
Hydrology and Earth System Sciences, 10:277-287, 2006.
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(sf)
rpath = system.file("extdata",package="rtop")
observations = st_read(rpath,"observations")
# Create a column with the specific runoff:
observations$obs = observations$QSUMMER_OB/observations$AREASQKM

vario = rtopVariogram(observations, cloud = TRUE)

## End(Not run)
</code></pre>

<hr>
<h2 id='sceua'>
Optimisation with the Shuffle Complex Evolution method</h2><span id='topic+sceua'></span>

<h3>Description</h3>

<p>Calibration function which searches a parameter set which is minimizing the value of an objective function
</p>


<h3>Usage</h3>

<pre><code class='language-R'>sceua(OFUN, pars, lower, upper, maxn = 10000, kstop = 5, pcento = 0.01,
    ngs = 5, npg = 2 * length(pars) + 1, nps = length(pars) + 1, 
    nspl = 2 * length(pars) + 1, mings = ngs, iniflg = 1, iprint = 0, iround = 3, 
    peps = 0.0001, plog = rep(FALSE,length(pars)), implicit = NULL, timeout = NULL, ...)
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="sceua_+3A_ofun">OFUN</code></td>
<td>
<p> A function to be minimized, with first argument the vector of 
parameters over which minimization is to take place. It should return a scalar result 
as an indicator of the error for a certain parameter set</p>
</td></tr>
<tr><td><code id="sceua_+3A_pars">pars</code></td>
<td>
<p> a vector with the initial guess the parameters </p>
</td></tr>
<tr><td><code id="sceua_+3A_lower">lower</code></td>
<td>
<p> the lower boundary for the parameters </p>
</td></tr>
<tr><td><code id="sceua_+3A_upper">upper</code></td>
<td>
<p> the upper boundary for the parameters </p>
</td></tr>
<tr><td><code id="sceua_+3A_maxn">maxn</code></td>
<td>
<p> the maximum number of function evaluations</p>
</td></tr>
<tr><td><code id="sceua_+3A_kstop">kstop</code></td>
<td>
<p>number of shuffling loops in which the criterion value must change by the given percentage before optimization is terminated</p>
</td></tr>
<tr><td><code id="sceua_+3A_pcento">pcento</code></td>
<td>
<p>percentage by which the criterion value must change in given number (kstop) of shuffling loops to continue optimization</p>
</td></tr>
<tr><td><code id="sceua_+3A_ngs">ngs</code></td>
<td>
<p>number of complexes in the initial population</p>
</td></tr>
<tr><td><code id="sceua_+3A_npg">npg</code></td>
<td>
<p>number of points in each complex</p>
</td></tr>
<tr><td><code id="sceua_+3A_nps">nps</code></td>
<td>
<p>number of points in a sub-complex</p>
</td></tr>
<tr><td><code id="sceua_+3A_nspl">nspl</code></td>
<td>
<p>number of evolution steps allowed for each complex before complex shuffling</p>
</td></tr>
<tr><td><code id="sceua_+3A_mings">mings</code></td>
<td>
<p>minimum number of complexes required, if the number of complexes is allowed to reduce as the optimization proceeds</p>
</td></tr>
<tr><td><code id="sceua_+3A_iniflg">iniflg</code></td>
<td>
<p>flag on whether to include the initial point in population. iniflg = 0, not included. iniflg= 1, included
</p>
</td></tr>
<tr><td><code id="sceua_+3A_iprint">iprint</code></td>
<td>
<p>flag for controlling print-out after each shuffling loop. iprint &lt; 0: no output. iprint = 1: print information on the best point of the population. iprint &gt; 0: print information on every point of the population
</p>
</td></tr>
<tr><td><code id="sceua_+3A_iround">iround</code></td>
<td>
<p>number of significant digits in print-out</p>
</td></tr>
<tr><td><code id="sceua_+3A_peps">peps</code></td>
<td>
<p>convergence level for parameter set (lower number means smaller difference between parameters of the population required for stop)</p>
</td></tr>
<tr><td><code id="sceua_+3A_plog">plog</code></td>
<td>
<p>whether optimization should be done in log10-domain. Either a single TRUE value for all parameters, or a vector with TRUE/FALSE for the different parameters</p>
</td></tr>
<tr><td><code id="sceua_+3A_implicit">implicit</code></td>
<td>
<p>function for implicit boundaries for the parameters (e.g. sum(pars[4]+pars[5]) &lt; 1). See below for details</p>
</td></tr>
<tr><td><code id="sceua_+3A_timeout">timeout</code></td>
<td>
<p>if different from NULL: maximum time in seconds for execution before the optimization returns with the parameters so far.</p>
</td></tr>
<tr><td><code id="sceua_+3A_...">...</code></td>
<td>
<p>arguments for the objective function, must be named</p>
</td></tr>
</table>


<h3>Details</h3>

<p>sceua is an R-implementation of the Shuffle Complex Evolution - University of Arizona (Duan et al., 1992), 
a global optimization method which &quot;combines the strengths of the simplex procedure of Nelder and Mead (1965)
with the concepts of controlled random search (Price, 1987), competetive evolusion (Holland, 1975)&quot; with the 
concept of complex shuffling, developed by Duan et al. (1992). 
</p>
<p>This implementation follows the Fortran implementation relatively close, but adds the possibility of searching 
in log-space for one or more of the parameters, and it uses the capability of R to pass functions
as arguments, making it possible to pass implicit conditions to the parameter selection. 
</p>
<p>The objective function <code>OFUN</code> is a function which should give an error value for each parameter set.
It should never return non-numeric values such as NA, NULL, or Inf. If some parameter combinations can 
give such values, the return value should rather be a large number.
</p>
<p>The function works with fixed upper and lower boundaries for the parameters. If the possible range of 
a parameter might span several orders of magnitude, it might be better to search in log-space for the optimal parameter, 
to reduce the risk of being trapped in local optima. This can be set with the argument <code>plog</code>, which is either
a single value (FALSE/TRUE) or a vector for all parameters. 
<code>plog = c(TRUE, FALSE, FALSE, TRUE, TRUE)</code> means that the search for parameters 1,4 and 5 should be in log10-space, 
whereas the search for parameters 2 and 3 are in normal space.
</p>
<p>Implicit boundaries can be evoked by passing a function <code>implicit</code> to <code>sceua</code>.
This function should give 0 when parameters are acceptable 
and 1 if not. If, for example, the condition is that the following sum of parameters four and five should be limited:
</p>
<p>sum(pars[4]+pars[5]) &lt;= 1
</p>
<p>then the function will be implicit = function(pars) (2*pars[4] + pars[5]) &gt; 1
</p>


<h3>Value</h3>

<p>The function returns a list with the following elements
</p>

<dl>
<dt>par</dt><dd><p> - a vector of the best parameters combination </p>
</dd>
<dt>value</dt><dd><p> - the value of the objective function for this parameter set</p>
</dd>
<dt>convergence</dt><dd><p> - a list of two values </p>

<dl>
<dt>funConvergence</dt><dd><p> - the function convergence relative to pcento</p>
</dd>
<dt>parConvergence</dt><dd><p> - the parameter convergence relative to peps</p>
</dd>
</dl>
</dd>
<dt>counts</dt><dd><p> - the number of function evaluations</p>
</dd>
<dt>iterations</dt><dd><p> - the number of shuffling loops</p>
</dd>
<dt>timeout</dt><dd><p> - logical; TRUE if the optimization was aborted because the timeout time was reached, FALSE otherwise</p>
</dd>
</dl>

<p>There are also two elements returned as attributes:
</p>

<dl>
<dt>parset</dt><dd><p> - the entire set of parameters from the last evolution step </p>
</dd>
<dt>xf</dt><dd><p> - the values of the objective function from the last evolution step </p>
</dd>
</dl>

<p>The last two can be accessed as <code>attr(sceuares, "parset")</code> and <code>attr(sceuares, "xf")</code>, if the 
result is stored as <code>sceuares</code>.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

<p>Duan, Q., Sorooshian, S., and Gupta, V.K., 1992. Effective and efficient 
global optimization for conceptual rainfall-runoff models.
Water Resour. Res. 28 (4), 1015?1031.
</p>
<p>Holland, H.H., 1975. Adaptation in natural and artificial systems, 
University of Michigan Press, Ann Arbor.
</p>
<p>Nelder, J.A. and Mead, R., 1965. A simplex method for function minimization, 
Comput. J., 7(4), 308-313.
</p>
<p>Price, W.L., 1987. Global optimization algorithms for a CAD workstation, 
J. Optim. Theory Appl., 55(1), 133-146.
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>set.seed(1)
# generate example data from a function with three parameters
# with some random noise
fun = function(x, pars) pars[2]*sin(x*pars[1])+pars[3]
x = rnorm(50, sd = 3)
y = fun(x, pars = c(5, 2, 3)) +  rnorm(length(x), sd = 0.3)
plot(x,y)
   
# Objective function, summing up squared differences
OFUN = function(pars, x, yobs) {
  yvals = fun(x, pars)  
  sum((yvals-yobs)^2)
}

sceuares = sceua(OFUN, pars = c(0.1,0.1,0.1), lower = c(-10,0,-10), 
                 upper = c(10,10,10), x = x, yobs = y)
sceuares
xx = seq(min(x), max(x), 0.1)
lines(xx, fun(xx, pars = sceuares$par))

</code></pre>

<hr>
<h2 id='useRtopWithIntamap'>
Integrates the rtop package with the <code>intamap</code> package
</h2><span id='topic+useRtopWithIntamap'></span>

<h3>Description</h3>

<p>This function makes it possible to use <code>rtop</code>-objects in the functions of the package.
It is necessary to load the <code>intamap</code>-package before calling this function. 
</p>


<h3>Usage</h3>

<pre><code class='language-R'>useRtopWithIntamap()
</code></pre>


<h3>Value</h3>

<p>The function will have as side effect that the intamap package is loaded, 
and that rtop-methods are registered for the intamap-functions estimateParameters,
spatialPredict and methodParameters.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

 
<p>Pebesma, E., Cornford, D., Dubois, G., Heuvelink, G.B.M., Hristopulos, D., Pilz, J., Stohlker, U., Morin, G., Skoien, J.O. INTAMAP: The design and implementation f an interoperable automated interpolation Web Service. Computers and Geosciences 37 (3), 2011. 
</p>
<p>Skoien J. O., R. Merz, and G. Bloschl. Top-kriging - geostatistics on stream networks.
Hydrology and Earth System Sciences, 10:277-287, 2006.
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>


<h3>Examples</h3>

<pre><code class='language-R'>library(intamap)
useRtopWithIntamap()
</code></pre>

<hr>
<h2 id='variogramModel'> create or update variogram model</h2><span id='topic+rtopVariogramModel'></span><span id='topic+updateRtopVariogram'></span><span id='topic+updateRtopVariogram.rtop'></span><span id='topic+updateRtopVariogram.rtopVariogramModel'></span>

<h3>Description</h3>

<p>This gives an easier interface to the parameters of the variogram model
</p>


<h3>Usage</h3>

<pre><code class='language-R'>rtopVariogramModel(model = "Ex1", sill = NULL, range = NULL, 
    exp = NULL, nugget = NULL, exp0 = NULL,
    observations = NULL, formulaString = obs~1) 
## S3 method for class 'rtop'
updateRtopVariogram(object, ...)
## S3 method for class 'rtopVariogramModel'
updateRtopVariogram(object, action = "mult", ..., 
              checkVario = FALSE, 
sampleVariogram = NULL, observations = NULL) 

</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="variogramModel_+3A_model">model</code></td>
<td>
<p>variogram model, currently &quot;Ex1&quot; is the only implemented, see Skoien et al (2006)</p>
</td></tr>
<tr><td><code id="variogramModel_+3A_sill">sill</code></td>
<td>
<p>sill of variogram</p>
</td></tr>
<tr><td><code id="variogramModel_+3A_range">range</code></td>
<td>
<p>range of variogram</p>
</td></tr>
<tr><td><code id="variogramModel_+3A_exp">exp</code></td>
<td>
<p>the exponent of the fractal part of the variogram, see Skoien et al (2006)</p>
</td></tr>
<tr><td><code id="variogramModel_+3A_exp0">exp0</code></td>
<td>
<p>gives the angle of the first part of the variogram in a log-log plot (weibull type), 
should be between 0 and 2. See Skoien et al (2006)</p>
</td></tr>
<tr><td><code id="variogramModel_+3A_nugget">nugget</code></td>
<td>
<p>nugget of point variogram</p>
</td></tr>
<tr><td><code id="variogramModel_+3A_formulastring">formulaString</code></td>
<td>
<p>formula that defines the dependent variable as a linear model 
of independent variables, see e.g. <code><a href="#topic+createRtopObject">createRtopObject</a></code> for more details.</p>
</td></tr>
<tr><td><code id="variogramModel_+3A_object">object</code></td>
<td>
<p>either: object of class <code>rtop</code> (see <a href="#topic+rtop-package">rtop-package</a>), or an rtopVariogramModel. </p>
</td></tr>
<tr><td><code id="variogramModel_+3A_action">action</code></td>
<td>
<p>character variable defining whether the new parameters should 
be <code>add</code>(-ed), <code>mult</code>(-iplied) or <code>replace</code> the former parameters.
Leaving the parameters equal to NULL will cause no change.</p>
</td></tr>
<tr><td><code id="variogramModel_+3A_checkvario">checkVario</code></td>
<td>
<p>logical, will issue a call to<code><a href="#topic+checkVario">checkVario</a></code> if TRUE</p>
</td></tr>
<tr><td><code id="variogramModel_+3A_samplevariogram">sampleVariogram</code></td>
<td>
<p>a sample variogram of the data</p>
</td></tr>
<tr><td><code id="variogramModel_+3A_observations">observations</code></td>
<td>
<p>a set of observations</p>
</td></tr>
<tr><td><code id="variogramModel_+3A_...">...</code></td>
<td>
<p>parameters to lower level functions</p>
</td></tr>
</table>


<h3>Value</h3>

 
<p>The function helps creating and updating the parameters of the variogram, by 
using common names and simple update methods. This is mainly for manual 
fitting of the variogram. The automatic call to checkVario makes it easier to 
visualize the effect of the changes to the variogram</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>See Also</h3>

<p><code><a href="#topic+rtop-package">rtop-package</a></code></p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(sf)
rpath = system.file("extdata",package="rtop")
observations = st_read(rpath,"observations")
# Create a column with the specific runoff:
observations$obs = observations$QSUMMER_OB/observations$AREASQKM
predictionLocations = st_read(rpath,"predictionLocations")
rtopObj = createRtopObject(observations,predictionLocations)
 # Fit a variogram (function also creates it)
rtopObj = rtopFitVariogram(rtopObj)
rtopObj = updateRtopVariogram(rtopObj, exp = 1.5, action = "mult", 
              checkVario = TRUE)

## End(Not run)
</code></pre>

<hr>
<h2 id='varMat'> create a semivariogram matrix between a set of locations, or semivariogram 
matrices between and within two sets of locations</h2><span id='topic+varMat'></span><span id='topic+varMat.rtop'></span><span id='topic+varMat.SpatialPolygonsDataFrame'></span><span id='topic+varMat.SpatialPolygons'></span><span id='topic+varMat.matrix'></span><span id='topic+varMat.list'></span>

<h3>Description</h3>

<p>varMat will create a semivariogram matrix between all the supports in a set of 
locations (observations or prediction locations) or semivariogram matrices
between all the supports in one or two sets of locations, and also between them.
</p>


<h3>Usage</h3>

<pre><code class='language-R'>## S3 method for class 'rtop'
varMat(object, varMatUpdate = FALSE, fullPred = FALSE, params = list(), ...) 
## S3 method for class 'SpatialPolygonsDataFrame'
varMat(object, object2 = NULL,...) 
## S3 method for class 'SpatialPolygons'
varMat(object, object2 = NULL, variogramModel,
     overlapObs, overlapPredObs, ...) 
## S3 method for class 'list'
varMat(object, object2 = NULL, coor1, coor2, maxdist = Inf, 
              variogramModel, diag = FALSE, sub1, sub2, 
              debug.level = ifelse(interactive(), 1, 0), ...) 
</code></pre>


<h3>Arguments</h3>

<table role = "presentation">
<tr><td><code id="varMat_+3A_object">object</code></td>
<td>
<p> either: 1) an object of class <code>rtop</code> (see <a href="#topic+rtop-package">rtop-package</a>) 
or 2) a <br />
<code><a href="sp.html#topic+SpatialPolygons">SpatialPolygonsDataFrame</a></code>,
or <code><a href="sp.html#topic+SpatialPolygons">SpatialPolygons</a></code>, 
or 3) a <br />
<code><a href="base.html#topic+matrix">matrix</a></code> with geostatistical distances (see
<code><a href="#topic+gDist">gDist</a></code>
or 4) a <code><a href="base.html#topic+list">list</a></code> with discretized supports</p>
</td></tr>
<tr><td><code id="varMat_+3A_varmatupdate">varMatUpdate</code></td>
<td>
<p>logical; if TRUE, also existing variance matrices will 
be recomputed, if FALSE, only missing variance matrices will be computed</p>
</td></tr>
<tr><td><code id="varMat_+3A_fullpred">fullPred</code></td>
<td>
<p>logical; whether to create the full covariance matrix also for the predictions, 
mainly used for simulations</p>
</td></tr>
<tr><td><code id="varMat_+3A_params">params</code></td>
<td>
<p>a set of parameters, used to modify the default parameters for 
the <code>rtop</code> package, set in <code><a href="#topic+getRtopParams">getRtopParams</a></code>. </p>
</td></tr>
<tr><td><code id="varMat_+3A_object2">object2</code></td>
<td>
<p>if <code>object</code> is not an object of class <code>rtop</code>; 
an object of the same class as <code>object</code> with a possible second 
set of locations with support</p>
</td></tr>
<tr><td><code id="varMat_+3A_variogrammodel">variogramModel</code></td>
<td>
<p>variogramModel to be used in calculation of the 
semivariogram matrix (matrices)</p>
</td></tr>
<tr><td><code id="varMat_+3A_...">...</code></td>
<td>
<p>typical parameters to modify from the default parameters of the
rtop-package (or modifications of the previously set parameters for the 
<code>rtop</code>-object), see also <code><a href="#topic+getRtopParams">getRtopParams</a></code>. These can also 
be passed in a list named params, as for the rtop-method. Typical 
parameters to modify for this function:
</p>

<dl>
<dt>rresol = 100</dt><dd><p>miminum number of discretization points, in call to 
<code><a href="#topic+rtopDisc">rtopDisc</a></code> if necessary</p>
</dd>
<dt>rstype = &quot;rtop&quot;</dt><dd><p>sampling type from areas, in call to 
<code><a href="#topic+rtopDisc">rtopDisc</a></code> if necessary</p>
</dd>
<dt>gDistPred = FALSE</dt><dd><p>use geostatistical distance for semivariogram matrices</p>
</dd>
<dt>gDist</dt><dd><p>parameter to set jointly <code>gDistEst = gDistPred = gDist</code></p>
</dd>
</dl>

</td></tr>
<tr><td><code id="varMat_+3A_overlapobs">overlapObs</code></td>
<td>
<p>matrix with observations that overlap each other</p>
</td></tr>
<tr><td><code id="varMat_+3A_overlappredobs">overlapPredObs</code></td>
<td>
<p>matrix with <code>observations</code> and <code>predictionLocations</code>
that overlap each other</p>
</td></tr>
<tr><td><code id="varMat_+3A_coor1">coor1</code></td>
<td>
<p>coordinates of centroids of <code>object</code></p>
</td></tr>
<tr><td><code id="varMat_+3A_coor2">coor2</code></td>
<td>
<p>coordinates of centre-of-gravity of <code>object2</code></p>
</td></tr>
<tr><td><code id="varMat_+3A_maxdist">maxdist</code></td>
<td>
<p>maximum distance between areas for inclusion in semivariogrma matrix</p>
</td></tr>
<tr><td><code id="varMat_+3A_diag">diag</code></td>
<td>
<p>logical; if TRUE only the semivariogram values along the diagonal 
will be calculated, typical for semivariogram matrix of prediction locations</p>
</td></tr>
<tr><td><code id="varMat_+3A_sub1">sub1</code></td>
<td>
<p>semivariogram array for subtraction of inner variances of areas</p>
</td></tr>
<tr><td><code id="varMat_+3A_sub2">sub2</code></td>
<td>
<p>semivariogram array for subtraction of inner variances of areas</p>
</td></tr>
<tr><td><code id="varMat_+3A_debug.level">debug.level</code></td>
<td>
<p>debug.level &gt;= 1 will give output for every element</p>
</td></tr>
</table>


<h3>Value</h3>

 
<p>The lower level versions of the function calculates a semivariogram matrix
between locations in <code>object</code> or between the locations in <code>object</code> 
and the locations in <code>object2</code>. The method for object of type <code>rtop</code>
calculates semivariogram matrices between observation locations, between prediction locations, 
and between observation locations and prediction locations, and adds these 
to <code>object</code>.
</p>


<h3>Note</h3>

<p>The argument <code>varMatUpdate</code> is typically used to avoid repeated computations
of the same variance matrices. Default is FALSE, which will avoid recomputation
of the variance matrix for the observations if the procedure is cross-validation
before interpolation. Should be set to TRUE if the variogram Model has been
changed, or if observation and/or prediction locations have been changed.
</p>
<p>If an <code>rtop</code>-object contains observations and/or predictionLocations of type 
<code><a href="spacetime.html#topic+STSDF">STSDF</a></code>, the covariance matrix is computed based on the spatial 
properties of the object.
</p>


<h3>Author(s)</h3>

<p> Jon Olav Skoien </p>


<h3>References</h3>

 
<p>Skoien J. O., R. Merz, and G. Bloschl. Top-kriging - geostatistics on stream networks.
Hydrology and Earth System Sciences, 10:277-287, 2006.
</p>
<p>Skoien, J. O., Bloschl, G., Laaha, G., Pebesma, E., Parajka, J., Viglione, A., 2014. Rtop: An R package for interpolation of data with a variable spatial support, with an example from river networks. Computers &amp; Geosciences, 67.
</p>


<h3>See Also</h3>

<p><code><a href="#topic+gDist">gDist</a></code>
</p>


<h3>Examples</h3>

<pre><code class='language-R'>## Not run: 
library(sf)
rpath = system.file("extdata",package="rtop")
observations = st_read(rpath,"observations")
vmod = list(model = "Ex1", params = c(0.00001,0.007,350000,0.9,1000))
vm = varMat(observations, variogramModel = vmod)

## End(Not run)
</code></pre>

</main>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
</body></html>
